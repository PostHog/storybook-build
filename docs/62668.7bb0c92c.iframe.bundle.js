"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[62668],{"../../products/llm_analytics/frontend/LLMAnalyticsTraceScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{LLMAnalyticsTraceScene:()=>LLMAnalyticsTraceScene,renderModelRow:()=>renderModelRow,scene:()=>scene});var classnames=__webpack_require__("../../node_modules/.pnpm/classnames@2.5.1/node_modules/classnames/index.js"),classnames_default=__webpack_require__.n(classnames),clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),index_module=__webpack_require__("../../node_modules/.pnpm/use-debounce@9.0.3_react@18.2.0/node_modules/use-debounce/dist/index.module.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.34.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),HighlightedJSONViewer=__webpack_require__("../../frontend/src/lib/components/HighlightedJSONViewer.tsx"),JSONViewer=__webpack_require__("../../frontend/src/lib/components/JSONViewer.tsx"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),ViewRecordingButton=__webpack_require__("../../frontend/src/lib/components/ViewRecordingButton/ViewRecordingButton.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),css_classes=__webpack_require__("../../frontend/src/lib/utils/css-classes.ts"),EmptyStates=__webpack_require__("../../frontend/src/scenes/insights/EmptyStates/index.ts"),PersonDisplay=__webpack_require__("../../frontend/src/scenes/persons/PersonDisplay.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),SceneBreadcrumbs=__webpack_require__("../../frontend/src/layout/scenes/components/SceneBreadcrumbs.tsx"),ConversationMessagesDisplay=__webpack_require__("../../products/llm_analytics/frontend/ConversationDisplay/ConversationMessagesDisplay.tsx"),MetadataHeader=__webpack_require__("../../products/llm_analytics/frontend/ConversationDisplay/MetadataHeader.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function ParametersHeader(_ref){let{eventProperties}=_ref;return(0,jsx_runtime.jsx)("div",{className:"flex flex-row flex-wrap gap-2",children:eventProperties.$ai_model_parameters&&Object.entries(eventProperties.$ai_model_parameters).map(_ref2=>{let[key,value]=_ref2;return null!==value&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",children:[key,": ",`${value}`]},key)})})}var LLMInputOutput=__webpack_require__("../../products/llm_analytics/frontend/LLMInputOutput.tsx"),SearchHighlight=__webpack_require__("../../products/llm_analytics/frontend/SearchHighlight.tsx"),llmEvaluationsLogic=__webpack_require__("../../products/llm_analytics/frontend/evaluations/llmEvaluationsLogic.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),frontend_utils=__webpack_require__("../../products/llm_analytics/frontend/utils.ts");let generationEvaluationRunsLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","llm_analytics","frontend","generationEvaluationRunsLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(props=>props.generationEventId),(0,index_esm.actions)({refreshGenerationEvaluationRuns:!0,setSelectedEvaluationId:evaluationId=>({evaluationId})}),(0,lib.loaders)(_ref=>{let{props,values}=_ref;return{generationEvaluationRuns:[[],{loadGenerationEvaluationRuns:async()=>{try{return await (0,frontend_utils.pW)({generationEventId:props.generationEventId,forceRefresh:values.isForceRefresh})}catch(error){return console.error("Failed to load generation evaluation runs:",error),[]}}}]}}),(0,index_esm.reducers)({isForceRefresh:[!1,{refreshGenerationEvaluationRuns:()=>!0,loadGenerationEvaluationRunsSuccess:()=>!1,loadGenerationEvaluationRunsFailure:()=>!1}],selectedEvaluationId:[null,{setSelectedEvaluationId:(_,_ref2)=>{let{evaluationId}=_ref2;return evaluationId}}]}),(0,index_esm.listeners)(_ref3=>{let{actions}=_ref3;return{refreshGenerationEvaluationRuns:()=>{actions.loadGenerationEvaluationRuns()}}}),(0,index_esm.afterMount)(_ref4=>{let{actions}=_ref4;actions.loadGenerationEvaluationRuns()})]);var api=__webpack_require__("../../frontend/src/lib/api.ts"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/index.ts"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx");let llmEvaluationExecutionLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","llm_analytics","frontend","llmEvaluationExecutionLogic"]),(0,index_esm.connect)(()=>({values:[teamLogic.teamLogic,["currentTeamId"]]})),(0,index_esm.actions)({runEvaluation:(evaluationId,targetEventId)=>({evaluationId,targetEventId})}),(0,lib.loaders)(_ref=>{let{values}=_ref;return{evaluationRun:[null,{runEvaluation:async _ref2=>{let{evaluationId,targetEventId}=_ref2;if(!values.currentTeamId)throw Error("No team selected");try{let response=await api.ZP.evaluationRuns.create({evaluation_id:evaluationId,target_event_id:targetEventId});return LemonToast.U.success("Evaluation started successfully"),response}catch(error){throw LemonToast.U.error("Failed to start evaluation"),error}}}]}}),(0,index_esm.reducers)({lastRunWorkflowId:[null,{runEvaluationSuccess:(_,_ref3)=>{let{evaluationRun}=_ref3;return evaluationRun?.workflow_id||null}}]})]);var TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx");function GenerationEvalRunsTable(_ref){let{generationEventId}=_ref;return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:generationEvaluationRunsLogic,props:{generationEventId},children:(0,jsx_runtime.jsx)(GenerationEvalRunsTableContent,{})})}function GenerationEvalRunsTableContent(){let{generationEvaluationRuns,generationEvaluationRunsLoading}=(0,index_esm.useValues)(generationEvaluationRunsLogic),columns=[{title:"Timestamp",key:"timestamp",render:(_,run)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:run.timestamp}),sorter:(a,b)=>new Date(b.timestamp).getTime()-new Date(a.timestamp).getTime()},{title:"Evaluation",key:"evaluation",render:(_,run)=>(0,jsx_runtime.jsx)(src.rU,{to:urls.j.llmAnalyticsEvaluation(run.evaluation_id),className:"text-primary font-medium",children:run.evaluation_name})},{title:"Result",key:"result",render:(_,run)=>"failed"===run.status?(0,jsx_runtime.jsx)(src.oe,{type:"danger",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconWarning,{}),children:"Error"}):"running"===run.status?(0,jsx_runtime.jsx)(src.oe,{type:"primary",children:"Running..."}):(0,jsx_runtime.jsx)("div",{className:"flex items-center gap-2",children:run.result?(0,jsx_runtime.jsx)(src.oe,{type:"success",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconCheck,{}),children:"True"}):(0,jsx_runtime.jsx)(src.oe,{type:"danger",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),children:"False"})}),sorter:(a,b)=>Number(b.result)-Number(a.result)},{title:"Reasoning",key:"reasoning",render:(_,run)=>(0,jsx_runtime.jsx)("div",{className:"max-w-md",children:(0,jsx_runtime.jsx)("div",{className:"text-sm text-default line-clamp-2",children:run.reasoning})})}];return(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(src.g3,{columns:columns,dataSource:generationEvaluationRuns,loading:generationEvaluationRunsLoading,rowKey:"id",pagination:{pageSize:20},emptyState:(0,jsx_runtime.jsxs)("div",{className:"text-center py-8",children:[(0,jsx_runtime.jsx)("div",{className:"text-muted mb-2",children:"No evaluations run yet"}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:'Click "Run Evaluation" above to run an evaluation on this generation.'})]})})})}function EvalsTabContent(_ref){let{generationEventId}=_ref;return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:generationEvaluationRunsLogic,props:{generationEventId},children:(0,jsx_runtime.jsx)(EvalsTabContentInner,{generationEventId:generationEventId})})}function EvalsTabContentInner(_ref2){let{generationEventId}=_ref2,{evaluations,evaluationsLoading}=(0,index_esm.useValues)(llmEvaluationsLogic.k),{runEvaluation}=(0,index_esm.useActions)(llmEvaluationExecutionLogic),{evaluationRunLoading}=(0,index_esm.useValues)(llmEvaluationExecutionLogic),{refreshGenerationEvaluationRuns,setSelectedEvaluationId}=(0,index_esm.useActions)(generationEvaluationRunsLogic),{generationEvaluationRunsLoading,selectedEvaluationId}=(0,index_esm.useValues)(generationEvaluationRunsLogic);return(0,jsx_runtime.jsxs)("div",{className:"py-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Yv,{value:selectedEvaluationId,onChange:setSelectedEvaluationId,options:evaluations?.filter(e=>!e.deleted).map(evaluation=>({value:evaluation.id,label:evaluation.name}))||[],placeholder:"Select an evaluation to run",loading:evaluationsLoading,className:"w-80"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{}),onClick:()=>{selectedEvaluationId&&runEvaluation(selectedEvaluationId,generationEventId)},loading:evaluationRunLoading,disabledReason:selectedEvaluationId?void 0:"Select an evaluation first",children:"Run Evaluation"})]}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconRefresh,{}),onClick:refreshGenerationEvaluationRuns,loading:generationEvaluationRunsLoading,size:"small",children:"Refresh"})]}),(0,jsx_runtime.jsx)(GenerationEvalRunsTable,{generationEventId:generationEventId})]})}var CopyToClipboard=__webpack_require__("../../frontend/src/lib/components/CopyToClipboard.tsx");function FeedbackTag(_ref){let{properties}=_ref,{$ai_feedback_text:feedbackText}=properties,feedbackPreview="string"==typeof feedbackText?feedbackText.slice(0,5):"",text=feedbackText||"No feedback provided";return(0,jsx_runtime.jsx)(src.oe,{className:"bg-surface-primary cursor-default",children:(0,jsx_runtime.jsx)(CopyToClipboard.D,{iconSize:"xsmall",description:"user feedback",tooltipMessage:text,explicitValue:String(feedbackText),children:`User feedback${feedbackPreview?`: ${feedbackPreview}...`:""}`})})}function MetricTag(_ref){let{properties}=_ref,{$ai_metric_name:metricName,$ai_metric_value:metricValue}=properties,strValue=String(metricValue),isValueLong=strValue.length>10,name=metricName?(0,utils.UV)(metricName):"Metric",value=isValueLong?`${strValue.slice(0,10)}...`:strValue,title=`${name}: ${value}`,description=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[metricName&&(0,jsx_runtime.jsxs)("span",{children:["Metric: ",metricName,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("br",{})]}),metricValue,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("span",{children:"Click to copy the value"})]});return(0,jsx_runtime.jsx)(src.oe,{className:"bg-surface-primary cursor-default",children:(0,jsx_runtime.jsx)(CopyToClipboard.D,{iconSize:"xsmall",description:"metric",explicitValue:strValue,tooltipMessage:isValueLong?description:"Click to copy the value",children:title})})}var kea_forms_lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),DatasetItemModal=__webpack_require__("../../products/llm_analytics/frontend/datasets/DatasetItemModal.tsx"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js");let saveToDatasetButtonLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","llm-analytics","saveToDatasetButtonLogic"]),(0,index_esm.props)({partialDatasetItem:null}),(0,index_esm.actions)({setIsModalOpen:isModalOpen=>({isModalOpen}),setEditMode:editMode=>({editMode}),setDropdownVisible:dropdownVisible=>({dropdownVisible}),setSelectedDataset:dataset=>({dataset}),setRecentDatasetIds:recentDatasetIds=>({recentDatasetIds}),setRecentDatasets:recentDatasets=>({recentDatasets})}),(0,index_esm.reducers)(()=>({isModalOpen:[!1,{setIsModalOpen:(_,_ref)=>{let{isModalOpen}=_ref;return isModalOpen}}],selectedDataset:[null,{setSelectedDataset:(_,_ref2)=>{let{dataset}=_ref2;return dataset}}],editMode:["create",{setEditMode:(_,_ref3)=>{let{editMode}=_ref3;return editMode},setIsModalOpen:(state,_ref4)=>{let{isModalOpen}=_ref4;return isModalOpen?state:"create"}}],dropdownVisible:[!1,{setDropdownVisible:(_,_ref5)=>{let{dropdownVisible}=_ref5;return dropdownVisible}}],recentDatasetIds:[[],{persist:!0},{setRecentDatasetIds:(_,_ref6)=>{let{recentDatasetIds}=_ref6;return truncateRecentDatasets(recentDatasetIds)}}],recentDatasets:[[],{setRecentDatasets:(_,_ref7)=>{let{recentDatasets}=_ref7;return truncateRecentDatasets(recentDatasets)}}]})),(0,lib.loaders)(_ref8=>{let{actions,values}=_ref8;return{datasetStore:[{},{loadDatasets:async function(){let debounce=arguments.length>0&&void 0!==arguments[0]&&arguments[0],breakpoint=arguments.length>1?arguments[1]:void 0;debounce&&await breakpoint(300);let params={limit:100,offset:0,search:values.searchForm.search},storageKey=getStorageKey(values.searchForm.search),response=await api.ZP.datasets.list(params);return{...values.datasetStore,[storageKey]:response.results}}}],recentDatasets:[[],{loadRecentDatasets:async function(){let debounce=arguments.length>0&&void 0!==arguments[0]&&arguments[0],breakpoint=arguments.length>1?arguments[1]:void 0;if(debounce&&await breakpoint(300),0===values.recentDatasetIds.length)return[];try{let response=await api.ZP.datasets.list({ids:values.recentDatasetIds}),map=new Map(response.results.map(dataset=>[dataset.id,dataset])),missingIds=values.recentDatasetIds.filter(id=>!map.has(id)),actualItems=values.recentDatasetIds.filter(id=>map.has(id));return missingIds.length>0&&actions.setRecentDatasetIds(actualItems),actualItems.map(id=>map.get(id))}catch{return[]}}}]}}),(0,kea_forms_lib.forms)(_ref9=>{let{asyncActions,actions,values,props}=_ref9;return{searchForm:{defaults:{search:"",datasetId:null},submit:async _ref10=>{let{datasetId}=_ref10;if(!datasetId){await asyncActions.loadDatasets(!0);return}actions.setDropdownVisible(!1),actions.resetSearchForm();let dataset=values.datasets?.find(dataset=>dataset.id===datasetId);if(dataset){if("edit"===values.editMode){actions.setSelectedDataset(dataset),actions.setIsModalOpen(!0);return}await createDatasetItem(datasetId)}async function createDatasetItem(datasetId){let recursionCount=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;try{await api.ZP.datasetItems.create({...props.partialDatasetItem,dataset:datasetId}),LemonToast.U.success("Dataset item has been created successfully",{button:{label:"View",action:()=>{kea_router_lib.router.actions.push(urls.j.llmAnalyticsDataset(datasetId))}}})}catch{LemonToast.U.error("Failed to create dataset item",{button:recursionCount<3?{label:"Retry",action:()=>{createDatasetItem(datasetId,recursionCount+1)}}:void 0})}}}}}}),(0,index_esm.selectors)({datasets:[s=>[s.datasetStore,s.searchForm],(datasetStore,searchForm)=>{var _datasetStore$storage;return null!==(_datasetStore$storage=datasetStore[getStorageKey(searchForm.search)])&&void 0!==_datasetStore$storage?_datasetStore$storage:null}],isLoadingDatasets:[s=>[s.datasets,s.datasetStoreLoading,s.recentDatasetsLoading],(datasets,datasetStoreLoading,recentDatasetsLoading)=>!datasets&&(datasetStoreLoading||recentDatasetsLoading)],isModalMounted:[s=>[s.editMode],editMode=>"edit"===editMode]}),(0,index_esm.listeners)(_ref11=>{let{actions,asyncActions,values}=_ref11;return{setIsModalOpen:()=>{actions.setSearchFormValue("search","")},setSearchFormValue:_ref12=>{let{name,value}=_ref12;if(compareFieldName(name,"search")&&asyncActions.loadDatasets(!0),compareFieldName(name,"datasetId")&&!values.recentDatasetIds.includes(value)){let dataset=values.datasets?.find(dataset=>dataset.id===value);dataset&&(actions.setRecentDatasetIds([value,...values.recentDatasetIds]),actions.setRecentDatasets([dataset,...values.recentDatasets]))}},setDropdownVisible:_ref13=>{let{dropdownVisible}=_ref13;dropdownVisible?asyncActions.loadDatasets(!0):actions.setSearchFormValue("search","")}}}),(0,index_esm.afterMount)(_ref14=>{let{actions,values}=_ref14;values.datasets?.length||(actions.loadDatasets(!1),actions.loadRecentDatasets(!1))}),(0,index_esm.beforeUnmount)(_ref15=>{let{actions}=_ref15;actions.setSearchFormValue("search","")})]);function getStorageKey(search){return(0,kea_router_lib.encodeParams)({limit:100,offset:0,search})}function truncateRecentDatasets(state){return state.slice(0,3)}function compareFieldName(nameValue,fieldName){return Array.isArray(nameValue)?nameValue[0]===fieldName:nameValue===fieldName}function useKeyboardNavigation(itemCount){let defaultFocusedItemIndex=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,{enabled=!0}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},[focusedItemIndex,setFocusedItemIndex]=(0,react.useState)(-1),referenceRef=(0,react.useRef)(null),itemsRef=(0,react.useRef)(Array.from({length:itemCount},()=>(0,react.createRef)()));(0,react.useEffect)(()=>{setFocusedItemIndex(defaultFocusedItemIndex)},[defaultFocusedItemIndex]);let stableListener=(0,react.useRef)(()=>{});return(0,react.useEffect)(()=>{function focus(newIndex){itemsRef.current[newIndex].current?.focus()}stableListener.current=e=>{"ArrowDown"===e.key?focusedItemIndex<itemCount-1&&(focus(focusedItemIndex+1),setFocusedItemIndex(focusedItemIndex+1),e.preventDefault()):"ArrowUp"===e.key&&focusedItemIndex>0&&(focus(focusedItemIndex-1),setFocusedItemIndex(focusedItemIndex-1),e.preventDefault())}},[itemCount,focusedItemIndex,setFocusedItemIndex]),(0,react.useEffect)(()=>{if(!enabled)return;let handleKeyDown=e=>{stableListener.current(e)};return referenceRef.current?.addEventListener("keydown",handleKeyDown),()=>{referenceRef.current?.removeEventListener("keydown",handleKeyDown)}},[enabled]),{referenceRef,itemsRef,focusedItemIndex}}let SaveToDatasetButton=react.memo(function SaveToDatasetButton(_ref){let{traceId,timestamp,sourceId,input,output,metadata}=_ref,partialDatasetItem=(0,react.useMemo)(()=>({ref_trace_id:traceId,ref_timestamp:timestamp,ref_source_id:sourceId,input:convertToDict(input,"input"),output:convertToDict(output,"output"),metadata:convertToDict(metadata,"metadata")}),[traceId,timestamp,sourceId,input,output,metadata]),logic=saveToDatasetButtonLogic({partialDatasetItem}),{dropdownVisible,isModalOpen,selectedDataset,isModalMounted}=(0,index_esm.useValues)(logic),{setEditMode,setDropdownVisible,setIsModalOpen}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Qw,{overlay:(0,jsx_runtime.jsx)(OverlayMenu,{}),visible:dropdownVisible,onVisibilityChange:setDropdownVisible,closeOnClickInside:!1,children:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconDatabase,{}),sideAction:{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{}),onClick:()=>{dropdownVisible||setEditMode("edit"),setDropdownVisible(!dropdownVisible)},tooltip:"Add to dataset and edit it"},onClick:()=>{setDropdownVisible(!dropdownVisible)},children:"Add to dataset"})}),isModalMounted&&selectedDataset&&(0,jsx_runtime.jsx)(DatasetItemModal.Q,{isOpen:isModalOpen,onClose:()=>setIsModalOpen(!1),datasetId:selectedDataset.id,partialDatasetItem:partialDatasetItem,title:`New dataset item for ${selectedDataset.name}`})]})});function OverlayMenu(){var _datasets$length,_recentDatasets$lengt,_recentDatasets$lengt2;let{datasets,isLoadingDatasets,recentDatasets,searchForm}=(0,index_esm.useValues)(saveToDatasetButtonLogic),{setSearchFormValue,setDropdownVisible}=(0,index_esm.useActions)(saveToDatasetButtonLogic),{referenceRef,itemsRef,focusedItemIndex}=useKeyboardNavigation((null!==(_datasets$length=datasets?.length)&&void 0!==_datasets$length?_datasets$length:0)+(null!==(_recentDatasets$lengt=recentDatasets?.length)&&void 0!==_recentDatasets$lengt?_recentDatasets$lengt:0),0,{enabled:!isLoadingDatasets}),recentDatasetsLength=null!==(_recentDatasets$lengt2=recentDatasets?.length)&&void 0!==_recentDatasets$lengt2?_recentDatasets$lengt2:0;return(0,jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:saveToDatasetButtonLogic,formKey:"searchForm",className:"w-xs",enableFormOnSubmit:!0,children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"search",label:"Search",labelClassName:"sr-only",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"Find a dataset",autoFocus:!0})}),(0,jsx_runtime.jsx)(src.p2,{className:"my-0 mt-2"}),(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("overflow-y-auto max-h-64 py-2",isLoadingDatasets?"space-y-4":"space-y-2"),ref:referenceRef,children:isLoadingDatasets?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.yW,{active:!0,className:"h-4 w-full"}),(0,jsx_runtime.jsx)(src.yW,{active:!0,className:"h-4 w-full"}),(0,jsx_runtime.jsx)(src.yW,{active:!0,className:"h-4 w-full"}),(0,jsx_runtime.jsx)(src.yW,{active:!0,className:"h-4 w-full"}),(0,jsx_runtime.jsx)(src.yW,{active:!0,className:"h-4 w-full"})]}):datasets&&datasets.length>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!searchForm.search&&recentDatasets.length>0&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{className:"text-muted text-xs px-2",children:"Recent datasets"}),recentDatasets.map((dataset,index)=>(0,jsx_runtime.jsx)(src.Jp,{ref:itemsRef?.current?.[index],fullWidth:!0,size:"small",active:focusedItemIndex===index,htmlType:"submit",onClick:()=>{setSearchFormValue("datasetId",dataset.id)},children:(0,jsx_runtime.jsx)("span",{className:"line-clamp-1",children:dataset.name})},dataset.id)),(0,jsx_runtime.jsx)(src.p2,{className:"my-0 mb-2"})]}),datasets.map((dataset,index)=>(0,jsx_runtime.jsx)(src.Jp,{ref:itemsRef?.current?.[recentDatasetsLength+index],fullWidth:!0,size:"small",active:focusedItemIndex-recentDatasetsLength===index,htmlType:"submit",onClick:()=>{setSearchFormValue("datasetId",dataset.id)},children:(0,jsx_runtime.jsx)("span",{className:"line-clamp-1",children:dataset.name})},dataset.id))]}):(0,jsx_runtime.jsx)("p",{className:"text-muted text-sm px-2",children:"No datasets found"})}),(0,jsx_runtime.jsx)(src.p2,{className:"my-0 mb-2"}),(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,size:"small",to:urls.j.llmAnalyticsDataset("new"),sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconExternal,{}),targetBlank:!0,onClick:()=>{setDropdownVisible(!1)},children:"Create new dataset"})]})}function convertToDict(input,key){if(null!=input){if((0,utils.Kn)(input)&&!Array.isArray(input)){if(0===Object.keys(input).length)return;return input}return{[key]:Array.isArray(input)?input:String(input)}}}var llmAnalyticsPlaygroundLogic=__webpack_require__("../../products/llm_analytics/frontend/llmAnalyticsPlaygroundLogic.ts"),dataNodeLogic=__webpack_require__("../../frontend/src/queries/nodes/DataNode/dataNodeLogic.ts"),InsightViz=__webpack_require__("../../frontend/src/queries/nodes/InsightViz/InsightViz.tsx"),llmAnalyticsTraceLogic=__webpack_require__("../../products/llm_analytics/frontend/llmAnalyticsTraceLogic.ts"),searchUtils=__webpack_require__("../../products/llm_analytics/frontend/searchUtils.ts");function getDataNodeLogicProps(_ref){let{traceId,query,cachedResults}=_ref,insightProps={dashboardItemId:`new-Trace.${traceId}`,dataNodeCollectionId:traceId},vizKey=(0,InsightViz.gG)(insightProps);return{query:query.source,key:vizKey,dataNodeCollectionId:traceId,cachedResults:cachedResults||void 0}}let FEEDBACK_EVENTS=new Set(["$ai_feedback","$ai_metric"]);function findEventWithParents(targetEvent,allEvents,traceId){var _ref2,_event$properties$$ai,_currentEvent$propert;let eventMap=new Map;for(let event of allEvents){let eventId=null!==(_ref2=null!==(_event$properties$$ai=event.properties.$ai_generation_id)&&void 0!==_event$properties$$ai?_event$properties$$ai:event.properties.$ai_span_id)&&void 0!==_ref2?_ref2:event.id;eventMap.set(eventId,event)}let parentChain=[],currentEvent=targetEvent;for(;currentEvent;){parentChain.push(currentEvent);let parentId=null!==(_currentEvent$propert=currentEvent.properties.$ai_parent_id)&&void 0!==_currentEvent$propert?_currentEvent$propert:currentEvent.properties.$ai_trace_id;if(!parentId||parentId===traceId)break;currentEvent=eventMap.get(parentId)||null}return parentChain}let llmAnalyticsTraceDataLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","llm-analytics","llmAnalyticsTraceLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(props=>({values:[llmAnalyticsTraceLogic.AX,["eventId","searchQuery"],(0,dataNodeLogic.M)(getDataNodeLogicProps(props)),["response","responseLoading","responseError"]]})),(0,index_esm.selectors)({trace:[s=>[s.response],response=>response?.results?.[0]],showableEvents:[s=>[s.trace],trace=>trace?trace.events.filter(event=>!FEEDBACK_EVENTS.has(event.event)):[]],filteredEvents:[(s,p)=>[s.showableEvents,s.searchQuery,p.traceId],(showableEvents,searchQuery,traceId)=>{if(!searchQuery.trim())return showableEvents;let matchingEvents=showableEvents.filter(event=>(0,searchUtils.jo)(event,searchQuery)),eventsWithParents=new Set;for(let matchingEvent of matchingEvents)for(let event of findEventWithParents(matchingEvent,showableEvents,traceId))eventsWithParents.add(event);return Array.from(eventsWithParents)}],filteredTree:[(s,p)=>[p.traceId,s.trace,s.searchQuery,s.filteredEvents],(traceId,trace,searchQuery,filteredEvents)=>searchQuery.trim()?restoreTree(filteredEvents,traceId):restoreTree(trace?.events||[],traceId)],mostRelevantEvent:[s=>[s.filteredEvents,s.searchQuery],(filteredEvents,searchQuery)=>{if(!searchQuery.trim()||!filteredEvents.length)return null;let query=searchQuery.toLowerCase().trim(),best=filteredEvents.map(event=>{let score=0;return"$ai_generation"===event.event&&(score+=10),(event.properties.$ai_span_name||event.event||"").toLowerCase().includes(query)&&(score+=5),(event.properties.$ai_model||"").toLowerCase().includes(query)&&(score+=3),JSON.stringify(event.properties.$ai_input||event.properties.$ai_input_state||"").toLowerCase().includes(query)&&(score+=2),JSON.stringify(event.properties.$ai_output||event.properties.$ai_output_choices||event.properties.$ai_output_state||"").toLowerCase().includes(query)&&(score+=2),{event,score}}).sort((a,b)=>b.score-a.score)[0];return best?.event||null}],searchOccurrences:[s=>[s.showableEvents,s.searchQuery,s.trace],(showableEvents,searchQuery,trace)=>{if(!searchQuery.trim())return[];let query=searchQuery.toLowerCase().trim(),traceOccurrences=(0,searchUtils.ll)(trace,query);return[...traceOccurrences,...(0,searchUtils.Pi)(showableEvents,query),...(0,searchUtils.zl)(showableEvents,query,frontend_utils.VL)]}],metricEvents:[s=>[s.trace],trace=>trace?.events.filter(event=>"$ai_metric"===event.event&&event.properties.$ai_metric_value)],feedbackEvents:[s=>[s.trace],trace=>trace?.events.filter(event=>"$ai_feedback"===event.event&&event.properties.$ai_feedback_text)],metricsAndFeedbackEvents:[s=>[s.metricEvents,s.feedbackEvents],(metricEvents,feedbackEvents)=>[...null!=metricEvents?metricEvents:[],...null!=feedbackEvents?feedbackEvents:[]].map(event=>{var _event$properties$$ai2,_event$properties$$ai3;return{metric:"$ai_metric"===event.event?null!==(_event$properties$$ai2=event.properties.$ai_metric_name)&&void 0!==_event$properties$$ai2?_event$properties$$ai2:"Metric":"User feedback",value:null!==(_event$properties$$ai3=event.properties.$ai_metric_value)&&void 0!==_event$properties$$ai3?_event$properties$$ai3:event.properties.$ai_feedback_text}})],event:[(s,p)=>[p.traceId,s.eventId,s.trace,s.showableEvents],(traceId,eventId,trace,showableEvents)=>eventId&&eventId!==traceId?showableEvents?.length&&showableEvents.find(event=>event.id===eventId)||null:trace||null],tree:[s=>[s.filteredTree],filteredTree=>filteredTree],enrichedTree:[s=>[s.filteredTree],filteredTree=>filteredTree.map(enrichNode)],eventMetadata:[s=>[s.event],event=>{if(event&&(0,frontend_utils.w1)(event))return Object.fromEntries(Object.entries(event.properties).filter(_ref3=>{let[key]=_ref3;return!key.startsWith("$")}))}],availableEventTypes:[s=>[s.enrichedTree],enrichedTree=>{let types=new Set,addTypesFromTree=nodes=>{for(let node of nodes)types.add((0,frontend_utils.x6)(node.event)),node.children&&addTypesFromTree(node.children)};return addTypesFromTree(enrichedTree),types.delete("trace"),[...types]}]})]);function extractTotalCost(event){return event.properties.$ai_total_cost_usd||0}function extractLatency(event){return event.properties.$ai_latency||0}function enrichNode(node){var _node$aggregation$tot,_node$aggregation$tot2;return{...node,children:node.children?.map(enrichNode),displayTotalCost:null!==(_node$aggregation$tot=node.aggregation?.totalCost)&&void 0!==_node$aggregation$tot?_node$aggregation$tot:extractTotalCost(node.event),displayLatency:null!==(_node$aggregation$tot2=node.aggregation?.totalLatency)&&void 0!==_node$aggregation$tot2?_node$aggregation$tot2:extractLatency(node.event),displayUsage:node.aggregation?(0,frontend_utils.Pz)(node.aggregation):(0,frontend_utils.Pz)(node.event)}}function aggregateSpanMetrics(node){var _event$properties$$ai4,_event$properties$$ai5,_event$properties$$ai6,_event$properties$$ai7;let event=node.event,hasGenerationChildren=!1,totalCost=null!==(_event$properties$$ai4=event.properties.$ai_total_cost_usd)&&void 0!==_event$properties$$ai4?_event$properties$$ai4:0,totalLatency=null!==(_event$properties$$ai5=event.properties.$ai_latency)&&void 0!==_event$properties$$ai5?_event$properties$$ai5:0,inputTokens=null!==(_event$properties$$ai6=event.properties.$ai_input_tokens)&&void 0!==_event$properties$$ai6?_event$properties$$ai6:0,outputTokens=null!==(_event$properties$$ai7=event.properties.$ai_output_tokens)&&void 0!==_event$properties$$ai7?_event$properties$$ai7:0,shouldAggregateCost=void 0===event.properties.$ai_total_cost_usd,shouldAggregateLatency=void 0===event.properties.$ai_latency,shouldAggregateInputTokens=void 0===event.properties.$ai_input_tokens,shouldAggregateOutputTokens=void 0===event.properties.$ai_output_tokens;if(node.children&&node.children.length>0)for(let child of node.children)if("$ai_generation"===child.event.event&&(hasGenerationChildren=!0),child.children&&child.children.length>0){let childAgg=aggregateSpanMetrics(child);shouldAggregateCost&&(totalCost+=childAgg.totalCost),shouldAggregateLatency&&(totalLatency+=childAgg.totalLatency),shouldAggregateInputTokens&&(inputTokens+=childAgg.inputTokens),shouldAggregateOutputTokens&&(outputTokens+=childAgg.outputTokens),childAgg.hasGenerationChildren&&(hasGenerationChildren=!0)}else shouldAggregateCost&&(totalCost+=child.event.properties.$ai_total_cost_usd||0),shouldAggregateLatency&&(totalLatency+=child.event.properties.$ai_latency||0),shouldAggregateInputTokens&&(inputTokens+=child.event.properties.$ai_input_tokens||0),shouldAggregateOutputTokens&&(outputTokens+=child.event.properties.$ai_output_tokens||0);return{totalCost,totalLatency,inputTokens,outputTokens,hasGenerationChildren}}function restoreTree(events,traceId){let childrenMap=new Map,idMap=new Map,visitedNodes=new Set;for(let event of events){var _ref4,_event$properties$$ai8,_event$properties$$ai9;if(FEEDBACK_EVENTS.has(event.event))continue;let eventId=null!==(_ref4=null!==(_event$properties$$ai8=event.properties.$ai_generation_id)&&void 0!==_event$properties$$ai8?_event$properties$$ai8:event.properties.$ai_span_id)&&void 0!==_ref4?_ref4:event.id;idMap.set(eventId,event);let parentId=null!==(_event$properties$$ai9=event.properties.$ai_parent_id)&&void 0!==_event$properties$$ai9?_event$properties$$ai9:event.properties.$ai_trace_id;if(null!=parentId){let existingEvents=childrenMap.get(parentId);existingEvents?existingEvents.push(eventId):childrenMap.set(parentId,[eventId])}}function traverse(spanId){if(visitedNodes.has(spanId))return console.warn("Circular reference detected in trace tree:",spanId),null;let event=idMap.get(spanId);if(!event)return null;visitedNodes.add(spanId);let children=childrenMap.get(spanId),result={event,children:children?.map(child=>traverse(child)).filter(node=>null!==node)};return result.children&&result.children.length>0&&"$ai_generation"!==event.event&&(result.aggregation=aggregateSpanMetrics(result)),visitedNodes.delete(spanId),result}return(childrenMap.get(traceId)||[]).map(childId=>traverse(childId)).filter(node=>null!==node)}var copyToClipboard=__webpack_require__("../../frontend/src/lib/utils/copyToClipboard.tsx");function buildEventExport(event,children){let isGeneration="$ai_generation"===event.event,result={type:isGeneration?"generation":"span",name:(0,frontend_utils.hG)(event)};if(isGeneration&&(event.properties.$ai_model&&(result.model=event.properties.$ai_model),event.properties.$ai_provider&&(result.provider=event.properties.$ai_provider)),isGeneration){var _event$properties$$ai;let inputMessages=(0,frontend_utils.VL)(event.properties.$ai_input,"user"),outputMessages=(0,frontend_utils.VL)(null!==(_event$properties$$ai=event.properties.$ai_output_choices)&&void 0!==_event$properties$$ai?_event$properties$$ai:event.properties.$ai_output,"assistant"),messages=[];inputMessages.length>0&&messages.push(...inputMessages),outputMessages.length>0&&messages.push(...outputMessages),messages.length>0&&(result.messages=messages),event.properties.$ai_tools&&(result.available_tools=event.properties.$ai_tools)}else void 0!==event.properties.$ai_input_state&&(result.input=event.properties.$ai_input_state),void 0!==event.properties.$ai_output_state&&(result.output=event.properties.$ai_output_state);event.properties.$ai_error?result.error=event.properties.$ai_error:event.properties.$ai_is_error&&(result.error="Error occurred (details not available)");let metrics={};return event.properties.$ai_latency&&(metrics.latency=event.properties.$ai_latency),(event.properties.$ai_input_tokens||event.properties.$ai_output_tokens)&&(metrics.tokens={input:event.properties.$ai_input_tokens||0,output:event.properties.$ai_output_tokens||0}),event.properties.$ai_total_cost_usd&&(metrics.cost=event.properties.$ai_total_cost_usd),Object.keys(metrics).length>0&&(result.metrics=metrics),children&&children.length>0&&(result.children=children.map(child=>buildEventExport(child.event,child.children))),result}function buildMinimalTraceJSON(trace,tree){let result={trace_id:trace.id,timestamp:trace.createdAt,total_tokens:{input:trace.inputTokens||0,output:trace.outputTokens||0},events:tree.map(node=>buildEventExport(node.event,node.children))};return trace.traceName&&(result.name=trace.traceName),trace.totalCost&&(result.total_cost=trace.totalCost),result}async function exportTraceToClipboard(trace,tree){let jsonString=JSON.stringify(buildMinimalTraceJSON(trace,tree),null,2);await (0,copyToClipboard.v)(jsonString,"trace data")}var TraceViewMode=function(TraceViewMode){return TraceViewMode.Conversation="conversation",TraceViewMode.Raw="raw",TraceViewMode.Evals="evals",TraceViewMode}(TraceViewMode||{});let scene={component:LLMAnalyticsTraceScene,logic:llmAnalyticsTraceLogic.AX};function LLMAnalyticsTraceScene(){let{traceId,query}=(0,index_esm.useValues)(llmAnalyticsTraceLogic.AX);return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:llmAnalyticsTraceDataLogic,props:{traceId,query},children:(0,jsx_runtime.jsx)(TraceSceneWrapper,{})})}function getSessionFilterUrl(sessionId){let params=new URLSearchParams;return params.set("filters",JSON.stringify([{key:"$ai_session_id",value:[sessionId],operator:"exact",type:"event"}])),`${urls.j.llmAnalyticsTraces()}?${params.toString()}`}function TraceSceneWrapper(){let{eventId}=(0,index_esm.useValues)(llmAnalyticsTraceLogic.AX),{enrichedTree,trace,event,responseLoading,responseError,feedbackEvents,metricEvents,searchQuery,eventMetadata}=(0,index_esm.useValues)(llmAnalyticsTraceDataLogic);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:responseLoading?(0,jsx_runtime.jsx)(src.t2,{}):responseError?(0,jsx_runtime.jsx)(EmptyStates.jC,{}):trace?(0,jsx_runtime.jsxs)("div",{className:"relative flex flex-col gap-3",children:[(0,jsx_runtime.jsx)(SceneBreadcrumbs.A,{}),(0,jsx_runtime.jsxs)("div",{className:"flex items-start justify-between",children:[(0,jsx_runtime.jsx)(TraceMetadata,{trace:trace,metricEvents:metricEvents,feedbackEvents:feedbackEvents}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap justify-end items-center gap-x-2 gap-y-1",children:[(0,jsx_runtime.jsx)(DisplayOptionsSelect,{}),(0,jsx_runtime.jsx)(CopyTraceButton,{trace:trace,tree:enrichedTree})]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 min-h-0 gap-3 flex-col md:flex-row",children:[(0,jsx_runtime.jsx)(TraceSidebar,{trace:trace,eventId:eventId,tree:enrichedTree}),(0,jsx_runtime.jsx)(EventContent,{trace:trace,event:event,tree:enrichedTree,searchQuery:searchQuery,eventMetadata:eventMetadata})]})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"trace"})})}function Chip(_ref){let{title,children,icon}=_ref;return(0,jsx_runtime.jsx)(src.u,{title:title,children:(0,jsx_runtime.jsxs)(src.oe,{size:"medium",className:"bg-surface-primary",icon:icon,children:[(0,jsx_runtime.jsx)("span",{className:"sr-only",children:title}),children]})})}function UsageChip(_ref2){let{event}=_ref2,usage=(0,frontend_utils.Pz)(event);return usage?(0,jsx_runtime.jsx)(Chip,{title:"Usage",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconAIText,{}),children:usage}):null}function TraceMetadata(_ref3){let{trace,metricEvents,feedbackEvents}=_ref3;return(0,jsx_runtime.jsxs)("header",{className:"flex gap-1.5 flex-wrap",children:["person"in trace&&(0,jsx_runtime.jsx)(Chip,{title:"Person",children:(0,jsx_runtime.jsx)(PersonDisplay.I,{withIcon:"sm",person:trace.person})}),trace.aiSessionId&&(0,jsx_runtime.jsx)(Chip,{title:"AI Session ID - Click to filter traces by this session",children:(0,jsx_runtime.jsx)(src.rU,{to:getSessionFilterUrl(trace.aiSessionId),subtle:!0,children:(0,jsx_runtime.jsxs)("span",{className:"font-mono",children:[trace.aiSessionId.slice(0,8),"..."]})})}),(0,jsx_runtime.jsx)(UsageChip,{event:trace}),"number"==typeof trace.inputCost&&(0,jsx_runtime.jsx)(Chip,{title:"Input cost",icon:(0,jsx_runtime.jsx)(icons.Cz,{}),children:(0,frontend_utils.K7)(trace.inputCost)}),"number"==typeof trace.outputCost&&(0,jsx_runtime.jsx)(Chip,{title:"Output cost",icon:(0,jsx_runtime.jsx)(icons.BD,{}),children:(0,frontend_utils.K7)(trace.outputCost)}),"number"==typeof trace.totalCost&&(0,jsx_runtime.jsx)(Chip,{title:"Total cost",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconReceipt,{}),children:(0,frontend_utils.K7)(trace.totalCost)}),metricEvents.map(metric=>(0,jsx_runtime.jsx)(MetricTag,{properties:metric.properties},metric.id)),feedbackEvents.map(feedback=>(0,jsx_runtime.jsx)(FeedbackTag,{properties:feedback.properties},feedback.id))]})}function TraceSidebar(_ref4){let{trace,eventId,tree}=_ref4,ref=(0,react.useRef)(null),{mostRelevantEvent,searchOccurrences}=(0,index_esm.useValues)(llmAnalyticsTraceDataLogic),{searchQuery}=(0,index_esm.useValues)(llmAnalyticsTraceLogic.AX),{setSearchQuery,setEventId}=(0,index_esm.useActions)(llmAnalyticsTraceLogic.AX),[searchValue,setSearchValue]=(0,react.useState)(searchQuery);(0,react.useEffect)(()=>{setSearchValue(searchQuery)},[searchQuery]);let debouncedSetSearchQuery=(0,index_module.y1)(value=>{setSearchQuery(value)},300);return(0,react.useEffect)(()=>{if(eventId&&ref.current){let selectedNode=ref.current.querySelector("[aria-current=true]");selectedNode&&selectedNode.scrollIntoView({block:"center"})}},[eventId]),(0,react.useEffect)(()=>{mostRelevantEvent&&searchQuery.trim()&&setEventId(mostRelevantEvent.id)},[mostRelevantEvent,searchQuery,setEventId]),(0,jsx_runtime.jsxs)("aside",{className:"sticky bottom-[var(--scene-padding)] border-primary max-h-fit bg-surface-primary border rounded overflow-hidden flex flex-col w-full md:w-80",ref:ref,children:[(0,jsx_runtime.jsx)("h3",{className:"font-medium text-sm px-2 my-2",children:"Tree"}),(0,jsx_runtime.jsx)(src.p2,{className:"m-0"}),(0,jsx_runtime.jsxs)("div",{className:"p-2",children:[(0,jsx_runtime.jsx)(src.DF,{placeholder:"Search trace...",prefix:(0,jsx_runtime.jsx)(posthog_icons_es.IconSearch,{}),value:searchValue,onChange:value=>{setSearchValue(value),debouncedSetSearchQuery(value)},size:"small"}),searchValue.trim()&&(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted ml-1 mt-1",children:searchOccurrences.length>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[searchOccurrences.length," ",1===searchOccurrences.length?"occurrence":"occurrences"]}):"No occurrences"}),(0,jsx_runtime.jsx)("div",{className:"mt-2",children:(0,jsx_runtime.jsx)(EventTypeFilters,{})})]}),(0,jsx_runtime.jsxs)("ul",{className:"overflow-y-auto p-1 *:first:mt-0 overflow-x-hidden",children:[(0,jsx_runtime.jsx)(TreeNode,{topLevelTrace:trace,node:{event:trace,displayTotalCost:trace.totalCost||0,displayLatency:trace.totalLatency||0,displayUsage:(0,frontend_utils.Pz)(trace)},isSelected:!eventId||eventId===trace.id,searchQuery:searchQuery}),(0,jsx_runtime.jsx)(TreeNodeChildren,{tree:tree,trace:trace,selectedEventId:eventId,searchQuery:searchQuery})]})]})}function NestingGroup(_ref5){let{onToggle,isCollapsed,children}=_ref5;return(0,jsx_runtime.jsxs)("li",{className:(0,clsx_m.default)("flex items-stretch min-w-0",isCollapsed&&"text-border hover:text-muted"),children:[(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("mb-1 ml-1 cursor-pointer",!isCollapsed&&"text-border hover:text-muted"),onClick:onToggle,children:(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("w-0 h-full my-0 ml-1 mr-2 border-l border-current",isCollapsed&&"border-dashed")})}),(0,jsx_runtime.jsx)("ul",{className:"flex-1 min-w-0",children:children})]})}let TreeNode=react.memo(function TraceNode(_ref6){let{topLevelTrace,node,isSelected,searchQuery}=_ref6,totalCost=node.displayTotalCost,latency=node.displayLatency,usage=node.displayUsage,item=node.event,{eventTypeExpanded}=(0,index_esm.useValues)(llmAnalyticsTraceLogic.AX),isCollapsedDueToFilter=!eventTypeExpanded((0,frontend_utils.x6)(item)),children=[(0,frontend_utils.w1)(item)&&item.properties.$ai_is_error&&(0,jsx_runtime.jsx)(src.oe,{type:"danger",children:"Error"},"error-tag"),latency>=.01&&(0,jsx_runtime.jsx)(src.oe,{type:"muted",children:(0,frontend_utils.DB)(latency)},"latency-tag"),(null!=usage||null!=totalCost)&&(0,jsx_runtime.jsxs)("span",{children:[usage,null!=usage&&null!=totalCost&&(0,jsx_runtime.jsx)("span",{children:" / "}),null!=totalCost&&(0,frontend_utils.K7)(totalCost)]},"usage-tag")],hasChildren=children.some(child=>!!child);return(0,jsx_runtime.jsx)("li",{className:"mt-0.5","aria-current":isSelected,children:(0,jsx_runtime.jsxs)(src.rU,{to:urls.j.llmAnalyticsTrace(topLevelTrace.id,{event:item.id,timestamp:(0,frontend_utils.Wd)(topLevelTrace.createdAt),...searchQuery?.trim()&&{search:searchQuery}}),className:classnames_default()("flex flex-col gap-1 p-1 text-xs rounded min-h-8 justify-center hover:!bg-accent-highlight-secondary",isSelected&&"!bg-accent-highlight-secondary",isCollapsedDueToFilter&&"min-h-4 min-w-0"),children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row items-center gap-1.5",children:[(0,jsx_runtime.jsx)(EventTypeTag,{event:item,size:"small"}),!isCollapsedDueToFilter&&(0,jsx_runtime.jsx)(src.u,{title:(0,frontend_utils.hG)(item),children:searchQuery?.trim()?(0,jsx_runtime.jsx)(SearchHighlight.t,{string:(0,frontend_utils.hG)(item),substring:searchQuery,className:"flex-1"}):(0,jsx_runtime.jsx)("span",{className:"flex-1 truncate",children:(0,frontend_utils.hG)(item)})})]}),!isCollapsedDueToFilter&&renderModelRow(item,searchQuery),!isCollapsedDueToFilter&&hasChildren&&(0,jsx_runtime.jsx)("div",{className:"flex flex-row flex-wrap text-secondary items-center gap-1.5",children:children})]})},item.id)});function renderModelRow(event,searchQuery){if((0,frontend_utils.w1)(event)&&"$ai_generation"===event.event){if(!event.properties.$ai_span_name)return null;let model=event.properties.$ai_model;return event.properties.$ai_provider&&(model=`${model} (${event.properties.$ai_provider})`),searchQuery?.trim()?(0,jsx_runtime.jsx)(SearchHighlight.t,{string:model,substring:searchQuery,className:"flex-1"}):(0,jsx_runtime.jsxs)("span",{className:"flex-1 truncate",children:[" ",model," "]})}return null}function TreeNodeChildren(_ref7){let{tree,trace,selectedEventId,searchQuery}=_ref7,[isCollapsed,setIsCollapsed]=(0,react.useState)(!1);return(0,jsx_runtime.jsx)(NestingGroup,{isCollapsed:isCollapsed,onToggle:()=>setIsCollapsed(!isCollapsed),children:isCollapsed?(0,jsx_runtime.jsxs)("div",{className:"text-secondary hover:text-default text-xxs cursor-pointer p-1",onClick:()=>setIsCollapsed(!1),children:["Show ",(0,utils.Zi)(tree.length,"collapsed child","collapsed children")]}):tree.map(node=>(0,jsx_runtime.jsxs)(react.Fragment,{children:[(0,jsx_runtime.jsx)(TreeNode,{topLevelTrace:trace,node:node,isSelected:!!selectedEventId&&selectedEventId===node.event.id,searchQuery:searchQuery}),node.children&&(0,jsx_runtime.jsx)(TreeNodeChildren,{tree:node.children,trace:trace,selectedEventId:selectedEventId,searchQuery:searchQuery})]},node.event.id))})}function EventContentDisplay(_ref8){let{input,output,raisedError}=_ref8,{searchQuery}=(0,index_esm.useValues)(llmAnalyticsTraceLogic.AX);return input||output?(0,jsx_runtime.jsx)(LLMInputOutput.D,{inputDisplay:(0,jsx_runtime.jsx)("div",{className:"p-2 text-xs border rounded bg-[var(--color-bg-fill-secondary)]",children:(0,utils.Kn)(input)?(0,jsx_runtime.jsx)(HighlightedJSONViewer.Q,{src:input,collapsed:4,searchQuery:searchQuery}):(0,jsx_runtime.jsx)("span",{className:"font-mono",children:JSON.stringify(null!=input?input:null)})}),outputDisplay:(0,jsx_runtime.jsx)("div",{className:(0,css_classes.cn)("p-2 text-xs border rounded",raisedError?"bg-[var(--color-bg-fill-error-tertiary)]":"bg-[var(--color-bg-fill-success-tertiary)]"),children:(0,utils.Kn)(output)?(0,jsx_runtime.jsx)(HighlightedJSONViewer.Q,{src:output,collapsed:4,searchQuery:searchQuery}):(0,jsx_runtime.jsx)("span",{className:"font-mono",children:JSON.stringify(null!=output?output:null)})})}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})}function findNodeForEvent(tree,eventId){for(let node of tree){if(node.event.id===eventId)return node;if(node.children){let result=findNodeForEvent(node.children,eventId);if(result)return result}}return null}let EventContent=react.memo(_ref9=>{var _event$properties$$ai2,_ref10,_ref11,_event$properties$$ai3,_event$properties$$ai4,_event$properties$$ai5;let{trace,event,eventMetadata,tree,searchQuery}=_ref9,{setupPlaygroundFromEvent}=(0,index_esm.useActions)(llmAnalyticsPlaygroundLogic.s),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.featureFlagLogic),[viewMode,setViewMode]=(0,react.useState)(TraceViewMode.Conversation),node=event&&(0,frontend_utils.w1)(event)?findNodeForEvent(tree,event.id):null,aggregation=node?.aggregation||null,childEventsForSessionId=node?.children?.map(child=>child.event),sessionId=event?(0,frontend_utils.mL)(event,childEventsForSessionId):null,hasSessionRecording=!!sessionId,isGenerationEvent=event&&(0,frontend_utils.w1)(event)&&"$ai_generation"===event.event,showPlaygroundButton=isGenerationEvent&&featureFlags[constants.y8.LLM_OBSERVABILITY_PLAYGROUND],showSaveToDatasetButton=featureFlags[constants.y8.LLM_ANALYTICS_DATASETS],showEvalsTab=isGenerationEvent&&featureFlags[constants.y8.LLM_ANALYTICS_EVALUATIONS];return(0,jsx_runtime.jsx)("div",{className:"flex-1 bg-surface-primary max-h-fit border rounded flex flex-col border-primary p-4 overflow-y-auto",children:event?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("header",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-row flex items-center gap-2",children:[(0,jsx_runtime.jsx)(EventTypeTag,{event:event}),(0,jsx_runtime.jsx)("h3",{className:"text-lg font-semibold p-0 m-0 truncate flex-1",children:(0,frontend_utils.hG)(event)})]}),(0,frontend_utils.w1)(event)?(0,jsx_runtime.jsx)(MetadataHeader.I,{isError:event.properties.$ai_is_error,inputTokens:event.properties.$ai_input_tokens,outputTokens:event.properties.$ai_output_tokens,cacheReadTokens:event.properties.$ai_cache_read_input_tokens,cacheWriteTokens:event.properties.$ai_cache_creation_input_tokens,totalCostUsd:event.properties.$ai_total_cost_usd,model:event.properties.$ai_model,latency:event.properties.$ai_latency,timestamp:event.createdAt}):(0,jsx_runtime.jsx)(MetadataHeader.I,{inputTokens:event.inputTokens,outputTokens:event.outputTokens,totalCostUsd:event.totalCost,latency:event.totalLatency,timestamp:event.createdAt}),(0,frontend_utils.w1)(event)&&(0,jsx_runtime.jsx)(ParametersHeader,{eventProperties:event.properties}),aggregation&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-row flex-wrap items-center gap-2",children:[aggregation.totalCost>0&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",size:"small",children:["Total Cost: ",(0,frontend_utils.K7)(aggregation.totalCost)]}),aggregation.totalLatency>0&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",size:"small",children:["Total Latency: ",(0,frontend_utils.DB)(aggregation.totalLatency)]}),(aggregation.inputTokens>0||aggregation.outputTokens>0)&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",size:"small",children:["Tokens: ",aggregation.inputTokens," → ",aggregation.outputTokens," (∑"," ",aggregation.inputTokens+aggregation.outputTokens,")"]})]}),(showPlaygroundButton||hasSessionRecording||showSaveToDatasetButton)&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-row items-center gap-2",children:[showPlaygroundButton&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconChat,{}),onClick:()=>{let model,input,tools;if(event){if((0,frontend_utils.w1)(event)){var _event$properties$$ai;model=event.properties.$ai_model,input=null!==(_event$properties$$ai=event.properties.$ai_input)&&void 0!==_event$properties$$ai?_event$properties$$ai:event.properties.$ai_input_state,tools=event.properties.$ai_tools}setupPlaygroundFromEvent({model,input,tools})}},tooltip:"Try this prompt in the playground",children:"Try in Playground"}),showSaveToDatasetButton&&(0,jsx_runtime.jsx)(SaveToDatasetButton,{traceId:trace.id,timestamp:trace.createdAt,sourceId:event.id,input:(0,frontend_utils.w1)(event)?null!==(_event$properties$$ai2=event.properties.$ai_input)&&void 0!==_event$properties$$ai2?_event$properties$$ai2:event.properties.$ai_input_state:event.inputState,output:(0,frontend_utils.w1)(event)?null!==(_ref10=null!==(_ref11=null!==(_event$properties$$ai3=event.properties.$ai_output_choices)&&void 0!==_event$properties$$ai3?_event$properties$$ai3:event.properties.$ai_output)&&void 0!==_ref11?_ref11:event.properties.$ai_output_state)&&void 0!==_ref10?_ref10:event.properties.$ai_error:event.outputState,metadata:eventMetadata}),hasSessionRecording&&(0,jsx_runtime.jsx)(ViewRecordingButton.Z,{inModal:!0,type:"secondary",size:"xsmall","data-attr":"llm-analytics",sessionId:sessionId||void 0,timestamp:(0,frontend_utils.sl)(event.createdAt)})]})]}),(0,jsx_runtime.jsx)(src.TP,{activeKey:viewMode,onChange:setViewMode,tabs:[{key:TraceViewMode.Conversation,label:"Conversation",content:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,frontend_utils.w1)(event)?"$ai_generation"===event.event?(0,jsx_runtime.jsx)(ConversationMessagesDisplay.F4,{inputNormalized:(0,frontend_utils.VL)(event.properties.$ai_input,"user",event.properties.$ai_tools),outputNormalized:(0,frontend_utils.VL)(null!==(_event$properties$$ai4=event.properties.$ai_output_choices)&&void 0!==_event$properties$$ai4?_event$properties$$ai4:event.properties.$ai_output,"assistant"),errorData:event.properties.$ai_error,httpStatus:event.properties.$ai_http_status,raisedError:event.properties.$ai_is_error,searchQuery:searchQuery}):"$ai_embedding"===event.event?(0,jsx_runtime.jsx)(EventContentDisplay,{input:event.properties.$ai_input,output:"Embedding vector generated"}):(0,jsx_runtime.jsx)(EventContentDisplay,{input:event.properties.$ai_input_state,output:null!==(_event$properties$$ai5=event.properties.$ai_output_state)&&void 0!==_event$properties$$ai5?_event$properties$$ai5:event.properties.$ai_error,raisedError:event.properties.$ai_is_error}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(TraceMetricsTable,{}),(0,jsx_runtime.jsx)(EventContentDisplay,{input:event.inputState,output:event.outputState})]})})},{key:TraceViewMode.Raw,label:"Raw",content:(0,jsx_runtime.jsx)("div",{className:"p-2",children:(0,jsx_runtime.jsx)(JSONViewer.C,{src:event,collapsed:2})})},...showEvalsTab?[{key:TraceViewMode.Evals,label:"Evaluations",content:(0,jsx_runtime.jsx)(EvalsTabContent,{generationEventId:event.id})}]:[]]})]}):(0,jsx_runtime.jsx)(EmptyStates.dV,{heading:"Event not found",detail:"Check if the event ID is correct."})})});function EventTypeTag(_ref12){let{event,size}=_ref12,eventType=(0,frontend_utils.x6)(event),tagType="completion";switch(eventType){case"generation":tagType="success";break;case"embedding":tagType="warning";break;case"span":tagType="default";break;case"trace":tagType="completion"}return(0,jsx_runtime.jsx)(src.oe,{className:"uppercase",type:tagType,size:size,children:eventType})}function EventTypeFilters(){let{availableEventTypes}=(0,index_esm.useValues)(llmAnalyticsTraceDataLogic),{eventTypeExpanded}=(0,index_esm.useValues)(llmAnalyticsTraceLogic.AX),{toggleEventTypeExpanded}=(0,index_esm.useActions)(llmAnalyticsTraceLogic.AX);return 0===availableEventTypes.length?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{}):(0,jsx_runtime.jsxs)("fieldset",{className:"border border-border rounded p-1.5",children:[(0,jsx_runtime.jsx)("legend",{className:"text-xs font-medium text-muted px-1",children:"Expand"}),(0,jsx_runtime.jsx)("div",{className:"flex flex-wrap gap-x-3 gap-y-1",children:availableEventTypes.map(eventType=>(0,jsx_runtime.jsx)(src.Hw,{checked:eventTypeExpanded(eventType),onChange:()=>toggleEventTypeExpanded(eventType),label:(0,jsx_runtime.jsxs)("span",{className:"capitalize text-xs",children:[eventType,"s"]}),size:"small"},eventType))})]})}function CopyTraceButton(_ref13){let{trace,tree}=_ref13,handleCopyTrace=async()=>{await exportTraceToClipboard(trace,tree)};return(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconCopy,{}),onClick:handleCopyTrace,tooltip:"Copy trace to clipboard",children:"Copy trace JSON"})}function DisplayOptionsSelect(){let{displayOption}=(0,index_esm.useValues)(llmAnalyticsTraceLogic.AX),{setDisplayOption}=(0,index_esm.useActions)(llmAnalyticsTraceLogic.AX),displayOptions=[{value:llmAnalyticsTraceLogic.zY.ExpandAll,label:"Expand all"},{value:llmAnalyticsTraceLogic.zY.CollapseExceptOutputAndLastInput,label:"Collapse except output and last input"}];return(0,jsx_runtime.jsx)(src.Yv,{size:"xsmall",value:displayOption,onChange:setDisplayOption,options:displayOptions,tooltip:"Configure how generation conversation messages are displayed"})}function TraceMetricsTable(){let{metricsAndFeedbackEvents}=(0,index_esm.useValues)(llmAnalyticsTraceDataLogic);return metricsAndFeedbackEvents?.length?(0,jsx_runtime.jsxs)("div",{className:"mb-3",children:[(0,jsx_runtime.jsxs)("h4",{className:"flex items-center gap-x-1.5 text-xs font-semibold mb-2",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconMessage,{className:"text-base"}),"Metrics and user feedback"]}),(0,jsx_runtime.jsx)(src.g3,{columns:[{title:"Metric",key:"metric",render:(_,_ref14)=>{let{metric}=_ref14;return(0,jsx_runtime.jsx)("span",{children:(0,utils.UV)(metric)})},width:"40%"},{title:"Value",key:"value",render:(_,_ref15)=>{let{value}=_ref15;return(0,jsx_runtime.jsx)("span",{children:null!=value?value:"–"})},width:"60%"}],dataSource:metricsAndFeedbackEvents})]}):null}EventContent.displayName="EventContent"},"../../products/llm_analytics/frontend/components/JSONEditor.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{q:()=>JSONEditor});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),lib_monaco_CodeEditor__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/src/lib/monaco/CodeEditor.tsx"),_datasets_utils__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../products/llm_analytics/frontend/datasets/utils.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let JSONEditor=react__WEBPACK_IMPORTED_MODULE_0__.memo(_ref=>{let{onChange,lineHeight=20,defaultNumberOfLines=3,maxNumberOfLines=24,value="",readOnly=!1,autoFocus=!1}=_ref,defaultHeight=lineHeight*(Math.max(defaultNumberOfLines,(value?.toString()||"").split(/\r\n|\r|\n/).length)+1),[height,setHeight]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(defaultHeight),updateHeight=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)(val=>{val?setHeight(lineHeight*(Math.min(Math.max(val.split(/\r\n|\r|\n/).length,defaultNumberOfLines),maxNumberOfLines)+1)):setHeight(lineHeight*(defaultNumberOfLines+1))},[defaultNumberOfLines,lineHeight,maxNumberOfLines]);(0,react__WEBPACK_IMPORTED_MODULE_0__.useLayoutEffect)(()=>{(0,_datasets_utils__WEBPACK_IMPORTED_MODULE_3__.B7)(value)||height===defaultHeight||updateHeight(value)},[value,height,defaultHeight,updateHeight]);let onTextChange=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)(val=>{updateHeight(val),onChange&&onChange(val)},[onChange,defaultNumberOfLines,lineHeight,maxNumberOfLines,updateHeight]),options=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)(()=>({readOnly:readOnly,lineHeight:lineHeight,minimap:{enabled:!1},scrollbar:{alwaysConsumeMouseWheel:!1},padding:{bottom:0,top:10},overviewRulerLanes:0,hideCursorInOverviewRuler:!0,overviewRulerBorder:!1,glyphMargin:!0,folding:!1,lineNumbers:"off",lineDecorationsWidth:0,lineNumbersMinChars:0,renderLineHighlight:"none",cursorStyle:"line",scrollBeyondLastLine:!1,quickSuggestions:!1,contextmenu:!1}),[lineHeight,readOnly]);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(lib_monaco_CodeEditor__WEBPACK_IMPORTED_MODULE_1__.p,{className:"rounded [&_.monaco-editor]:rounded [&_.monaco-diff-editor]:rounded [&_.overflow-guard]:rounded",language:"json",height:height,value:value,options:options,onChange:onTextChange,autoFocus:autoFocus})});JSONEditor.displayName="JSONEditor"},"../../products/llm_analytics/frontend/datasets/DatasetItemModal.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Q:()=>DatasetItemModal});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonModal=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonModal/LemonModal.tsx"),JSONEditor=__webpack_require__("../../products/llm_analytics/frontend/components/JSONEditor.tsx"),api=__webpack_require__("../../frontend/src/lib/api.ts"),utils=__webpack_require__("../../products/llm_analytics/frontend/datasets/utils.ts");let FORM_DEFAULT_VALUE={input:utils.Kc,output:utils.Kc,metadata:utils.Kc},datasetItemModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","llm-analytics","datasetItemModalLogic"]),(0,index_esm.props)({datasetId:"",partialDatasetItem:null,closeModal:()=>{}}),(0,index_esm.key)(_ref=>{let{datasetId,partialDatasetItem}=_ref;return`dataset-item-${datasetId}-${partialDatasetItem?.id||"new"}`}),(0,index_esm.actions)({setShouldCloseModal:shouldCloseModal=>({shouldCloseModal}),setRefetchDatasetItems:refetchDatasetItems=>({refetchDatasetItems})}),(0,index_esm.reducers)(()=>({shouldCloseModal:[!0,{setShouldCloseModal:(_,_ref2)=>{let{shouldCloseModal}=_ref2;return shouldCloseModal}}],refetchDatasetItems:[!1,{setRefetchDatasetItems:(_,_ref3)=>{let{refetchDatasetItems}=_ref3;return refetchDatasetItems}}]})),(0,lib.forms)(_ref4=>{let{props,actions,values}=_ref4;return{datasetItemForm:{defaults:FORM_DEFAULT_VALUE,errors:_ref5=>{let{input,output,metadata}=_ref5;return{input:(0,utils.Fh)(input)?void 0:"Input must contain a valid JSON object",output:(0,utils.Fh)(output)?void 0:"Output must contain a valid JSON object",metadata:(0,utils.Fh)(metadata)?void 0:"Metadata must contain a valid JSON object"}},submit:async formValues=>{try{if(props.partialDatasetItem?.id){let updatedItem=await api.ZP.datasetItems.update(props.partialDatasetItem.id,{...props.partialDatasetItem,input:(0,utils.B7)(formValues.input),output:(0,utils.B7)(formValues.output),metadata:(0,utils.B7)(formValues.metadata)});src.UJ.success("Dataset item updated successfully"),props.closeModal(!0),actions.setDatasetItemFormValues(getDatasetItemFormDefaults(updatedItem))}else await api.ZP.datasetItems.create({...props.partialDatasetItem,dataset:props.datasetId,input:(0,utils.B7)(formValues.input),output:(0,utils.B7)(formValues.output),metadata:(0,utils.B7)(formValues.metadata)}),src.UJ.success("Dataset item created successfully"),values.shouldCloseModal?props.closeModal(!0):(actions.setRefetchDatasetItems(!0),actions.setDatasetItemFormValues(FORM_DEFAULT_VALUE)),actions.setShouldCloseModal(!0)}catch(error){console.error(error),src.UJ.error("Failed to save a dataset item.")}}}}}),(0,index_esm.defaults)(_ref6=>{let{props}=_ref6;return{datasetItemForm:props.partialDatasetItem?getDatasetItemFormDefaults(props.partialDatasetItem):FORM_DEFAULT_VALUE}}),(0,index_esm.propsChanged)(_ref7=>{let{props,actions}=_ref7;!props.partialDatasetItem&&props.isModalOpen&&actions.resetDatasetItemForm(),props.isModalOpen&&actions.setRefetchDatasetItems(!1)})]);function getDatasetItemFormDefaults(partialDatasetItem){return{input:(0,utils.pP)(partialDatasetItem.input)||utils.Kc,output:(0,utils.pP)(partialDatasetItem.output)||utils.Kc,metadata:(0,utils.pP)(partialDatasetItem.metadata)||utils.Kc}}var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let DatasetItemModal=react.memo(function DatasetItemModal(_ref){let{isOpen,onClose,partialDatasetItem,datasetId,displayBulkCreationButton,title}=_ref,logicProps={datasetId,partialDatasetItem,closeModal:onClose,isModalOpen:isOpen},{isDatasetItemFormSubmitting,refetchDatasetItems}=(0,index_esm.useValues)(datasetItemModalLogic(logicProps)),{submitDatasetItemForm,setShouldCloseModal}=(0,index_esm.useActions)(datasetItemModalLogic(logicProps));return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:()=>onClose(refetchDatasetItems),maxWidth:"40rem",simple:!0,className:"w-full",children:(0,jsx_runtime.jsxs)(lib.Form,{logic:datasetItemModalLogic,props:logicProps,formKey:"datasetItemForm",enableFormOnSubmit:!0,className:"flex flex-col overflow-y-hidden",children:[(0,jsx_runtime.jsx)(LemonModal.R6,{children:(0,jsx_runtime.jsx)("h3",{children:null!=title?title:partialDatasetItem?.id?"Edit dataset item":"New dataset item"})}),(0,jsx_runtime.jsxs)(LemonModal.TL,{className:"flex flex-col gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"input",label:"Input",children:(0,jsx_runtime.jsx)(JSONEditor.q,{})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"output",label:"Output",children:(0,jsx_runtime.jsx)(JSONEditor.q,{})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"metadata",label:"Metadata",children:(0,jsx_runtime.jsx)(JSONEditor.q,{})})]}),(0,jsx_runtime.jsxs)(LemonModal.oC,{children:[displayBulkCreationButton&&!partialDatasetItem?.id&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",loading:isDatasetItemFormSubmitting,htmlType:"submit",onClick:e=>{e.preventDefault(),setShouldCloseModal(!1),submitDatasetItemForm()},children:"Save and add another"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",htmlType:"submit",loading:isDatasetItemFormSubmitting,children:"Save"})]})]})})})},"../../products/llm_analytics/frontend/datasets/utils.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{B7:()=>coerceJsonToObject,Fh:()=>isStringJsonObject,Kc:()=>EMPTY_JSON,pP:()=>prettifyJson});let EMPTY_JSON="{\n  \n}";function coerceJsonToObject(maybeJson){if(!maybeJson)return null;try{let parsedObject=JSON.parse(maybeJson);if("object"==typeof parsedObject&&Object.keys(parsedObject).length>0)return parsedObject;return null}catch{return null}}function isStringJsonObject(maybeJson){if(!maybeJson)return!0;try{let parsedObject=JSON.parse(maybeJson);if("object"!=typeof parsedObject||null===parsedObject)return!1}catch{return!1}return!0}function prettifyJson(json){let stringified=json?JSON.stringify(json,null,2):null;return"{}"===stringified&&(stringified=EMPTY_JSON),stringified}},"../../products/llm_analytics/frontend/evaluations/llmEvaluationsLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{k:()=>llmEvaluationsLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib_api__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/src/lib/api.ts"),scenes_teamLogic__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx");let llmEvaluationsLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["products","llm_analytics","evaluations","llmEvaluationsLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({loadEvaluations:!0,loadEvaluationsSuccess:evaluations=>({evaluations}),createEvaluation:evaluation=>({evaluation}),createEvaluationSuccess:evaluation=>({evaluation}),updateEvaluation:(id,evaluation)=>({id,evaluation}),updateEvaluationSuccess:(id,evaluation)=>({id,evaluation}),deleteEvaluation:id=>({id}),deleteEvaluationSuccess:id=>({id}),duplicateEvaluation:id=>({id}),duplicateEvaluationSuccess:evaluation=>({evaluation}),toggleEvaluationEnabled:id=>({id}),toggleEvaluationEnabledSuccess:id=>({id}),setEvaluationsFilter:filter=>({filter})}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({evaluations:[[],{loadEvaluationsSuccess:(_,_ref)=>{let{evaluations}=_ref;return evaluations},createEvaluationSuccess:(state,_ref2)=>{let{evaluation}=_ref2;return[...state,evaluation]},updateEvaluationSuccess:(state,_ref3)=>{let{id,evaluation}=_ref3;return state.map(e=>e.id===id?{...e,...evaluation}:e)},deleteEvaluationSuccess:(state,_ref4)=>{let{id}=_ref4;return state.filter(e=>e.id!==id)},duplicateEvaluationSuccess:(state,_ref5)=>{let{evaluation}=_ref5;return[...state,evaluation]},toggleEvaluationEnabledSuccess:(state,_ref6)=>{let{id}=_ref6;return state.map(e=>e.id===id?{...e,enabled:!e.enabled}:e)}}],evaluationsLoading:[!1,{loadEvaluations:()=>!0,loadEvaluationsSuccess:()=>!1}],evaluationsFilter:["",{setEvaluationsFilter:(_,_ref7)=>{let{filter}=_ref7;return filter}}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref8=>{let{actions,values}=_ref8;return{loadEvaluations:async()=>{try{let teamId=scenes_teamLogic__WEBPACK_IMPORTED_MODULE_2__.teamLogic.values.currentTeamId;if(!teamId)return;let response=await lib_api__WEBPACK_IMPORTED_MODULE_1__.ZP.get(`/api/environments/${teamId}/evaluations/`);actions.loadEvaluationsSuccess(response.results)}catch(error){console.error("Failed to load evaluations:",error),actions.loadEvaluationsSuccess([])}},createEvaluation:async _ref9=>{let{evaluation}=_ref9;try{let teamId=scenes_teamLogic__WEBPACK_IMPORTED_MODULE_2__.teamLogic.values.currentTeamId;if(!teamId)return;let response=await lib_api__WEBPACK_IMPORTED_MODULE_1__.ZP.create(`/api/environments/${teamId}/evaluations/`,evaluation);actions.createEvaluationSuccess(response)}catch(error){console.error("Failed to create evaluation:",error)}},updateEvaluation:async _ref10=>{let{id,evaluation}=_ref10;try{let teamId=scenes_teamLogic__WEBPACK_IMPORTED_MODULE_2__.teamLogic.values.currentTeamId;if(!teamId)return;let response=await lib_api__WEBPACK_IMPORTED_MODULE_1__.ZP.update(`/api/environments/${teamId}/evaluations/${id}/`,evaluation);actions.updateEvaluationSuccess(id,response)}catch(error){console.error("Failed to update evaluation:",error)}},deleteEvaluation:async _ref11=>{let{id}=_ref11;try{let teamId=scenes_teamLogic__WEBPACK_IMPORTED_MODULE_2__.teamLogic.values.currentTeamId;if(!teamId)return;await lib_api__WEBPACK_IMPORTED_MODULE_1__.ZP.update(`/api/environments/${teamId}/evaluations/${id}/`,{deleted:!0}),actions.deleteEvaluationSuccess(id)}catch(error){console.error("Failed to delete evaluation:",error)}},duplicateEvaluation:async _ref12=>{let{id}=_ref12;try{let original=values.evaluations.find(e=>e.id===id);if(!original)return;let duplicate={name:`${original.name} (Copy)`,description:original.description,enabled:original.enabled,evaluation_type:original.evaluation_type,evaluation_config:original.evaluation_config,output_type:original.output_type,output_config:original.output_config,conditions:original.conditions},teamId=scenes_teamLogic__WEBPACK_IMPORTED_MODULE_2__.teamLogic.values.currentTeamId;if(!teamId)return;let response=await lib_api__WEBPACK_IMPORTED_MODULE_1__.ZP.create(`/api/environments/${teamId}/evaluations/`,duplicate);actions.duplicateEvaluationSuccess(response)}catch(error){console.error("Failed to duplicate evaluation:",error)}},toggleEvaluationEnabled:async _ref13=>{let{id}=_ref13;try{let evaluation=values.evaluations.find(e=>e.id===id);if(!evaluation)return;let teamId=scenes_teamLogic__WEBPACK_IMPORTED_MODULE_2__.teamLogic.values.currentTeamId;if(!teamId)return;await lib_api__WEBPACK_IMPORTED_MODULE_1__.ZP.update(`/api/environments/${teamId}/evaluations/${id}/`,{enabled:!evaluation.enabled}),actions.toggleEvaluationEnabledSuccess(id)}catch(error){console.error("Failed to toggle evaluation enabled:",error)}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({filteredEvaluations:[s=>[s.evaluations,s.evaluationsFilter],(evaluations,filter)=>filter?evaluations.filter(e=>e.name.toLowerCase().includes(filter.toLowerCase())||e.description?.toLowerCase().includes(filter.toLowerCase())||e.evaluation_config.prompt.toLowerCase().includes(filter.toLowerCase())):evaluations]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref14=>{let{actions}=_ref14;actions.loadEvaluations()})])}}]);