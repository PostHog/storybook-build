(window.webpackJsonp=window.webpackJsonp||[]).push([[299],{"./frontend/src/scenes/instance/AsyncMigrations/AsyncMigrations.tsx":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"scene",(function(){return scene})),__webpack_require__.d(__webpack_exports__,"AsyncMigrations",(function(){return AsyncMigrations}));var react=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/index.js"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),tabs=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/tabs/index.js"),es_progress=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/progress/index.js"),es_button=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/button/index.js"),space=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/space/index.js"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@16.14.0/node_modules/kea/lib/index.esm.js"),PlayCircleOutlined=__webpack_require__("./node_modules/.pnpm/@ant-design+icons@4.7.0_react-dom@16.14.0_react@16.14.0/node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts"),systemStatusLogic=__webpack_require__("./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts"),lemonToast=__webpack_require__("./frontend/src/lib/lemon-ui/lemonToast.tsx"),preflightLogic=__webpack_require__("./frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.3_kea@3.1.5/node_modules/kea-router/lib/index.js");let AsyncMigrationStatus=function(AsyncMigrationStatus){return AsyncMigrationStatus[AsyncMigrationStatus.NotStarted=0]="NotStarted",AsyncMigrationStatus[AsyncMigrationStatus.Running=1]="Running",AsyncMigrationStatus[AsyncMigrationStatus.CompletedSuccessfully=2]="CompletedSuccessfully",AsyncMigrationStatus[AsyncMigrationStatus.Errored=3]="Errored",AsyncMigrationStatus[AsyncMigrationStatus.RolledBack=4]="RolledBack",AsyncMigrationStatus[AsyncMigrationStatus.Starting=5]="Starting",AsyncMigrationStatus[AsyncMigrationStatus.FailedAtStartup=6]="FailedAtStartup",AsyncMigrationStatus}({}),AsyncMigrationsTab=function(AsyncMigrationsTab){return AsyncMigrationsTab.Management="management",AsyncMigrationsTab.FutureMigrations="future",AsyncMigrationsTab.Settings="settings",AsyncMigrationsTab}({});const migrationStatusNumberToMessage={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},asyncMigrationsLogic=Object(index_esm.kea)([Object(index_esm.path)(["scenes","instance","AsyncMigrations","asyncMigrationsLogic"]),Object(index_esm.connect)({values:[preflightLogic.a,["preflight"]]}),Object(index_esm.actions)({triggerMigration:migration=>({migration:migration}),resumeMigration:migration=>({migration:migration}),rollbackMigration:migration=>({migration:migration}),forceStopMigration:migration=>({migration:migration}),forceStopMigrationWithoutRollback:migration=>({migration:migration}),updateMigrationStatus:(migration,endpoint,message)=>({migration:migration,endpoint:endpoint,message:message}),setActiveTab:tab=>({tab:tab}),updateSetting:(settingKey,newValue)=>({settingKey:settingKey,newValue:newValue}),loadAsyncMigrationErrors:migrationId=>({migrationId:migrationId}),loadAsyncMigrationErrorsSuccess:(migrationId,errors)=>({migrationId:migrationId,errors:errors}),loadAsyncMigrationErrorsFailure:(migrationId,error)=>({migrationId:migrationId,error:error}),openAsyncMigrationsModal:(migration,endpoint,message)=>({migration:migration,endpoint:endpoint,message:message}),closeAsyncMigrationsModal:!0}),Object(index_esm.reducers)({activeTab:[AsyncMigrationsTab.Management,{setActiveTab:(_,_ref)=>{let{tab:tab}=_ref;return tab}}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:(state,_ref2)=>{let{migrationId:migrationId,errors:errors}=_ref2;return{...state,[migrationId]:errors}}}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:(state,_ref3)=>{let{migrationId:migrationId}=_ref3;return{...state,[migrationId]:!0}},loadAsyncMigrationErrorsSuccess:(state,_ref4)=>{let{migrationId:migrationId}=_ref4;return{...state,[migrationId]:!1}},loadAsyncMigrationErrorsFailure:(state,_ref5)=>{let{migrationId:migrationId}=_ref5;return{...state,[migrationId]:!1}}}],activeAsyncMigrationModal:[null,{openAsyncMigrationsModal:(_,payload)=>payload,closeAsyncMigrationsModal:()=>null,updateMigrationStatus:()=>null}]}),Object(lib.loaders)((()=>({asyncMigrations:[[],{loadAsyncMigrations:async()=>{var _userLogic$values$use;return null!==(_userLogic$values$use=userLogic.a.values.user)&&void 0!==_userLogic$values$use&&_userLogic$values$use.is_staff?(await api.b.get("api/async_migrations")).results:[]}}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:async()=>{var _userLogic$values$use2;if(null===(_userLogic$values$use2=userLogic.a.values.user)||void 0===_userLogic$values$use2||!_userLogic$values$use2.is_staff)return[];return(await api.b.get("api/instance_settings")).results.filter((setting=>setting.key.includes("ASYNC_MIGRATIONS")))}}]}))),Object(index_esm.selectors)({isAnyMigrationRunning:[s=>[s.asyncMigrations],asyncMigrations=>asyncMigrations.some((migration=>[AsyncMigrationStatus.Running,AsyncMigrationStatus.Starting].includes(migration.status)))],actionableMigrations:[s=>[s.asyncMigrations],asyncMigrations=>asyncMigrations.filter((migration=>migration.is_available))],futureMigrations:[s=>[s.asyncMigrations],asyncMigrations=>asyncMigrations.filter((migration=>!migration.is_available))]}),Object(index_esm.listeners)((_ref6=>{let{actions:actions}=_ref6;return{triggerMigration:async _ref7=>{let{migration:migration}=_ref7;Object.keys(migration.parameter_definitions).length>0?actions.openAsyncMigrationsModal(migration,"trigger","Migration triggered successfully"):actions.updateMigrationStatus(migration,"trigger","Migration triggered successfully")},resumeMigration:async _ref8=>{let{migration:migration}=_ref8;Object.keys(migration.parameter_definitions).length>0?actions.openAsyncMigrationsModal(migration,"resume","Migration resume triggered successfully"):actions.updateMigrationStatus(migration,"resume","Migration resume triggered successfully")},rollbackMigration:async _ref9=>{let{migration:migration}=_ref9;actions.updateMigrationStatus(migration,"rollback","Migration rollback triggered successfully")},forceStopMigration:async _ref10=>{let{migration:migration}=_ref10;actions.updateMigrationStatus(migration,"force_stop","Force stop triggered successfully")},forceStopMigrationWithoutRollback:async _ref11=>{let{migration:migration}=_ref11;actions.updateMigrationStatus(migration,"force_stop_without_rollback","Force stop without rollback triggered successfully")},updateMigrationStatus:async _ref12=>{let{migration:migration,endpoint:endpoint,message:message}=_ref12;const res=await api.b.create(`/api/async_migrations/${migration.id}/${endpoint}`,{parameters:migration.parameters});res.success?(lemonToast.d.success(message),actions.loadAsyncMigrations()):lemonToast.d.error(res.error)},updateSetting:async _ref13=>{let{settingKey:settingKey,newValue:newValue}=_ref13;try{await api.b.update(`/api/instance_settings/${settingKey}`,{value:newValue}),lemonToast.d.success(`Instance setting ${settingKey} updated`),actions.loadAsyncMigrationSettings(),actions.loadAsyncMigrations(),systemStatusLogic.b.actions.loadSystemStatus()}catch{lemonToast.d.error("Failed to trigger migration")}},loadAsyncMigrationErrors:async _ref14=>{let{migrationId:migrationId}=_ref14;try{const errorsForMigration=await api.b.get(`api/async_migrations/${migrationId}/errors`);actions.loadAsyncMigrationErrorsSuccess(migrationId,errorsForMigration)}catch(error){actions.loadAsyncMigrationErrorsFailure(migrationId,error)}}}})),Object(index_esm.events)((_ref15=>{let{actions:actions}=_ref15;return{afterMount:()=>{actions.loadAsyncMigrations(),actions.loadAsyncMigrationSettings()}}})),Object(kea_router_lib.actionToUrl)((_ref16=>{let{values:values}=_ref16;return{setActiveTab:()=>"/instance/async_migrations"+(values.activeTab===AsyncMigrationsTab.Management?"":"/"+values.activeTab)}})),Object(kea_router_lib.urlToAction)((_ref17=>{let{actions:actions,values:values}=_ref17;return{"/instance/async_migrations(/:tab)":_ref18=>{let{tab:tab}=_ref18;tab&&tab!==values.activeTab&&tab!==AsyncMigrationsTab.Management&&actions.setActiveTab(tab)}}}))]);var Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip.tsx"),Spinner=__webpack_require__("./frontend/src/lib/lemon-ui/Spinner/Spinner.tsx"),row=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/row/index.js"),col=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/col/index.js"),input=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/input/index.js"),divider=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/divider/index.js"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/jsx-runtime.js");function SettingUpdateField(_ref){let{setting:setting}=_ref;const{updateSetting:updateSetting}=Object(index_esm.useActions)(asyncMigrationsLogic),[inputValue,setInputValue]=Object(react.useState)(String(setting.value));return Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)("h4",{children:setting.key}),Object(jsx_runtime.jsx)("p",{children:setting.description}),Object(jsx_runtime.jsxs)(row.a,{gutter:[8,8],children:[Object(jsx_runtime.jsx)(col.a,{span:8,children:Object(jsx_runtime.jsx)(input.a,{value:inputValue,onChange:e=>setInputValue(e.target.value)})}),Object(jsx_runtime.jsx)(col.a,{span:16,children:Object(jsx_runtime.jsx)(es_button.a,{disabled:String(setting.value)===inputValue,type:"primary",onClick:()=>updateSetting(setting.key,inputValue),children:"Update"})})]}),Object(jsx_runtime.jsx)(divider.a,{})]},setting.key)}try{SettingUpdateField.displayName="SettingUpdateField",SettingUpdateField.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"InstanceSetting"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:SettingUpdateField.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(__react_docgen_typescript_loader_error){}var LemonTable=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTable/index.ts"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts");function AsyncMigrationDetails(_ref){let{asyncMigration:asyncMigration}=_ref;const{asyncMigrationErrorsLoading:asyncMigrationErrorsLoading,asyncMigrationErrors:asyncMigrationErrors}=Object(index_esm.useValues)(asyncMigrationsLogic),{loadAsyncMigrationErrors:loadAsyncMigrationErrors}=Object(index_esm.useActions)(asyncMigrationsLogic),columns=[{title:"Error",dataIndex:"description"},{title:Object(jsx_runtime.jsx)(LemonButton.a,{icon:asyncMigrationErrorsLoading[asyncMigration.id]?Object(jsx_runtime.jsx)(Spinner.a,{}):Object(jsx_runtime.jsx)(icons.Ac,{}),onClick:()=>loadAsyncMigrationErrors(asyncMigration.id),type:"secondary",size:"small",children:"Refresh errors"}),render:function Render(_,asyncMigrationError){return Object(jsx_runtime.jsx)("div",{children:Object(utils.N)(asyncMigrationError.created_at)})}}];return Object(jsx_runtime.jsx)(LemonTable.a,{columns:columns,dataSource:asyncMigrationErrors[asyncMigration.id],loading:asyncMigrationErrorsLoading[asyncMigration.id],embedded:!0})}try{AsyncMigrationDetails.displayName="AsyncMigrationDetails",AsyncMigrationDetails.__docgenInfo={description:"",displayName:"AsyncMigrationDetails",props:{asyncMigration:{defaultValue:null,description:"",name:"asyncMigration",required:!0,type:{name:"AsyncMigration"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"]={docgenInfo:AsyncMigrationDetails.__docgenInfo,name:"AsyncMigrationDetails",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"})}catch(__react_docgen_typescript_loader_error){}var More=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/More.tsx"),LemonTag=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTag/LemonTag.tsx"),kea_forms_lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.0.3_kea@3.1.5/node_modules/kea-forms/lib/index.js");const asyncMigrationParameterFormLogic=Object(index_esm.kea)([Object(index_esm.path)(["scenes","instance","AsyncMigrations","asyncMigrationParameterFormLogic"]),Object(index_esm.props)({}),Object(index_esm.key)((props=>props.migration.id)),Object(kea_forms_lib.forms)((_ref=>{let{props:props}=_ref;return{parameters:{defaults:defaultParameters(props),submit:async parameters=>{asyncMigrationsLogic.actions.updateMigrationStatus({...props.migration,parameters:parameters},props.endpoint,props.message)}}}}))]);function defaultParameters(props){const result={};return Object.keys(props.migration.parameter_definitions).forEach((key=>{props.migration.parameters[key]?result[key]=props.migration.parameters[key]:result[key]=props.migration.parameter_definitions[key][0]})),result}var LemonInput=__webpack_require__("./frontend/src/lib/lemon-ui/LemonInput/LemonInput.tsx"),AnimatedCollapsible=__webpack_require__("./frontend/src/lib/components/AnimatedCollapsible.tsx"),LemonModal=__webpack_require__("./frontend/src/lib/lemon-ui/LemonModal/index.ts");function AsyncMigrationParametersModal(props){const{closeAsyncMigrationsModal:closeAsyncMigrationsModal}=Object(index_esm.useActions)(asyncMigrationsLogic),[collapsed,setCollapsed]=Object(react.useState)(!0);return Object(jsx_runtime.jsx)(LemonModal.a,{title:"",onClose:closeAsyncMigrationsModal,isOpen:!0,simple:!0,children:Object(jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:asyncMigrationParameterFormLogic,props:props,formKey:"parameters",enableFormOnSubmit:!0,id:"async-migration-parameters-form",className:"LemonModal__layout",children:[Object(jsx_runtime.jsx)(LemonModal.a.Header,{children:Object(jsx_runtime.jsx)("h3",{children:"Advanced migration configuration"})}),Object(jsx_runtime.jsxs)(LemonModal.a.Content,{children:[Object(jsx_runtime.jsxs)("p",{children:["This async migration allows tuning parameters used in the async migration.",collapsed&&Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)("br",{}),Object(jsx_runtime.jsx)("a",{onClick:()=>{setCollapsed(!collapsed)},children:"Click here to show advanced configuration."})]})]}),Object(jsx_runtime.jsx)(AnimatedCollapsible.a,{collapsed:collapsed,children:Object.entries(props.migration.parameter_definitions).map((_ref=>{let[parameterName,[defaultValue,parameterDescription]]=_ref;return Object(jsx_runtime.jsx)(kea_forms_lib.Field,{name:parameterName,label:Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:parameterDescription}),children:Object(jsx_runtime.jsx)(LemonInput.a,{type:"number"==typeof defaultValue?"number":"text"})},parameterName)}))})]}),Object(jsx_runtime.jsxs)(LemonModal.a.Footer,{children:[Object(jsx_runtime.jsx)(LemonButton.a,{form:"async-migration-parameters-form",type:"secondary","data-attr":"async-migration-parameters-cancel",className:"mr-2",onClick:closeAsyncMigrationsModal,children:"Cancel"}),Object(jsx_runtime.jsx)(LemonButton.a,{form:"async-migration-parameters-form",htmlType:"submit",type:"primary","data-attr":"async-migration-parameters-submit",children:"Run migration"})]})]})})}try{AsyncMigrationParametersModal.displayName="AsyncMigrationParametersModal",AsyncMigrationParametersModal.__docgenInfo={description:"",displayName:"AsyncMigrationParametersModal",props:{migration:{defaultValue:null,description:"",name:"migration",required:!0,type:{name:"AsyncMigration"}},endpoint:{defaultValue:null,description:"",name:"endpoint",required:!0,type:{name:"string"}},message:{defaultValue:null,description:"",name:"message",required:!0,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationParametersModal.tsx#AsyncMigrationParametersModal"]={docgenInfo:AsyncMigrationParametersModal.__docgenInfo,name:"AsyncMigrationParametersModal",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationParametersModal.tsx#AsyncMigrationParametersModal"})}catch(__react_docgen_typescript_loader_error){}const{TabPane:TabPane}=tabs.a,scene={component:AsyncMigrations,logic:asyncMigrationsLogic};function AsyncMigrations(){const{user:user}=Object(index_esm.useValues)(userLogic.a),{asyncMigrationsLoading:asyncMigrationsLoading,activeTab:activeTab,asyncMigrationSettings:asyncMigrationSettings,isAnyMigrationRunning:isAnyMigrationRunning,activeAsyncMigrationModal:activeAsyncMigrationModal,actionableMigrations:actionableMigrations,futureMigrations:futureMigrations}=Object(index_esm.useValues)(asyncMigrationsLogic),{triggerMigration:triggerMigration,resumeMigration:resumeMigration,rollbackMigration:rollbackMigration,forceStopMigration:forceStopMigration,forceStopMigrationWithoutRollback:forceStopMigrationWithoutRollback,loadAsyncMigrations:loadAsyncMigrations,loadAsyncMigrationErrors:loadAsyncMigrationErrors,setActiveTab:setActiveTab}=Object(index_esm.useActions)(asyncMigrationsLogic);Object(react.useEffect)((()=>{if(isAnyMigrationRunning){const interval=setInterval((()=>loadAsyncMigrations()),3e3);return()=>clearInterval(interval)}}),[isAnyMigrationRunning]);const nameColumn={title:"Migration",render:function Render(_,asyncMigration){const link="https://github.com/PostHog/posthog/blob/master/posthog/async_migrations/migrations/"+asyncMigration.name+".py";return Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)("div",{className:"row-name",children:Object(jsx_runtime.jsx)("a",{href:link,children:asyncMigration.name})}),Object(jsx_runtime.jsx)("div",{className:"row-description",children:asyncMigration.description})]})}},progressColumn={title:"Progress",render:function Render(_,asyncMigration){const progress=asyncMigration.progress;return Object(jsx_runtime.jsx)("div",{children:Object(jsx_runtime.jsx)(es_progress.a,{percent:progress})})}},statusColumn={title:"Status",render:function Render(_,asyncMigration){const status=asyncMigration.status,type=status===AsyncMigrationStatus.Running?"success":status===AsyncMigrationStatus.Errored||status===AsyncMigrationStatus.FailedAtStartup?"danger":status===AsyncMigrationStatus.Starting||status===AsyncMigrationStatus.RolledBack?"warning":"default";return Object(jsx_runtime.jsx)(LemonTag.a,{type:type,className:"uppercase",children:migrationStatusNumberToMessage[status]})}},lastOpColumn={title:"Last operation index",render:function Render(_,asyncMigration){return Object(jsx_runtime.jsx)("div",{children:asyncMigration.current_operation_index})}},queryIdColumn={title:"Last query ID",render:function Render(_,asyncMigration){return Object(jsx_runtime.jsx)("div",{children:Object(jsx_runtime.jsx)("small",{children:asyncMigration.current_query_id})})}},startedAtColumn={title:"Started at",render:function Render(_,asyncMigration){const startedAt=asyncMigration.started_at;return Object(jsx_runtime.jsx)("div",{children:Object(utils.N)(startedAt)})}},finishedAtColumn={title:"Finished at",render:function Render(_,asyncMigration){const finishedAt=asyncMigration.finished_at;return Object(jsx_runtime.jsx)("div",{children:Object(utils.N)(finishedAt)})}},ActionsColumn={title:"",render:function Render(_,asyncMigration){const status=asyncMigration.status;return Object(jsx_runtime.jsx)("div",{children:status===AsyncMigrationStatus.NotStarted||status===AsyncMigrationStatus.FailedAtStartup?Object(jsx_runtime.jsx)(Tooltip.a,{title:"Start",children:Object(jsx_runtime.jsx)(es_button.a,{type:"link",icon:Object(jsx_runtime.jsx)(PlayCircleOutlined.a,{}),onClick:()=>triggerMigration(asyncMigration),children:"Run"})}):status===AsyncMigrationStatus.Starting||status===AsyncMigrationStatus.Running?Object(jsx_runtime.jsx)(More.a,{overlay:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)(LemonButton.a,{status:"stealth",onClick:()=>forceStopMigration(asyncMigration),fullWidth:!0,children:"Stop and rollback"}),Object(jsx_runtime.jsx)(LemonButton.a,{status:"stealth",onClick:()=>forceStopMigrationWithoutRollback(asyncMigration),fullWidth:!0,children:"Stop"})]})}):status===AsyncMigrationStatus.CompletedSuccessfully?Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{}):status===AsyncMigrationStatus.Errored?Object(jsx_runtime.jsx)(More.a,{overlay:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)(LemonButton.a,{status:"stealth",onClick:()=>resumeMigration(asyncMigration),fullWidth:!0,children:"Resume"}),Object(jsx_runtime.jsx)(LemonButton.a,{status:"stealth",onClick:()=>rollbackMigration(asyncMigration),fullWidth:!0,children:"Rollback"})]})}):status===AsyncMigrationStatus.RolledBack?Object(jsx_runtime.jsx)(Tooltip.a,{title:"Restart",children:Object(jsx_runtime.jsx)(LemonButton.a,{status:"stealth",icon:Object(jsx_runtime.jsx)(icons.Bc,{}),onClick:()=>triggerMigration(asyncMigration),fullWidth:!0})}):null})}},minVersionColumn={title:"Minimum PostHog version",render:function Render(_,asyncMigration){return Object(jsx_runtime.jsx)("div",{children:asyncMigration.posthog_min_version})}},maxVersionColumn={title:"Maximum PostHog version",render:function Render(_,asyncMigration){return Object(jsx_runtime.jsx)("div",{children:asyncMigration.posthog_max_version})}},columns={};columns[AsyncMigrationsTab.FutureMigrations]=[nameColumn,statusColumn,minVersionColumn,maxVersionColumn],columns[AsyncMigrationsTab.Management]=[nameColumn,progressColumn,statusColumn,lastOpColumn,queryIdColumn,startedAtColumn,finishedAtColumn,ActionsColumn];const migrations={};migrations[AsyncMigrationsTab.FutureMigrations]=futureMigrations,migrations[AsyncMigrationsTab.Management]=actionableMigrations;const rowExpansion={expandedRowRender:function renderExpand(asyncMigration){return asyncMigration&&Object(jsx_runtime.jsx)(AsyncMigrationDetails,{asyncMigration:asyncMigration})},rowExpandable:asyncMigration=>asyncMigration.error_count>0,onRowExpand:function getErrors(asyncMigration){loadAsyncMigrationErrors(asyncMigration.id)}};return Object(jsx_runtime.jsx)("div",{children:null!=user&&user.is_staff?Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)(PageHeader.a,{title:"Async Migrations",caption:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)("p",{children:"Manage async migrations in your instance."}),Object(jsx_runtime.jsxs)("p",{children:["Read about async migrations on our"," ",Object(jsx_runtime.jsx)("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations/overview",children:"dedicated docs page"}),"."]})]})}),Object(jsx_runtime.jsxs)(tabs.a,{activeKey:activeTab,onTabClick:t=>setActiveTab(t),children:[Object(jsx_runtime.jsx)(TabPane,{tab:`Management (${actionableMigrations.length})`},AsyncMigrationsTab.Management),futureMigrations.length>0&&Object(jsx_runtime.jsx)(TabPane,{tab:`Future Migrations (${futureMigrations.length})`},AsyncMigrationsTab.FutureMigrations),Object(jsx_runtime.jsx)(TabPane,{tab:"Settings"},AsyncMigrationsTab.Settings)]}),[AsyncMigrationsTab.Management,AsyncMigrationsTab.FutureMigrations].includes(activeTab)?Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)("div",{className:"mb-4 float-right",children:Object(jsx_runtime.jsx)(LemonButton.a,{icon:asyncMigrationsLoading?Object(jsx_runtime.jsx)(Spinner.a,{}):Object(jsx_runtime.jsx)(icons.Ac,{}),onClick:loadAsyncMigrations,type:"secondary",size:"small",children:"Refresh"})}),Object(jsx_runtime.jsx)(space.b,{}),Object(jsx_runtime.jsx)(LemonTable.a,{pagination:{pageSize:10},loading:asyncMigrationsLoading,columns:columns[activeTab],dataSource:migrations[activeTab],expandable:rowExpansion}),activeAsyncMigrationModal?Object(jsx_runtime.jsx)(AsyncMigrationParametersModal,{...activeAsyncMigrationModal}):null]}):activeTab===AsyncMigrationsTab.Settings?Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)("br",{}),asyncMigrationSettings.map((setting=>Object(jsx_runtime.jsx)("div",{children:Object(jsx_runtime.jsx)(SettingUpdateField,{setting:setting})},setting.key)))]}):null]}):Object(jsx_runtime.jsx)(PageHeader.a,{title:"Async Migrations",caption:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)("p",{children:"Only users with staff access can manage async migrations. Please contact your instance admin."}),Object(jsx_runtime.jsxs)("p",{children:["If you're an admin and don't have access, set ",Object(jsx_runtime.jsx)("code",{children:"is_staff=true"})," for your user on the PostgreSQL ",Object(jsx_runtime.jsx)("code",{children:"posthog_user"})," table."]})]})})})}},"./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return ConfigMode})),__webpack_require__.d(__webpack_exports__,"b",(function(){return systemStatusLogic}));var lib_api__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./frontend/src/lib/api.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@16.14.0/node_modules/kea/lib/index.esm.js"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./frontend/src/scenes/userLogic.ts"),scenes_PreflightCheck_preflightLogic__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),scenes_organizationLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./frontend/src/scenes/organizationLogic.tsx"),lib_constants__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/constants.tsx"),lib_utils__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/lib/utils.tsx"),lib_lemon_ui_lemonToast__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/lib/lemon-ui/lemonToast.tsx"),lib_utils_eventUsageLogic__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./frontend/src/lib/utils/eventUsageLogic.ts");let ConfigMode=function(ConfigMode){return ConfigMode.View="view",ConfigMode.Edit="edit",ConfigMode.Saving="saving",ConfigMode}({});const EDITABLE_INSTANCE_SETTINGS=["RECORDINGS_TTL_WEEKS","RECORDINGS_PERFORMANCE_EVENTS_TTL_WEEKS","EMAIL_ENABLED","EMAIL_HOST","EMAIL_PORT","EMAIL_HOST_USER","EMAIL_HOST_PASSWORD","EMAIL_USE_TLS","EMAIL_USE_SSL","EMAIL_DEFAULT_FROM","EMAIL_REPLY_TO","AGGREGATE_BY_DISTINCT_IDS_TEAMS","PERSON_ON_EVENTS_ENABLED","GROUPS_ON_EVENTS_ENABLED","STRICT_CACHING_TEAMS","SLACK_APP_CLIENT_ID","SLACK_APP_CLIENT_SECRET","SLACK_APP_SIGNING_SECRET","PARALLEL_DASHBOARD_ITEM_CACHE","RATE_LIMIT_ENABLED","RATE_LIMITING_ALLOW_LIST_TEAMS","SENTRY_AUTH_TOKEN","SENTRY_ORGANIZATION","HEATMAP_SAMPLE_N"],systemStatusLogic=Object(kea__WEBPACK_IMPORTED_MODULE_1__.kea)({path:["scenes","instance","SystemStatus","systemStatusLogic"],actions:{setTab:tab=>({tab:tab}),setOpenSections:sections=>({sections:sections}),setAnalyzeModalOpen:isOpen=>({isOpen:isOpen}),setAnalyzeQuery:query=>({query:query}),openAnalyzeModalWithQuery:query=>({query:query}),setInstanceConfigMode:mode=>({mode:mode}),updateInstanceConfigValue:(key,value)=>({key:key,value:value}),clearInstanceConfigEditing:!0,saveInstanceConfig:!0,setUpdatedInstanceConfigCount:count=>({count:count}),increaseUpdatedInstanceConfigCount:!0},loaders:_ref=>{let{values:values}=_ref;return{systemStatus:[null,{loadSystemStatus:async()=>{var _preflightLogic$value,_userLogic$values$use,_await$api$get$result;return Object(lib_utils__WEBPACK_IMPORTED_MODULE_6__.nb)()&&(null===(_preflightLogic$value=scenes_PreflightCheck_preflightLogic__WEBPACK_IMPORTED_MODULE_3__.a.values.preflight)||void 0===_preflightLogic$value||!_preflightLogic$value.cloud||null!==(_userLogic$values$use=scenes_userLogic__WEBPACK_IMPORTED_MODULE_2__.a.values.user)&&void 0!==_userLogic$values$use&&_userLogic$values$use.is_staff)&&null!==(_await$api$get$result=(await lib_api__WEBPACK_IMPORTED_MODULE_0__.b.get("api/instance_status")).results)&&void 0!==_await$api$get$result?_await$api$get$result:null}}],instanceSettings:[[],{loadInstanceSettings:async()=>{var _await$api$get$result2;return null!==(_await$api$get$result2=(await lib_api__WEBPACK_IMPORTED_MODULE_0__.b.get("api/instance_settings")).results)&&void 0!==_await$api$get$result2?_await$api$get$result2:[]}}],queries:[null,{loadQueries:async()=>(await lib_api__WEBPACK_IMPORTED_MODULE_0__.b.get("api/instance_status/queries")).results}],analyzeQueryResult:[null,{setAnalyzeModalOpen:()=>null,runAnalyzeQuery:async()=>(await lib_api__WEBPACK_IMPORTED_MODULE_0__.b.create("api/instance_status/analyze_ch_query",{query:values.analyzeQuery})).results}]}},reducers:{tab:["overview",{setTab:(_,_ref2)=>{let{tab:tab}=_ref2;return tab}}],error:[null,{loadSystemStatusFailure:(_,_ref3)=>{let{error:error}=_ref3;return error}}],openSections:[["0"],{persist:!0},{setOpenSections:(_,_ref4)=>{let{sections:sections}=_ref4;return sections}}],analyzeModalOpen:[!1,{setAnalyzeModalOpen:(_,_ref5)=>{let{isOpen:isOpen}=_ref5;return isOpen},openAnalyzeModalWithQuery:()=>!0}],analyzeQuery:["",{setAnalyzeQuery:(_,_ref6)=>{let{query:query}=_ref6;return query},openAnalyzeModalWithQuery:(_,_ref7)=>{let{query:query}=_ref7;return query}}],instanceConfigMode:[ConfigMode.View,{setInstanceConfigMode:(_,_ref8)=>{let{mode:mode}=_ref8;return mode}}],instanceConfigEditingState:[{},{updateInstanceConfigValue:(s,_ref9)=>{let{key:key,value:value}=_ref9;if(void 0!==value)return{...s,[key]:value};const newState={...s};return delete newState[key],newState},clearInstanceConfigEditing:()=>({})}],updatedInstanceConfigCount:[null,{setUpdatedInstanceConfigCount:(_,_ref10)=>{let{count:count}=_ref10;return count},loadInstanceSettings:()=>null,increaseUpdatedInstanceConfigCount:state=>(null!=state?state:0)+1}]},selectors:()=>({overview:[s=>[s.systemStatus],status=>status?status.overview:[]],showAnalyzeQueryButton:[()=>[scenes_PreflightCheck_preflightLogic__WEBPACK_IMPORTED_MODULE_3__.a.selectors.preflight,scenes_organizationLogic__WEBPACK_IMPORTED_MODULE_4__.a.selectors.currentOrganization,scenes_userLogic__WEBPACK_IMPORTED_MODULE_2__.a.selectors.user],(preflight,org,user)=>null!=preflight&&preflight.cloud?!(null==user||!user.is_staff):!(null==org||!org.membership_level)&&org.membership_level>=lib_constants__WEBPACK_IMPORTED_MODULE_5__.q.Admin],editableInstanceSettings:[s=>[s.instanceSettings],instanceSettings=>instanceSettings.filter((item=>item.editable&&EDITABLE_INSTANCE_SETTINGS.includes(item.key)))]}),listeners:_ref11=>{let{actions:actions,values:values}=_ref11;return{setTab:_ref12=>{let{tab:tab}=_ref12;"metrics"===tab&&actions.loadQueries(),actions.setInstanceConfigMode(ConfigMode.View)},updateInstanceConfigValue:_ref13=>{var _values$editableInsta;let{key:key,value:value}=_ref13;const previousValue=null===(_values$editableInsta=values.editableInstanceSettings.find((item=>item.key===key)))||void 0===_values$editableInsta?void 0:_values$editableInsta.value;value&&previousValue==value&&actions.updateInstanceConfigValue(key,void 0)},saveInstanceConfig:async(_,breakpoint)=>{actions.setUpdatedInstanceConfigCount(0),Object.entries(values.instanceConfigEditingState).map((async _ref14=>{let[key,value]=_ref14;try{await lib_api__WEBPACK_IMPORTED_MODULE_0__.b.update(`api/instance_settings/${key}`,{value:value}),lib_utils_eventUsageLogic__WEBPACK_IMPORTED_MODULE_8__.e.actions.reportInstanceSettingChange(key,value),actions.increaseUpdatedInstanceConfigCount()}catch{lib_lemon_ui_lemonToast__WEBPACK_IMPORTED_MODULE_7__.d.error("There was an error updating instance settings – please try again"),await breakpoint(1e3),actions.loadInstanceSettings()}})),await breakpoint(1e3),values.updatedInstanceConfigCount===Object.keys(values.instanceConfigEditingState).length&&(actions.loadInstanceSettings(),actions.clearInstanceConfigEditing(),actions.setInstanceConfigMode(ConfigMode.View),lib_lemon_ui_lemonToast__WEBPACK_IMPORTED_MODULE_7__.d.success("Instance settings updated"))}}},events:_ref15=>{let{actions:actions}=_ref15;return{afterMount:()=>{actions.loadSystemStatus()}}},actionToUrl:_ref16=>{let{values:values}=_ref16;return{setTab:()=>"/instance/"+("overview"===values.tab?"status":values.tab)}},urlToAction:_ref17=>{let{actions:actions,values:values}=_ref17;return{"/instance(/:tab)":_ref18=>{let{tab:tab}=_ref18;const currentTab=tab&&["metrics","settings","staff_users","kafka_inspector"].includes(tab)?tab:"overview";currentTab!==values.tab&&actions.setTab(currentTab)}}}})}}]);