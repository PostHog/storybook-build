"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[80730],{"./frontend/src/scenes/pipeline/PipelineBatchExportConfiguration.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{B:()=>PipelineBatchExportConfiguration});var src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),NotFound=__webpack_require__("./frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),constants=__webpack_require__("./frontend/src/lib/constants.tsx"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonField=__webpack_require__("./frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonInput=__webpack_require__("./frontend/src/lib/lemon-ui/LemonInput/index.ts"),Spinner=__webpack_require__("./frontend/src/lib/lemon-ui/Spinner/index.ts"),featureFlagLogic=__webpack_require__("./frontend/src/lib/logic/featureFlagLogic.ts"),DatabaseTable=__webpack_require__("./frontend/src/scenes/data-management/database/DatabaseTable.tsx"),types=__webpack_require__("./frontend/src/types.ts"),posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.7.3_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function BatchExportGeneralEditFields(_ref){let{isNew,isPipeline=!1,batchExportConfigForm}=_ref,{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.h),highFrequencyBatchExports=featureFlags[constants.y8.HIGH_FREQUENCY_BATCH_EXPORTS];return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4 max-w-200",children:[!isPipeline&&(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"Name your workflow for future reference"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-start flex-wrap",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"interval",label:"Batch interval",className:"flex-1",info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The intervals of data exports. For example, if you select hourly, every hour a run will be created to export that hours data."}),children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"hour",label:"Hourly"},{value:"day",label:"Daily"},{value:"every 5 minutes",label:"Every 5 minutes",hidden:!highFrequencyBatchExports}]})}),(!isPipeline||batchExportConfigForm.end_at)&&(0,jsx_runtime.jsx)(LemonField.D,{name:"end_at",label:"End date",className:"flex-1",info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The date up to which data is to be exported. Leaving it unset implies that data exports will continue forever until this export is paused or deleted."}),children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.he,{value:value,onChange:onChange,placeholder:"Select end date (optional)",clearable:!0})}})]}),isPipeline?(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:"The export will be created in a paused state, once configured your exporter, you can trigger a manual export for historic data or start the continous export."}):(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:"This batch exporter will schedule regular batch exports at your indicated interval until the end date. Once you have configured your exporter, you can trigger a manual export for historic data."}),isNew&&!isPipeline?(0,jsx_runtime.jsx)(LemonField.D,{name:"paused",children:(0,jsx_runtime.jsx)(src.Hw,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Create in paused state",(0,jsx_runtime.jsx)(src.u,{title:"If selected, the Batch Exporter will be created but will be 'paused' allowing you to resumed it at a later date.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:" text-lg text-muted-alt"})})]})})}):null]})})}function BatchExportsEditFields(_ref3){let{isNew,batchExportConfigForm}=_ref3;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("div",{className:"space-y-4 max-w-200",children:"S3"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"bucket_name",label:"Bucket",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. my-bucket"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"region",label:"Region",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"us-east-1",label:"US East (N. Virginia)"},{value:"us-east-2",label:"US East (Ohio)"},{value:"us-west-1",label:"US West (N. California)"},{value:"us-west-2",label:"US West (Oregon)"},{value:"af-south-1",label:"Africa (Cape Town)"},{value:"ap-east-1",label:"Asia Pacific (Hong Kong)"},{value:"ap-south-1",label:"Asia Pacific (Mumbai)"},{value:"ap-northeast-3",label:"Asia Pacific (Osaka-Local)"},{value:"ap-northeast-2",label:"Asia Pacific (Seoul)"},{value:"ap-southeast-1",label:"Asia Pacific (Singapore)"},{value:"ap-southeast-2",label:"Asia Pacific (Sydney)"},{value:"ap-northeast-1",label:"Asia Pacific (Tokyo)"},{value:"ca-central-1",label:"Canada (Central)"},{value:"cn-north-1",label:"China (Beijing)"},{value:"cn-northwest-1",label:"China (Ningxia)"},{value:"eu-central-1",label:"Europe (Frankfurt)"},{value:"eu-west-1",label:"Europe (Ireland)"},{value:"eu-west-2",label:"Europe (London)"},{value:"eu-south-1",label:"Europe (Milan)"},{value:"eu-west-3",label:"Europe (Paris)"},{value:"eu-north-1",label:"Europe (Stockholm)"},{value:"me-south-1",label:"Middle East (Bahrain)"},{value:"sa-east-1",label:"South America (S\xe3o Paulo)"}]})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"prefix",label:"Key prefix",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. posthog-events/"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"compression",label:"Compression",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"gzip",label:"gzip"},{value:"brotli",label:"brotli"},{value:null,label:"No compression"}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"encryption",label:"Encryption",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"AES256",label:"AES256"},{value:"aws:kms",label:"aws:kms"},{value:null,label:"No encryption"}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"file_format",label:"Format",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"JSONLines",label:"JSON lines"},{value:"Parquet",label:"Apache Parquet"}]})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"aws_access_key_id",label:"AWS Access Key ID",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. AKIAIOSFODNN7EXAMPLE":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"aws_secret_access_key",label:"AWS Secret Access Key",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. secret-key":"Leave unchanged",type:"password"})}),"aws:kms"==batchExportConfigForm.encryption&&(0,jsx_runtime.jsx)(LemonField.D,{name:"kms_key_id",label:"AWS KMS Key ID",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. 1234abcd-12ab-34cd-56ef-1234567890ab":"leave unchanged"})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"endpoint_url",label:"Endpoint URL",showOptional:!0,info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Only required if exporting to an S3-compatible blob storage (like MinIO)"}),children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. https://your-minio-host:9000":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):"Snowflake"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-user":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-password":"Leave unchanged",type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"account",label:"Account",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-account"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"warehouse",label:"Warehouse",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-warehouse"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-schema"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"role",label:"Role",showOptional:!0,children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-role"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):"Postgres"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-user":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-password":"Leave unchanged",type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"host",label:"Host",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-host"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"port",label:"Port",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"5432",type:"number",min:"0",max:"65535"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"public"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"has_self_signed_cert",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsx)(src.Hw,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Does your Postgres instance have a self-signed SSL certificate?",(0,jsx_runtime.jsx)(src.u,{title:"In most cases, Heroku and RDS users should check this.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:" text-lg text-muted-alt"})})]}),checked:!!value,onChange:onChange})}}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):"Redshift"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-user":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-password":"Leave unchanged",type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"host",label:"Host",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-host"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"port",label:"Port",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"5439",type:"number",min:"0",max:"65535"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"public"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"properties_data_type",label:"Properties data type",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"varchar",label:"VARCHAR(65535)"},{value:"super",label:"SUPER"}],value:"varchar"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):"BigQuery"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"json_config_file",label:"Google Cloud JSON key file",children:(0,jsx_runtime.jsx)(src.mH,{accept:".json",multiple:!1})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_id",label:"Table ID",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"dataset_id",label:"Dataset ID",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"dataset"})}),isNew?(0,jsx_runtime.jsx)(LemonField.D,{name:"use_json_type",label:"Structured fields data type",children:(0,jsx_runtime.jsx)(src.Hw,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Export 'properties', 'set', and 'set_once' fields as BigQuery JSON type",(0,jsx_runtime.jsx)(src.u,{title:"If left unchecked, these fields will be sent as STRING type. This setting cannot be changed after batch export is created.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:" text-lg text-muted-alt"})})]})})}):null,(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):"HTTP"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"url",label:"URL",children:(0,jsx_runtime.jsx)(src.DF,{})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"token",label:"Project API Key",children:(0,jsx_runtime.jsx)(src.DF,{})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):null})})}var pipelineBatchExportConfigurationLogic=__webpack_require__("./frontend/src/scenes/pipeline/pipelineBatchExportConfigurationLogic.tsx"),utils=__webpack_require__("./frontend/src/scenes/pipeline/utils.tsx");function PipelineBatchExportConfiguration(_ref){let{service,id}=_ref,logicProps={service:service||null,id:id||null},logic=(0,pipelineBatchExportConfigurationLogic.t)(logicProps),{isNew,configuration,tables,savedConfiguration,isConfigurationSubmitting,batchExportConfigLoading,configurationChanged,batchExportConfig,selectedModel}=(0,index_esm.useValues)(logic),{resetConfiguration,submitConfiguration,setSelectedModel}=(0,index_esm.useActions)(logic),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.h);if(service&&!types.e2.includes(service))return(0,jsx_runtime.jsx)(NotFound.T,{object:`batch export service ${service}`});if(!batchExportConfig&&batchExportConfigLoading)return(0,jsx_runtime.jsx)(Spinner.t,{});let buttons=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",htmlType:"reset",onClick:()=>resetConfiguration(savedConfiguration||{}),disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress…":void 0:"No changes",children:isNew?"Reset":"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,children:isNew?"Create":"Save"})]});return(0,jsx_runtime.jsx)("div",{className:"space-y-3",children:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:buttons}),(0,jsx_runtime.jsxs)(lib.Form,{logic:pipelineBatchExportConfigurationLogic.t,props:logicProps,formKey:"configuration",className:"space-y-3",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-start gap-2 flex-wrap",children:[(0,jsx_runtime.jsxs)("div",{className:"border bg-bg-light p-3 rounded space-y-2 flex-1 min-w-100",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 min-h-16 items-center",children:[configuration.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(utils.oe,{size:"medium",type:configuration.destination}),(0,jsx_runtime.jsx)("div",{className:"flex-1 font-semibold text-sm",children:configuration.destination})]}):(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"paused",info:"Start in a paused state or continuously exporting from now",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.f4,{label:"Paused",onChange:()=>onChange(!value),checked:value,bordered:!0})}})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",info:"Customising the name can be useful if multiple instances of the same type are used.",children:(0,jsx_runtime.jsx)(LemonInput.D,{type:"text"})}),featureFlags[constants.y8.PERSON_BATCH_EXPORTS]&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"model",label:"Model",info:"A model defines the data that will be exported.",children:(0,jsx_runtime.jsx)(src.Yv,{options:tables.map(table=>({value:table.name,label:table.id})),value:selectedModel,onSelect:newValue=>{setSelectedModel(newValue)}})}),(0,jsx_runtime.jsx)(DatabaseTable.B,{table:selectedModel||"events",tables:tables,inEditSchemaMode:!1})]})]}),(0,jsx_runtime.jsx)("div",{className:"border bg-bg-light p-3 rounded flex-2 min-w-100",children:(0,jsx_runtime.jsx)(BatchExportConfigurationFields,{isNew:isNew,formValues:configuration})})]}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-end",children:buttons})]})]})})}function BatchExportConfigurationFields(_ref3){let{isNew,formValues}=_ref3;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(BatchExportGeneralEditFields,{isNew:isNew,isPipeline:!0,batchExportConfigForm:formValues}),(0,jsx_runtime.jsx)(BatchExportsEditFields,{isNew:isNew,batchExportConfigForm:formValues})]})}},"./frontend/src/scenes/pipeline/PipelineNode.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{PIPELINE_TAB_TO_NODE_STAGE:()=>PIPELINE_TAB_TO_NODE_STAGE,PipelineNode:()=>PipelineNode,scene:()=>scene});var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),ActivityLog=__webpack_require__("./frontend/src/lib/components/ActivityLog/ActivityLog.tsx"),NotFound=__webpack_require__("./frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),LemonTabs=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTabs/LemonTabs.tsx"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),src=__webpack_require__("./frontend/@posthog/apps-common/src/index.ts"),lemon_ui_src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),More=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/More.tsx"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),data_warehouse_utils=__webpack_require__("./frontend/src/scenes/data-warehouse/utils.ts"),urls=__webpack_require__("./frontend/src/scenes/urls.ts"),SyncMethodForm=__webpack_require__("./frontend/src/scenes/data-warehouse/external/forms/SyncMethodForm.tsx"),dataWarehouseSettingsLogic=__webpack_require__("./frontend/src/scenes/data-warehouse/settings/dataWarehouseSettingsLogic.ts"),lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts");let dataWarehouseSourcesTableSyncMethodModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-warehouse","settings","DataWarehouseSourcesTableSyncMethodModalLogic"]),(0,index_esm.props)({schema:{}}),(0,index_esm.key)(props=>props.schema.id),(0,index_esm.connect)(()=>({actions:[dataWarehouseSettingsLogic.T,["updateSchema","updateSchemaSuccess","updateSchemaFailure","loadSources"]]})),(0,index_esm.actions)({openSyncMethodModal:schema=>({schema}),closeSyncMethodModal:!0}),(0,lib.loaders)({schemaIncrementalFields:[null,{loadSchemaIncrementalFields:async schemaId=>await api.ZP.externalDataSchemas.incremental_fields(schemaId),resetSchemaIncrementalFields:()=>null}]}),(0,index_esm.reducers)({syncMethodModalIsOpen:[!1,{openSyncMethodModal:()=>!0,closeSyncMethodModal:()=>!1}],currentSyncMethodModalSchema:[null,{openSyncMethodModal:(_,_ref)=>{let{schema}=_ref;return schema},closeSyncMethodModal:()=>null}],saveButtonIsLoading:[!1,{updateSchema:()=>!0,updateSchemaFailure:()=>!1,updateSchemaSuccess:()=>!1}]}),(0,index_esm.listeners)(_ref2=>{let{actions}=_ref2;return{updateSchemaSuccess:()=>{actions.loadSources(null),actions.resetSchemaIncrementalFields(),actions.closeSyncMethodModal()}}})]);var dist_module=__webpack_require__("./node_modules/.pnpm/posthog-js@1.154.3/node_modules/posthog-js/dist/module.js");let dataWarehouseSourceSettingsLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-warehouse","settings","source","dataWarehouseSourceSettingsLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.actions)({setSourceId:id=>({id}),reloadSchema:schema=>({schema}),resyncSchema:schema=>({schema}),setCanLoadMoreJobs:canLoadMoreJobs=>({canLoadMoreJobs})}),(0,lib.loaders)(_ref2=>{let{actions,values}=_ref2;return{source:[null,{loadSource:async()=>await api.ZP.externalDataSources.get(values.sourceId),updateSchema:async schema=>{let clonedSource=JSON.parse(JSON.stringify(values.source)),schemaIndex=clonedSource.schemas.findIndex(n=>n.id===schema.id);clonedSource.schemas[schemaIndex]=schema,actions.loadSourceSuccess(clonedSource);let updatedSchema=await api.ZP.externalDataSchemas.update(schema.id,schema),source=values.source;return void 0!==schemaIndex&&(source.schemas[schemaIndex]=updatedSchema),source}}],jobs:[[],{loadJobs:async()=>{if(0===values.jobs.length)return await api.ZP.externalDataSources.jobs(values.sourceId,null,null);let newJobs=await api.ZP.externalDataSources.jobs(values.sourceId,null,values.jobs[0].created_at);return[...newJobs,...values.jobs]},loadMoreJobs:async()=>{let hasJobs=values.jobs.length>=0;if(hasJobs){let lastJobCreatedAt=values.jobs[values.jobs.length-1].created_at,oldJobs=await api.ZP.externalDataSources.jobs(values.sourceId,lastJobCreatedAt,null);return 0===oldJobs.length?(actions.setCanLoadMoreJobs(!1),values.jobs):[...values.jobs,...oldJobs]}return values.jobs}}]}}),(0,index_esm.reducers)(_ref3=>{let{props}=_ref3;return{sourceId:[props.id,{setSourceId:(_,_ref4)=>{let{id}=_ref4;return id}}],canLoadMoreJobs:[!0,{setCanLoadMoreJobs:(_,_ref5)=>{let{canLoadMoreJobs}=_ref5;return canLoadMoreJobs},setSourceId:()=>!0}]}}),(0,index_esm.listeners)(_ref6=>{let{values,actions,cache}=_ref6;return{loadSourceSuccess:()=>{clearTimeout(cache.sourceRefreshTimeout),cache.sourceRefreshTimeout=setTimeout(()=>{actions.loadSource()},5e3)},loadSourceFailure:()=>{clearTimeout(cache.sourceRefreshTimeout),cache.sourceRefreshTimeout=setTimeout(()=>{actions.loadSource()},5e3)},loadJobsSuccess:()=>{clearTimeout(cache.jobsRefreshTimeout),cache.jobsRefreshTimeout=setTimeout(()=>{actions.loadJobs()},5e3)},loadJobsFailure:()=>{clearTimeout(cache.jobsRefreshTimeout),cache.jobsRefreshTimeout=setTimeout(()=>{actions.loadJobs()},5e3)},reloadSchema:async _ref7=>{let{schema}=_ref7,clonedSource=JSON.parse(JSON.stringify(values.source)),schemaIndex=clonedSource.schemas.findIndex(n=>n.id===schema.id);clonedSource.status="Running",clonedSource.schemas[schemaIndex].status="Running",actions.loadSourceSuccess(clonedSource);try{await api.ZP.externalDataSchemas.reload(schema.id),dist_module.ZP.capture("schema reloaded",{sourceType:clonedSource.source_type})}catch(e){e.message?lemon_ui_src.UJ.error(e.message):lemon_ui_src.UJ.error("Cant reload schema at this time")}},resyncSchema:async _ref8=>{let{schema}=_ref8,clonedSource=JSON.parse(JSON.stringify(values.source)),schemaIndex=clonedSource.schemas.findIndex(n=>n.id===schema.id);clonedSource.status="Running",clonedSource.schemas[schemaIndex].status="Running",actions.loadSourceSuccess(clonedSource);try{await api.ZP.externalDataSchemas.resync(schema.id),dist_module.ZP.capture("schema resynced",{sourceType:clonedSource.source_type})}catch(e){e.message?lemon_ui_src.UJ.error(e.message):lemon_ui_src.UJ.error("Cant refresh schema at this time")}}}}),(0,index_esm.afterMount)(_ref9=>{let{actions}=_ref9;actions.loadSource(),actions.loadJobs()})]);var jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let Schemas=_ref=>{var _source$schemas;let{id}=_ref,{source,sourceLoading}=(0,index_esm.useValues)(dataWarehouseSourceSettingsLogic({id}));return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:dataWarehouseSourceSettingsLogic,props:{id},children:(0,jsx_runtime.jsx)(SchemaTable,{schemas:null!==(_source$schemas=source?.schemas)&&void 0!==_source$schemas?_source$schemas:[],isLoading:sourceLoading})})},StatusTagSetting={Running:"primary",Completed:"success",Error:"danger",Failed:"danger"},SchemaTable=_ref2=>{let{schemas,isLoading}=_ref2,{updateSchema,reloadSchema,resyncSchema}=(0,index_esm.useActions)(dataWarehouseSourceSettingsLogic),{schemaReloadingById}=(0,index_esm.useValues)(dataWarehouseSettingsLogic.T);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(lemon_ui_src.g3,{dataSource:schemas,loading:isLoading,disableTableWhileLoading:!1,columns:[{title:"Schema Name",key:"name",render:function RenderName(_,schema){return(0,jsx_runtime.jsx)("span",{children:schema.name})}},{title:"Sync Frequency",key:"frequency",render:function RenderFrequency(_,schema){return(0,jsx_runtime.jsx)(lemon_ui_src.Yv,{className:"my-1",value:schema.sync_frequency||"6hour",onChange:value=>updateSchema({...schema,sync_frequency:value}),options:[{value:"5min",label:"5 mins"},{value:"30min",label:"30 mins"},{value:"1hour",label:"1 hour"},{value:"6hour",label:"6 hours"},{value:"12hour",label:"12 hours"},{value:"24hour",label:"Daily"},{value:"7day",label:"Weekly"},{value:"30day",label:"Monthly"}]})}},{title:"Sync method",key:"incremental",render:function RenderIncremental(_,schema){let{openSyncMethodModal}=(0,index_esm.useActions)(dataWarehouseSourcesTableSyncMethodModalLogic({schema}));return schema.sync_type?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{className:"my-1",size:"small",type:"secondary",onClick:()=>openSyncMethodModal(schema),children:"incremental"==schema.sync_type?"Incremental":"Full refresh"}),(0,jsx_runtime.jsx)(SyncMethodModal,{schema:schema})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{className:"my-1",type:"primary",onClick:()=>openSyncMethodModal(schema),children:"Set up"}),(0,jsx_runtime.jsx)(SyncMethodModal,{schema:schema})]})}},{title:"Enabled",key:"should_sync",render:function RenderShouldSync(_,schema){return(0,jsx_runtime.jsx)(lemon_ui_src.f4,{disabledReason:null===schema.sync_type?"You must set up the sync method first":void 0,checked:schema.should_sync,onChange:active=>{updateSchema({...schema,should_sync:active})}})}},{title:"Synced Table",key:"table",render:function RenderTable(_,schema){if(schema.table){let query=(0,data_warehouse_utils.w)(schema.table.name,schema.table.columns);return(0,jsx_runtime.jsx)(lemon_ui_src.rU,{to:urls.j.dataWarehouse(JSON.stringify(query)),children:(0,jsx_runtime.jsx)("code",{children:schema.table.name})})}return"Completed"===schema.status?(0,jsx_runtime.jsx)("div",{children:"No rows to query"}):(0,jsx_runtime.jsx)("div",{children:"Not yet synced"})}},{title:"Last Synced At",key:"last_synced_at",render:function Render(_,schema){return schema.last_synced_at?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.w4,{time:schema.last_synced_at,formatDate:"MMM\xa0DD,\xa0YYYY",formatTime:"HH:mm"})}):null}},{title:"Rows Synced",key:"rows_synced",render:function Render(_,schema){return schema.table?schema.table.row_count.toLocaleString():"Completed"===schema.status?0:""}},{title:"Status",key:"status",render:function RenderStatus(_,schema){return schema.status?(0,jsx_runtime.jsx)(lemon_ui_src.oe,{type:StatusTagSetting[schema.status]||"default",children:schema.status}):null}},{key:"actions",width:0,render:function RenderActions(_,schema){return schemaReloadingById[schema.id]?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(lemon_ui_src.$j,{})}):(0,jsx_runtime.jsx)("div",{className:"flex flex-row justify-end",children:(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{type:"tertiary",onClick:()=>{reloadSchema(schema)},children:"Reload"},`reload-data-warehouse-schema-${schema.id}`),schema.incremental&&(0,jsx_runtime.jsx)(lemon_ui_src.u,{title:"Completely resync incrementally loaded data. Only recommended if there is an issue with data quality in previously imported data",children:(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{type:"tertiary",onClick:()=>{resyncSchema(schema)},status:"danger",children:"Resync"},`resync-data-warehouse-schema-${schema.id}`)})]})})})})}}]})})},SyncMethodModal=_ref3=>{var _currentSyncMethodMod,_currentSyncMethodMod2;let{schema}=_ref3,{syncMethodModalIsOpen,currentSyncMethodModalSchema,schemaIncrementalFields,schemaIncrementalFieldsLoading,saveButtonIsLoading}=(0,index_esm.useValues)(dataWarehouseSourcesTableSyncMethodModalLogic({schema})),{closeSyncMethodModal,loadSchemaIncrementalFields,resetSchemaIncrementalFields,updateSchema}=(0,index_esm.useActions)(dataWarehouseSourcesTableSyncMethodModalLogic({schema}));(0,react.useEffect)(()=>{currentSyncMethodModalSchema?.id&&(resetSchemaIncrementalFields(),loadSchemaIncrementalFields(currentSyncMethodModalSchema.id))},[currentSyncMethodModalSchema?.id]);let schemaLoading=schemaIncrementalFieldsLoading||!schemaIncrementalFields;return currentSyncMethodModalSchema?(0,jsx_runtime.jsxs)(lemon_ui_src.fQ,{title:`Sync method for ${currentSyncMethodModalSchema.name}`,isOpen:syncMethodModalIsOpen,onClose:closeSyncMethodModal,footer:schemaLoading&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(lemon_ui_src.yW.Button,{}),(0,jsx_runtime.jsx)(lemon_ui_src.yW.Button,{})]}),children:[schemaLoading&&(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsx)(lemon_ui_src.yW,{className:"w-1/2 h-4"}),(0,jsx_runtime.jsx)(lemon_ui_src.yW.Row,{repeat:3})]}),!schemaLoading&&schemaIncrementalFields&&(0,jsx_runtime.jsx)(SyncMethodForm.m,{showRefreshMessageOnChange:null!==currentSyncMethodModalSchema.sync_type,saveButtonIsLoading:saveButtonIsLoading,schema:{table:currentSyncMethodModalSchema.name,should_sync:currentSyncMethodModalSchema.should_sync,sync_type:currentSyncMethodModalSchema.sync_type,incremental_field:null!==(_currentSyncMethodMod=currentSyncMethodModalSchema.incremental_field)&&void 0!==_currentSyncMethodMod?_currentSyncMethodMod:null,incremental_field_type:null!==(_currentSyncMethodMod2=currentSyncMethodModalSchema.incremental_field_type)&&void 0!==_currentSyncMethodMod2?_currentSyncMethodMod2:null,incremental_available:!!schemaIncrementalFields.length,incremental_fields:schemaIncrementalFields},onClose:()=>{resetSchemaIncrementalFields(),closeSyncMethodModal()},onSave:(syncType,incrementalField,incrementalFieldType)=>{"full_refresh"===syncType?updateSchema({...currentSyncMethodModalSchema,should_sync:!0,sync_type:syncType,incremental_field:null,incremental_field_type:null}):updateSchema({...currentSyncMethodModalSchema,should_sync:!0,sync_type:syncType,incremental_field:incrementalField,incremental_field_type:incrementalFieldType})}})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})};var constants=__webpack_require__("./frontend/src/lib/constants.tsx"),dayjs=__webpack_require__("./frontend/src/lib/dayjs.ts"),pipeline_utils=__webpack_require__("./frontend/src/scenes/pipeline/utils.tsx");let schemaLogLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-warehouse","settings","source","schemaLogLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{job}=_ref;return job.id}),(0,index_esm.actions)({clearBackgroundLogs:!0,setLogLevelFilters:levelFilters=>({levelFilters}),setSearchTerm:searchTerm=>({searchTerm}),setSchema:schemaId=>({schemaId}),markLogsEnd:!0}),(0,lib.loaders)(_ref2=>{let{values,actions,cache,props}=_ref2;return{logs:{__default:[],loadSchemaLogs:async()=>{let response=await api.ZP.externalDataSchemas.logs(props.job.schema.id,{level:values.levelFilters.join(","),search:values.searchTerm,instance_id:props.job.workflow_run_id});return cache.pollingInterval||(cache.pollingInterval=setInterval(actions.loadSchemaLogsBackgroundPoll,2e3)),response.results},loadSchemaLogsMore:async()=>{if(!values.selectedSchemaId)return[];let response=await api.ZP.externalDataSchemas.logs(values.selectedSchemaId,{level:values.levelFilters.join(","),search:values.searchTerm,instance_id:props.job.workflow_run_id,before:values.leadingEntry?.timestamp});return response.results.length<constants.F2&&actions.markLogsEnd(),[...values.logs,...response.results]},revealBackground:()=>{let newArray=[...values.logsBackground,...values.logs];return actions.clearBackgroundLogs(),newArray}},logsBackground:{__default:[],loadSchemaLogsBackgroundPoll:async()=>{let response=await api.ZP.externalDataSchemas.logs(props.job.schema.id,{level:values.levelFilters.join(","),search:values.searchTerm,instance_id:props.job.workflow_run_id,after:values.leadingEntry?.timestamp});return[...response.results,...values.logsBackground]}}}}),(0,index_esm.reducers)({levelFilters:[["DEBUG","LOG","INFO","WARNING","ERROR"],{setLogLevelFilters:(_,_ref3)=>{let{levelFilters}=_ref3;return levelFilters}}],searchTerm:["",{setSearchTerm:(_,_ref4)=>{let{searchTerm}=_ref4;return searchTerm}}],selectedSchemaId:[null,{setSchema:(_,_ref5)=>{let{schemaId}=_ref5;return schemaId}}],isThereMoreToLoad:[!0,{loadSchemaLogsSuccess:(_,_ref6)=>{let{logs}=_ref6;return logs.length>=constants.F2},markLogsEnd:()=>!1}]}),(0,index_esm.selectors)({leadingEntry:[s=>[s.logs,s.logsBackground],(logs,logsBackground)=>logsBackground.length?logsBackground[0]:logs.length?logs[0]:null]}),(0,index_esm.listeners)(_ref7=>{let{actions}=_ref7;return{setLogLevelFilters:()=>{actions.loadSchemaLogs()},setSearchTerm:async(_ref8,breakpoint)=>{let{searchTerm}=_ref8;searchTerm&&await breakpoint(1e3),actions.loadSchemaLogs()},setSchema:()=>{actions.loadSchemaLogs()}}}),(0,index_esm.events)(_ref9=>{let{actions,cache}=_ref9;return{afterMount:()=>{actions.loadSchemaLogs()},beforeUnmount:()=>{clearInterval(cache.pollingInterval)}}})]),columns=[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",width:1,render:(_,entry)=>(0,dayjs.Bv)(entry.timestamp).format("YYYY-MM-DD HH:mm:ss.SSS UTC")},{title:"Level",key:"level",dataIndex:"level",width:1,render:(_,entry)=>(0,pipeline_utils.bH)(entry.level)},{title:"Run ID",key:"run_id",dataIndex:"instance_id",width:1,render:(_,entry)=>entry.instance_id},{title:"Message",key:"message",dataIndex:"message",width:6}],LogsView=_ref=>{let{job}=_ref,logic=schemaLogLogic({job}),{logs,logsLoading,logsBackground,isThereMoreToLoad}=(0,index_esm.useValues)(logic),{revealBackground,loadSchemaLogsMore}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"ph-no-capture space-y-2 flex-1",children:[(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{onClick:revealBackground,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:logsBackground.length?void 0:"There's nothing to load",children:logsBackground.length?`Load ${(0,utils.Zi)(logsBackground.length,"newer entry","newer entries")}`:"No new entries"}),(0,jsx_runtime.jsx)(lemon_ui_src.g3,{dataSource:logs,columns:columns,loading:logsLoading,className:"ph-no-capture",pagination:{pageSize:200,hideOnSinglePage:!0}}),!!logs.length&&(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{onClick:loadSchemaLogsMore,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:isThereMoreToLoad?void 0:"There's nothing more to load",children:isThereMoreToLoad?`Load up to ${constants.F2} older entries`:"No older entries"})]})},Syncs_StatusTagSetting={Running:"primary",Completed:"success",Failed:"danger",Cancelled:"default"},Syncs=_ref=>{let{id}=_ref,{jobs,jobsLoading,canLoadMoreJobs}=(0,index_esm.useValues)(dataWarehouseSourceSettingsLogic({id})),{loadMoreJobs}=(0,index_esm.useActions)(dataWarehouseSourceSettingsLogic({id}));return(0,jsx_runtime.jsx)(lemon_ui_src.g3,{dataSource:jobs,loading:jobsLoading,disableTableWhileLoading:!1,columns:[{title:"Schema",render:(_,job)=>job.schema.name},{title:"Status",render:(_,job)=>(0,jsx_runtime.jsx)(lemon_ui_src.oe,{type:Syncs_StatusTagSetting[job.status],children:job.status})},{title:"Rows synced",render:(_,job)=>job.rows_synced},{title:"Synced at",render:(_,job)=>(0,jsx_runtime.jsx)(src.w4,{time:job.created_at,formatDate:"MMM\xa0DD,\xa0YYYY",formatTime:"HH:mm"})}],expandable:jobs.length>0?{expandedRowRender:job=>(0,jsx_runtime.jsx)("div",{className:"p-4",children:(0,jsx_runtime.jsx)(LogsView,{job:job})}),rowExpandable:()=>!0,noIndent:!0}:void 0,footer:(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{onClick:loadMoreJobs,type:"secondary",fullWidth:!0,center:!0,disabledReason:canLoadMoreJobs?void 0:"There's nothing more to load",children:canLoadMoreJobs?"Load older jobs":"No older jobs"})})};var posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.7.3_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),kea_router_lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),sceneTypes=__webpack_require__("./frontend/src/scenes/sceneTypes.ts"),types=__webpack_require__("./frontend/src/types.ts"),pipelineNodeNewLogic=__webpack_require__("./frontend/src/scenes/pipeline/pipelineNodeNewLogic.tsx"),pipeline_types=__webpack_require__("./frontend/src/scenes/pipeline/types.ts");let pipelineNodeLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(id=>["scenes","pipeline","pipelineNodeLogic",id]),(0,index_esm.actions)({setCurrentTab:function(){let tab=arguments.length>0&&void 0!==arguments[0]?arguments[0]:types.il.Configuration;return{tab}},setBreadcrumbTitle:title=>({title})}),(0,index_esm.reducers)(()=>({currentTab:[types.il.Configuration,{setCurrentTab:(_,_ref2)=>{let{tab}=_ref2;return tab}}],breadcrumbTitle:["",{setBreadcrumbTitle:(_,_ref3)=>{let{title}=_ref3;return title}}]})),(0,index_esm.selectors)(()=>({breadcrumbs:[(s,p)=>[p.id,p.stage,s.breadcrumbTitle],(id,stage,breadcrumbTitle)=>[{key:sceneTypes.x.Pipeline,name:"Data pipeline",path:urls.j.pipeline()},{key:stage||"unknown",name:stage?(0,utils.fm)(pipelineNodeNewLogic.U[stage]||""):"Unknown",path:urls.j.pipeline(stage?pipelineNodeNewLogic.U[stage]:void 0)},{key:[sceneTypes.x.PipelineNode,id],name:breadcrumbTitle}]],activityFilters:[s=>[s.node],node=>node.backend===pipeline_types.b.Plugin?{scope:types.jc.PLUGIN,item_id:`${node.id}`}:null],nodeBackend:[s=>[s.node],node=>node.backend],node:[(_,p)=>[p.id],id=>"string"==typeof id?0===id.indexOf("hog-")?{backend:pipeline_types.b.HogFunction,id:`${id}`.replace("hog-","")}:0===id.indexOf("managed")?{backend:pipeline_types.b.ManagedSource,id:`${id}`.replace("managed-","")}:{backend:pipeline_types.b.BatchExport,id}:{backend:pipeline_types.b.Plugin,id}],tabs:[s=>[s.nodeBackend],nodeBackend=>{let tabs=Object.values(types.il);return nodeBackend===pipeline_types.b.BatchExport?tabs.filter(t=>t!==types.il.History):tabs}],id:[(_,p)=>[p.id],id=>id],stage:[(_,p)=>[p.stage],stage=>stage]})),(0,kea_router_lib.actionToUrl)(_ref4=>{let{values,props}=_ref4;return{setCurrentTab:()=>[urls.j.pipelineNode(props.stage,props.id,values.currentTab)]}}),(0,kea_router_lib.urlToAction)(_ref5=>{let{props,actions,values}=_ref5;return{[urls.j.pipelineNode(props.stage,props.id,":nodeTab")]:_ref6=>{let{nodeTab}=_ref6;nodeTab!==values.currentTab&&Object.values(types.il).includes(nodeTab)&&actions.setCurrentTab(nodeTab)}}})]);var teamLogic=__webpack_require__("./frontend/src/scenes/teamLogic.tsx");let pipelineNodeLogsLogic_ALL_LOG_LEVELS=["DEBUG","LOG","INFO","WARNING","ERROR"],pipelineNodeLogsLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(key=>["scenes","pipeline","pipelineNodeLogsLogic",key]),(0,index_esm.connect)(props=>({values:[(0,teamLogic.H)(),["currentTeamId"],pipelineNodeLogic(props),["node"]]})),(0,index_esm.actions)({setSelectedLogLevels:levels=>({levels}),setSearchTerm:searchTerm=>({searchTerm}),setInstanceId:instanceId=>({instanceId}),clearBackgroundLogs:!0,markLogsEnd:!0}),(0,lib.loaders)(_ref2=>{let{values,actions,cache}=_ref2;return{logs:[[],{loadLogs:async()=>{var _values$instanceId;let results=[],logParams={search:values.searchTerm,level:values.selectedLogLevelsForAPI.join(","),limit:constants.F2,instance_id:null!==(_values$instanceId=values.instanceId)&&void 0!==_values$instanceId?_values$instanceId:void 0};if(values.node.backend===pipeline_types.b.BatchExport){let res=await api.ZP.batchExports.logs(values.node.id,logParams);results=res.results}else if(values.node.backend===pipeline_types.b.HogFunction){let res=await api.ZP.hogFunctions.logs(values.node.id,logParams);results=res.results}else{if(values.node.backend===pipeline_types.b.ManagedSource)return[];results=await api.ZP.pluginConfigs.logs(values.node.id,logParams)}return cache.pollingInterval||(cache.pollingInterval=setInterval(actions.pollBackgroundLogs,5e3)),actions.clearBackgroundLogs(),results},loadMoreLogs:async()=>{var _values$instanceId2;let results;let logParams={search:values.searchTerm,level:values.selectedLogLevels.join(","),limit:constants.F2,before:values.trailingEntry?.timestamp,instance_id:null!==(_values$instanceId2=values.instanceId)&&void 0!==_values$instanceId2?_values$instanceId2:void 0};if(values.node.backend===pipeline_types.b.BatchExport){let res=await api.ZP.batchExports.logs(values.node.id,logParams);results=res.results}else if(values.node.backend===pipeline_types.b.HogFunction){let res=await api.ZP.hogFunctions.logs(values.node.id,logParams);results=res.results}else{if(values.node.backend===pipeline_types.b.ManagedSource)return[];results=await api.ZP.pluginConfigs.logs(values.node.id,logParams)}return results.length<constants.F2&&actions.markLogsEnd(),[...values.logs,...results]},revealBackground:()=>{let newArray=[...values.backgroundLogs,...values.logs];return actions.clearBackgroundLogs(),newArray}}],backgroundLogs:[[],{pollBackgroundLogs:async()=>{var _values$instanceId3;let results;if(values.logsLoading)return values.backgroundLogs;let logParams={search:values.searchTerm,level:values.selectedLogLevels.join(","),limit:constants.F2,after:values.leadingEntry?.timestamp,instance_id:null!==(_values$instanceId3=values.instanceId)&&void 0!==_values$instanceId3?_values$instanceId3:void 0};if(values.node.backend===pipeline_types.b.BatchExport){let res=await api.ZP.batchExports.logs(values.node.id,logParams);results=res.results}else if(values.node.backend===pipeline_types.b.HogFunction){let res=await api.ZP.hogFunctions.logs(values.node.id,logParams);results=res.results}else{if(values.node.backend===pipeline_types.b.ManagedSource)return[];results=await api.ZP.pluginConfigs.logs(values.node.id,logParams)}return[...results,...values.backgroundLogs]}}]}}),(0,index_esm.reducers)({selectedLogLevels:[["LOG","INFO","WARNING","ERROR"],{setSelectedLogLevels:(_,_ref3)=>{let{levels}=_ref3;return levels}}],backgroundLogs:[[],{clearBackgroundLogs:()=>[]}],searchTerm:["",{setSearchTerm:(_,_ref4)=>{let{searchTerm}=_ref4;return searchTerm}}],instanceId:[null,{setInstanceId:(_,_ref5)=>{let{instanceId}=_ref5;return instanceId}}],isThereMoreToLoad:[!0,{loadLogsSuccess:(_,_ref6)=>{let{logs}=_ref6;return logs.length>=constants.F2},markLogsEnd:()=>!1}]}),(0,index_esm.selectors)(_ref7=>{let{actions,values}=_ref7;return{leadingEntry:[s=>[s.logs,s.backgroundLogs],(logs,backgroundLogs)=>backgroundLogs.length?backgroundLogs[0]:logs.length?logs[0]:null],trailingEntry:[s=>[s.logs,s.backgroundLogs],(logs,backgroundLogs)=>logs.length?logs[logs.length-1]:backgroundLogs.length?backgroundLogs[backgroundLogs.length-1]:null],columns:[s=>[s.node],node=>[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",sorter:(a,b)=>(0,dayjs.Bv)(a.timestamp).unix()-(0,dayjs.Bv)(b.timestamp).unix(),render:timestamp=>(0,jsx_runtime.jsx)(src.w4,{time:timestamp}),width:0},{width:0,title:node.backend==pipeline_types.b.HogFunction?"Invocation":node.backend==pipeline_types.b.BatchExport?"Run Id":"Source",dataIndex:"instance_id",key:"instance_id",render:instanceId=>(0,jsx_runtime.jsx)("code",{className:"whitespace-nowrap",children:node.backend!==pipeline_types.b.Plugin?(0,jsx_runtime.jsx)(lemon_ui_src.rU,{subtle:!0,onClick:()=>{values.instanceId===instanceId?actions.setInstanceId(null):actions.setInstanceId(instanceId)},children:instanceId}):instanceId})},{width:100,title:"Level",key:"level",dataIndex:"level",render:pipeline_utils.bH},{title:"Message",key:"message",dataIndex:"message",render:message=>(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}]],selectedLogLevelsForAPI:[s=>[s.selectedLogLevels],logLevels=>{let uniqueLevels=new Set(logLevels);return uniqueLevels.has("WARN")&&uniqueLevels.add("WARNING"),uniqueLevels.has("WARNING")&&uniqueLevels.add("WARN"),Array.from(uniqueLevels)}]}}),(0,index_esm.listeners)(_ref8=>{let{actions}=_ref8;return{setSelectedLogLevels:()=>{actions.loadLogs()},setSearchTerm:async(_ref9,breakpoint)=>{let{searchTerm}=_ref9;searchTerm&&await breakpoint(1e3),actions.loadLogs()},setInstanceId:async()=>{actions.loadLogs()}}}),(0,index_esm.events)(_ref10=>{let{actions,cache}=_ref10;return{afterMount:()=>{actions.loadLogs()},beforeUnmount:()=>{clearInterval(cache.pollingInterval)}}})]);function PipelineNodeLogs(_ref){let{id,stage}=_ref,logic=pipelineNodeLogsLogic({id,stage}),{logs,logsLoading,backgroundLogs,columns,isThereMoreToLoad,selectedLogLevels,instanceId}=(0,index_esm.useValues)(logic),{revealBackground,loadMoreLogs,setSelectedLogLevels,setSearchTerm,setInstanceId}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"ph-no-capture space-y-2 flex-1",children:[(0,jsx_runtime.jsx)(lemon_ui_src.DF,{type:"search",placeholder:"Search for messages containing…",fullWidth:!0,onChange:setSearchTerm,allowClear:!0,prefix:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconSearch,{}),instanceId&&(0,jsx_runtime.jsx)(lemon_ui_src.LV,{onClose:()=>setInstanceId(null),children:instanceId})]})}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-4",children:[(0,jsx_runtime.jsx)("span",{className:"mr-1",children:"Show logs of level:"}),pipelineNodeLogsLogic_ALL_LOG_LEVELS.map(level=>(0,jsx_runtime.jsx)(lemon_ui_src.Hw,{label:level,checked:selectedLogLevels.includes(level),onChange:checked=>{let newLogLevels=checked?[...selectedLogLevels,level]:selectedLogLevels.filter(t=>t!=level);setSelectedLogLevels(newLogLevels)}},level))]}),(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{onClick:revealBackground,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:backgroundLogs.length?void 0:"There's nothing to load",children:backgroundLogs.length?`Load ${(0,utils.Zi)(backgroundLogs.length,"newer entry","newer entries")}`:"No new entries"}),(0,jsx_runtime.jsx)(lemon_ui_src.g3,{dataSource:logs,columns:columns,loading:logsLoading,className:"ph-no-capture",rowKey:record=>`${record.log_source_id}:${record.instance_id}:${record.timestamp}`,pagination:{pageSize:200,hideOnSinglePage:!0}}),!!logs.length&&(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{onClick:loadMoreLogs,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:isThereMoreToLoad?void 0:"There's nothing more to load",children:isThereMoreToLoad?`Load up to ${constants.F2} older entries`:"No older entries"})]})}var clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),DateFilter=__webpack_require__("./frontend/src/lib/components/DateFilter/DateFilter.tsx"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts"),kea_forms_lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonCalendarSelect=__webpack_require__("./frontend/src/lib/lemon-ui/LemonCalendar/LemonCalendarSelect.tsx"),LemonField=__webpack_require__("./frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonModal=__webpack_require__("./frontend/src/lib/lemon-ui/LemonModal/index.ts"),pipelineBatchExportConfigurationLogic=__webpack_require__("./frontend/src/scenes/pipeline/pipelineBatchExportConfigurationLogic.tsx");let batchExportRunsLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(key=>["scenes","pipeline","batchExportRunsLogic",key]),(0,index_esm.connect)(props=>({values:[(0,teamLogic.H)(),["currentTeamId"],(0,pipelineBatchExportConfigurationLogic.t)({id:props.id,service:null}),["batchExportConfig"]]})),(0,index_esm.actions)({setDateRange:(from,to)=>({from,to}),switchLatestRuns:enabled=>({enabled}),loadRuns:!0,retryRun:run=>({run}),openBackfillModal:!0,closeBackfillModal:!0}),(0,lib.loaders)(_ref2=>{let{props,values}=_ref2;return{runsPaginatedResponse:[null,{loadRuns:async()=>values.usingLatestRuns?await api.ZP.batchExports.listRuns(props.id,{}):await api.ZP.batchExports.listRuns(props.id,{start:values.dateRange.from,end:values.dateRange.to,ordering:"-data_interval_start"}),loadOlderRuns:async()=>{var _values$runsPaginated;let nextUrl=values.runsPaginatedResponse?.next;if(!nextUrl)return values.runsPaginatedResponse;let res=await api.ZP.get(nextUrl);return res.results=[...null!==(_values$runsPaginated=values.runsPaginatedResponse?.results)&&void 0!==_values$runsPaginated?_values$runsPaginated:[],...res.results],res}}]}}),(0,index_esm.reducers)({dateRange:[{from:"-2d",to:null},{setDateRange:(_,_ref3)=>{let{from,to}=_ref3;return{from:null!=from?from:"-2d",to:to}}}],usingLatestRuns:[!0,{switchLatestRuns:(_,_ref4)=>{let{enabled}=_ref4;return enabled}}],isBackfillModalOpen:[!1,{openBackfillModal:()=>!0,closeBackfillModal:()=>!1}]}),(0,kea_forms_lib.forms)(_ref5=>{let{props,actions}=_ref5;return{backfillForm:{defaults:{end_at:(0,dayjs.Bv)()},errors:_ref6=>{let{start_at,end_at}=_ref6;return{start_at:start_at?void 0:"Start date is required",end_at:end_at?void 0:"End date is required"}},submit:async _ref7=>{var _start_at$toISOString,_end_at$toISOString;let{start_at,end_at}=_ref7;await new Promise(resolve=>setTimeout(resolve,1e3)),await api.ZP.batchExports.createBackfill(props.id,{start_at:null!==(_start_at$toISOString=start_at?.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=end_at?.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null}).catch(e=>{if(e.detail){var _e$attr;actions.setBackfillFormManualErrors({[null!==(_e$attr=e.attr)&&void 0!==_e$attr?_e$attr:"start_at"]:e.detail})}else lemon_ui_src.UJ.error("Unknown error occurred");throw e}),actions.closeBackfillModal(),actions.loadRuns()}}}}),(0,index_esm.selectors)({hasMoreRunsToLoad:[s=>[s.runsPaginatedResponse],runsPaginatedResponse=>!!runsPaginatedResponse?.next],loading:[s=>[s.runsPaginatedResponseLoading],runsPaginatedResponseLoading=>runsPaginatedResponseLoading],latestRuns:[s=>[s.runsPaginatedResponse],runsPaginatedResponse=>{var _runsPaginatedRespons;let runs=null!==(_runsPaginatedRespons=runsPaginatedResponse?.results)&&void 0!==_runsPaginatedRespons?_runsPaginatedRespons:[];return runs.map(run=>({...run,created_at:(0,dayjs.fp)(run.created_at,teamLogic.H.values.timezone),data_interval_start:(0,dayjs.fp)(run.data_interval_start,teamLogic.H.values.timezone),data_interval_end:(0,dayjs.fp)(run.data_interval_end,teamLogic.H.values.timezone),last_updated_at:run.last_updated_at?(0,dayjs.fp)(run.last_updated_at,teamLogic.H.values.timezone):void 0}))}],groupedRuns:[s=>[s.runsPaginatedResponse,s.usingLatestRuns],(runsPaginatedResponse,usingLatestRuns)=>{var _runsPaginatedRespons2;if(usingLatestRuns)return[];let runs=null!==(_runsPaginatedRespons2=runsPaginatedResponse?.results)&&void 0!==_runsPaginatedRespons2?_runsPaginatedRespons2:[],groupedRuns={};return runs.forEach(run=>{let key=`${run.data_interval_start}-${run.data_interval_end}`;groupedRuns[key]||(groupedRuns[key]={data_interval_start:(0,dayjs.fp)(run.data_interval_start,teamLogic.H.values.timezone),data_interval_end:(0,dayjs.fp)(run.data_interval_end,teamLogic.H.values.timezone),runs:[],last_run_at:(0,dayjs.fp)(run.created_at,teamLogic.H.values.timezone)}),groupedRuns[key].runs.push({...run,created_at:(0,dayjs.fp)(run.created_at,teamLogic.H.values.timezone),data_interval_start:(0,dayjs.fp)(run.data_interval_start,teamLogic.H.values.timezone),data_interval_end:(0,dayjs.fp)(run.data_interval_end,teamLogic.H.values.timezone),last_updated_at:run.last_updated_at?(0,dayjs.fp)(run.last_updated_at,teamLogic.H.values.timezone):void 0}),groupedRuns[key].runs.sort((a,b)=>b.created_at.diff(a.created_at)),groupedRuns[key].last_run_at=groupedRuns[key].runs[0].created_at}),Object.values(groupedRuns)}]}),(0,index_esm.listeners)(_ref8=>{let{actions,props}=_ref8;return{setDateRange:()=>{actions.loadRuns()},switchLatestRuns:()=>{actions.loadRuns()},retryRun:async _ref9=>{let{run}=_ref9;await api.ZP.batchExports.createBackfill(props.id,{start_at:run.data_interval_start.toISOString(),end_at:run.data_interval_end.toISOString()}),lemon_ui_src.UJ.success("Retry has been scheduled.")}}}),(0,index_esm.afterMount)(_ref10=>{let{actions}=_ref10;actions.loadRuns()})]);function BatchExportBackfillModal(_ref){let{id}=_ref,logic=batchExportRunsLogic({id}),{batchExportConfig,isBackfillModalOpen,isBackfillFormSubmitting}=(0,index_esm.useValues)(logic),{closeBackfillModal}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)(LemonModal.f,{title:"Backfill batch export",onClose:closeBackfillModal,isOpen:isBackfillModalOpen,width:"30rem",footer:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary","data-attr":"batch-export-backfill-cancel",disabledReason:isBackfillFormSubmitting?"Please wait...":void 0,onClick:closeBackfillModal,children:"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{form:"batch-export-backfill-form",htmlType:"submit",type:"primary","data-attr":"batch-export-backfill-submit",loading:isBackfillFormSubmitting,children:"Schedule runs"})]}),children:[(0,jsx_runtime.jsxs)("p",{children:["Backfilling a batch export will sequentially run all batch periods that fall within the range specified below. The runs will export data in ",(0,jsx_runtime.jsx)("b",{children:batchExportConfig?.interval})," intervals, from the start date until the end date is reached."]}),(0,jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:batchExportRunsLogic,props:{id:id},formKey:"backfillForm",id:"batch-export-backfill-form",enableFormOnSubmit:!0,className:"space-y-2",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"start_at",label:"Start Date",className:"flex-1",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(LemonCalendarSelect.he,{value:value,onChange:onChange,placeholder:"Select start date"})}}),(0,jsx_runtime.jsx)(LemonField.D,{name:"end_at",label:"End date",className:"flex-1",children:_ref3=>{let{value,onChange}=_ref3;return(0,jsx_runtime.jsx)(LemonCalendarSelect.he,{value:value,onChange:onChange,placeholder:"Select end date (optional)"})}})]})]})}var pipelineAccessLogic=__webpack_require__("./frontend/src/scenes/pipeline/pipelineAccessLogic.tsx");function BatchExportRuns(_ref){let{id}=_ref,logic=batchExportRunsLogic({id}),{batchExportConfig,groupedRuns,loading,hasMoreRunsToLoad,usingLatestRuns}=(0,index_esm.useValues)(logic),{loadOlderRuns,retryRun,openBackfillModal}=(0,index_esm.useActions)(logic);return batchExportConfig?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Backfill batch export"})}),(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsx)(BatchExportRunsFilters,{id:id}),usingLatestRuns?(0,jsx_runtime.jsx)(BatchExportLatestRuns,{id:id}):(0,jsx_runtime.jsx)(BatchExportRunsGrouped,{id:id,groupedRuns:groupedRuns,loading:loading,retryRun:retryRun,hasMoreRunsToLoad:hasMoreRunsToLoad,loadOlderRuns:loadOlderRuns,interval:batchExportConfig.interval})]}),(0,jsx_runtime.jsx)(BatchExportBackfillModal,{id:id})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BatchExportRunsFilters(_ref2){let{id}=_ref2,logic=batchExportRunsLogic({id}),{dateRange,usingLatestRuns,loading}=(0,index_esm.useValues)(logic),{setDateRange,switchLatestRuns,loadRuns}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{onClick:loadRuns,loading:loading,type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),size:"small",children:"Refresh"}),(0,jsx_runtime.jsx)(lemon_ui_src.f4,{bordered:!0,label:"Show latest runs",checked:usingLatestRuns,onChange:switchLatestRuns,size:"small"}),(0,jsx_runtime.jsx)(DateFilter.f,{dateTo:dateRange.to,dateFrom:dateRange.from,disabledReason:usingLatestRuns?'Turn off "Show latest runs" to filter by data interval':void 0,onChange:(from,to)=>setDateRange(from,to),allowedRollingDateOptions:["hours","days","weeks","months","years"],makeLabel:key=>(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalendar,{})," ",key]})})]})}function BatchExportLatestRuns(_ref3){let{id}=_ref3,logic=batchExportRunsLogic({id}),{batchExportConfig,latestRuns,loading,hasMoreRunsToLoad}=(0,index_esm.useValues)(logic),{openBackfillModal,loadOlderRuns,retryRun}=(0,index_esm.useActions)(logic),{canEnableNewDestinations}=(0,index_esm.useValues)(pipelineAccessLogic.g);return batchExportConfig?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(lemon_ui_src.g3,{dataSource:latestRuns,loading:loading,loadingSkeletonRows:5,footer:hasMoreRunsToLoad&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{center:!0,fullWidth:!0,onClick:loadOlderRuns,loading:loading,children:"Load more rows"})}),columns:[{title:"Status",key:"status",width:0,render:(_,run)=>(0,jsx_runtime.jsx)(BatchExportRunIcon,{runs:[run],showLabel:!0})},{title:"ID",key:"runId",render:(_,run)=>run.id},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(src.w4,{time:run.data_interval_start,formatDate:"MMMM\xa0DD,\xa0YYYY",formatTime:"HH:mm:ss"})},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(src.w4,{time:run.data_interval_end,formatDate:"MMMM\xa0DD,\xa0YYYY",formatTime:"HH:mm:ss"})},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,run)=>(0,jsx_runtime.jsx)(src.w4,{time:run.created_at})},{key:"actions",width:0,render:function RenderActions(_,run){if(canEnableNewDestinations)return(0,jsx_runtime.jsx)(RunRetryButton,{run:run,retryRun:retryRun})}}],emptyState:(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsxs)("div",{children:["No runs in this time range. Your exporter runs every ",(0,jsx_runtime.jsx)("b",{children:batchExportConfig.interval}),"."]}),canEnableNewDestinations&&(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Backfill batch export"})]})})}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BatchExportRunsGrouped(_ref4){let{id,groupedRuns,loading,retryRun,hasMoreRunsToLoad,loadOlderRuns,interval}=_ref4,logic=batchExportRunsLogic({id}),{canEnableNewDestinations}=(0,index_esm.useValues)(pipelineAccessLogic.g),{openBackfillModal}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(lemon_ui_src.g3,{dataSource:groupedRuns,loading:loading,loadingSkeletonRows:5,footer:hasMoreRunsToLoad&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{center:!0,fullWidth:!0,onClick:loadOlderRuns,loading:loading,children:"Load more rows"})}),expandable:{noIndent:!0,expandedRowRender:groupedRuns=>(0,jsx_runtime.jsx)(lemon_ui_src.g3,{dataSource:groupedRuns.runs,embedded:!0,columns:[{title:"Status",key:"status",width:0,render:(_,run)=>(0,jsx_runtime.jsx)(BatchExportRunIcon,{runs:[run],showLabel:!0})},{title:"ID",key:"runId",render:(_,run)=>run.id},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,run)=>(0,jsx_runtime.jsx)(src.w4,{time:run.created_at})}]})},columns:[{key:"icon",width:0,render:(_,groupedRun)=>(0,jsx_runtime.jsx)(BatchExportRunIcon,{runs:groupedRun.runs})},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(src.w4,{time:run.data_interval_start,formatDate:"MMMM\xa0DD,\xa0YYYY",formatTime:"HH:mm:ss"})},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(src.w4,{time:run.data_interval_end,formatDate:"MMMM\xa0DD,\xa0YYYY",formatTime:"HH:mm:ss"})},{title:"Latest run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,groupedRun)=>(0,jsx_runtime.jsx)(src.w4,{time:groupedRun.last_run_at})},{key:"actions",width:0,render:function RenderActions(_,groupedRun){if(!(0,pipeline_utils.WT)(groupedRun.runs[0])&&canEnableNewDestinations)return(0,jsx_runtime.jsx)(RunRetryButton,{run:groupedRun.runs[0],retryRun:retryRun})}}],emptyState:(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsxs)("div",{children:["No runs in this time range. Your exporter runs every ",(0,jsx_runtime.jsx)("b",{children:interval}),"."]}),canEnableNewDestinations&&(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Backfill batch export"})]})})})}function RunRetryButton(_ref5){let{run,retryRun}=_ref5;return(0,jsx_runtime.jsx)("span",{className:"flex items-center gap-1",children:(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),onClick:()=>lemon_ui_src.dn.open({title:"Retry export?",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"This will schedule a new run for the same interval. Any changes to the configuration will be applied to the new run."}),(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("b",{children:"Please note -"})," there may be a slight delay before the new run appears."]})]}),width:"20rem",primaryButton:{children:"Retry",onClick:()=>retryRun(run)},secondaryButton:{children:"Cancel"}})})})}function BatchExportRunIcon(_ref6){let{runs,showLabel=!1}=_ref6,latestRun=runs[0],status=combineFailedStatuses(latestRun.status),color=colorForStatus(status);return(0,jsx_runtime.jsx)(lemon_ui_src.u,{title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Run status: ",status,runs.length>1&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),"Attempts: ",runs.length]})]}),children:(0,jsx_runtime.jsx)("span",{className:(0,clsx_m.default)(`BatchExportRunIcon h-6 p-2 border-2 flex items-center justify-center rounded-full font-semibold text-xs border-${color} text-${color}-dark select-none`,"primary"===color&&"BatchExportRunIcon--pulse",showLabel?"":"w-6"),children:showLabel?(0,jsx_runtime.jsx)("span",{className:"text-center",children:status}):runs.length})})}let combineFailedStatuses=status=>"FailedRetryable"===status?"Failed":status,colorForStatus=status=>{switch(status){case"Completed":return"success";case"ContinuedAsNew":case"Running":case"Starting":return"primary";case"Cancelled":case"Terminated":case"TimedOut":return"warning";case"Failed":case"FailedRetryable":return"danger";default:return"default"}};var HogFunctionConfiguration=__webpack_require__("./frontend/src/scenes/pipeline/hogfunctions/HogFunctionConfiguration.tsx"),PipelineBatchExportConfiguration=__webpack_require__("./frontend/src/scenes/pipeline/PipelineBatchExportConfiguration.tsx"),PipelinePluginConfiguration=__webpack_require__("./frontend/src/scenes/pipeline/PipelinePluginConfiguration.tsx");function PipelineNodeConfiguration(){let{node,stage}=(0,index_esm.useValues)(pipelineNodeLogic);return stage?(0,jsx_runtime.jsx)("div",{className:"space-y-3",children:node.backend===pipeline_types.b.HogFunction?(0,jsx_runtime.jsx)(HogFunctionConfiguration.g,{id:node.id}):node.backend===pipeline_types.b.Plugin?(0,jsx_runtime.jsx)(PipelinePluginConfiguration.s,{stage:stage,pluginConfigId:node.id}):(0,jsx_runtime.jsx)(PipelineBatchExportConfiguration.B,{id:node.id})}):(0,jsx_runtime.jsx)(NotFound.T,{object:"pipeline app stage"})}var Chart=__webpack_require__("./frontend/src/lib/Chart.ts"),colors=__webpack_require__("./frontend/src/lib/colors.ts"),CodeSnippet=__webpack_require__("./frontend/src/lib/components/CodeSnippet/index.ts"),TZLabel=__webpack_require__("./frontend/src/lib/components/TZLabel/index.tsx"),LemonLabel=__webpack_require__("./frontend/src/lib/lemon-ui/LemonLabel/LemonLabel.tsx"),LemonSkeleton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonSkeleton/index.ts"),LemonTable=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTable/index.ts"),Link=__webpack_require__("./frontend/src/lib/lemon-ui/Link/index.ts"),Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip/index.ts"),pipelineNodeMetricsLogic=__webpack_require__("./frontend/src/scenes/pipeline/pipelineNodeMetricsLogic.tsx");function PipelineNodeMetrics(_ref){let{id}=_ref,logic=(0,pipelineNodeMetricsLogic.j)({id}),{appMetricsResponse,appMetricsResponseLoading,dateRange}=(0,index_esm.useValues)(logic),{setDateRange}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"space-y-8",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,jsx_runtime.jsx)(MetricsOverview,{metrics:appMetricsResponse?.metrics,metricsLoading:appMetricsResponseLoading}),(0,jsx_runtime.jsx)(DateFilter.f,{dateTo:dateRange.to,dateFrom:dateRange.from,onChange:(from,to)=>setDateRange(from,to),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalendar,{})," ",key]})})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h2",{children:"Delivery trends"}),(0,jsx_runtime.jsx)(AppMetricsGraph,{metrics:appMetricsResponse?.metrics,metricsLoading:appMetricsResponseLoading})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h2",{children:"Errors"}),(0,jsx_runtime.jsx)(ErrorsOverview,{id:id})]})]})}function MetricsOverview(_ref2){let{metrics,metricsLoading}=_ref2;return metricsLoading?(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"w-20 h-4 mb-2",repeat:4}):(0,jsx_runtime.jsx)("div",{className:"space-y-4",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-start gap-8 flex-wrap",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"text-muted font-semibold mb-2",children:["Events Processed successfully",(0,jsx_runtime.jsx)(Tooltip.u,{title:"Total number of events processed successfully",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{})})]}),(0,jsx_runtime.jsx)("div",{className:"text-4xl",children:renderNumber(metrics?.totals?.successes)})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"text-muted font-semibold mb-2",children:["Events Failed",(0,jsx_runtime.jsx)(Tooltip.u,{title:"Total number of events that threw an error during processing",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{})})]}),(0,jsx_runtime.jsx)("div",{className:"text-4xl",children:renderNumber(metrics?.totals?.failures)})]})]})})}function renderNumber(value){return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:value?(0,utils.Lc)(value):value})}function AppMetricsGraph(_ref3){let{metrics,metricsLoading}=_ref3,canvasRef=(0,react.useRef)(null);return((0,react.useEffect)(()=>{let chart;if(canvasRef.current&&metrics&&!(0,utils.es)())return chart=new Chart.k(canvasRef.current?.getContext("2d"),{type:"line",data:{labels:metrics.dates,datasets:[{label:"events processed successfully",data:metrics.successes,borderColor:"",...colorConfig("data-color-1")},{label:"events failed",data:metrics.failures,...colorConfig("data-color-5")}]},options:{scales:{x:{ticks:{maxRotation:0},grid:{display:!1}},y:{beginAtZero:!0}},plugins:{crosshair:!1,legend:{display:!1}},maintainAspectRatio:!1,interaction:{mode:"index",axis:"x",intersect:!1}}}),()=>{chart?.destroy()}},[metrics]),metricsLoading||!metrics)?(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"AppMetricsGraph border rounded p-6"}):(0,jsx_runtime.jsx)("div",{className:"AppMetricsGraph border rounded p-6",children:(0,jsx_runtime.jsx)("canvas",{ref:canvasRef})})}function colorConfig(baseColorVar){let mainColor=(0,colors.cM)(baseColorVar);return{borderColor:mainColor,hoverBorderColor:(0,utils._$)(mainColor,-20),hoverBackgroundColor:(0,utils._$)(mainColor,-20),backgroundColor:mainColor,fill:!1,borderWidth:2,pointRadius:0}}function ErrorsOverview(_ref4){let{id}=_ref4,logic=(0,pipelineNodeMetricsLogic.j)({id}),{appMetricsResponse,appMetricsResponseLoading}=(0,index_esm.useValues)(logic),{openErrorDetailsModal}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ErrorDetailsModal,{id:id}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:appMetricsResponse?.errors||[],loading:appMetricsResponseLoading,columns:[{title:"Error type",dataIndex:"error_type",render:function RenderErrorType(_,errorSummary){return(0,jsx_runtime.jsx)(Link.r,{title:"View details",className:"font-semibold",onClick:event=>{event.preventDefault(),openErrorDetailsModal(errorSummary.error_type)},children:errorSummary.error_type})},sorter:(a,b)=>a.error_type.localeCompare(b.error_type)},{title:"Count",dataIndex:"count",align:"right",sorter:(a,b)=>a.count-b.count},{title:"Last seen",dataIndex:"last_seen",render:function RenderCreatedAt(lastSeen){return(0,jsx_runtime.jsx)("div",{className:"whitespace-nowrap text-right",children:(0,jsx_runtime.jsx)(TZLabel.w,{time:lastSeen})})},align:"right",sorter:(a,b)=>new Date(a.last_seen||0)>new Date(b.last_seen||0)?1:-1}],defaultSorting:{columnKey:"last_seen",order:-1},useURLForSorting:!1,noSortingCancellation:!0,emptyState:(0,jsx_runtime.jsxs)("div",{className:"",children:[(0,jsx_runtime.jsx)("b",{children:"No errors! \uD83E\uDD73"}),(0,jsx_runtime.jsx)("p",{className:"m-0",children:"If this app has any errors in the future, this table will contain information to help solve the issue."})]})})]})}function ErrorDetailsModal(_ref5){let{id}=_ref5,logic=(0,pipelineNodeMetricsLogic.j)({id}),{errorDetails,errorDetailsModalError,errorDetailsLoading}=(0,index_esm.useValues)(logic),{closeErrorDetailsModal}=(0,index_esm.useActions)(logic),[page,setPage]=(0,react.useState)(0),activeErrorDetails=errorDetails[page];return(0,jsx_runtime.jsx)(LemonModal.f,{isOpen:!!errorDetailsModalError,onClose:closeErrorDetailsModal,title:errorDetailsModalError,width:"min(50vw, 80rem)",description:(0,jsx_runtime.jsx)("span",{children:activeErrorDetails?.error_details?.error.message?.substring(0,200)}),footer:(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-end gap-1 h-",children:errorDetailsLoading?(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"h-10"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("span",{children:[page+1," of ",errorDetails.length," sample",errorDetails.length>1?"s":""]}),(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(icons.ed,{}),onClick:()=>setPage(page-1),disabledReason:0==page?"First page":void 0}),(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(icons.VG,{}),onClick:()=>setPage(page+1),disabledReason:page==errorDetails.length-1?"Last page":void 0})]})}),children:!errorDetailsModalError||errorDetailsLoading?(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"h-10"}):(0,jsx_runtime.jsxs)("div",{className:"flex flex-col space-y-2",style:{height:"80vh"},children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"When:"})," ",(0,jsx_runtime.jsx)(TZLabel.w,{time:activeErrorDetails.timestamp,showSeconds:!0})]}),activeErrorDetails.error_details.eventCount&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(LemonLabel.H,{children:"Event Count"}),(0,jsx_runtime.jsx)("div",{children:activeErrorDetails.error_details.eventCount})]}),activeErrorDetails.error_details.error.message&&(0,jsx_runtime.jsx)(CollapsibleSection,{title:"Error message",defaultIsExpanded:!0,children:(0,jsx_runtime.jsx)(CodeSnippet.O,{wrap:!0,language:CodeSnippet.S.JavaScript,children:activeErrorDetails.error_details.error.message})}),activeErrorDetails.error_details.event&&(0,jsx_runtime.jsx)(CollapsibleSection,{title:"Event payload",defaultIsExpanded:!1,children:(0,jsx_runtime.jsx)(CodeSnippet.O,{wrap:!0,language:CodeSnippet.S.JSON,children:JSON.stringify(activeErrorDetails.error_details.event,null,2)})}),activeErrorDetails.error_details.error.stack&&(0,jsx_runtime.jsx)(CollapsibleSection,{title:"Stack trace",defaultIsExpanded:!1,children:(0,jsx_runtime.jsx)(CodeSnippet.O,{wrap:!0,language:CodeSnippet.S.JavaScript,children:activeErrorDetails.error_details.error.stack})})]})})}function CollapsibleSection(props){let[isExpanded,setIsExpanded]=(0,react.useState)(props.defaultIsExpanded);return(0,jsx_runtime.jsxs)("div",{className:"bg-bg-3000 border rounded",children:[(0,jsx_runtime.jsx)(LemonButton.J,{fullWidth:!0,onClick:()=>setIsExpanded(!isExpanded),sideIcon:isExpanded?(0,jsx_runtime.jsx)(posthog_icons_es.IconCollapse,{}):(0,jsx_runtime.jsx)(posthog_icons_es.IconExpand,{}),title:isExpanded?"Show less":"Show more",className:"bg-bg-3000",children:props.title}),isExpanded&&(0,jsx_runtime.jsx)("div",{className:"bg-bg-light p-2",children:props.children})]})}var InsightTooltip=__webpack_require__("./frontend/src/scenes/insights/InsightTooltip/InsightTooltip.tsx"),pipelineNodeMetricsV2Logic=__webpack_require__("./frontend/src/scenes/pipeline/pipelineNodeMetricsV2Logic.tsx");let METRICS_INFO={succeeded:"Total number of events processed successfully",failed:"Total number of events that had errors during processing",filtered:"Total number of events that were filtered out",disabled_temporarily:"Total number of events that were skipped due to the destination being temporarily disabled (due to issues such as the destination being down or rate-limited)",disabled_permanently:"Total number of events that were skipped due to the destination being permanently disabled (due to prolonged issues with the destination)"};function PipelineNodeMetricsV2(){let{node}=(0,index_esm.useValues)(pipelineNodeLogic),logic=(0,pipelineNodeMetricsV2Logic.K)({id:`${node.id}`}),{filters}=(0,index_esm.useValues)(logic),{setFilters,loadMetrics,loadMetricsTotals}=(0,index_esm.useActions)(logic);return((0,react.useEffect)(()=>{loadMetrics(),loadMetricsTotals()},[]),node.backend!==pipeline_types.b.HogFunction)?(0,jsx_runtime.jsx)("div",{children:"Metrics not available for this node"}):(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:pipelineNodeMetricsV2Logic.K,props:{id:node.id},children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(AppMetricsTotals,{}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0",children:"Delivery trends"}),(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(lemon_ui_src.Yv,{options:[{label:"Hourly",value:"hour"},{label:"Daily",value:"day"},{label:"Weekly",value:"week"}],size:"small",value:filters.interval,onChange:value=>setFilters({interval:value})}),(0,jsx_runtime.jsx)(DateFilter.f,{dateTo:filters.before,dateFrom:filters.after,onChange:(from,to)=>setFilters({after:from||void 0,before:to||void 0}),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalendar,{})," ",key]})})]}),(0,jsx_runtime.jsx)(PipelineNodeMetricsV2_AppMetricsGraph,{})]})})}function AppMetricBigNumber(_ref){let{label,value,tooltip}=_ref;return(0,jsx_runtime.jsx)(lemon_ui_src.u,{title:tooltip,children:(0,jsx_runtime.jsxs)("div",{className:"border p-2 rounded bg-bg-light flex-1 flex flex-col gap-2 items-center",children:[(0,jsx_runtime.jsx)("div",{className:"uppercase font-bold text-xs",children:label.replace(/_/g," ")}),(0,jsx_runtime.jsx)("div",{className:"text-2xl flex-1 mb-2 flex items-center",children:(0,utils.Lc)(null!=value?value:0)})]})})}function AppMetricsTotals(){let{appMetricsTotals,appMetricsTotalsLoading}=(0,index_esm.useValues)(pipelineNodeMetricsV2Logic.K);return(0,jsx_runtime.jsx)("div",{className:"space-y-4",children:(0,jsx_runtime.jsx)("div",{className:"flex items-center gap-2 flex-wrap",children:Object.entries(METRICS_INFO).map(_ref2=>{let[key,value]=_ref2;return(0,jsx_runtime.jsx)("div",{className:"flex flex-col h-30 min-w-30 flex-1 max-w-100",children:appMetricsTotalsLoading?(0,jsx_runtime.jsx)(lemon_ui_src.yW,{className:"h-full w-full"}):(0,jsx_runtime.jsx)(AppMetricBigNumber,{label:key,value:appMetricsTotals?.totals?.[key],tooltip:value})},key)})})})}function PipelineNodeMetricsV2_AppMetricsGraph(){let{appMetrics,appMetricsLoading}=(0,index_esm.useValues)(pipelineNodeMetricsV2Logic.K),canvasRef=(0,react.useRef)(null),[popoverContent,setPopoverContent]=(0,react.useState)(null),[tooltipState,setTooltipState]=(0,react.useState)({x:0,y:0,visible:!1});return(0,react.useEffect)(()=>{let chart;if(canvasRef.current&&appMetrics&&!(0,utils.es)())return chart=new Chart.k(canvasRef.current?.getContext("2d"),{type:"line",data:{labels:appMetrics.labels,datasets:[...appMetrics.series.map(series=>({label:series.name,data:series.values,borderColor:"",...function(name){let color="";switch(name){case"succeeded":color=(0,colors.cM)("success");break;case"failed":color=(0,colors.cM)("danger");break;default:color=(0,colors.cM)("data-color-1")}return{borderColor:color,hoverBorderColor:color,hoverBackgroundColor:color,backgroundColor:color,fill:!1,borderWidth:2,pointRadius:0}}(series.name)}))]},options:{scales:{x:{ticks:{maxRotation:0},grid:{display:!1}},y:{beginAtZero:!0}},plugins:{crosshair:!1,legend:{display:!1},tooltip:{enabled:!1,external(_ref3){let{tooltip,chart}=_ref3;setPopoverContent((0,jsx_runtime.jsx)(InsightTooltip.Q,{embedded:!0,hideInspectActorsSection:!0,altTitle:tooltip.dataPoints[0].label,seriesData:tooltip.dataPoints.map((dp,i)=>({id:i,dataIndex:0,datasetIndex:0,label:dp.dataset.label,color:dp.dataset.borderColor,count:dp.dataset.data?.[dp.dataIndex]||0})),renderSeries:value=>value,renderCount:count=>(0,utils.Lc)(count)}));let position=chart.canvas.getBoundingClientRect();setTooltipState({x:position.left+tooltip.caretX,y:position.top+tooltip.caretY,visible:tooltip.opacity>0})}}},maintainAspectRatio:!1,interaction:{mode:"index",axis:"x",intersect:!1}}}),()=>{chart?.destroy()}},[appMetrics]),(0,jsx_runtime.jsxs)("div",{className:"relative border rounded p-6 bg-bg-light h-[50vh]",children:[appMetricsLoading&&(0,jsx_runtime.jsx)(lemon_ui_src.t2,{}),!!appMetrics&&(0,jsx_runtime.jsx)("canvas",{ref:canvasRef}),(0,jsx_runtime.jsx)(lemon_ui_src.J2,{visible:tooltipState.visible,overlay:popoverContent,placement:"top",padded:!1,className:"pointer-events-none",children:(0,jsx_runtime.jsx)("div",{className:"fixed",style:{left:tooltipState.x,top:tooltipState.y}})})]})}let PIPELINE_TAB_TO_NODE_STAGE={[types.J9.Transformations]:types.We.Transformation,[types.J9.Destinations]:types.We.Destination,[types.J9.SiteApps]:types.We.SiteApp,[types.J9.ImportApps]:types.We.ImportApp,[types.J9.Sources]:types.We.Source},paramsToProps=_ref=>{let{params:{stage,id}}=_ref,numericId=id&&/^\d+$/.test(id)?parseInt(id):void 0;if(!stage||!id)throw Error("Loaded PipelineNode without either `stage` or `id` passed in");return{stage:PIPELINE_TAB_TO_NODE_STAGE[stage]||null,id:numericId&&!isNaN(numericId)?numericId:id}},scene={component:PipelineNode,logic:pipelineNodeLogic,paramsToProps};function PipelineNode(){let params=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{stage,id}=paramsToProps({params}),{currentTab,node}=(0,index_esm.useValues)(pipelineNodeLogic);if(!stage)return(0,jsx_runtime.jsx)(NotFound.T,{object:"pipeline stage"});let tabToContent=node.backend===pipeline_types.b.ManagedSource?{[types.il.Schemas]:(0,jsx_runtime.jsx)(Schemas,{id:node.id}),[types.il.Syncs]:(0,jsx_runtime.jsx)(Syncs,{id:node.id})}:{[types.il.Configuration]:(0,jsx_runtime.jsx)(PipelineNodeConfiguration,{}),[types.il.Metrics]:node.backend===pipeline_types.b.HogFunction?(0,jsx_runtime.jsx)(PipelineNodeMetricsV2,{}):(0,jsx_runtime.jsx)(PipelineNodeMetrics,{id:id}),[types.il.Logs]:(0,jsx_runtime.jsx)(PipelineNodeLogs,{id:id,stage:stage})};return node.backend===pipeline_types.b.BatchExport&&(tabToContent[types.il.Runs]=(0,jsx_runtime.jsx)(BatchExportRuns,{id:node.id})),node.backend===pipeline_types.b.Plugin&&(tabToContent[types.il.History]=(0,jsx_runtime.jsx)(ActivityLog.D,{id:id,scope:types.jc.PLUGIN})),(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:currentTab,tabs:Object.entries(tabToContent).map(_ref2=>{let[tab,content]=_ref2;return{label:(0,utils.fm)(tab),key:tab,content:content,link:params.stage?urls.j.pipelineNode(stage,id,tab):void 0}})})]})}},"./frontend/src/scenes/pipeline/PipelinePluginConfiguration.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{s:()=>PipelinePluginConfiguration});var posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.7.3_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),NotFound=__webpack_require__("./frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),types=__webpack_require__("./frontend/src/lib/components/TaxonomicFilter/types.ts"),TestAccountFiltersSwitch=__webpack_require__("./frontend/src/lib/components/TestAccountFiltersSwitch.tsx"),LemonField=__webpack_require__("./frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonMarkdown=__webpack_require__("./frontend/src/lib/lemon-ui/LemonMarkdown/index.ts"),CodeEditor=__webpack_require__("./frontend/src/lib/monaco/CodeEditor.tsx"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),AutoSizer=__webpack_require__("./node_modules/.pnpm/react-virtualized@9.22.5_react-dom@18.2.0_react@18.2.0/node_modules/react-virtualized/dist/es/AutoSizer/index.js"),ActionFilter=__webpack_require__("./frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("./frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),configUtils=__webpack_require__("./frontend/src/scenes/pipeline/configUtils.ts"),src_types=__webpack_require__("./frontend/src/types.ts"),kea_loaders_lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),constants=__webpack_require__("./frontend/src/lib/constants.tsx"),featureFlagLogic=__webpack_require__("./frontend/src/lib/logic/featureFlagLogic.ts"),teamLogic=__webpack_require__("./frontend/src/scenes/teamLogic.tsx"),urls=__webpack_require__("./frontend/src/scenes/urls.ts"),destinationsLogic=__webpack_require__("./frontend/src/scenes/pipeline/destinations/destinationsLogic.tsx"),frontendAppsLogic=__webpack_require__("./frontend/src/scenes/pipeline/frontendAppsLogic.tsx"),importAppsLogic=__webpack_require__("./frontend/src/scenes/pipeline/importAppsLogic.tsx"),pipelineAccessLogic=__webpack_require__("./frontend/src/scenes/pipeline/pipelineAccessLogic.tsx"),transformationsLogic=__webpack_require__("./frontend/src/scenes/pipeline/transformationsLogic.tsx");function getConfigurationFromPluginConfig(pluginConfig){return{...pluginConfig.config,filters:pluginConfig.filters,enabled:pluginConfig.enabled,order:pluginConfig.order,name:pluginConfig.name?pluginConfig.name:pluginConfig.plugin_info.name,description:pluginConfig.description?pluginConfig.description:pluginConfig.plugin_info.description||""}}function getDefaultConfiguration(plugin){return{...(0,configUtils.NM)(plugin),enabled:!1,name:plugin.name,description:plugin.description}}let pipelinePluginConfigurationLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{pluginId,pluginConfigId}=_ref;return pluginConfigId?`ID:${pluginConfigId}`:`NEW:${pluginId}`}),(0,index_esm.path)(id=>["scenes","pipeline","pipelinePluginConfigurationLogic",id]),(0,index_esm.connect)(()=>({values:[teamLogic.H,["currentTeamId"],transformationsLogic.P,["nextAvailableOrder"],featureFlagLogic.h,["featureFlags"],pipelineAccessLogic.g,["canEnableNewDestinations"]]})),(0,kea_loaders_lib.loaders)(_ref2=>{let{props,values}=_ref2;return{pluginFromPluginId:[null,{loadPlugin:async()=>props.pluginId?await api.ZP.get(`api/organizations/@current/plugins/${props.pluginId}`):null}],pluginConfig:[null,{loadPluginConfig:async()=>props.pluginConfigId?await api.ZP.pluginConfigs.get(props.pluginConfigId):null,updatePluginConfig:async formdata=>{if(!values.plugin||!props.stage)return null;if((!values.pluginConfig||!values.pluginConfig.enabled&&formdata.enabled)&&props.stage===src_types.We.Destination&&!values.canEnableNewDestinations)return src.UJ.error("Data pipelines add-on is required for enabling new destinations."),values.pluginConfig;let{enabled,order,name,description,...config}=formdata,{filters}=formdata,formData=(0,configUtils.Ge)(values.plugin.config_schema,(0,configUtils.NM)(values.plugin),config);formData.append("enabled",enabled),formData.append("name",name),formData.append("description",description);let sanitizedFilters=function(filters){if(!filters)return null;let sanitized={};return filters.events&&(sanitized.events=filters.events.map(f=>({id:f.id,type:"events",name:f.name,order:f.order,properties:f.properties}))),filters.actions&&(sanitized.actions=filters.actions.map(f=>({id:f.id,type:"actions",name:f.name,order:f.order,properties:f.properties}))),filters.filter_test_accounts&&(sanitized.filter_test_accounts=filters.filter_test_accounts),Object.keys(sanitized).length>0?sanitized:void 0}(filters);filters&&!formData.has("add_attachment[filters]")&&formData.append("filters",sanitizedFilters?JSON.stringify(sanitizedFilters):"");let orderFixed=enabled&&values.pluginConfig&&!values.pluginConfig.enabled?values.nextAvailableOrder:order||0;if(formData.append("order",orderFixed),props.pluginConfigId)return await api.ZP.pluginConfigs.update(props.pluginConfigId,formData);formData.append("plugin",values.plugin.id.toString());let res=await api.ZP.pluginConfigs.create(formData);return kea_router_lib.router.actions.replace(urls.j.pipelineNode(props.stage,res.id,src_types.il.Configuration)),res}}]}}),(0,index_esm.listeners)(_ref3=>{let{props,actions,values}=_ref3;return{updatePluginConfigSuccess:_ref4=>{let{pluginConfig}=_ref4;pluginConfig&&(actions.resetConfiguration(values.configuration),props.stage===src_types.We.Transformation?transformationsLogic.P.findMounted()?.actions.updatePluginConfig(pluginConfig):props.stage===src_types.We.Destination?destinationsLogic.w.findMounted()?.actions.updatePluginConfig(pluginConfig):props.stage===src_types.We.SiteApp?frontendAppsLogic.$.findMounted()?.actions.updatePluginConfig(pluginConfig):props.stage===src_types.We.ImportApp&&importAppsLogic.c.findMounted()?.actions.updatePluginConfig(pluginConfig))}}}),(0,index_esm.reducers)(()=>({configuration:[{},{loadPluginSuccess:(state,_ref5)=>{let{pluginFromPluginId}=_ref5;return Object.keys(state).length>0||!pluginFromPluginId?state:getDefaultConfiguration(pluginFromPluginId)},loadPluginConfigSuccess:(state,_ref6)=>{let{pluginConfig}=_ref6;return pluginConfig?getConfigurationFromPluginConfig(pluginConfig):state},updatePluginConfigSuccess:(state,_ref7)=>{let{pluginConfig}=_ref7;return pluginConfig?getConfigurationFromPluginConfig(pluginConfig):state}}]})),(0,index_esm.selectors)(()=>({plugin:[s=>[s.pluginFromPluginId,s.pluginConfig],(pluginFromId,pluginConfig)=>pluginConfig?.plugin_info||pluginFromId],loading:[s=>[s.pluginFromPluginIdLoading,s.pluginConfigLoading],(pluginLoading,pluginConfigLoading)=>pluginLoading||pluginConfigLoading],savedConfiguration:[s=>[s.pluginConfig,s.plugin],(pluginConfig,plugin)=>pluginConfig&&plugin?pluginConfig?getConfigurationFromPluginConfig(pluginConfig):plugin?getDefaultConfiguration(plugin):void 0:{}],requiredFields:[s=>[s.plugin,s.configuration],(plugin,configuration)=>plugin&&configuration?(0,configUtils.fY)(fieldName=>configuration[fieldName],plugin):[]],hiddenFields:[s=>[s.plugin,s.configuration],(plugin,configuration)=>plugin&&configuration?(0,configUtils.zl)(fieldName=>configuration[fieldName],plugin):[]],isNew:[(_,p)=>[p.pluginConfigId],pluginConfigId=>!pluginConfigId],stage:[(_,p)=>[p.stage],stage=>stage],pluginFilteringEnabled:[s=>[s.featureFlags,s.pluginConfig,s.plugin],(featureFlags,pluginConfig,plugin)=>{let pluginFilteringEnabled=featureFlags[constants.y8.PLUGINS_FILTERING];return(pluginFilteringEnabled||pluginConfig?.filters)&&plugin?.url==="https://github.com/PostHog/legacy-action-webhook"}]})),(0,lib.forms)(_ref8=>{let{asyncActions,values}=_ref8;return{configuration:{errors:formdata=>Object.fromEntries(values.requiredFields.map(field=>[field,formdata[field]?void 0:"This field is required"])),submit:async formdata=>{await asyncActions.updatePluginConfig(formdata)}}}}),(0,kea_router_lib.beforeUnload)(_ref9=>{let{actions,values}=_ref9;return{enabled:()=>values.configurationChanged,message:"Leave action?\nChanges you made will be discarded.",onConfirm:()=>{actions.resetConfiguration()}}}),(0,index_esm.afterMount)(_ref10=>{let{props,actions}=_ref10;props.pluginConfigId?actions.loadPluginConfig():props.pluginId&&actions.loadPlugin()})]);var utils=__webpack_require__("./frontend/src/scenes/pipeline/utils.tsx"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function PipelinePluginConfiguration(_ref){let{stage,pluginId,pluginConfigId}=_ref,logicProps={stage:stage,pluginId:pluginId||null,pluginConfigId:pluginConfigId||null},logic=pipelinePluginConfigurationLogic(logicProps),{plugin,isNew,isConfigurationSubmitting,savedConfiguration,hiddenFields,requiredFields,loading,configurationChanged,pluginFilteringEnabled}=(0,index_esm.useValues)(logic),{submitConfiguration,resetConfiguration}=(0,index_esm.useActions)(logic);if(!stage)return(0,jsx_runtime.jsx)(NotFound.T,{object:"pipeline stage"});if(loading&&!plugin)return(0,jsx_runtime.jsx)(src.t2,{});if(!plugin)return(0,jsx_runtime.jsx)(NotFound.T,{object:`pipeline ${stage}`});let loadingOrSubmitting=loading||isConfigurationSubmitting,configSchemaArray=(0,configUtils.fN)(plugin.config_schema),fields=configSchemaArray.map((fieldConfig,index)=>(0,jsx_runtime.jsx)(react.Fragment,{children:fieldConfig.key&&fieldConfig.type&&(0,configUtils.Zs)(fieldConfig)&&!hiddenFields.includes(fieldConfig.key)?(0,jsx_runtime.jsx)(LemonField.D,{name:fieldConfig.key,label:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[fieldConfig.secret&&(0,jsx_runtime.jsx)(src.u,{placement:"top-start",title:"This field is write-only. Its value won't be visible after saving.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconLock,{})}),fieldConfig.markdown&&(0,jsx_runtime.jsx)(LemonMarkdown.j,{children:fieldConfig.markdown}),fieldConfig.name||fieldConfig.key]}),help:fieldConfig.hint&&(0,jsx_runtime.jsx)(LemonMarkdown.j,{className:"mt-0.5",children:fieldConfig.hint}),showOptional:!requiredFields.includes(fieldConfig.key),children:(0,jsx_runtime.jsx)(PluginField,{fieldConfig:fieldConfig,disabled:loadingOrSubmitting})}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:fieldConfig.type?(0,jsx_runtime.jsxs)("p",{className:"text-danger",children:["Invalid config field ",(0,jsx_runtime.jsx)("i",{children:fieldConfig.name||fieldConfig.key}),"."]}):null})},fieldConfig.key||`__key__${index}`)),buttons=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",htmlType:"reset",onClick:()=>resetConfiguration(savedConfiguration||{}),disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress…":void 0:"No changes",children:"Clear changes"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,children:isNew?"Create":"Save"})]});return(0,jsx_runtime.jsxs)("div",{className:"space-y-3",children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:buttons}),(0,jsx_runtime.jsx)(lib.Form,{logic:pipelinePluginConfigurationLogic,props:logicProps,formKey:"configuration",className:"space-y-3",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-4 items-start",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-4 flex-1 min-w-100",children:[(0,jsx_runtime.jsxs)("div",{className:"border bg-bg-light rounded p-3 space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 min-h-16 items-center",children:[(0,jsx_runtime.jsx)(utils.Wf,{plugin:plugin,imageSize:"medium"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col py-1 flex-1",children:[(0,jsx_runtime.jsx)("div",{className:"flex flex-row items-center font-semibold text-sm gap-1",children:plugin.name}),plugin.description?(0,jsx_runtime.jsx)("div",{className:"text-text-3000 text-xs text-text-secondary-3000 mt-1",children:(0,jsx_runtime.jsx)(LemonMarkdown.j,{className:"max-w-[30rem]",lowKeyHeadings:!0,children:plugin.description})}):null]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"enabled",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.f4,{label:"Enabled",onChange:()=>onChange(!value),checked:value,disabled:loadingOrSubmitting,bordered:!0})}})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",info:"Customising the name can be useful if multiple instances of the same type are used.",children:(0,jsx_runtime.jsx)(src.DF,{type:"text",disabled:loadingOrSubmitting})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"description",label:"Description",info:"Add a description to share context with other team members",children:(0,jsx_runtime.jsx)(src._V,{disabled:loadingOrSubmitting})})]}),pluginFilteringEnabled?(0,jsx_runtime.jsxs)("div",{className:"border bg-bg-light rounded p-3 space-y-2",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:"Filters by events and actions",children:_ref3=>{var _value$filter_test_ac;let{value,onChange}=_ref3;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:null!==(_value$filter_test_ac=value?.filter_test_accounts)&&void 0!==_value$filter_test_ac&&_value$filter_test_ac,onChange:val=>onChange({...value,filter_test_accounts:val}),fullWidth:!0}),(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:null!=value?value:{},setFilters:payload=>{onChange({...payload,filter_test_accounts:value?.filter_test_accounts})},typeKey:"plugin-filters",mathAvailability:ActionFilterRow.Qq.None,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:[types.t.Events,types.t.Actions],propertiesTaxonomicGroupTypes:[types.t.EventProperties,types.t.EventFeatureFlags,types.t.Elements,types.t.PersonProperties],propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:src_types.DC.EVENTS},buttonCopy:"Add event filter"})]})}}),(0,jsx_runtime.jsxs)("p",{className:"italic text-muted-alt",children:["This destination will be triggered if ",(0,jsx_runtime.jsx)("b",{children:"any of"})," the above filters match."]})]}):null]}),(0,jsx_runtime.jsxs)("div",{className:"flex-2 min-w-100 space-y-4",children:[(0,jsx_runtime.jsx)("div",{className:"border bg-bg-light rounded p-3  space-y-2",children:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:fields.length?fields:(0,jsx_runtime.jsx)("span",{className:"italic text-muted-alt",children:"This app does not have specific configuration options"})})}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-end",children:buttons})]})]})})]})}function PluginField(_ref4){let{value,onChange,fieldConfig,disabled}=_ref4,[editingSecret,setEditingSecret]=(0,react.useState)(!1);return fieldConfig.secret&&!editingSecret&&value&&(value===configUtils.ue||value.name===configUtils.ue)?(0,jsx_runtime.jsxs)(src.Jp,{type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{}),onClick:()=>{onChange?.(fieldConfig.default||""),setEditingSecret(!0)},disabled:disabled,children:["Reset secret ","attachment"===fieldConfig.type?"attachment":"field"]}):"attachment"===fieldConfig.type?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[value?.name?(0,jsx_runtime.jsxs)("span",{children:["Selected file: ",value.name]}):null,(0,jsx_runtime.jsx)(src.mH,{accept:"*",multiple:!1,onChange:files=>onChange?.(files[0]),value:value?.size?[value]:[],showUploadedFiles:!1})]}):"string"===fieldConfig.type?(0,jsx_runtime.jsx)(src.DF,{value:value,onChange:onChange,autoFocus:editingSecret,className:"ph-no-capture",disabled:disabled}):"json"===fieldConfig.type?(0,jsx_runtime.jsx)(JsonConfigField,{value:value,onChange:onChange,autoFocus:editingSecret,className:"ph-no-capture"}):"choice"===fieldConfig.type?(0,jsx_runtime.jsx)(src.Yv,{fullWidth:!0,value:value,className:"ph-no-capture",onChange:onChange,options:fieldConfig.choices.map(choice=>({label:choice,value:choice})),disabled:disabled}):(0,jsx_runtime.jsxs)("strong",{className:"text-danger",children:['Unknown field type "',(0,jsx_runtime.jsx)("code",{children:fieldConfig.type}),'".',(0,jsx_runtime.jsx)("br",{}),"You may need to upgrade PostHog!"]})}function JsonConfigField(props){return(0,jsx_runtime.jsx)(AutoSizer.q,{disableWidth:!0,className:"min-h-60",children:_ref5=>{let{height}=_ref5;return(0,jsx_runtime.jsx)(CodeEditor.p,{className:"border",language:"json",value:props.value,onChange:v=>props.onChange?.(null!=v?v:""),height:height,options:{minimap:{enabled:!1}}})}})}},"./frontend/src/scenes/pipeline/frontendAppsLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{$:()=>frontendAppsLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./frontend/src/lib/api.ts"),scenes_teamLogic__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./frontend/src/scenes/teamLogic.tsx"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/types.ts"),_types__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/scenes/pipeline/types.ts"),_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/scenes/pipeline/utils.tsx");let frontendAppsLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","pipeline","frontendAppsLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)({values:[scenes_teamLogic__WEBPACK_IMPORTED_MODULE_3__.H,["currentTeamId"],scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__.userLogic,["user"]]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({loadPluginConfigs:!0,updatePluginConfig:pluginConfig=>({pluginConfig})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref=>{let{values}=_ref;return{plugins:[{},{loadPlugins:async()=>(0,_utils__WEBPACK_IMPORTED_MODULE_7__.c$)("api/organizations/@current/pipeline_frontend_apps")}],pluginConfigs:[{},{loadPluginConfigs:async()=>{let res=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.loadPaginatedResults(`api/projects/${values.currentTeamId}/pipeline_frontend_apps_configs`);return Object.fromEntries(res.map(pluginConfig=>[pluginConfig.id,pluginConfig]))},toggleEnabled:async _ref2=>{let{id,enabled}=_ref2;if(!(0,_utils__WEBPACK_IMPORTED_MODULE_7__.FH)(_types__WEBPACK_IMPORTED_MODULE_5__.We.SiteApp,enabled))return values.pluginConfigs;let{pluginConfigs,plugins}=values,pluginConfig=pluginConfigs[id],plugin=plugins[pluginConfig.plugin];(0,_utils__WEBPACK_IMPORTED_MODULE_7__.SO)(`plugin ${enabled?"enabled":"disabled"}`,plugin,pluginConfig);let response=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.update(`api/plugin_config/${id}`,{enabled});return{...pluginConfigs,[id]:response}},updatePluginConfig:_ref3=>{let{pluginConfig}=_ref3;return{...values.pluginConfigs,[pluginConfig.id]:pluginConfig}}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({loading:[s=>[s.pluginsLoading,s.pluginConfigsLoading],(pluginsLoading,pluginConfigsLoading)=>pluginsLoading||pluginConfigsLoading],frontendApps:[s=>[s.plugins,s.pluginConfigs],(plugins,pluginConfigs)=>{let rawFrontendApp=Object.values(pluginConfigs).map(pluginConfig=>({...pluginConfig,plugin_info:plugins[pluginConfig.plugin]||null})),convertedFrontendApps=rawFrontendApp.map(t=>(0,_types__WEBPACK_IMPORTED_MODULE_6__.n)(t,_types__WEBPACK_IMPORTED_MODULE_5__.We.SiteApp)),enabledFirst=convertedFrontendApps.sort((a,b)=>Number(b.enabled)-Number(a.enabled));return enabledFirst}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref4=>{let{actions}=_ref4;actions.loadPlugins(),actions.loadPluginConfigs()})])},"./frontend/src/scenes/pipeline/hogfunctions/HogFunctionConfiguration.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{g:()=>HogFunctionConfiguration});var posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.7.3_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),NotFound=__webpack_require__("./frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),PayGateMini=__webpack_require__("./frontend/src/lib/components/PayGateMini/PayGateMini.tsx"),Sparkline=__webpack_require__("./frontend/src/lib/components/Sparkline.tsx"),types=__webpack_require__("./frontend/src/lib/components/TaxonomicFilter/types.ts"),TestAccountFiltersSwitch=__webpack_require__("./frontend/src/lib/components/TestAccountFiltersSwitch.tsx"),useFeatureFlag=__webpack_require__("./frontend/src/lib/hooks/useFeatureFlag.ts"),More=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/More.tsx"),LemonField=__webpack_require__("./frontend/src/lib/lemon-ui/LemonField/index.ts"),CodeEditorResizable=__webpack_require__("./frontend/src/lib/monaco/CodeEditorResizable.tsx"),ActionFilter=__webpack_require__("./frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("./frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),groupsModel=__webpack_require__("./frontend/src/models/groupsModel.ts"),src_types=__webpack_require__("./frontend/src/types.ts"),fast_deep_equal=__webpack_require__("./node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"),fast_deep_equal_default=__webpack_require__.n(fast_deep_equal),kea_loaders_lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),kea_subscriptions_lib=__webpack_require__("./node_modules/.pnpm/kea-subscriptions@3.0.1_kea@3.1.5/node_modules/kea-subscriptions/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),dayjs=__webpack_require__("./frontend/src/lib/dayjs.ts"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),deleteWithUndo=__webpack_require__("./frontend/src/lib/utils/deleteWithUndo.tsx"),dist_module=__webpack_require__("./node_modules/.pnpm/posthog-js@1.154.3/node_modules/posthog-js/dist/module.js"),teamLogic=__webpack_require__("./frontend/src/scenes/teamLogic.tsx"),urls=__webpack_require__("./frontend/src/scenes/urls.ts"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts"),query=__webpack_require__("./frontend/src/queries/query.ts"),schema=__webpack_require__("./frontend/src/queries/schema.ts"),queries_utils=__webpack_require__("./frontend/src/queries/utils.ts");let NEW_FUNCTION_TEMPLATE={id:"new",name:"",description:"",inputs_schema:[],hog:"print('Hello, world!');",status:"stable"};function sanitizeConfiguration(data){let sanitizedInputs={};data.inputs_schema?.forEach(input=>{let value=data.inputs?.[input.key]?.value,secret=data.inputs?.[input.key]?.secret;if(secret){sanitizedInputs[input.key]={value:"********",secret:!0};return}if("json"===input.type&&"string"==typeof value){try{sanitizedInputs[input.key]={value:JSON.parse(value)}}catch(e){}return}sanitizedInputs[input.key]={value:value}});let payload={...data,filters:data.filters?function(filters){if(!filters)return null;let sanitized={};return filters.events&&(sanitized.events=filters.events.map(f=>({id:f.id,type:"events",name:f.name,order:f.order,properties:f.properties}))),filters.actions&&(sanitized.actions=filters.actions.map(f=>({id:f.id,type:"actions",name:f.name,order:f.order,properties:f.properties}))),filters.filter_test_accounts&&(sanitized.filter_test_accounts=filters.filter_test_accounts),Object.keys(sanitized).length>0?sanitized:void 0}(data.filters):null,inputs:sanitizedInputs,icon_url:data.icon_url?.replace("&temp=true","")};return payload}let hogFunctionConfigurationLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{var _ref2;let{id,templateId}=_ref;return null!==(_ref2=null!=id?id:templateId)&&void 0!==_ref2?_ref2:"new"}),(0,index_esm.connect)({values:[teamLogic.H,["currentTeam"],groupsModel.$,["groupTypes"],userLogic.userLogic,["hasAvailableFeature"]]}),(0,index_esm.path)(id=>["scenes","pipeline","hogFunctionConfigurationLogic",id]),(0,index_esm.actions)({setShowSource:showSource=>({showSource}),resetForm:configuration=>({configuration}),upsertHogFunction:configuration=>({configuration}),duplicate:!0,duplicateFromTemplate:!0,resetToTemplate:function(){let keepInputs=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return{keepInputs}},deleteHogFunction:!0,sparklineQueryChanged:sparklineQuery=>({sparklineQuery})}),(0,index_esm.reducers)({showSource:[!1,{setShowSource:(_,_ref3)=>{let{showSource}=_ref3;return showSource}}],hasHadSubmissionErrors:[!1,{upsertHogFunctionFailure:()=>!0}]}),(0,kea_loaders_lib.loaders)(_ref4=>{let{props,values}=_ref4;return{template:[null,{loadTemplate:async()=>{if(!props.templateId)return null;if("new"===props.templateId)return{...NEW_FUNCTION_TEMPLATE};let res=await api.ZP.hogFunctions.getTemplate(props.templateId);if(!res)throw Error("Template not found");return res}}],hogFunction:[null,{loadHogFunction:async()=>props.id?await api.ZP.hogFunctions.get(props.id):null,upsertHogFunction:async _ref5=>{let{configuration}=_ref5,res=props.id?await api.ZP.hogFunctions.update(props.id,configuration):await api.ZP.hogFunctions.create(configuration);return dist_module.ZP.capture("hog function saved",{id:res.id,template_id:res.template?.id,template_name:res.template?.name}),src.UJ.success("Configuration saved"),res}}],sparkline:[null,{sparklineQueryChanged:async(_ref6,breakpoint)=>{var _result$results$0$dat;let{sparklineQuery}=_ref6;null===values.sparkline?await breakpoint(100):await breakpoint(1e3);let result=await (0,query.jr)(sparklineQuery);breakpoint();let dataValues=null!==(_result$results$0$dat=result?.results?.[0]?.data)&&void 0!==_result$results$0$dat?_result$results$0$dat:[],[underThreshold,overThreshold]=dataValues.reduce((acc,val)=>(acc[0].push(Math.min(val,1e3)),acc[1].push(Math.max(0,val-1e3)),acc),[[],[]]),count=result?.results?.[0]?.count,labels=result?.results?.[0]?.labels;return{data:[{name:"Low volume",values:underThreshold,color:"success"},{name:"High volume",values:overThreshold,color:"warning"}],count,labels}}}]}}),(0,lib.forms)(_ref7=>{let{values,props,asyncActions}=_ref7;return{configuration:{defaults:{},alwaysShowErrors:!0,errors:data=>({name:data.name?void 0:"Name is required",...values.inputFormErrors}),submit:async data=>{let payload=sanitizeConfiguration(data);payload.template_id=props.templateId||values.hogFunction?.template?.id,values.hasAddon||(delete payload.hog,delete payload.inputs_schema),await asyncActions.upsertHogFunction(payload)}}}}),(0,index_esm.selectors)(()=>({hasAddon:[s=>[s.hasAvailableFeature],hasAvailableFeature=>hasAvailableFeature(src_types.P$.DATA_PIPELINES)],showPaygate:[s=>[s.template,s.hasAddon],(template,hasAddon)=>template&&"free"!==template.status&&!hasAddon],defaultFormState:[s=>[s.template,s.hogFunction],(template,hogFunction)=>{if(template){let inputs={};return template.inputs_schema?.forEach(schema=>{schema.default&&(inputs[schema.key]={value:schema.default})}),{...template,inputs,enabled:!1}}return hogFunction||{}}],loading:[s=>[s.hogFunctionLoading,s.templateLoading],(hogFunctionLoading,templateLoading)=>hogFunctionLoading||templateLoading],loaded:[s=>[s.hogFunction,s.template],(hogFunction,template)=>!!hogFunction||!!template],inputFormErrors:[s=>[s.configuration],configuration=>{var _configuration$inputs;let inputs=null!==(_configuration$inputs=configuration.inputs)&&void 0!==_configuration$inputs?_configuration$inputs:{},inputErrors={};return configuration.inputs_schema?.forEach(input=>{let key=input.key,value=inputs[key]?.value;if(!inputs[key]?.secret&&(input.required&&(null==value||""===value)&&(inputErrors[key]="This field is required"),"json"===input.type&&"string"==typeof value))try{JSON.parse(value)}catch(e){inputErrors[key]="Invalid JSON"}}),Object.keys(inputErrors).length>0?{inputs:inputErrors}:null}],willReEnableOnSave:[s=>[s.configuration,s.hogFunction],(configuration,hogFunction)=>{var _hogFunction$status$s;return configuration?.enabled&&(null!==(_hogFunction$status$s=hogFunction?.status?.state)&&void 0!==_hogFunction$status$s?_hogFunction$status$s:0)>=3}],exampleInvocationGlobals:[s=>[s.configuration,s.currentTeam,s.groupTypes],(configuration,currentTeam,groupTypes)=>{var _configuration$name;let currentUrl=window.location.href.split("#")[0],globals={event:{uuid:(0,utils.Vj)(),distinct_id:(0,utils.Vj)(),name:"$pageview",timestamp:(0,dayjs.Bv)().toISOString(),url:`${window.location.origin}/project/${currentTeam?.id}/events/`,properties:{$current_url:currentUrl,$browser:"Chrome"}},person:{uuid:(0,utils.Vj)(),name:"Example person",url:`${window.location.origin}/person/${(0,utils.Vj)()}`,properties:{email:"example@posthog.com"}},groups:{},project:{id:currentTeam?.id||0,name:currentTeam?.name||"",url:`${window.location.origin}/project/${currentTeam?.id}`},source:{name:null!==(_configuration$name=configuration?.name)&&void 0!==_configuration$name?_configuration$name:"Unnamed",url:currentUrl}};return groupTypes.forEach(groupType=>{globals.groups[groupType.group_type]={id:(0,utils.Vj)(),type:groupType.group_type,index:groupType.group_type_index,url:`${window.location.origin}/groups/${groupType.group_type_index}/groups/${encodeURIComponent(groupType.group_type_index)}`,properties:{}}}),globals}],exampleInvocationGlobalsWithInputs:[s=>[s.exampleInvocationGlobals,s.configuration],(exampleInvocationGlobals,configuration)=>{let inputs={};for(let input of configuration?.inputs_schema||[])inputs[input.key]=input.type;return{...exampleInvocationGlobals,inputs}}],sparklineQuery:[s=>[s.configuration],configuration=>{var _configuration$filter,_event$properties,_configuration$filter2,_action$properties;let properties={type:src_types.J2.Or,values:[]};for(let event of null!==(_configuration$filter=configuration.filters?.events)&&void 0!==_configuration$filter?_configuration$filter:[]){let eventProperties=[...null!==(_event$properties=event.properties)&&void 0!==_event$properties?_event$properties:[]];event.id&&eventProperties.push({type:src_types.FT.HogQL,key:(0,queries_utils.zP)`event = ${event.id}`}),0===eventProperties.length&&eventProperties.push({type:src_types.FT.HogQL,key:"true"}),properties.values.push({type:src_types.J2.And,values:eventProperties})}for(let action of null!==(_configuration$filter2=configuration.filters?.actions)&&void 0!==_configuration$filter2?_configuration$filter2:[]){let actionProperties=[...null!==(_action$properties=action.properties)&&void 0!==_action$properties?_action$properties:[]];action.id&&actionProperties.push({type:src_types.FT.HogQL,key:(0,queries_utils.zP)`matchesAction(${parseInt(action.id)})`}),properties.values.push({type:src_types.J2.And,values:actionProperties})}return{kind:schema.OH.TrendsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,series:[{kind:schema.OH.EventsNode,event:null,name:"All Events",math:src_types.vN.TotalCount}],properties,interval:"day",dateRange:{date_from:"-7d"},trendsFilter:{display:src_types.Qb.ActionsBar}}},{resultEqualityCheck:fast_deep_equal_default()}]})),(0,index_esm.listeners)(_ref8=>{let{actions,values,cache}=_ref8;return{loadTemplateSuccess:()=>actions.resetForm(),loadHogFunctionSuccess:()=>actions.resetForm(),upsertHogFunctionSuccess:()=>actions.resetForm(),upsertHogFunctionFailure:_ref9=>{let{errorObject}=_ref9,maybeValidationError=errorObject.data;maybeValidationError?.type==="validation_error"?setTimeout(()=>{maybeValidationError.attr.includes("inputs__")?actions.setConfigurationManualErrors({inputs:{[maybeValidationError.attr.split("__")[1]]:maybeValidationError.detail}}):actions.setConfigurationManualErrors({[maybeValidationError.attr]:maybeValidationError.detail})},1):(console.error(errorObject),src.UJ.error("Error submitting configuration"))},resetForm:()=>{var _cache$paramsFromUrl;let config={...values.defaultFormState,...cache.configFromUrl||{}},paramsFromUrl=null!==(_cache$paramsFromUrl=cache.paramsFromUrl)&&void 0!==_cache$paramsFromUrl?_cache$paramsFromUrl:{};paramsFromUrl.integration_target&&paramsFromUrl.integration_id&&(config.inputs[paramsFromUrl.integration_target]={value:paramsFromUrl.integration_id}),actions.resetConfiguration(config)},duplicate:async()=>{if(values.hogFunction){var _values$hogFunction$t;let newConfig={...values.configuration,name:`${values.configuration.name} (copy)`},originalTemplate=null!==(_values$hogFunction$t=values.hogFunction.template?.id)&&void 0!==_values$hogFunction$t?_values$hogFunction$t:"new";kea_router_lib.router.actions.push(urls.j.pipelineNodeNew(src_types.We.Destination,`hog-${originalTemplate}`),void 0,{configuration:newConfig})}},duplicateFromTemplate:async()=>{if(values.hogFunction?.template){let newConfig={...values.hogFunction.template};kea_router_lib.router.actions.push(urls.j.pipelineNodeNew(src_types.We.Destination,`hog-${values.hogFunction.template.id}`),void 0,{configuration:newConfig})}},resetToTemplate:async _ref10=>{let{keepInputs}=_ref10;if(values.hogFunction?.template){var _values$configuration;let template=values.hogFunction.template,inputs={};template.inputs_schema?.forEach(schema=>{var _ref11;inputs[schema.key]=null!==(_ref11=keepInputs?values.configuration.inputs?.[schema.key]:void 0)&&void 0!==_ref11?_ref11:{value:schema.default}}),actions.setConfigurationValues({...values.hogFunction.template,filters:null!==(_values$configuration=values.configuration.filters)&&void 0!==_values$configuration?_values$configuration:template.filters,name:values.configuration.name,description:values.configuration.description,inputs,enabled:!1})}},setConfigurationValue:()=>{values.hasHadSubmissionErrors&&actions.setConfigurationManualErrors({})},deleteHogFunction:async()=>{if(!values.hogFunction)return;let{id,name}=values.hogFunction;await (0,deleteWithUndo.S)({endpoint:`projects/${teamLogic.H.values.currentTeamId}/hog_functions`,object:{id,name},callback(undo){undo&&kea_router_lib.router.actions.replace(urls.j.pipelineNode(src_types.We.Destination,`hog-${id}`,src_types.il.Configuration))}}),kea_router_lib.router.actions.replace(urls.j.pipeline(src_types.J9.Destinations))}}}),(0,index_esm.afterMount)(_ref12=>{let{props,actions,cache}=_ref12;cache.paramsFromUrl={integration_id:kea_router_lib.router.values.searchParams.integration_id,integration_target:kea_router_lib.router.values.searchParams.integration_target},props.templateId?(cache.configFromUrl=kea_router_lib.router.values.hashParams.configuration,actions.loadTemplate()):props.id&&actions.loadHogFunction(),kea_router_lib.router.values.searchParams.integration_target&&kea_router_lib.router.actions.replace(kea_router_lib.router.values.location.pathname,void 0,kea_router_lib.router.values.hashParams)}),(0,kea_subscriptions_lib.Vt)(_ref13=>{let{props,cache,actions}=_ref13;return{configuration:configuration=>{Object.keys(configuration).length&&props.templateId&&(cache.ignoreUrlChange=!0,kea_router_lib.router.actions.replace(kea_router_lib.router.values.location.pathname,void 0,{configuration}))},hogFunction:hogFunction=>{hogFunction&&props.templateId&&kea_router_lib.router.actions.replace(urls.j.pipelineNode(src_types.We.Destination,`hog-${hogFunction.id}`,src_types.il.Configuration))},sparklineQuery:async sparklineQuery=>{actions.sparklineQueryChanged(sparklineQuery)}}})]);var HogFunctionIcon=__webpack_require__("./frontend/src/scenes/pipeline/hogfunctions/HogFunctionIcon.tsx"),core_esm=__webpack_require__("./node_modules/.pnpm/@dnd-kit+core@6.0.8_react-dom@18.2.0_react@18.2.0/node_modules/@dnd-kit/core/dist/core.esm.js"),sortable_esm=__webpack_require__("./node_modules/.pnpm/@dnd-kit+sortable@7.0.2_@dnd-kit+core@6.0.8_react@18.2.0/node_modules/@dnd-kit/sortable/dist/sortable.esm.js"),utilities_esm=__webpack_require__("./node_modules/.pnpm/@dnd-kit+utilities@3.2.1_react@18.2.0/node_modules/@dnd-kit/utilities/dist/utilities.esm.js"),CodeEditorInline=__webpack_require__("./frontend/src/lib/monaco/CodeEditorInline.tsx"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),integrationsLogic=__webpack_require__("./frontend/src/lib/integrations/integrationsLogic.ts"),IntegrationView=__webpack_require__("./frontend/src/lib/integrations/IntegrationView.tsx"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function HogFunctionInputIntegration(_ref){let{schema,...props}=_ref;return(0,jsx_runtime.jsx)(HogFunctionIntegrationChoice,{...props,schema:schema})}function HogFunctionIntegrationChoice(_ref2){let{onChange,value,schema}=_ref2,{integrationsLoading,integrations}=(0,index_esm.useValues)(integrationsLogic.a),kind=schema.integration,integrationsOfKind=integrations?.filter(x=>x.kind===kind),integration=integrationsOfKind?.find(integration=>integration.id===value);if(!kind)return null;if(integrationsLoading)return(0,jsx_runtime.jsx)(src.yW,{className:"h-10"});let button=(0,jsx_runtime.jsx)(src.d6,{items:[integrationsOfKind?.length?{items:[...integrationsOfKind?.map(integration=>({icon:jsx_runtime.jsx("img",{src:integration.icon_url,className:"w-6 h-6 rounded"}),onClick:()=>onChange?.(integration.id),active:integration.id===value,label:integration.display_name}))||[]]}:null,{items:[{to:api.ZP.integrations.authorizeUrl({kind,next:`${window.location.pathname}?integration_target=${schema.key}`}),disableClientSideRouting:!0,label:integrationsOfKind?.length?`Connect to a different ${kind} integration`:`Connect to ${kind}`}]},{items:[{to:urls.j.settings("project-integrations"),label:"Manage integrations",sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconExternal,{})},value?{onClick:()=>onChange?.(null),label:"Clear",sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{})}:null]}],children:integration?(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",children:"Change"}):(0,jsx_runtime.jsxs)(src.Jp,{type:"secondary",children:["Choose ",(0,utils.fm)(kind)," connection"]})});return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:integration?(0,jsx_runtime.jsx)(IntegrationView.K,{integration:integration,suffix:button}):button})}var SlackIntegrationHelpers=__webpack_require__("./frontend/src/lib/integrations/SlackIntegrationHelpers.tsx");function HogFunctionInputIntegrationField(_ref){let{schema,value,onChange}=_ref,{configuration}=(0,index_esm.useValues)(hogFunctionConfigurationLogic),{integrationsLoading,integrations}=(0,index_esm.useValues)(integrationsLogic.a);if(integrationsLoading)return(0,jsx_runtime.jsx)(src.yW,{className:"h-10"});let relatedSchemaIntegration=configuration.inputs_schema?.find(input=>input.key===schema.integration_key);if(!relatedSchemaIntegration)return(0,jsx_runtime.jsxs)("div",{className:"text-danger",children:["Bad configuration: integration key ",schema.integration_key," not found in schema"]});let integrationId=configuration.inputs?.[relatedSchemaIntegration.key]?.value,integration=integrations?.find(integration=>integration.id===integrationId);return integration?"slack_channel"===schema.integration_field?(0,jsx_runtime.jsx)(SlackIntegrationHelpers.a,{value:value,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):(0,jsx_runtime.jsx)("div",{className:"text-danger",children:(0,jsx_runtime.jsxs)("p",{children:["Unsupported integration type: ",schema.integration]})}):(0,jsx_runtime.jsxs)("div",{className:"border border-dashed h-10 rounded p-2 text-muted-alt italic",children:["Configure ",relatedSchemaIntegration.label," to continue"]})}let typeList=["string","boolean","dictionary","choice","json","integration"];function JsonConfigField(props){let{exampleInvocationGlobalsWithInputs}=(0,index_esm.useValues)(hogFunctionConfigurationLogic);return(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"hogJson",value:"string"!=typeof props.value?JSON.stringify(props.value,null,2):props.value,onChange:v=>props.onChange?.(null!=v?v:""),options:{lineNumbers:"off",minimap:{enabled:!1},scrollbar:{vertical:"hidden",verticalScrollbarSize:0}},globals:exampleInvocationGlobalsWithInputs})}function HogFunctionTemplateInput(props){let{exampleInvocationGlobalsWithInputs}=(0,index_esm.useValues)(hogFunctionConfigurationLogic);return(0,jsx_runtime.jsx)(CodeEditorInline.s,{...props,globals:exampleInvocationGlobalsWithInputs})}function DictionaryField(_ref){let{onChange,value}=_ref,[entries,setEntries]=(0,react.useState)(Object.entries(null!=value?value:{}));return(0,react.useEffect)(()=>{let val=Object.fromEntries(entries.filter(_ref2=>{let[key,val]=_ref2;return""!==key.trim()||""!==val.trim()}));onChange?.(val)},[entries]),(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[entries.map((_ref3,index)=>{let[key,val]=_ref3;return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.DF,{value:key,className:"flex-1 min-w-60",onChange:key=>{let newEntries=[...entries];newEntries[index]=[key,newEntries[index][1]],setEntries(newEntries)},placeholder:"Key"}),(0,jsx_runtime.jsx)(HogFunctionTemplateInput,{className:"flex-2 overflow-hidden",value:val,language:"hogTemplate",onChange:val=>{let newEntries=[...entries];newEntries[index]=[newEntries[index][0],null!=val?val:""],setEntries(newEntries)}}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),size:"small",onClick:()=>{let newEntries=[...entries];newEntries.splice(index,1),setEntries(newEntries)}})]},index)}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),size:"small",type:"secondary",onClick:()=>{setEntries([...entries,["",""]])},children:"Add entry"})]})}function HogFunctionInputRenderer(_ref4){var _schema$choices;let{value,onChange,schema,disabled}=_ref4;switch(schema.type){case"string":return(0,jsx_runtime.jsx)(HogFunctionTemplateInput,{language:"hogTemplate",value:value,onChange:disabled?()=>{}:onChange,className:"ph-no-capture"});case"json":return(0,jsx_runtime.jsx)(JsonConfigField,{value:value,onChange:onChange,className:"ph-no-capture"});case"choice":return(0,jsx_runtime.jsx)(src.Yv,{fullWidth:!0,value:value,className:"ph-no-capture",onChange:onChange,options:null!==(_schema$choices=schema.choices)&&void 0!==_schema$choices?_schema$choices:[],disabled:disabled});case"dictionary":return(0,jsx_runtime.jsx)(DictionaryField,{value:value,onChange:onChange});case"boolean":return(0,jsx_runtime.jsx)(src.f4,{checked:value,onChange:checked=>onChange?.(checked),disabled:disabled});case"integration":return(0,jsx_runtime.jsx)(HogFunctionInputIntegration,{schema:schema,value:value,onChange:onChange});case"integration_field":return(0,jsx_runtime.jsx)(HogFunctionInputIntegrationField,{schema:schema,value:value,onChange:onChange});default:return(0,jsx_runtime.jsxs)("strong",{className:"text-danger",children:['Unknown field type "',(0,jsx_runtime.jsx)("code",{children:schema.type}),'".']})}}function HogFunctionInputSchemaControls(_ref5){let{value,onChange,onDone}=_ref5,_onChange=data=>{onChange(data?{...value,...data}:null)},[localVariableValue,setLocalVariableValue]=(0,react.useState)(value.key);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 flex items-center gap-2 flex-wrap",children:[(0,jsx_runtime.jsx)(src.Yv,{size:"small",options:typeList.map(type=>({label:(0,utils.fm)(type),value:type})),value:value.type,className:"w-30",onChange:type=>_onChange({type})}),(0,jsx_runtime.jsx)(src.Hw,{size:"small",checked:value.required,onChange:required=>_onChange({required}),label:"Required",bordered:!0}),(0,jsx_runtime.jsx)(src.Hw,{size:"small",checked:value.secret,onChange:secret=>_onChange({secret}),label:"Secret",bordered:!0}),(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconTrash,{}),size:"small",onClick:()=>onChange(null)}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>onDone(),children:"Done"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex-1 flex gap-2 flex-wrap",children:[(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Display label",children:(0,jsx_runtime.jsx)(src.DF,{className:"min-w-60",size:"small",value:value.label,onChange:label=>_onChange({label}),placeholder:"Display label"})}),(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Input variable name",children:(0,jsx_runtime.jsx)(src.DF,{size:"small",value:localVariableValue,onChange:key=>setLocalVariableValue(key),onBlur:()=>_onChange({key:localVariableValue}),placeholder:"Variable name"})})]}),(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Description",children:(0,jsx_runtime.jsx)(src._V,{minRows:1,value:value.description,onChange:description=>_onChange({description}),placeholder:"Description"})}),"choice"===value.type&&(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Choices",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,value:value.choices?.map(choice=>choice.value),onChange:choices=>_onChange({choices:choices.map(value=>({label:value,value}))}),placeholder:"Choices"})}),"integration"===value.type&&(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Integration kind",children:(0,jsx_runtime.jsx)(src.Yv,{value:value.integration,onChange:integration=>_onChange({integration}),options:[{label:"Slack",value:"slack"},{label:"Salesforce",value:"salesforce"},{label:"Hubspot",value:"hubspot"}],placeholder:"Choose kind"})}),(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Default value",children:(0,jsx_runtime.jsx)(HogFunctionInputRenderer,{schema:value,value:value.default,onChange:val=>_onChange({default:val})})})]})}function HogFunctionInputWithSchema(_ref6){let{schema}=_ref6,{attributes,listeners,setNodeRef,transform,transition}=(0,sortable_esm.nB)({id:schema.key}),{showSource,configuration}=(0,index_esm.useValues)(hogFunctionConfigurationLogic),{setConfigurationValue}=(0,index_esm.useActions)(hogFunctionConfigurationLogic),[editing,setEditing]=(0,react.useState)(showSource),value=configuration.inputs?.[schema.key];return(0,react.useEffect)(()=>{showSource||setEditing(!1)},[showSource]),(0,jsx_runtime.jsx)("div",{ref:setNodeRef,style:{transform:utilities_esm.ux.Transform.toString(transform),transition},children:editing?(0,jsx_runtime.jsx)("div",{className:"border rounded p-2 border-dashed space-y-4",children:(0,jsx_runtime.jsx)(HogFunctionInputSchemaControls,{value:schema,onChange:newSchema=>{let inputsSchema=configuration.inputs_schema||[];if(newSchema){let modifiedSchema={...schema,...newSchema};inputsSchema=inputsSchema.map(s=>s.key===schema.key?modifiedSchema:s)}else inputsSchema=inputsSchema.filter(s=>s.key!==schema.key);newSchema?.key&&setConfigurationValue(`inputs.${newSchema.key}`,value),newSchema?.type&&newSchema.type!==schema.type&&setConfigurationValue(`inputs.${schema.key}`,null),setConfigurationValue("inputs_schema",inputsSchema)},onDone:()=>setEditing(!1)})}):(0,jsx_runtime.jsx)(LemonField.D,{name:`inputs.${schema.key}`,help:schema.description,children:_ref7=>{let{value,onChange}=_ref7;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsxs)(src.HQ,{className:showSource?"cursor-grab":"",showOptional:!schema.required,...attributes,...listeners,children:[schema.label||schema.key,schema.secret?(0,jsx_runtime.jsx)(src.u,{title:"This input is marked as secret. It will be encrypted and not visible after saving.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconLock,{})}):void 0]}),showSource?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)(src.oe,{type:"muted",className:"font-mono",children:["inputs.",schema.key]}),(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",noPadding:!0,icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGear,{}),onClick:()=>setEditing(!0)})]}):null]}),value?.secret?(0,jsx_runtime.jsxs)("div",{className:"border border-dashed rounded p-1 flex gap-2 items-center",children:[(0,jsx_runtime.jsx)("span",{className:"flex-1 text-muted-alt italic p-1",children:"This value is secret and is not displayed here."}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{onChange({value:void 0})},size:"small",type:"secondary",children:"Edit"})]}):(0,jsx_runtime.jsx)(HogFunctionInputRenderer,{schema:schema,value:value?.value,onChange:val=>onChange({value:val})})]})}})})}function HogFunctionInputs(){let{showSource,configuration}=(0,index_esm.useValues)(hogFunctionConfigurationLogic),{setConfigurationValue}=(0,index_esm.useActions)(hogFunctionConfigurationLogic);if(!configuration?.inputs_schema?.length)return(0,jsx_runtime.jsx)("span",{className:"italic text-muted-alt",children:"This function does not require any input variables."});let inputSchemas=configuration.inputs_schema,inputSchemaIds=inputSchemas.map(schema=>schema.key);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(core_esm.LB,{collisionDetection:core_esm.pE,onDragEnd:_ref8=>{let{active,over}=_ref8;if(over&&active.id!==over.id){let oldIndex=inputSchemaIds.indexOf(active.id),newIndex=inputSchemaIds.indexOf(over.id);setConfigurationValue("inputs_schema",(0,sortable_esm.Rp)(inputSchemas,oldIndex,newIndex))}},children:(0,jsx_runtime.jsx)(sortable_esm.Fo,{disabled:!showSource,items:inputSchemaIds,strategy:sortable_esm.qw,children:configuration.inputs_schema?.map(schema=>jsx_runtime.jsx(HogFunctionInputWithSchema,{schema:schema},schema.key))})})})}var apps_common_src=__webpack_require__("./frontend/@posthog/apps-common/src/index.ts");let displayMap={[src_types.si.healthy]:{tagType:"success",display:"Healthy",description:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The function is running as expected."})},[src_types.si.overflowed]:{tagType:"caution",display:"Degraded",description:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The function is running slow or has issues performing async requests. It has been moved to the slow lane and may be processing slower than usual."})},[src_types.si.disabledForPeriod]:{tagType:"danger",display:"Disabled temporarily",description:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The function has been disabled temporarily due to enough slow or failed requests. It will be re-enabled soon."})},[src_types.si.disabledIndefinitely]:{tagType:"danger",display:"Disabled",description:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:'The function has been disabled indefinitely due to too many slow or failed requests. Please check your config. Updating your function will move it back to the "degraded" state for testing. If it performs well, it will then be moved to the healthy.'})}},DEFAULT_DISPLAY={tagType:"default",display:"Unknown",description:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The function status is unknown. The status will be derived once enough invocations have been performed."})};function HogFunctionStatusIndicator(){var _hogFunction$status$s;let{hogFunction}=(0,index_esm.useValues)(hogFunctionConfigurationLogic);if(!hogFunction||!hogFunction.enabled)return null;let{tagType,display,description}=hogFunction.status?.state?displayMap[hogFunction.status.state]:DEFAULT_DISPLAY,noRatings=hogFunction.status?.ratings.length===0,averageRating=hogFunction.status?.ratings.length?hogFunction.status.ratings.reduce((acc,x)=>acc+x.rating,0)/hogFunction.status.ratings.length:0;return(0,jsx_runtime.jsx)(src.Qw,{overlay:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"p-2 space-y-2",children:[(0,jsx_runtime.jsxs)("h2",{className:"flex items-center m-0 gap-2",children:["Function status - ",(0,jsx_runtime.jsx)(src.oe,{type:tagType,children:display})]}),(0,jsx_runtime.jsxs)("p",{children:["Your function has"," ",noRatings?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"no ratings yet. There are either no recent invocations or data is still being gathered."}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["a rating of ",(0,jsx_runtime.jsxs)("b",{children:[Math.round(100*averageRating),"%"]}),"."]})," ","A rating of 100% means the function is running perfectly, with 0% meaning it is failing every time."]}),(0,jsx_runtime.jsx)("p",{children:description}),(0,jsx_runtime.jsx)("h4",{children:"History"}),(0,jsx_runtime.jsx)("ul",{children:(0,jsx_runtime.jsx)(src.g3,{columns:[{title:"Timestamp",key:"timestamp",render:(_,_ref)=>{let{timestamp}=_ref;return(0,jsx_runtime.jsx)(apps_common_src.w4,{time:(0,dayjs.Bv)(timestamp)})}},{title:"Status",key:"state",render:(_,_ref2)=>{let{state}=_ref2,{tagType,display}=displayMap[state]||DEFAULT_DISPLAY;return(0,jsx_runtime.jsx)(src.oe,{type:tagType,children:display})}}],dataSource:null!==(_hogFunction$status$s=hogFunction.status?.states)&&void 0!==_hogFunction$status$s?_hogFunction$status$s:[]})})]})}),children:(0,jsx_runtime.jsx)(src.oe,{type:tagType,children:display})})}var clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js");let hogFunctionTestLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>props.id),(0,index_esm.path)(id=>["scenes","pipeline","hogfunctions","hogFunctionTestLogic",id]),(0,index_esm.connect)(props=>({values:[hogFunctionConfigurationLogic({id:props.id}),["configuration","configurationHasErrors","exampleInvocationGlobals"]],actions:[hogFunctionConfigurationLogic({id:props.id}),["touchConfigurationField"]]})),(0,index_esm.actions)({setTestResult:result=>({result}),toggleExpanded:expanded=>({expanded})}),(0,index_esm.reducers)({expanded:[!1,{toggleExpanded:(_,_ref)=>{let{expanded}=_ref;return void 0===expanded?!_:expanded}}],testResult:[null,{setTestResult:(_,_ref2)=>{let{result}=_ref2;return result}}]}),(0,lib.forms)(_ref3=>{let{props,actions,values}=_ref3;return{testInvocation:{defaults:{mock_async_functions:!0},alwaysShowErrors:!0,errors:_ref4=>{let{globals}=_ref4;return{globals:globals?(0,utils.Cy)(globals)?void 0:"Invalid JSON":"Required"}},submit:async data=>{if(values.configurationHasErrors){src.UJ.error("Please fix the configuration errors before testing.");return}let globals=(0,utils.Cy)(data.globals),configuration=sanitizeConfiguration(values.configuration);try{let res=await api.ZP.hogFunctions.createTestInvocation(props.id,{globals,mock_async_functions:data.mock_async_functions,configuration});actions.setTestResult(res)}catch(e){src.UJ.error(`An unexpected serror occurred while trying to testing the function. ${e}`)}}}}}),(0,index_esm.afterMount)(_ref5=>{let{actions,values}=_ref5;actions.setTestInvocationValue("globals",JSON.stringify(values.exampleInvocationGlobals,null,2))})]),HogFunctionTestEditor=_ref=>{let{value,onChange}=_ref;return(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",value:value,height:300,onChange:onChange,options:{lineNumbers:"off",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"hidden",verticalScrollbarSize:0}}})};function HogFunctionTestPlaceholder(){return(0,jsx_runtime.jsxs)("div",{className:"border bg-accent-3000 rounded p-3 space-y-2",children:[(0,jsx_runtime.jsx)("h2",{className:"flex-1 m-0",children:"Testing"}),(0,jsx_runtime.jsx)("p",{children:"Save your configuration to enable testing"})]})}function HogFunctionTest(props){var _testResult$logs;let{isTestInvocationSubmitting,testResult,expanded}=(0,index_esm.useValues)(hogFunctionTestLogic(props)),{submitTestInvocation,setTestResult,toggleExpanded}=(0,index_esm.useActions)(hogFunctionTestLogic(props));return(0,jsx_runtime.jsx)(lib.Form,{logic:hogFunctionTestLogic,props:props,formKey:"testInvocation",enableFormOnSubmit:!0,children:(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("border rounded p-3 space-y-2",expanded?"bg-bg-light min-h-120":"bg-accent-3000"),children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 justify-end",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0",children:"Testing"}),!expanded&&(0,jsx_runtime.jsx)("p",{children:"Click here to test your function with an example event"})]}),expanded?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[testResult?(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>setTestResult(null),loading:isTestInvocationSubmitting,children:"Clear test result"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"mock_async_functions",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.f4,{bordered:!0,onChange:onChange,checked:value,label:(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"When selected, async functions such as `fetch` will not actually be called but instead will be mocked out with the fetch content logged instead"}),children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2",children:["Mock out async functions",(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-lg"})]})})})}}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:submitTestInvocation,loading:isTestInvocationSubmitting,children:"Test function"})]}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>toggleExpanded(),tooltip:"Hide testing"})]}):(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>toggleExpanded(),children:"Start testing"})]}),expanded&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:testResult?(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Test invocation result "}),(0,jsx_runtime.jsx)(src.oe,{type:"success"===testResult.status?"success":"danger",children:testResult.status})]}),(0,jsx_runtime.jsx)(src.g3,{dataSource:null!==(_testResult$logs=testResult.logs)&&void 0!==_testResult$logs?_testResult$logs:[],columns:[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:timestamp=>(0,jsx_runtime.jsx)(apps_common_src.w4,{time:timestamp}),width:0},{width:100,title:"Level",key:"level",dataIndex:"level"},{title:"Message",key:"message",dataIndex:"message",render:message=>(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}],className:"ph-no-capture",rowKey:"timestamp",pagination:{pageSize:200,hideOnSinglePage:!0}})]}):(0,jsx_runtime.jsx)("div",{className:"space-y-2",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"globals",label:"Test invocation context",children:_ref3=>{let{value,onChange}=_ref3;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex items-start justify-end",children:(0,jsx_runtime.jsx)("p",{className:"flex-1",children:"The globals object is the context in which your function will be tested. It should contain all the data that your function will need to run"})}),(0,jsx_runtime.jsx)(HogFunctionTestEditor,{value:value,onChange:onChange})]})}})})})]})})}function HogFunctionConfiguration(_ref){var _sparkline$count,_sparkline$count2;let{templateId,id}=_ref,logicProps={templateId,id},logic=hogFunctionConfigurationLogic(logicProps),{isConfigurationSubmitting,configurationChanged,showSource,configuration,loading,loaded,hogFunction,willReEnableOnSave,exampleInvocationGlobalsWithInputs,showPaygate,hasAddon,sparkline,sparklineLoading}=(0,index_esm.useValues)(logic),{submitConfiguration,resetForm,setShowSource,duplicate,resetToTemplate,duplicateFromTemplate,setConfigurationValue,deleteHogFunction}=(0,index_esm.useActions)(logic),hogFunctionsEnabled=!!(0,useFeatureFlag.y)("HOG_FUNCTIONS"),{groupsTaxonomicTypes}=(0,index_esm.useValues)(groupsModel.$);if(loading&&!loaded)return(0,jsx_runtime.jsx)(src.t2,{});if(!loaded)return(0,jsx_runtime.jsx)(NotFound.T,{object:"Hog function"});if(!hogFunctionsEnabled&&!id)return(0,jsx_runtime.jsx)("div",{className:"space-y-3",children:(0,jsx_runtime.jsxs)("div",{className:"border rounded text-center p-4",children:[(0,jsx_runtime.jsx)("h2",{children:"Feature not enabled"}),(0,jsx_runtime.jsx)("p",{children:"Hog functions are not enabled for you yet. If you think they should be, contact support."})]})});let headerButtons=(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:!templateId&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,onClick:()=>duplicate(),children:"Duplicate"}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",fullWidth:!0,onClick:()=>deleteHogFunction(),children:"Delete"})]})}),(0,jsx_runtime.jsx)(src.p2,{vertical:!0})]})}),saveButtons=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",htmlType:"reset",onClick:()=>resetForm(),disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress…":void 0:"No changes",children:"Clear changes"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,children:templateId?"Create":willReEnableOnSave?"Save & re-enable":"Save"})]});return showPaygate?(0,jsx_runtime.jsx)(PayGateMini.E,{feature:src_types.P$.DATA_PIPELINES}):(0,jsx_runtime.jsx)("div",{className:"space-y-3",children:(0,jsx_runtime.jsxs)(index_esm.BindLogic,{logic:hogFunctionConfigurationLogic,props:logicProps,children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[headerButtons,saveButtons]})}),(0,jsx_runtime.jsxs)(src.Vp,{type:"info",children:["Hog Functions are in ",(0,jsx_runtime.jsx)("b",{children:"alpha"})," and are the next generation of our data pipeline destinations. You can use pre-existing templates or modify the source Hog code to create your own custom functions."]}),(0,jsx_runtime.jsx)(lib.Form,{logic:hogFunctionConfigurationLogic,props:logicProps,formKey:"configuration",className:"space-y-3",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-4 items-start",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-4 flex-1 min-w-100",children:[(0,jsx_runtime.jsxs)("div",{className:"border bg-bg-light rounded p-3 space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 min-h-16 items-center",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"icon_url",children:_ref2=>{var _ref3;let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(HogFunctionIcon.g,{logicKey:null!==(_ref3=null!=id?id:templateId)&&void 0!==_ref3?_ref3:"new",src:value,onChange:val=>onChange(val)})}}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col py-1 flex-1 justify-start",children:(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:configuration.name})}),(0,jsx_runtime.jsx)(HogFunctionStatusIndicator,{}),(0,jsx_runtime.jsx)(LemonField.D,{name:"enabled",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsx)(src.f4,{label:"Enabled",onChange:()=>onChange(!value),checked:value,disabled:loading,bordered:!0})}})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",info:"Customising the name can be useful if multiple instances of the same type are used.",children:(0,jsx_runtime.jsx)(src.DF,{type:"text",disabled:loading})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"description",label:"Description",info:"Add a description to share context with other team members",children:(0,jsx_runtime.jsx)(src._V,{disabled:loading})}),hogFunction?.template?(0,jsx_runtime.jsxs)("p",{className:"border border-dashed rounded text-muted-alt p-2",children:["Built from template:"," ",(0,jsx_runtime.jsx)(src.Qw,{showArrow:!0,overlay:(0,jsx_runtime.jsxs)("div",{className:"max-w-120 p-1",children:[(0,jsx_runtime.jsxs)("p",{children:["This function was built from the template"," ",(0,jsx_runtime.jsx)("b",{children:hogFunction.template.name}),". If the template is updated, this function is not affected unless you choose to update it."]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 gap-2 items-center border-t pt-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(src.Jp,{children:"Close"})}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>resetToTemplate(),children:"Reset to template"}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>duplicateFromTemplate(),children:"New function from template"})]})]}),children:(0,jsx_runtime.jsxs)(src.rU,{subtle:!0,className:"font-semibold",children:[hogFunction?.template.name," ",(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{})]})})]}):null]}),(0,jsx_runtime.jsxs)("div",{className:"border bg-bg-light rounded p-3 space-y-2",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:"Filters by events and actions",children:_ref5=>{var _value$filter_test_ac;let{value,onChange}=_ref5;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:null!==(_value$filter_test_ac=value?.filter_test_accounts)&&void 0!==_value$filter_test_ac&&_value$filter_test_ac,onChange:val=>onChange({...value,filter_test_accounts:val}),fullWidth:!0}),(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:null!=value?value:{},setFilters:payload=>{onChange({...payload,filter_test_accounts:value?.filter_test_accounts})},typeKey:"plugin-filters",mathAvailability:ActionFilterRow.Qq.None,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:[types.t.Events,types.t.Actions],propertiesTaxonomicGroupTypes:[types.t.EventProperties,types.t.EventFeatureFlags,types.t.Elements,types.t.PersonProperties,types.t.HogQLExpression,...groupsTaxonomicTypes],propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:src_types.DC.EVENTS},buttonCopy:"Add event filter"})]})}}),(0,jsx_runtime.jsxs)("p",{className:"italic text-muted-alt",children:["This destination will be triggered if ",(0,jsx_runtime.jsx)("b",{children:"any of"})," the above filters match."]})]}),(0,jsx_runtime.jsxs)("div",{className:"relative border bg-bg-light rounded p-3 space-y-2",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Expected volume"}),sparkline&&!sparklineLoading?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[sparkline.count>8e3?(0,jsx_runtime.jsxs)(src.Vp,{type:"warning",children:[(0,jsx_runtime.jsx)("b",{children:"Warning:"})," This destination would have triggered"," ",(0,jsx_runtime.jsxs)("strong",{children:[null!==(_sparkline$count=sparkline.count)&&void 0!==_sparkline$count?_sparkline$count:0," time",1!==sparkline.count?"s":""]})," ","in the last 7 days. Consider the impact of this function on your destination."]}):(0,jsx_runtime.jsxs)("p",{children:["This destination would have triggered"," ",(0,jsx_runtime.jsxs)("strong",{children:[null!==(_sparkline$count2=sparkline.count)&&void 0!==_sparkline$count2?_sparkline$count2:0," time",1!==sparkline.count?"s":""]})," ","in the last 7 days."]}),(0,jsx_runtime.jsx)(Sparkline.b,{type:"bar",className:"w-full h-20",data:sparkline.data,labels:sparkline.labels})]}):sparklineLoading?(0,jsx_runtime.jsx)("div",{className:"min-h-20",children:(0,jsx_runtime.jsx)(src.t2,{})}):(0,jsx_runtime.jsx)("p",{children:"The expected volume could not be calculated"})]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex-2 min-w-100 space-y-4",children:[(0,jsx_runtime.jsx)("div",{className:"border bg-bg-light rounded p-3 space-y-2",children:(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsx)(HogFunctionInputs,{}),showSource?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),size:"small",type:"secondary",className:"my-4",onClick:()=>{var _configuration$inputs,_configuration$inputs2;setConfigurationValue("inputs_schema",[...null!==(_configuration$inputs=configuration.inputs_schema)&&void 0!==_configuration$inputs?_configuration$inputs:[],{type:"string",key:`input_${(null!==(_configuration$inputs2=configuration.inputs_schema?.length)&&void 0!==_configuration$inputs2?_configuration$inputs2:0)+1}`,label:"",required:!1}])},children:"Add input variable"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"hog",children:_ref6=>{let{value,onChange}=_ref6;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between gap-2",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Function source code"}),(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"secondary",onClick:()=>setShowSource(!1),children:"Hide source code"})]}),(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"hog",value:null!=value?value:"",onChange:v=>onChange(null!=v?v:""),globals:exampleInvocationGlobalsWithInputs,options:{minimap:{enabled:!1},wordWrap:"on",scrollBeyondLastLine:!1,automaticLayout:!0,fixedOverflowWidgets:!0,suggest:{showInlineDetails:!0},quickSuggestionsDelay:300}})]})}})]}):(0,jsx_runtime.jsx)("div",{className:"flex justify-end mt-2",children:(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"secondary",onClick:()=>setShowSource(!0),disabledReason:hasAddon?void 0:"Editing the source code requires the Data Pipelines addon",children:"Show function source code"})})]})}),id?(0,jsx_runtime.jsx)(HogFunctionTest,{id:id}):(0,jsx_runtime.jsx)(HogFunctionTestPlaceholder,{}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-end",children:saveButtons})]})]})})]})})}},"./frontend/src/scenes/pipeline/importAppsLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{c:()=>importAppsLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./frontend/src/lib/api.ts"),scenes_teamLogic__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./frontend/src/scenes/teamLogic.tsx"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/types.ts"),_types__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/scenes/pipeline/types.ts"),_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/scenes/pipeline/utils.tsx");let importAppsLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","pipeline","importAppsLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)({values:[scenes_teamLogic__WEBPACK_IMPORTED_MODULE_3__.H,["currentTeamId"],scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__.userLogic,["user"]]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({loadPluginConfigs:!0,updatePluginConfig:pluginConfig=>({pluginConfig})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref=>{let{values}=_ref;return{plugins:[{},{loadPlugins:async()=>(0,_utils__WEBPACK_IMPORTED_MODULE_7__.c$)("api/organizations/@current/pipeline_import_apps")}],pluginConfigs:[{},{loadPluginConfigs:async()=>{let res=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.loadPaginatedResults(`api/projects/${values.currentTeamId}/pipeline_import_apps_configs`);return Object.fromEntries(res.map(pluginConfig=>[pluginConfig.id,pluginConfig]))},toggleEnabled:async _ref2=>{let{id,enabled}=_ref2;if(!(0,_utils__WEBPACK_IMPORTED_MODULE_7__.FH)(_types__WEBPACK_IMPORTED_MODULE_5__.We.ImportApp,enabled))return values.pluginConfigs;let{pluginConfigs,plugins}=values,pluginConfig=pluginConfigs[id],plugin=plugins[pluginConfig.plugin];(0,_utils__WEBPACK_IMPORTED_MODULE_7__.SO)(`plugin ${enabled?"enabled":"disabled"}`,plugin,pluginConfig);let response=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.update(`api/plugin_config/${id}`,{enabled});return{...pluginConfigs,[id]:response}},updatePluginConfig:_ref3=>{let{pluginConfig}=_ref3;return{...values.pluginConfigs,[pluginConfig.id]:pluginConfig}}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({loading:[s=>[s.pluginsLoading,s.pluginConfigsLoading],(pluginsLoading,pluginConfigsLoading)=>pluginsLoading||pluginConfigsLoading],importApps:[s=>[s.plugins,s.pluginConfigs],(plugins,pluginConfigs)=>{let rawImportApp=Object.values(pluginConfigs).map(pluginConfig=>({...pluginConfig,plugin_info:plugins[pluginConfig.plugin]||null})),convertedImportApps=rawImportApp.map(t=>(0,_types__WEBPACK_IMPORTED_MODULE_6__.n)(t,_types__WEBPACK_IMPORTED_MODULE_5__.We.ImportApp)),enabledFirst=convertedImportApps.sort((a,b)=>Number(b.enabled)-Number(a.enabled));return enabledFirst}],hasEnabledImportApps:[s=>[s.importApps],importApps=>importApps.some(app=>app.enabled)]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref4=>{let{actions}=_ref4;actions.loadPlugins(),actions.loadPluginConfigs()})])},"./frontend/src/scenes/pipeline/pipelineBatchExportConfigurationLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{t:()=>pipelineBatchExportConfigurationLogic});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/api.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/scenes/urls.ts"),_types__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/types.ts"),_destinations_destinationsLogic__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./frontend/src/scenes/pipeline/destinations/destinationsLogic.tsx"),_pipelineAccessLogic__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./frontend/src/scenes/pipeline/pipelineAccessLogic.tsx");function getConfigurationFromBatchExportConfig(batchExportConfig){return{name:batchExportConfig.name,destination:batchExportConfig.destination.type,paused:batchExportConfig.paused,interval:batchExportConfig.interval,model:batchExportConfig.model,...batchExportConfig.destination.config}}function getDefaultConfiguration(service){return{name:service,destination:service,model:"events",paused:!0}}function getEventTable(service){let eventsTable={type:"batch_export",id:"Events",name:"events",fields:{uuid:{name:"uuid",hogql_value:"toString(uuid)",type:"string",schema_valid:!0},timestamp:{name:"timestamp",hogql_value:"timestamp",type:"datetime",schema_valid:!0},event:{name:"event",hogql_value:"event",type:"string",schema_valid:!0},distinct_id:{name:"distinct_id",hogql_value:"toString(distinct_id)",type:"string",schema_valid:!0},properties:{name:"properties",hogql_value:"properties",type:"json",schema_valid:!0},..."S3"==service&&{person_id:{name:"person_id",hogql_value:"toString(person_id)",type:"string",schema_valid:!0},person_properties:{name:"person_properties",hogql_value:"nullIf(person_properties, '')",type:"string",schema_valid:!0},created_at:{name:"created_at",hogql_value:"created_at",type:"datetime",schema_valid:!0}},..."S3"!=service&&{team_id:{name:"team_id",hogql_value:"Postgres"==service||"Redshift"==service?"toInt32(team_id)":"team_id",type:"integer",schema_valid:!0},set:{name:"Snowflake"==service?"people_set":"set",hogql_value:"nullIf(JSONExtractString(properties, '$set'), '')",type:"string",schema_valid:!0},set_once:{name:"Snowflake"==service?"people_set_once":"set_once",hogql_value:"nullIf(JSONExtractString(properties, '$set_once'), '')",type:"string",schema_valid:!0},site_url:{name:"site_url",hogql_value:"''",type:"string",schema_valid:!0},ip:{name:"ip",hogql_value:"nullIf(JSONExtractString(properties, '$ip'), '')",type:"string",schema_valid:!0},elements_chain:{name:"elements",hogql_value:"toJSONString(elements_chain)",type:"string",schema_valid:!0}},..."BigQuery"==service&&{bq_ingested_timestamp:{name:"bq_ingested_timestamp",hogql_value:"NOW64()",type:"datetime",schema_valid:!0}}}};return eventsTable}let personsTable={type:"batch_export",id:"Persons",name:"persons",fields:{team_id:{name:"team_id",hogql_value:"team_id",type:"integer",schema_valid:!0},distinct_id:{name:"distinct_id",hogql_value:"distinct_id",type:"string",schema_valid:!0},person_id:{name:"person_id",hogql_value:"person_id",type:"string",schema_valid:!0},properties:{name:"properties",hogql_value:"properties",type:"json",schema_valid:!0},person_version:{name:"person_version",hogql_value:"person_version",type:"integer",schema_valid:!0},person_distinct_id_version:{name:"person_distinct_id_version",hogql_value:"person_distinct_id_version",type:"integer",schema_valid:!0}}},pipelineBatchExportConfigurationLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.key)(_ref=>{let{service,id}=_ref;return id?`ID:${id}`:`NEW:${service}`}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(id=>["scenes","pipeline","pipelineBatchExportConfigurationLogic",id]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.connect)(()=>({values:[_pipelineAccessLogic__WEBPACK_IMPORTED_MODULE_9__.g,["canEnableNewDestinations"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({setSavedConfiguration:configuration=>({configuration}),setSelectedModel:model=>({model})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_3__.loaders)(_ref2=>{let{props,values}=_ref2;return{batchExportConfig:[null,{loadBatchExportConfig:async()=>props.id?await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.get(props.id):null,updateBatchExportConfig:async formdata=>{if((!values.batchExportConfig||values.batchExportConfig.paused&&!0!==formdata.paused)&&!values.canEnableNewDestinations)return _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.UJ.error("Data pipelines add-on is required for enabling new destinations."),null;let{name,destination,interval,paused,created_at,start_at,end_at,model,...config}=formdata,data={paused,name,interval,model,destination:{type:destination,config:config}};if(props.id){let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.update(props.id,data);return res}let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.create(data);return kea_router__WEBPACK_IMPORTED_MODULE_4__.router.actions.replace(scenes_urls__WEBPACK_IMPORTED_MODULE_6__.j.pipelineNode(_types__WEBPACK_IMPORTED_MODULE_7__.We.Destination,res.id,_types__WEBPACK_IMPORTED_MODULE_7__.il.Configuration)),res}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.reducers)(_ref3=>{let{props}=_ref3;return{tables:[props.service?[getEventTable(props.service),personsTable]:[],{loadBatchExportConfigSuccess:(state,_ref4)=>{let{batchExportConfig}=_ref4;return batchExportConfig?[getEventTable(batchExportConfig.destination.type),personsTable]:state},updateBatchExportConfigSuccess:(state,_ref5)=>{let{batchExportConfig}=_ref5;return batchExportConfig?[getEventTable(batchExportConfig.destination.type),personsTable]:state}}],selectedModel:["events",{setSelectedModel:(_,_ref6)=>{let{model}=_ref6;return model},loadBatchExportConfigSuccess:(state,_ref7)=>{let{batchExportConfig}=_ref7;return batchExportConfig?batchExportConfig.model:state},updateBatchExportConfigSuccess:(state,_ref8)=>{let{batchExportConfig}=_ref8;return batchExportConfig?batchExportConfig.model:state}}],configuration:[props.service?getDefaultConfiguration(props.service):{},{loadBatchExportConfigSuccess:(state,_ref9)=>{let{batchExportConfig}=_ref9;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state},updateBatchExportConfigSuccess:(state,_ref10)=>{let{batchExportConfig}=_ref10;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.selectors)(()=>({service:[(s,p)=>[s.batchExportConfig,p.service],(config,service)=>config?.destination.type||service],savedConfiguration:[(s,p)=>[s.batchExportConfig,p.service],(batchExportConfig,service)=>batchExportConfig&&service?batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):service?getDefaultConfiguration(service):{}:{}],isNew:[(_,p)=>[p.id],id=>!id],requiredFields:[s=>[s.service,s.isNew],(service,isNew)=>{let generalRequiredFields=["interval","name","model"];return"Postgres"===service||"Redshift"===service?[...generalRequiredFields,...isNew?["user"]:[],...isNew?["password"]:[],"host","port","database","schema","table_name"]:"S3"===service?[...generalRequiredFields,"bucket_name","region","prefix",...isNew?["aws_access_key_id"]:[],...isNew?["aws_secret_access_key"]:[],...isNew?["file_format"]:[]]:"BigQuery"===service?[...generalRequiredFields,...isNew?["json_config_file"]:[],"dataset_id","table_id"]:"HTTP"===service?[...generalRequiredFields,"url","token"]:"Snowflake"===service?[...generalRequiredFields,"account","database","warehouse",...isNew?["user"]:[],...isNew?["password"]:[],"schema","table_name"]:generalRequiredFields}]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.listeners)(_ref11=>{let{values,actions}=_ref11;return{updateBatchExportConfigSuccess:_ref12=>{let{batchExportConfig}=_ref12;batchExportConfig&&_destinations_destinationsLogic__WEBPACK_IMPORTED_MODULE_8__.w.findMounted()?.actions.updateBatchExportConfig(batchExportConfig)},setConfigurationValue:async _ref13=>{let{name,value}=_ref13;if("json_config_file"===name[0]&&value)try{let loadedFile=await new Promise((resolve,reject)=>{let filereader=new FileReader;filereader.onload=e=>resolve(e.target?.result),filereader.onerror=e=>reject(e),filereader.readAsText(value[0])}),jsonConfig=JSON.parse(loadedFile);actions.setConfigurationValues({...values.configuration,project_id:jsonConfig.project_id,private_key:jsonConfig.private_key,private_key_id:jsonConfig.private_key_id,client_email:jsonConfig.client_email,token_uri:jsonConfig.token_uri})}catch(e){actions.setConfigurationManualErrors({json_config_file:"The config file is not valid"})}}}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_2__.forms)(_ref14=>{let{asyncActions,values}=_ref14;return{configuration:{errors:formdata=>Object.fromEntries(values.requiredFields.map(field=>[field,formdata[field]?void 0:"This field is required"])),submit:async formdata=>{await asyncActions.updateBatchExportConfig(formdata)}}}}),(0,kea_router__WEBPACK_IMPORTED_MODULE_4__.beforeUnload)(_ref15=>{let{actions,values}=_ref15;return{enabled:()=>values.configurationChanged,message:"Leave action?\nChanges you made will be discarded.",onConfirm:()=>{actions.resetConfiguration()}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.afterMount)(_ref16=>{let{actions}=_ref16;actions.loadBatchExportConfig()})])},"./frontend/src/scenes/pipeline/pipelineNodeNewLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Q:()=>pipelineNodeNewLogic,U:()=>NODE_STAGE_TO_PIPELINE_TAB});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),lib_utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./frontend/src/lib/utils.tsx"),scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./frontend/src/scenes/sceneTypes.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./frontend/src/scenes/urls.ts"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/types.ts"),_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/scenes/pipeline/utils.tsx");let NODE_STAGE_TO_PIPELINE_TAB={[_types__WEBPACK_IMPORTED_MODULE_6__.We.Transformation]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.Transformations,[_types__WEBPACK_IMPORTED_MODULE_6__.We.Destination]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.Destinations,[_types__WEBPACK_IMPORTED_MODULE_6__.We.SiteApp]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.SiteApps,[_types__WEBPACK_IMPORTED_MODULE_6__.We.Source]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.Sources},pipelineNodeNewLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)({values:[scenes_userLogic__WEBPACK_IMPORTED_MODULE_5__.userLogic,["user"]]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(id=>["scenes","pipeline","pipelineNodeNewLogic",id]),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)({plugins:[{},{loadPlugins:async()=>(0,_utils__WEBPACK_IMPORTED_MODULE_7__.c$)("api/organizations/@current/pipeline_destinations")}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(()=>({loading:[s=>[s.pluginsLoading],pluginsLoading=>pluginsLoading],breadcrumbs:[(_,p)=>[p.stage,p.pluginId,p.batchExportDestination],(stage,pluginId,batchDestination)=>[{key:scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__.x.Pipeline,name:"Data pipeline",path:scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipeline()},{key:stage||"unknown",name:stage?(0,lib_utils__WEBPACK_IMPORTED_MODULE_2__.fm)(NODE_STAGE_TO_PIPELINE_TAB[stage]||""):"Unknown",path:scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipeline(stage?NODE_STAGE_TO_PIPELINE_TAB[stage]:void 0)},{key:pluginId||batchDestination||"Unknown",name:pluginId?"New":batchDestination?`New ${batchDestination} destination`:"New"}]],batchExportServiceNames:[s=>[s.user],user=>{let services=_types__WEBPACK_IMPORTED_MODULE_6__.e2.filter(service=>"HTTP"!==service);return(user?.is_impersonated||user?.is_staff)&&services.push("HTTP"),services}]}))])},"./frontend/src/scenes/pipeline/transformationsLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{P:()=>pipelineTransformationsLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./frontend/src/lib/api.ts"),scenes_teamLogic__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./frontend/src/scenes/teamLogic.tsx"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/types.ts"),_types__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/scenes/pipeline/types.ts"),_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/scenes/pipeline/utils.tsx");let pipelineTransformationsLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","pipeline","transformationsLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)({values:[scenes_teamLogic__WEBPACK_IMPORTED_MODULE_3__.H,["currentTeamId"],scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__.userLogic,["user"]]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({loadPluginConfigs:!0,openReorderModal:!0,closeReorderModal:!0,setTemporaryOrder:tempOrder=>({tempOrder}),savePluginConfigsOrder:newOrders=>({newOrders}),updatePluginConfig:pluginConfig=>({pluginConfig})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref=>{let{values}=_ref;return{plugins:[{},{loadPlugins:async()=>(0,_utils__WEBPACK_IMPORTED_MODULE_7__.c$)("api/organizations/@current/pipeline_transformations")}],temporaryOrder:[{},{setTemporaryOrder:async _ref2=>{let{tempOrder}=_ref2;return tempOrder},closeReorderModal:async()=>({})}],pluginConfigs:[{},{loadPluginConfigs:async()=>{let res=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.loadPaginatedResults(`api/projects/${values.currentTeamId}/pipeline_transformation_configs`);return Object.fromEntries(res.map(pluginConfig=>[pluginConfig.id,pluginConfig]))},savePluginConfigsOrder:async _ref3=>{let{newOrders}=_ref3;if(!(0,_utils__WEBPACK_IMPORTED_MODULE_7__.FH)(_types__WEBPACK_IMPORTED_MODULE_5__.We.Transformation,!1))return values.pluginConfigs;let{pluginConfigs}=values,response=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.update("api/plugin_config/rearrange",{orders:newOrders}),newPluginConfigs={...pluginConfigs};for(let pluginConfig of response)Object.keys(values.plugins).map(Number).includes(pluginConfig.plugin)&&(newPluginConfigs[pluginConfig.id]=pluginConfig);return newPluginConfigs},toggleEnabled:async _ref4=>{let{id,enabled}=_ref4;if(!(0,_utils__WEBPACK_IMPORTED_MODULE_7__.FH)(_types__WEBPACK_IMPORTED_MODULE_5__.We.Transformation,enabled))return values.pluginConfigs;let{pluginConfigs,plugins}=values,pluginConfig=pluginConfigs[id],plugin=plugins[pluginConfig.plugin];(0,_utils__WEBPACK_IMPORTED_MODULE_7__.SO)(`plugin ${enabled?"enabled":"disabled"}`,plugin,pluginConfig);let order={};enabled&&(order={order:values.nextAvailableOrder});let response=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.update(`api/plugin_config/${id}`,{enabled,...order});return{...pluginConfigs,[id]:response}},updatePluginConfig:_ref5=>{let{pluginConfig}=_ref5;return{...values.pluginConfigs,[pluginConfig.id]:pluginConfig}}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({loading:[s=>[s.pluginsLoading,s.pluginConfigsLoading],(pluginsLoading,pluginConfigsLoading)=>pluginsLoading||pluginConfigsLoading],transformations:[s=>[s.pluginConfigs,s.plugins],(pluginConfigs,plugins)=>{let rawTransformations=Object.values(pluginConfigs).map(pluginConfig=>({...pluginConfig,plugin_info:plugins[pluginConfig.plugin]||null})),convertedTransformations=rawTransformations.map(t=>(0,_types__WEBPACK_IMPORTED_MODULE_6__.n)(t,_types__WEBPACK_IMPORTED_MODULE_5__.We.Transformation));return convertedTransformations}],sortedEnabledTransformations:[s=>[s.transformations,s.temporaryOrder],(transformations,temporaryOrder)=>(transformations=transformations.filter(t=>t.enabled),transformations=temporaryOrder&&Object.keys(temporaryOrder).length>0?Object.entries(temporaryOrder).sort((_ref6,_ref7)=>{let[,aIdx]=_ref6,[,bIdx]=_ref7;return aIdx-bIdx}).map(_ref8=>{let[pluginId]=_ref8;return transformations.find(t=>t.id===Number(pluginId))}):transformations.sort((a,b)=>a.order-b.order))],sortedTransformations:[s=>[s.transformations,s.sortedEnabledTransformations],(transformations,sortedEnabledTransformations)=>sortedEnabledTransformations.concat(transformations.filter(t=>!t.enabled).sort((a,b)=>a.id-b.id))],nextAvailableOrder:[s=>[s.transformations],transformations=>{let enabledTransformations=transformations.filter(t=>t.enabled);return enabledTransformations.length>0?Math.max(...enabledTransformations.map(t=>t.order),0)+1:0}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({reorderModalOpen:[!1,{openReorderModal:()=>!0,closeReorderModal:()=>!1}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref9=>{let{actions}=_ref9;return{savePluginConfigsOrderSuccess:()=>{actions.closeReorderModal()}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref10=>{let{actions}=_ref10;actions.loadPlugins(),actions.loadPluginConfigs()})])}}]);