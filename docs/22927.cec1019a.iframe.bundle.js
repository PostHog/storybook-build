"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[22927],{"./frontend/src/scenes/data-warehouse/editor/EditorScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{EditorScene:()=>EditorScene});var posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.9.2_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),CopyToClipboard=__webpack_require__("./frontend/src/lib/components/CopyToClipboard.tsx"),DatabaseTableTree=__webpack_require__("./frontend/src/lib/components/DatabaseTableTree/DatabaseTableTree.tsx"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),Sidebar=__webpack_require__("./frontend/src/layout/navigation-3000/components/Sidebar.tsx"),navigationLogic=__webpack_require__("./frontend/src/layout/navigation-3000/navigationLogic.tsx"),ViewLinkModal=__webpack_require__("./frontend/src/scenes/data-warehouse/ViewLinkModal.tsx"),editorSceneLogic=__webpack_require__("./frontend/src/scenes/data-warehouse/editor/editorSceneLogic.ts"),resizerLogic=__webpack_require__("./frontend/src/lib/components/Resizer/resizerLogic.ts");let editorSizingLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-warehouse","editor","editorSizingLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(props=>({values:[(0,resizerLogic.Z)(props.sourceNavigatorResizerProps),["desiredSize as sourceNavigatorDesiredSize"],(0,resizerLogic.Z)(props.queryPaneResizerProps),["desiredSize as queryPaneDesiredSize"]]})),(0,index_esm.selectors)({editorSceneRef:[()=>[(_,props)=>props.editorSceneRef],editorSceneRef=>editorSceneRef],sourceNavigatorWidth:[s=>[s.sourceNavigatorDesiredSize],desiredSize=>Math.max(desiredSize||350,100)],queryPaneHeight:[s=>[s.queryPaneDesiredSize],queryPaneDesiredSize=>Math.max(queryPaneDesiredSize||400,100)],queryTabsWidth:[s=>[s.queryPaneDesiredSize],desiredSize=>desiredSize||350],sourceNavigatorResizerProps:[()=>[(_,props)=>props.sourceNavigatorResizerProps],sourceNavigatorResizerProps=>sourceNavigatorResizerProps],queryPaneResizerProps:[()=>[(_,props)=>props.queryPaneResizerProps],queryPaneResizerProps=>queryPaneResizerProps]})]);var src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.2.0_kea@3.1.5/node_modules/kea-router/lib/index.js"),dataNodeLogic=__webpack_require__("./frontend/src/queries/nodes/DataNode/dataNodeLogic.ts"),variableModalLogic=__webpack_require__("./frontend/src/queries/nodes/DataVisualization/Components/Variables/variableModalLogic.ts"),variablesLogic=__webpack_require__("./frontend/src/queries/nodes/DataVisualization/Components/Variables/variablesLogic.ts"),dataVisualizationLogic=__webpack_require__("./frontend/src/queries/nodes/DataVisualization/dataVisualizationLogic.ts"),displayLogic=__webpack_require__("./frontend/src/queries/nodes/DataVisualization/displayLogic.ts"),types=__webpack_require__("./frontend/src/types.ts"),multitabEditorLogic=__webpack_require__("./frontend/src/scenes/data-warehouse/editor/multitabEditorLogic.tsx");__webpack_require__("./node_modules/.pnpm/react-data-grid@7.0.0-beta.47_react-dom@18.2.0_react@18.2.0/node_modules/react-data-grid/lib/styles.css");var clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),animations=__webpack_require__("./frontend/src/lib/animations/animations.ts"),Animation=__webpack_require__("./frontend/src/lib/components/Animation/Animation.tsx"),ExportButton=__webpack_require__("./frontend/src/lib/components/ExportButton/ExportButton.tsx"),bundle=__webpack_require__("./node_modules/.pnpm/react-data-grid@7.0.0-beta.47_react-dom@18.2.0_react@18.2.0/node_modules/react-data-grid/lib/bundle.js"),EmptyStates=__webpack_require__("./frontend/src/scenes/insights/EmptyStates/index.ts"),BoldNumber=__webpack_require__("./frontend/src/scenes/insights/views/BoldNumber/BoldNumber.tsx"),KeyboardShortcut=__webpack_require__("./frontend/src/layout/navigation-3000/components/KeyboardShortcut.tsx"),themeLogic=__webpack_require__("./frontend/src/layout/navigation-3000/themeLogic.ts"),LineGraph=__webpack_require__("./frontend/src/queries/nodes/DataVisualization/Components/Charts/LineGraph.tsx"),SideBar=__webpack_require__("./frontend/src/queries/nodes/DataVisualization/Components/SideBar.tsx"),Table=__webpack_require__("./frontend/src/queries/nodes/DataVisualization/Components/Table.tsx"),TableDisplay=__webpack_require__("./frontend/src/queries/nodes/DataVisualization/Components/TableDisplay.tsx"),AddVariableButton=__webpack_require__("./frontend/src/queries/nodes/DataVisualization/Components/Variables/AddVariableButton.tsx"),Variables=__webpack_require__("./frontend/src/queries/nodes/DataVisualization/Components/Variables/Variables.tsx"),dataWarehouseViewsLogic=__webpack_require__("./frontend/src/scenes/data-warehouse/saved_queries/dataWarehouseViewsLogic.tsx");let OutputTab=function(OutputTab){return OutputTab.Results="results",OutputTab.Visualization="visualization",OutputTab}({}),outputPaneLogic=(0,index_esm.kea)([(0,index_esm.path)(["data-warehouse","editor","outputPaneLogic"]),(0,index_esm.actions)({setActiveTab:tab=>({tab})}),(0,index_esm.reducers)({activeTab:[OutputTab.Results,{setActiveTab:(_,_ref)=>{let{tab}=_ref;return tab}}]})]);var jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function OutputPane(){let{activeTab}=(0,index_esm.useValues)(outputPaneLogic),{setActiveTab}=(0,index_esm.useActions)(outputPaneLogic),{variablesForInsight}=(0,index_esm.useValues)(variablesLogic.Q),{editingView,sourceQuery,exportContext,isValidView,error}=(0,index_esm.useValues)(multitabEditorLogic.tg),{saveAsInsight,saveAsView,setSourceQuery,runQuery}=(0,index_esm.useActions)(multitabEditorLogic.tg),{isDarkModeOn}=(0,index_esm.useValues)(themeLogic.b),{response,responseLoading}=(0,index_esm.useValues)(dataNodeLogic.M),{dataWarehouseSavedQueriesLoading}=(0,index_esm.useValues)(dataWarehouseViewsLogic.$),{updateDataWarehouseSavedQuery}=(0,index_esm.useActions)(dataWarehouseViewsLogic.$),{visualizationType}=(0,index_esm.useValues)(dataVisualizationLogic.H8),columns=(0,react.useMemo)(()=>{var _response$columns$map;return null!==(_response$columns$map=response?.columns?.map(column=>({key:column,name:column,resizable:!0})))&&void 0!==_response$columns$map?_response$columns$map:[]},[response]),rows=(0,react.useMemo)(()=>response?.results?response?.results?.map(row=>{let rowObject={};return response.columns.forEach((column,i)=>{rowObject[column]=row[i]}),rowObject}):[],[response]);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col w-full flex-1 bg-bg-3000",children:[variablesForInsight.length>0&&(0,jsx_runtime.jsx)("div",{className:"py-2 px-4",children:(0,jsx_runtime.jsx)(Variables.M,{})}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-row justify-between align-center py-2 px-4 w-full h-[55px]",children:[(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,onChange:tab=>setActiveTab(tab),tabs:[{key:OutputTab.Results,label:"Results"},{key:OutputTab.Visualization,label:"Visualization"}]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(AddVariableButton.u,{}),exportContext&&(0,jsx_runtime.jsx)(ExportButton.j,{disabledReason:visualizationType!=types.Qb.ActionsTable&&"Only table results are exportable",type:"secondary",items:[{export_format:types.P5.CSV,export_context:exportContext},{export_format:types.P5.XLSX,export_context:exportContext}]}),editingView?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.Jp,{loading:dataWarehouseSavedQueriesLoading,type:"secondary",onClick:()=>{var _response$types;return updateDataWarehouseSavedQuery({id:editingView.id,query:sourceQuery.source,types:null!==(_response$types=response?.types)&&void 0!==_response$types?_response$types:[]})},children:"Update view"})}):(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>saveAsView(),disabledReason:isValidView?"":"Some fields may need an alias",children:"Save as view"}),(0,jsx_runtime.jsxs)(src.Jp,{disabledReason:error||"",loading:responseLoading,type:"primary",onClick:()=>runQuery(),children:[(0,jsx_runtime.jsx)("span",{className:"mr-1",children:"Run"}),(0,jsx_runtime.jsx)(KeyboardShortcut.e,{command:!0,enter:!0})]})]})]}),(0,jsx_runtime.jsx)("div",{className:"flex flex-1 relative bg-dark justify-center items-center",children:(0,jsx_runtime.jsx)(()=>activeTab===OutputTab.Results?responseLoading?(0,jsx_runtime.jsx)(src.$j,{className:"text-3xl"}):response?(0,jsx_runtime.jsx)("div",{className:"flex-1 absolute top-0 left-0 right-0 bottom-0",children:(0,jsx_runtime.jsx)(bundle.ZP,{className:isDarkModeOn?"rdg-dark h-full":"rdg-light h-full",columns:columns,rows:rows})}):(0,jsx_runtime.jsx)("span",{className:"text-muted mt-3",children:"Query results will appear here"}):activeTab===OutputTab.Visualization?response?(0,jsx_runtime.jsx)("div",{className:"flex-1 absolute top-0 left-0 right-0 bottom-0 px-4 py-1 hide-scrollbar",children:(0,jsx_runtime.jsx)(InternalDataTableVisualization,{uniqueKey:"SQLEditorScene",query:sourceQuery,setQuery:setSourceQuery,context:{},cachedResults:void 0,exportContext:exportContext,onSaveInsight:saveAsInsight})}):(0,jsx_runtime.jsx)("span",{className:"text-muted mt-3",children:"Query be results will be visualized here"}):null,{})})]})}function InternalDataTableVisualization(props){let{query,visualizationType,showEditingUI,showResultControls,response,responseLoading,responseError,queryCancelled,isChartSettingsPanelOpen}=(0,index_esm.useValues)(dataVisualizationLogic.H8),{toggleChartSettingsPanel}=(0,index_esm.useActions)(dataVisualizationLogic.H8),component=null;return showEditingUI||response&&!responseLoading?visualizationType===types.Qb.ActionsTable?component=(0,jsx_runtime.jsx)(Table.i,{uniqueKey:props.uniqueKey,query:query,context:props.context,cachedResults:props.cachedResults}):visualizationType===types.Qb.ActionsLineGraph||visualizationType===types.Qb.ActionsBar||visualizationType===types.Qb.ActionsAreaGraph||visualizationType===types.Qb.ActionsStackedBar?component=(0,jsx_runtime.jsx)(LineGraph.x,{}):visualizationType===types.Qb.BoldNumber&&(component=(0,jsx_runtime.jsx)(BoldNumber.w,{})):component=(0,jsx_runtime.jsx)("div",{className:"flex flex-col flex-1 justify-center items-center border rounded bg-bg-light",children:(0,jsx_runtime.jsx)(Animation.f,{type:animations.ru.LaptopHog})}),(0,jsx_runtime.jsx)("div",{className:"h-full hide-scrollbar flex flex-1 gap-2",children:(0,jsx_runtime.jsxs)("div",{className:"relative w-full flex flex-col gap-4 flex-1",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 flex-row gap-4 overflow-scroll hide-scrollbar",children:[isChartSettingsPanelOpen&&(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(SideBar.K,{})}),(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("w-full h-full flex-1 overflow-auto"),children:visualizationType!==types.Qb.ActionsTable&&responseError?(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("rounded bg-bg-light relative flex flex-1 flex-col p-2",{border:showEditingUI}),children:(0,jsx_runtime.jsx)(EmptyStates.jC,{query:props.query,excludeDetail:!0,title:queryCancelled?"The query was cancelled":response&&"error"in response?response.error:responseError})}):component})]}),showResultControls&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 justify-between flex-wrap px-px py-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex gap-4 items-center"}),(0,jsx_runtime.jsx)("div",{className:"flex gap-4 items-center",children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 items-center flex-wrap",children:[(0,jsx_runtime.jsx)(TableDisplay.V,{}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGear,{}),type:isChartSettingsPanelOpen?"primary":"secondary",onClick:()=>toggleChartSettingsPanel(),tooltip:"Visualization settings"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>props.onSaveInsight(),children:"Create insight"})]})})]})})]})})}var Resizer=__webpack_require__("./frontend/src/lib/components/Resizer/Resizer.tsx"),CodeEditor=__webpack_require__("./frontend/src/lib/monaco/CodeEditor.tsx"),AutoSizer=__webpack_require__("./node_modules/.pnpm/react-virtualized@9.22.5_react-dom@18.2.0_react@18.2.0/node_modules/react-virtualized/dist/es/AutoSizer/index.js");function QueryPane(props){let{queryPaneHeight,queryPaneResizerProps}=(0,index_esm.useValues)(editorSizingLogic);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"relative flex flex-col w-full bg-bg-3000",style:{height:`${queryPaneHeight}px`},ref:queryPaneResizerProps.containerRef,children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(AutoSizer.q,{children:_ref=>{let{height,width}=_ref;return(0,jsx_runtime.jsx)(CodeEditor.p,{className:"border",language:"hogQL",value:props.queryInput,sourceQuery:props.sourceQuery,height:height,width:width,...props.codeEditorProps,options:{minimap:{enabled:!1},wordWrap:"on",scrollBeyondLastLine:!1,automaticLayout:!0,fixedOverflowWidgets:!0,suggest:{showInlineDetails:!0},quickSuggestionsDelay:300}})}})}),(0,jsx_runtime.jsx)(Resizer.w,{...queryPaneResizerProps})]})})}function QueryTabs(_ref){let{models,onClear,onClick,onAdd,activeModelUri}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-row overflow-scroll hide-scrollbar h-10",children:[models.map(model=>(0,jsx_runtime.jsx)(QueryTabComponent,{model:model,onClear:models.length>1?onClear:void 0,onClick:onClick,active:activeModelUri?.uri.path===model.uri.path},model.uri.path)),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>onAdd(),icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{fontSize:14})})]})}function QueryTabComponent(_ref2){var _model$view$name;let{model,active,onClear,onClick}=_ref2;return(0,jsx_runtime.jsxs)("button",{onClick:()=>onClick?.(model),className:(0,clsx_m.default)("space-y-px rounded-t p-1 flex flex-row items-center gap-1 hover:bg-[var(--bg-light)] cursor-pointer",active?"bg-[var(--bg-light)] border":"bg-bg-3000",onClear?"pl-3 pr-2":"px-3"),children:[null!==(_model$view$name=model.view?.name)&&void 0!==_model$view$name?_model$view$name:"Untitled",onClear&&(0,jsx_runtime.jsx)(src.Jp,{onClick:e=>{e.stopPropagation(),onClear(model)},size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{})})]})}function QueryWindow(){let[monacoAndEditor,setMonacoAndEditor]=(0,react.useState)(null),[monaco,editor]=null!=monacoAndEditor?monacoAndEditor:[],codeEditorKey=`hogQLQueryEditor/${lib.router.values.location.pathname}`,logic=(0,multitabEditorLogic.tg)({key:codeEditorKey,monaco,editor}),{allTabs,activeModelUri,queryInput,editingView,sourceQuery}=(0,index_esm.useValues)(logic),{selectTab,deleteTab,createTab,setQueryInput,runQuery,setError,setIsValidView}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 flex-col h-full",children:[(0,jsx_runtime.jsx)(QueryTabs,{models:allTabs,onClick:selectTab,onClear:deleteTab,onAdd:createTab,activeModelUri:activeModelUri}),editingView&&(0,jsx_runtime.jsx)("div",{className:"h-7 bg-warning-highlight p-1",children:(0,jsx_runtime.jsxs)("span",{children:[' Editing view "',editingView.name,'"']})}),(0,jsx_runtime.jsx)(QueryPane,{queryInput:queryInput,sourceQuery:sourceQuery.source,promptError:null,codeEditorProps:{queryKey:codeEditorKey,onChange:v=>{setQueryInput(null!=v?v:"")},onMount:(editor,monaco)=>{setMonacoAndEditor([monaco,editor])},onPressCmdEnter:(value,selectionType)=>{value&&"selection"===selectionType?runQuery(value):runQuery()},onError:(error,isValidView)=>{setError(error),setIsValidView(isValidView)}}}),(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:multitabEditorLogic.tg,props:{key:codeEditorKey,monaco,editor},children:(0,jsx_runtime.jsx)(InternalQueryWindow,{})})]})}function InternalQueryWindow(){let{cacheLoading,sourceQuery,queryInput}=(0,index_esm.useValues)(multitabEditorLogic.tg),{setSourceQuery}=(0,index_esm.useActions)(multitabEditorLogic.tg);if(cacheLoading)return(0,jsx_runtime.jsx)("div",{className:"flex-1 flex justify-center items-center",children:(0,jsx_runtime.jsx)(src.$j,{className:"text-3xl"})});let dataVisualizationLogicProps={key:multitabEditorLogic.cc,query:sourceQuery,dashboardId:void 0,dataNodeCollectionId:multitabEditorLogic.cc,insightMode:types.LO.Edit,loadPriority:void 0,cachedResults:void 0,variablesOverride:void 0,setQuery:setSourceQuery},dataNodeLogicProps={query:sourceQuery.source,key:multitabEditorLogic.cc,cachedResults:void 0,loadPriority:void 0,dataNodeCollectionId:multitabEditorLogic.cc,variablesOverride:void 0,autoLoad:!1},variablesLogicProps={key:dataVisualizationLogicProps.key,readOnly:!1,queryInput};return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:dataNodeLogic.M,props:dataNodeLogicProps,children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:dataVisualizationLogic.H8,props:dataVisualizationLogicProps,children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:displayLogic.Y,props:{key:dataVisualizationLogicProps.key},children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:variablesLogic.Q,props:variablesLogicProps,children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:variableModalLogic.b,props:{key:dataVisualizationLogicProps.key},children:(0,jsx_runtime.jsx)(OutputPane,{})})})})})})}function EditorScene(){let ref=(0,react.useRef)(null),navigatorRef=(0,react.useRef)(null),queryPaneRef=(0,react.useRef)(null),{activeNavbarItem}=(0,index_esm.useValues)(navigationLogic.f),{sidebarOverlayOpen}=(0,index_esm.useValues)(editorSceneLogic.h);return(0,jsx_runtime.jsxs)(index_esm.BindLogic,{logic:editorSizingLogic,props:{editorSceneRef:ref,navigatorRef,sourceNavigatorResizerProps:{containerRef:navigatorRef,logicKey:"source-navigator",placement:"right"},queryPaneResizerProps:{containerRef:queryPaneRef,logicKey:"query-pane",placement:"bottom"}},children:[(0,jsx_runtime.jsxs)("div",{className:"w-full h-full flex flex-row overflow-hidden",ref:ref,children:[activeNavbarItem&&(0,jsx_runtime.jsx)(Sidebar.Y,{navbarItem:activeNavbarItem,sidebarOverlay:(0,jsx_runtime.jsx)(EditorSidebarOverlay,{}),sidebarOverlayProps:{isOpen:sidebarOverlayOpen}},activeNavbarItem.identifier),(0,jsx_runtime.jsx)(QueryWindow,{})]}),(0,jsx_runtime.jsx)(ViewLinkModal.WI,{})]})}let EditorSidebarOverlay=()=>{let{setSidebarOverlayOpen}=(0,index_esm.useActions)(editorSceneLogic.h),{sidebarOverlayTreeItems,selectedSchema}=(0,index_esm.useValues)(editorSceneLogic.h);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsxs)("header",{className:"flex flex-row h-10 border-b shrink-0 p-1 gap-2",children:[(0,jsx_runtime.jsx)(LemonButton.J,{size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconArrowLeft,{}),onClick:()=>setSidebarOverlayOpen(!1)}),selectedSchema?.name&&(0,jsx_runtime.jsx)(CopyToClipboard.D,{className:"font-mono",tooltipMessage:null,description:"schema",iconStyle:{color:"var(--muted-alt)"},explicitValue:selectedSchema?.name,children:selectedSchema?.name})]}),(0,jsx_runtime.jsx)(DatabaseTableTree.E,{items:sidebarOverlayTreeItems})]})}}}]);