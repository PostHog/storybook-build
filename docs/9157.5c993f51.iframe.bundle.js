"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[9157],{"../../frontend/src/scenes/oauth/OAuthAuthorize.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{OAuthAuthorize:()=>OAuthAuthorize,OAuthAuthorizeError:()=>OAuthAuthorizeError,scene:()=>scene});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.26.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/index.ts"),ScopeAccessSelector=__webpack_require__("../../frontend/src/scenes/settings/user/scopes/ScopeAccessSelector.tsx"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/LemonToast.tsx"),lib_scopes=__webpack_require__("../../frontend/src/lib/scopes.tsx"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts");let oauthAuthorize=async values=>{try{let response=await api.ZP.create("/oauth/authorize/",{client_id:kea_router_lib.router.values.searchParams.client_id,redirect_uri:kea_router_lib.router.values.searchParams.redirect_uri,response_type:kea_router_lib.router.values.searchParams.response_type,state:kea_router_lib.router.values.searchParams.state,scope:kea_router_lib.router.values.searchParams.scope,code_challenge:kea_router_lib.router.values.searchParams.code_challenge,code_challenge_method:kea_router_lib.router.values.searchParams.code_challenge_method,nonce:kea_router_lib.router.values.searchParams.nonce,claims:kea_router_lib.router.values.searchParams.claims,scoped_organizations:"organizations"===values.access_type?values.scoped_organizations:[],scoped_teams:"teams"===values.access_type?values.scoped_teams:[],access_level:"all"===values.access_type?"all":"organizations"===values.access_type?"organization":"team",allow:values.allow});response.redirect_to&&(location.href=response.redirect_to)}catch(error){throw LemonToast.UJ.error("Something went wrong while authorizing the application"),error}},oauthAuthorizeLogic=(0,index_esm.kea)([(0,index_esm.path)(["oauth","authorize"]),(0,index_esm.connect)(()=>({values:[userLogic.userLogic,["user"]]})),(0,index_esm.actions)({setScopes:scopes=>({scopes}),cancel:()=>({})}),(0,kea_loaders_lib.loaders)({allTeams:[null,{loadAllTeams:async()=>await api.ZP.loadPaginatedResults("api/projects")}],oauthApplication:[null,{loadOAuthApplication:async()=>await api.ZP.oauthApplication.getPublicMetadata(kea_router_lib.router.values.searchParams.client_id)}]}),(0,index_esm.listeners)(_ref=>{let{values}=_ref;return{cancel:async()=>{await oauthAuthorize({scoped_organizations:values.oauthAuthorization.scoped_organizations,scoped_teams:values.oauthAuthorization.scoped_teams,access_type:values.oauthAuthorization.access_type,allow:!1})}}}),(0,index_esm.reducers)({scopes:[[],{setScopes:(_,_ref2)=>{let{scopes}=_ref2;return scopes}}]}),(0,lib.forms)(()=>({oauthAuthorization:{defaults:{scoped_organizations:[],scoped_teams:[],access_type:"all"},errors:_ref3=>{let{access_type,scoped_organizations,scoped_teams}=_ref3;return{access_type:access_type?void 0:"Select access mode",scoped_organizations:"organizations"!==access_type||scoped_organizations?.length?void 0:"Select at least one organization",scoped_teams:"teams"!==access_type||scoped_teams?.length?void 0:"Select at least one project"}},submit:async values=>{await oauthAuthorize({...values,allow:!0})}}})),(0,index_esm.selectors)(()=>({allOrganizations:[s=>[s.user],user=>{var _user$organizations;return null!==(_user$organizations=user?.organizations)&&void 0!==_user$organizations?_user$organizations:[]}],scopeDescriptions:[s=>[s.scopes],scopes=>(0,lib_scopes.Hr)(scopes).map(lib_scopes.rR)],redirectDomain:[s=>[s.oauthApplication],()=>{let redirectUri=kea_router_lib.router.values.searchParams.redirect_uri;if(!redirectUri)return"";try{return new URL(redirectUri).hostname}catch{return""}}]})),(0,kea_router_lib.urlToAction)(_ref4=>{let{actions}=_ref4;return{"/oauth/authorize":(_,searchParams)=>{var _searchParams$scope$s;let requestedScopes=null!==(_searchParams$scope$s=searchParams.scope?.split(" ")?.filter(scope=>scope.length))&&void 0!==_searchParams$scope$s?_searchParams$scope$s:[],scopes=0===requestedScopes.length?lib_scopes.Dm:requestedScopes;actions.setScopes(scopes),actions.loadOAuthApplication(),actions.loadAllTeams()}}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let OAuthAuthorizeError=_ref=>{let{title,description}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col items-center justify-center h-full gap-4 py-12",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconWarning,{className:"text-muted-alt text-4xl"}),(0,jsx_runtime.jsx)("div",{className:"text-xl font-semibold",children:title}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:description})]})},OAuthAuthorize=()=>{let{scopeDescriptions,oauthApplication,oauthApplicationLoading,allOrganizations,allTeams,oauthAuthorization,isOauthAuthorizationSubmitting,redirectDomain}=(0,index_esm.useValues)(oauthAuthorizeLogic),{cancel,submitOauthAuthorization}=(0,index_esm.useActions)(oauthAuthorizeLogic);return oauthApplicationLoading?(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center h-full py-12",children:(0,jsx_runtime.jsx)(Spinner.$,{})}):oauthApplication?(0,jsx_runtime.jsx)("div",{className:"flex flex-col items-center justify-center h-full",children:(0,jsx_runtime.jsxs)("div",{className:"max-w-2xl mx-auto py-12 px-6",children:[(0,jsx_runtime.jsxs)("div",{className:"text-center mb-8",children:[(0,jsx_runtime.jsxs)("h2",{className:"text-2xl font-semibold",children:["Authorize ",(0,jsx_runtime.jsx)("strong",{children:oauthApplication.name})]}),(0,jsx_runtime.jsxs)("p",{className:"text-muted mt-2",children:[oauthApplication.name," is requesting access to your data."]})]}),(0,jsx_runtime.jsx)(lib.Form,{logic:oauthAuthorizeLogic,formKey:"oauthAuthorization",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-6 bg-bg-light border border-border rounded p-6 shadow",children:[(0,jsx_runtime.jsx)(ScopeAccessSelector.Z,{accessType:oauthAuthorization.access_type,organizations:allOrganizations,teams:null!=allTeams?allTeams:void 0}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"text-sm font-semibold uppercase text-muted mb-2",children:"Requested Permissions"}),(0,jsx_runtime.jsxs)("ul",{className:"space-y-2",children:[scopeDescriptions.map((scopeDescription,idx)=>(0,jsx_runtime.jsxs)("li",{className:"flex items-center space-x-2 text-large",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCheck,{color:"var(--success)"}),(0,jsx_runtime.jsx)("span",{className:"font-medium",children:scopeDescription})]},idx)),(0,jsx_runtime.jsxs)("li",{className:"flex items-center space-x-2 text-large",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{color:"var(--danger)"}),(0,jsx_runtime.jsx)("span",{className:"font-medium",children:"Replace your dashboards with hedgehog memes"})]})]})]}),redirectDomain&&(0,jsx_runtime.jsxs)("div",{className:"text-xs text-muted",children:[(0,jsx_runtime.jsxs)("p",{children:["Once you authorize, you will be redirected to ",(0,jsx_runtime.jsx)("strong",{children:redirectDomain})]}),(0,jsx_runtime.jsxs)("p",{children:["The developer of ",oauthApplication.name,"'s privacy policy and terms of service apply to this application"]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-end space-x-2 pt-4",children:[(0,jsx_runtime.jsx)(LemonButton.J,{type:"tertiary",status:"alt",htmlType:"button",loading:isOauthAuthorizationSubmitting,disabledReason:isOauthAuthorizationSubmitting?"Processing...":void 0,onClick:e=>{e.preventDefault(),cancel()},children:"Cancel"}),(0,jsx_runtime.jsxs)(LemonButton.J,{type:"primary",htmlType:"submit",loading:isOauthAuthorizationSubmitting,disabledReason:isOauthAuthorizationSubmitting?"Authorizing...":void 0,onClick:()=>submitOauthAuthorization(),children:["Authorize ",oauthApplication?.name]})]})]})})]})}):(0,jsx_runtime.jsx)(OAuthAuthorizeError,{title:"No application found",description:"The application requesting access to your data does not exist."})},scene={component:OAuthAuthorize,logic:oauthAuthorizeLogic}}}]);