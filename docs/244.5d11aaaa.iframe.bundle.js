(window.webpackJsonp=window.webpackJsonp||[]).push([[244],{4487:function(module,exports,__webpack_require__){(exports=__webpack_require__(50)(!1)).push([module.i,'.mixin-gradient-overlay{width:100%;height:3rem;background:linear-gradient(0deg,#fff,transparent)}.mixin-gradient-overlay,.mixin-gradient-overlay-right{content:"";position:absolute;pointer-events:none;bottom:0}.mixin-gradient-overlay-right{width:3rem;height:100%;background:linear-gradient(270deg,#fff,transparent)}.text-ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:calc(100% - 8px)}.async-migrations-scene .migration-btn{cursor:pointer}.async-migrations-scene .success{color:#77b96c}.async-migrations-scene .danger{color:#f96132}.async-migrations-scene .warning{color:#f7a501}',""]),module.exports=exports},4724:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"scene",(function(){return scene})),__webpack_require__.d(__webpack_exports__,"tooltipMessageForStatus",(function(){return tooltipMessageForStatus})),__webpack_require__.d(__webpack_exports__,"AsyncMigrations",(function(){return AsyncMigrations_AsyncMigrations}));__webpack_require__(227),__webpack_require__(240),__webpack_require__(34),__webpack_require__(149),__webpack_require__(64);var AsyncMigrationStatus,AsyncMigrationsTab,injectStylesIntoStyleTag=__webpack_require__(18),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),AsyncMigrations=__webpack_require__(4487),AsyncMigrations_default=__webpack_require__.n(AsyncMigrations),options={insert:"head",singleton:!1},react=(injectStylesIntoStyleTag_default()(AsyncMigrations_default.a,options),AsyncMigrations_default.a.locals,__webpack_require__(0)),react_default=__webpack_require__.n(react),PageHeader=__webpack_require__(296),tabs=__webpack_require__(564),modal=__webpack_require__(1242),es_progress=__webpack_require__(2558),es_button=__webpack_require__(133),space=__webpack_require__(4255),table=__webpack_require__(2679),index_esm=__webpack_require__(1),defineProperty=(__webpack_require__(90),__webpack_require__(49),__webpack_require__(128),__webpack_require__(42),__webpack_require__(106),__webpack_require__(53),__webpack_require__(5)),defineProperty_default=__webpack_require__.n(defineProperty),slicedToArray=__webpack_require__(12),slicedToArray_default=__webpack_require__.n(slicedToArray),regenerator=__webpack_require__(8),regenerator_default=__webpack_require__.n(regenerator),asyncToGenerator=(__webpack_require__(70),__webpack_require__(13)),asyncToGenerator_default=__webpack_require__.n(asyncToGenerator),utils=__webpack_require__(11),api=__webpack_require__(22),userLogic=__webpack_require__(72);function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){defineProperty_default()(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}!function(AsyncMigrationStatus){AsyncMigrationStatus[AsyncMigrationStatus.NotStarted=0]="NotStarted",AsyncMigrationStatus[AsyncMigrationStatus.Running=1]="Running",AsyncMigrationStatus[AsyncMigrationStatus.CompletedSuccessfully=2]="CompletedSuccessfully",AsyncMigrationStatus[AsyncMigrationStatus.Errored=3]="Errored",AsyncMigrationStatus[AsyncMigrationStatus.RolledBack=4]="RolledBack",AsyncMigrationStatus[AsyncMigrationStatus.Starting=5]="Starting"}(AsyncMigrationStatus||(AsyncMigrationStatus={})),function(AsyncMigrationsTab){AsyncMigrationsTab.Management="management",AsyncMigrationsTab.Settings="settings"}(AsyncMigrationsTab||(AsyncMigrationsTab={}));var migrationStatusNumberToMessage={0:"Not started",1:"Running",2:"Completed successfully",3:"Errored",4:"Rolled back",5:"Starting"},asyncMigrationsLogic=Object(index_esm.kea)({path:["scenes","instance","AsyncMigrations","asyncMigrationsLogic"],actions:{triggerMigration:function triggerMigration(migrationId){return{migrationId:migrationId}},forceStopMigration:function forceStopMigration(migrationId){return{migrationId:migrationId}},setActiveTab:function setActiveTab(tab){return{tab:tab}},updateSetting:function updateSetting(settingKey,newValue){return{settingKey:settingKey,newValue:newValue}}},reducers:{activeTab:[AsyncMigrationsTab.Management,{setActiveTab:function setActiveTab(_,_ref){return _ref.tab}}]},loaders:function loaders(){return{asyncMigrations:[[],{loadAsyncMigrations:(_loadAsyncMigrations=asyncToGenerator_default()(regenerator_default.a.mark((function _callee(){var _userLogic$values$use;return regenerator_default.a.wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:if(null===(_userLogic$values$use=userLogic.a.values.user)||void 0===_userLogic$values$use?void 0:_userLogic$values$use.is_staff){_context.next=2;break}return _context.abrupt("return",[]);case 2:return _context.next=4,api.a.get("api/async_migrations");case 4:return _context.abrupt("return",_context.sent.results);case 5:case"end":return _context.stop()}}),_callee)}))),function loadAsyncMigrations(){return _loadAsyncMigrations.apply(this,arguments)})}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:(_loadAsyncMigrationSettings=asyncToGenerator_default()(regenerator_default.a.mark((function _callee2(){var _userLogic$values$use2,settingsResult,settings,_i,_Object$entries,_Object$entries$_i,key,config;return regenerator_default.a.wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(null===(_userLogic$values$use2=userLogic.a.values.user)||void 0===_userLogic$values$use2?void 0:_userLogic$values$use2.is_staff){_context2.next=2;break}return _context2.abrupt("return",[]);case 2:return _context2.next=4,api.a.get("api/instance_settings");case 4:for(settingsResult=_context2.sent,settings=[],_i=0,_Object$entries=Object.entries(settingsResult);_i<_Object$entries.length;_i++)_Object$entries$_i=slicedToArray_default()(_Object$entries[_i],2),key=_Object$entries$_i[0],config=_Object$entries$_i[1],key.includes("ASYNC_MIGRATIONS")&&settings.push(_objectSpread({key:key},config));return _context2.abrupt("return",settings);case 8:case"end":return _context2.stop()}}),_callee2)}))),function loadAsyncMigrationSettings(){return _loadAsyncMigrationSettings.apply(this,arguments)})}]};var _loadAsyncMigrationSettings,_loadAsyncMigrations},listeners:function listeners(_ref2){var _updateSetting,_forceStopMigration,_triggerMigration,actions=_ref2.actions;return{triggerMigration:(_triggerMigration=asyncToGenerator_default()(regenerator_default.a.mark((function _callee3(_ref3){var migrationId,res;return regenerator_default.a.wrap((function _callee3$(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return migrationId=_ref3.migrationId,_context3.next=3,api.a.create("/api/async_migrations/".concat(migrationId,"/trigger"));case 3:(res=_context3.sent).success?(Object(utils.tb)("Migration triggered successfully"),actions.loadAsyncMigrations()):Object(utils.y)("Failed to trigger migration",res.error);case 5:case"end":return _context3.stop()}}),_callee3)}))),function triggerMigration(_x){return _triggerMigration.apply(this,arguments)}),forceStopMigration:(_forceStopMigration=asyncToGenerator_default()(regenerator_default.a.mark((function _callee4(_ref4){var migrationId,res;return regenerator_default.a.wrap((function _callee4$(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return migrationId=_ref4.migrationId,_context4.next=3,api.a.create("/api/async_migrations/".concat(migrationId,"/force_stop"));case 3:(res=_context4.sent).success?(Object(utils.tb)("Force stop triggered successfully"),actions.loadAsyncMigrations()):Object(utils.y)("Failed to trigger force stop",res.error);case 5:case"end":return _context4.stop()}}),_callee4)}))),function forceStopMigration(_x2){return _forceStopMigration.apply(this,arguments)}),updateSetting:(_updateSetting=asyncToGenerator_default()(regenerator_default.a.mark((function _callee5(_ref5){var settingKey,newValue,res;return regenerator_default.a.wrap((function _callee5$(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:return settingKey=_ref5.settingKey,newValue=_ref5.newValue,_context5.next=3,api.a.create("/api/instance_settings/update_setting",{key:settingKey,value:newValue});case 3:1===(res=_context5.sent).status?(Object(utils.tb)("Setting updated successfully"),actions.loadAsyncMigrationSettings()):Object(utils.y)("Failed to trigger migration",res.error);case 5:case"end":return _context5.stop()}}),_callee5)}))),function updateSetting(_x3){return _updateSetting.apply(this,arguments)})}},events:function events(_ref6){var actions=_ref6.actions;return{afterMount:function afterMount(){actions.loadAsyncMigrations(),actions.loadAsyncMigrationSettings()}}}}),PlayCircleOutlined=__webpack_require__(4316),StopOutlined=__webpack_require__(4218),CheckCircleOutlined=__webpack_require__(456),RedoOutlined=__webpack_require__(4259),InfoCircleOutlined=__webpack_require__(632),Tooltip=__webpack_require__(46),Spinner=__webpack_require__(206),row=__webpack_require__(380),col=__webpack_require__(347),input=__webpack_require__(458),divider=__webpack_require__(4207);function SettingUpdateField(_ref){var setting=_ref.setting,updateSetting=Object(index_esm.useActions)(asyncMigrationsLogic).updateSetting,_useState=Object(react.useState)(String(setting.value)),_useState2=slicedToArray_default()(_useState,2),inputValue=_useState2[0],setInputValue=_useState2[1];return react_default.a.createElement("div",{key:setting.key},react_default.a.createElement("h4",null,setting.key),react_default.a.createElement("p",null,setting.description),react_default.a.createElement(row.a,{gutter:[8,8]},react_default.a.createElement(col.a,{span:8},react_default.a.createElement(input.a,{value:inputValue,onChange:function onChange(e){return setInputValue(e.target.value)}})),react_default.a.createElement(col.a,{span:16},react_default.a.createElement(es_button.a,{disabled:String(setting.value)===inputValue,type:"primary",onClick:function onClick(){return updateSetting(setting.key,inputValue)}},"Update"))),react_default.a.createElement(divider.a,null))}try{SettingUpdateField.displayName="SettingUpdateField",SettingUpdateField.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"AsyncMigrationsSetting"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:SettingUpdateField.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(__react_docgen_typescript_loader_error){}var scene={component:AsyncMigrations_AsyncMigrations},TabPane=tabs.a.TabPane,tooltipMessageForStatus={0:"Run migration",1:"Force stop migration",2:"Migration completed",3:"Re-run migration",4:"Re-run migration"};function AsyncMigrations_AsyncMigrations(){var user=Object(index_esm.useValues)(userLogic.a).user,_useValues2=Object(index_esm.useValues)(asyncMigrationsLogic),asyncMigrations=_useValues2.asyncMigrations,asyncMigrationsLoading=_useValues2.asyncMigrationsLoading,activeTab=_useValues2.activeTab,asyncMigrationSettings=_useValues2.asyncMigrationSettings,_useActions=Object(index_esm.useActions)(asyncMigrationsLogic),triggerMigration=_useActions.triggerMigration,forceStopMigration=_useActions.forceStopMigration,loadAsyncMigrations=_useActions.loadAsyncMigrations,setActiveTab=_useActions.setActiveTab,columns=[{title:"",render:function RenderTriggerButton(asyncMigration){var status=asyncMigration.status;return react_default.a.createElement(Tooltip.a,{title:tooltipMessageForStatus[status]},0===status?react_default.a.createElement(PlayCircleOutlined.a,{className:"migration-btn success",onClick:function onClick(){return triggerMigration(asyncMigration.id)}}):1===status?react_default.a.createElement(StopOutlined.a,{className:"migration-btn danger",onClick:function onClick(){return forceStopMigration(asyncMigration.id)}}):2===status?react_default.a.createElement(CheckCircleOutlined.a,{className:"success"}):3===status||4===status?react_default.a.createElement(RedoOutlined.a,{className:"migration-btn warning",onClick:function onClick(){return triggerMigration(asyncMigration.id)}}):5===status?react_default.a.createElement(Spinner.a,{size:"sm"}):null)}},{title:"Migration name",dataIndex:"name"},{title:"Description",render:function RenderError(asyncMigration){var description=asyncMigration.description;return react_default.a.createElement("small",null,react_default.a.createElement("span",null,description.slice(0,40)),description.length>40?react_default.a.createElement("a",{onClick:function onClick(){modal.a.info({title:"'".concat(asyncMigration.name,"' description"),content:react_default.a.createElement("pre",null,description),icon:react_default.a.createElement(InfoCircleOutlined.a,null),okText:"Close",width:"80%"})}}," [...]"):null)}},{title:"Progress",dataIndex:"progress",render:function RenderMigrationProgress(progress){return react_default.a.createElement("div",null,react_default.a.createElement(es_progress.a,{percent:progress}))}},{title:"Status",dataIndex:"status",render:function RenderMigrationStatus(status){return react_default.a.createElement("div",null,migrationStatusNumberToMessage[status])}},{title:"Error",render:function RenderError(asyncMigration){var error=asyncMigration.last_error||"";return react_default.a.createElement("small",null,react_default.a.createElement("span",null,error.slice(0,40)),error.length>40?react_default.a.createElement("a",{onClick:function onClick(){modal.a.info({title:"Error on migration '".concat(asyncMigration.name,"'"),content:react_default.a.createElement("pre",null,error),icon:react_default.a.createElement(InfoCircleOutlined.a,null),okText:"Close",width:"80%"})}}," [...]"):null)}},{title:"Last operation index",dataIndex:"current_operation_index"},{title:"Last query ID",dataIndex:"current_query_id",render:function RenderQueryId(queryId){return react_default.a.createElement("div",null,react_default.a.createElement("small",null,queryId))}},{title:"Celery task ID",dataIndex:"celery_task_id",render:function RenderCeleryTaskId(celeryTaskId){return react_default.a.createElement("div",null,react_default.a.createElement("small",null,celeryTaskId))}},{title:"Started at",dataIndex:"started_at",render:function RenderStartedAt(startedAt){return react_default.a.createElement("div",null,Object(utils.I)(startedAt))}},{title:"Finished at",dataIndex:"finished_at",render:function RenderFinishedAt(finishedAt){return react_default.a.createElement("div",null,Object(utils.I)(finishedAt))}}];return react_default.a.createElement("div",{className:"async-migrations-scene"},(null==user?void 0:user.is_staff)?react_default.a.createElement(react_default.a.Fragment,null,react_default.a.createElement(PageHeader.a,{title:"Async Migrations",caption:react_default.a.createElement(react_default.a.Fragment,null,react_default.a.createElement("p",null,"Manage async migrations in your instance."),react_default.a.createElement("p",null,"Read about async migrations on our"," ",react_default.a.createElement("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations"},"dedicated docs page"),"."))}),react_default.a.createElement(tabs.a,{activeKey:activeTab,onChange:function onChange(t){return setActiveTab(t)}},react_default.a.createElement(TabPane,{tab:"Management",key:AsyncMigrationsTab.Management}),react_default.a.createElement(TabPane,{tab:"Settings",key:AsyncMigrationsTab.Settings})),activeTab===AsyncMigrationsTab.Management?react_default.a.createElement(react_default.a.Fragment,null,react_default.a.createElement("div",{className:"mb float-right"},react_default.a.createElement(es_button.a,{icon:asyncMigrationsLoading?react_default.a.createElement(Spinner.a,{size:"sm"}):react_default.a.createElement(RedoOutlined.a,null),onClick:loadAsyncMigrations},"Refresh")),react_default.a.createElement(space.b,null),react_default.a.createElement(table.a,{pagination:!1,loading:asyncMigrationsLoading,columns:columns,dataSource:asyncMigrations})):activeTab===AsyncMigrationsTab.Settings?react_default.a.createElement(react_default.a.Fragment,null,react_default.a.createElement("br",null),asyncMigrationSettings.map((function(setting){return react_default.a.createElement("div",{key:setting.key},react_default.a.createElement(SettingUpdateField,{setting:setting}))}))):null):react_default.a.createElement(PageHeader.a,{title:"Async Migrations",caption:react_default.a.createElement(react_default.a.Fragment,null,react_default.a.createElement("p",null,"Only users with staff access can manage async migrations. Please contact your instance admin."),react_default.a.createElement("p",null,"If you're an admin and don't have access, set ",react_default.a.createElement("code",null,"is_staff=true")," for your user on the PostgreSQL ",react_default.a.createElement("code",null,"posthog_user")," table."))}))}}}]);