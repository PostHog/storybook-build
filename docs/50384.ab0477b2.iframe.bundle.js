"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[50384],{"../../frontend/src/scenes/debug/DebugScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{DebugScene:()=>DebugScene,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonLabel=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonLabel/LemonLabel.tsx"),LemonSelect=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSelect/index.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),HogDebug=__webpack_require__("../../frontend/src/scenes/debug/HogDebug.tsx"),LemonDivider=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonDivider/index.ts"),lemon_ui_LemonLabel=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonLabel/index.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function Modifiers(_ref){var _query$modifiers$pers,_query$modifiers$pers2,_query$modifiers$inCo,_query$modifiers$mate,_query$modifiers$opti,_query$modifiers$prop;let{setQuery,query,response=null}=_ref;if(null===query)return null;let labelClassName="flex flex-col gap-1 items-start";return(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsxs)(lemon_ui_LemonLabel.H,{className:labelClassName,children:[(0,jsx_runtime.jsx)("div",{children:"POE:"}),(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:[{value:"disabled",label:"Disabled"},{value:"person_id_no_override_properties_on_events",label:"Properties: Events, Person ID: Events"},{value:"person_id_override_properties_on_events",label:"Properties: Events, Person ID: Overrides (v2)"},{value:"person_id_override_properties_joined",label:"Properties: Person, Person ID: Overrides (v3)"}],onChange:value=>setQuery({...query,modifiers:{...query.modifiers,personsOnEventsMode:value}}),value:null!==(_query$modifiers$pers=query.modifiers?.personsOnEventsMode)&&void 0!==_query$modifiers$pers?_query$modifiers$pers:response?.modifiers?.personsOnEventsMode})]}),(0,jsx_runtime.jsxs)(lemon_ui_LemonLabel.H,{className:labelClassName,children:[(0,jsx_runtime.jsx)("div",{children:"Persons ArgMax:"}),(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:[{value:"v1",label:"V1"},{value:"v2",label:"V2"}],onChange:value=>setQuery({...query,modifiers:{...query.modifiers,personsArgMaxVersion:value}}),value:null!==(_query$modifiers$pers2=query.modifiers?.personsArgMaxVersion)&&void 0!==_query$modifiers$pers2?_query$modifiers$pers2:response?.modifiers?.personsArgMaxVersion})]}),(0,jsx_runtime.jsxs)(lemon_ui_LemonLabel.H,{className:labelClassName,children:[(0,jsx_runtime.jsx)("div",{children:"In Cohort Via:"}),(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:[{value:"auto",label:"auto"},{value:"leftjoin",label:"leftjoin"},{value:"subquery",label:"subquery"},{value:"leftjoin_conjoined",label:"leftjoin conjoined"}],onChange:value=>setQuery({...query,modifiers:{...query.modifiers,inCohortVia:value}}),value:null!==(_query$modifiers$inCo=query.modifiers?.inCohortVia)&&void 0!==_query$modifiers$inCo?_query$modifiers$inCo:response?.modifiers?.inCohortVia})]}),(0,jsx_runtime.jsxs)(lemon_ui_LemonLabel.H,{className:labelClassName,children:[(0,jsx_runtime.jsx)("div",{children:"Materialization Mode:"}),(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:[{value:"auto",label:"auto"},{value:"legacy_null_as_string",label:"legacy_null_as_string"},{value:"legacy_null_as_null",label:"legacy_null_as_null"},{value:"disabled",label:"disabled"}],onChange:value=>setQuery({...query,modifiers:{...query.modifiers,materializationMode:value}}),value:null!==(_query$modifiers$mate=query.modifiers?.materializationMode)&&void 0!==_query$modifiers$mate?_query$modifiers$mate:response?.modifiers?.materializationMode})]}),(0,jsx_runtime.jsxs)(lemon_ui_LemonLabel.H,{className:labelClassName,children:[(0,jsx_runtime.jsx)("div",{children:"Optimize joined filters:"}),(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:[{value:!0,label:"true"},{value:!1,label:"false"}],onChange:value=>setQuery({...query,modifiers:{...query.modifiers,optimizeJoinedFilters:value}}),value:null!==(_query$modifiers$opti=query.modifiers?.optimizeJoinedFilters)&&void 0!==_query$modifiers$opti?_query$modifiers$opti:response?.modifiers?.optimizeJoinedFilters})]}),(0,jsx_runtime.jsxs)(lemon_ui_LemonLabel.H,{className:labelClassName,children:[(0,jsx_runtime.jsx)("div",{children:"Property Groups:"}),(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:[{value:"enabled",label:"Enabled"},{value:"disabled",label:"Disabled"},{value:"optimized",label:"Enabled, with Optimizations"}],onChange:value=>setQuery({...query,modifiers:{...query.modifiers,propertyGroupsMode:value}}),value:null!==(_query$modifiers$prop=query.modifiers?.propertyGroupsMode)&&void 0!==_query$modifiers$prop?_query$modifiers$prop:response?.modifiers?.propertyGroupsMode})]})]})}var dataNodeLogic=__webpack_require__("../../frontend/src/queries/nodes/DataNode/dataNodeLogic.ts"),DateRange=__webpack_require__("../../frontend/src/queries/nodes/DataNode/DateRange.tsx"),ElapsedTime=__webpack_require__("../../frontend/src/queries/nodes/DataNode/ElapsedTime.tsx"),Reload=__webpack_require__("../../frontend/src/queries/nodes/DataNode/Reload.tsx"),EventPropertyFilters=__webpack_require__("../../frontend/src/queries/nodes/EventsNode/EventPropertyFilters.tsx"),HogQLQueryEditor=__webpack_require__("../../frontend/src/queries/nodes/HogQLQuery/HogQLQueryEditor.tsx"),CodeSnippet=__webpack_require__("../../frontend/src/lib/components/CodeSnippet/index.ts"),LemonTable=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/index.ts"),LemonTabs=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTabs/index.ts"),LemonTag=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTag/index.ts"),CodeEditor=__webpack_require__("../../frontend/src/lib/monaco/CodeEditor.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),ErrorBoundary=__webpack_require__("../../frontend/src/layout/ErrorBoundary/index.ts"),Query=__webpack_require__("../../frontend/src/queries/Query/Query.tsx"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),utils=__webpack_require__("../../frontend/src/queries/utils.ts");function toLineColumn(hogql,position){let lines=hogql.split("\n"),line=0,column=0;for(let i=0;i<lines.length;i++){if(position<lines[i].length){line=i+1,column=position+1;break}position-=lines[i].length+1}return{line,column}}function toLine(hogql,position){return toLineColumn(hogql,position).line}function toColumn(hogql,position){return toLineColumn(hogql,position).column}function QueryTabs(_ref){var _find$t,_find$t2,_find$t3;let{query,queryKey,setQuery,response}=_ref,[tab,setTab]=(0,react.useState)(null),clickHouseTime=null!==(_find$t=response?.timings?.find(_ref2=>{let{k}=_ref2;return"./clickhouse_execute"===k})?.t)&&void 0!==_find$t?_find$t:0,explainTime=null!==(_find$t2=response?.timings?.find(_ref3=>{let{k}=_ref3;return"./explain"===k})?.t)&&void 0!==_find$t2?_find$t2:0,hogQLTime=(null!==(_find$t3=response?.timings?.find(_ref4=>{let{k}=_ref4;return"."===k})?.t)&&void 0!==_find$t3?_find$t3:0)-explainTime-clickHouseTime,tabs=query?[response?.error&&{key:"error",label:"Error",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("h2",{className:"text-danger",children:"Error Running Query!"}),(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Text,wrap:!0,children:response.error})]})},(0,utils.KN)(query)&&{key:"viz",label:"Visualization",content:(0,jsx_runtime.jsx)(Query.A,{uniqueKey:queryKey,query:query,setQuery:query=>setQuery(query),context:{insightProps:{dashboardItemId:queryKey,query,setQuery:query=>setQuery(query),dataNodeCollectionId:queryKey}}})},(0,utils.Yg)(query)&&{key:"insight",label:"Insight",content:(0,jsx_runtime.jsx)(Query.A,{uniqueKey:queryKey,query:{kind:schema_general.OH.InsightVizNode,source:query,full:!0},setQuery:query=>setQuery(query)})},(0,utils.TC)(query)&&{key:"table",label:"Data Table",content:(0,jsx_runtime.jsx)(Query.A,{uniqueKey:queryKey,query:query,setQuery:query=>setQuery(query)})},(response?.result||response?.results)&&{key:"result",label:"Result JSON",content:(0,jsx_runtime.jsx)(CodeEditor.p,{className:"border",language:"json",value:JSON.stringify(response?.result||response?.results,null,2),height:500,path:`debug/${queryKey}/result.json`})},response?.hogql&&{key:"hogql",label:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["HogQL",hogQLTime&&(0,jsx_runtime.jsxs)(LemonTag.o,{className:"ml-2",children:[Math.floor(10*hogQLTime)/10,"s"]})]}),content:(0,jsx_runtime.jsx)(CodeEditor.p,{className:"border",language:"sql",value:String(response.hogql),height:500,path:`debug/${queryKey}/hogql.sql`})},response?.clickhouse&&{key:"clickhouse",label:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Clickhouse",clickHouseTime&&(0,jsx_runtime.jsxs)(LemonTag.o,{className:"ml-2",children:[Math.floor(10*clickHouseTime)/10,"s"]})]}),content:(0,jsx_runtime.jsx)(CodeEditor.p,{className:"border",language:"sql",value:String(response.clickhouse),height:500,path:`debug/${queryKey}/hogql.sql`})},response?.explain&&{key:"explain",label:"Explain",content:(0,jsx_runtime.jsx)(CodeSnippet.O,{wrap:!0,children:response.explain.join("\n")})},response?.timings&&{key:"timings",label:"Timings",content:(0,jsx_runtime.jsx)(ElapsedTime.F,{timings:response?.timings,elapsedTime:response?.elapsedTime})},response&&{key:"response",label:"Full response",content:(0,jsx_runtime.jsx)(CodeEditor.p,{className:"border",language:"json",value:JSON.stringify(response,null,2),height:500,path:`debug/${queryKey}/response.json`})},response?.metadata&&{key:"metadata",label:"Metadata",content:(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:[...response.metadata.errors.map(error=>{var _response$hogql,_error$start,_response$hogql2,_error$start2;return{type:"error",line:toLine(null!==(_response$hogql=response.hogql)&&void 0!==_response$hogql?_response$hogql:"",null!==(_error$start=error.start)&&void 0!==_error$start?_error$start:0),column:toColumn(null!==(_response$hogql2=response.hogql)&&void 0!==_response$hogql2?_response$hogql2:"",null!==(_error$start2=error.start)&&void 0!==_error$start2?_error$start2:0),...error}}),...response.metadata.warnings.map(warn=>{var _response$hogql3,_warn$start,_response$hogql4,_warn$start2;return{type:"warning",line:toLine(null!==(_response$hogql3=response.hogql)&&void 0!==_response$hogql3?_response$hogql3:"",null!==(_warn$start=warn.start)&&void 0!==_warn$start?_warn$start:0),column:toColumn(null!==(_response$hogql4=response.hogql)&&void 0!==_response$hogql4?_response$hogql4:"",null!==(_warn$start2=warn.start)&&void 0!==_warn$start2?_warn$start2:0),...warn}}),...response.metadata.notices.map(notice=>{var _response$hogql5,_notice$start,_response$hogql6,_notice$start2;return{type:"notice",line:toLine(null!==(_response$hogql5=response.hogql)&&void 0!==_response$hogql5?_response$hogql5:"",null!==(_notice$start=notice.start)&&void 0!==_notice$start?_notice$start:0),column:toColumn(null!==(_response$hogql6=response.hogql)&&void 0!==_response$hogql6?_response$hogql6:"",null!==(_notice$start2=notice.start)&&void 0!==_notice$start2?_notice$start2:0),...notice}})].sort((a,b)=>{var _a$start,_b$start;return(null!==(_a$start=a.start)&&void 0!==_a$start?_a$start:0)-(null!==(_b$start=b.start)&&void 0!==_b$start?_b$start:0)}),columns:[{title:"Line",dataIndex:"line",key:"line",width:"40px"},{title:"Column",dataIndex:"column",key:"column",width:"40px"},{title:"Type",dataIndex:"type",key:"type",width:"80px"},{title:"Message",dataIndex:"message",key:"message"}]})}].filter(Boolean).map(tab=>({...tab,content:(0,jsx_runtime.jsx)(ErrorBoundary.S,{children:tab.content})})):[];return(0,jsx_runtime.jsx)(ErrorBoundary.S,{children:(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:tab&&tabs.find(t=>t&&t.key===tab)?tab:tabs[0]&&tabs[0].key||"response",onChange:t=>setTab(t),tabs:tabs})})}function HogQLDebug(_ref){let{query,setQuery,queryKey}=_ref,dataNodeLogicProps={query,key:queryKey,dataNodeCollectionId:queryKey},{dataLoading,response:_response}=(0,index_esm.useValues)((0,dataNodeLogic.M)(dataNodeLogicProps));return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:dataNodeLogic.M,props:dataNodeLogicProps,children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)(HogQLQueryEditor.n,{query:query,setQuery:setQuery}),(0,jsx_runtime.jsx)(Modifiers,{setQuery:setQuery,query:query,response:_response}),(0,jsx_runtime.jsx)(LemonDivider.p,{className:"my-4"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-2 ",children:[(0,jsx_runtime.jsx)(Reload.L,{}),(0,jsx_runtime.jsx)(DateRange.C,{query:query,setQuery:setQuery},"date-range"),(0,jsx_runtime.jsx)(EventPropertyFilters.H,{query:query,setQuery:setQuery},"event-property")]}),dataLoading?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("h2",{children:"Running query..."}),(0,jsx_runtime.jsxs)("div",{className:"flex",children:["Time elapsed:Â ",(0,jsx_runtime.jsx)(ElapsedTime.W,{})]})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(QueryTabs,{query:query,response:_response,setQuery:setQuery,queryKey:queryKey})})]})})}var InsightViz=__webpack_require__("../../frontend/src/queries/nodes/InsightViz/InsightViz.tsx"),QueryEditor=__webpack_require__("../../frontend/src/queries/QueryEditor/QueryEditor.tsx");function DebugSceneQuery(_ref){var _parsed$source;let{query,setQuery,queryKey}=_ref,parsed=null;try{parsed=JSON.parse(query)}catch(e){}let dataNode=parsed&&((0,utils.KN)(parsed)||(0,utils.TC)(parsed))?parsed.source:parsed,dataNodeKey=(0,InsightViz.gG)({dashboardItemId:queryKey}),{response}=(0,index_esm.useValues)((0,dataNodeLogic.M)({query:dataNode,key:dataNodeKey,dataNodeCollectionId:queryKey,modifiers:{debug:!0}}));return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,utils.GD)(parsed)?(0,jsx_runtime.jsx)(HogDebug.O,{queryKey:queryKey,query:parsed,setQuery:query=>setQuery(JSON.stringify(query,null,2)),debug:!0}):(0,utils.Vf)(parsed)?(0,jsx_runtime.jsx)(HogQLDebug,{queryKey:queryKey,query:parsed,setQuery:query=>setQuery(JSON.stringify(query,null,2))}):(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,jsx_runtime.jsx)(QueryEditor.W,{query:query,setQuery:setQuery,aboveButton:(0,jsx_runtime.jsx)(Modifiers,{setQuery:parsed&&"source"in parsed&&parsed?.source?query=>setQuery(JSON.stringify({...parsed,source:query},null,2)):query=>setQuery(JSON.stringify(query,null,2)),query:null!==(_parsed$source=parsed?.source)&&void 0!==_parsed$source?_parsed$source:parsed,response:response})}),parsed?(0,jsx_runtime.jsx)(QueryTabs,{query:parsed,queryKey:queryKey,response:response,setQuery:query=>setQuery(JSON.stringify(query,null,2))}):null]})})}var examples=__webpack_require__("../../frontend/src/queries/examples.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts");let DEFAULT_QUERY=examples.Os.HogQLRaw,debugSceneLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","query","debugSceneLogic"]),(0,index_esm.actions)({setQuery1:query=>({query:query}),setQuery2:query=>({query:query})}),(0,index_esm.reducers)({query1:[DEFAULT_QUERY,{setQuery1:(_,_ref)=>{let{query}=_ref;return query}}],query2:[DEFAULT_QUERY,{setQuery2:(_,_ref2)=>{let{query}=_ref2;return query}}]}),(0,lib.actionToUrl)(_ref3=>{let{values}=_ref3;return{setQuery1:_ref4=>{let{query}=_ref4;return[urls.j.debugQuery(),{},{q:query,...values.query2?{q2:values.query2}:{}},{replace:!0}]},setQuery2:()=>[urls.j.debugQuery(),{},{q:values.query1,q2:values.query2},{replace:!0}]}}),(0,lib.urlToAction)(_ref5=>{let{actions,values}=_ref5;return{[urls.j.debugQuery()]:(_,__,_ref6)=>{var _values$query;let{q,q2}=_ref6;q&&q!==values.query1&&actions.setQuery1(q),(null!=q2?q2:"")!==(null!==(_values$query=values.query2)&&void 0!==_values$query?_values$query:"")&&actions.setQuery2(null!=q2?q2:"")}}})]);function DebugScene(){let{query1,query2}=(0,index_esm.useValues)(debugSceneLogic),{setQuery1,setQuery2}=(0,index_esm.useActions)(debugSceneLogic),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.featureFlagLogic);return(0,jsx_runtime.jsxs)("div",{className:"QueryScene",children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{active:!!query2,onClick:()=>query2?setQuery2(""):setQuery2(query1),children:"Split"}),(0,jsx_runtime.jsx)(LemonButton.J,{active:query1===examples.Os.HogQLRaw,onClick:()=>setQuery1(examples.Os.HogQLRaw),children:"HogQL Debug"}),featureFlags[constants.y8.HOG]?(0,jsx_runtime.jsx)(LemonButton.J,{active:query1===examples.Os.Hoggonacci,onClick:()=>setQuery1(examples.Os.Hoggonacci),children:"Hog"}):null,(0,jsx_runtime.jsx)(LemonButton.J,{active:query1===examples.Os.HogQLTable,onClick:()=>setQuery1(examples.Os.HogQLTable),children:"HogQL Table"}),(0,jsx_runtime.jsx)(LemonButton.J,{active:query1===examples.Os.Events,onClick:()=>setQuery1(examples.Os.Events),children:"Any Query"}),(0,jsx_runtime.jsx)(LemonLabel.H,{children:(0,jsx_runtime.jsx)(LemonSelect.Yv,{placeholder:"More sample queries",options:Object.entries(examples.Os).filter(_ref=>{let[k]=_ref;return"HogQLTable"!==k&&"HogQLRaw"!==k}).map(_ref2=>{let[k,v]=_ref2;return{label:k,value:v}}),onChange:v=>{v&&setQuery1(v)}})})]})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1 w-1/2",children:(0,jsx_runtime.jsx)(DebugSceneQuery,{query:query1,setQuery:setQuery1,queryKey:"new-hogql-debug-1"})}),query2?(0,jsx_runtime.jsx)("div",{className:"flex-1 w-1/2",children:(0,jsx_runtime.jsx)(DebugSceneQuery,{query:query2,setQuery:setQuery2,queryKey:"new-hogql-debug-2"})}):null]})]})}let scene={component:DebugScene,logic:debugSceneLogic}}}]);