"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[35599],{"../../products/revenue_analytics/frontend/RevenueAnalyticsScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{RevenueAnalyticsScene:()=>RevenueAnalyticsScene,RevenueAnalyticsSceneContent:()=>RevenueAnalyticsSceneContent,scene:()=>scene});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.11.7_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),ProductIntroduction=__webpack_require__("../../frontend/src/lib/components/ProductIntroduction/ProductIntroduction.tsx"),css_classes=__webpack_require__("../../frontend/src/lib/utils/css-classes.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),navigationLogic=__webpack_require__("../../frontend/src/layout/navigation/navigationLogic.ts"),dataNodeCollectionLogic=__webpack_require__("../../frontend/src/queries/nodes/DataNode/dataNodeCollectionLogic.ts"),types=__webpack_require__("../../frontend/src/types.ts"),DateFilter=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),DateFilter_types=__webpack_require__("../../frontend/src/lib/components/DateFilter/types.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),DataWarehouseSourceIcon=__webpack_require__("../../frontend/src/scenes/data-warehouse/settings/DataWarehouseSourceIcon.tsx"),Reload=__webpack_require__("../../frontend/src/queries/nodes/DataNode/Reload.tsx"),revenueAnalyticsLogic=__webpack_require__("../../products/revenue_analytics/frontend/revenueAnalyticsLogic.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let DATE_FILTER_DATE_OPTIONS=[{key:DateFilter_types.Q2,values:[]},{key:"Month to date",values:["mStart"],getFormattedDate:date=>date.startOf("d").format(utils.zT),defaultInterval:"day"},{key:"Last month",values:["-1mStart","-1mEnd"],getFormattedDate:date=>(0,utils._Q)(date.subtract(1,"month").startOf("month"),date.subtract(1,"month").endOf("month")),defaultInterval:"day"},{key:"Year to date",values:["yStart"],getFormattedDate:date=>(0,utils._Q)(date.startOf("y"),date.endOf("y")),defaultInterval:"month"},{key:"Previous year",values:["-1yStart","-1yEnd"],getFormattedDate:date=>(0,utils._Q)(date.subtract(1,"year").startOf("y"),date.subtract(1,"year").endOf("y")),defaultInterval:"month"},{key:"All time",values:["all"],defaultInterval:"month"}],buildEvents=(allEvents,state)=>allEvents.reduce((acc,event)=>(event.eventName in acc||(acc[event.eventName]=!0),acc),state),buildDataWarehouseSources=(allDataWarehouseSources,state)=>allDataWarehouseSources.reduce((acc,source)=>(source.id in acc||(acc[source.id]=!0),acc),state),RevenueAnalyticsFilters=()=>{let{dateFilter:{dateTo,dateFrom}}=(0,index_esm.useValues)(revenueAnalyticsLogic.Km),{setDates}=(0,index_esm.useActions)(revenueAnalyticsLogic.Km);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-row w-full justify-between gap-1",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,jsx_runtime.jsx)(DateFilter.f,{dateFrom:dateFrom,dateTo:dateTo,onChange:setDates,dateOptions:DATE_FILTER_DATE_OPTIONS}),(0,jsx_runtime.jsx)(src.u,{title:"Refresh data",children:(0,jsx_runtime.jsx)(Reload.H,{iconOnly:!0})})]}),(0,jsx_runtime.jsx)(RevenueAnalyticsFiltersModal,{})]})},RevenueAnalyticsFiltersModal=()=>{let{allEvents,allDataWarehouseSources}=(0,index_esm.useValues)(revenueAnalyticsLogic.Km),{setRevenueSources}=(0,index_esm.useActions)(revenueAnalyticsLogic.Km),[events,setEvents]=(0,react.useState)(()=>buildEvents(allEvents,{})),[dataWarehouseSources,setDataWarehouseSources]=(0,react.useState)(()=>{var _allDataWarehouseSour;return buildDataWarehouseSources(null!==(_allDataWarehouseSour=allDataWarehouseSources?.results)&&void 0!==_allDataWarehouseSour?_allDataWarehouseSour:[],{})});(0,react.useEffect)(()=>{setEvents(events=>buildEvents(allEvents,events)),setDataWarehouseSources(dataWarehouseSources=>{var _allDataWarehouseSour2;return buildDataWarehouseSources(null!==(_allDataWarehouseSour2=allDataWarehouseSources?.results)&&void 0!==_allDataWarehouseSour2?_allDataWarehouseSour2:[],dataWarehouseSources)})},[allEvents,allDataWarehouseSources]);let eventsRef=(0,react.useRef)(events);(0,react.useEffect)(()=>{eventsRef.current=events},[events]);let dataWarehouseSourcesRef=(0,react.useRef)(dataWarehouseSources);(0,react.useEffect)(()=>{dataWarehouseSourcesRef.current=dataWarehouseSources},[dataWarehouseSources]);let updateEvent=(eventName,enabled)=>{setEvents(events=>({...events,[eventName]:enabled}))},updateDataWarehouseSource=(sourceId,enabled)=>{setDataWarehouseSources(dataWarehouseSources=>({...dataWarehouseSources,[sourceId]:enabled}))},areAllEventsEnabled=Object.values(events).every(enabled=>enabled),areAllEventsDisabled=Object.values(events).length>0&&Object.values(events).every(enabled=>!enabled),areAllDataWarehouseSourcesEnabled=Object.values(dataWarehouseSources).every(enabled=>enabled),areAllDataWarehouseSourcesDisabled=Object.values(dataWarehouseSources).length>0&&Object.values(dataWarehouseSources).every(enabled=>!enabled),areAllDisabled=areAllEventsDisabled||areAllDataWarehouseSourcesDisabled;return(0,jsx_runtime.jsx)(src.Qw,{closeOnClickInside:!1,onVisibilityChange:visible=>{var _allDataWarehouseSour3;if(!visible)setRevenueSources({events:allEvents.filter(event=>eventsRef.current[event.eventName]),dataWarehouseSources:null!==(_allDataWarehouseSour3=allDataWarehouseSources?.results.filter(source=>dataWarehouseSourcesRef.current[source.id]))&&void 0!==_allDataWarehouseSour3?_allDataWarehouseSour3:[]})},overlay:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between sm:min-w-[400px] p-2 gap-5",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("span",{className:"text-sm font-medium pb-2",children:["Events",(0,jsx_runtime.jsx)(src.rU,{className:"ml-1",to:urls.j.revenueSettings(),children:(0,jsx_runtime.jsx)(posthog_icons_es.SC9,{})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[allEvents.map(event=>(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,jsx_runtime.jsx)(src.f4,{checked:events[event.eventName],onChange:checked=>updateEvent(event.eventName,checked)}),event.eventName]},event.eventName)),0===allEvents.length&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("span",{className:"text-sm text-muted-alt",children:"No revenue events found"})})]})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("span",{className:"text-sm font-medium pb-2",children:["Data warehouse sources",(0,jsx_runtime.jsx)(src.rU,{className:"ml-1",to:urls.j.revenueSettings(),children:(0,jsx_runtime.jsx)(posthog_icons_es.SC9,{})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[allDataWarehouseSources?.results.map(source=>jsx_runtime.jsxs("div",{className:"flex flex-row gap-1",children:[jsx_runtime.jsx(src.f4,{checked:dataWarehouseSources[source.id],onChange:checked=>updateDataWarehouseSource(source.id,checked)}),jsx_runtime.jsx("span",{className:"ml-1",children:source.prefix||source.source_type}),jsx_runtime.jsx(DataWarehouseSourceIcon.U,{type:source.source_type,size:"xsmall"})]},source.id)),!allDataWarehouseSources?.results.length&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("span",{className:"text-sm text-muted-alt",children:"No enabled revenue data warehouse sources found"})})]})]})]}),children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",tooltip:"Choose which revenue sources should be taken into consideration",icon:(0,jsx_runtime.jsx)(icons.T,{content:areAllDisabled?"!":areAllEventsEnabled&&areAllDataWarehouseSourcesEnabled?void 0:"*",status:areAllDisabled?"danger":"data",children:(0,jsx_runtime.jsx)(posthog_icons_es.wHY,{})})})})};var revenueEventsSettingsLogic=__webpack_require__("../../products/revenue_analytics/frontend/settings/revenueEventsSettingsLogic.ts"),Query=__webpack_require__("../../frontend/src/queries/Query/Query.tsx");let QUERY_ID=revenueAnalyticsLogic.nf.GROSS_REVENUE,INSIGHT_PROPS={dashboardItemId:(0,revenueAnalyticsLogic.z0)(QUERY_ID),loadPriority:QUERY_ID,dataNodeCollectionId:revenueAnalyticsLogic.hP},GrossRevenueTile=()=>{let{queries}=(0,index_esm.useValues)(revenueAnalyticsLogic.Km),query=queries[QUERY_ID],context=(0,react.useMemo)(()=>({insightProps:{...INSIGHT_PROPS,query}}),[query]);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsxs)("h3",{className:"text-lg font-semibold",children:["Gross Revenue ",(0,jsx_runtime.jsx)(src.u,{title:"Gross revenue is the total amount of revenue generated from all sources, including all products and services.",children:(0,jsx_runtime.jsx)(posthog_icons_es.aUG,{})})]}),(0,jsx_runtime.jsx)(Query.A,{query:query,readOnly:!0,context:context})]})},OverviewTile_QUERY_ID=revenueAnalyticsLogic.nf.OVERVIEW,OverviewTile_INSIGHT_PROPS={dashboardItemId:(0,revenueAnalyticsLogic.z0)(OverviewTile_QUERY_ID),loadPriority:OverviewTile_QUERY_ID,dataNodeCollectionId:revenueAnalyticsLogic.hP},OverviewTile=()=>{let{queries}=(0,index_esm.useValues)(revenueAnalyticsLogic.Km),query=queries[OverviewTile_QUERY_ID],context=(0,react.useMemo)(()=>({insightProps:{...OverviewTile_INSIGHT_PROPS,query}}),[query]);return(0,jsx_runtime.jsx)(Query.A,{query:query,readOnly:!0,context:context})};var Tooltip=__webpack_require__("../../frontend/src/lib/lemon-ui/Tooltip/index.ts"),geography_currency=__webpack_require__("../../frontend/src/lib/utils/geography/currency.ts");let RevenueGrowthRateTile_QUERY_ID=revenueAnalyticsLogic.nf.REVENUE_GROWTH_RATE,RevenueGrowthRateTile_INSIGHT_PROPS={dashboardItemId:(0,revenueAnalyticsLogic.z0)(RevenueGrowthRateTile_QUERY_ID),loadPriority:RevenueGrowthRateTile_QUERY_ID,dataNodeCollectionId:revenueAnalyticsLogic.hP},RevenueGrowthRateTile=()=>{let{baseCurrency}=(0,index_esm.useValues)(revenueEventsSettingsLogic.d),{queries,growthRateDisplayMode,disabledGrowthModeSelection}=(0,index_esm.useValues)(revenueAnalyticsLogic.Km),{setGrowthRateDisplayMode}=(0,index_esm.useActions)(revenueAnalyticsLogic.Km),query=queries[RevenueGrowthRateTile_QUERY_ID],columns=(0,react.useMemo)(()=>({month:{title:"Month"},revenue:{title:"Revenue",render:_ref=>{let{value}=_ref;return(0,jsx_runtime.jsx)(RevenueCell,{value:value,currency:baseCurrency})}},previous_month_revenue:{title:"Prev revenue",render:_ref2=>{let{value}=_ref2;return(0,jsx_runtime.jsx)(RevenueCell,{value:value,currency:baseCurrency})}},month_over_month_growth_rate:{title:"Growth Rate",render:_ref3=>{let{value,recordIndex,rowCount}=_ref3;return(0,jsx_runtime.jsx)(RevenueGrowthRateCell,{value:value,hasIncompleteMonthNotice:recordIndex===rowCount-1})}},three_month_growth_rate:{title:"3M Growth Rate",render:_ref4=>{let{value}=_ref4;return(0,jsx_runtime.jsx)(RevenueGrowthRateCell,{value:value})}},six_month_growth_rate:{title:"6M Growth Rate",render:_ref5=>{let{value}=_ref5;return(0,jsx_runtime.jsx)(RevenueGrowthRateCell,{value:value})}}}),[baseCurrency]),context=(0,react.useMemo)(()=>({columns,insightProps:{...RevenueGrowthRateTile_INSIGHT_PROPS,query}}),[query,columns]);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row justify-between",children:[(0,jsx_runtime.jsxs)("h3",{className:"text-lg font-semibold",children:["Revenue growth rate ",(0,jsx_runtime.jsx)(Tooltip.u,{title:"Revenue growth rate is the percentage change in revenue from the previous month. You can also see the rolling growth rate for the last 3 and 6 months.",children:(0,jsx_runtime.jsx)(posthog_icons_es.aUG,{})})]}),(0,jsx_runtime.jsx)(src.P4,{value:growthRateDisplayMode,onChange:setGrowthRateDisplayMode,options:[{value:"line",icon:(0,jsx_runtime.jsx)(posthog_icons_es.MsJ,{}),disabledReason:disabledGrowthModeSelection?"Select data that spans multiple months to see growth rate as a line graph":void 0},{value:"table",icon:(0,jsx_runtime.jsx)(icons.p$,{})}],size:"small"})]}),(0,jsx_runtime.jsx)(Query.A,{query:query,readOnly:!0,context:context})]})},RevenueCell=_ref6=>{let{value,currency}=_ref6;if(null===value)return null;let{symbol,isPrefix}=(0,geography_currency.jK)(currency);return(0,jsx_runtime.jsxs)("span",{children:[isPrefix?symbol:null,(0,utils.Lc)(value,2,2),isPrefix?null:" "+symbol]})},RevenueGrowthRateCell=_ref7=>{let{value,hasIncompleteMonthNotice}=_ref7;if(null===value)return null;let asNumber=Number(value),percentage=(100*asNumber).toFixed(2);return(0,jsx_runtime.jsxs)("span",{className:(0,css_classes.cn)("text-sm",asNumber>0?"text-green-500":"text-red-500"),children:[percentage,"%",hasIncompleteMonthNotice&&(0,jsx_runtime.jsx)(Tooltip.u,{title:"Given that the month hasn't finished yet, growth rate is not final",children:(0,jsx_runtime.jsx)(posthog_icons_es.aUG,{className:"ml-1"})})]})},TopCustomersTile_QUERY_ID=revenueAnalyticsLogic.nf.TOP_CUSTOMERS,TopCustomersTile_INSIGHT_PROPS={dashboardItemId:(0,revenueAnalyticsLogic.z0)(TopCustomersTile_QUERY_ID),loadPriority:TopCustomersTile_QUERY_ID,dataNodeCollectionId:revenueAnalyticsLogic.hP},TopCustomersTile=()=>{let{baseCurrency}=(0,index_esm.useValues)(revenueEventsSettingsLogic.d),{queries,topCustomersDisplayMode,disabledGrowthModeSelection}=(0,index_esm.useValues)(revenueAnalyticsLogic.Km),{setTopCustomersDisplayMode}=(0,index_esm.useActions)(revenueAnalyticsLogic.Km),query=queries[TopCustomersTile_QUERY_ID],columns=(0,react.useMemo)(()=>({name:{title:"Name"},customer_id:{title:(0,jsx_runtime.jsxs)("span",{children:["Customer ID"," ",(0,jsx_runtime.jsx)(src.u,{title:"As seen in your Data Warehouse",children:(0,jsx_runtime.jsx)(posthog_icons_es.aUG,{})})]})},month:{title:" ",width:"0px",render:()=>null},amount:{title:"Amount",render:_ref=>{let{value}=_ref;return(0,jsx_runtime.jsx)(AmountCell,{value:value,currency:baseCurrency})}}}),[baseCurrency]),context=(0,react.useMemo)(()=>({columns,insightProps:{...TopCustomersTile_INSIGHT_PROPS,query}}),[columns,query]);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row justify-between",children:[(0,jsx_runtime.jsxs)("h3",{className:"text-lg font-semibold",children:["Top customers ",(0,jsx_runtime.jsx)(src.u,{title:"Top customers by all revenue accumulated in the selected period.",children:(0,jsx_runtime.jsx)(posthog_icons_es.aUG,{})})]}),(0,jsx_runtime.jsx)(src.P4,{value:topCustomersDisplayMode,onChange:setTopCustomersDisplayMode,options:[{value:"line",icon:(0,jsx_runtime.jsx)(posthog_icons_es.MsJ,{}),disabledReason:disabledGrowthModeSelection?"Select data that spans multiple months to see growth rate as a line graph":void 0},{value:"table",icon:(0,jsx_runtime.jsx)(icons.p$,{})}],size:"small"})]}),(0,jsx_runtime.jsx)(Query.A,{query:query,readOnly:!0,context:context})]})},AmountCell=_ref2=>{let{value,currency}=_ref2,{symbol,isPrefix}=(0,geography_currency.jK)(currency);return(0,jsx_runtime.jsxs)("span",{children:[isPrefix?symbol:null,(0,utils.Lc)(value,2,2),isPrefix?null:" "+symbol]})},scene={component:RevenueAnalyticsScene,logic:revenueAnalyticsLogic.Km};function RevenueAnalyticsScene(){return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:revenueEventsSettingsLogic.d,props:{},children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:revenueAnalyticsLogic.Km,props:{},children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:dataNodeCollectionLogic.y,props:{key:revenueAnalyticsLogic.hP},children:(0,jsx_runtime.jsx)(RevenueAnalyticsSceneContent,{})})})})}function RevenueAnalyticsSceneContent(){let{hasRevenueTables}=(0,index_esm.useValues)(revenueAnalyticsLogic.Km),{mobileLayout}=(0,index_esm.useValues)(navigationLogic.f),{updateHasSeenProductIntroFor}=(0,index_esm.useActions)(userLogic.userLogic);return null===hasRevenueTables?(0,jsx_runtime.jsx)(src.t2,{sceneLevel:!0}):hasRevenueTables?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(src.Vp,{type:"info",dismissKey:"revenue-analytics-beta",className:"mb-2",action:{children:"Send feedback",id:"revenue-analytics-feedback-button"},children:"Revenue Analytics is in beta. Please let us know what you'd like to see here and/or report any issues directly to us!"}),(0,jsx_runtime.jsx)("div",{className:(0,css_classes.cn)("sticky z-20 bg-primary border-b py-2",mobileLayout?"top-[var(--breadcrumbs-height-full)]":"top-[var(--breadcrumbs-height-compact)]"),children:(0,jsx_runtime.jsx)(RevenueAnalyticsFilters,{})}),(0,jsx_runtime.jsx)(RevenueAnalyticsTables,{})]}):(0,jsx_runtime.jsx)(ProductIntroduction.C,{isEmpty:!0,productName:"Revenue Analytics",productKey:types.Md.REVENUE_ANALYTICS,titleOverride:"Connect your first revenue source",thingName:"revenue",description:"Track and analyze your revenue metrics to understand your business performance and growth.",actionElementOverride:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"primary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.SC9,{}),onClick:()=>{updateHasSeenProductIntroFor(types.Md.REVENUE_ANALYTICS,!0),lib.router.actions.push(urls.j.pipelineNodeNew(types.We.Source,{kind:"stripe"}))},"data-attr":"create-revenue-source",children:"Connect revenue source"}),(0,jsx_runtime.jsxs)("span",{className:"text-xs text-muted-alt",children:["Only Stripe is supported currently. ",(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)(src.rU,{target:"_blank",to:"https://github.com/PostHog/posthog/issues/new?assignees=&labels=enhancement,feature/revenue-analytics%2C+feature&projects=&template=feature_request.yml&title=New%20revenue%20source:%20%3Cinsert%20source%3E",children:"Request more revenue integrations."})]})]})})}let RevenueAnalyticsTables=()=>(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,jsx_runtime.jsx)(OverviewTile,{}),(0,jsx_runtime.jsx)(GrossRevenueTile,{}),(0,jsx_runtime.jsx)(src.p2,{className:"mt-6"}),(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,jsx_runtime.jsx)(RevenueGrowthRateTile,{}),(0,jsx_runtime.jsx)(TopCustomersTile,{})]})]})}}]);