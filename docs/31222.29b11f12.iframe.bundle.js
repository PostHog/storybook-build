(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[31222],{"./frontend/src/scenes/batch_exports/BatchExportScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{BatchExportScene:()=>BatchExportScene,LogsTab:()=>LogsTab,RunsTab:()=>RunsTab,scene:()=>scene});var src=__webpack_require__("./frontend/@posthog/apps-common/src/index.ts"),posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.7.0_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),lemon_ui_src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),NotFound=__webpack_require__("./frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),dayjs=__webpack_require__("./frontend/src/lib/dayjs.ts"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts"),LemonCalendarRange=__webpack_require__("./frontend/src/lib/lemon-ui/LemonCalendarRange/LemonCalendarRange.tsx"),LemonDialog=__webpack_require__("./frontend/src/lib/lemon-ui/LemonDialog/index.ts"),LemonMenu=__webpack_require__("./frontend/src/lib/lemon-ui/LemonMenu/index.ts"),LemonSkeleton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonSkeleton/index.ts"),LemonTabs=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTabs/index.ts"),Popover=__webpack_require__("./frontend/src/lib/lemon-ui/Popover/index.ts"),Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip/index.ts"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),pipelineNodeLogsLogic=__webpack_require__("./frontend/src/scenes/pipeline/pipelineNodeLogsLogic.tsx"),urls=__webpack_require__("./frontend/src/scenes/urls.ts"),lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonCalendarSelect=__webpack_require__("./frontend/src/lib/lemon-ui/LemonCalendar/LemonCalendarSelect.tsx"),LemonField=__webpack_require__("./frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonModal=__webpack_require__("./frontend/src/lib/lemon-ui/LemonModal/index.ts"),batchExportLogic=__webpack_require__("./frontend/src/scenes/batch_exports/batchExportLogic.ts"),batch_exports_utils=__webpack_require__("./frontend/src/scenes/batch_exports/utils.ts"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function BatchExportBackfillModal(){if(!(0,batch_exports_utils.dv)())return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let{batchExportConfig,isBackfillModalOpen,isBackfillFormSubmitting}=(0,index_esm.useValues)(batchExportLogic.B),{closeBackfillModal}=(0,index_esm.useActions)(batchExportLogic.B);return(0,jsx_runtime.jsxs)(LemonModal.f,{title:"Export historical data",onClose:closeBackfillModal,isOpen:isBackfillModalOpen,width:"30rem",footer:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary","data-attr":"batch-export-backfill-cancel",disabledReason:isBackfillFormSubmitting?"Please wait...":void 0,onClick:closeBackfillModal,children:"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{form:"batch-export-backfill-form",htmlType:"submit",type:"primary","data-attr":"batch-export-backfill-submit",loading:isBackfillFormSubmitting,children:"Schedule runs"})]}),children:[(0,jsx_runtime.jsxs)("p",{children:["Triggering a historic export will create multiple runs, one after another for the range specified below. The runs will export data in ",(0,jsx_runtime.jsx)("b",{children:batchExportConfig?.interval})," intervals, from the start date until the end date is reached."]}),(0,jsx_runtime.jsxs)(lib.Form,{logic:batchExportLogic.B,formKey:"backfillForm",id:"batch-export-backfill-form",enableFormOnSubmit:!0,className:"space-y-2",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"start_at",label:"Start Date",className:"flex-1",children:_ref=>{let{value,onChange}=_ref;return(0,jsx_runtime.jsx)(LemonCalendarSelect.he,{value:value,onChange:onChange,placeholder:"Select start date"})}}),(0,jsx_runtime.jsx)(LemonField.D,{name:"end_at",label:"End date",className:"flex-1",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(LemonCalendarSelect.he,{value:value,onChange:onChange,placeholder:"Select end date (optional)"})}})]})]})}var kea_loaders_lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts");let batchExportLogsLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{batchExportId}=_ref;return batchExportId}),(0,index_esm.path)(batchExportId=>["scenes","batch_exports","batchExportLogsLogic",batchExportId]),(0,index_esm.actions)({clearBatchExportLogsBackground:!0,markLogsEnd:!0,setBatchExportLogsTypes:typeFilters=>({typeFilters}),setSearchTerm:searchTerm=>({searchTerm})}),(0,kea_loaders_lib.loaders)(_ref2=>{let{props:{batchExportId},values,actions,cache}=_ref2;return{batchExportLogs:{__default:[],loadBatchExportLogs:async()=>{let results=await api.ZP.batchExportLogs.search(batchExportId,values.searchTerm,values.typeFilters);return cache.pollingInterval||(cache.pollingInterval=setInterval(actions.loadBatchExportLogsBackgroundPoll,2e3)),actions.clearBatchExportLogsBackground(),results},loadBatchExportLogsMore:async()=>{let results=await api.ZP.batchExportLogs.search(batchExportId,values.searchTerm,values.typeFilters,values.trailingEntry);return results.length<50&&actions.markLogsEnd(),[...values.batchExportLogs,...results]},revealBackground:()=>{let newArray=[...values.batchExportLogsBackground,...values.batchExportLogs];return actions.clearBatchExportLogsBackground(),newArray}},batchExportLogsBackground:{__default:[],loadBatchExportLogsBackgroundPoll:async()=>{if(values.batchExportLogsLoading)return values.batchExportLogsBackground;let results=await api.ZP.batchExportLogs.search(batchExportId,values.searchTerm,values.typeFilters,null,values.leadingEntry);return[...results,...values.batchExportLogsBackground]}}}}),(0,index_esm.reducers)({batchExportLogsTypes:[Object.values(pipelineNodeLogsLogic.i).filter(type=>"DEBUG"!==type),{setBatchExportLogsTypes:(_,_ref3)=>{let{typeFilters}=_ref3;return typeFilters.map(tf=>tf)}}],batchExportLogsBackground:[[],{clearBatchExportLogsBackground:()=>[]}],searchTerm:["",{setSearchTerm:(_,_ref4)=>{let{searchTerm}=_ref4;return searchTerm}}],typeFilters:[Object.values(pipelineNodeLogsLogic.i).filter(type=>"DEBUG"!==type),{setBatchExportLogsTypes:(_,_ref5)=>{let{typeFilters}=_ref5;return typeFilters||[]}}],isThereMoreToLoad:[!0,{loadBatchExportLogsSuccess:(_,_ref6)=>{let{batchExportLogs}=_ref6;return batchExportLogs.length>=50},markLogsEnd:()=>!1}]}),(0,index_esm.selectors)(_ref7=>{let{selectors}=_ref7;return{leadingEntry:[()=>[selectors.batchExportLogs,selectors.batchExportLogsBackground],(batchExportLogs,batchExportLogsBackground)=>batchExportLogsBackground.length?batchExportLogsBackground[0]:batchExportLogs.length?batchExportLogs[0]:null],trailingEntry:[()=>[selectors.batchExportLogs,selectors.batchExportLogsBackground],(batchExportLogs,batchExportLogsBackground)=>batchExportLogs.length?batchExportLogs[batchExportLogs.length-1]:batchExportLogsBackground.length?batchExportLogsBackground[batchExportLogsBackground.length-1]:null]}}),(0,index_esm.listeners)(_ref8=>{let{actions}=_ref8;return{setBatchExportLogsTypes:()=>{actions.loadBatchExportLogs()},setSearchTerm:async(_ref9,breakpoint)=>{let{searchTerm}=_ref9;searchTerm&&await breakpoint(1e3),actions.loadBatchExportLogs()}}}),(0,index_esm.events)(_ref10=>{let{actions,cache}=_ref10;return{afterMount:()=>{actions.loadBatchExportLogs()},beforeUnmount:()=>{clearInterval(cache.pollingInterval)}}})]);var components=__webpack_require__("./frontend/src/scenes/batch_exports/components.tsx");let scene={component:BatchExportScene,logic:batchExportLogic.B,paramsToProps:_ref=>{let{params:{id}}=_ref;return{id:null!=id?id:"missing"}}};function RunsTab(){let{batchExportRunsResponse,batchExportConfig,groupedRuns,batchExportRunsResponseLoading,runsDateRange,batchExportConfigLoading}=(0,index_esm.useValues)(batchExportLogic.B),{loadNextBatchExportRuns,openBackfillModal,setRunsDateRange,retryRun}=(0,index_esm.useActions)(batchExportLogic.B),[dateRangeVisible,setDateRangeVisible]=(0,react.useState)(!1),hasDataPipelines=(0,batch_exports_utils.dv)();return batchExportConfig||batchExportConfigLoading?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:batchExportConfig?(0,jsx_runtime.jsx)("div",{className:"flex items-start gap-8 flex-wrap",children:(0,jsx_runtime.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-end items-start",children:(0,jsx_runtime.jsx)(Popover.J2,{actionable:!0,onClickOutside:function noRefCheck(){setDateRangeVisible(!1)},visible:dateRangeVisible,overlay:(0,jsx_runtime.jsx)(LemonCalendarRange.O,{value:[runsDateRange.from,runsDateRange.to],onChange:_ref2=>{let[start,end]=_ref2;setRunsDateRange({from:start.startOf("day"),to:end.endOf("day")}),setDateRangeVisible(!1)},onClose:function noRefCheck(){setDateRangeVisible(!1)}}),children:(0,jsx_runtime.jsxs)(lemon_ui_src.LemonButton,{onClick:function onClick(){setDateRangeVisible(!dateRangeVisible)},type:"secondary",size:"small",children:[runsDateRange.from.format("MMMM D, YYYY")," -"," ",runsDateRange.to.format("MMMM D, YYYY")]})})}),(0,jsx_runtime.jsx)(lemon_ui_src.LemonTable,{dataSource:groupedRuns,loading:batchExportRunsResponseLoading,loadingSkeletonRows:5,footer:batchExportRunsResponse?.next&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{center:!0,fullWidth:!0,onClick:loadNextBatchExportRuns,loading:batchExportRunsResponseLoading,children:"Load more rows"})}),expandable:{noIndent:!0,expandedRowRender:groupedRuns=>(0,jsx_runtime.jsx)(lemon_ui_src.LemonTable,{dataSource:groupedRuns.runs,embedded:!0,columns:[{title:"Status",key:"status",width:0,render:(_,run)=>(0,jsx_runtime.jsx)(components.pP,{runs:[run],showLabel:!0})},{title:"ID",key:"runId",render:(_,run)=>run.id},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,run)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:run.created_at})}]})},columns:[{key:"icon",width:0,render:(_,groupedRun)=>(0,jsx_runtime.jsx)(components.pP,{runs:groupedRun.runs})},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:run.data_interval_start,formatDate:"MMMM\xa0DD,\xa0YYYY",formatTime:"HH:mm:ss"})},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:run.data_interval_end,formatDate:"MMMM\xa0DD,\xa0YYYY",formatTime:"HH:mm:ss"})},{title:"Latest run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,groupedRun)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:groupedRun.last_run_at})},{key:"actions",width:0,render:function RenderName(_,groupedRun){return(0,jsx_runtime.jsx)("span",{className:"flex items-center gap-1",children:!(0,batch_exports_utils.WT)(groupedRun.runs[0])&&hasDataPipelines&&(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),onClick:()=>LemonDialog.d.open({title:"Retry export?",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"This will schedule a new run for the same interval. Any changes to the configuration will be applied to the new run."}),(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("b",{children:"Please note -"})," there may be a slight delay before the new run appears."]})]}),width:"20rem",primaryButton:{children:"Retry",onClick:()=>retryRun(groupedRun.runs[0])},secondaryButton:{children:"Cancel"}})})})}}],emptyState:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["No runs yet. Your exporter runs every ",(0,jsx_runtime.jsx)("b",{children:batchExportConfig.interval}),".",(0,jsx_runtime.jsx)("br",{}),hasDataPipelines&&(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{type:"primary",onClick:openBackfillModal,children:"Create historic export"})]})})]})}):null}):(0,jsx_runtime.jsx)(NotFound.T,{object:"Batch Export"})}let columns=[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",width:1,render:(_,entry)=>(0,dayjs.Bv)(entry.timestamp).format("YYYY-MM-DD HH:mm:ss.SSS UTC")},{title:"Level",key:"level",dataIndex:"level",width:1,render:(_,entry)=>(function(type){let color;switch(type){case pipelineNodeLogsLogic.i.Debug:color="var(--muted)";break;case pipelineNodeLogsLogic.i.Log:color="var(--default)";break;case pipelineNodeLogsLogic.i.Info:color="var(--blue)";break;case pipelineNodeLogsLogic.i.Warning:color="var(--warning)";break;case pipelineNodeLogsLogic.i.Error:color="var(--danger)"}return(0,jsx_runtime.jsx)("span",{style:{color},children:type})})(entry.level)},{title:"Run ID",key:"run_id",dataIndex:"run_id",width:1,render:(_,entry)=>entry.run_id},{title:"Message",key:"message",dataIndex:"message",width:6}];function LogsTab(_ref3){let{batchExportId}=_ref3,{activeTab,batchExportConfig,batchExportConfigLoading}=(0,index_esm.useValues)(batchExportLogic.B),logic=batchExportLogsLogic({batchExportId}),{batchExportLogs,batchExportLogsLoading,batchExportLogsBackground,isThereMoreToLoad,batchExportLogsTypes}=(0,index_esm.useValues)(logic),{revealBackground,loadBatchExportLogsMore,setBatchExportLogsTypes,setSearchTerm}=(0,index_esm.useActions)(logic);return batchExportConfig&&!batchExportConfigLoading&&activeTab?(0,jsx_runtime.jsxs)("div",{className:"ph-no-capture space-y-2 flex-1",children:[(0,jsx_runtime.jsx)(lemon_ui_src.LemonInput,{type:"search",placeholder:"Search for messages containing…",fullWidth:!0,onChange:setSearchTerm,allowClear:!0}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-4",children:[(0,jsx_runtime.jsx)("span",{children:"Show logs of type:\xa0"}),Object.values(pipelineNodeLogsLogic.i).map(type=>(0,jsx_runtime.jsx)(lemon_ui_src.LemonCheckbox,{label:type,checked:batchExportLogsTypes.includes(type),onChange:checked=>{let newBatchExportLogsTypes=checked?[...batchExportLogsTypes,type]:batchExportLogsTypes.filter(t=>t!=type);setBatchExportLogsTypes(newBatchExportLogsTypes)}},type))]}),(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{onClick:revealBackground,loading:batchExportLogsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:batchExportLogsBackground.length?void 0:"There's nothing to load",children:batchExportLogsBackground.length?`Load ${(0,utils.Zi)(batchExportLogsBackground.length,"newer entry","newer entries")}`:"No new entries"}),(0,jsx_runtime.jsx)(lemon_ui_src.LemonTable,{dataSource:batchExportLogs,columns:columns,loading:batchExportLogsLoading,className:"ph-no-capture",pagination:{pageSize:200,hideOnSinglePage:!0}}),!!batchExportLogs.length&&(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{onClick:loadBatchExportLogsMore,loading:batchExportLogsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:isThereMoreToLoad?void 0:"There's nothing more to load",children:isThereMoreToLoad?"Load up to 50 older entries":"No older entries"})]}):(0,jsx_runtime.jsx)(LemonSkeleton.y,{})}function BatchExportScene(){let{batchExportConfig,batchExportConfigLoading,activeTab}=(0,index_esm.useValues)(batchExportLogic.B),{loadBatchExportConfig,loadBatchExportRuns,openBackfillModal,pause,unpause,archive,setActiveTab}=(0,index_esm.useActions)(batchExportLogic.B),hasDataPipelines=(0,batch_exports_utils.dv)();return((0,react.useEffect)(()=>{loadBatchExportConfig(),loadBatchExportRuns()},[]),batchExportConfig||batchExportConfigLoading)?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:batchExportConfig?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonMenu.d,{items:[{label:batchExportConfig.paused?"Unpause":"Pause",onClick:()=>{batchExportConfig.paused?unpause():pause()},disabledReason:batchExportConfigLoading?"Loading...":void 0},{label:"Archive",status:"danger",onClick:()=>LemonDialog.d.open({title:"Archive Batch Export?",description:"Are you sure you want to archive this Batch Export? This will stop all future runs",primaryButton:{children:"Archive",status:"danger",onClick:()=>archive()},secondaryButton:{children:"Cancel"}}),disabledReason:batchExportConfigLoading?"Loading...":void 0}],children:(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{}),size:"small"})}),hasDataPipelines&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(lemon_ui_src.LemonDivider,{vertical:!0}),(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{type:"secondary",onClick:()=>openBackfillModal(),children:"Create historic export"})]}),(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{type:"primary",to:urls.j.batchExportEdit(batchExportConfig?.id),children:"Edit"})]}):void 0}),(0,jsx_runtime.jsx)("div",{children:batchExportConfig?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(components.$o,{batchExportConfig:batchExportConfig}),(0,jsx_runtime.jsx)(lemon_ui_src.LemonTag,{children:(0,utils.fm)((0,batch_exports_utils.J0)(batchExportConfig.interval))}),(0,jsx_runtime.jsx)(lemon_ui_src.LemonTag,{children:batchExportConfig.end_at?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-1",children:["Ends ",(0,jsx_runtime.jsx)(src.TZLabel,{time:batchExportConfig.end_at})]})}):"Indefinite"}),(0,jsx_runtime.jsx)(Tooltip.u,{title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("ul",{className:"mb-4",children:[(0,jsx_runtime.jsxs)("li",{className:"flex items-center justify-between gap-2",children:[(0,jsx_runtime.jsx)("span",{children:"Destination:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:batchExportConfig.destination.type})]}),Object.keys(batchExportConfig.destination.config).filter(x=>!["password","aws_secret_access_key","client_email","token_uri","private_key","private_key_id"].includes(x)).map(x=>(0,jsx_runtime.jsxs)("li",{className:"flex items-center justify-between gap-2",children:[(0,jsx_runtime.jsxs)("span",{children:[(0,utils.UV)(x),":"]}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:batchExportConfig.destination.config[x]})]},x))]})}),children:(0,jsx_runtime.jsx)(lemon_ui_src.LemonTag,{children:(0,batch_exports_utils.qY)(batchExportConfig.destination)})})]})}):(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"w-10 h-4"})}),batchExportConfig&&activeTab?(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:activeTab,onChange:newKey=>setActiveTab(newKey),tabs:[{key:batchExportLogic.o.Runs,label:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Latest runs"}),content:(0,jsx_runtime.jsx)(RunsTab,{})},{key:batchExportLogic.o.Logs,label:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Logs"}),content:(0,jsx_runtime.jsx)(LogsTab,{batchExportId:batchExportConfig.id})}]}):null,(0,jsx_runtime.jsx)(BatchExportBackfillModal,{})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"Batch Export"})}},"./frontend/src/scenes/batch_exports/batchExportLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{B:()=>batchExportLogic,o:()=>BatchExportTab});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/api.ts"),lib_dayjs__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/lib/dayjs.ts"),scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/scenes/sceneTypes.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./frontend/src/scenes/urls.ts");let BatchExportTab=function(BatchExportTab){return BatchExportTab.Runs="runs",BatchExportTab.Logs="logs",BatchExportTab}({}),convert=run=>({...run,data_interval_start:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.data_interval_start),data_interval_end:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.data_interval_end),created_at:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.created_at),last_updated_at:run.last_updated_at?(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.last_updated_at):void 0}),mergeRuns=(oldRuns,newRuns)=>{let runs=[...oldRuns];return newRuns.forEach(rawRun=>{let newRun=convert(rawRun),index=runs.findIndex(run=>run.id===newRun.id);index>-1?runs[index]=newRun:runs.push(newRun)}),runs},batchExportLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.key)(_ref=>{let{id}=_ref;return id}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(key=>["scenes","batch_exports","batchExportLogic",key]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({loadBatchExportRuns:!0,loadNextBatchExportRuns:!0,openBackfillModal:!0,closeBackfillModal:!0,retryRun:run=>({run}),setRunsDateRange:data=>data,setActiveTab:tab=>({tab})}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.reducers)({activeTab:["runs",{setActiveTab:(_,_ref2)=>{let{tab}=_ref2;return tab}}],runsDateRange:[{from:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)().subtract(7,"day").startOf("day"),to:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)().endOf("day")},{setRunsDateRange:(_,_ref3)=>{let{from,to}=_ref3;return{from,to}}}],isBackfillModalOpen:[!1,{openBackfillModal:()=>!0,closeBackfillModal:()=>!1}]}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_3__.loaders)(_ref4=>{let{props,values}=_ref4;return{batchExportConfig:[null,{loadBatchExportConfig:async()=>{let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.get(props.id);return res},pause:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.pause(props.id),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Batch export paused. No future runs will be scheduled"),{...values.batchExportConfig,paused:!0}):null,unpause:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.unpause(props.id),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Batch export unpaused. Future runs will be scheduled"),{...values.batchExportConfig,paused:!1}):null,archive:async()=>(values.batchExportConfig&&(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.delete(props.id),kea_router__WEBPACK_IMPORTED_MODULE_4__.router.actions.replace(scenes_urls__WEBPACK_IMPORTED_MODULE_8__.j.batchExports())),null)}],batchExportRunsResponse:[null,{loadBatchExportRuns:async()=>{var _values$batchExportRu;let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.listRuns(props.id,{after:values.runsDateRange.from,before:values.runsDateRange.to.add(1,"day")});return res.results=mergeRuns(null!==(_values$batchExportRu=values.batchExportRunsResponse?.results)&&void 0!==_values$batchExportRu?_values$batchExportRu:[],res.results),res},loadNextBatchExportRuns:async()=>{var _values$batchExportRu2;let nextUrl=values.batchExportRunsResponse?.next;if(!nextUrl)return values.batchExportRunsResponse;let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.get(nextUrl);return res.results=mergeRuns(null!==(_values$batchExportRu2=values.batchExportRunsResponse?.results)&&void 0!==_values$batchExportRu2?_values$batchExportRu2:[],res.results),res}}]}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_2__.forms)(_ref5=>{let{props,actions}=_ref5;return{backfillForm:{defaults:{end_at:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)()},errors:_ref6=>{let{start_at,end_at}=_ref6;return{start_at:start_at?void 0:"Start date is required",end_at:end_at?void 0:"End date is required"}},submit:async _ref7=>{var _start_at$toISOString,_end_at$toISOString;let{start_at,end_at}=_ref7;await new Promise(resolve=>setTimeout(resolve,1e3)),await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.createBackfill(props.id,{start_at:null!==(_start_at$toISOString=start_at?.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=end_at?.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null}).catch(e=>{if(e.detail){var _e$attr;actions.setBackfillFormManualErrors({[null!==(_e$attr=e.attr)&&void 0!==_e$attr?_e$attr:"start_at"]:e.detail})}else _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.error("Unknown error occurred");throw e}),actions.closeBackfillModal(),actions.loadBatchExportRuns()}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.selectors)(()=>({groupedRuns:[s=>[s.batchExportRuns],runs=>{let groupedRuns={};return runs.forEach(run=>{let key=`${run.data_interval_start}-${run.data_interval_end}`;groupedRuns[key]||(groupedRuns[key]={data_interval_start:run.data_interval_start,data_interval_end:run.data_interval_end,runs:[],last_run_at:run.created_at}),groupedRuns[key].runs.push(run),groupedRuns[key].runs.sort((a,b)=>b.created_at.diff(a.created_at)),groupedRuns[key].last_run_at=groupedRuns[key].runs[0].created_at}),Object.values(groupedRuns).sort((a,b)=>b.data_interval_end.diff(a.data_interval_end))}],breadcrumbs:[s=>[s.batchExportConfig],config=>[{key:scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__.x.BatchExports,name:"Batch Exports",path:scenes_urls__WEBPACK_IMPORTED_MODULE_8__.j.batchExports()},{key:[scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__.x.BatchExport,config?.id||"loading"],name:config?.name}]],batchExportRuns:[s=>[s.batchExportRunsResponse],batchExportRunsResponse=>{var _batchExportRunsRespo;return null!==(_batchExportRunsRespo=batchExportRunsResponse?.results)&&void 0!==_batchExportRunsRespo?_batchExportRunsRespo:[]}],defaultTab:[s=>[s.batchExportConfig],()=>BatchExportTab.Runs]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.listeners)(_ref8=>{let{actions,cache,props}=_ref8;return{setRunsDateRange:()=>{actions.loadBatchExportRuns()},loadBatchExportRunsSuccess:()=>{clearTimeout(cache.refreshTimeout),cache.refreshTimeout=setTimeout(()=>{actions.loadBatchExportRuns()},5e3)},retryRun:async _ref9=>{let{run}=_ref9;await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.createBackfill(props.id,{start_at:run.data_interval_start.toISOString(),end_at:run.data_interval_end.toISOString()}),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Retry has been scheduled."),clearTimeout(cache.refreshTimeout),cache.refreshTimeout=setTimeout(()=>{actions.loadBatchExportRuns()},2e3)}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.beforeUnmount)(_ref10=>{let{cache}=_ref10;clearTimeout(cache.refreshTimeout)})])},"./frontend/src/scenes/batch_exports/components.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{pP:()=>BatchExportRunIcon,$o:()=>BatchExportTag});var injectStylesIntoStyleTag=__webpack_require__("./node_modules/.pnpm/style-loader@2.0.0_webpack@5.88.2/node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),BatchExports=__webpack_require__("./node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!./node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.4.31_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!./node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!./frontend/src/scenes/batch_exports/BatchExports.scss"),BatchExports_default=__webpack_require__.n(BatchExports),options={};options.insert="head",options.singleton=!1,injectStylesIntoStyleTag_default()(BatchExports_default(),options),BatchExports_default().locals;var src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip/index.ts"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function BatchExportTag(_ref){let{batchExportConfig}=_ref;return(0,jsx_runtime.jsx)(Tooltip.u,{title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:batchExportConfig.paused?"This export is paused - no future export runs will be scheduled ":"This export is active - new runs will be triggered at the configured interval."}),children:(0,jsx_runtime.jsx)(src.LemonTag,{type:batchExportConfig.paused?"default":"primary",children:batchExportConfig.paused?"Paused":"Active"})})}let combineFailedStatuses=status=>"FailedRetryable"===status?"Failed":status,colorForStatus=status=>{switch(status){case"Completed":return"success";case"ContinuedAsNew":case"Running":case"Starting":return"primary";case"Cancelled":case"Terminated":case"TimedOut":return"warning";case"Failed":case"FailedRetryable":return"danger";default:return"default"}};function BatchExportRunIcon(_ref2){let{runs,showLabel=!1}=_ref2,latestRun=runs[0],status=combineFailedStatuses(latestRun.status),color=colorForStatus(status);return(0,jsx_runtime.jsx)(Tooltip.u,{title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Run status: ",status,runs.length>1&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),"Attempts: ",runs.length]})]}),children:(0,jsx_runtime.jsx)("span",{className:(0,clsx_m.default)(`BatchExportRunIcon h-6 p-2 border-2 flex items-center justify-center rounded-full font-semibold text-xs border-${color} text-${color}-dark select-none`,"primary"===color&&"BatchExportRunIcon--pulse",showLabel?"":"w-6"),children:showLabel?(0,jsx_runtime.jsx)("span",{className:"text-center",children:status}):runs.length})})}},"./frontend/src/scenes/batch_exports/utils.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{J0:()=>intervalToFrequency,WT:()=>isRunInProgress,dv:()=>showBatchExports,qY:()=>humanizeDestination});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./frontend/src/types.ts");function intervalToFrequency(interval){return({day:"daily",hour:"hourly","every 5 minutes":"every 5 minutes"})[interval]}function isRunInProgress(run){return["Running","Starting"].includes(run.status)}function humanizeDestination(destination){return"S3"===destination.type?`s3://${destination.config.bucket_name}/${destination.config.prefix}`:"Snowflake"===destination.type?`snowflake:${destination.config.account}:${destination.config.database}:${destination.config.table_name}`:"Postgres"===destination.type?`postgresql://${destination.config.user}:***@${destination.config.host}:${destination.config.port}/${destination.config.database}`:"Redshift"===destination.type?`redshift://${destination.config.user}:***@${destination.config.host}:${destination.config.port}/${destination.config.database}`:"BigQuery"===destination.type?`bigquery:${destination.config.project_id}:${destination.config.dataset_id}:${destination.config.table_id}`:"Unknown"}function showBatchExports(){let{user}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)(scenes_userLogic__WEBPACK_IMPORTED_MODULE_1__.userLogic),{hasAvailableFeature}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)(scenes_userLogic__WEBPACK_IMPORTED_MODULE_1__.userLogic);return hasAvailableFeature(_types__WEBPACK_IMPORTED_MODULE_2__.P$.DATA_PIPELINES)||user?.is_impersonated==!0}},"./node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!./node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.4.31_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!./node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!./frontend/src/scenes/batch_exports/BatchExports.scss":(module,exports,__webpack_require__)=>{(exports=__webpack_require__("./node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/runtime/api.js")(!1)).push([module.id,".BatchExportRunIcon--pulse{animation:BatchExportRunIcon__pulse 2s ease-out infinite;outline:2px solid transparent;outline-offset:0}@keyframes BatchExportRunIcon__pulse{0%{outline-color:var(--primary-3000-hover);outline-offset:0}80%{outline-color:transparent;outline-offset:20px}to{outline-color:transparent;outline-offset:20px}}",""]),module.exports=exports}}]);