"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[5244],{"./frontend/src/scenes/debug/DebugScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{DebugScene:()=>DebugScene,scene:()=>scene});var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonLabel=__webpack_require__("./frontend/src/lib/lemon-ui/LemonLabel/LemonLabel.tsx"),LemonSelect=__webpack_require__("./frontend/src/lib/lemon-ui/LemonSelect/index.ts"),CodeEditors=__webpack_require__("./frontend/src/lib/components/CodeEditors.tsx"),CodeSnippet=__webpack_require__("./frontend/src/lib/components/CodeSnippet/index.ts"),lemon_ui_LemonLabel=__webpack_require__("./frontend/src/lib/lemon-ui/LemonLabel/index.ts"),LemonTable=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTable/index.ts"),dataNodeLogic=__webpack_require__("./frontend/src/queries/nodes/DataNode/dataNodeLogic.ts"),DateRange=__webpack_require__("./frontend/src/queries/nodes/DataNode/DateRange.tsx"),ElapsedTime=__webpack_require__("./frontend/src/queries/nodes/DataNode/ElapsedTime.tsx"),Reload=__webpack_require__("./frontend/src/queries/nodes/DataNode/Reload.tsx"),EventPropertyFilters=__webpack_require__("./frontend/src/queries/nodes/EventsNode/EventPropertyFilters.tsx"),HogQLQueryEditor=__webpack_require__("./frontend/src/queries/nodes/HogQLQuery/HogQLQueryEditor.tsx"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function toLineColumn(hogql,position){let lines=hogql.split("\n"),line=0,column=0;for(let i=0;i<lines.length;i++){if(position<lines[i].length){line=i+1,column=position+1;break}position-=lines[i].length+1}return{line,column}}function toLine(hogql,position){return toLineColumn(hogql,position).line}function toColumn(hogql,position){return toLineColumn(hogql,position).column}function HogQLDebug(_ref){var _query$modifiers$pers,_query$modifiers$pers2,_query$modifiers$inCo,_query$modifiers$mate;let{query,setQuery,queryKey}=_ref,dataNodeLogicProps={query,key:queryKey},{dataLoading,response:_response,responseErrorObject,elapsedTime}=(0,index_esm.useValues)((0,dataNodeLogic.M)(dataNodeLogicProps)),clickHouseTime=_response?.timings?.find(_ref2=>{let{k}=_ref2;return"./clickhouse_execute"===k})?.t;return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:dataNodeLogic.M,props:dataNodeLogicProps,children:(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsx)(HogQLQueryEditor.n,{query:query,setQuery:setQuery}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(Reload.L,{}),(0,jsx_runtime.jsx)(DateRange.C,{query:query,setQuery:setQuery},"date-range"),(0,jsx_runtime.jsx)(EventPropertyFilters.H,{query:query,setQuery:setQuery},"event-property")]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsxs)(lemon_ui_LemonLabel.H,{children:["POE:",(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:[{value:"disabled",label:"Disabled"},{value:"v1_enabled",label:"V1 Enabled"},{value:"v1_mixed",label:"V1 Mixed"},{value:"v2_enabled",label:"V2 Enabled"}],onChange:value=>setQuery({...query,modifiers:{...query.modifiers,personsOnEventsMode:value}}),value:null!==(_query$modifiers$pers=query.modifiers?.personsOnEventsMode)&&void 0!==_query$modifiers$pers?_query$modifiers$pers:_response?.modifiers?.personsOnEventsMode})]}),(0,jsx_runtime.jsxs)(lemon_ui_LemonLabel.H,{children:["Persons ArgMax:",(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:[{value:"v1",label:"V1"},{value:"v2",label:"V2"}],onChange:value=>setQuery({...query,modifiers:{...query.modifiers,personsArgMaxVersion:value}}),value:null!==(_query$modifiers$pers2=query.modifiers?.personsArgMaxVersion)&&void 0!==_query$modifiers$pers2?_query$modifiers$pers2:_response?.modifiers?.personsArgMaxVersion})]}),(0,jsx_runtime.jsxs)(lemon_ui_LemonLabel.H,{children:["In Cohort Via:",(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:[{value:"auto",label:"auto"},{value:"leftjoin",label:"join"},{value:"subquery",label:"subquery"},{value:"leftjoin_conjoined",label:"leftjoin conjoined"}],onChange:value=>setQuery({...query,modifiers:{...query.modifiers,inCohortVia:value}}),value:null!==(_query$modifiers$inCo=query.modifiers?.inCohortVia)&&void 0!==_query$modifiers$inCo?_query$modifiers$inCo:_response?.modifiers?.inCohortVia})]}),(0,jsx_runtime.jsxs)(lemon_ui_LemonLabel.H,{children:["Materialization Mode:",(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:[{value:"auto",label:"auto"},{value:"legacy_null_as_string",label:"legacy_null_as_string"},{value:"legacy_null_as_null",label:"legacy_null_as_null"},{value:"disabled",label:"disabled"}],onChange:value=>setQuery({...query,modifiers:{...query.modifiers,materializationMode:value}}),value:null!==(_query$modifiers$mate=query.modifiers?.materializationMode)&&void 0!==_query$modifiers$mate?_query$modifiers$mate:_response?.modifiers?.materializationMode})]})]}),dataLoading?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("h2",{children:"Running query..."}),(0,jsx_runtime.jsxs)("div",{className:"flex",children:["Time elapsed: ",(0,jsx_runtime.jsx)(ElapsedTime.W,{})]})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[_response?.error?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("h2",{className:"text-danger",children:"Error Running Query!"}),(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Text,wrap:!0,children:_response.error})]}):null,_response?.hogql?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("h2",{children:"Executed HogQL"}),(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.SQL,wrap:!0,children:_response.hogql})]}):null,_response?.clickhouse?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("h2",{children:["Executed ClickHouse SQL",void 0!==clickHouseTime?` (${Math.floor(1e3*clickHouseTime)/1e3}s)`:""]}),(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.SQL,wrap:!0,children:_response.clickhouse})]}):null,_response?.metadata?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("h2",{children:"Metadata"}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:[..._response.metadata.errors.map(error=>{var _response$hogql,_error$start,_response$hogql2,_error$start2;return{type:"error",line:toLine(null!==(_response$hogql=_response.hogql)&&void 0!==_response$hogql?_response$hogql:"",null!==(_error$start=error.start)&&void 0!==_error$start?_error$start:0),column:toColumn(null!==(_response$hogql2=_response.hogql)&&void 0!==_response$hogql2?_response$hogql2:"",null!==(_error$start2=error.start)&&void 0!==_error$start2?_error$start2:0),...error}}),..._response.metadata.warnings.map(warn=>{var _response$hogql3,_warn$start,_response$hogql4,_warn$start2;return{type:"warning",line:toLine(null!==(_response$hogql3=_response.hogql)&&void 0!==_response$hogql3?_response$hogql3:"",null!==(_warn$start=warn.start)&&void 0!==_warn$start?_warn$start:0),column:toColumn(null!==(_response$hogql4=_response.hogql)&&void 0!==_response$hogql4?_response$hogql4:"",null!==(_warn$start2=warn.start)&&void 0!==_warn$start2?_warn$start2:0),...warn}}),..._response.metadata.notices.map(notice=>{var _response$hogql5,_notice$start,_response$hogql6,_notice$start2;return{type:"notice",line:toLine(null!==(_response$hogql5=_response.hogql)&&void 0!==_response$hogql5?_response$hogql5:"",null!==(_notice$start=notice.start)&&void 0!==_notice$start?_notice$start:0),column:toColumn(null!==(_response$hogql6=_response.hogql)&&void 0!==_response$hogql6?_response$hogql6:"",null!==(_notice$start2=notice.start)&&void 0!==_notice$start2?_notice$start2:0),...notice}})].sort((a,b)=>{var _a$start,_b$start;return(null!==(_a$start=a.start)&&void 0!==_a$start?_a$start:0)-(null!==(_b$start=b.start)&&void 0!==_b$start?_b$start:0)}),columns:[{title:"Line",dataIndex:"line",key:"line",width:"40px"},{title:"Column",dataIndex:"column",key:"column",width:"40px"},{title:"Type",dataIndex:"type",key:"type",width:"80px"},{title:"Message",dataIndex:"message",key:"message"}]})]}):null,_response?.explain?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("h2",{children:"Explained ClickHouseSQL"}),(0,jsx_runtime.jsx)(CodeSnippet.O,{wrap:!0,children:_response.explain.join("\n")})]}):null,_response?.timings&&null!==elapsedTime?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("h2",{children:"Time spent"}),(0,jsx_runtime.jsx)(ElapsedTime.F,{timings:_response.timings,elapsedTime:elapsedTime})]}):null,(0,jsx_runtime.jsx)("h2",{children:"Raw response"}),(0,jsx_runtime.jsx)(CodeEditors.p,{className:"border",language:"json",value:JSON.stringify(null!=_response?_response:responseErrorObject,null,2),height:800})]})]})})}var examples=__webpack_require__("./frontend/src/queries/examples.ts"),Query=__webpack_require__("./frontend/src/queries/Query/Query.tsx"),lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),urls=__webpack_require__("./frontend/src/scenes/urls.ts");let DEFAULT_QUERY=examples.Os.HogQLRaw,debugSceneLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","query","debugSceneLogic"]),(0,index_esm.actions)({setQuery1:query=>({query:query}),setQuery2:query=>({query:query})}),(0,index_esm.reducers)({query1:[DEFAULT_QUERY,{setQuery1:(_,_ref)=>{let{query}=_ref;return query}}],query2:[DEFAULT_QUERY,{setQuery2:(_,_ref2)=>{let{query}=_ref2;return query}}]}),(0,lib.actionToUrl)(_ref3=>{let{values}=_ref3;return{setQuery1:_ref4=>{let{query}=_ref4;return[urls.j.debugQuery(),{},{q:query,...values.query2?{q2:values.query2}:{}},{replace:!0}]},setQuery2:()=>[urls.j.debugQuery(),{},{q:values.query1,q2:values.query2},{replace:!0}]}}),(0,lib.urlToAction)(_ref5=>{let{actions,values}=_ref5;return{[urls.j.debugQuery()]:(_,__,_ref6)=>{var _values$query;let{q,q2}=_ref6;q&&q!==values.query1&&actions.setQuery1(q),(null!=q2?q2:"")!==(null!==(_values$query=values.query2)&&void 0!==_values$query?_values$query:"")&&actions.setQuery2(null!=q2?q2:"")}}})]);function QueryDebug(_ref){let parsed,{query,setQuery,queryKey}=_ref;try{parsed=JSON.parse(query)}catch(e){}return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:parsed&&parsed?.kind==="HogQLQuery"?(0,jsx_runtime.jsx)(HogQLDebug,{queryKey:queryKey,query:parsed,setQuery:query=>setQuery(JSON.stringify(query,null,2))}):(0,jsx_runtime.jsx)(Query.A,{query:query,setQuery:query=>setQuery(JSON.stringify(query,null,2)),context:{showQueryEditor:!0}})})}function DebugScene(){let{query1,query2}=(0,index_esm.useValues)(debugSceneLogic),{setQuery1,setQuery2}=(0,index_esm.useActions)(debugSceneLogic);return(0,jsx_runtime.jsxs)("div",{className:"QueryScene",children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{active:!!query2,onClick:()=>query2?setQuery2(""):setQuery2(query1),children:"Split"}),(0,jsx_runtime.jsx)(LemonButton.J,{active:query1===examples.Os.HogQLRaw,onClick:()=>setQuery1(examples.Os.HogQLRaw),children:"HogQL Debug"}),(0,jsx_runtime.jsx)(LemonButton.J,{active:query1===examples.Os.HogQLTable,onClick:()=>setQuery1(examples.Os.HogQLTable),children:"HogQL Table"}),(0,jsx_runtime.jsx)(LemonButton.J,{active:query1===examples.Os.Events,onClick:()=>setQuery1(examples.Os.Events),children:"Any Query"}),(0,jsx_runtime.jsx)(LemonLabel.H,{children:(0,jsx_runtime.jsx)(LemonSelect.Yv,{placeholder:"More sample queries",options:Object.entries(examples.Os).filter(_ref2=>{let[k]=_ref2;return"HogQLTable"!==k&&"HogQLRaw"!==k}).map(_ref3=>{let[k,v]=_ref3;return{label:k,value:v}}),onChange:v=>{v&&setQuery1(v)}})})]})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1 w-1/2",children:(0,jsx_runtime.jsx)(QueryDebug,{query:query1,setQuery:setQuery1,queryKey:"hogql-debug-1"})}),query2?(0,jsx_runtime.jsx)("div",{className:"flex-1 w-1/2",children:(0,jsx_runtime.jsx)(QueryDebug,{query:query2,setQuery:setQuery2,queryKey:"hogql-debug-2"})}):null]})]})}let scene={component:DebugScene,logic:debugSceneLogic}}}]);