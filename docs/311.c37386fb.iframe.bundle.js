var N=Object.defineProperty,U=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var Q=(d,c,t)=>c in d?N(d,c,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[c]=t,k=(d,c)=>{for(var t in c||(c={}))E.call(c,t)&&Q(d,t,c[t]);if(w)for(var t of w(c))G.call(c,t)&&Q(d,t,c[t]);return d},T=(d,c)=>U(d,W(c));var M=(d,c,t)=>new Promise((O,b)=>{var o=l=>{try{m(t.next(l))}catch(j){b(j)}},f=l=>{try{m(t.throw(l))}catch(j){b(j)}},m=l=>l.done?O(l.value):Promise.resolve(l.value).then(o,f);m((t=t.apply(d,c)).next())});(window.webpackJsonp=window.webpackJsonp||[]).push([[311],{"./frontend/src/scenes/instance/DeadLetterQueue/DeadLetterQueue.tsx":function(d,c,t){"use strict";t.r(c),t.d(c,"scene",function(){return F}),t.d(c,"DeadLetterQueue",function(){return p});var O=t("./frontend/src/lib/components/PageHeader.tsx"),b=t("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/tabs/index.js"),o=t("./node_modules/.pnpm/kea@3.0.4_react@16.14.0/node_modules/kea/lib/index.esm.js"),f=t("./frontend/src/lib/api.ts"),m=t("./frontend/src/scenes/userLogic.ts"),l=t("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.0.4/node_modules/kea-loaders/lib/index.js");let j;(function(e){e.Metrics="metrics",e.Management="management",e.Settings="settings"})(j||(j={}));const x=Object(o.kea)([Object(o.path)(["scenes","instance","DeadLetterQueue","deadLetterQueueLogic"]),Object(o.actions)({setActiveTab:e=>({tabKey:e}),loadMoreRows:e=>({key:e}),addRowsToMetric:(e,n)=>({key:e,rows:n})}),Object(o.reducers)({activeTab:[j.Metrics,{setActiveTab:(e,n)=>{let{tabKey:r}=n;return r}}],rowsPerMetric:[{},{addRowsToMetric:(e,n)=>{let{key:r,rows:i}=n;return T(k({},e),{[r]:[...e[r]||[],...i]})},loadDeadLetterQueueMetricsSuccess:(e,n)=>{let{deadLetterQueueMetrics:r}=n;const i={};for(const u of r)u.subrows&&(i[u.key]=u.subrows.rows);return i}}]}),Object(l.loaders)({deadLetterQueueMetrics:[[],{loadDeadLetterQueueMetrics:()=>M(this,null,function*(){var e;return(e=m.a.values.user)!==null&&e!==void 0&&e.is_staff?(yield f.b.get("api/dead_letter_queue")).results:[]})}]}),Object(o.listeners)(e=>{let{values:n,actions:r}=e;return{loadMoreRows:i=>M(this,null,function*(){var u;let{key:v}=i;const y=((u=n.rowsPerMetric[v])===null||u===void 0?void 0:u.length)+1;if(y){const a=yield f.b.get(`api/dead_letter_queue/${v}?offset=${y}`);r.addRowsToMetric(v,a.subrows.rows)}})}}),Object(o.selectors)({singleValueMetrics:[e=>[e.deadLetterQueueMetrics],e=>e.filter(n=>!n.subrows)],tableMetrics:[e=>[e.deadLetterQueueMetrics],e=>e.filter(n=>!!n.subrows)]}),Object(o.afterMount)(e=>{let{actions:n}=e;n.loadDeadLetterQueueMetrics()})]);var S=t("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/row/index.js"),D=t("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/col/index.js"),P=t("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/statistic/index.js"),L=t("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/divider/index.js"),R=t("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/button/index.js"),z=t("./frontend/src/lib/components/LemonTable/index.ts"),$=t("./frontend/src/lib/components/LemonButton/index.ts"),A=t("./frontend/src/lib/components/Spinner/Spinner.tsx"),I=t("./frontend/src/lib/components/icons.tsx"),s=t("./node_modules/.pnpm/react@16.14.0/node_modules/react/jsx-runtime.js");const V=10;function C(){const{user:e}=Object(o.useValues)(m.a),{singleValueMetrics:n,tableMetrics:r,deadLetterQueueMetricsLoading:i,rowsPerMetric:u}=Object(o.useValues)(x),{loadDeadLetterQueueMetrics:v,loadMoreRows:y}=Object(o.useActions)(x);return e!=null&&e.is_staff?Object(s.jsxs)("div",{children:[Object(s.jsx)("br",{}),Object(s.jsx)("div",{className:"mb-4 float-right",children:Object(s.jsx)($.a,{icon:i?Object(s.jsx)(A.a,{}):Object(s.jsx)(I.IconRefresh,{}),onClick:v,type:"secondary",size:"small",children:"Refresh"})}),Object(s.jsx)(S.a,{gutter:32,children:n.map(a=>Object(s.jsx)(D.a,{children:Object(s.jsx)(P.a,{title:a.metric,value:(a.value||"0").toLocaleString("en-US"),loading:i})},a.key))}),Object(s.jsx)(L.a,{}),r.map(a=>{var h,g;return Object(s.jsxs)("div",{children:[Object(s.jsx)("h2",{children:a.metric}),Object(s.jsx)(z.a,{columns:[{title:(h=a.subrows)===null||h===void 0?void 0:h.columns[0],dataIndex:"key"},{title:(g=a.subrows)===null||g===void 0?void 0:g.columns[1],dataIndex:"value"}],dataSource:u[a.key].map(B=>{let[H,J]=B;return{key:H,value:J}})||[],loading:i,defaultSorting:{columnKey:"value",order:-1},embedded:!0}),Object(s.jsx)("div",{style:{margin:"1rem",textAlign:"center"},children:Object(s.jsx)(R.a,{disabled:u[a.key].length%V!==0,onClick:()=>y(a.key),children:"Load more values"})}),Object(s.jsx)(L.a,{})]},a.key)})]}):Object(s.jsx)(s.Fragment,{})}const F={component:p,logic:x},{TabPane:K}=b.a;function p(){const{user:e}=Object(o.useValues)(m.a),{activeTab:n}=Object(o.useValues)(x),{setActiveTab:r}=Object(o.useActions)(x);return e!=null&&e.is_staff?Object(s.jsxs)("div",{children:[Object(s.jsx)(O.a,{title:"Dead Letter Queue",caption:Object(s.jsx)(s.Fragment,{children:Object(s.jsx)("p",{children:"Manage your instance's dead letter queue."})})}),Object(s.jsx)(b.a,{activeKey:n,onChange:i=>r(i),children:Object(s.jsx)(K,{tab:"Metrics"},j.Metrics)}),n===j.Metrics?Object(s.jsx)(C,{}):null]}):Object(s.jsx)(O.a,{title:"Dead Letter Queue",caption:Object(s.jsxs)(s.Fragment,{children:[Object(s.jsx)("p",{children:"Only users with staff access can manage the dead letter queue. Please contact your instance admin."}),Object(s.jsxs)("p",{children:["If you're an admin and don't have access, set ",Object(s.jsx)("code",{children:"is_staff=true"})," for your user on the PostgreSQL ",Object(s.jsx)("code",{children:"posthog_user"})," table."]})]})})}}}]);
