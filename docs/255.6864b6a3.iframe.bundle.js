(window.webpackJsonp=window.webpackJsonp||[]).push([[255],{"./frontend/src/scenes/instance/AsyncMigrations/AsyncMigrations.tsx":function(_,C,r){"use strict";r.r(C),r.d(C,"scene",function(){return fe}),r.d(C,"AsyncMigrations",function(){return q});var x=r("./node_modules/core-js/modules/es.symbol.js"),k=r("./node_modules/core-js/modules/es.symbol.description.js"),w=r("./node_modules/core-js/modules/es.array.join.js"),K=r("./node_modules/core-js/modules/es.array.map.js"),U=r("./node_modules/core-js/modules/es.function.name.js"),N=r("./node_modules/core-js/modules/es.regexp.exec.js"),ee=r("./node_modules/core-js/modules/es.string.split.js"),V=r("./node_modules/react/index.js"),e=r.n(V),F=r("./frontend/src/lib/components/PageHeader.tsx"),z=r("./node_modules/antd/es/tabs/index.js"),ne=r("./node_modules/antd/es/progress/index.js"),Y=r("./node_modules/antd/es/button/index.js"),te=r("./node_modules/antd/es/space/index.js"),j=r("./node_modules/kea/lib/index.esm.js"),re=r("./node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js"),Ae=r("./node_modules/core-js/modules/es.array.filter.js"),je=r("./node_modules/core-js/modules/es.array.includes.js"),be=r("./node_modules/core-js/modules/es.array.iterator.js"),Oe=r("./node_modules/core-js/modules/es.object.to-string.js"),Ie=r("./node_modules/core-js/modules/es.string.includes.js"),Re=r("./node_modules/core-js/modules/web.dom-collections.iterator.js"),ae=r("./node_modules/@babel/runtime/regenerator/index.js"),f=r.n(ae),Ce=r("./node_modules/regenerator-runtime/runtime.js"),se=r("./node_modules/@babel/runtime/helpers/asyncToGenerator.js"),S=r.n(se),ie=r("./node_modules/@babel/runtime/helpers/defineProperty.js"),T=r.n(ie),h=r("./frontend/src/lib/api.ts"),D=r("./frontend/src/scenes/userLogic.ts"),E=r("./frontend/src/lib/components/lemonToast.tsx");function G(a,n){var s=Object.keys(a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(a);n&&(i=i.filter(function(u){return Object.getOwnPropertyDescriptor(a,u).enumerable})),s.push.apply(s,i)}return s}function A(a){for(var n=1;n<arguments.length;n++){var s=arguments[n]!=null?arguments[n]:{};n%2?G(Object(s),!0).forEach(function(i){T()(a,i,s[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(s)):G(Object(s)).forEach(function(i){Object.defineProperty(a,i,Object.getOwnPropertyDescriptor(s,i))})}return a}var y;(function(a){a[a.NotStarted=0]="NotStarted",a[a.Running=1]="Running",a[a.CompletedSuccessfully=2]="CompletedSuccessfully",a[a.Errored=3]="Errored",a[a.RolledBack=4]="RolledBack",a[a.Starting=5]="Starting",a[a.FailedAtStartup=6]="FailedAtStartup"})(y||(y={}));var b;(function(a){a.Management="management",a.Settings="settings"})(b||(b={}));var oe={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},R=Object(j.kea)({path:["scenes","instance","AsyncMigrations","asyncMigrationsLogic"],actions:{triggerMigration:function(n){return{migrationId:n}},resumeMigration:function(n){return{migrationId:n}},rollbackMigration:function(n){return{migrationId:n}},forceStopMigration:function(n){return{migrationId:n}},forceStopMigrationWithoutRollback:function(n){return{migrationId:n}},setActiveTab:function(n){return{tab:n}},updateSetting:function(n,s){return{settingKey:n,newValue:s}},loadAsyncMigrationErrors:function(n){return{migrationId:n}},loadAsyncMigrationErrorsSuccess:function(n,s){return{migrationId:n,errors:s}},loadAsyncMigrationErrorsFailure:function(n,s){return{migrationId:n,error:s}}},reducers:{activeTab:[b.Management,{setActiveTab:function(n,s){var i=s.tab;return i}}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:function(n,s){var i=s.migrationId,u=s.errors;return A(A({},n),{},T()({},i,u))}}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:function(n,s){var i=s.migrationId;return A(A({},n),{},T()({},i,!0))},loadAsyncMigrationErrorsSuccess:function(n,s){var i=s.migrationId;return A(A({},n),{},T()({},i,!1))},loadAsyncMigrationErrorsFailure:function(n,s){var i=s.migrationId;return A(A({},n),{},T()({},i,!1))}}]},loaders:function(){return{asyncMigrations:[[],{loadAsyncMigrations:function(){var n=S()(f.a.mark(function i(){var u;return f.a.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(!((u=D.a.values.user)===null||u===void 0)&&u.is_staff){d.next=2;break}return d.abrupt("return",[]);case 2:return d.next=4,h.a.get("api/async_migrations");case 4:return d.abrupt("return",d.sent.results);case 5:case"end":return d.stop()}},i)}));function s(){return n.apply(this,arguments)}return s}()}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:function(){var n=S()(f.a.mark(function i(){var u,c;return f.a.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!((u=D.a.values.user)===null||u===void 0)&&u.is_staff){o.next=2;break}return o.abrupt("return",[]);case 2:return o.next=4,h.a.get("api/instance_settings");case 4:return c=o.sent.results,o.abrupt("return",c.filter(function(l){return l.key.includes("ASYNC_MIGRATIONS")}));case 6:case"end":return o.stop()}},i)}));function s(){return n.apply(this,arguments)}return s}()}]}},listeners:function(n){var s=n.actions;return{triggerMigration:function(){var i=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.next=3,h.a.create("/api/async_migrations/".concat(o,"/trigger"));case 3:l=t.sent,l.success?(E.a.success("Migration triggered successfully"),s.loadAsyncMigrations()):E.a.error(l.error);case 5:case"end":return t.stop()}},c)}));function u(c){return i.apply(this,arguments)}return u}(),resumeMigration:function(){var i=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.next=3,h.a.create("/api/async_migrations/".concat(o,"/resume"));case 3:l=t.sent,l.success?(E.a.success("Migration resume triggered successfully"),s.loadAsyncMigrations()):E.a.error(l.error);case 5:case"end":return t.stop()}},c)}));function u(c){return i.apply(this,arguments)}return u}(),rollbackMigration:function(){var i=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.next=3,h.a.create("/api/async_migrations/".concat(o,"/rollback"));case 3:l=t.sent,l.success?(E.a.success("Migration rolledback triggered successfully"),s.loadAsyncMigrations()):E.a.error(l.error);case 5:case"end":return t.stop()}},c)}));function u(c){return i.apply(this,arguments)}return u}(),forceStopMigration:function(){var i=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.next=3,h.a.create("/api/async_migrations/".concat(o,"/force_stop"));case 3:l=t.sent,l.success?(E.a.success("Force stop triggered successfully"),s.loadAsyncMigrations()):E.a.error(l.error);case 5:case"end":return t.stop()}},c)}));function u(c){return i.apply(this,arguments)}return u}(),forceStopMigrationWithoutRollback:function(){var i=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.next=3,h.a.create("/api/async_migrations/".concat(o,"/force_stop_without_rollback"));case 3:l=t.sent,l.success?(E.a.success("Force stop without rollback triggered successfully"),s.loadAsyncMigrations()):E.a.error(l.error);case 5:case"end":return t.stop()}},c)}));function u(c){return i.apply(this,arguments)}return u}(),updateSetting:function(){var i=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.settingKey,l=d.newValue,t.prev=1,t.next=4,h.a.update("/api/instance_settings/".concat(o),{value:l});case 4:E.a.success("Instance setting ".concat(o," updated")),s.loadAsyncMigrationSettings(),t.next=11;break;case 8:t.prev=8,t.t0=t.catch(1),E.a.error("Failed to trigger migration");case 11:case"end":return t.stop()}},c,null,[[1,8]])}));function u(c){return i.apply(this,arguments)}return u}(),loadAsyncMigrationErrors:function(){var i=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.prev=1,t.next=4,h.a.get("api/async_migrations/".concat(o,"/errors"));case 4:l=t.sent,s.loadAsyncMigrationErrorsSuccess(o,l),t.next=11;break;case 8:t.prev=8,t.t0=t.catch(1),s.loadAsyncMigrationErrorsFailure(o,t.t0);case 11:case"end":return t.stop()}},c,null,[[1,8]])}));function u(c){return i.apply(this,arguments)}return u}()}},events:function(n){var s=n.actions;return{afterMount:function(){s.loadAsyncMigrations(),s.loadAsyncMigrationSettings()}}}}),H=r("./frontend/src/lib/components/Tooltip.tsx"),$=r("./frontend/src/lib/components/Spinner/Spinner.tsx"),le=r("./node_modules/@babel/runtime/helpers/slicedToArray.js"),ce=r.n(le),ue=r("./node_modules/antd/es/row/index.js"),J=r("./node_modules/antd/es/col/index.js"),de=r("./node_modules/antd/es/input/index.js"),ge=r("./node_modules/antd/es/divider/index.js");function P(a){var n=a.setting,s=Object(j.useActions)(R),i=s.updateSetting,u=Object(V.useState)(String(n.value)),c=ce()(u,2),d=c[0],o=c[1];return e.a.createElement("div",{key:n.key},e.a.createElement("h4",null,n.key),e.a.createElement("p",null,n.description),e.a.createElement(ue.a,{gutter:[8,8]},e.a.createElement(J.a,{span:8},e.a.createElement(de.a,{value:d,onChange:function(M){return o(M.target.value)}})),e.a.createElement(J.a,{span:16},e.a.createElement(Y.a,{disabled:String(n.value)===d,type:"primary",onClick:function(){return i(n.key,d)}},"Update"))),e.a.createElement(ge.a,null))}try{P.displayName="SettingUpdateField",P.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"InstanceSetting"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:P.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(a){}var Q=r("./frontend/src/lib/components/LemonTable/index.ts"),B=r("./frontend/src/lib/utils.tsx"),O=r("./frontend/src/lib/components/LemonButton/index.ts"),W=r("./frontend/src/lib/components/icons.tsx");function L(a){var n=a.asyncMigration,s=Object(j.useValues)(R),i=s.asyncMigrationErrorsLoading,u=s.asyncMigrationErrors,c=Object(j.useActions)(R),d=c.loadAsyncMigrationErrors,o=[{title:"Error",dataIndex:"description"},{title:e.a.createElement(O.a,{icon:i[n.id]?e.a.createElement($.a,{size:"sm"}):e.a.createElement(W.IconRefresh,null),onClick:function(){return d(n.id)},type:"secondary",compact:!0},"Refresh errors"),render:function(M,t){return e.a.createElement("div",null,Object(B.M)(t.created_at))}}];return e.a.createElement(Q.a,{columns:o,dataSource:u[n.id],loading:i[n.id],embedded:!0})}try{L.displayName="AsyncMigrationDetails",L.__docgenInfo={description:"",displayName:"AsyncMigrationDetails",props:{asyncMigration:{defaultValue:null,description:"",name:"asyncMigration",required:!0,type:{name:"AsyncMigration"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"]={docgenInfo:L.__docgenInfo,name:"AsyncMigrationDetails",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"})}catch(a){}var X=r("./frontend/src/lib/components/LemonButton/More.tsx"),me=r("./frontend/src/lib/components/LemonTag/LemonTag.tsx"),fe={component:q,logic:R},Z=z.a.TabPane;function q(){var a=Object(j.useValues)(D.a),n=a.user,s=Object(j.useValues)(R),i=s.asyncMigrations,u=s.asyncMigrationsLoading,c=s.activeTab,d=s.asyncMigrationSettings,o=Object(j.useActions)(R),l=o.triggerMigration,M=o.resumeMigration,t=o.rollbackMigration,pe=o.forceStopMigration,ye=o.forceStopMigrationWithoutRollback,ve=o.loadAsyncMigrations,Ee=o.loadAsyncMigrationErrors,Me=o.setActiveTab,Se=[{title:"Migration",render:function(p,m){var g="https://posthog.com/docs/self-host/configure/async-migrations/"+m.name.split("_").join("-");return e.a.createElement(e.a.Fragment,null,e.a.createElement("div",{className:"row-name"},e.a.createElement("a",{href:g},m.name)),e.a.createElement("div",{className:"row-description"},m.description))}},{title:"Progress",render:function(p,m){var g=m.progress;return e.a.createElement("div",null,e.a.createElement(ne.a,{percent:g}))}},{title:"Status",render:function(p,m){var g=m.status,I=g===y.Running?"success":g===y.Errored||g===y.FailedAtStartup?"danger":g===y.Starting||g===y.RolledBack?"warning":"default";return e.a.createElement(me.a,{type:I},oe[g])}},{title:"Last operation index",dataIndex:"current_operation_index"},{title:"Last query ID",render:function(p,m){return e.a.createElement("div",null,e.a.createElement("small",null,m.current_query_id))}},{title:"Started at",render:function(p,m){var g=m.started_at;return e.a.createElement("div",null,Object(B.M)(g))}},{title:"Finished at",render:function(p,m){var g=m.finished_at;return e.a.createElement("div",null,Object(B.M)(g))}},{title:"",render:function(p,m){var g=m.status;return e.a.createElement("div",null,g===y.NotStarted||g===y.FailedAtStartup?e.a.createElement(H.a,{title:"Start"},e.a.createElement(Y.a,{type:"link",icon:e.a.createElement(re.a,null),onClick:function(){return l(m.id)}},"Run")):g===y.Running?e.a.createElement(X.a,{overlay:e.a.createElement(e.a.Fragment,null,e.a.createElement(O.a,{type:"stealth",onClick:function(){return pe(m.id)},fullWidth:!0},"Stop and rollback"),e.a.createElement(O.a,{type:"stealth",onClick:function(){return ye(m.id)},fullWidth:!0},"Stop"))}):g===y.CompletedSuccessfully?e.a.createElement(e.a.Fragment,null):g===y.Errored?e.a.createElement(X.a,{overlay:e.a.createElement(e.a.Fragment,null,e.a.createElement(O.a,{type:"stealth",onClick:function(){return M(m.id)},fullWidth:!0},"Resume"),e.a.createElement(O.a,{type:"stealth",onClick:function(){return t(m.id)},fullWidth:!0},"Rollback"))}):g===y.RolledBack?e.a.createElement(H.a,{title:"Restart"},e.a.createElement(O.a,{type:"stealth",icon:e.a.createElement(W.IconReplay,null),onClick:function(){return l(m.id)},fullWidth:!0})):g===y.Starting?e.a.createElement($.a,{size:"sm"}):null)}}],he={expandedRowRender:function(p){return p&&e.a.createElement(L,{asyncMigration:p})},rowExpandable:function(p){return p.error_count>0},onRowExpand:function(p){Ee(p.id)}};return e.a.createElement("div",null,n!=null&&n.is_staff?e.a.createElement(e.a.Fragment,null,e.a.createElement(F.a,{title:"Async Migrations",caption:e.a.createElement(e.a.Fragment,null,e.a.createElement("p",null,"Manage async migrations in your instance."),e.a.createElement("p",null,"Read about async migrations on our"," ",e.a.createElement("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations"},"dedicated docs page"),"."))}),e.a.createElement(z.a,{activeKey:c,onChange:function(p){return Me(p)}},e.a.createElement(Z,{tab:"Management",key:b.Management}),e.a.createElement(Z,{tab:"Settings",key:b.Settings})),c===b.Management?e.a.createElement(e.a.Fragment,null,e.a.createElement("div",{className:"mb float-right"},e.a.createElement(O.a,{icon:u?e.a.createElement($.a,{size:"sm"}):e.a.createElement(W.IconRefresh,null),onClick:ve,type:"secondary",compact:!0},"Refresh")),e.a.createElement(te.b,null),e.a.createElement(Q.a,{pagination:{pageSize:10},loading:u,columns:Se,dataSource:i,expandable:he})):c===b.Settings?e.a.createElement(e.a.Fragment,null,e.a.createElement("br",null),d.map(function(v){return e.a.createElement("div",{key:v.key},e.a.createElement(P,{setting:v}))})):null):e.a.createElement(F.a,{title:"Async Migrations",caption:e.a.createElement(e.a.Fragment,null,e.a.createElement("p",null,"Only users with staff access can manage async migrations. Please contact your instance admin."),e.a.createElement("p",null,"If you're an admin and don't have access, set ",e.a.createElement("code",null,"is_staff=true")," for your user on the PostgreSQL ",e.a.createElement("code",null,"posthog_user")," table."))}))}},"./node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js":function(_,C,r){"use strict";var x=r("./node_modules/@babel/runtime/helpers/esm/objectSpread2.js"),k=r("./node_modules/react/index.js"),w={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}},{tag:"path",attrs:{d:"M719.4 499.1l-296.1-215A15.9 15.9 0 00398 297v430c0 13.1 14.8 20.5 25.3 12.9l296.1-215a15.9 15.9 0 000-25.8zm-257.6 134V390.9L628.5 512 461.8 633.1z"}}]},name:"play-circle",theme:"outlined"},K=w,U=r("./node_modules/@ant-design/icons/es/components/AntdIcon.js"),N=function(e,F){return k.createElement(U.a,Object(x.a)(Object(x.a)({},e),{},{ref:F,icon:K}))};N.displayName="PlayCircleOutlined";var ee=C.a=k.forwardRef(N)}}]);
