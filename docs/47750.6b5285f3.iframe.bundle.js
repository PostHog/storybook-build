"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[47750],{"../../frontend/src/scenes/experiments/ExperimentMetricForm.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{U:()=>ExperimentMetricForm});var lib_lemon_ui_LemonRadio__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonRadio/index.ts"),scenes_insights_filters_ActionFilter_ActionFilter__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),_queries_Query_Query__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/queries/Query/Query.tsx"),_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),_Metrics_Selectors__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/scenes/experiments/Metrics/Selectors.tsx"),_utils__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/scenes/experiments/utils.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let dataWarehousePopoverFields=[{key:"timestamp_field",label:"Timestamp Field"},{key:"data_warehouse_join_key",label:"Data Warehouse Join Key",allowHogQL:!0},{key:"events_join_key",label:"Events Join Key",allowHogQL:!0,hogQLOnly:!0,tableName:"events"}];function ExperimentMetricForm(_ref){let{metric,handleSetMetric}=_ref,mathAvailability=(0,_utils__WEBPACK_IMPORTED_MODULE_5__.Vb)(metric.metric_type),allowedMathTypes=(0,_utils__WEBPACK_IMPORTED_MODULE_5__.dR)(metric.metric_type),isDataWarehouseMetric=metric.metric_config.kind===_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_3__.OH.ExperimentDataWarehouseMetricConfig;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsxs)("div",{className:"space-y-4",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsxs)("div",{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)("h4",{className:"mb-2",children:"Metric type"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)(lib_lemon_ui_LemonRadio__WEBPACK_IMPORTED_MODULE_0__._,{"data-attr":"metrics-selector",value:metric.metric_type,onChange:newMetricType=>{let newAllowedMathTypes=(0,_utils__WEBPACK_IMPORTED_MODULE_5__.dR)(newMetricType);handleSetMetric({newMetric:{...metric,metric_type:newMetricType,metric_config:{...metric.metric_config,math:newAllowedMathTypes[0]}}})},options:[{value:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_3__.Tu.BINOMIAL,label:"Binomial",description:"Tracks whether an event happens for each user, useful for measuring conversion rates."},{value:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_3__.Tu.COUNT,label:"Count",description:"Tracks how many times an event happens, useful for click counts or page views."},{value:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_3__.Tu.CONTINUOUS,label:"Continuous",description:"Measures numerical values like revenue or session length."}]})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)(scenes_insights_filters_ActionFilter_ActionFilter__WEBPACK_IMPORTED_MODULE_1__.T,{bordered:!0,filters:(0,_utils__WEBPACK_IMPORTED_MODULE_5__.XX)(metric.metric_config),setFilters:_ref2=>{let{actions,events,data_warehouse}=_ref2,entity=events?.[0]||actions?.[0]||data_warehouse?.[0],metricConfig=(0,_utils__WEBPACK_IMPORTED_MODULE_5__.jG)(entity);metricConfig&&handleSetMetric({newMetric:{...metric,metric_config:metricConfig}})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!1,hideRename:!0,entitiesLimit:1,showNumericalPropsOnly:!0,mathAvailability:mathAvailability,allowedMathTypes:allowedMathTypes,dataWarehousePopoverFields:dataWarehousePopoverFields,..._Metrics_Selectors__WEBPACK_IMPORTED_MODULE_4__.dF}),(metric.metric_type===_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_3__.Tu.COUNT||metric.metric_type===_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_3__.Tu.CONTINUOUS)&&!isDataWarehouseMetric&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)(_queries_Query_Query__WEBPACK_IMPORTED_MODULE_2__.A,{query:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_3__.OH.InsightVizNode,source:(0,_utils__WEBPACK_IMPORTED_MODULE_5__.PI)(metric),showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0}),metric.metric_type===_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_3__.Tu.BINOMIAL&&!isDataWarehouseMetric&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)(_queries_Query_Query__WEBPACK_IMPORTED_MODULE_2__.A,{query:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_3__.OH.InsightVizNode,source:(0,_utils__WEBPACK_IMPORTED_MODULE_5__.PI)(metric),showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})]})}},"../../frontend/src/scenes/experiments/Metrics/Selectors.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{IF:()=>FunnelConversionWindowFilter,dF:()=>commonActionFilterProps,f$:()=>FunnelAttributionSelect,xE:()=>FunnelAggregationSelect});var _posthog_icons__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.11.1_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib_components_HogQLEditor_HogQLEditor__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/components/HogQLEditor/HogQLEditor.tsx"),lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),lib_introductions_groupsAccessLogic__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/introductions/groupsAccessLogic.ts"),lib_lemon_ui_Tooltip__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/lib/lemon-ui/Tooltip/index.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/lib/utils.tsx"),scenes_groups_GroupsIntroduction__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../frontend/src/scenes/groups/GroupsIntroduction.tsx"),scenes_insights_EditorFilters_FunnelsQuerySteps__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../frontend/src/scenes/insights/EditorFilters/FunnelsQuerySteps.tsx"),scenes_insights_views_Funnels_FunnelConversionWindowFilter__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("../../frontend/src/scenes/insights/views/Funnels/FunnelConversionWindowFilter.tsx"),_models_groupsModel__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("../../frontend/src/models/groupsModel.ts"),_types__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("../../frontend/src/types.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let commonActionFilterProps={actionsTaxonomicGroupTypes:[lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Events,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Actions,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.DataWarehouse],propertiesTaxonomicGroupTypes:[lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.EventProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.PersonProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.EventFeatureFlags,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Cohorts,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Elements,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.SessionProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.HogQLExpression,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.DataWarehouseProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.DataWarehousePersonProperties]};function FunnelAggregationSelect(_ref){let{value,onChange}=_ref,{groupTypes,aggregationLabel}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(_models_groupsModel__WEBPACK_IMPORTED_MODULE_11__.$),{needsUpgradeForGroups,canStartUsingGroups}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(lib_introductions_groupsAccessLogic__WEBPACK_IMPORTED_MODULE_5__.e),UNIQUE_USERS="person_id",baseValues=[UNIQUE_USERS],optionSections=[{title:"Event Aggregation",options:[{value:UNIQUE_USERS,label:"Unique users"}]}];return needsUpgradeForGroups||canStartUsingGroups?optionSections[0].footer=(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(scenes_groups_GroupsIntroduction__WEBPACK_IMPORTED_MODULE_8__.b,{needsUpgrade:needsUpgradeForGroups}):Array.from(groupTypes.values()).forEach(groupType=>{baseValues.push(`$group_${groupType.group_type_index}`),optionSections[0].options.push({value:`$group_${groupType.group_type_index}`,label:`Unique ${aggregationLabel(groupType.group_type_index).plural}`})}),baseValues.push("properties.$session_id"),optionSections[0].options.push({value:"properties.$session_id",label:"Unique sessions"}),optionSections[0].options.push({label:"Custom SQL expression",options:[{value:!value||baseValues.includes(value)?"":value,label:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("span",{className:"font-mono",children:value}),labelInMenu:function CustomHogQLOptionWrapped(_ref2){let{onSelect}=_ref2;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("div",{className:"w-120",style:{maxWidth:"max(60vw, 20rem)"},children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_components_HogQLEditor_HogQLEditor__WEBPACK_IMPORTED_MODULE_3__.E,{onChange:onSelect,value:value,placeholder:"Enter SQL expression, such as:\n- distinct_id\n- properties.$session_id\n- concat(distinct_id, ' ', properties.$session_id)\n- if(1 < 2, 'one', 'two')"})})}}]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"flex items-center w-full gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("span",{children:"Aggregating by"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Yv,{className:"flex-1",value:value,onChange:onChange,options:optionSections,dropdownMatchSelectWidth:!1})]})}function FunnelConversionWindowFilter(_ref3){let{funnelWindowInterval,funnelWindowIntervalUnit,onFunnelWindowIntervalChange,onFunnelWindowIntervalUnitChange}=_ref3,options=Object.keys(scenes_insights_views_Funnels_FunnelConversionWindowFilter__WEBPACK_IMPORTED_MODULE_10__.V).map(unit=>({label:(0,lib_utils__WEBPACK_IMPORTED_MODULE_7__.fm)((0,lib_utils__WEBPACK_IMPORTED_MODULE_7__.Zi)(null!=funnelWindowInterval?funnelWindowInterval:7,unit,`${unit}s`,!1)),value:unit})),intervalBounds=scenes_insights_views_Funnels_FunnelConversionWindowFilter__WEBPACK_IMPORTED_MODULE_10__.V[null!=funnelWindowIntervalUnit?funnelWindowIntervalUnit:_types__WEBPACK_IMPORTED_MODULE_12__.ih.Day];return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"flex items-center gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("span",{className:"flex whitespace-nowrap",children:["Conversion window limit",(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_Tooltip__WEBPACK_IMPORTED_MODULE_6__.u,{title:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("b",{children:"Recommended!"})," Limit to participants that converted within a specific time frame. Participants that do not convert in this time frame will be considered as drop-offs."]}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconInfo,{className:"w-4 info-indicator"})})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"flex items-center gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.DF,{type:"number",className:"max-w-20",fullWidth:!1,min:intervalBounds[0],max:intervalBounds[1],value:funnelWindowInterval,onChange:onFunnelWindowIntervalChange}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Yv,{dropdownMatchSelectWidth:!1,value:funnelWindowIntervalUnit,onChange:onFunnelWindowIntervalUnitChange,options:options})]})]})}function FunnelAttributionSelect(_ref4){let{value,onChange,stepsLength}=_ref4,funnelOrderType=void 0;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"flex items-center w-full gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"flex",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("span",{children:"Attribution type"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_Tooltip__WEBPACK_IMPORTED_MODULE_6__.u,{closeDelayMs:200,title:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"space-y-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("div",{children:"When breaking down funnels, it's possible that the same properties don't exist on every event. For example, if you want to break down by browser on a funnel that contains both frontend and backend events."}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("div",{children:"In this case, you can choose from which step the properties should be selected from by modifying the attribution type. There are four modes to choose from:"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("ul",{className:"list-disc pl-4",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("li",{children:"First touchpoint: the first property value seen in any of the steps is chosen."}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("li",{children:"Last touchpoint: the last property value seen from all steps is chosen."}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("li",{children:"All steps: the property value must be seen in all steps to be considered in the funnel."}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("li",{children:"Specific step: only the property value seen at the selected step is chosen."})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{children:["Read more in the"," ",(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.rU,{to:"https://posthog.com/docs/product-analytics/funnels#attribution-types",children:"documentation."})]})]}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconInfo,{className:"text-xl text-secondary shrink-0 ml-1"})})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Yv,{value:value,placeholder:"Attribution",options:[{value:_types__WEBPACK_IMPORTED_MODULE_12__.q9.FirstTouch,label:"First touchpoint"},{value:_types__WEBPACK_IMPORTED_MODULE_12__.q9.LastTouch,label:"Last touchpoint"},{value:_types__WEBPACK_IMPORTED_MODULE_12__.q9.AllSteps,label:"All steps"},{value:_types__WEBPACK_IMPORTED_MODULE_12__.q9.Step,label:"Any step",hidden:funnelOrderType!==_types__WEBPACK_IMPORTED_MODULE_12__.kO.UNORDERED},{label:"Specific step",options:Array(scenes_insights_EditorFilters_FunnelsQuerySteps__WEBPACK_IMPORTED_MODULE_9__.i).fill(null).map((_,stepIndex)=>({value:`${_types__WEBPACK_IMPORTED_MODULE_12__.q9.Step}/${stepIndex}`,label:`Step ${stepIndex+1}`,hidden:stepIndex>=stepsLength})),hidden:funnelOrderType===_types__WEBPACK_IMPORTED_MODULE_12__.kO.UNORDERED}],onChange:onChange,dropdownMaxContentWidth:!0,"data-attr":"breakdown-attributions"})]})}},"../../frontend/src/scenes/experiments/SharedMetrics/SharedMetric.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{SharedMetric:()=>SharedMetric,scene:()=>scene});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.11.1_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),ObjectTags=__webpack_require__("../../frontend/src/lib/components/ObjectTags/ObjectTags.tsx"),themeLogic=__webpack_require__("../../frontend/src/layout/navigation-3000/themeLogic.ts"),tagsModel=__webpack_require__("../../frontend/src/models/tagsModel.ts"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),ExperimentMetricForm=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentMetricForm.tsx"),utils=__webpack_require__("../../frontend/src/scenes/experiments/utils.ts"),types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),TestAccountFiltersSwitch=__webpack_require__("../../frontend/src/lib/components/TestAccountFiltersSwitch.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),ActionFilter=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),AggregationSelect=__webpack_require__("../../frontend/src/scenes/insights/filters/AggregationSelect.tsx"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),filtersToQueryNode=__webpack_require__("../../frontend/src/queries/nodes/InsightQuery/utils/filtersToQueryNode.ts"),queryNodeToFilter=__webpack_require__("../../frontend/src/queries/nodes/InsightQuery/utils/queryNodeToFilter.ts"),Query=__webpack_require__("../../frontend/src/queries/Query/Query.tsx"),src_types=__webpack_require__("../../frontend/src/types.ts"),Selectors=__webpack_require__("../../frontend/src/scenes/experiments/Metrics/Selectors.tsx"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),eventUsageLogic=__webpack_require__("../../frontend/src/lib/utils/eventUsageLogic.ts"),sharedMetricsLogic=__webpack_require__("../../frontend/src/scenes/experiments/SharedMetrics/sharedMetricsLogic.tsx");let NEW_SHARED_METRIC={name:"",description:"",query:void 0,tags:[]},sharedMetricLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.path)(key=>["scenes","experiments","sharedMetricLogic",key]),(0,index_esm.key)(props=>props.sharedMetricId||"new"),(0,index_esm.connect)(()=>({actions:[sharedMetricsLogic.G,["loadSharedMetrics"],eventUsageLogic.vx,["reportExperimentSharedMetricCreated"]],values:[featureFlagLogic.h,["featureFlags"]]})),(0,index_esm.actions)({setSharedMetric:metric=>({metric}),createSharedMetric:!0,updateSharedMetric:!0,deleteSharedMetric:!0}),(0,lib.loaders)(_ref=>{let{props,values}=_ref;return{sharedMetric:{loadSharedMetric:async()=>props.sharedMetricId&&"new"!==props.sharedMetricId?await api.ZP.get(`api/projects/@current/experiment_saved_metrics/${props.sharedMetricId}`):{...values.newSharedMetric}}}}),(0,index_esm.listeners)(_ref2=>{let{actions,values}=_ref2;return{createSharedMetric:async()=>{let response=await api.ZP.create("api/projects/@current/experiment_saved_metrics/",values.sharedMetric);response.id&&(src.UJ.success("Shared metric created successfully"),actions.reportExperimentSharedMetricCreated(response),actions.loadSharedMetrics(),kea_router_lib.router.actions.push("/experiments/shared-metrics"))},updateSharedMetric:async()=>{(await api.ZP.update(`api/projects/@current/experiment_saved_metrics/${values.sharedMetricId}`,values.sharedMetric)).id&&(src.UJ.success("Shared metric updated successfully"),actions.loadSharedMetrics(),kea_router_lib.router.actions.push("/experiments/shared-metrics"))},deleteSharedMetric:async()=>{try{await api.ZP.delete(`api/projects/@current/experiment_saved_metrics/${values.sharedMetricId}`),src.UJ.success("Shared metric deleted successfully"),actions.loadSharedMetrics(),kea_router_lib.router.actions.push("/experiments/shared-metrics")}catch(error){src.UJ.error("Failed to delete shared metric"),console.error(error)}}}}),(0,index_esm.reducers)({sharedMetric:[{...NEW_SHARED_METRIC},{setSharedMetric:(state,_ref3)=>{let{metric}=_ref3;return{...state,...metric}}}]}),(0,index_esm.selectors)({sharedMetricId:[()=>[(_,props)=>{var _props$sharedMetricId;return null!==(_props$sharedMetricId=props.sharedMetricId)&&void 0!==_props$sharedMetricId?_props$sharedMetricId:"new"}],sharedMetricId=>sharedMetricId],isNew:[s=>[s.sharedMetricId],sharedMetricId=>"new"===sharedMetricId],newSharedMetric:[s=>[s.featureFlags],featureFlags=>({...NEW_SHARED_METRIC,query:featureFlags[constants.y8.EXPERIMENTS_NEW_QUERY_RUNNER]?(0,utils.SV)():(0,utils.ug)()})]}),(0,kea_router_lib.urlToAction)(_ref4=>{let{actions,values}=_ref4;return{"/experiments/shared-metrics/:id":(_ref5,_,__,currentLocation,previousLocation)=>{let{id}=_ref5,didPathChange=currentLocation.initial||currentLocation.pathname!==previousLocation?.pathname;if(id&&didPathChange){let parsedId="new"===id?"new":parseInt(id);"new"===parsedId&&actions.setSharedMetric({...values.newSharedMetric}),"new"!==parsedId&&parsedId===values.sharedMetricId&&actions.loadSharedMetric()}}}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function LegacySharedFunnelsMetricForm(){var _sharedMetricQuery$fu,_sharedMetricQuery$fu2;let{sharedMetric}=(0,index_esm.useValues)(sharedMetricLogic),{setSharedMetric}=(0,index_esm.useActions)(sharedMetricLogic),{currentTeam}=(0,index_esm.useValues)(teamLogic.H),hasFilters=(currentTeam?.test_account_filters||[]).length>0,actionFilterProps={...Selectors.dF,actionsTaxonomicGroupTypes:[types.t.Events,types.t.Actions]};if(!sharedMetric?.query)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let sharedMetricQuery=sharedMetric.query;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(sharedMetricQuery.funnels_query),setFilters:_ref=>{let{actions,events,data_warehouse}=_ref;if(!sharedMetric?.query)return;let series=(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.None);setSharedMetric({query:{...sharedMetricQuery,funnels_query:{...sharedMetricQuery.funnels_query,series}}})},typeKey:"experiment-metric",mathAvailability:ActionFilterRow.Qq.None,buttonCopy:"Add funnel step",showSeriesIndicator:!0,seriesIndicatorType:"numeric",sortable:!0,showNestedArrow:!0,...actionFilterProps}),(0,jsx_runtime.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,jsx_runtime.jsx)(Selectors.xE,{value:(0,AggregationSelect.eV)(null!==(_sharedMetricQuery$fu=sharedMetricQuery.funnels_query.aggregation_group_type_index)&&void 0!==_sharedMetricQuery$fu?_sharedMetricQuery$fu:void 0,null!==(_sharedMetricQuery$fu2=sharedMetricQuery.funnels_query.funnelsFilter?.funnelAggregateByHogQL)&&void 0!==_sharedMetricQuery$fu2?_sharedMetricQuery$fu2:void 0),onChange:value=>{setSharedMetric({query:{...sharedMetricQuery,funnels_query:{...sharedMetricQuery.funnels_query,funnelsFilter:{...sharedMetricQuery.funnels_query.funnelsFilter,funnelAggregateByHogQL:value}}}})}}),(0,jsx_runtime.jsx)(Selectors.IF,{funnelWindowInterval:sharedMetricQuery.funnels_query?.funnelsFilter?.funnelWindowInterval,funnelWindowIntervalUnit:sharedMetricQuery.funnels_query?.funnelsFilter?.funnelWindowIntervalUnit,onFunnelWindowIntervalChange:funnelWindowInterval=>{setSharedMetric({query:{...sharedMetricQuery,funnels_query:{...sharedMetricQuery.funnels_query,funnelsFilter:{...sharedMetricQuery.funnels_query.funnelsFilter,funnelWindowInterval:funnelWindowInterval}}}})},onFunnelWindowIntervalUnitChange:funnelWindowIntervalUnit=>{setSharedMetric({query:{...sharedMetricQuery,funnels_query:{...sharedMetricQuery.funnels_query,funnelsFilter:{...sharedMetricQuery.funnels_query.funnelsFilter,funnelWindowIntervalUnit:funnelWindowIntervalUnit||void 0}}}})}}),(0,jsx_runtime.jsx)(Selectors.f$,{value:(()=>{let breakdownAttributionType=sharedMetricQuery.funnels_query?.funnelsFilter?.breakdownAttributionType,breakdownAttributionValue=sharedMetricQuery.funnels_query?.funnelsFilter?.breakdownAttributionValue;return breakdownAttributionType?breakdownAttributionType===src_types.q9.Step?`${breakdownAttributionType}/${breakdownAttributionValue||0}`:breakdownAttributionType:src_types.q9.FirstTouch})(),onChange:value=>{let[breakdownAttributionType,breakdownAttributionValue]=(value||"").split("/");setSharedMetric({query:{...sharedMetricQuery,funnels_query:{...sharedMetricQuery.funnels_query,funnelsFilter:{...sharedMetricQuery.funnels_query.funnelsFilter,breakdownAttributionType:breakdownAttributionType,breakdownAttributionValue:breakdownAttributionValue?parseInt(breakdownAttributionValue):void 0}}}})},stepsLength:sharedMetricQuery.funnels_query?.series?.length}),(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=sharedMetricQuery.funnels_query?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{setSharedMetric({query:{...sharedMetricQuery,funnels_query:{...sharedMetricQuery.funnels_query,filterTestAccounts:checked}}})},fullWidth:!0})]}),(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema_general.OH.InsightVizNode,source:sharedMetricQuery.funnels_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})}var dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),experiments_constants=__webpack_require__("../../frontend/src/scenes/experiments/constants.ts");function LegacySharedTrendsMetricForm(){let{sharedMetric}=(0,index_esm.useValues)(sharedMetricLogic),{setSharedMetric}=(0,index_esm.useActions)(sharedMetricLogic),{currentTeam}=(0,index_esm.useValues)(teamLogic.H),hasFilters=(currentTeam?.test_account_filters||[]).length>0,[activeTab,setActiveTab]=(0,react.useState)("main");if(!sharedMetric?.query)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let sharedMetricQuery=sharedMetric.query;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,onChange:newKey=>setActiveTab(newKey),tabs:[{key:"main",label:"Main metric",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(sharedMetricQuery.count_query),setFilters:_ref=>{let{actions,events,data_warehouse}=_ref,series=(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.All);setSharedMetric({query:{...sharedMetricQuery,count_query:{...sharedMetricQuery.count_query,series}}})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!0,entitiesLimit:1,showNumericalPropsOnly:!0,allowedMathTypes:experiments_constants.B,...Selectors.dF}),(0,jsx_runtime.jsx)("div",{className:"mt-4 space-y-4",children:(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=sharedMetricQuery.count_query?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{setSharedMetric({query:{...sharedMetricQuery,count_query:{...sharedMetricQuery.count_query,filterTestAccounts:checked}}})},fullWidth:!0})}),(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema_general.OH.InsightVizNode,source:sharedMetricQuery.count_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})},{key:"exposure",label:"Exposure",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${sharedMetricQuery.exposure_query?"border-border":"border-accent-primary bg-accent-primary-highlight"}`,onClick:()=>{setSharedMetric({query:{...sharedMetricQuery,exposure_query:void 0}})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Default"}),!sharedMetricQuery.exposure_query&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--accent-primary)"})]}),(0,jsx_runtime.jsxs)("div",{className:"text-secondary text-sm leading-relaxed",children:["Uses the number of unique users who trigger the"," ",(0,jsx_runtime.jsx)(src.oe,{children:"$feature_flag_called"})," event as your exposure count. This is the recommended setting for most experiments, as it accurately tracks variant exposure."]})]}),(0,jsx_runtime.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${sharedMetricQuery.exposure_query?"border-accent-primary bg-accent-primary-highlight":"border-border"}`,onClick:()=>{setSharedMetric({query:{...sharedMetricQuery,exposure_query:{kind:schema_general.OH.TrendsQuery,series:[{kind:schema_general.OH.EventsNode,name:"$feature_flag_called",event:"$feature_flag_called",math:src_types.vN.UniqueUsers}],interval:"day",dateRange:{date_from:(0,dayjs.Bv)().subtract(constants.uq,"day").format("YYYY-MM-DDTHH:mm"),date_to:(0,dayjs.Bv)().endOf("d").format("YYYY-MM-DDTHH:mm"),explicitDate:!0},trendsFilter:{display:src_types.Qb.ActionsLineGraph},filterTestAccounts:!0}}})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Custom"}),sharedMetricQuery.exposure_query&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--accent-primary)"})]}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Define your own exposure metric for specific use cases, such as counting by sessions instead of users. This gives you full control but requires careful configuration."})]})]}),sharedMetricQuery.exposure_query&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(sharedMetricQuery.exposure_query),setFilters:_ref2=>{let{actions,events,data_warehouse}=_ref2,series=(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.All);setSharedMetric({query:{...sharedMetricQuery,exposure_query:{...sharedMetricQuery.exposure_query,series}}})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!0,entitiesLimit:1,showNumericalPropsOnly:!0,allowedMathTypes:experiments_constants.B,...Selectors.dF}),(0,jsx_runtime.jsx)("div",{className:"mt-4 space-y-4",children:(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=sharedMetricQuery.exposure_query?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{setSharedMetric({query:{...sharedMetricQuery,exposure_query:{...sharedMetricQuery.exposure_query,filterTestAccounts:checked}}})},fullWidth:!0})}),(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema_general.OH.InsightVizNode,source:sharedMetricQuery.exposure_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})]})}]})})}let scene={component:SharedMetric,logic:sharedMetricLogic,paramsToProps:_ref=>{let{params:{id}}=_ref;return{sharedMetricId:"new"===id?"new":parseInt(id)}}};function SharedMetric(){let{sharedMetricId,sharedMetric}=(0,index_esm.useValues)(sharedMetricLogic),{setSharedMetric,createSharedMetric,updateSharedMetric,deleteSharedMetric}=(0,index_esm.useActions)(sharedMetricLogic),{isDarkModeOn}=(0,index_esm.useValues)(themeLogic.b),{tags:allExistingTags}=(0,index_esm.useValues)(tagsModel.x);return sharedMetric&&sharedMetric.query?(0,jsx_runtime.jsxs)("div",{className:"max-w-[800px]",children:[sharedMetric.query.kind!==schema_general.OH.ExperimentMetric&&(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${sharedMetric.query.kind===schema_general.OH.ExperimentTrendsQuery?"border-accent-primary bg-accent-primary-highlight":"border-border"}`,onClick:()=>{setSharedMetric({query:(0,utils.ug)()})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Trend"}),sharedMetric.query.kind===schema_general.OH.ExperimentTrendsQuery&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--accent-primary)"})]}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Track a single event, action or a property value."})]}),(0,jsx_runtime.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${sharedMetric.query.kind===schema_general.OH.ExperimentFunnelsQuery?"border-accent-primary bg-accent-primary-highlight":"border-border"}`,onClick:()=>{setSharedMetric({query:(0,utils.xs)()})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Funnel"}),sharedMetric.query.kind===schema_general.OH.ExperimentFunnelsQuery&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--accent-primary)"})]}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Analyze conversion rates between sequential steps."})]})]}),(0,jsx_runtime.jsxs)("div",{className:`border rounded ${isDarkModeOn?"bg-light":"bg-white"} p-4`,children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Name"}),(0,jsx_runtime.jsx)(src.DF,{value:sharedMetric.name,onChange:newName=>{setSharedMetric({name:newName})}})]}),(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Description (optional)"}),(0,jsx_runtime.jsx)(src.DF,{value:sharedMetric.description,onChange:newDescription=>{setSharedMetric({description:newDescription})}})]}),(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Tags"}),(0,jsx_runtime.jsx)("div",{className:"mt-2",children:(0,jsx_runtime.jsx)(ObjectTags.D,{tags:sharedMetric.tags||[],onChange:newTags=>{setSharedMetric({tags:newTags})},saving:!1,tagsAvailable:allExistingTags,"data-attr":"shared-metric-tags"})})]}),sharedMetric.query.kind===schema_general.OH.ExperimentMetric?(0,jsx_runtime.jsx)(ExperimentMetricForm.U,{metric:sharedMetric.query,handleSetMetric:_ref2=>{let{newMetric}=_ref2;setSharedMetric({...sharedMetric,query:newMetric})}}):sharedMetric.query.kind===schema_general.OH.ExperimentTrendsQuery?(0,jsx_runtime.jsx)(LegacySharedTrendsMetricForm,{}):(0,jsx_runtime.jsx)(LegacySharedFunnelsMetricForm,{})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between mt-4",children:["new"!==sharedMetricId&&(0,jsx_runtime.jsx)(src.Jp,{size:"medium",type:"primary",status:"danger",onClick:()=>{src.dn.open({title:"Delete this metric?",content:(0,jsx_runtime.jsx)("div",{className:"text-sm text-secondary",children:"This action cannot be undone."}),primaryButton:{children:"Delete",type:"primary",onClick:()=>deleteSharedMetric(),size:"small"},secondaryButton:{children:"Cancel",type:"tertiary",size:"small"}})},children:"Delete"}),(0,jsx_runtime.jsx)(src.Jp,{className:"ml-auto",disabledReason:sharedMetric.name?void 0:"You must give your metric a name",size:"medium",type:"primary",onClick:()=>{"new"===sharedMetricId?createSharedMetric():updateSharedMetric()},children:"Save"})]})]}):(0,jsx_runtime.jsx)("div",{className:"fixed inset-0 flex justify-center items-center",children:(0,jsx_runtime.jsx)(src.$j,{className:"text-5xl"})})}}}]);