"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[61330],{"../../frontend/src/scenes/instance/DeadLetterQueue/DeadLetterQueue.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{DeadLetterQueue:()=>DeadLetterQueue,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.30.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),LemonTabs=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTabs/index.ts"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),SceneContent=__webpack_require__("../../frontend/src/layout/scenes/components/SceneContent.tsx"),SceneDivider=__webpack_require__("../../frontend/src/layout/scenes/components/SceneDivider.tsx"),SceneTitleSection=__webpack_require__("../../frontend/src/layout/scenes/components/SceneTitleSection.tsx"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),DateFilter=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonTable=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/index.ts"),Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/Spinner.tsx"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),copyToClipboard=__webpack_require__("../../frontend/src/lib/utils/copyToClipboard.tsx"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts");let DeadLetterQueueTab=function(DeadLetterQueueTab){return DeadLetterQueueTab.Metrics="metrics",DeadLetterQueueTab.Management="management",DeadLetterQueueTab.Settings="settings",DeadLetterQueueTab}({}),deadLetterQueueLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","instance","DeadLetterQueue","deadLetterQueueLogic"]),(0,index_esm.actions)({setActiveTab:tabKey=>({tabKey}),loadMoreRows:key=>({key}),addRowsToMetric:(key,rows)=>({key,rows}),setFilters:filters=>({filters})}),(0,index_esm.reducers)({activeTab:[DeadLetterQueueTab.Metrics,{setActiveTab:(_,_ref)=>{let{tabKey}=_ref;return tabKey}}],rowsPerMetric:[{},{addRowsToMetric:(state,_ref2)=>{let{key,rows}=_ref2;return{...state,[key]:[...state[key]||[],...rows]}},loadDeadLetterQueueMetricsSuccess:(_,_ref3)=>{let{deadLetterQueueMetrics}=_ref3,rowsPerMetric={};for(let metric of deadLetterQueueMetrics)metric.subrows&&(rowsPerMetric[metric.key]=metric.subrows.rows);return rowsPerMetric}}],filters:[{before:void 0,after:"-7d",interval:"day"},{setFilters:(state,_ref4)=>{let{filters}=_ref4;return{...state,...filters}}}]}),(0,lib.loaders)(_ref5=>{let{values}=_ref5;return{deadLetterQueueMetrics:[[],{loadDeadLetterQueueMetrics:async()=>{if(!userLogic.userLogic.values.user?.is_staff)return[];let params={};return values.filters.before&&(params.before=values.filters.before),values.filters.after&&(params.after=values.filters.after),(await api.ZP.get(`api/dead_letter_queue?${new URLSearchParams(params).toString()}`)).results}}]}}),(0,index_esm.listeners)(_ref6=>{let{values,actions}=_ref6;return{loadMoreRows:async _ref7=>{let{key}=_ref7,offset=values.rowsPerMetric[key]?.length+1;if(offset||values.filters.before||values.filters.after){let params={};offset&&(params.offset=offset.toString()),values.filters.before&&(params.before=values.filters.before),values.filters.after&&(params.after=values.filters.after);let res=await api.ZP.get(`api/dead_letter_queue/${key}?${new URLSearchParams(params).toString()}`);actions.addRowsToMetric(key,res.subrows.rows)}},setFilters:async(_,breakpoint)=>{await breakpoint(100),actions.loadDeadLetterQueueMetrics()}}}),(0,index_esm.selectors)({singleValueMetrics:[s=>[s.deadLetterQueueMetrics],deadLetterQueueMetrics=>deadLetterQueueMetrics.filter(metric=>!metric.subrows)],tableMetrics:[s=>[s.deadLetterQueueMetrics],deadLetterQueueMetrics=>deadLetterQueueMetrics.filter(metric=>!!metric.subrows)]}),(0,index_esm.afterMount)(_ref8=>{let{actions}=_ref8;actions.loadDeadLetterQueueMetrics()})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function MetricsTab(){let{user}=(0,index_esm.useValues)(userLogic.userLogic),{singleValueMetrics,tableMetrics,deadLetterQueueMetricsLoading,rowsPerMetric,filters}=(0,index_esm.useValues)(deadLetterQueueLogic),{loadDeadLetterQueueMetrics,loadMoreRows,setFilters}=(0,index_esm.useActions)(deadLetterQueueLogic);return user?.is_staff?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)(DateFilter.f,{dateTo:filters.before,dateFrom:filters.after,onChange:(from,to)=>setFilters({after:from||void 0,before:to||void 0}),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalendar,{})," ",key]})}),(0,jsx_runtime.jsx)("div",{className:"mb-4 float-right",children:(0,jsx_runtime.jsx)(LemonButton.J,{icon:deadLetterQueueMetricsLoading?(0,jsx_runtime.jsx)(Spinner.$,{}):(0,jsx_runtime.jsx)(icons.tr,{}),onClick:loadDeadLetterQueueMetrics,type:"secondary",size:"small",children:"Refresh"})}),(0,jsx_runtime.jsx)("div",{className:"flex deprecated-space-x-8 mb-4",children:singleValueMetrics.map(row=>(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-1",children:[(0,jsx_runtime.jsx)("div",{children:row.metric}),(0,jsx_runtime.jsx)("div",{className:"text-2xl",children:(row.value||"0").toLocaleString("en-US")})]},row.key))}),tableMetrics.map(row=>(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h2",{children:row.metric}),(0,jsx_runtime.jsx)(LemonTable.g,{columns:row.subrows?.columns?.map((columnTitle,index)=>({title:columnTitle,dataIndex:`col${index}`,className:"whitespace-nowrap overflow-hidden text-ellipsis max-w-xs cursor-pointer",render:value=>jsx_runtime.jsx("span",{onClick:()=>copyToClipboard.v(String(value),"value"),title:"Click to copy",className:"hover:bg-gray-100 px-1 py-0.5 rounded",children:value})}))||[],dataSource:rowsPerMetric[row.key].map(rowData=>{let rowObject={};return rowData.forEach((value,index)=>{rowObject[`col${index}`]=value}),rowObject})||[],loading:deadLetterQueueMetricsLoading,defaultSorting:{columnKey:"value",order:-1},embedded:!0}),(0,jsx_runtime.jsx)("div",{className:"flex justify-center m-4 text-center",children:(0,jsx_runtime.jsx)(LemonButton.J,{disabledReason:rowsPerMetric[row.key].length%10!=0&&"No more values",onClick:()=>loadMoreRows(row.key),children:"Load more values"})}),(0,jsx_runtime.jsx)(src.p2,{})]},row.key))]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})}let scene={component:DeadLetterQueue,logic:deadLetterQueueLogic};function DeadLetterQueue(){let{user}=(0,index_esm.useValues)(userLogic.userLogic),{activeTab}=(0,index_esm.useValues)(deadLetterQueueLogic),{setActiveTab}=(0,index_esm.useActions)(deadLetterQueueLogic);return user?.is_staff?(0,jsx_runtime.jsxs)(SceneContent._,{children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:"Dead Letter Queue",description:"Manage your instance's dead letter queue.",resourceType:{type:"dead_letter_queue",forceIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconDatabase,{})}}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:activeTab,onChange:key=>setActiveTab(key),tabs:[{label:"Metrics",key:DeadLetterQueueTab.Metrics}],sceneInset:!0}),activeTab===DeadLetterQueueTab.Metrics?(0,jsx_runtime.jsx)(MetricsTab,{}):null]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:"Dead Letter Queue",description:"Manage your instance's dead letter queue.",resourceType:{type:"dead_letter_queue",forceIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconDatabase,{})}}),(0,jsx_runtime.jsx)("p",{children:"Only users with staff access can manage the dead letter queue. Please contact your instance admin."}),(0,jsx_runtime.jsxs)("p",{children:["If you're an admin and don't have access, set ",(0,jsx_runtime.jsx)("code",{children:"is_staff=true"})," for your user on the PostgreSQL ",(0,jsx_runtime.jsx)("code",{children:"posthog_user"})," table."]}),(0,jsx_runtime.jsx)(SceneDivider.V,{})]})}}}]);