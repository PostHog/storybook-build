(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[51570],{"./frontend/src/scenes/max/Max.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Max:()=>Max_Max,scene:()=>scene});var injectStylesIntoStyleTag=__webpack_require__("./node_modules/.pnpm/style-loader@2.0.0_webpack@5.88.2/node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),Max=__webpack_require__("./node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!./node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.4.31_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!./node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!./frontend/src/scenes/max/Max.scss"),Max_default=__webpack_require__.n(Max),options={};options.insert="head",options.singleton=!1,injectStylesIntoStyleTag_default()(Max_default(),options),Max_default().locals;var src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),HedgehogBuddyRender=__webpack_require__("./frontend/src/lib/components/HedgehogBuddy/HedgehogBuddyRender.tsx"),constants=__webpack_require__("./frontend/src/lib/constants.tsx"),featureFlagLogic=__webpack_require__("./frontend/src/lib/logic/featureFlagLogic.ts"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts"),queryNodeToFilter=__webpack_require__("./frontend/src/queries/nodes/InsightQuery/utils/queryNodeToFilter.ts"),Query=__webpack_require__("./frontend/src/queries/Query/Query.tsx"),schema=__webpack_require__("./frontend/src/queries/schema.ts"),api=__webpack_require__("./frontend/src/lib/api.ts");let maxLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","max","maxLogic"]),(0,index_esm.props)({}),(0,index_esm.actions)({askMax:prompt=>({prompt}),setThreadLoaded:!0,addMessage:message=>({message}),replaceMessage:(index,message)=>({index,message}),setMessageStatus:(index,status)=>({index,status})}),(0,index_esm.reducers)({thread:[[],{addMessage:(state,_ref)=>{let{message}=_ref;return[...state,message]},replaceMessage:(state,_ref2)=>{let{message,index}=_ref2;return[...state.slice(0,index),message,...state.slice(index+1)]},setMessageStatus:(state,_ref3)=>{let{index,status}=_ref3;return[...state.slice(0,index),{...state[index],status},...state.slice(index+1)]}}],threadLoading:[!1,{askMax:()=>!0,setThreadLoaded:()=>!1}]}),(0,index_esm.listeners)(_ref4=>{let{actions,values,props}=_ref4;return{askMax:async _ref5=>{let{prompt}=_ref5;actions.addMessage({role:"user",content:prompt});let newIndex=values.thread.length;try{let response=await api.ZP.chat({session_id:props.sessionId,messages:values.thread.map(_ref6=>{let{role,content}=_ref6;return{role,content:"string"==typeof content?content:JSON.stringify(content)}})}),reader=response.body?.getReader(),decoder=new TextDecoder;if(reader){let firstChunk=!0;for(;;){let{done,value}=await reader.read();if(done){actions.setMessageStatus(newIndex,"completed");break}let text=decoder.decode(value),parsedResponse=function parseResponse(response){let recursive=!(arguments.length>1)||void 0===arguments[1]||arguments[1];try{let parsed=JSON.parse(response);return parsed}catch{if(!recursive)return null;let results=[],pair=[0,0],seq=0;for(let i=0;i<response.length;i++){let char=response[i];"{"===char&&(0===seq&&(pair[0]=i),seq+=1),"}"===char&&0==(seq-=1)&&(pair[1]=i),0===seq&&(results.push(pair),pair=[0,0])}let lastPair=results.pop();if(lastPair){let[left,right]=lastPair;return parseResponse(response.slice(left,right+1),!1)}return null}}(text);firstChunk?(firstChunk=!1,parsedResponse&&actions.addMessage({role:"assistant",content:parsedResponse,status:"loading"})):parsedResponse&&actions.replaceMessage(newIndex,{role:"assistant",content:parsedResponse,status:"loading"})}}}catch{actions.setMessageStatus(values.thread.length-1===newIndex?newIndex:newIndex-1,"error")}actions.setThreadLoaded()}}})]);var jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let scene={component:Max_Max,logic:maxLogic};function Message(_ref){let{role,children,className}=_ref;return(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("border p-2 rounded","user"===role?"bg-accent-3000 self-end":"bg-bg-light self-start w-2/3",className),children:children})}function Max_Max(){let{user}=(0,index_esm.useValues)(userLogic.userLogic),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.h),logic=maxLogic({sessionId:(0,utils.Vj)()}),{thread,threadLoading}=(0,index_esm.useValues)(logic),{askMax}=(0,index_esm.useActions)(logic),[question,setQuestion]=(0,react.useState)("");return featureFlags[constants.y8.ARTIFICIAL_HOG]?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-4 grow p-4",children:[thread.map((message,index)=>{if("user"===message.role||"string"==typeof message.content)return(0,jsx_runtime.jsx)(Message,{role:message.role,className:"error"===message.status?"border-danger":void 0,children:message.content||(0,jsx_runtime.jsx)("i",{children:"No text"})},index);let query={kind:schema.OH.InsightVizNode,source:message.content?.answer};return(0,jsx_runtime.jsxs)(react.Fragment,{children:[message.content?.reasoning_steps&&(0,jsx_runtime.jsx)(Message,{role:message.role,children:(0,jsx_runtime.jsx)("ul",{className:"list-disc ml-4",children:message.content.reasoning_steps.map((step,index)=>(0,jsx_runtime.jsx)("li",{children:step},index))})}),"completed"===message.status&&message.content?.answer&&(0,jsx_runtime.jsxs)(Message,{role:message.role,children:[(0,jsx_runtime.jsx)("div",{className:"h-96 flex",children:(0,jsx_runtime.jsx)(Query.A,{query:query,readOnly:!0,embedded:!0})}),(0,jsx_runtime.jsx)(src.Jp,{className:"mt-4 w-fit",type:"primary",to:`/insights/new#filters=${JSON.stringify((0,queryNodeToFilter.ce)(message.content.answer))}`,targetBlank:!0,children:"Edit Query"})]})]},index)}),threadLoading&&(0,jsx_runtime.jsx)(Message,{role:"assistant",className:"w-fit select-none",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:["Let me think…",(0,jsx_runtime.jsx)(src.$j,{className:"text-xl"})]})})]}),(0,jsx_runtime.jsxs)("div",{className:"relative flex items-start px-4",children:[(0,jsx_runtime.jsx)("div",{className:"flex -ml-2.5 -mt-2",children:(0,jsx_runtime.jsx)(HedgehogBuddyRender.Z,{accessories:user?.hedgehog_config?.accessories,color:user?.hedgehog_config?.color,size:80,waveOnAppearance:!0})}),(0,jsx_runtime.jsx)(src.DF,{value:question,onChange:value=>setQuestion(value),placeholder:"Hey, I'm Max! What would you like to know about your product?",fullWidth:!0,size:"large",autoFocus:!0,onPressEnter:()=>{askMax(question),setQuestion("")},disabled:threadLoading,suffix:(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>{askMax(question),setQuestion("")},disabledReason:threadLoading?"Thinking…":void 0,children:"Ask Max"})})]})]}):null}},"./node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!./node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.4.31_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!./node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!./frontend/src/scenes/max/Max.scss":(module,exports,__webpack_require__)=>{(exports=__webpack_require__("./node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/runtime/api.js")(!1)).push([module.id,".InsightVizDisplay{flex:1}",""]),module.exports=exports}}]);