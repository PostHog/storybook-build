"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[44122],{"../../products/messaging/frontend/MessagingScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{MessagingScene:()=>MessagingScene,messagingSceneLogic:()=>messagingSceneLogic,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.30.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),useFeatureFlag=__webpack_require__("../../frontend/src/lib/hooks/useFeatureFlag.ts"),LemonTabs=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTabs/index.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),sceneTypes=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),SceneContent=__webpack_require__("../../frontend/src/layout/scenes/components/SceneContent.tsx"),SceneDivider=__webpack_require__("../../frontend/src/layout/scenes/components/SceneDivider.tsx"),SceneTitleSection=__webpack_require__("../../frontend/src/layout/scenes/components/SceneTitleSection.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),AppMetricsSparkline=__webpack_require__("../../frontend/src/lib/components/AppMetrics/AppMetricsSparkline.tsx"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),More=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/More.tsx"),LemonTable=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/index.ts"),LemonTableLink=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/LemonTableLink.tsx"),columnUtils=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/columnUtils.tsx"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts");let campaignsLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","messaging","frontend","campaignsLogic"]),(0,index_esm.actions)({toggleCampaignStatus:campaign=>({campaign}),duplicateCampaign:campaign=>({campaign}),deleteCampaign:campaign=>({campaign}),loadCampaigns:()=>({})}),(0,kea_loaders_lib.loaders)(_ref=>{let{values}=_ref;return{campaigns:[[],{loadCampaigns:async()=>(await api.ZP.hogFlows.getHogFlows()).results,toggleCampaignStatus:async _ref2=>{let{campaign}=_ref2,updatedCampaign=await api.ZP.hogFlows.updateHogFlow(campaign.id,{status:"active"===campaign.status?"draft":"active"});return values.campaigns.map(c=>c.id===updatedCampaign.id?updatedCampaign:c)},duplicateCampaign:async _ref3=>{let{campaign}=_ref3;return[await api.ZP.hogFlows.createHogFlow({...campaign,status:"draft",name:`${campaign.name} (copy)`}),...values.campaigns]},deleteCampaign:async _ref4=>{let{campaign}=_ref4;return await api.ZP.hogFlows.deleteHogFlow(campaign.id),values.campaigns.filter(c=>c.id!==campaign.id)}}]}}),(0,index_esm.afterMount)(_ref5=>{let{actions}=_ref5;actions.loadCampaigns()})]);var HogFlowSteps=__webpack_require__("../../products/messaging/frontend/Campaigns/hogflows/steps/HogFlowSteps.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function CampaignActionsSummary(_ref){let{campaign}=_ref,actionsByType=(0,react.useMemo)(()=>campaign.actions.reduce((acc,action)=>{let step=(0,HogFlowSteps.d)(action,{});if(!step||!step.type.startsWith("function"))return acc;let key="template_id"in action.config?action.config.template_id:action.type;return acc[key]={count:(acc[key]?.count||0)+1,icon:step.icon,color:step.color},acc},{}),[campaign.actions]);return(0,jsx_runtime.jsx)(src.rU,{to:urls.j.messagingCampaign(campaign.id,"workflow"),children:(0,jsx_runtime.jsx)("div",{className:"flex flex-row gap-2 items-center",children:Object.entries(actionsByType).map(_ref2=>{let[type,{count,icon,color}]=_ref2;return(0,jsx_runtime.jsxs)("div",{className:"rounded px-1 flex items-center justify-center gap-1",style:{backgroundColor:`${color}20`,color},children:[icon," ",count]},type)})})})}function CampaignsTable(){(0,index_esm.useMountedLogic)(campaignsLogic);let{campaigns,campaignsLoading}=(0,index_esm.useValues)(campaignsLogic),{toggleCampaignStatus,duplicateCampaign,deleteCampaign}=(0,index_esm.useActions)(campaignsLogic),columns=[{title:"Name",key:"name",sorter:(a,b)=>(a.name||"").localeCompare(b.name||""),render:(_,item)=>(0,jsx_runtime.jsx)(LemonTableLink.i,{to:urls.j.messagingCampaign(item.id),title:item.name,description:item.description})},{title:"Trigger",width:0,render:(_,item)=>{var _item$trigger$type;return(0,jsx_runtime.jsx)(src.rU,{to:urls.j.messagingCampaign(item.id,"workflow")+"?node=trigger_node",children:(0,jsx_runtime.jsx)(src.oe,{type:"default",children:(0,utils.fm)(null!==(_item$trigger$type=item.trigger?.type)&&void 0!==_item$trigger$type?_item$trigger$type:"unknown")})})}},{title:"Dispatches",width:0,render:(_,item)=>(0,jsx_runtime.jsx)(CampaignActionsSummary,{campaign:item})},{...(0,columnUtils.yI)(),width:0},{title:"Last 7 days",width:0,render:(_,_ref3)=>{let{id}=_ref3;return(0,jsx_runtime.jsx)(src.rU,{to:urls.j.messagingCampaign(id,"metrics"),children:(0,jsx_runtime.jsx)(AppMetricsSparkline.e,{logicKey:id,forceParams:{appSource:"hog_flow",appSourceId:id,metricKind:["success","failure"],breakdownBy:"metric_kind",interval:"day",dateFrom:"-7d"}})})}},{title:"Status",width:0,key:"status",sorter:(a,b)=>a.status.localeCompare(b.status),render:(_,item)=>(0,jsx_runtime.jsx)(src.oe,{type:"active"===item.status?"success":"default",children:(0,utils.fm)(item.status)})},{width:0,render:function Render(_,campaign){return(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"campaign-edit",fullWidth:!0,status:"draft"===campaign.status?"default":"danger",onClick:()=>toggleCampaignStatus(campaign),tooltip:"draft"===campaign.status?"Enables the campaign to start sending messages":"Disables the campaign from sending any new messages. In-progress workflows will end immediately.",children:"draft"===campaign.status?"Enable":"Disable"}),(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"campaign-duplicate",fullWidth:!0,onClick:()=>duplicateCampaign(campaign),children:"Duplicate"}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"campaign-delete",fullWidth:!0,status:"danger",onClick:()=>{src.dn.open({title:"Delete campaign",description:(0,jsx_runtime.jsxs)("p",{children:['Are you sure you want to delete the campaign "',(0,jsx_runtime.jsx)("strong",{children:campaign.name}),'"? This action cannot be undone. In-progress workflows will end immediately.']}),primaryButton:{children:"Delete",status:"danger",onClick:()=>{deleteCampaign(campaign)}},secondaryButton:{children:"Cancel"}})},children:"Delete"})]})})}}];return(0,jsx_runtime.jsx)("div",{className:"campaigns-section",children:(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:campaigns,loading:campaignsLoading,columns:columns,defaultSorting:{columnKey:"status",order:1}})})}var ProductIntroduction=__webpack_require__("../../frontend/src/lib/components/ProductIntroduction/ProductIntroduction.tsx"),integrationsLogic=__webpack_require__("../../frontend/src/lib/integrations/integrationsLogic.ts");let isVerificationRequired=integration=>["email"].includes(integration.kind),isVerified=integration=>"email"!==integration.kind||!0===integration.config.mailjet_verified;function IntegrationEmailDomainView(_ref){let{integration}=_ref,{openSetupModal,deleteIntegration}=(0,index_esm.useActions)(integrationsLogic.a),{domain,integrations}=integration,verified=integrations.every(isVerified),verificationRequired=integrations.some(isVerificationRequired);return(0,jsx_runtime.jsxs)("div",{className:"rounded border bg-surface-primary",children:[(0,jsx_runtime.jsx)("div",{className:"flex flex-1 justify-between items-center p-2",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 gap-4 items-center ml-2",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconLetter,{className:"w-8 h-8"}),(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)("span",{children:(0,jsx_runtime.jsx)("strong",{children:domain})}),verificationRequired&&(0,jsx_runtime.jsx)(src.u,{title:verified?"This channel is ready to use":"You cannot send messages from this channel until it has been verified",children:(0,jsx_runtime.jsx)(src.oe,{type:verified?"success":"warning",children:verified?"Verified":"Unverified"})})]})}),verificationRequired&&!verified&&(0,jsx_runtime.jsx)(src.Jp,{type:"primary",size:"small",onClick:()=>{openSetupModal(integrations[0],integrations[0].kind)},icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconWarning,{}),children:"Verify"})]})}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col",children:integrations.map(integration=>(0,jsx_runtime.jsxs)("div",{className:"flex items-center px-4 py-2 border-t",children:[(0,jsx_runtime.jsxs)("span",{className:"flex-1",children:[integration.config.name," <",integration.config.email,">"]}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",status:"danger",onClick:()=>{deleteIntegration(integration.id)},children:"Remove"})]},integration.id))})]})}function EmailIntegrationsList(){let{integrationsLoading,domainGroupedEmailIntegrations}=(0,index_esm.useValues)(integrationsLogic.a);return(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:integrationsLoading?(0,jsx_runtime.jsx)(src.yW,{className:"h-10"}):domainGroupedEmailIntegrations.map(integration=>(0,jsx_runtime.jsx)(IntegrationEmailDomainView,{integration:integration},integration.domain))})}var IntegrationsList=__webpack_require__("../../frontend/src/lib/integrations/IntegrationsList.tsx"),LemonMenu=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonMenu/index.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/icons.tsx"),ChannelSetupModal=__webpack_require__("../../products/messaging/frontend/Channels/ChannelSetupModal.tsx");let MESSAGING_CHANNEL_TYPES=["email","slack","twilio"];function MessageChannels(){var _integrations$filter;let{setupModalOpen,integrations,integrationsLoading,setupModalType,selectedIntegration}=(0,index_esm.useValues)(integrationsLogic.a),{openSetupModal,closeSetupModal}=(0,index_esm.useActions)(integrationsLogic.a),allMessagingIntegrations=null!==(_integrations$filter=integrations?.filter(integration=>MESSAGING_CHANNEL_TYPES.includes(integration.kind)))&&void 0!==_integrations$filter?_integrations$filter:[],showProductIntroduction=!integrationsLoading&&!allMessagingIntegrations.length,menuItems=[{label:(0,jsx_runtime.jsxs)("div",{className:"flex gap-1 items-center",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconLetter,{})," Email"]}),onClick:()=>openSetupModal(void 0,"email")},{label:(0,jsx_runtime.jsxs)("div",{className:"flex gap-1 items-center",children:[(0,jsx_runtime.jsx)(icons.IconSlack,{})," Slack"]}),disableClientSideRouting:!0,to:api.ZP.integrations.authorizeUrl({kind:"slack",next:urls.j.messaging("channels")})},{label:(0,jsx_runtime.jsxs)("div",{className:"flex gap-1 items-center",children:[(0,jsx_runtime.jsx)(icons.IconTwilio,{})," Twilio"]}),onClick:()=>openSetupModal(void 0,"twilio")}];return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)("div",{className:"flex items-center shrink-0",children:(0,jsx_runtime.jsx)(LemonMenu.d,{items:menuItems,children:(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"new-channel-button",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),size:"small",type:"primary",children:"New channel"})})})}),(0,jsx_runtime.jsx)(ChannelSetupModal.A,{isOpen:setupModalOpen,channelType:setupModalType,integration:selectedIntegration||void 0,onComplete:()=>closeSetupModal()}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-4",children:[integrationsLoading&&!integrations?.length&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.yW,{className:"h-20"}),(0,jsx_runtime.jsx)(src.yW,{className:"h-20"}),(0,jsx_runtime.jsx)(src.yW,{className:"h-20"})]}),showProductIntroduction&&(0,jsx_runtime.jsx)(ProductIntroduction.C,{productName:"Messaging channel",thingName:"channel integration",description:"Configure channels to send messages from.",docsURL:"https://posthog.com/docs/messaging",action:()=>openSetupModal(void 0,"email"),isEmpty:!0}),(0,jsx_runtime.jsx)(EmailIntegrationsList,{}),(0,jsx_runtime.jsx)(IntegrationsList.B,{titleText:"",onlyKinds:MESSAGING_CHANNEL_TYPES.filter(type=>"email"!==type)})]})]})}var userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),LemonDivider=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonDivider/index.ts"),kea_forms_lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/LemonToast.tsx"),optOutCategoriesLogic=__webpack_require__("../../products/messaging/frontend/OptOuts/optOutCategoriesLogic.ts");let NEW_CATEGORY={name:"",key:"",description:"",public_description:"",category_type:"marketing"},newCategoryLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","messaging","frontend","OptOuts","newCategoryLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(props=>props.category?.id||"new"),(0,index_esm.actions)({submitForm:!0,resetForm:!0}),(0,kea_forms_lib.forms)(_ref=>{let{actions,props}=_ref;return{categoryForm:{defaults:props.category?{name:props.category.name,key:props.category.key,description:props.category.description,public_description:props.category.public_description,category_type:props.category.category_type}:NEW_CATEGORY,errors:_ref2=>{let{name,key}=_ref2;return{name:name.trim()?void 0:"Name is required",key:key.trim()?/^[a-zA-Z0-9_-]+$/.test(key)?void 0:"Only letters, numbers, hyphens (-) & underscores (_) are allowed":"Key is required"}},submit:async formValues=>{props.category?(await api.ZP.messaging.updateCategory(props.category.id,formValues),LemonToast.UJ.success("Category updated successfully")):(await api.ZP.messaging.createCategory(formValues),LemonToast.UJ.success("Category created successfully")),optOutCategoriesLogic.O.actions.loadCategories(),actions.resetForm(),props.onSuccess&&props.onSuccess()}}}}),(0,index_esm.listeners)(_ref3=>{let{actions}=_ref3;return{resetForm:()=>{actions.resetCategoryForm()}}})]);function NewCategoryModal(_ref){let{isOpen,onClose,category}=_ref,logic=newCategoryLogic({category,onSuccess:onClose}),{isCategoryFormSubmitting}=(0,index_esm.useValues)(logic),{submitCategoryForm,resetCategoryForm}=(0,index_esm.useActions)(logic),handleClose=()=>{resetCategoryForm(),onClose()};return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:handleClose,title:category?"Edit message category":"New message category",footer:(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:handleClose,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",loading:isCategoryFormSubmitting,onClick:submitCategoryForm,children:category?"Update":"Create"})]}),children:(0,jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:newCategoryLogic,formKey:"categoryForm",props:{category,onSuccess:onClose},className:"space-y-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g., Product updates"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"key",label:"Key",info:"This is the unique identifier for the category",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g., product_updates",disabledReason:category?"Key cannot be changed after creation":void 0})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"category_type",label:"Message type",info:"Marketing messages can be opted out of by users. Transactional messages are not affected by recipient preferences",help:(0,jsx_runtime.jsxs)("p",{children:["Be sure to comply with local regulations regarding marketing communications (",(0,jsx_runtime.jsx)(src.rU,{to:"https://www.ftc.gov/business-guidance/resources/can-spam-act-compliance-guide-business",target:"_blank",children:"CAN-SPAM"}),","," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://gdpr.eu/email-encryption/",target:"_blank",children:"GDPR"}),")"]}),children:(0,jsx_runtime.jsx)(src.Yv,{options:[{label:"Marketing",value:"marketing"},{label:"Transactional",value:"transactional"}],placeholder:"Select message type"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"description",label:"Description",children:(0,jsx_runtime.jsx)(src._V,{placeholder:"Internal description for your team",rows:3})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"public_description",label:"Public description",help:"This description will be shown to users in the email preferences page.",children:(0,jsx_runtime.jsx)(src._V,{placeholder:"e.g., Latest updates on feature launches, product improvements, and more.",rows:3})})]})})}var TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),DataTable=__webpack_require__("../../frontend/src/queries/nodes/DataTable/DataTable.tsx"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts");let optOutSceneLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","messaging","frontend","OptOuts","optOutSceneLogic"]),(0,index_esm.connect)({values:[userLogic.userLogic,["user"]]}),(0,index_esm.actions)({loadUnsubscribeLink:!0}),(0,kea_loaders_lib.loaders)(_ref=>{let{values}=_ref;return{preferencesUrl:{__default:null,openPreferencesPage:async recipient=>{if(!values.user?.email)return src.UJ.error("User email not found"),null;try{let newPreferencesUrl=await api.ZP.messaging.generateMessagingPreferencesLink(recipient);if(!newPreferencesUrl)return src.UJ.error("Failed to generate messaging preferences link"),null;return window.open(newPreferencesUrl,"_blank"),newPreferencesUrl}catch{return src.UJ.error("Failed to generate messaging preferences link"),null}}}}})]),optOutListLogic=(0,index_esm.kea)([(0,index_esm.key)(props=>props.category?.id||"$all"),(0,index_esm.path)(["products","messaging","frontend","OptOuts","optOutListLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)({values:[optOutSceneLogic,["preferencesUrlLoading"]],actions:[optOutSceneLogic,["openPreferencesPage"]]}),(0,index_esm.actions)({loadUnsubscribeLink:!0,setPersonsModalOpen:open=>({open}),setManagePreferencesModalOpen:open=>({open}),setSelectedIdentifier:identifier=>({identifier})}),(0,index_esm.reducers)({personsModalOpen:[!1,{setPersonsModalOpen:(_,_ref)=>{let{open}=_ref;return open},setSelectedIdentifier:(open,_ref2)=>{let{identifier}=_ref2;return!!identifier&&open}}],managePreferencesModalOpen:[!1,{setManagePreferencesModalOpen:(_,_ref3)=>{let{open}=_ref3;return open},setSelectedIdentifier:(open,_ref4)=>{let{identifier}=_ref4;return!!identifier&&open}}],selectedIdentifier:[null,{setSelectedIdentifier:(_,_ref5)=>{let{identifier}=_ref5;return identifier}}]}),(0,kea_loaders_lib.loaders)(_ref6=>{let{props}=_ref6;return{optOutPersons:{__default:[],loadOptOutPersons:async()=>{try{return await api.ZP.messaging.getMessageOptOuts(props.category?.key)}catch{return src.UJ.error("Failed to load opt-out persons"),[]}}}}}),(0,index_esm.afterMount)(_ref7=>{let{props,actions}=_ref7;props.category?.id&&props.category?.category_type!=="marketing"||actions.loadOptOutPersons()})]);function OptOutList(_ref){let{category}=_ref,logic=optOutListLogic({category}),{setSelectedIdentifier,openPreferencesPage}=(0,index_esm.useActions)(logic),{selectedIdentifier,optOutPersons,optOutPersonsLoading,preferencesUrlLoading}=(0,index_esm.useValues)(logic),handleShowPersons=identifier=>{setSelectedIdentifier(identifier)},actorsQuery=selectedIdentifier?{kind:schema_general.OH.DataTableNode,source:{kind:schema_general.OH.ActorsQuery,select:["person_display_name -- Person","id","created_at"],search:selectedIdentifier,orderBy:["created_at"]}}:null,columns=[{title:"Recipient",dataIndex:"identifier",key:"recipient"},{title:"Opt-out date",dataIndex:"updated_at",key:"updated_at",render:updated_at=>(0,jsx_runtime.jsx)(TZLabel.w,{time:updated_at})},{width:0,render:function Render(_,optOutEntry){return(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>handleShowPersons(optOutEntry.identifier),fullWidth:!0,children:"Show person(s)"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>openPreferencesPage(optOutEntry.identifier),loading:preferencesUrlLoading,fullWidth:!0,icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconExternal,{}),children:"Manage"})]})})}}];return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"max-h-64 overflow-y-auto",children:(0,jsx_runtime.jsx)(src.g3,{columns:columns,dataSource:optOutPersons,loading:optOutPersonsLoading,loadingSkeletonRows:3,rowKey:"identifier",emptyState:`No opt-outs found${category?.name?` for ${category.name}`:""}`,size:"small"})}),(0,jsx_runtime.jsx)(src.fQ,{isOpen:!!selectedIdentifier,onClose:()=>{setSelectedIdentifier(null)},title:`Persons for ${selectedIdentifier}`,width:"50rem",footer:null,children:actorsQuery&&(0,jsx_runtime.jsx)("div",{className:"h-96",children:(0,jsx_runtime.jsx)(DataTable.w,{query:actorsQuery,setQuery:()=>{},uniqueKey:`opt-out-persons-${selectedIdentifier}`,readOnly:!0})})})]})}function OptOutCategories(){let{categories,categoriesLoading}=(0,index_esm.useValues)(optOutCategoriesLogic.O),{loadCategories,deleteCategory}=(0,index_esm.useActions)(optOutCategoriesLogic.O),[isNewCategoryModalOpen,setIsNewCategoryModalOpen]=(0,react.useState)(!1),[editingCategory,setEditingCategory]=(0,react.useState)(null);(0,react.useEffect)(()=>{loadCategories()},[loadCategories]);let handleEditCategory=category=>{setEditingCategory(category)},collapseItems=(0,react.useMemo)(()=>(categories||[]).map(category=>({key:category.id,header:(0,jsx_runtime.jsxs)("div",{className:"flex justify-between w-full gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"font-medium",children:category.name}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted",children:category.description})]}),(0,jsx_runtime.jsx)(src.oe,{type:"marketing"===category.category_type?"success":"completion",children:category.category_type.toUpperCase()})]}),(0,jsx_runtime.jsx)(More.T,{onClick:e=>e.stopPropagation(),overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>handleEditCategory(category),fullWidth:!0,children:"Edit"}),(0,jsx_runtime.jsx)(LemonDivider.p,{}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",onClick:()=>src.dn.open({title:"Delete category",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("p",{children:["Are you sure you want to delete the message category"," ",(0,jsx_runtime.jsx)("b",{children:category.name}),"?"]}),(0,jsx_runtime.jsx)("p",{children:"All messages associated with this category must be updated manually."})]}),primaryButton:{children:"Delete",status:"danger",onClick:()=>deleteCategory(category.id)},secondaryButton:{children:"Cancel"}}),fullWidth:!0,children:"Delete"})]})})]}),content:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-3",children:[(0,jsx_runtime.jsxs)("div",{className:"text-sm text-muted mb-1",children:["Key: ",category.key]}),category.public_description&&(0,jsx_runtime.jsxs)("div",{className:"text-sm text-muted",children:["Public description: ",category.public_description]})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{className:"font-medium mb-2",children:"Opt-out list"}),"marketing"===category.category_type?(0,jsx_runtime.jsx)(OptOutList,{category:category}):(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted mb-1",children:"Transactional messages are not eligible for opt-outs"})]})]})})),[categories,deleteCategory]);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{caption:"Configure message categories and view opt-outs",buttons:(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"new-optout-category",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),size:"small",type:"primary",onClick:()=>setIsNewCategoryModalOpen(!0),children:"New category"})}),categoriesLoading?(0,jsx_runtime.jsx)(src.yW,{className:"h-10"}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:collapseItems.length>0?(0,jsx_runtime.jsx)(src.JL,{panels:collapseItems}):(0,jsx_runtime.jsx)("div",{className:"text-center py-8 text-muted",children:"No message categories configured yet"})}),(0,jsx_runtime.jsx)(NewCategoryModal,{isOpen:isNewCategoryModalOpen||null!==editingCategory,onClose:()=>{setIsNewCategoryModalOpen(!1),setEditingCategory(null)},category:editingCategory})]})}function OptOutScene(){let{user}=(0,index_esm.useValues)(userLogic.userLogic),{preferencesUrlLoading}=(0,index_esm.useValues)(optOutSceneLogic),{openPreferencesPage}=(0,index_esm.useActions)(optOutSceneLogic);return(0,jsx_runtime.jsxs)("div",{className:"space-y-8",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,jsx_runtime.jsx)("h2",{className:"text-xl font-semibold",children:"Message categories"}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>openPreferencesPage(),loading:preferencesUrlLoading,disabled:!user?.email,tooltip:user?.email?"Generate an unsubscribe link for your email and open it in a new tab":"User email not available",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconExternal,{}),children:"Preview opt-out page"})]}),(0,jsx_runtime.jsx)(OptOutCategories,{})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h2",{className:"text-xl font-semibold",children:"Marketing opt-out list"}),(0,jsx_runtime.jsx)("p",{className:"mt-6",children:"Message recipients who have opted out of all marketing messages"}),(0,jsx_runtime.jsx)(OptOutList,{})]})]})}var MaxTool=__webpack_require__("../../frontend/src/scenes/max/MaxTool.tsx"),lemon_ui_LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/index.ts"),deleteWithUndo=__webpack_require__("../../frontend/src/lib/utils/deleteWithUndo.tsx");let messageTemplatesLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","messaging","frontend","library","messageTemplatesLogic"]),(0,kea_loaders_lib.loaders)(_ref=>{let{values,actions}=_ref;return{templates:[[],{loadTemplates:async()=>(await api.ZP.messaging.getTemplates()).results,deleteTemplate:async template=>(await (0,deleteWithUndo.S)({endpoint:"environments/@current/messaging_templates",object:{id:template.id,name:template.name},callback:undo=>{undo&&actions.loadTemplates()}}),values.templates.filter(t=>t.id!==template.id)),createTemplate:async _ref2=>{let{template}=_ref2;try{let newTemplate=await api.ZP.messaging.createTemplate(template);return lemon_ui_LemonToast.U.success("Template created successfully"),[...values.templates,newTemplate]}catch{return lemon_ui_LemonToast.U.error("Failed to create template"),values.templates}},updateTemplate:async _ref3=>{let{templateId,template}=_ref3;try{let updatedTemplate=await api.ZP.messaging.updateTemplate(templateId,template);return lemon_ui_LemonToast.U.success("Template updated successfully"),values.templates.map(t=>t.id===templateId?updatedTemplate:t)}catch{return lemon_ui_LemonToast.U.error("Failed to update template"),values.templates}}}]}}),(0,index_esm.afterMount)(_ref4=>{let{actions}=_ref4;actions.loadTemplates()})]);function MessageTemplatesTable(){(0,index_esm.useMountedLogic)(messageTemplatesLogic);let{templates,templatesLoading}=(0,index_esm.useValues)(messageTemplatesLogic),{deleteTemplate,createTemplate}=(0,index_esm.useActions)(messageTemplatesLogic),columns=[{title:"Name",render:(_,item)=>(0,jsx_runtime.jsx)(LemonTableLink.i,{to:urls.j.messagingLibraryTemplate(item.id),title:item.name,description:item.description})},(0,columnUtils.JB)(),(0,columnUtils.rw)(),{width:0,render:function Render(_,message){return(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"message-template-delete",fullWidth:!0,status:"danger",onClick:()=>deleteTemplate(message),children:"Delete"})})})}}];return(0,jsx_runtime.jsxs)("div",{className:"templates-section",children:[(0,jsx_runtime.jsx)(MaxTool.Z,{identifier:"create_message_template",context:{},callback:toolOutput=>{createTemplate({template:JSON.parse(toolOutput)})},children:(0,jsx_runtime.jsx)("div",{className:"relative"})}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:templates,loading:templatesLoading,columns:columns})]})}let MESSAGING_SCENE_TABS=["campaigns","library","channels","opt-outs"],messagingSceneLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.path)(()=>["scenes","messaging","messagingSceneLogic"]),(0,index_esm.actions)({setCurrentTab:tab=>({tab})}),(0,index_esm.reducers)(()=>({currentTab:["campaigns",{setCurrentTab:(_,_ref)=>{let{tab}=_ref;return tab}}]})),(0,index_esm.selectors)({logicProps:[()=>[(_,props)=>props],props=>props],breadcrumbs:[(_,p)=>[p.tab],tab=>[{key:[sceneTypes.x.Messaging,tab],name:(0,utils.fm)(tab.replaceAll("_"," ")),iconType:"messaging"}]]}),(0,index_esm.listeners)({setCurrentTab:_ref2=>{let{tab}=_ref2;lib.router.actions.push(urls.j.messaging(tab))}}),(0,lib.urlToAction)(_ref3=>{let{actions,values}=_ref3;return{[urls.j.messaging(":tab")]:_ref4=>{let{tab}=_ref4,possibleTab=null!=tab?tab:"campaigns";(possibleTab=MESSAGING_SCENE_TABS.includes(possibleTab)?possibleTab:"campaigns")!==values.currentTab&&actions.setCurrentTab(possibleTab)}}})]),scene={component:MessagingScene,logic:messagingSceneLogic,paramsToProps:_ref6=>{let{params:{tab}}=_ref6;return{tab}}};function MessagingScene(){let{currentTab}=(0,index_esm.useValues)(messagingSceneLogic),{setCurrentTab}=(0,index_esm.useActions)(messagingSceneLogic);if(!(0,useFeatureFlag.y)("MESSAGING"))return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col justify-center items-center h-full",children:[(0,jsx_runtime.jsx)("h1",{className:"text-2xl font-bold",children:"Coming soon!"}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-muted-foreground",children:"We're working on bringing messaging to PostHog. Stay tuned for updates!"})]});let tabs=[{label:"Campaigns",key:"campaigns",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{caption:"Create automated messaging campaigns triggered by events",buttons:(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"new-campaign",to:urls.j.messagingCampaignNew(),type:"primary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),children:"New campaign"})}),(0,jsx_runtime.jsx)(CampaignsTable,{})]})},{label:"Library",key:"library",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{caption:"Create and manage messages",buttons:(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"new-message-button",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),size:"small",type:"primary",to:urls.j.messagingLibraryTemplateNew(),children:"New template"})}),(0,jsx_runtime.jsx)(MessageTemplatesTable,{})]})},{label:"Channels",key:"channels",content:(0,jsx_runtime.jsx)(MessageChannels,{})},{label:"Opt-outs",key:"opt-outs",content:(0,jsx_runtime.jsx)(OptOutScene,{})}];return(0,jsx_runtime.jsxs)(SceneContent._,{className:"messaging",children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:"Messaging",resourceType:{type:"messaging"},description:"Create automated workflows triggered by PostHog events to onboard, retain, and re-engage your users."}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:currentTab,tabs:tabs,onChange:setCurrentTab,sceneInset:!0})]})}}}]);