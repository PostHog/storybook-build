{"version":3,"file":"38178.89350549.iframe.bundle.js","mappings":";AAiRA;AACA;AACA","sources":["webpack://@posthog/storybook/../../frontend/src/scenes/cohorts/CohortEdit.tsx"],"sourcesContent":["import { useActions, useValues } from 'kea'\nimport { Form } from 'kea-forms'\nimport { router } from 'kea-router'\n\nimport { IconCopy, IconMinusSmall, IconPlusSmall, IconTrash, IconWarning } from '@posthog/icons'\nimport { LemonBanner, LemonDivider, LemonFileInput, Link, Tooltip } from '@posthog/lemon-ui'\n\nimport { NotFound } from 'lib/components/NotFound'\nimport { PageHeader } from 'lib/components/PageHeader'\nimport { SceneAddToNotebookDropdownMenu } from 'lib/components/Scenes/InsightOrDashboard/SceneAddToNotebookDropdownMenu'\nimport { SceneFile } from 'lib/components/Scenes/SceneFile'\nimport { TZLabel } from 'lib/components/TZLabel'\nimport { CohortTypeEnum } from 'lib/constants'\nimport { LemonButton } from 'lib/lemon-ui/LemonButton'\nimport { LemonField } from 'lib/lemon-ui/LemonField'\nimport { LemonSelect } from 'lib/lemon-ui/LemonSelect'\nimport { Spinner } from 'lib/lemon-ui/Spinner/Spinner'\nimport { IconErrorOutline, IconUploadFile } from 'lib/lemon-ui/icons'\nimport { ButtonPrimitive } from 'lib/ui/Button/ButtonPrimitives'\nimport { WrappingLoadingSkeleton } from 'lib/ui/WrappingLoadingSkeleton/WrappingLoadingSkeleton'\nimport { cn } from 'lib/utils/css-classes'\nimport { CohortCriteriaGroups } from 'scenes/cohorts/CohortFilters/CohortCriteriaGroups'\nimport { COHORT_TYPE_OPTIONS } from 'scenes/cohorts/CohortFilters/constants'\nimport { CohortLogicProps, cohortEditLogic } from 'scenes/cohorts/cohortEditLogic'\nimport { urls } from 'scenes/urls'\n\nimport { ScenePanel, ScenePanelActions, ScenePanelDivider, ScenePanelMetaInfo } from '~/layout/scenes/SceneLayout'\nimport { SceneContent } from '~/layout/scenes/components/SceneContent'\nimport { SceneDivider } from '~/layout/scenes/components/SceneDivider'\nimport { SceneSection } from '~/layout/scenes/components/SceneSection'\nimport { SceneTitleSection } from '~/layout/scenes/components/SceneTitleSection'\nimport { Query } from '~/queries/Query/Query'\nimport { AndOrFilterSelect } from '~/queries/nodes/InsightViz/PropertyGroupFilters/AndOrFilterSelect'\nimport { QueryContext } from '~/queries/types'\n\nimport { AddPersonToCohortModal } from './AddPersonToCohortModal'\nimport { addPersonToCohortModalLogic } from './addPersonToCohortModalLogic'\nimport { cohortCountWarningLogic } from './cohortCountWarningLogic'\nimport { createCohortDataNodeLogicKey } from './cohortUtils'\n\nconst RESOURCE_TYPE = 'cohort'\n\nexport function CohortEdit({ id }: CohortLogicProps): JSX.Element {\n    const logicProps = { id }\n\n    const logic = cohortEditLogic(logicProps)\n    const {\n        deleteCohort,\n        setOuterGroupsType,\n        setQuery,\n        duplicateCohort,\n        setCohortValue,\n        addPersonToCreateStaticCohort,\n        removePersonFromCreateStaticCohort,\n        setCreationPersonQuery,\n    } = useActions(logic)\n    const modalLogic = addPersonToCohortModalLogic(logicProps)\n    const { showAddPersonToCohortModal } = useActions(modalLogic)\n    const { cohort, cohortLoading, cohortMissing, query, creationPersonQuery, personsToCreateStaticCohort } =\n        useValues(logic)\n    const isNewCohort = cohort.id === 'new' || cohort.id === undefined\n    const dataNodeLogicKey = createCohortDataNodeLogicKey(cohort.id)\n    const warningLogic = cohortCountWarningLogic({ cohort, query, dataNodeLogicKey })\n    const { shouldShowCountWarning } = useValues(warningLogic)\n\n    const createStaticCohortContext: QueryContext = {\n        columns: {\n            id: {\n                renderTitle: () => null,\n                render: (props) => {\n                    const id = props.value as string\n                    const isAdded = personsToCreateStaticCohort[id] != null\n                    return (\n                        <LemonButton\n                            type=\"secondary\"\n                            status={isAdded ? 'danger' : 'default'}\n                            size=\"small\"\n                            onClick={(e) => {\n                                e.preventDefault()\n                                if (isAdded) {\n                                    removePersonFromCreateStaticCohort(id)\n                                } else {\n                                    addPersonToCreateStaticCohort(id)\n                                }\n                            }}\n                        >\n                            {isAdded ? <IconMinusSmall /> : <IconPlusSmall />}\n                        </LemonButton>\n                    )\n                },\n            },\n        },\n        showOpenEditorButton: false,\n    }\n\n    if (cohortMissing) {\n        return <NotFound object=\"cohort\" />\n    }\n\n    return (\n        <div className=\"cohort\">\n            <AddPersonToCohortModal id={id} />\n            <PageHeader\n                buttons={\n                    <div className=\"flex items-center gap-2\">\n                        {isNewCohort ? (\n                            <LemonButton\n                                data-attr=\"cancel-cohort\"\n                                type=\"secondary\"\n                                onClick={() => {\n                                    router.actions.push(urls.cohorts())\n                                }}\n                                disabled={cohortLoading}\n                            >\n                                Cancel\n                            </LemonButton>\n                        ) : null}\n                        <LemonButton\n                            type=\"primary\"\n                            data-attr=\"save-cohort\"\n                            htmlType=\"submit\"\n                            loading={cohortLoading || cohort.is_calculating}\n                            form=\"cohort\"\n                        >\n                            Save\n                        </LemonButton>\n                    </div>\n                }\n            />\n\n            <ScenePanel>\n                <ScenePanelMetaInfo>\n                    <SceneFile dataAttrKey={RESOURCE_TYPE} />\n                </ScenePanelMetaInfo>\n\n                <ScenePanelDivider />\n\n                <ScenePanelActions>\n                    <SceneAddToNotebookDropdownMenu\n                        dataAttrKey={RESOURCE_TYPE}\n                        disabledReasons={{\n                            'Save the cohort first': isNewCohort,\n                        }}\n                    />\n\n                    <ButtonPrimitive\n                        onClick={() => duplicateCohort(false)}\n                        disabledReasons={{\n                            'Save the cohort first': isNewCohort,\n                            'Cohort must be dynamic to duplicate': cohort.is_static === true,\n                            'Cohort is still calculating': cohort.is_calculating ?? false,\n                        }}\n                        menuItem\n                    >\n                        <IconCopy /> Duplicate as dynamic cohort\n                    </ButtonPrimitive>\n\n                    <ButtonPrimitive\n                        onClick={() => duplicateCohort(true)}\n                        disabledReasons={{\n                            'Save the cohort first': isNewCohort,\n                            'Cohort must be dynamic to duplicate': cohort.is_static === true,\n                            'Cohort is still calculating': cohort.is_calculating ?? false,\n                        }}\n                        menuItem\n                    >\n                        <IconCopy /> Duplicate as static cohort\n                    </ButtonPrimitive>\n\n                    <ScenePanelDivider />\n\n                    <ButtonPrimitive\n                        onClick={() => {\n                            deleteCohort()\n                        }}\n                        variant=\"danger\"\n                        menuItem\n                        data-attr={`${RESOURCE_TYPE}-delete`}\n                    >\n                        <IconTrash />\n                        Delete\n                    </ButtonPrimitive>\n                </ScenePanelActions>\n            </ScenePanel>\n\n            <Form id=\"cohort\" logic={cohortEditLogic} props={logicProps} formKey=\"cohort\" enableFormOnSubmit>\n                <SceneContent>\n                    <LemonField name=\"name\">\n                        <SceneTitleSection\n                            name={cohort.name}\n                            description={cohort.description || ''}\n                            resourceType={{\n                                to: urls.cohorts(),\n                                type: RESOURCE_TYPE,\n                            }}\n                            isLoading={cohortLoading}\n                            onNameChange={(value) => {\n                                setCohortValue('name', value)\n                            }}\n                            onDescriptionChange={(value) => {\n                                setCohortValue('description', value)\n                            }}\n                            canEdit\n                            forceEdit={isNewCohort}\n                        />\n                    </LemonField>\n\n                    <SceneDivider />\n\n                    <SceneSection\n                        title=\"Type\"\n                        description=\"Static cohorts are created once and never updated, while dynamic cohorts are recalculated based on the latest data.\"\n                        className=\"max-w-200 flex flex-col gap-y-2\"\n                        hideTitleAndDescription\n                    >\n                        <div className=\"flex gap-4 flex-wrap\">\n                            <div className={cn('flex-1 flex flex-col gap-y-4')}>\n                                <LemonField name=\"is_static\" label={null}>\n                                    {({ value, onChange }) => (\n                                        <LemonSelect\n                                            disabledReason={\n                                                isNewCohort\n                                                    ? null\n                                                    : 'Create a new cohort to use a different type of cohort.'\n                                            }\n                                            options={COHORT_TYPE_OPTIONS}\n                                            value={value ? CohortTypeEnum.Static : CohortTypeEnum.Dynamic}\n                                            onChange={(cohortType) => {\n                                                onChange(cohortType === CohortTypeEnum.Static)\n                                            }}\n                                            fullWidth\n                                            data-attr=\"cohort-type\"\n                                        />\n                                    )}\n                                </LemonField>\n\n                                {!isNewCohort && !cohort?.is_static && (\n                                    <div className=\"max-w-70 w-fit\">\n                                        <p className=\"flex items-center gap-x-1 my-0\">\n                                            <strong>Last calculated:</strong>\n                                            {cohort.is_calculating ? (\n                                                <WrappingLoadingSkeleton>In progress...</WrappingLoadingSkeleton>\n                                            ) : cohort.last_calculation ? (\n                                                <TZLabel time={cohort.last_calculation} />\n                                            ) : (\n                                                <>Not yet calculated</>\n                                            )}\n                                        </p>\n\n                                        {cohort.errors_calculating ? (\n                                            <Tooltip\n                                                title={\n                                                    \"The last attempted calculation failed. This means your current cohort data can be stale. This doesn't affect feature flag evaluation.\"\n                                                }\n                                            >\n                                                <div className=\"text-danger\">\n                                                    <IconErrorOutline className=\"text-danger text-xl shrink-0\" />\n                                                </div>\n                                            </Tooltip>\n                                        ) : null}\n                                    </div>\n                                )}\n                            </div>\n                        </div>\n                    </SceneSection>\n                    {cohort.is_static ? (\n                        <>\n                            <SceneDivider />\n                            <SceneSection\n                                title={isNewCohort ? 'Upload users' : 'Add users'}\n                                description={\n                                    isNewCohort\n                                        ? `Upload a CSV file to add users to your cohort. For single-column files, include\n                                        one distinct ID per row (all rows will be processed as data). For multi-column\n                                        files, include a header row with a 'distinct_id' column containing the user\n                                        identifiers.`\n                                        : undefined\n                                }\n                                className={cn('ph-ignore-input')}\n                            >\n                                {!isNewCohort && (\n                                    <div className=\"flex flex-col gap-y-0 flex-1 justify-center\">\n                                        <h3 className=\"text-sm\">Upload a CSV</h3>\n                                        <span className=\"max-w-prose\">\n                                            Upload a CSV file to add users to your cohort. For single-column files,\n                                            include one distinct ID per row (all rows will be processed as data). For\n                                            multi-column files, include a header row with a 'distinct_id' column\n                                            containing the user identifiers.\n                                        </span>\n                                    </div>\n                                )}\n                                {/* TODO: @adamleithp Allow users to download a template CSV file */}\n                                {/* TODO: @adamleithp Tell users that adding ANOTHER file will NOT(?) replace the current one */}\n                                {/* TODO: @adamleithp Render the csv file and validate it */}\n                                {/* TODO: @adamleithp Adding a csv file doesn't show up with cohort.csv... */}\n                                <LemonField name=\"csv\" data-attr=\"cohort-csv\">\n                                    {({ onChange }) => (\n                                        <LemonFileInput\n                                            accept=\".csv\"\n                                            multiple={false}\n                                            value={cohort.csv ? [cohort.csv] : []}\n                                            onChange={(files) => onChange(files[0])}\n                                            showUploadedFiles={false}\n                                            callToAction={\n                                                <div\n                                                    className={cn(\n                                                        'flex flex-col items-center justify-center flex-1 cohort-csv-dragger text-text-3000 deprecated-space-y-1',\n                                                        'text-primary mt-0 bg-transparent border border-dashed border-primary hover:border-secondary p-8',\n                                                        cohort.csv?.name && 'border-success'\n                                                    )}\n                                                >\n                                                    {cohort.csv ? (\n                                                        <>\n                                                            <IconUploadFile\n                                                                style={{\n                                                                    fontSize: '3rem',\n                                                                    color: 'var(--color-text-primary)',\n                                                                }}\n                                                            />\n                                                            <div>{cohort.csv?.name ?? 'File chosen'}</div>\n                                                        </>\n                                                    ) : (\n                                                        <>\n                                                            <IconUploadFile\n                                                                style={{\n                                                                    fontSize: '3rem',\n                                                                    color: 'var(--color-text-primary)',\n                                                                }}\n                                                            />\n                                                            <div>Drag a file here or click to browse for a file</div>\n                                                            <div className=\"text-secondary text-xs\">\n                                                                Accepts .csv files only\n                                                            </div>\n                                                        </>\n                                                    )}\n                                                </div>\n                                            }\n                                        />\n                                    )}\n                                </LemonField>\n                            </SceneSection>\n                            {isNewCohort && (\n                                <>\n                                    <LemonDivider label=\"OR\" />\n                                    <div>\n                                        <h3 className=\"font-semibold my-0 mb-1 max-w-prose\">Add users manually</h3>\n                                        <span className=\"max-w-prose\">\n                                            Select the users that you would like to add to the new cohort.\n                                        </span>\n                                    </div>\n                                    <Query\n                                        query={creationPersonQuery}\n                                        setQuery={setCreationPersonQuery}\n                                        context={createStaticCohortContext}\n                                    />\n                                </>\n                            )}\n                            {!isNewCohort && (\n                                <>\n                                    <LemonDivider label=\"OR\" />\n                                    <div>\n                                        <h3 className=\"text-sm\">Add users manually</h3>\n                                        <span className=\"max-w-prose\">\n                                            Select the users that you would like to add to the cohort.\n                                        </span>\n                                        <LemonButton\n                                            className=\"w-fit mt-4\"\n                                            type=\"primary\"\n                                            onClick={showAddPersonToCohortModal}\n                                        >\n                                            Add Users\n                                        </LemonButton>\n                                    </div>\n                                </>\n                            )}\n                        </>\n                    ) : (\n                        <>\n                            <SceneDivider />\n                            {!isNewCohort && cohort.experiment_set && cohort.experiment_set.length > 0 && (\n                                <LemonBanner type=\"info\">\n                                    This cohort manages exposure for an experiment. Editing this cohort may change\n                                    experiment metrics. If unsure,{' '}\n                                    <Link to={urls.experiment(cohort.experiment_set[0])}>\n                                        check the experiment details.\n                                    </Link>\n                                </LemonBanner>\n                            )}\n                            <SceneSection\n                                // TODO: @adamleithp Add a number of matching persons to the title \"Matching criteria (100)\"\n                                title=\"Matching criteria\"\n                                description=\"Actors who match the following criteria will be part of the cohort. Continuously updated automatically.\"\n                                className={cn('flex items-start justify-between')}\n                                hideTitleAndDescription\n                            >\n                                <AndOrFilterSelect\n                                    value={cohort.filters.properties.type}\n                                    onChange={(value) => {\n                                        setOuterGroupsType(value)\n                                    }}\n                                    topLevelFilter={true}\n                                    suffix={['criterion', 'criteria']}\n                                />\n                                <div className={cn('w-full [&>div]:my-0 [&>div]:w-full')}>\n                                    <CohortCriteriaGroups id={logicProps.id} />\n                                </div>\n                            </SceneSection>\n                        </>\n                    )}\n\n                    {/* The typeof here is needed to pass the cohort id to the query below. Using `isNewCohort` won't work */}\n                    {typeof cohort.id === 'number' && (\n                        <>\n                            <SceneDivider />\n                            <SceneSection\n                                title={\n                                    <>\n                                        Persons in this cohort\n                                        <span className=\"text-secondary ml-2\">\n                                            {!cohort.is_calculating && cohort.count != undefined && `(${cohort.count})`}\n                                        </span>\n                                        {shouldShowCountWarning && (\n                                            <Tooltip title=\"The displayed number of persons is less than the cohort count due to deleted persons. This is expected behavior for dynamic cohorts where persons may be deleted after being counted.\">\n                                                <IconWarning className=\"text-warning ml-2\" />\n                                            </Tooltip>\n                                        )}\n                                    </>\n                                }\n                                description=\"Persons who match the following criteria will be part of the cohort.\"\n                                hideTitleAndDescription\n                            >\n                                <div>\n                                    {cohort.is_calculating ? (\n                                        <div className=\"cohort-recalculating flex items-center\">\n                                            <Spinner className=\"mr-4\" />\n                                            {cohort.is_static\n                                                ? \"We're creating this cohort. This could take up to a couple of minutes.\"\n                                                : \"We're recalculating who belongs to this cohort. This could take up to a couple of minutes.\"}\n                                        </div>\n                                    ) : (\n                                        <Query\n                                            query={query}\n                                            setQuery={setQuery}\n                                            context={{\n                                                refresh: 'force_blocking',\n                                                fileNameForExport: cohort.name,\n                                                dataNodeLogicKey: dataNodeLogicKey,\n                                            }}\n                                        />\n                                    )}\n                                </div>\n                            </SceneSection>\n                        </>\n                    )}\n                </SceneContent>\n            </Form>\n        </div>\n    )\n}\n"],"names":[],"sourceRoot":""}