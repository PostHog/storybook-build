"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[16801],{"./frontend/src/scenes/experiments/Metrics/Selectors.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{IF:()=>FunnelConversionWindowFilter,dF:()=>commonActionFilterProps,f$:()=>FunnelAttributionSelect,xE:()=>FunnelAggregationSelect});var _posthog_icons__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.9.2_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib_components_HogQLEditor_HogQLEditor__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./frontend/src/lib/components/HogQLEditor/HogQLEditor.tsx"),lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./frontend/src/lib/components/TaxonomicFilter/types.ts"),lib_introductions_groupsAccessLogic__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/introductions/groupsAccessLogic.ts"),lib_lemon_ui_Tooltip__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip/index.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/lib/utils.tsx"),scenes_groups_GroupsIntroduction__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./frontend/src/scenes/groups/GroupsIntroduction.tsx"),scenes_insights_EditorFilters_FunnelsQuerySteps__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./frontend/src/scenes/insights/EditorFilters/FunnelsQuerySteps.tsx"),scenes_insights_views_Funnels_FunnelConversionWindowFilter__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("./frontend/src/scenes/insights/views/Funnels/FunnelConversionWindowFilter.tsx"),_models_groupsModel__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("./frontend/src/models/groupsModel.ts"),_types__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("./frontend/src/types.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let commonActionFilterProps={actionsTaxonomicGroupTypes:[lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Events,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Actions,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.DataWarehouse],propertiesTaxonomicGroupTypes:[lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.EventProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.PersonProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.EventFeatureFlags,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Cohorts,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Elements,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.SessionProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.HogQLExpression,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.DataWarehouseProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.DataWarehousePersonProperties]};function FunnelAggregationSelect(_ref){let{value,onChange}=_ref,{groupTypes,aggregationLabel}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(_models_groupsModel__WEBPACK_IMPORTED_MODULE_11__.$),{needsUpgradeForGroups,canStartUsingGroups}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(lib_introductions_groupsAccessLogic__WEBPACK_IMPORTED_MODULE_5__.e),UNIQUE_USERS="person_id",baseValues=[UNIQUE_USERS],optionSections=[{title:"Event Aggregation",options:[{value:UNIQUE_USERS,label:"Unique users"}]}];return needsUpgradeForGroups||canStartUsingGroups?optionSections[0].footer=(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(scenes_groups_GroupsIntroduction__WEBPACK_IMPORTED_MODULE_8__.b,{needsUpgrade:needsUpgradeForGroups}):Array.from(groupTypes.values()).forEach(groupType=>{baseValues.push(`$group_${groupType.group_type_index}`),optionSections[0].options.push({value:`$group_${groupType.group_type_index}`,label:`Unique ${aggregationLabel(groupType.group_type_index).plural}`})}),baseValues.push("properties.$session_id"),optionSections[0].options.push({value:"properties.$session_id",label:"Unique sessions"}),optionSections[0].options.push({label:"Custom HogQL expression",options:[{value:!value||baseValues.includes(value)?"":value,label:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("span",{className:"font-mono",children:value}),labelInMenu:function CustomHogQLOptionWrapped(_ref2){let{onSelect}=_ref2;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("div",{className:"w-120",style:{maxWidth:"max(60vw, 20rem)"},children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_components_HogQLEditor_HogQLEditor__WEBPACK_IMPORTED_MODULE_3__.E,{onChange:onSelect,value:value,placeholder:"Enter HogQL expression, such as:\n- distinct_id\n- properties.$session_id\n- concat(distinct_id, ' ', properties.$session_id)\n- if(1 < 2, 'one', 'two')"})})}}]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"flex items-center w-full gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("span",{children:"Aggregating by"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Yv,{className:"flex-1",value:value,onChange:onChange,options:optionSections,dropdownMatchSelectWidth:!1})]})}function FunnelConversionWindowFilter(_ref3){let{funnelWindowInterval,funnelWindowIntervalUnit,onFunnelWindowIntervalChange,onFunnelWindowIntervalUnitChange}=_ref3,options=Object.keys(scenes_insights_views_Funnels_FunnelConversionWindowFilter__WEBPACK_IMPORTED_MODULE_10__.V).map(unit=>({label:(0,lib_utils__WEBPACK_IMPORTED_MODULE_7__.fm)((0,lib_utils__WEBPACK_IMPORTED_MODULE_7__.Zi)(null!=funnelWindowInterval?funnelWindowInterval:7,unit,`${unit}s`,!1)),value:unit})),intervalBounds=scenes_insights_views_Funnels_FunnelConversionWindowFilter__WEBPACK_IMPORTED_MODULE_10__.V[null!=funnelWindowIntervalUnit?funnelWindowIntervalUnit:_types__WEBPACK_IMPORTED_MODULE_12__.ih.Day];return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"flex items-center gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("span",{className:"flex whitespace-nowrap",children:["Conversion window limit",(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_Tooltip__WEBPACK_IMPORTED_MODULE_6__.u,{title:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("b",{children:"Recommended!"})," Limit to participants that converted within a specific time frame. Participants that do not convert in this time frame will be considered as drop-offs."]}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconInfo,{className:"w-4 info-indicator"})})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"flex items-center gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.DF,{type:"number",className:"max-w-20",fullWidth:!1,min:intervalBounds[0],max:intervalBounds[1],value:funnelWindowInterval,onChange:onFunnelWindowIntervalChange}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Yv,{dropdownMatchSelectWidth:!1,value:funnelWindowIntervalUnit,onChange:onFunnelWindowIntervalUnitChange,options:options})]})]})}function FunnelAttributionSelect(_ref4){let{value,onChange,stepsLength}=_ref4,funnelOrderType=void 0;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"flex items-center w-full gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"flex",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("span",{children:"Attribution type"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_Tooltip__WEBPACK_IMPORTED_MODULE_6__.u,{closeDelayMs:200,title:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{className:"space-y-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("div",{children:"When breaking down funnels, it's possible that the same properties don't exist on every event. For example, if you want to break down by browser on a funnel that contains both frontend and backend events."}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("div",{children:"In this case, you can choose from which step the properties should be selected from by modifying the attribution type. There are four modes to choose from:"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("ul",{className:"list-disc pl-4",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("li",{children:"First touchpoint: the first property value seen in any of the steps is chosen."}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("li",{children:"Last touchpoint: the last property value seen from all steps is chosen."}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("li",{children:"All steps: the property value must be seen in all steps to be considered in the funnel."}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("li",{children:"Specific step: only the property value seen at the selected step is chosen."})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("div",{children:["Read more in the"," ",(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.rU,{to:"https://posthog.com/docs/product-analytics/funnels#attribution-types",children:"documentation."})]})]}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconInfo,{className:"text-xl text-muted-alt shrink-0 ml-1"})})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Yv,{value:value,placeholder:"Attribution",options:[{value:_types__WEBPACK_IMPORTED_MODULE_12__.q9.FirstTouch,label:"First touchpoint"},{value:_types__WEBPACK_IMPORTED_MODULE_12__.q9.LastTouch,label:"Last touchpoint"},{value:_types__WEBPACK_IMPORTED_MODULE_12__.q9.AllSteps,label:"All steps"},{value:_types__WEBPACK_IMPORTED_MODULE_12__.q9.Step,label:"Any step",hidden:funnelOrderType!==_types__WEBPACK_IMPORTED_MODULE_12__.kO.UNORDERED},{label:"Specific step",options:Array(scenes_insights_EditorFilters_FunnelsQuerySteps__WEBPACK_IMPORTED_MODULE_9__.i).fill(null).map((_,stepIndex)=>({value:`${_types__WEBPACK_IMPORTED_MODULE_12__.q9.Step}/${stepIndex}`,label:`Step ${stepIndex+1}`,hidden:stepIndex>=stepsLength})),hidden:funnelOrderType===_types__WEBPACK_IMPORTED_MODULE_12__.kO.UNORDERED}],onChange:onChange,dropdownMaxContentWidth:!0,"data-attr":"breakdown-attributions"})]})}},"./frontend/src/scenes/experiments/SavedMetrics/SavedMetric.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{SavedMetric:()=>SavedMetric,scene:()=>scene});var posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.9.2_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),themeLogic=__webpack_require__("./frontend/src/layout/navigation-3000/themeLogic.ts"),schema=__webpack_require__("./frontend/src/queries/schema.ts"),experimentLogic=__webpack_require__("./frontend/src/scenes/experiments/experimentLogic.tsx"),types=__webpack_require__("./frontend/src/lib/components/TaxonomicFilter/types.ts"),TestAccountFiltersSwitch=__webpack_require__("./frontend/src/lib/components/TestAccountFiltersSwitch.tsx"),constants=__webpack_require__("./frontend/src/lib/constants.tsx"),ActionFilter=__webpack_require__("./frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("./frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),AggregationSelect=__webpack_require__("./frontend/src/scenes/insights/filters/AggregationSelect.tsx"),teamLogic=__webpack_require__("./frontend/src/scenes/teamLogic.tsx"),filtersToQueryNode=__webpack_require__("./frontend/src/queries/nodes/InsightQuery/utils/filtersToQueryNode.ts"),queryNodeToFilter=__webpack_require__("./frontend/src/queries/nodes/InsightQuery/utils/queryNodeToFilter.ts"),Query=__webpack_require__("./frontend/src/queries/Query/Query.tsx"),src_types=__webpack_require__("./frontend/src/types.ts"),Selectors=__webpack_require__("./frontend/src/scenes/experiments/Metrics/Selectors.tsx"),lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.2.0_kea@3.1.5/node_modules/kea-router/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),savedMetricsLogic=__webpack_require__("./frontend/src/scenes/experiments/SavedMetrics/savedMetricsLogic.tsx");let NEW_SAVED_METRIC={name:"",description:"",query:(0,experimentLogic.ug)()},savedMetricLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.path)(key=>["scenes","experiments","savedMetricLogic",key]),(0,index_esm.key)(props=>props.savedMetricId||"new"),(0,index_esm.connect)(()=>({actions:[savedMetricsLogic.w,["loadSavedMetrics"]]})),(0,index_esm.actions)({setSavedMetric:metric=>({metric}),createSavedMetric:!0,updateSavedMetric:!0,deleteSavedMetric:!0}),(0,lib.loaders)(_ref=>{let{props}=_ref;return{savedMetric:{loadSavedMetric:async()=>{if(props.savedMetricId&&"new"!==props.savedMetricId){let response=await api.ZP.get(`api/projects/@current/experiment_saved_metrics/${props.savedMetricId}`);return response}return{...NEW_SAVED_METRIC}}}}}),(0,index_esm.listeners)(_ref2=>{let{actions,values}=_ref2;return{createSavedMetric:async()=>{let response=await api.ZP.create("api/projects/@current/experiment_saved_metrics/",values.savedMetric);response.id&&(src.UJ.success("Shared metric created successfully"),actions.loadSavedMetrics(),kea_router_lib.router.actions.push("/experiments/shared-metrics"))},updateSavedMetric:async()=>{let response=await api.ZP.update(`api/projects/@current/experiment_saved_metrics/${values.savedMetricId}`,values.savedMetric);response.id&&(src.UJ.success("Shared metric updated successfully"),actions.loadSavedMetrics(),kea_router_lib.router.actions.push("/experiments/shared-metrics"))},deleteSavedMetric:async()=>{try{await api.ZP.delete(`api/projects/@current/experiment_saved_metrics/${values.savedMetricId}`),src.UJ.success("Shared metric deleted successfully"),actions.loadSavedMetrics(),kea_router_lib.router.actions.push("/experiments/shared-metrics")}catch(error){src.UJ.error("Failed to delete shared metric"),console.error(error)}}}}),(0,index_esm.reducers)({savedMetric:[{...NEW_SAVED_METRIC},{setSavedMetric:(state,_ref3)=>{let{metric}=_ref3;return{...state,...metric}}}]}),(0,index_esm.selectors)({savedMetricId:[()=>[(_,props)=>{var _props$savedMetricId;return null!==(_props$savedMetricId=props.savedMetricId)&&void 0!==_props$savedMetricId?_props$savedMetricId:"new"}],savedMetricId=>savedMetricId],isNew:[s=>[s.savedMetricId],savedMetricId=>"new"===savedMetricId]}),(0,kea_router_lib.urlToAction)(_ref4=>{let{actions,values}=_ref4;return{"/experiments/shared-metrics/:id":(_ref5,_,__,currentLocation,previousLocation)=>{let{id}=_ref5,didPathChange=currentLocation.initial||currentLocation.pathname!==previousLocation?.pathname;if(id&&didPathChange){let parsedId="new"===id?"new":parseInt(id);"new"===parsedId&&actions.setSavedMetric({...NEW_SAVED_METRIC}),"new"!==parsedId&&parsedId===values.savedMetricId&&actions.loadSavedMetric()}}}})]);var jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function SavedFunnelsMetricForm(){var _savedMetricQuery$fun,_savedMetricQuery$fun2;let{savedMetric}=(0,index_esm.useValues)(savedMetricLogic),{setSavedMetric}=(0,index_esm.useActions)(savedMetricLogic),{currentTeam}=(0,index_esm.useValues)(teamLogic.H),hasFilters=(currentTeam?.test_account_filters||[]).length>0,actionFilterProps={...Selectors.dF,actionsTaxonomicGroupTypes:[types.t.Events,types.t.Actions]};if(!savedMetric?.query)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let savedMetricQuery=savedMetric.query;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(savedMetricQuery.funnels_query),setFilters:_ref=>{let{actions,events,data_warehouse}=_ref;if(!savedMetric?.query)return;let series=(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.None);setSavedMetric({query:{...savedMetricQuery,funnels_query:{...savedMetricQuery.funnels_query,series}}})},typeKey:"experiment-metric",mathAvailability:ActionFilterRow.Qq.None,buttonCopy:"Add funnel step",showSeriesIndicator:!0,seriesIndicatorType:"numeric",sortable:!0,showNestedArrow:!0,...actionFilterProps}),(0,jsx_runtime.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,jsx_runtime.jsx)(Selectors.xE,{value:(0,AggregationSelect.eV)(null!==(_savedMetricQuery$fun=savedMetricQuery.funnels_query.aggregation_group_type_index)&&void 0!==_savedMetricQuery$fun?_savedMetricQuery$fun:void 0,null!==(_savedMetricQuery$fun2=savedMetricQuery.funnels_query.funnelsFilter?.funnelAggregateByHogQL)&&void 0!==_savedMetricQuery$fun2?_savedMetricQuery$fun2:void 0),onChange:value=>{setSavedMetric({query:{...savedMetricQuery,funnels_query:{...savedMetricQuery.funnels_query,aggregation_group_type_index:value}}})}}),(0,jsx_runtime.jsx)(Selectors.IF,{funnelWindowInterval:savedMetricQuery.funnels_query?.funnelsFilter?.funnelWindowInterval,funnelWindowIntervalUnit:savedMetricQuery.funnels_query?.funnelsFilter?.funnelWindowIntervalUnit,onFunnelWindowIntervalChange:funnelWindowInterval=>{setSavedMetric({query:{...savedMetricQuery,funnels_query:{...savedMetricQuery.funnels_query,funnelsFilter:{...savedMetricQuery.funnels_query.funnelsFilter,funnelWindowInterval:funnelWindowInterval}}}})},onFunnelWindowIntervalUnitChange:funnelWindowIntervalUnit=>{setSavedMetric({query:{...savedMetricQuery,funnels_query:{...savedMetricQuery.funnels_query,funnelsFilter:{...savedMetricQuery.funnels_query.funnelsFilter,funnelWindowIntervalUnit:funnelWindowIntervalUnit||void 0}}}})}}),(0,jsx_runtime.jsx)(Selectors.f$,{value:(()=>{let breakdownAttributionType=savedMetricQuery.funnels_query?.funnelsFilter?.breakdownAttributionType,breakdownAttributionValue=savedMetricQuery.funnels_query?.funnelsFilter?.breakdownAttributionValue,currentValue=breakdownAttributionType?breakdownAttributionType===src_types.q9.Step?`${breakdownAttributionType}/${breakdownAttributionValue||0}`:breakdownAttributionType:src_types.q9.FirstTouch;return currentValue})(),onChange:value=>{let[breakdownAttributionType,breakdownAttributionValue]=(value||"").split("/");setSavedMetric({query:{...savedMetricQuery,funnels_query:{...savedMetricQuery.funnels_query,funnelsFilter:{...savedMetricQuery.funnels_query.funnelsFilter,breakdownAttributionType:breakdownAttributionType,breakdownAttributionValue:breakdownAttributionValue?parseInt(breakdownAttributionValue):void 0}}}})},stepsLength:savedMetricQuery.funnels_query?.series?.length}),(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=savedMetricQuery.funnels_query?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{setSavedMetric({query:{...savedMetricQuery,funnels_query:{...savedMetricQuery.funnels_query,filterTestAccounts:checked}}})},fullWidth:!0})]}),(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema.OH.InsightVizNode,source:savedMetricQuery.funnels_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})}var dayjs=__webpack_require__("./frontend/src/lib/dayjs.ts"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js");function SavedTrendsMetricForm(){let{savedMetric}=(0,index_esm.useValues)(savedMetricLogic),{setSavedMetric}=(0,index_esm.useActions)(savedMetricLogic),{currentTeam}=(0,index_esm.useValues)(teamLogic.H),hasFilters=(currentTeam?.test_account_filters||[]).length>0,[activeTab,setActiveTab]=(0,react.useState)("main");if(!savedMetric?.query)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let savedMetricQuery=savedMetric.query;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,onChange:newKey=>setActiveTab(newKey),tabs:[{key:"main",label:"Main metric",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(savedMetricQuery.count_query),setFilters:_ref=>{let{actions,events,data_warehouse}=_ref,series=(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.All);setSavedMetric({query:{...savedMetricQuery,count_query:{...savedMetricQuery.count_query,series}}})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!0,entitiesLimit:1,showNumericalPropsOnly:!0,onlyPropertyMathDefinitions:[src_types.O4.Average],...Selectors.dF}),(0,jsx_runtime.jsx)("div",{className:"mt-4 space-y-4",children:(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=savedMetricQuery.count_query?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{setSavedMetric({query:{...savedMetricQuery,count_query:{...savedMetricQuery.count_query,filterTestAccounts:checked}}})},fullWidth:!0})}),(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema.OH.InsightVizNode,source:savedMetricQuery.count_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})},{key:"exposure",label:"Exposure",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${savedMetricQuery.exposure_query?"border-border":"border-primary bg-primary-highlight"}`,onClick:()=>{setSavedMetric({query:{...savedMetricQuery,exposure_query:void 0}})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Default"}),!savedMetricQuery.exposure_query&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--primary)"})]}),(0,jsx_runtime.jsxs)("div",{className:"text-muted text-sm leading-relaxed",children:["Uses the number of unique users who trigger the"," ",(0,jsx_runtime.jsx)(src.oe,{children:"$feature_flag_called"})," event as your exposure count. This is the recommended setting for most experiments, as it accurately tracks variant exposure."]})]}),(0,jsx_runtime.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${savedMetricQuery.exposure_query?"border-primary bg-primary-highlight":"border-border"}`,onClick:()=>{setSavedMetric({query:{...savedMetricQuery,exposure_query:{kind:schema.OH.TrendsQuery,series:[{kind:schema.OH.EventsNode,name:"$feature_flag_called",event:"$feature_flag_called",math:src_types.vN.UniqueUsers}],interval:"day",dateRange:{date_from:(0,dayjs.Bv)().subtract(constants.uq,"day").format("YYYY-MM-DDTHH:mm"),date_to:(0,dayjs.Bv)().endOf("d").format("YYYY-MM-DDTHH:mm"),explicitDate:!0},trendsFilter:{display:src_types.Qb.ActionsLineGraph},filterTestAccounts:!0}}})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Custom"}),savedMetricQuery.exposure_query&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--primary)"})]}),(0,jsx_runtime.jsx)("div",{className:"text-muted text-sm leading-relaxed",children:"Define your own exposure metric for specific use cases, such as counting by sessions instead of users. This gives you full control but requires careful configuration."})]})]}),savedMetricQuery.exposure_query&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(savedMetricQuery.exposure_query),setFilters:_ref2=>{let{actions,events,data_warehouse}=_ref2,series=(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.All);setSavedMetric({query:{...savedMetricQuery,exposure_query:{...savedMetricQuery.exposure_query,series}}})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!0,entitiesLimit:1,showNumericalPropsOnly:!0,...Selectors.dF}),(0,jsx_runtime.jsx)("div",{className:"mt-4 space-y-4",children:(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=savedMetricQuery.exposure_query?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{setSavedMetric({query:{...savedMetricQuery,exposure_query:{...savedMetricQuery.exposure_query,filterTestAccounts:checked}}})},fullWidth:!0})}),(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema.OH.InsightVizNode,source:savedMetricQuery.exposure_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})]})}]})})}let scene={component:SavedMetric,logic:savedMetricLogic,paramsToProps:_ref=>{let{params:{id}}=_ref;return{savedMetricId:"new"===id?"new":parseInt(id)}}};function SavedMetric(){let{savedMetricId,savedMetric}=(0,index_esm.useValues)(savedMetricLogic),{setSavedMetric,createSavedMetric,updateSavedMetric,deleteSavedMetric}=(0,index_esm.useActions)(savedMetricLogic),{isDarkModeOn}=(0,index_esm.useValues)(themeLogic.b);return savedMetric&&savedMetric.query?(0,jsx_runtime.jsxs)("div",{className:"max-w-[800px]",children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${savedMetric.query.kind===schema.OH.ExperimentTrendsQuery?"border-primary bg-primary-highlight":"border-border"}`,onClick:()=>{setSavedMetric({query:(0,experimentLogic.ug)()})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Trend"}),savedMetric.query.kind===schema.OH.ExperimentTrendsQuery&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--primary)"})]}),(0,jsx_runtime.jsx)("div",{className:"text-muted text-sm leading-relaxed",children:"Track a single event, action or a property value."})]}),(0,jsx_runtime.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${savedMetric.query.kind===schema.OH.ExperimentFunnelsQuery?"border-primary bg-primary-highlight":"border-border"}`,onClick:()=>{setSavedMetric({query:(0,experimentLogic.xs)()})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Funnel"}),savedMetric.query.kind===schema.OH.ExperimentFunnelsQuery&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--primary)"})]}),(0,jsx_runtime.jsx)("div",{className:"text-muted text-sm leading-relaxed",children:"Analyze conversion rates between sequential steps."})]})]}),(0,jsx_runtime.jsxs)("div",{className:`border rounded ${isDarkModeOn?"bg-light":"bg-white"} p-4`,children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Name"}),(0,jsx_runtime.jsx)(src.DF,{value:savedMetric.name,onChange:newName=>{setSavedMetric({name:newName})}})]}),(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Description (optional)"}),(0,jsx_runtime.jsx)(src.DF,{value:savedMetric.description,onChange:newDescription=>{setSavedMetric({description:newDescription})}})]}),savedMetric.query.kind===schema.OH.ExperimentTrendsQuery?(0,jsx_runtime.jsx)(SavedTrendsMetricForm,{}):(0,jsx_runtime.jsx)(SavedFunnelsMetricForm,{})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between mt-4",children:[(0,jsx_runtime.jsx)(src.Jp,{size:"medium",type:"primary",status:"danger",onClick:()=>{src.dn.open({title:"Delete this metric?",content:(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:"This action cannot be undone."}),primaryButton:{children:"Delete",type:"primary",onClick:()=>deleteSavedMetric(),size:"small"},secondaryButton:{children:"Cancel",type:"tertiary",size:"small"}})},children:"Delete"}),(0,jsx_runtime.jsx)(src.Jp,{disabledReason:savedMetric.name?void 0:"You must give your metric a name",size:"medium",type:"primary",onClick:()=>{"new"===savedMetricId?createSavedMetric():updateSavedMetric()},children:"Save"})]})]}):(0,jsx_runtime.jsx)("div",{className:"fixed inset-0 flex justify-center items-center",children:(0,jsx_runtime.jsx)(src.$j,{className:"text-5xl"})})}}}]);