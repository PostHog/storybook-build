"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[47855],{"../../frontend/src/scenes/audit-logs/AdvancedActivityLogsScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{AdvancedActivityLogsScene:()=>AdvancedActivityLogsScene,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.30.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),humanizeActivity=__webpack_require__("../../frontend/src/lib/components/ActivityLog/humanizeActivity.tsx"),DateFilter=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),LemonInputSelect=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonInputSelect/LemonInputSelect.tsx"),advancedActivityLogsLogic=__webpack_require__("../../frontend/src/scenes/audit-logs/advancedActivityLogsLogic.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let DetailFilterRow=_ref=>{let{filter}=_ref,{availableFilters}=(0,index_esm.useValues)(advancedActivityLogsLogic.advancedActivityLogsLogic),{updateActiveFilter,removeActiveFilter}=(0,index_esm.useActions)(advancedActivityLogsLogic.advancedActivityLogsLogic),[localValue,setLocalValue]=(0,react.useState)(filter.value),[localFieldPath,setLocalFieldPath]=(0,react.useState)(filter.fieldPath),[fieldPathError,setFieldPathError]=(0,react.useState)(null),debounceTimerRef=(0,react.useRef)(null),fieldOptionsForRow=(0,react.useMemo)(()=>{if(!availableFilters?.detail_fields)return[];let{activeFilters}=advancedActivityLogsLogic.advancedActivityLogsLogic.values,selectedFields=new Set(activeFilters.filter(f=>f.key!==filter.key&&!f.isCustom).map(f=>f.fieldPath)),sections=new Map,generalFields=new Set;return Object.entries(availableFilters.detail_fields).forEach(_ref2=>{let[scope,scopeData]=_ref2,cleanScope=scope.replace(/([A-Z])/g," $1").trim()||"General";sections.has(cleanScope)||sections.set(cleanScope,{fields:new Map,scope}),scopeData.fields.forEach(field=>{let fieldValue=`${scope}::${field.name}`;selectedFields.has(fieldValue)&&fieldValue!==filter.fieldPath||sections.get(cleanScope).fields.set(field.name,fieldValue),"General"===cleanScope&&generalFields.add(field.name)})}),Array.from(sections.entries()).sort((_ref3,_ref4)=>{let[a]=_ref3,[b]=_ref4;return"General"===a?-1:"General"===b?1:a.localeCompare(b)}).map(_ref5=>{let[title,{fields}]=_ref5,fieldOptions=Array.from(fields.entries()).filter(_ref6=>{let[fieldName]=_ref6;return"General"===title||!generalFields.has(fieldName)}).sort((_ref7,_ref8)=>{let[a]=_ref7,[b]=_ref8;return a.localeCompare(b)}).map(_ref9=>{let[fieldName,fieldValue]=_ref9;return{value:fieldValue,label:fieldName}});return{title,options:fieldOptions}}).filter(section=>section.options.length>0)},[availableFilters,filter.key,filter.fieldPath]),validateCustomFieldPath=path=>{if(!path||!path.trim())return"Field path cannot be empty";let cleanPath=path.trim();return/^[a-zA-Z0-9_.[\]]+$/.test(cleanPath)?null:"Field path can only contain letters, numbers, dots, underscores, and square brackets"};(0,react.useEffect)(()=>{setLocalValue(filter.value)},[filter.value]),(0,react.useEffect)(()=>{setLocalFieldPath(filter.fieldPath)},[filter.fieldPath]);let handleValueChange=value=>{setLocalValue(value),debounceTimerRef.current&&clearTimeout(debounceTimerRef.current),(Array.isArray(value)?value.some(v=>v.length>0):value.length>0)&&(debounceTimerRef.current=setTimeout(()=>{updateActiveFilter(filter.key,{value})},500))};return(0,react.useEffect)(()=>()=>{debounceTimerRef.current&&clearTimeout(debounceTimerRef.current)},[]),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[filter.isCustom?(0,jsx_runtime.jsxs)("div",{className:"min-w-60",children:[(0,jsx_runtime.jsx)(src.DF,{value:localFieldPath,onChange:newPath=>{setLocalFieldPath(newPath);let error=validateCustomFieldPath(newPath);setFieldPathError(error),!error&&newPath&&newPath!==filter.fieldPath&&(debounceTimerRef.current&&clearTimeout(debounceTimerRef.current),debounceTimerRef.current=setTimeout(()=>{let cleanPath=newPath.trim();cleanPath&&cleanPath!==filter.fieldPath&&updateActiveFilter(filter.key,{fieldPath:cleanPath})},500))},placeholder:"Enter custom field path",status:fieldPathError?"danger":void 0}),fieldPathError&&(0,jsx_runtime.jsx)("div",{className:"text-xs text-danger mt-1",children:fieldPathError})]}):(0,jsx_runtime.jsx)(src.Yv,{value:filter.fieldPath,onChange:newFieldPath=>{newFieldPath!==filter.fieldPath&&(debounceTimerRef.current&&clearTimeout(debounceTimerRef.current),updateActiveFilter(filter.key,{fieldPath:newFieldPath}))},options:fieldOptionsForRow,placeholder:"Select field",className:"min-w-60"}),(0,jsx_runtime.jsx)(src.Yv,{value:filter.operation,onChange:operation=>{let newValue="in"!==operation||Array.isArray(filter.value)?filter.value:[filter.value];setLocalValue(newValue),updateActiveFilter(filter.key,{operation,value:newValue})},options:[{value:"exact",label:"equals"},{value:"contains",label:"contains"},{value:"in",label:"is one of"}],className:"min-w-32"}),"in"===filter.operation?(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",value:localValue,onChange:handleValueChange,allowCustomValues:!0,placeholder:"Enter values",className:"min-w-60"}):(0,jsx_runtime.jsx)(src.DF,{value:localValue,onChange:handleValueChange,placeholder:"Enter value",className:"min-w-60"}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconTrash,{}),size:"small",type:"tertiary",onClick:()=>removeActiveFilter(filter.key),tooltip:"Remove filter"})]})},DetailFilters=()=>{let{activeFilters,availableFilters}=(0,index_esm.useValues)(advancedActivityLogsLogic.advancedActivityLogsLogic),{addActiveFilter}=(0,index_esm.useActions)(advancedActivityLogsLogic.advancedActivityLogsLogic),fieldOptions=(0,react.useMemo)(()=>{if(!availableFilters?.detail_fields)return[];let selectedFields=new Set(activeFilters.filter(f=>!f.isCustom).map(f=>f.fieldPath)),sections=new Map,generalFields=new Set;Object.entries(availableFilters.detail_fields).forEach(_ref10=>{let[scope,scopeData]=_ref10,cleanScope=scope.replace(/([A-Z])/g," $1").trim()||"General";sections.has(cleanScope)||sections.set(cleanScope,{fields:new Map,scope}),scopeData.fields.forEach(field=>{let fieldValue=`${scope}::${field.name}`;selectedFields.has(fieldValue)||sections.get(cleanScope).fields.set(field.name,fieldValue),"General"===cleanScope&&generalFields.add(field.name)})});let fieldSections=Array.from(sections.entries()).sort((_ref11,_ref12)=>{let[a]=_ref11,[b]=_ref12;return"General"===a?-1:"General"===b?1:a.localeCompare(b)}).map(_ref13=>{let[title,{fields}]=_ref13,fieldOptions=Array.from(fields.entries()).filter(_ref14=>{let[fieldName]=_ref14;return"General"===title||!generalFields.has(fieldName)}).sort((_ref15,_ref16)=>{let[a]=_ref15,[b]=_ref16;return a.localeCompare(b)}).map(_ref17=>{let[fieldName,fieldValue]=_ref17;return{value:fieldValue,label:fieldName}});return{title,options:fieldOptions}}).filter(section=>section.options.length>0);return fieldSections.push({title:"Custom",options:[{value:"__add_custom__",label:"Custom field path..."}]}),fieldSections},[availableFilters,activeFilters]);return availableFilters?.detail_fields&&0!==Object.keys(availableFilters.detail_fields).length?(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsx)("label",{className:"block text-sm font-medium",children:"Detail Filters"}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col gap-2",children:activeFilters.map(filter=>(0,jsx_runtime.jsx)(DetailFilterRow,{filter:filter},filter.key))}),(0,jsx_runtime.jsx)(src.Ds,{value:void 0,onChange:value=>{"__add_custom__"===value?addActiveFilter("",!0):value&&addActiveFilter(value,!1)},options:fieldOptions,placeholder:"Add detail filter",searchPlaceholder:"Search fields...",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),className:"w-[200px]"})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})},BasicFiltersTab=()=>{let{filters,availableFilters}=(0,index_esm.useValues)(advancedActivityLogsLogic.advancedActivityLogsLogic),{setFilters}=(0,index_esm.useActions)(advancedActivityLogsLogic.advancedActivityLogsLogic);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-4 pt-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 flex-start flex-wrap",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Date Range"}),(0,jsx_runtime.jsx)(DateFilter.f,{dateFrom:filters.start_date,dateTo:filters.end_date,onChange:(start_date,end_date)=>{setFilters({start_date:start_date||void 0,end_date:end_date||void 0})},placeholder:"All time","data-attr":"audit-logs-date-filter",className:"h-8 flex items-center"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)("label",{className:"block text-sm font-medium mb-1",children:"User"}),(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",displayMode:"count",bulkActions:"select-and-clear-all",value:filters.users||[],onChange:users=>setFilters({users}),options:availableFilters?.static_filters?.users?.map(u=>({key:u.value,label:u.label}))||[],placeholder:"All users",allowCustomValues:!1,"data-attr":"audit-logs-user-filter",className:"min-w-50 min-h-10"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Scope"}),(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",displayMode:"count",bulkActions:"select-and-clear-all",value:filters.scopes||[],onChange:scopes=>setFilters({scopes:scopes}),options:availableFilters?.static_filters?.scopes?.map(s=>({key:s.value,label:humanizeActivity.VI(s.value,!0)}))||[],placeholder:"All scopes",allowCustomValues:!1,"data-attr":"audit-logs-scope-filter",className:"min-w-50 min-h-10"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Action"}),(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",displayMode:"count",bulkActions:"select-and-clear-all",value:filters.activities||[],onChange:activities=>setFilters({activities}),options:availableFilters?.static_filters?.activities?.map(a=>({key:a.value,label:humanizeActivity.J$(a.value)}))||[],placeholder:"All actions",allowCustomValues:!1,"data-attr":"audit-logs-action-filter",className:"min-w-50 min-h-10"})]})]}),(0,jsx_runtime.jsx)(DetailFilters,{})]})};function AdvancedActivityLogFiltersPanel(){let{hasActiveFilters,exportsLoading}=(0,index_esm.useValues)(advancedActivityLogsLogic.advancedActivityLogsLogic),{clearAllFilters,exportLogs}=(0,index_esm.useActions)(advancedActivityLogsLogic.advancedActivityLogsLogic),[activeTab,setActiveTab]=(0,react.useState)("basic");return(0,jsx_runtime.jsxs)("div",{className:"border rounded-md p-4 bg-bg-light",children:[(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-end",children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Qw,{overlay:(0,jsx_runtime.jsxs)("div",{className:"space-y-1 p-1",children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",fullWidth:!0,onClick:()=>exportLogs("csv"),loading:exportsLoading,"data-attr":"audit-logs-export-csv",children:"Export as CSV"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",fullWidth:!0,onClick:()=>exportLogs("xlsx"),loading:exportsLoading,"data-attr":"audit-logs-export-xlsx",children:"Export as Excel"})]}),placement:"bottom-end","data-attr":"audit-logs-export-dropdown",children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconDownload,{}),"data-attr":"audit-logs-export-button",children:"Export"})}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",disabledReason:hasActiveFilters?void 0:"No active filters",onClick:clearAllFilters,"data-attr":"audit-logs-clear-filters",children:"Clear all"})]})}),(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,onChange:setActiveTab,"data-attr":"audit-logs-filter-tabs",tabs:[{key:"basic",label:"Filters",content:(0,jsx_runtime.jsx)(BasicFiltersTab,{})},{key:"hogql",label:"HogQL",content:(0,jsx_runtime.jsx)(HogQLFilterTab,{})}]})]})}let HogQLFilterTab=()=>(0,jsx_runtime.jsx)("div",{className:"pt-4",children:(0,jsx_runtime.jsx)("div",{children:"HogQL filter placeholder"})});var AdvancedActivityLogsList=__webpack_require__("../../frontend/src/scenes/audit-logs/AdvancedActivityLogsList.tsx"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts");let getStatusTag=exportAsset=>exportAsset.exception?(0,jsx_runtime.jsx)(src.oe,{type:"danger",children:"Failed"}):exportAsset.has_content?(0,jsx_runtime.jsx)(src.oe,{type:"success",children:"Completed"}):(0,jsx_runtime.jsx)(src.oe,{type:"default",children:"Processing"}),getHumanReadableFormat=format=>{let lowerFormat=format.toLowerCase();return["csv","text/csv"].some(matcher=>lowerFormat.includes(matcher))?"CSV":["xlsx","excel","spreadsheet"].some(matcher=>lowerFormat.includes(matcher))?"Excel":format.toUpperCase()},getFilterSummary=exportAsset=>{let filters=exportAsset.export_context?.filters;if(!filters)return"No filters";let activeFilters=[];return(filters.start_date||filters.end_date)&&activeFilters.push("Date filter: 1"),filters.users&&filters.users.length>0&&activeFilters.push(`Users: ${filters.users.length}`),filters.scopes&&filters.scopes.length>0&&activeFilters.push(`Scopes: ${filters.scopes.length}`),filters.activities&&filters.activities.length>0&&activeFilters.push(`Actions: ${filters.activities.length}`),filters.detail_filters&&Object.keys(filters.detail_filters).length>0&&activeFilters.push(`Detail filters: ${Object.keys(filters.detail_filters).length}`),activeFilters.length>0?activeFilters.join(", "):"No filters"},getFilterTooltip=exportAsset=>{let filters=exportAsset.export_context?.filters;if(!filters)return(0,jsx_runtime.jsx)("div",{children:"No filters applied"});let filterSections=[];if(filters.start_date||filters.end_date){let formatDate=dateStr=>{try{return(0,dayjs.Bv)(dateStr).format("YYYY-MM-DD HH:mm:ss")}catch{return dateStr}};filterSections.push((0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("strong",{children:"Date Range:"}),(0,jsx_runtime.jsx)("br",{}),filters.start_date&&`From: ${formatDate(filters.start_date)}`,filters.start_date&&filters.end_date&&(0,jsx_runtime.jsx)("br",{}),filters.end_date&&`To: ${formatDate(filters.end_date)}`]},"dates"))}if(filters.users&&filters.users.length>0&&filterSections.push((0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("strong",{children:["Users (",filters.users.length,"):"]}),(0,jsx_runtime.jsx)("br",{}),filters.users.slice(0,5).join(", "),filters.users.length>5&&`... and ${filters.users.length-5} more`]},"users")),filters.scopes&&filters.scopes.length>0&&filterSections.push((0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("strong",{children:["Scopes (",filters.scopes.length,"):"]}),(0,jsx_runtime.jsx)("br",{}),filters.scopes.slice(0,5).join(", "),filters.scopes.length>5&&`... and ${filters.scopes.length-5} more`]},"scopes")),filters.activities&&filters.activities.length>0&&filterSections.push((0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("strong",{children:["Actions (",filters.activities.length,"):"]}),(0,jsx_runtime.jsx)("br",{}),filters.activities.slice(0,5).join(", "),filters.activities.length>5&&`... and ${filters.activities.length-5} more`]},"activities")),filters.detail_filters&&Object.keys(filters.detail_filters).length>0){let detailFilterEntries=Object.entries(filters.detail_filters),detailFilterText=detailFilterEntries.map(_ref=>{let[field,filter]=_ref,valueText=Array.isArray(filter.value)?filter.value.join(", "):filter.value,operationText="exact"===filter.operation?"equals":"contains"===filter.operation?"contains":"is one of";return`${field} ${operationText} "${valueText}"`});filterSections.push((0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("strong",{children:["Detail Filters (",detailFilterEntries.length,"):"]}),(0,jsx_runtime.jsx)("br",{}),detailFilterText.slice(0,3).join(", "),detailFilterText.length>3&&`... and ${detailFilterText.length-3} more`]},"detail_filters"))}return 0===filterSections.length?(0,jsx_runtime.jsx)("div",{children:"No filters applied"}):(0,jsx_runtime.jsx)("div",{className:"space-y-2",children:filterSections.map((section,index)=>(0,jsx_runtime.jsx)("div",{children:section},index))})},downloadExport=exportAsset=>{let link=document.createElement("a");link.href=`/api/environments/@current/exports/${exportAsset.id}/content/?download=true`,link.download=exportAsset.filename||"",document.body.appendChild(link),link.click(),document.body.removeChild(link)};function ExportsList(){let{exports,exportsLoading}=(0,index_esm.useValues)(advancedActivityLogsLogic.advancedActivityLogsLogic),columns=[{title:"Filename",dataIndex:"filename",key:"filename",render:filename=>filename?String(filename):"export"},{title:"Format",dataIndex:"export_format",key:"export_format",render:format=>format?getHumanReadableFormat(String(format)):""},{title:"Filters",key:"filters",render:(_,exportAsset)=>(0,jsx_runtime.jsx)(src.u,{title:getFilterTooltip(exportAsset),children:(0,jsx_runtime.jsx)("span",{className:"text-muted text-xs cursor-help",children:getFilterSummary(exportAsset)})})},{title:"Status",key:"status",render:(_,exportAsset)=>getStatusTag(exportAsset)},{title:"Created",dataIndex:"created_at",key:"created_at",render:createdAt=>createdAt?(0,utils.bo)(String(createdAt)):""},{title:"Actions",key:"actions",render:(_,exportAsset)=>{let failedReason=exportAsset.exception&&"Failed to export",disabledReason=!exportAsset.has_content&&"Export is not ready";return(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconDownload,{}),disabledReason:failedReason||disabledReason,onClick:()=>downloadExport(exportAsset),"data-attr":`audit-logs-download-export-${exportAsset.id}`,children:"Download"})}}];return(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsx)("h3",{className:"text-lg font-semibold",children:"Your exports"}),(0,jsx_runtime.jsx)("p",{className:"text-muted text-xs",children:"Refreshed every 5 seconds"})]}),(0,jsx_runtime.jsx)(src.g3,{dataSource:exports||[],columns:columns,loading:exportsLoading,rowKey:"id",emptyState:"No exports found"})]})}let scene={component:AdvancedActivityLogsScene,logic:advancedActivityLogsLogic.advancedActivityLogsLogic};function AdvancedActivityLogsScene(){let{isFeatureFlagEnabled,exports,activeTab}=(0,index_esm.useValues)(advancedActivityLogsLogic.advancedActivityLogsLogic),{setActiveTab}=(0,index_esm.useActions)(advancedActivityLogsLogic.advancedActivityLogsLogic);if(!isFeatureFlagEnabled)return window.location.href=urls.j.projectHomepage(),null;let hasExports=exports&&exports.length>0,tabs=[{key:"logs",label:"Activity logs",content:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(AdvancedActivityLogFiltersPanel,{}),(0,jsx_runtime.jsx)(AdvancedActivityLogsList.d,{})]})},...hasExports?[{key:"exports",label:"Exports",content:(0,jsx_runtime.jsx)(ExportsList,{})}]:[]];return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(PageHeader.m,{caption:"Track all changes and activities in your organization"}),(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,onChange:key=>setActiveTab(key),tabs:tabs})]})}}}]);