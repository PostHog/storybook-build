"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[1191],{"./frontend/src/scenes/web-analytics/WebAnalyticsScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{WebAnalyticsScene:()=>WebAnalyticsScene,scene:()=>scene});var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@16.14.0/node_modules/kea/lib/index.esm.js"),schema=__webpack_require__("./frontend/src/queries/schema.ts"),types=__webpack_require__("./frontend/src/types.ts"),utils=__webpack_require__("./frontend/src/lib/utils.tsx");let SourceTab=function(SourceTab){return SourceTab.REFERRING_DOMAIN="REFERRING_DOMAIN",SourceTab.UTM_SOURCE="UTM_SOURCE",SourceTab.UTM_CAMPAIGN="UTM_CAMPAIGN",SourceTab}({}),DeviceTab=function(DeviceTab){return DeviceTab.BROWSER="BROWSER",DeviceTab.OS="OS",DeviceTab.DEVICE_TYPE="DEVICE_TYPE",DeviceTab}({}),PathTab=function(PathTab){return PathTab.PATH="PATH",PathTab.INITIAL_PATH="INITIAL_PATH",PathTab}({});const setOncePropertyNames=["$initial_pathname","$initial_referrer","$initial_utm_source","$initial_utm_campaign"],hogqlForSetOnceProperty=(key,value)=>`properties.$set_once.${key} = '${value}'`,isHogqlForSetOnceProperty=(key,p)=>setOncePropertyNames.includes(key)&&p.key.startsWith(`properties.$set_once.${key} = `),webAnalyticsLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","webAnalytics","webAnalyticsSceneLogic"]),(0,index_esm.connect)({}),(0,index_esm.actions)({setWebAnalyticsFilters:webAnalyticsFilters=>({webAnalyticsFilters}),togglePropertyFilter:(key,value)=>({key,value}),setSourceTab:tab=>({tab}),setDeviceTab:tab=>({tab}),setPathTab:tab=>({tab})}),(0,index_esm.reducers)({webAnalyticsFilters:[[],{setWebAnalyticsFilters:(_,_ref)=>{let{webAnalyticsFilters}=_ref;return webAnalyticsFilters},togglePropertyFilter:(oldPropertyFilters,_ref2)=>{let{key,value}=_ref2;if(oldPropertyFilters.some((f=>f.type===types.FT.Event&&f.key===key&&f.operator===types.WV.Exact||f.type===types.FT.HogQL&&isHogqlForSetOnceProperty(key,f))))return oldPropertyFilters.map((f=>{if(setOncePropertyNames.includes(key)){if(f.type!==types.FT.HogQL)return f;if(!isHogqlForSetOnceProperty(key,f))return f;const hogql=hogqlForSetOnceProperty(key,value);return f.key===hogql?null:{type:types.FT.HogQL,key,value:hogql}}{if(f.key!==key||f.type!==types.FT.Event||f.operator!==types.WV.Exact)return f;const oldValue=(Array.isArray(f.value)?f.value:[f.value]).filter(utils.DX);let newValue;if(oldValue.includes(value)){if(!(oldValue.length>1))return null;newValue=[value]}else newValue=[...oldValue,value];return{type:types.FT.Event,key,operator:types.WV.Exact,value:newValue}}})).filter(utils.DX);{let newFilter;return newFilter=setOncePropertyNames.includes(key)?{type:types.FT.HogQL,key:hogqlForSetOnceProperty(key,value)}:{type:types.FT.Event,key,value,operator:types.WV.Exact},[...oldPropertyFilters,newFilter]}}}],sourceTab:[SourceTab.REFERRING_DOMAIN,{setSourceTab:(_,_ref3)=>{let{tab}=_ref3;return tab}}],deviceTab:[DeviceTab.BROWSER,{setDeviceTab:(_,_ref4)=>{let{tab}=_ref4;return tab}}],pathTab:[PathTab.PATH,{setPathTab:(_,_ref5)=>{let{tab}=_ref5;return tab}}]}),(0,index_esm.selectors)((_ref6=>{let{actions}=_ref6;return{tiles:[s=>[s.webAnalyticsFilters,s.pathTab,s.deviceTab,s.sourceTab],(webAnalyticsFilters,pathTab,deviceTab,sourceTab)=>[{layout:{colSpan:12},query:{full:!0,kind:schema.OH.DataTableNode,source:{kind:schema.OH.WebOverviewStatsQuery,properties:webAnalyticsFilters}}},{layout:{colSpan:6},activeTabId:pathTab,setTabId:actions.setPathTab,tabs:[{id:PathTab.PATH,title:"Top Paths",linkText:"Path",query:{full:!0,kind:schema.OH.DataTableNode,source:{kind:schema.OH.WebStatsTableQuery,properties:webAnalyticsFilters,breakdownBy:schema.GI.Page}}},{id:PathTab.INITIAL_PATH,title:"Top Entry Paths",linkText:"Entry Path",query:{full:!0,kind:schema.OH.DataTableNode,source:{kind:schema.OH.WebStatsTableQuery,properties:webAnalyticsFilters,breakdownBy:schema.GI.InitialPage}}}]},{layout:{colSpan:6},activeTabId:sourceTab,setTabId:actions.setSourceTab,tabs:[{id:SourceTab.REFERRING_DOMAIN,title:"Top Referrers",linkText:"Referrer",query:{full:!0,kind:schema.OH.DataTableNode,source:{kind:schema.OH.WebStatsTableQuery,properties:webAnalyticsFilters,breakdownBy:schema.GI.InitialReferringDomain}}},{id:SourceTab.UTM_SOURCE,title:"Top Sources",linkText:"UTM Source",query:{full:!0,kind:schema.OH.DataTableNode,source:{kind:schema.OH.WebStatsTableQuery,properties:webAnalyticsFilters,breakdownBy:schema.GI.InitialUTMSource}}},{id:SourceTab.UTM_CAMPAIGN,title:"Top Campaigns",linkText:"UTM Campaign",query:{full:!0,kind:schema.OH.DataTableNode,source:{kind:schema.OH.WebStatsTableQuery,properties:webAnalyticsFilters,breakdownBy:schema.GI.InitialUTMCampaign}}}]},{layout:{colSpan:6},activeTabId:deviceTab,setTabId:actions.setDeviceTab,tabs:[{id:DeviceTab.BROWSER,title:"Top Browsers",linkText:"Browser",query:{full:!0,kind:schema.OH.DataTableNode,source:{kind:schema.OH.WebStatsTableQuery,properties:webAnalyticsFilters,breakdownBy:schema.GI.Browser}}},{id:DeviceTab.OS,title:"Top OSs",linkText:"OS",query:{full:!0,kind:schema.OH.DataTableNode,source:{kind:schema.OH.WebStatsTableQuery,properties:webAnalyticsFilters,breakdownBy:schema.GI.OS}}},{id:DeviceTab.DEVICE_TYPE,title:"Top Device Types",linkText:"Device Type",query:{full:!0,kind:schema.OH.DataTableNode,source:{kind:schema.OH.WebStatsTableQuery,properties:webAnalyticsFilters,breakdownBy:schema.GI.DeviceType}}}]},{title:"Unique users",layout:{colSpan:6},query:{kind:schema.OH.InsightVizNode,source:{kind:schema.OH.TrendsQuery,dateRange:{date_from:"-7d",date_to:"-1d"},interval:"day",series:[{event:"$pageview",kind:schema.OH.EventsNode,math:types.vN.UniqueUsers,name:"$pageview"}],trendsFilter:{compare:!0,display:types.Qb.ActionsLineGraph},filterTestAccounts:!0,properties:webAnalyticsFilters}}},{title:"World Map (Unique Users)",layout:{colSpan:6},query:{kind:schema.OH.InsightVizNode,source:{kind:schema.OH.TrendsQuery,breakdown:{breakdown:"$geoip_country_code",breakdown_type:"person"},dateRange:{date_from:"-7d"},series:[{event:"$pageview",kind:schema.OH.EventsNode,math:types.vN.UniqueUsers}],trendsFilter:{display:types.Qb.WorldMap},filterTestAccounts:!0,properties:webAnalyticsFilters}}}]]}})),(0,index_esm.sharedListeners)((()=>({}))),(0,index_esm.listeners)((()=>({})))]);var Query=__webpack_require__("./frontend/src/queries/Query/Query.tsx"),PropertyFilters=__webpack_require__("./frontend/src/lib/components/PropertyFilters/PropertyFilters.tsx"),TaxonomicFilter_types=__webpack_require__("./frontend/src/lib/components/TaxonomicFilter/types.ts"),PropertyFilters_utils=__webpack_require__("./frontend/src/lib/components/PropertyFilters/utils.ts"),react=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/index.js"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/jsx-runtime.js");const NumericCell=_ref2=>{let{value}=_ref2;return(0,jsx_runtime.jsx)("div",{className:"w-full text-right",children:(0,jsx_runtime.jsx)("span",{className:"flex-1 text-right",children:String(value)})})},queryContext={columns:{breakdown_value:{renderTitle:props=>{const{query}=props,{source}=query;if(source.kind!==schema.OH.WebStatsTableQuery)return null;const{breakdownBy}=source;switch(breakdownBy){case schema.GI.Page:return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Path"});case schema.GI.InitialPage:return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Initial Path"});case schema.GI.InitialReferringDomain:return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Referring Domain"});case schema.GI.InitialUTMSource:return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"UTM Source"});case schema.GI.InitialUTMCampaign:return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"UTM Campaign"});case schema.GI.Browser:return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Browser"});case schema.GI.OS:return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"OS"});case schema.GI.DeviceType:return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Device Type"});default:throw new utils.q0(breakdownBy)}},render:props=>{const{value,query}=props,{togglePropertyFilter}=(0,index_esm.useActions)(webAnalyticsLogic),{source}=query;if(source.kind!==schema.OH.WebStatsTableQuery)return null;if("string"!=typeof value)return null;const{breakdownBy}=source;let propertyName;switch(breakdownBy){case schema.GI.Page:propertyName="$pathname";break;case schema.GI.InitialPage:propertyName="$initial_pathname";break;case schema.GI.InitialReferringDomain:propertyName="$initial_referrer";break;case schema.GI.InitialUTMSource:propertyName="$initial_utm_source";break;case schema.GI.InitialUTMCampaign:propertyName="$initial_utm_campaign";break;case schema.GI.Browser:propertyName="$browser";break;case schema.GI.OS:propertyName="$os";break;case schema.GI.DeviceType:propertyName="$device_type";break;default:throw new utils.q0(breakdownBy)}const onClick=(0,react.useCallback)((()=>{togglePropertyFilter(propertyName,value)}),[togglePropertyFilter,propertyName,value]);return(0,jsx_runtime.jsx)("a",{onClick,children:value})}},bounce_rate:{title:"Bounce Rate",render:_ref=>{let{value}=_ref;return"number"==typeof value?(0,jsx_runtime.jsx)("div",{className:"w-full text-right",children:(0,jsx_runtime.jsx)("span",{className:"flex-1 text-right",children:`${(100*value).toFixed(1)}%`})}):null}},views:{title:"Views",render:NumericCell},visitors:{title:"Visitors",render:NumericCell}}},WebAnalyticsDashboard=()=>{const{tiles,webAnalyticsFilters}=(0,index_esm.useValues)(webAnalyticsLogic),{setWebAnalyticsFilters}=(0,index_esm.useActions)(webAnalyticsLogic);return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"sticky top-0 bg-white z-20 pt-2",children:[(0,jsx_runtime.jsx)(PropertyFilters.t,{taxonomicGroupTypes:[TaxonomicFilter_types.t.EventProperties],onChange:filters=>setWebAnalyticsFilters(filters.filter(PropertyFilters_utils.B0)),propertyFilters:webAnalyticsFilters,pageKey:"web-analytics"}),(0,jsx_runtime.jsx)("div",{className:"bg-border h-px w-full mt-2"})]}),(0,jsx_runtime.jsx)("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-12 gap-4",children:tiles.map(((tile,i)=>{if("query"in tile){var _layout$colSpan,_layout$rowSpan;const{query,title,layout}=tile;return(0,jsx_runtime.jsxs)("div",{className:`col-span-1 row-span-1 md:col-span-${null!==(_layout$colSpan=layout.colSpan)&&void 0!==_layout$colSpan?_layout$colSpan:6} md:row-span-${null!==(_layout$rowSpan=layout.rowSpan)&&void 0!==_layout$rowSpan?_layout$rowSpan:1} min-h-100 flex flex-col`,children:[title&&(0,jsx_runtime.jsx)("h2",{children:title}),(0,jsx_runtime.jsx)(Query.A,{query,readOnly:!0,context:queryContext})]},i)}if("tabs"in tile){var _layout$colSpan2,_layout$rowSpan2;const{tabs,activeTabId,layout,setTabId}=tile,tab=tabs.find((t=>t.id===activeTabId));if(!tab)return null;const{query,title}=tab;return(0,jsx_runtime.jsxs)("div",{className:`col-span-1 row-span-1 md:col-span-${null!==(_layout$colSpan2=layout.colSpan)&&void 0!==_layout$colSpan2?_layout$colSpan2:6} md:row-span-${null!==(_layout$rowSpan2=layout.rowSpan)&&void 0!==_layout$rowSpan2?_layout$rowSpan2:1} min-h-100 flex flex-col`,children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row items-center",children:[(0,jsx_runtime.jsx)("h2",{className:"flex-1 m-0",children:title}),tabs.length>1&&(0,jsx_runtime.jsx)("div",{className:"space-x-2",children:tabs.map((_ref3=>{let{id,linkText}=_ref3;return(0,jsx_runtime.jsx)("a",{className:id===activeTabId?"text-link":"text-inherit hover:text-link",onClick:()=>setTabId(id),children:linkText},id)}))})]}),(0,jsx_runtime.jsx)(Query.A,{query,readOnly:!0,context:queryContext},activeTabId)]},i)}return null}))})]})};function WebAnalyticsScene(){return(0,jsx_runtime.jsx)(WebAnalyticsDashboard,{})}const scene={component:WebAnalyticsScene,logic:webAnalyticsLogic}}}]);