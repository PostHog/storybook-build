"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[49234],{"../../frontend/src/scenes/session-recordings/file-playback/SessionRecordingFilePlaybackScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{SessionRecordingFilePlaybackScene:()=>SessionRecordingFilePlaybackScene,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),PayGateMini=__webpack_require__("../../frontend/src/lib/components/PayGateMini/PayGateMini.tsx"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),LemonBanner=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonBanner/index.ts"),LemonFileInput=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonFileInput/index.ts"),Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/Spinner.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),types=__webpack_require__("../../frontend/src/types.ts"),SessionRecordingPlayer=__webpack_require__("../../frontend/src/scenes/session-recordings/player/SessionRecordingPlayer.tsx"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),sceneTypes=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),sessionRecordingDataLogic=__webpack_require__("../../frontend/src/scenes/session-recordings/player/sessionRecordingDataLogic.ts"),sessionRecordingEventUsageLogic=__webpack_require__("../../frontend/src/scenes/session-recordings/sessionRecordingEventUsageLogic.ts");let parseExportedSessionRecording=fileData=>{let data=JSON.parse(fileData);if(!data.version||!data.data)throw Error("File does not appear to be a valid session recording export");if("2023-04-28"===data.version)return data;if("2022-12-02"===data.version)return{version:"2023-04-28",data:{id:"",person:data.data.person||void 0,snapshots:Object.entries(data.data.snapshotsByWindowId).flatMap(_ref=>{let[windowId,snapshots]=_ref;return snapshots.map(snapshot=>({...snapshot,windowId}))}).sort((a,b)=>a.timestamp-b.timestamp)}};throw Error("File version is not supported")},waitForDataLogic=async playerKey=>{let retries=0,dataLogic=null;for(;retries<20;){if(null!==(dataLogic=sessionRecordingDataLogic.K.findMounted({sessionRecordingId:"",playerKey:playerKey})))return console.log("found after retries",retries),dataLogic;await new Promise(resolve=>setTimeout(resolve,1)),retries++}throw Error("Timeout reached: dataLogic is still null after 2 seconds")},sessionRecordingFilePlaybackSceneLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","session-recordings","detail","sessionRecordingFilePlaybackSceneLogic"]),(0,index_esm.connect)(()=>({actions:[sessionRecordingEventUsageLogic.G,["reportRecordingLoadedFromFile"]],values:[featureFlagLogic.featureFlagLogic,["featureFlags"]]})),(0,lib.loaders)(_ref2=>{let{actions}=_ref2;return{sessionRecording:{__default:null,loadFromFile:async file=>{try{let loadedFile=await new Promise((resolve,reject)=>{let filereader=new FileReader;filereader.onload=e=>{resolve(e.target?.result)},filereader.onerror=e=>{reject(e)},filereader.readAsText(file)}),data=parseExportedSessionRecording(loadedFile);return actions.reportRecordingLoadedFromFile({success:!0}),data.data}catch(error){return actions.reportRecordingLoadedFromFile({success:!1,error:`${error}`}),src.UJ.error(`File import failed: ${error}`),null}},resetSessionRecording:()=>null}}}),(0,index_esm.reducers)({playerKey:["file-playback",{loadFromFileSuccess:()=>`file-playback-${(0,utils.Vj)()}`,resetSessionRecording:()=>"file-playback"}]}),(0,index_esm.listeners)(_ref3=>{let{values}=_ref3;return{loadFromFileSuccess:async()=>{let dataLogic=await waitForDataLogic(values.playerKey);if(!dataLogic||!values.sessionRecording)return;let snapshots=values.sessionRecording.snapshots;dataLogic.cache.snapshotsBySource={"file-file":{snapshots:snapshots,source:{source:"file"}}},dataLogic.actions.loadSnapshotsForSourceSuccess({source:{source:"file"}}),dataLogic.actions.loadSnapshotSourcesSuccess([{source:"file"}]),dataLogic.actions.loadRecordingMetaSuccess({id:values.sessionRecording.id,viewed:!1,viewers:[],recording_duration:snapshots[snapshots.length-1].timestamp-snapshots[0].timestamp,person:values.sessionRecording.person||void 0,start_time:(0,dayjs.Bv)(snapshots[0].timestamp).toISOString(),end_time:(0,dayjs.Bv)(snapshots[snapshots.length-1].timestamp).toISOString(),snapshot_source:"unknown"})}}}),(0,kea_router_lib.beforeUnload)(_ref4=>{let{values,actions}=_ref4;return{enabled:()=>!!values.sessionRecording,message:"The loaded session recording will be lost. Are you sure you want to leave?",onConfirm:()=>{actions.resetSessionRecording()}}}),(0,index_esm.selectors)({breadcrumbs:[()=>[],()=>[{key:sceneTypes.x.Replay,name:"Replay",path:urls.j.replay()},{key:sceneTypes.x.ReplayFilePlayback,name:"File playback",path:urls.j.replayFilePlayback()}]]})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let scene={component:SessionRecordingFilePlaybackScene,logic:sessionRecordingFilePlaybackSceneLogic};function SessionRecordingFilePlaybackScene(){let{loadFromFile,resetSessionRecording}=(0,index_esm.useActions)(sessionRecordingFilePlaybackSceneLogic),{sessionRecording,sessionRecordingLoading,playerKey}=(0,index_esm.useValues)(sessionRecordingFilePlaybackSceneLogic),{hasAvailableFeature}=(0,index_esm.useValues)(userLogic.userLogic),filePlaybackEnabled=hasAvailableFeature(types.P$.RECORDINGS_FILE_EXPORT),dropRef=(0,react.useRef)(null);return filePlaybackEnabled?(0,jsx_runtime.jsx)("div",{children:sessionRecordingLoading?(0,jsx_runtime.jsx)(Spinner.t,{}):sessionRecording?(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 h-screen pb-4",children:[(0,jsx_runtime.jsx)(LemonBanner.V,{type:"info",action:{onClick:()=>resetSessionRecording(),children:"Load a different recording"},children:"You are viewing a recording loaded from a file."}),(0,jsx_runtime.jsx)(SessionRecordingPlayer.d,{sessionRecordingId:"",playerKey:playerKey})]}):(0,jsx_runtime.jsx)("div",{ref:dropRef,className:"w-full border rounded p-20 text-secondary flex flex-col items-center justify-center",children:(0,jsx_runtime.jsx)(LemonFileInput.m,{accept:"application/json",multiple:!1,onChange:files=>loadFromFile(files[0]),alternativeDropTargetRef:dropRef,callToAction:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col items-center justify-center deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2 font-semibold",children:[(0,jsx_runtime.jsx)(icons.bn,{className:"text-2xl"})," Load recording"]}),(0,jsx_runtime.jsx)("div",{children:"Drag and drop your exported recording here or click to open the file browser."})]})})})}):(0,jsx_runtime.jsx)(PayGateMini.E,{feature:types.P$.RECORDINGS_FILE_EXPORT,className:"py-8",docsLink:"https://posthog.com/docs/user-guides/session-recordings"})}}}]);