"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[18783],{"./frontend/src/scenes/batch_exports/BatchExportEditScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{BatchExportsEditScene:()=>BatchExportsEditScene,scene:()=>scene});var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),BatchExportEditForm=__webpack_require__("./frontend/src/scenes/batch_exports/BatchExportEditForm.tsx"),sceneTypes=__webpack_require__("./frontend/src/scenes/sceneTypes.ts"),urls=__webpack_require__("./frontend/src/scenes/urls.ts"),batchExportLogic=__webpack_require__("./frontend/src/scenes/batch_exports/batchExportLogic.ts");let batchExportsEditSceneLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(key=>["scenes","batch_exports","batchExportsEditSceneLogic",key]),(0,index_esm.connect)(props=>({values:[(0,batchExportLogic.B)(props),["batchExportConfig"]]})),(0,index_esm.selectors)({id:[()=>[(_,props)=>props],props=>props.id],breadcrumbs:[s=>[s.batchExportConfig,s.id],(config,id)=>[{key:sceneTypes.x.BatchExports,name:"Batch Exports",path:urls.j.batchExports()},..."new"===id?[{key:"new",name:"New"}]:[{key:config?.id||"loading",name:config?.name,path:config?.id?urls.j.batchExport(config.id):void 0},{key:"edit",name:"Edit"}]]]})]);var jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let scene={component:BatchExportsEditScene,logic:batchExportsEditSceneLogic,paramsToProps:_ref=>{let{params:{id}}=_ref;return{id:null!=id?id:"new"}}};function BatchExportsEditScene(){let{id}=(0,index_esm.useValues)(batchExportsEditSceneLogic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{}),(0,jsx_runtime.jsx)("div",{className:"my-8"}),(0,jsx_runtime.jsx)(BatchExportEditForm.mf,{id:id})]})}},"./frontend/src/scenes/batch_exports/batchExportLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{B:()=>batchExportLogic,o:()=>BatchExportTab});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/api.ts"),lib_dayjs__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/lib/dayjs.ts"),scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/scenes/sceneTypes.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./frontend/src/scenes/urls.ts");let BatchExportTab=function(BatchExportTab){return BatchExportTab.Runs="runs",BatchExportTab.Logs="logs",BatchExportTab}({}),convert=run=>({...run,data_interval_start:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.data_interval_start),data_interval_end:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.data_interval_end),created_at:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.created_at),last_updated_at:run.last_updated_at?(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.last_updated_at):void 0}),mergeRuns=(oldRuns,newRuns)=>{let runs=[...oldRuns];return newRuns.forEach(rawRun=>{let newRun=convert(rawRun),index=runs.findIndex(run=>run.id===newRun.id);index>-1?runs[index]=newRun:runs.push(newRun)}),runs},batchExportLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.key)(_ref=>{let{id}=_ref;return id}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(key=>["scenes","batch_exports","batchExportLogic",key]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({loadBatchExportRuns:!0,loadNextBatchExportRuns:!0,openBackfillModal:!0,closeBackfillModal:!0,retryRun:run=>({run}),setRunsDateRange:data=>data,setActiveTab:tab=>({tab})}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.reducers)({activeTab:["runs",{setActiveTab:(_,_ref2)=>{let{tab}=_ref2;return tab}}],runsDateRange:[{from:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)().subtract(7,"day").startOf("day"),to:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)().endOf("day")},{setRunsDateRange:(_,_ref3)=>{let{from,to}=_ref3;return{from,to}}}],isBackfillModalOpen:[!1,{openBackfillModal:()=>!0,closeBackfillModal:()=>!1}]}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_3__.loaders)(_ref4=>{let{props,values}=_ref4;return{batchExportConfig:[null,{loadBatchExportConfig:async()=>{let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.get(props.id);return res},pause:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.pause(props.id),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Batch export paused. No future runs will be scheduled"),{...values.batchExportConfig,paused:!0}):null,unpause:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.unpause(props.id),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Batch export unpaused. Future runs will be scheduled"),{...values.batchExportConfig,paused:!1}):null,archive:async()=>(values.batchExportConfig&&(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.delete(props.id),kea_router__WEBPACK_IMPORTED_MODULE_4__.router.actions.replace(scenes_urls__WEBPACK_IMPORTED_MODULE_8__.j.batchExports())),null)}],batchExportRunsResponse:[null,{loadBatchExportRuns:async()=>{var _values$batchExportRu;let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.listRuns(props.id,{after:values.runsDateRange.from,before:values.runsDateRange.to.add(1,"day")});return{...res,results:mergeRuns(null!==(_values$batchExportRu=values.batchExportRunsResponse?.results)&&void 0!==_values$batchExportRu?_values$batchExportRu:[],res.results)}},loadNextBatchExportRuns:async()=>{var _values$batchExportRu2;let nextUrl=values.batchExportRunsResponse?.next;if(!nextUrl)return values.batchExportRunsResponse;let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.get(nextUrl);return{...res,results:mergeRuns(null!==(_values$batchExportRu2=values.batchExportRunsResponse?.results)&&void 0!==_values$batchExportRu2?_values$batchExportRu2:[],res.results)}}}]}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_2__.forms)(_ref5=>{let{props,actions}=_ref5;return{backfillForm:{defaults:{end_at:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)()},errors:_ref6=>{let{start_at,end_at}=_ref6;return{start_at:start_at?void 0:"Start date is required",end_at:end_at?void 0:"End date is required"}},submit:async _ref7=>{var _start_at$toISOString,_end_at$toISOString;let{start_at,end_at}=_ref7;await new Promise(resolve=>setTimeout(resolve,1e3)),await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.createBackfill(props.id,{start_at:null!==(_start_at$toISOString=start_at?.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=end_at?.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null}).catch(e=>{if(e.detail){var _e$attr;actions.setBackfillFormManualErrors({[null!==(_e$attr=e.attr)&&void 0!==_e$attr?_e$attr:"start_at"]:e.detail})}else _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.error("Unknown error occurred");throw e}),actions.closeBackfillModal(),actions.loadBatchExportRuns()}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.selectors)(()=>({groupedRuns:[s=>[s.batchExportRuns],runs=>{let groupedRuns={};return runs.forEach(run=>{let key=`${run.data_interval_start}-${run.data_interval_end}`;groupedRuns[key]||(groupedRuns[key]={data_interval_start:run.data_interval_start,data_interval_end:run.data_interval_end,runs:[],last_run_at:run.created_at}),groupedRuns[key].runs.push(run),groupedRuns[key].runs.sort((a,b)=>b.created_at.diff(a.created_at)),groupedRuns[key].last_run_at=groupedRuns[key].runs[0].created_at}),Object.values(groupedRuns).sort((a,b)=>b.data_interval_end.diff(a.data_interval_end))}],breadcrumbs:[s=>[s.batchExportConfig],config=>[{key:scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__.x.BatchExports,name:"Batch Exports",path:scenes_urls__WEBPACK_IMPORTED_MODULE_8__.j.batchExports()},{key:[scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__.x.BatchExport,config?.id||"loading"],name:config?.name}]],batchExportRuns:[s=>[s.batchExportRunsResponse],batchExportRunsResponse=>{var _batchExportRunsRespo;let runs=null!==(_batchExportRunsRespo=batchExportRunsResponse?.results)&&void 0!==_batchExportRunsRespo?_batchExportRunsRespo:[],deserializedRuns=runs.map(run=>({...run,data_interval_start:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.data_interval_start),data_interval_end:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.data_interval_end),created_at:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.created_at),last_updated_at:run.last_updated_at?(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.last_updated_at):void 0}));return deserializedRuns}],defaultTab:[s=>[s.batchExportConfig],()=>BatchExportTab.Runs]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.listeners)(_ref8=>{let{actions,cache,props}=_ref8;return{setRunsDateRange:()=>{actions.loadBatchExportRuns()},loadBatchExportRunsSuccess:()=>{clearTimeout(cache.refreshTimeout),cache.refreshTimeout=setTimeout(()=>{actions.loadBatchExportRuns()},5e3)},retryRun:async _ref9=>{let{run}=_ref9;await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.createBackfill(props.id,{start_at:run.data_interval_start.toISOString(),end_at:run.data_interval_end.toISOString()}),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Retry has been scheduled."),clearTimeout(cache.refreshTimeout),cache.refreshTimeout=setTimeout(()=>{actions.loadBatchExportRuns()},2e3)}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.beforeUnmount)(_ref10=>{let{cache}=_ref10;clearTimeout(cache.refreshTimeout)})])}}]);