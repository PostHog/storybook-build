"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[19506],{"../../frontend/src/scenes/data-pipelines/batch-exports/BatchExportBackfillModal.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{W:()=>BatchExportBackfillModal});var _posthog_icons__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.22.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),lib_components_NotFound__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),lib_lemon_ui_LemonButton__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),lib_lemon_ui_LemonCalendar_LemonCalendarSelect__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonCalendar/LemonCalendarSelect.tsx"),lib_lemon_ui_LemonCheckbox__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonCheckbox/index.ts"),lib_lemon_ui_LemonField__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),lib_lemon_ui_LemonInput__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonInput/index.ts"),lib_lemon_ui_LemonModal__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonModal/index.ts"),scenes_teamLogic__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),_batchExportBackfillModalLogic__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/batchExportBackfillModalLogic.tsx"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function BatchExportBackfillModal(_ref){let{id}=_ref,{timezone}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(scenes_teamLogic__WEBPACK_IMPORTED_MODULE_11__.teamLogic),logic=(0,_batchExportBackfillModalLogic__WEBPACK_IMPORTED_MODULE_12__.c)({id}),{batchExportConfig,isBackfillModalOpen,isBackfillFormSubmitting,isEarliestBackfill}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(logic),{closeBackfillModal,setEarliestBackfill,unsetEarliestBackfill,setBackfillFormManualErrors}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useActions)(logic);return batchExportConfig?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)(lib_lemon_ui_LemonModal__WEBPACK_IMPORTED_MODULE_10__.f,{title:"Start backfill",onClose:closeBackfillModal,isOpen:isBackfillModalOpen,width:"30rem",footer:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_LemonButton__WEBPACK_IMPORTED_MODULE_5__.J,{type:"secondary","data-attr":"batch-export-backfill-cancel",disabledReason:isBackfillFormSubmitting?"Please wait...":void 0,onClick:closeBackfillModal,children:"Cancel"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_LemonButton__WEBPACK_IMPORTED_MODULE_5__.J,{form:"batch-export-backfill-form",htmlType:"submit",type:"primary","data-attr":"batch-export-backfill-submit",loading:isBackfillFormSubmitting,onClick:()=>setBackfillFormManualErrors({}),children:"Schedule runs"})]}),children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("p",{children:["Backfilling a batch export will sequentially run all batch periods that fall within the range specified below. The runs will export data in ",(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)("b",{children:batchExportConfig?.interval})," intervals, from the start date until the end date is reached."]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)(kea_forms__WEBPACK_IMPORTED_MODULE_3__.Form,{logic:_batchExportBackfillModalLogic__WEBPACK_IMPORTED_MODULE_12__.c,props:{id:id},formKey:"backfillForm",id:"batch-export-backfill-form",enableFormOnSubmit:!0,className:"deprecated-space-y-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_LemonField__WEBPACK_IMPORTED_MODULE_8__.D,{name:"start_at",label:`Start Date (${timezone})`,className:"flex-1",children:_ref2=>{let{value,onChange}=_ref2;return isEarliestBackfill?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_LemonInput__WEBPACK_IMPORTED_MODULE_9__.D,{value:"Beginning of time",disabled:!0}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_LemonCalendar_LemonCalendarSelect__WEBPACK_IMPORTED_MODULE_6__.he,{value:value&&batchExportConfig?"day"===batchExportConfig.interval?value.hour(0).minute(0).second(0):value.tz(timezone):value,onChange:date=>{if(date){let projectDate=date.tz(timezone,!0);batchExportConfig&&"day"===batchExportConfig.interval&&(projectDate=projectDate.hour(0).minute(0).second(0)),onChange(projectDate)}else onChange(date)},placeholder:"Select start date",granularity:batchExportConfig?"hour"===batchExportConfig.interval?"hour":batchExportConfig.interval.endsWith("minutes")?"minute":"day":"day"})}}),batchExportConfig?.model=="persons"||batchExportConfig?.model=="sessions"?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_LemonField__WEBPACK_IMPORTED_MODULE_8__.D,{name:"earliest_backfill",children:_ref3=>{let{onChange}=_ref3;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_LemonCheckbox__WEBPACK_IMPORTED_MODULE_7__.H,{bordered:!0,label:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsxs)("span",{className:"flex gap-2 items-center",children:["Backfill since beginning of time",(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.u,{title:"If selected, we will backfill all data since the beginning of time until the end date set below. There is no need to set a start date for the backfill.",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconInfo,{className:"text-lg text-secondary"})})]}),onChange:checked=>{onChange(checked),checked?setEarliestBackfill():unsetEarliestBackfill()}})}}):null,(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_LemonField__WEBPACK_IMPORTED_MODULE_8__.D,{name:"end_at",label:`End Date (${timezone})`,className:"flex-1",children:_ref4=>{let{value,onChange}=_ref4;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_lemon_ui_LemonCalendar_LemonCalendarSelect__WEBPACK_IMPORTED_MODULE_6__.he,{value:value&&batchExportConfig?"day"===batchExportConfig.interval?value.hour(0).minute(0).second(0):value.tz(timezone):value,onChange:date=>{if(date){let projectDate=date.tz(timezone,!0);batchExportConfig&&"day"===batchExportConfig.interval&&(projectDate=projectDate.hour(0).minute(0).second(0)),onChange(projectDate)}else onChange(date)},placeholder:"Select end date",granularity:batchExportConfig?"hour"===batchExportConfig.interval?"hour":batchExportConfig.interval.endsWith("minutes")?"minute":"day":"day"})}})]})]}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_13__.jsx)(lib_components_NotFound__WEBPACK_IMPORTED_MODULE_4__.T,{object:"batch export"})}},"../../frontend/src/scenes/data-pipelines/batch-exports/BatchExportBackfills.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{F:()=>BatchExportBackfills});var src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),LemonProgress=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonProgress/index.tsx"),pipelineAccessLogic=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineAccessLogic.tsx"),BatchExportBackfillModal=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/BatchExportBackfillModal.tsx"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/index.ts"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),batchExportBackfillModalLogic=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/batchExportBackfillModalLogic.tsx"),batchExportConfigurationLogic=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/batchExportConfigurationLogic.tsx");let batchExportBackfillsLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(key=>["scenes","pipeline","batchExportBackfillsLogic",key]),(0,index_esm.connect)(props=>({values:[(0,teamLogic.teamLogic)(),["currentTeamId"],(0,batchExportConfigurationLogic.D)({id:props.id,service:null}),["batchExportConfig"]],actions:[(0,batchExportBackfillModalLogic.c)(props),["submitBackfillFormSuccess","openBackfillModal"]]})),(0,index_esm.actions)({loadBackfills:!0,cancelBackfill:backfill=>({backfill})}),(0,lib.loaders)(_ref2=>{let{props,values}=_ref2;return{backfillsPaginatedResponse:[null,{loadBackfills:async()=>{try{return await api.ZP.batchExports.listBackfills(props.id,{ordering:"-created_at"})}catch(e){throw LemonToast.U.error("Unknown error occurred when fetching backfills"),e}},loadOlderBackfills:async()=>{let nextUrl=values.backfillsPaginatedResponse?.next;if(!nextUrl)return values.backfillsPaginatedResponse;try{var _values$backfillsPagi;let res=await api.ZP.get(nextUrl);return res.results=[...null!==(_values$backfillsPagi=values.backfillsPaginatedResponse?.results)&&void 0!==_values$backfillsPagi?_values$backfillsPagi:[],...res.results],res}catch(e){throw LemonToast.U.error("Unknown error occurred when fetching backfills"),e}}}]}}),(0,index_esm.selectors)({hasMoreBackfillsToLoad:[s=>[s.backfillsPaginatedResponse],backfillsPaginatedResponse=>!!backfillsPaginatedResponse?.next],loading:[s=>[s.backfillsPaginatedResponseLoading],backfillsPaginatedResponseLoading=>backfillsPaginatedResponseLoading],latestBackfills:[s=>[s.backfillsPaginatedResponse],backfillsPaginatedResponse=>{var _backfillsPaginatedRe;return(null!==(_backfillsPaginatedRe=backfillsPaginatedResponse?.results)&&void 0!==_backfillsPaginatedRe?_backfillsPaginatedRe:[]).map(backfill=>{let parseDateSafely=date=>{if(!date)return;let parsed=(0,dayjs.Bv)(date);return parsed.isValid()?parsed:void 0};return{...backfill,created_at:parseDateSafely(backfill.created_at),finished_at:parseDateSafely(backfill.finished_at),start_at:parseDateSafely(backfill.start_at),end_at:parseDateSafely(backfill.end_at),last_updated_at:parseDateSafely(backfill.last_updated_at)}})}]}),(0,index_esm.listeners)(_ref3=>{let{actions,props}=_ref3;return{cancelBackfill:async _ref4=>{let{backfill}=_ref4;try{await api.ZP.batchExports.cancelBackfill(props.id,backfill.id),LemonToast.U.success("Backfill has been cancelled."),actions.loadBackfills()}catch(error){LemonToast.U.error("Failed to cancel backfill. Please try again.")}},submitBackfillFormSuccess:()=>{setTimeout(()=>{actions.loadBackfills()},1e3)}}}),(0,index_esm.afterMount)(_ref5=>{let{actions}=_ref5;actions.loadBackfills()})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function BatchExportBackfills(_ref){let{id}=_ref,logic=batchExportBackfillsLogic({id}),{openBackfillModal}=(0,index_esm.useActions)(logic),{batchExportConfig}=(0,index_esm.useValues)(logic);return batchExportConfig?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Start backfill"})}),(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)(BatchExportBackfillsControls,{id:id}),(0,jsx_runtime.jsx)(BatchExportLatestBackfills,{id:id})]}),(0,jsx_runtime.jsx)(BatchExportBackfillModal.W,{id:id})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BatchExportBackfillsControls(_ref2){let{id}=_ref2,logic=batchExportBackfillsLogic({id}),{loading}=(0,index_esm.useValues)(logic),{loadBackfills}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsx)("div",{className:"flex gap-2 items-center",children:(0,jsx_runtime.jsx)(src.Jp,{onClick:loadBackfills,loading:loading,type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),size:"small",children:"Refresh"})})}function BatchExportLatestBackfills(_ref3){let{id}=_ref3,logic=batchExportBackfillsLogic({id}),{latestBackfills,loading,hasMoreBackfillsToLoad,batchExportConfig}=(0,index_esm.useValues)(logic),{cancelBackfill,loadOlderBackfills,openBackfillModal}=(0,index_esm.useActions)(logic),{canEnableNewDestinations}=(0,index_esm.useValues)(pipelineAccessLogic.g);return batchExportConfig?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.g3,{dataSource:latestBackfills,loading:loading,loadingSkeletonRows:5,footer:hasMoreBackfillsToLoad&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(src.Jp,{center:!0,fullWidth:!0,onClick:loadOlderBackfills,loading:loading,children:"Load more rows"})}),columns:[{title:"Status",key:"status",width:0,render:(_,backfill)=>{let status=backfill.status,color=colorForStatus(status);return(0,jsx_runtime.jsx)("span",{className:(0,clsx_m.default)("flex justify-center items-center p-2 h-6 text-xs font-semibold rounded-full border-2 select-none",{success:"border-success text-success-dark",accent:"border-accent text-primary-dark",warning:"border-warning text-warning-dark",danger:"border-danger text-danger-dark",default:"border-default text-default-dark"}[color]),children:(0,jsx_runtime.jsx)("span",{className:"text-center",children:status})})}},{title:"Progress",key:"progress",render:(_,backfill)=>{let color=colorForStatus(backfill.status),progress=backfill.progress;if(progress&&null!==progress.progress&&void 0!==progress.progress){let label="";if(null!==progress.finished_runs&&void 0!==progress.finished_runs&&progress.total_runs){let runsLabel=1===progress.total_runs?"run":"runs";label=`(${progress.finished_runs}/${progress.total_runs} ${runsLabel})`}return(0,jsx_runtime.jsxs)("span",{className:"flex gap-2 items-center",children:[(0,jsx_runtime.jsx)(LemonProgress.b,{percent:100*progress.progress,strokeColor:`var(--${color})`,className:"min-w-[80px]"}),(0,jsx_runtime.jsx)("span",{className:"flex-shrink-0 whitespace-nowrap",children:label})]})}return""}},{title:"ID",key:"runId",render:(_,backfill)=>backfill.id},{title:"Interval start",key:"intervalStart",tooltip:"Start of the time range to backfill",render:(_,backfill)=>backfill.start_at?(0,jsx_runtime.jsx)(TZLabel.w,{time:backfill.start_at,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"}):"Beginning of time"},{title:"Interval end",key:"intervalEnd",tooltip:"End of the time range to backfill",render:(_,backfill)=>backfill.end_at?(0,jsx_runtime.jsx)(TZLabel.w,{time:backfill.end_at,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"}):"Until present"},{title:"Started",key:"started",tooltip:"Date and time when this BatchExport backfill started",render:(_,backfill)=>backfill.created_at?(0,jsx_runtime.jsx)(TZLabel.w,{time:backfill.created_at}):""},{title:"Finished",key:"finished",tooltip:"Date and time when this BatchExport backfill finished",render:(_,backfill)=>backfill.finished_at?(0,jsx_runtime.jsx)(TZLabel.w,{time:backfill.finished_at}):""},{key:"actions",width:0,render:function RenderActions(_,backfill){if(canEnableNewDestinations&&backfillIsCancelable(backfill.status))return(0,jsx_runtime.jsx)("div",{className:"flex gap-1",children:(0,jsx_runtime.jsx)(BackfillCancelButton,{backfill:backfill,cancelBackfill:cancelBackfill})})}}],emptyState:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"No backfills in this time range."}),canEnableNewDestinations&&(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Start backfill"})]})})}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BackfillCancelButton(_ref4){let{backfill,cancelBackfill}=_ref4;return(0,jsx_runtime.jsx)("span",{className:"flex gap-1 items-center",children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(icons.uR,{}),tooltip:"Cancel backfill",onClick:()=>src.dn.open({title:"Cancel backfill?",description:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("p",{children:"This will cancel the selected backfill."})}),width:"20rem",primaryButton:{children:"Cancel backfill",onClick:()=>cancelBackfill(backfill)},secondaryButton:{children:"Go back"}})})})}let colorForStatus=status=>{switch(status){case"Completed":return"success";case"ContinuedAsNew":case"Running":case"Starting":return"accent";case"Cancelled":case"Terminated":case"TimedOut":return"warning";case"Failed":case"FailedRetryable":return"danger";default:return"default"}},backfillIsCancelable=status=>"Running"===status||"Starting"===status},"../../frontend/src/scenes/data-pipelines/batch-exports/BatchExportConfiguration.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{J:()=>BatchExportConfiguration});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.22.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),EventSelect=__webpack_require__("../../frontend/src/lib/components/EventSelect/EventSelect.tsx"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),PropertyFilters=__webpack_require__("../../frontend/src/lib/components/PropertyFilters/PropertyFilters.tsx"),types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),LemonBanner=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonBanner/index.ts"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonCollapse=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonCollapse/index.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonInput=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonInput/index.ts"),LemonLabel=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonLabel/index.ts"),Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/index.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),More=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/More.tsx"),LemonTable=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/index.ts"),LemonTag=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTag/LemonTag.tsx"),Link=__webpack_require__("../../frontend/src/lib/lemon-ui/Link/index.ts"),deleteWithUndo=__webpack_require__("../../frontend/src/lib/utils/deleteWithUndo.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),dataWarehouseJoinsLogic=__webpack_require__("../../frontend/src/scenes/data-warehouse/external/dataWarehouseJoinsLogic.ts"),dataWarehouseSceneLogic=__webpack_require__("../../frontend/src/scenes/data-warehouse/settings/dataWarehouseSceneLogic.ts"),viewLinkLogic=__webpack_require__("../../frontend/src/scenes/data-warehouse/viewLinkLogic.tsx"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let nonEditableSchemaTypes=["lazy_table","virtual_table","field_traverser","expression","view","materialized_view"],editSchemaOptions={integer:"Integer",float:"Float",decimal:"Decimal",string:"String",datetime:"DateTime",date:"Date",boolean:"Boolean",array:"Array",json:"JSON",unknown:"Unknown"},editSchemaOptionsAsArray=Object.keys(editSchemaOptions).map(n=>({value:n,label:editSchemaOptions[n]})),isNonEditableSchemaType=schemaType=>"string"==typeof schemaType&&nonEditableSchemaTypes.includes(schemaType),JoinsMoreMenu=_ref=>{let{tableName,fieldName}=_ref,{currentTeamId}=(0,index_esm.useValues)(teamLogic.teamLogic),{toggleEditJoinModal}=(0,index_esm.useActions)(viewLinkLogic.t),{joins,joinsLoading}=(0,index_esm.useValues)(dataWarehouseJoinsLogic.F),{loadJoins}=(0,index_esm.useActions)(dataWarehouseJoinsLogic.F),{loadDatabase}=(0,index_esm.useActions)(dataWarehouseSceneLogic.M),join=joins.find(n=>n.source_table_name===tableName&&n.field_name===fieldName),overlay=(0,react.useCallback)(()=>joinsLoading||!join?(0,jsx_runtime.jsx)(src.$j,{}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,onClick:()=>void toggleEditJoinModal(join),children:"Edit"}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",fullWidth:!0,onClick:()=>{(0,deleteWithUndo.S)({endpoint:`environments/${currentTeamId}/warehouse_view_link`,object:{id:join.id,name:`${join.field_name} on ${join.source_table_name}`},callback:()=>{loadDatabase(),loadJoins()}}).catch(e=>{src.UJ.error(`Failed to delete warehouse view link: ${e.detail}`)})},children:"Delete"})]}),[joinsLoading,join]);return(0,jsx_runtime.jsx)(More.T,{overlay:overlay()})};function DatabaseTable(_ref2){var _tables$find$fields;let{table,tables,inEditSchemaMode,schemaOnChange}=_ref2,dataSource=Object.values(null!==(_tables$find$fields=tables.find(_ref3=>{let{name}=_ref3;return name===table})?.fields)&&void 0!==_tables$find$fields?_tables$find$fields:{}),{dataWarehouseTables,databaseLoading}=(0,index_esm.useValues)(dataWarehouseSceneLogic.M);return(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:dataSource,loading:databaseLoading,disableTableWhileLoading:!1,columns:[{title:"Column",key:"key",dataIndex:"name",render:function RenderColumn(column){return(0,jsx_runtime.jsx)("code",{children:column})}},{title:"Type",key:"type",dataIndex:"type",render:function RenderType(_,_ref4){let{name,type,schema_valid}=_ref4;return inEditSchemaMode&&!isNonEditableSchemaType(type)?(0,jsx_runtime.jsx)(src.Yv,{options:editSchemaOptionsAsArray,value:type,onChange:newValue=>{schemaOnChange&&schemaOnChange(name,newValue)}}):"virtual_table"===type?(0,jsx_runtime.jsx)(LemonTag.o,{type:"default",className:"uppercase",children:"Virtual Table"}):"lazy_table"===type?(0,jsx_runtime.jsx)(LemonTag.o,{type:"default",className:"uppercase",children:"Reference"}):"field_traverser"===type?(0,jsx_runtime.jsx)(LemonTag.o,{type:"default",className:"uppercase",children:"Expression"}):(0,jsx_runtime.jsx)(LemonTag.o,{type:schema_valid?"default":"danger",className:"uppercase",children:type})}},{title:"Info",key:"info",dataIndex:"type",render:function RenderInfo(type,field){if("virtual_table"===type||"view"===type)return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Fields: ",(0,jsx_runtime.jsx)("code",{children:field.fields.join(", ")})]});if("lazy_table"===type)return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["To table: ",(0,jsx_runtime.jsx)("code",{children:String(field.table)})]});if("field_traverser"===type&&Array.isArray(field.chain))return(0,jsx_runtime.jsx)("code",{children:field.chain.join(".")});if("events"==table&&"json"==type&&"properties"==field.name)return(0,jsx_runtime.jsx)(Link.r,{to:urls.j.propertyDefinitions("event"),children:"Manage event properties"});if("persons"==table&&"json"==type&&"properties"==field.name)return(0,jsx_runtime.jsx)(Link.r,{to:urls.j.propertyDefinitions("person"),children:"Manage person properties"});return field.schema_valid||inEditSchemaMode?"":(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("code",{children:field.name})," can't be parsed as a ",(0,jsx_runtime.jsx)("code",{children:field.type}),". It will not be queryable until this is fixed."]})}},{width:0,dataIndex:"type",render:function RenderActions(_,data){if("view"===data.type)return(0,jsx_runtime.jsx)(JoinsMoreMenu,{tableName:table,fieldName:data.name});if("lazy_table"===data.type&&data.table){let isJoiningTableExternalTable=!!dataWarehouseTables.find(n=>n.name===data.table),isSourceExternalTable=!!dataWarehouseTables.find(n=>n.name===table);if(isJoiningTableExternalTable||isSourceExternalTable)return(0,jsx_runtime.jsx)(JoinsMoreMenu,{tableName:table,fieldName:data.name})}return null}}]})}var schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),src_types=__webpack_require__("../../frontend/src/types.ts"),batchExportConfigurationLogic=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/batchExportConfigurationLogic.tsx");function BatchExportGeneralEditFields(_ref){let{isNew,isPipeline=!1,batchExportConfigForm}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[!isPipeline&&(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"Name your workflow for future reference"})}),(0,jsx_runtime.jsx)("div",{className:"flex flex-wrap gap-2 items-start",children:(!isPipeline||batchExportConfigForm.end_at)&&(0,jsx_runtime.jsx)(LemonField.D,{name:"end_at",label:"End date",className:"flex-1",info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The date up to which data is to be exported. Leaving it unset implies that data exports will continue forever until this export is paused or deleted."}),children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.he,{value:value,onChange:onChange,placeholder:"Select end date (optional)",clearable:!0})}})}),isNew&&!isPipeline?(0,jsx_runtime.jsx)(LemonField.D,{name:"paused",children:(0,jsx_runtime.jsx)(src.Hw,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2 items-center",children:["Create in paused state",(0,jsx_runtime.jsx)(src.u,{title:"If selected, the Batch Exporter will be created but will be 'paused' allowing you to resumed it at a later date.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-lg text-secondary"})})]})})}):null]})})}function BatchExportsEditFields(_ref3){let{isNew,batchExportConfigForm}=_ref3;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("div",{className:"mt-4 deprecated-space-y-4 max-w-200",children:"S3"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"bucket_name",label:"Bucket",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. my-bucket"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"region",label:"Region",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"us-east-1",label:"US East (N. Virginia)"},{value:"us-east-2",label:"US East (Ohio)"},{value:"us-west-1",label:"US West (N. California)"},{value:"us-west-2",label:"US West (Oregon)"},{value:"af-south-1",label:"Africa (Cape Town)"},{value:"ap-east-1",label:"Asia Pacific (Hong Kong)"},{value:"ap-south-1",label:"Asia Pacific (Mumbai)"},{value:"ap-northeast-3",label:"Asia Pacific (Osaka-Local)"},{value:"ap-northeast-2",label:"Asia Pacific (Seoul)"},{value:"ap-southeast-1",label:"Asia Pacific (Singapore)"},{value:"ap-southeast-2",label:"Asia Pacific (Sydney)"},{value:"ap-northeast-1",label:"Asia Pacific (Tokyo)"},{value:"ca-central-1",label:"Canada (Central)"},{value:"cn-north-1",label:"China (Beijing)"},{value:"cn-northwest-1",label:"China (Ningxia)"},{value:"eu-central-1",label:"Europe (Frankfurt)"},{value:"eu-west-1",label:"Europe (Ireland)"},{value:"eu-west-2",label:"Europe (London)"},{value:"eu-south-1",label:"Europe (Milan)"},{value:"eu-west-3",label:"Europe (Paris)"},{value:"eu-north-1",label:"Europe (Stockholm)"},{value:"me-east-1",label:"Middle East (Dubai)"},{value:"me-south-1",label:"Middle East (Bahrain)"},{value:"me-central-1",label:"Middle East (Riyadh)"},{value:"sa-east-1",label:"South America (São Paulo)"},{value:"auto",label:"Automatic (AUTO)"},{value:"apac",label:"Asia Pacific (APAC)"},{value:"eeur",label:"Eastern Europe (EEUR)"},{value:"enam",label:"Eastern North America (ENAM)"},{value:"weur",label:"Western Europe (WEUR)"},{value:"wnam",label:"Western North America (WNAM)"}]})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"prefix",label:"Key prefix",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. posthog-events/"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"file_format",label:"Format",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"JSONLines",label:"JSON lines"},{value:"Parquet",label:"Apache Parquet"}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"max_file_size_mb",label:"Max file size (MiB)",showOptional:!0,className:"flex-1",info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Files over this max file size will be split into multiple files. Leave empty or set to 0 for no splitting regardless of file size"}),children:(0,jsx_runtime.jsx)(src.DF,{type:"number",min:0})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"compression",label:"Compression",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"gzip",label:"gzip"},{value:"brotli",label:"brotli"},{value:null,label:"No compression"}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"encryption",label:"Encryption",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"AES256",label:"AES256"},{value:"aws:kms",label:"aws:kms"},{value:null,label:"No encryption"}]})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"aws_access_key_id",label:"AWS Access Key ID",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. AKIAIOSFODNN7EXAMPLE":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"aws_secret_access_key",label:"AWS Secret Access Key",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. secret-key":"Leave unchanged",type:"password"})}),"aws:kms"==batchExportConfigForm.encryption&&(0,jsx_runtime.jsx)(LemonField.D,{name:"kms_key_id",label:"AWS KMS Key ID",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. 1234abcd-12ab-34cd-56ef-1234567890ab":"leave unchanged"})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"endpoint_url",label:"Endpoint URL",showOptional:!0,info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Only required if exporting to an S3-compatible blob storage (like MinIO)"}),children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. https://your-minio-host:9000":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"use_virtual_style_addressing",label:"Virtual style addressing",showOptional:!0,info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:'Some non-AWS S3-compatible destinations may require this setting enabled. Check your destination\'s documentation if "virtual hosted style" is required, otherwise leave unchecked'}),children:(0,jsx_runtime.jsx)(src.Hw,{bordered:!0,label:(0,jsx_runtime.jsx)("span",{className:"flex gap-2 items-center",children:"Use virtual style addressing"})})})]}):"Snowflake"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"account",label:"Account",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-account"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-user":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"authentication_type",label:"Authentication type",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"password",label:"Password"},{value:"keypair",label:"Key pair"}]})}),"keypair"!=batchExportConfigForm.authentication_type&&(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-password":"Leave unchanged",type:"password"})}),"keypair"==batchExportConfigForm.authentication_type&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"private_key",label:"Private key",children:(0,jsx_runtime.jsx)(src._V,{className:"ph-ignore-input",placeholder:isNew?"my-private-key":"Leave unchanged",minRows:4})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"private_key_passphrase",label:"Private key passphrase",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-passphrase":"Leave unchanged"})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"warehouse",label:"Warehouse",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-warehouse"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-schema"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"role",label:"Role",showOptional:!0,children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-role"})})]}):"Postgres"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-user":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-password":"Leave unchanged",type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"host",label:"Host",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-host"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"port",label:"Port",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"5432",type:"number",min:"0",max:"65535"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"public"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"has_self_signed_cert",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsx)(src.Hw,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2 items-center",children:["Does your Postgres instance have a self-signed SSL certificate?",(0,jsx_runtime.jsx)(src.u,{title:"In most cases, Heroku and RDS users should check this.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-lg text-secondary"})})]}),checked:!!value,onChange:onChange})}})]}):"Redshift"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-user":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-password":"Leave unchanged",type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"host",label:"Host",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-host"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"port",label:"Port",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"5439",type:"number",min:"0",max:"65535"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"public"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"properties_data_type",label:"Properties data type",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"varchar",label:"VARCHAR(65535)"},{value:"super",label:"SUPER"}]})})]}):"BigQuery"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"json_config_file",label:"Google Cloud JSON key file",children:(0,jsx_runtime.jsx)(src.mH,{accept:".json",multiple:!1})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_id",label:"Table ID",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"dataset_id",label:"Dataset ID",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"dataset"})}),isNew?(0,jsx_runtime.jsx)(LemonField.D,{name:"use_json_type",label:"Structured fields data type",children:(0,jsx_runtime.jsx)(src.Hw,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2 items-center",children:["Export 'properties', 'set', and 'set_once' fields as BigQuery JSON type",(0,jsx_runtime.jsx)(src.u,{title:"If left unchecked, these fields will be sent as STRING type. This setting cannot be changed after batch export is created.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-lg text-secondary"})})]})})}):null]}):"HTTP"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"url",label:"PostHog region",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"https://us.i.posthog.com/batch/",label:"US"},{value:"https://eu.i.posthog.com/batch/",label:"EU"}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"token",label:"Destination project API Key",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. phc_12345..."})})]}):null})})}var BatchExportIcon=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/BatchExportIcon.tsx"),utils=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/utils.ts");function BatchExportConfiguration(_ref){var _service;let{service,id}=_ref,logicProps={service:(service=(0,utils.l)(null!==(_service=service)&&void 0!==_service?_service:""))||null,id:id||null},logic=(0,batchExportConfigurationLogic.D)(logicProps),{isNew,batchExportConfigTest,batchExportConfigTestLoading,configuration,tables,savedConfiguration,isConfigurationSubmitting,batchExportConfigLoading,configurationChanged,batchExportConfig,selectedModel,runningStep}=(0,index_esm.useValues)(logic),{resetConfiguration,submitConfiguration,setSelectedModel,setConfigurationValue,runBatchExportConfigTestStep}=(0,index_esm.useActions)(logic),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.featureFlagLogic),highFrequencyBatchExports=featureFlags[constants.y8.HIGH_FREQUENCY_BATCH_EXPORTS],sessionsBatchExports=featureFlags[constants.y8.SESSIONS_BATCH_EXPORTS];if(service&&!src_types.e2.includes(service))return(0,jsx_runtime.jsx)(NotFound.T,{object:`batch export service ${service}`});if(!batchExportConfig&&batchExportConfigLoading||!batchExportConfigTest&&batchExportConfigTestLoading)return(0,jsx_runtime.jsx)(Spinner.t,{});let requiredFieldsMissing=["interval"].filter(field=>!configuration[field]),buttons=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",htmlType:"reset",onClick:()=>isNew&&service?resetConfiguration((0,batchExportConfigurationLogic.z)(service)):resetConfiguration(savedConfiguration),disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress…":void 0:"No changes",children:isNew?"Reset":"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress…":void 0:"No changes to save",children:isNew?"Create":"Save"})]});return(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-3",children:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:buttons}),(0,jsx_runtime.jsxs)(lib.Form,{logic:batchExportConfigurationLogic.D,props:logicProps,formKey:"configuration",className:"deprecated-space-y-3",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-4 items-start",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1 min-w-100 deprecated-space-y-3",children:[(0,jsx_runtime.jsxs)("div",{className:"p-3 rounded border bg-surface-primary deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 items-center min-h-16",children:[configuration.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(BatchExportIcon.oe,{size:"medium",type:configuration.destination}),(0,jsx_runtime.jsx)("div",{className:"flex-1 text-sm font-semibold",children:(0,utils.x)(configuration.destination)})]}):(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"paused",info:"Start in a paused state or continuously exporting from now",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.f4,{label:"Enabled",onChange:()=>onChange(!value),checked:!value,bordered:!0})}})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",info:"Customizing the name can be useful if multiple instances of the same type are used.",children:(0,jsx_runtime.jsx)(LemonInput.D,{type:"text"})}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 min-h-16",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"interval",label:"Interval",className:"flex-1",info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Dictates the frequency of batch export runs. For example, if you select hourly, a new batch export run will start every hour."}),children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"hour",label:"Hourly"},{value:"day",label:"Daily"},{value:"every 5 minutes",label:"Every 5 minutes",hidden:!highFrequencyBatchExports}]})})})]}),(0,jsx_runtime.jsxs)("div",{className:"p-3 rounded border bg-surface-primary deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex gap-2 min-h-16",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"model",label:"Model",info:"A model defines the data that will be exported.",className:"flex flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:tables.map(table=>({value:table.name,label:table.id,hidden:!sessionsBatchExports&&"sessions"===table.name})),value:selectedModel,onSelect:newValue=>{setSelectedModel(newValue)},fullWidth:!0})})}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2",children:(0,jsx_runtime.jsx)(LemonCollapse.J,{className:"flex flex-1",panels:[{key:"schema",header:"View model schema",content:(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(DatabaseTable,{table:selectedModel||"events",tables:tables,inEditSchemaMode:!1})})}]})}),"events"===selectedModel?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 min-h-16",children:[(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-between w-full",children:(0,jsx_runtime.jsx)(LemonLabel.H,{children:"Include events"})}),(0,jsx_runtime.jsxs)("p",{className:"mb-0 text-xs text-secondary",children:["If set, the batch export will ",(0,jsx_runtime.jsx)("b",{children:"only"})," export events matching any of the below. If left unset, all events will be exported."]}),(0,jsx_runtime.jsx)(EventSelect._,{onChange:includedEvents=>{setConfigurationValue("include_events",includedEvents.filter(event=>null!=event))},selectedEvents:configuration.include_events?configuration.include_events:[],addElement:(0,jsx_runtime.jsx)(LemonButton.J,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),sideIcon:null,children:"Include event"})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 min-h-16",children:[(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-between w-full",children:(0,jsx_runtime.jsx)(LemonLabel.H,{children:"Exclude events"})}),(0,jsx_runtime.jsxs)("p",{className:"mb-0 text-xs text-secondary",children:["If set, the batch export will ",(0,jsx_runtime.jsx)("b",{children:"exclude"})," events matching any of the below. If left unset, no events will be excluded from the export."]}),(0,jsx_runtime.jsx)(EventSelect._,{onChange:excludedEvents=>{setConfigurationValue("exclude_events",excludedEvents.filter(event=>null!=event))},selectedEvents:configuration.exclude_events?configuration.exclude_events:[],addElement:(0,jsx_runtime.jsx)(LemonButton.J,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),sideIcon:null,children:"Exclude event"})})]}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 min-h-16",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:"Filters",className:"flex flex-1",children:(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:configuration.filters?configuration.filters:[],taxonomicGroupTypes:"events"===selectedModel?[types.t.EventProperties]:[types.t.PersonProperties],onChange:filters=>{setConfigurationValue("filters",filters)},pageKey:`BatchExportsPropertyFilters.${batchExportConfig?batchExportConfig.id:"New"}`,metadataSource:{kind:schema_general.OH.ActorsQuery}})})})]}):null]})]}),(0,jsx_runtime.jsxs)("div",{className:"gap-4 flex-2 deprecated-space-y-4 min-w-100",children:[(0,jsx_runtime.jsx)("div",{className:"p-3 rounded border bg-surface-primary",children:(0,jsx_runtime.jsx)(BatchExportConfigurationFields,{isNew:isNew,formValues:configuration})}),batchExportConfigTest&&(0,jsx_runtime.jsx)("div",{className:"p-3 rounded border bg-surface-primary",children:(0,jsx_runtime.jsx)(BatchExportConfigurationTests,{batchExportConfigTest:batchExportConfigTest,batchExportConfigTestLoading:batchExportConfigTestLoading,runningStep:runningStep,runBatchExportConfigTestStep:runBatchExportConfigTestStep,requiredFieldsMissing:requiredFieldsMissing})})]})]}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-end",children:buttons})]})]})})}function BatchExportConfigurationFields(_ref3){let{isNew,formValues}=_ref3;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(BatchExportGeneralEditFields,{isNew:isNew,isPipeline:!0,batchExportConfigForm:formValues}),(0,jsx_runtime.jsx)(BatchExportsEditFields,{isNew:isNew,batchExportConfigForm:formValues})]})}function BatchExportConfigurationTests(_ref4){let{batchExportConfigTest,batchExportConfigTestLoading,runningStep,runBatchExportConfigTestStep,requiredFieldsMissing}=_ref4;if(!batchExportConfigTest&&batchExportConfigTestLoading)return(0,jsx_runtime.jsx)("div",{className:"flex justify-center items-center p-4",children:(0,jsx_runtime.jsx)(Spinner.$,{})});if(!batchExportConfigTest||!batchExportConfigTest.steps)return null;let renderStatusIcon=(step,index)=>step.result&&runningStep!==index?"Passed"===step.result.status?(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{className:"text-green-500 shrink-0"}):(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{className:"text-red-500 shrink-0"}):(0,jsx_runtime.jsx)(Spinner.$,{}),header=(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsx)("h2",{className:"flex gap-2 items-center m-0 text-lg font-semibold",children:"Test configuration"}),(0,jsx_runtime.jsx)("p",{className:"text-xs text-secondary",children:"Test the batch export's configuration to uncover errors before saving it"})]});return requiredFieldsMissing.length>0?(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[header,(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"info",children:["Please select a value for the following fields before testing the configuration:"," ",requiredFieldsMissing.join(", ")]})]}):(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[header,(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>runBatchExportConfigTestStep(0),disabledReason:null!==runningStep?"Test step is running":null,size:"small",type:"primary",children:runningStep?"Testing...":"Start test"})]}),(0,jsx_runtime.jsx)("div",{className:"space-y-4",children:batchExportConfigTest.steps.map((step,index)=>step.result||index===runningStep?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-start",children:[(0,jsx_runtime.jsx)("div",{className:"mt-1",children:renderStatusIcon(step,index)}),(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[(0,jsx_runtime.jsx)(LemonLabel.H,{info:step.description,className:"mb-2",children:step.name}),step.result&&(0,jsx_runtime.jsx)("div",{className:"mt-2",children:(0,jsx_runtime.jsx)(LemonBanner.V,{type:"Passed"===step.result.status?"success":"error",children:"Passed"===step.result.status?"Success":`${step.result.message}`})})]})]})},`${step.name}-${index}`):null)})]})}},"../../frontend/src/scenes/data-pipelines/batch-exports/BatchExportIcon.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{EL:()=>BATCH_EXPORT_ICON_MAP,oe:()=>RenderBatchExportIcon});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),public_hedgehog_running_hog_png__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/public/hedgehog/running-hog.png"),public_services_aws_s3_png__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/public/services/aws-s3.png"),public_services_bigquery_png__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/public/services/bigquery.png"),public_services_postgres_png__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/public/services/postgres.png"),public_services_redshift_png__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/public/services/redshift.png"),public_services_snowflake_png__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/public/services/snowflake.png"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function getBatchExportUrl(service){return`https://posthog.com/docs/cdp/batch-exports/${service.toLowerCase()}`}let BATCH_EXPORT_ICON_MAP={BigQuery:public_services_bigquery_png__WEBPACK_IMPORTED_MODULE_3__.Z,Postgres:public_services_postgres_png__WEBPACK_IMPORTED_MODULE_4__.Z,Redshift:public_services_redshift_png__WEBPACK_IMPORTED_MODULE_5__.Z,S3:public_services_aws_s3_png__WEBPACK_IMPORTED_MODULE_2__.Z,Snowflake:public_services_snowflake_png__WEBPACK_IMPORTED_MODULE_6__.Z,HTTP:public_hedgehog_running_hog_png__WEBPACK_IMPORTED_MODULE_1__.Z};function RenderBatchExportIcon(_ref){let{type,size="small"}=_ref,icon=BATCH_EXPORT_ICON_MAP[type],sizePx="small"===size?30:60;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:"flex gap-4 items-center",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.u,{title:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.Fragment,{children:[type,(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("br",{}),"Click to view docs"]}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.rU,{to:getBatchExportUrl(type),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("img",{src:icon,alt:type,height:sizePx,width:sizePx})})})})}},"../../frontend/src/scenes/data-pipelines/batch-exports/BatchExportRuns.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{t_:()=>BatchExportRuns});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.22.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),DateFilter=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),pipelineAccessLogic=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineAccessLogic.tsx"),BatchExportBackfillModal=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/BatchExportBackfillModal.tsx"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),batchExportBackfillModalLogic=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/batchExportBackfillModalLogic.tsx"),batchExportConfigurationLogic=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/batchExportConfigurationLogic.tsx");let batchExportRunsLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(key=>["scenes","pipeline","batchExportRunsLogic",key]),(0,index_esm.connect)(props=>({values:[(0,batchExportConfigurationLogic.D)({id:props.id,service:null}),["batchExportConfig"]],actions:[(0,batchExportBackfillModalLogic.c)(props),["submitBackfillFormSuccess","openBackfillModal"]]})),(0,index_esm.actions)({setDateRange:(from,to)=>({from,to}),switchLatestRuns:enabled=>({enabled}),loadRuns:!0,retryRun:run=>({run}),cancelRun:run=>({run})}),(0,lib.loaders)(_ref2=>{let{props,values}=_ref2;return{runsPaginatedResponse:[null,{loadRuns:async()=>values.usingLatestRuns?await api.ZP.batchExports.listRuns(props.id,{}):await api.ZP.batchExports.listRuns(props.id,{start:values.dateRange.from,end:values.dateRange.to,ordering:"-data_interval_start"}),loadOlderRuns:async()=>{var _values$runsPaginated;let nextUrl=values.runsPaginatedResponse?.next;if(!nextUrl)return values.runsPaginatedResponse;let res=await api.ZP.get(nextUrl);return res.results=[...null!==(_values$runsPaginated=values.runsPaginatedResponse?.results)&&void 0!==_values$runsPaginated?_values$runsPaginated:[],...res.results],res}}]}}),(0,index_esm.reducers)({dateRange:[{from:"-2d",to:null},{setDateRange:(_,_ref3)=>{let{from,to}=_ref3;return{from:null!=from?from:"-2d",to:to}}}],usingLatestRuns:[!0,{switchLatestRuns:(_,_ref4)=>{let{enabled}=_ref4;return enabled}}]}),(0,index_esm.selectors)({hasMoreRunsToLoad:[s=>[s.runsPaginatedResponse],runsPaginatedResponse=>!!runsPaginatedResponse?.next],loading:[s=>[s.runsPaginatedResponseLoading],runsPaginatedResponseLoading=>runsPaginatedResponseLoading],latestRuns:[s=>[s.runsPaginatedResponse],runsPaginatedResponse=>{var _runsPaginatedRespons;return(null!==(_runsPaginatedRespons=runsPaginatedResponse?.results)&&void 0!==_runsPaginatedRespons?_runsPaginatedRespons:[]).map(run=>({...run,created_at:(0,dayjs.Bv)(run.created_at),data_interval_start:run.data_interval_start?(0,dayjs.Bv)(run.data_interval_start):void 0,data_interval_end:(0,dayjs.Bv)(run.data_interval_end),last_updated_at:run.last_updated_at?(0,dayjs.Bv)(run.last_updated_at):void 0}))}],groupedRuns:[s=>[s.runsPaginatedResponse,s.usingLatestRuns],(runsPaginatedResponse,usingLatestRuns)=>{var _runsPaginatedRespons2;if(usingLatestRuns)return[];let runs=null!==(_runsPaginatedRespons2=runsPaginatedResponse?.results)&&void 0!==_runsPaginatedRespons2?_runsPaginatedRespons2:[],groupedRuns={};return runs.forEach(run=>{if(!run.data_interval_start)return;let key=`${run.data_interval_start}-${run.data_interval_end}`;groupedRuns[key]||(groupedRuns[key]={data_interval_start:(0,dayjs.Bv)(run.data_interval_start),data_interval_end:(0,dayjs.Bv)(run.data_interval_end),runs:[],last_run_at:(0,dayjs.Bv)(run.created_at)}),groupedRuns[key].runs.push({...run,created_at:(0,dayjs.Bv)(run.created_at),data_interval_start:run.data_interval_start?(0,dayjs.Bv)(run.data_interval_start):void 0,data_interval_end:(0,dayjs.Bv)(run.data_interval_end),last_updated_at:run.last_updated_at?(0,dayjs.Bv)(run.last_updated_at):void 0}),groupedRuns[key].runs.sort((a,b)=>b.created_at.diff(a.created_at)),groupedRuns[key].last_run_at=groupedRuns[key].runs[0].created_at}),Object.values(groupedRuns)}]}),(0,index_esm.listeners)(_ref5=>{let{actions,props}=_ref5;return{setDateRange:()=>{actions.loadRuns()},switchLatestRuns:()=>{actions.loadRuns()},retryRun:async _ref6=>{let{run}=_ref6;await api.ZP.batchExports.retryRun(props.id,run.id),src.UJ.success("Retry has been scheduled.")},cancelRun:async _ref7=>{let{run}=_ref7;await api.ZP.batchExports.cancelRun(props.id,run.id),src.UJ.success("Run has been cancelled.")},submitBackfillFormSuccess:()=>{actions.loadRuns()}}}),(0,index_esm.afterMount)(_ref8=>{let{actions}=_ref8;actions.loadRuns()})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function isRunInProgress(run){return["Running","Starting"].includes(run.status)}function BatchExportRuns(_ref){let{id}=_ref,logic=batchExportRunsLogic({id}),{batchExportConfig,groupedRuns,loading,hasMoreRunsToLoad,usingLatestRuns}=(0,index_esm.useValues)(logic),{loadOlderRuns,retryRun}=(0,index_esm.useActions)(logic);return batchExportConfig?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)(BatchExportRunsFilters,{id:id}),usingLatestRuns?(0,jsx_runtime.jsx)(BatchExportLatestRuns,{id:id}):(0,jsx_runtime.jsx)(BatchExportRunsGrouped,{id:id,groupedRuns:groupedRuns,loading:loading,retryRun:retryRun,hasMoreRunsToLoad:hasMoreRunsToLoad,loadOlderRuns:loadOlderRuns,interval:batchExportConfig.interval})]}),(0,jsx_runtime.jsx)(BatchExportBackfillModal.W,{id:id})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BatchExportRunsFilters(_ref2){let{id}=_ref2,logic=batchExportRunsLogic({id}),{dateRange,usingLatestRuns,loading}=(0,index_esm.useValues)(logic),{setDateRange,switchLatestRuns,loadRuns}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:loadRuns,loading:loading,type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),size:"small",children:"Refresh"}),(0,jsx_runtime.jsx)(src.f4,{bordered:!0,label:"Show latest runs",checked:usingLatestRuns,onChange:switchLatestRuns,size:"small"}),(0,jsx_runtime.jsx)(DateFilter.f,{dateTo:dateRange.to,dateFrom:dateRange.from,disabledReason:usingLatestRuns?'Turn off "Show latest runs" to filter by data interval':void 0,onChange:(from,to)=>setDateRange(from,to),allowedRollingDateOptions:["hours","days","weeks","months","years"],makeLabel:key=>(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalendar,{})," ",key]})})]})}function BatchExportLatestRuns(_ref3){let{id}=_ref3,logic=batchExportRunsLogic({id}),{batchExportConfig,latestRuns,loading,hasMoreRunsToLoad}=(0,index_esm.useValues)(logic),{openBackfillModal,loadOlderRuns,retryRun,cancelRun}=(0,index_esm.useActions)(logic),{canEnableNewDestinations}=(0,index_esm.useValues)(pipelineAccessLogic.g);return batchExportConfig?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.g3,{dataSource:latestRuns,loading:loading,loadingSkeletonRows:5,footer:hasMoreRunsToLoad&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(src.Jp,{center:!0,fullWidth:!0,onClick:loadOlderRuns,loading:loading,children:"Load more rows"})}),columns:[{title:"Status",key:"status",width:0,render:(_,run)=>(0,jsx_runtime.jsx)(BatchExportRunIcon,{runs:[run],showLabel:!0})},{title:"ID",key:"runId",render:(_,run)=>run.id},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(_,run)=>run.data_interval_start?(0,jsx_runtime.jsx)(TZLabel.w,{time:run.data_interval_start,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"}):"Beginning of time"},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:run.data_interval_end,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"})},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,run)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:run.created_at})},{key:"actions",width:0,render:function RenderActions(_,run){if(canEnableNewDestinations)return(0,jsx_runtime.jsxs)("div",{className:"flex gap-1",children:[(0,jsx_runtime.jsx)(RunRetryButton,{run:run,retryRun:retryRun}),(0,jsx_runtime.jsx)(RunCancelButton,{run:run,cancelRun:cancelRun})]})}}],emptyState:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{children:["No runs in this time range. Your exporter runs every ",(0,jsx_runtime.jsx)("b",{children:batchExportConfig.interval}),"."]}),canEnableNewDestinations&&(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Start backfill"})]})})}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BatchExportRunsGrouped(_ref4){let{id,groupedRuns,loading,retryRun,hasMoreRunsToLoad,loadOlderRuns,interval}=_ref4,logic=batchExportRunsLogic({id}),{canEnableNewDestinations}=(0,index_esm.useValues)(pipelineAccessLogic.g),{openBackfillModal}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.g3,{dataSource:groupedRuns,loading:loading,loadingSkeletonRows:5,footer:hasMoreRunsToLoad&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(src.Jp,{center:!0,fullWidth:!0,onClick:loadOlderRuns,loading:loading,children:"Load more rows"})}),expandable:{noIndent:!0,expandedRowRender:groupedRuns=>(0,jsx_runtime.jsx)(src.g3,{dataSource:groupedRuns.runs,embedded:!0,columns:[{title:"Status",key:"status",width:0,render:(_,run)=>(0,jsx_runtime.jsx)(BatchExportRunIcon,{runs:[run],showLabel:!0})},{title:"ID",key:"runId",render:(_,run)=>run.id},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,run)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:run.created_at})}]})},columns:[{key:"icon",width:0,render:(_,groupedRun)=>(0,jsx_runtime.jsx)(BatchExportRunIcon,{runs:groupedRun.runs})},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(_,run)=>run.data_interval_start?(0,jsx_runtime.jsx)(TZLabel.w,{time:run.data_interval_start,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"}):"Beginning of time"},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:run.data_interval_end,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"})},{title:"Latest run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,groupedRun)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:groupedRun.last_run_at})},{key:"actions",width:0,render:function RenderActions(_,groupedRun){if(!isRunInProgress(groupedRun.runs[0])&&canEnableNewDestinations)return(0,jsx_runtime.jsx)(RunRetryButton,{run:groupedRun.runs[0],retryRun:retryRun})}}],emptyState:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{children:["No runs in this time range. Your exporter runs every ",(0,jsx_runtime.jsx)("b",{children:interval}),"."]}),canEnableNewDestinations&&(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Start backfill"})]})})})}function RunRetryButton(_ref5){let{run,retryRun}=_ref5;return(0,jsx_runtime.jsx)("span",{className:"flex gap-1 items-center",children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),onClick:()=>src.dn.open({title:"Retry export?",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"This will schedule a new run for the same interval. Any changes to the configuration will be applied to the new run."}),(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("b",{children:"Please note -"})," there may be a slight delay before the new run appears."]})]}),width:"20rem",primaryButton:{children:"Retry",onClick:()=>retryRun(run)},secondaryButton:{children:"Cancel"}})})})}function RunCancelButton(_ref6){let{run,cancelRun}=_ref6;return(0,jsx_runtime.jsx)("span",{className:"flex gap-1 items-center",children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(icons.uR,{}),disabledReason:"Running"===run.status||"Starting"===run.status?null:`Cannot cancel as run is '${run.status}'`,onClick:()=>src.dn.open({title:"Cancel run?",description:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("p",{children:"This will cancel the selected backfill run."})}),width:"20rem",primaryButton:{children:"Cancel run",onClick:()=>cancelRun(run)},secondaryButton:{children:"Go back"}})})})}function BatchExportRunIcon(_ref7){let{runs,showLabel=!1}=_ref7,status=combineFailedStatuses(runs[0].status),color=colorForStatus(status);return(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Run status: ",status,runs.length>1&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),"Attempts: ",runs.length]})]}),children:(0,jsx_runtime.jsx)("span",{className:(0,clsx_m.default)(`BatchExportRunIcon h-6 p-2 border-2 flex items-center justify-center rounded-full font-semibold text-xs border-${color} text-${color}-dark select-none`,"primary"===color&&"BatchExportRunIcon--pulse",showLabel?"":"w-6"),children:showLabel?(0,jsx_runtime.jsx)("span",{className:"text-center",children:status}):runs.length})})}let combineFailedStatuses=status=>"FailedRetryable"===status?"Failed":status,colorForStatus=status=>{switch(status){case"Completed":return"success";case"ContinuedAsNew":case"Running":case"Starting":return"primary";case"Cancelled":case"Terminated":case"TimedOut":return"warning";case"Failed":case"FailedRetryable":return"danger";default:return"default"}}},"../../frontend/src/scenes/data-pipelines/batch-exports/batchExportBackfillModalLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{c:()=>batchExportBackfillModalLogic});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_dayjs__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/dayjs.ts"),scenes_teamLogic__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),_batchExportConfigurationLogic__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/batchExportConfigurationLogic.tsx");let batchExportBackfillModalLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.key)(_ref=>{let{id}=_ref;return id}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(key=>["scenes","pipeline","batchExportBackfillModalLogic",key]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.connect)(props=>({values:[(0,_batchExportConfigurationLogic__WEBPACK_IMPORTED_MODULE_6__.D)({id:props.id,service:null}),["batchExportConfig"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({openBackfillModal:!0,closeBackfillModal:!0,setEarliestBackfill:!0,unsetEarliestBackfill:!0}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.reducers)({isBackfillModalOpen:[!1,{openBackfillModal:()=>!0,closeBackfillModal:()=>!1}],isEarliestBackfill:[!1,{setEarliestBackfill:()=>!0,unsetEarliestBackfill:()=>!1}]}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_2__.forms)(_ref2=>{let{props,actions,values}=_ref2;return{backfillForm:{defaults:{start_at:void 0,end_at:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_4__.Bv)().tz(scenes_teamLogic__WEBPACK_IMPORTED_MODULE_5__.teamLogic.values.timezone).hour(0).minute(0).second(0).millisecond(0),earliest_backfill:!1},errors:_ref3=>{let{start_at,end_at,earliest_backfill}=_ref3;return{start_at:start_at?void 0:earliest_backfill?void 0:"Start date is required",end_at:end_at?void 0:"End date is required",earliest_backfill:void 0}},submit:async _ref4=>{var _start_at$toISOString,_end_at$toISOString;let{start_at,end_at,earliest_backfill}=_ref4;if(values.batchExportConfig&&values.batchExportConfig.interval.endsWith("minutes")&&(start_at?.minute()!==void 0&&start_at?.minute()%5!=0||end_at?.minute()!==void 0&&end_at?.minute()%5!=0)){_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.UJ.error("Backfilling a 5 minute batch export requires bounds be multiple of five minutes");return}let upperBound=(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_4__.Bv)().tz(scenes_teamLogic__WEBPACK_IMPORTED_MODULE_5__.teamLogic.values.timezone),period="1 hour";if(values.batchExportConfig&&end_at&&("hour"==values.batchExportConfig.interval?upperBound=upperBound.add(1,"hour"):"day"==values.batchExportConfig.interval?(upperBound=(upperBound=upperBound.hour(0).minute(0).second(0)).add(1,"day"),period="1 day"):values.batchExportConfig.interval.endsWith("minutes")?(upperBound=upperBound.add(5,"minute"),period="5 minutes"):upperBound=upperBound.add(1,"hour"),end_at>upperBound)){_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.UJ.error(`Requested backfill end date lies too far into the future. Use an end date that is no more than ${period} from now (in your project's timezone)`);return}await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.batchExports.createBackfill(props.id,{start_at:earliest_backfill?null:null!==(_start_at$toISOString=start_at?.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=end_at?.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null}).catch(e=>{if(e.detail){var _e$attr;actions.setBackfillFormManualErrors({[null!==(_e$attr=e.attr)&&void 0!==_e$attr?_e$attr:"start_at"]:e.detail})}else _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.UJ.error("Unknown error occurred");throw e}),actions.closeBackfillModal()}}}})])},"../../frontend/src/scenes/data-pipelines/batch-exports/batchExportConfigurationLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{D:()=>batchExportConfigurationLogic,z:()=>getDefaultConfiguration});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/api.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/urls.ts"),_pipeline_pipelineAccessLogic__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineAccessLogic.tsx"),_utils__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../frontend/src/scenes/data-pipelines/batch-exports/utils.ts");function getConfigurationFromBatchExportConfig(batchExportConfig){return{name:batchExportConfig.name,destination:batchExportConfig.destination.type,paused:batchExportConfig.paused,interval:batchExportConfig.interval,model:batchExportConfig.model,filters:batchExportConfig.filters,...batchExportConfig.destination.config}}function getDefaultConfiguration(service){return{name:(0,_utils__WEBPACK_IMPORTED_MODULE_8__.x)(service),destination:service,model:"events",paused:!0,..."Snowflake"===service&&{authentication_type:"password"}}}function getEventTable(service){return{type:"batch_export",id:"Events",name:"events",fields:{uuid:{name:"uuid",hogql_value:"toString(uuid)",type:"string",schema_valid:!0},timestamp:{name:"timestamp",hogql_value:"timestamp",type:"datetime",schema_valid:!0},event:{name:"event",hogql_value:"event",type:"string",schema_valid:!0},distinct_id:{name:"distinct_id",hogql_value:"toString(distinct_id)",type:"string",schema_valid:!0},properties:{name:"properties",hogql_value:"properties",type:"json",schema_valid:!0},..."S3"==service&&{person_id:{name:"person_id",hogql_value:"toString(person_id)",type:"string",schema_valid:!0},person_properties:{name:"person_properties",hogql_value:"nullIf(person_properties, '')",type:"string",schema_valid:!0},created_at:{name:"created_at",hogql_value:"created_at",type:"datetime",schema_valid:!0}},..."S3"!=service&&{team_id:{name:"team_id",hogql_value:"Postgres"==service||"Redshift"==service?"toInt32(team_id)":"team_id",type:"integer",schema_valid:!0},set:{name:"Snowflake"==service?"people_set":"set",hogql_value:"nullIf(JSONExtractString(properties, '$set'), '')",type:"string",schema_valid:!0},set_once:{name:"Snowflake"==service?"people_set_once":"set_once",hogql_value:"nullIf(JSONExtractString(properties, '$set_once'), '')",type:"string",schema_valid:!0},site_url:{name:"site_url",hogql_value:"''",type:"string",schema_valid:!0},ip:{name:"ip",hogql_value:"nullIf(JSONExtractString(properties, '$ip'), '')",type:"string",schema_valid:!0},elements_chain:{name:"elements",hogql_value:"toJSONString(elements_chain)",type:"string",schema_valid:!0}},..."BigQuery"==service&&{bq_ingested_timestamp:{name:"bq_ingested_timestamp",hogql_value:"NOW64()",type:"datetime",schema_valid:!0}}}}}let personsTable={type:"batch_export",id:"Persons",name:"persons",fields:{team_id:{name:"team_id",hogql_value:"team_id",type:"integer",schema_valid:!0},distinct_id:{name:"distinct_id",hogql_value:"distinct_id",type:"string",schema_valid:!0},person_id:{name:"person_id",hogql_value:"person_id",type:"string",schema_valid:!0},properties:{name:"properties",hogql_value:"properties",type:"json",schema_valid:!0},person_version:{name:"person_version",hogql_value:"person_version",type:"integer",schema_valid:!0},person_distinct_id_version:{name:"person_distinct_id_version",hogql_value:"person_distinct_id_version",type:"integer",schema_valid:!0},created_at:{name:"created_at",hogql_value:"created_at",type:"datetime",schema_valid:!0},is_deleted:{name:"is_deleted",hogql_value:"is_deleted",type:"boolean",schema_valid:!0}}},sessionsTable={type:"batch_export",id:"Sessions",name:"sessions",fields:{team_id:{name:"team_id",hogql_value:"team_id",type:"integer",schema_valid:!0},session_id:{name:"session_id",type:"string",hogql_value:"session_id",schema_valid:!0},session_id_v7:{name:"session_id_v7",type:"integer",hogql_value:"session_id_v7",schema_valid:!0},distinct_id:{name:"distinct_id",type:"string",hogql_value:"distinct_id",schema_valid:!0},start_timestamp:{name:"start_timestamp",type:"datetime",hogql_value:"start_timestamp",schema_valid:!0},end_timestamp:{name:"end_timestamp",type:"datetime",hogql_value:"end_timestamp",schema_valid:!0},urls:{name:"urls",type:"array",hogql_value:"urls",schema_valid:!0},num_uniq_urls:{name:"num_uniq_urls",type:"integer",hogql_value:"num_uniq_urls",schema_valid:!0},entry_current_url:{name:"entry_current_url",type:"string",hogql_value:"entry_current_url",schema_valid:!0},entry_pathname:{name:"entry_pathname",type:"string",hogql_value:"entry_pathname",schema_valid:!0},entry_hostname:{name:"entry_hostname",type:"string",hogql_value:"entry_hostname",schema_valid:!0},end_current_url:{name:"end_current_url",type:"string",hogql_value:"end_current_url",schema_valid:!0},end_pathname:{name:"end_pathname",type:"string",hogql_value:"end_pathname",schema_valid:!0},end_hostname:{name:"end_hostname",type:"string",hogql_value:"end_hostname",schema_valid:!0},entry_utm_source:{name:"entry_utm_source",type:"string",hogql_value:"entry_utm_source",schema_valid:!0},entry_utm_campaign:{name:"entry_utm_campaign",type:"string",hogql_value:"entry_utm_campaign",schema_valid:!0},entry_utm_medium:{name:"entry_utm_medium",type:"string",hogql_value:"entry_utm_medium",schema_valid:!0},entry_utm_term:{name:"entry_utm_term",type:"string",hogql_value:"entry_utm_term",schema_valid:!0},entry_utm_content:{name:"entry_utm_content",type:"string",hogql_value:"entry_utm_content",schema_valid:!0},entry_referring_domain:{name:"entry_referring_domain",type:"string",hogql_value:"entry_referring_domain",schema_valid:!0},entry_gclid:{name:"entry_gclid",type:"string",hogql_value:"entry_gclid",schema_valid:!0},entry_fbclid:{name:"entry_fbclid",type:"string",hogql_value:"entry_fbclid",schema_valid:!0},entry_gad_source:{name:"entry_gad_source",type:"string",hogql_value:"entry_gad_source",schema_valid:!0},pageview_count:{name:"pageview_count",type:"integer",hogql_value:"pageview_count",schema_valid:!0},autocapture_count:{name:"autocapture_count",type:"integer",hogql_value:"autocapture_count",schema_valid:!0},screen_count:{name:"screen_count",type:"integer",hogql_value:"screen_count",schema_valid:!0},channel_type:{name:"channel_type",type:"string",hogql_value:"channel_type",schema_valid:!0},session_duration:{name:"session_duration",type:"integer",hogql_value:"session_duration",schema_valid:!0},duration:{name:"duration",type:"integer",hogql_value:"duration",schema_valid:!0},is_bounce:{name:"is_bounce",type:"boolean",hogql_value:"is_bounce",schema_valid:!0},last_external_click_url:{name:"last_external_click_url",type:"string",hogql_value:"last_external_click_url",schema_valid:!0},page_screen_autocapture_count_up_to:{name:"page_screen_autocapture_count_up_to",type:"string",hogql_value:"page_screen_autocapture_count_up_to",schema_valid:!0},exit_current_url:{name:"exit_current_url",type:"string",hogql_value:"exit_current_url",schema_valid:!0},exit_pathname:{name:"exit_pathname",type:"string",hogql_value:"exit_pathname",schema_valid:!0},vital_lcp:{name:"vital_lcp",type:"float",hogql_value:"vital_lcp",schema_valid:!0}}},batchExportConfigurationLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.key)(_ref=>{let{service,id}=_ref;return id?`ID:${id}`:`NEW:${service}`}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(id=>["scenes","data-pipelines","batch-exports","batchExportConfigurationLogic",id]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.connect)(()=>({values:[_pipeline_pipelineAccessLogic__WEBPACK_IMPORTED_MODULE_7__.g,["canEnableNewDestinations"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({setSavedConfiguration:configuration=>({configuration}),setSelectedModel:model=>({model}),setRunningStep:step=>({step})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_3__.loaders)(_ref2=>{let{props,actions,values}=_ref2;return{batchExportConfig:[null,{loadBatchExportConfig:async()=>props.id?await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.get(props.id):null,updateBatchExportConfig:async formdata=>{let{name,destination,interval,paused,created_at,start_at,end_at,model,filters,...config}=formdata,data={paused,name,interval,model,filters,destination:{type:destination,config:config}};if(props.id){let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.update(props.id,data);return _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.UJ.success("Batch export configuration updated successfully"),res}let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.create(data);return actions.resetConfiguration(getConfigurationFromBatchExportConfig(res)),kea_router__WEBPACK_IMPORTED_MODULE_4__.router.actions.replace(scenes_urls__WEBPACK_IMPORTED_MODULE_6__.j.batchExport(res.id)),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.UJ.success("Batch export created successfully"),res}}],batchExportConfigTest:[null,{loadBatchExportConfigTest:async()=>{if(props.service)try{return await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.test(props.service)}catch{}return null},updateBatchExportConfigTest:async service=>{if(service)try{return await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.test(service)}catch{}return null}}],batchExportConfigTestStep:[null,{runBatchExportConfigTestStep:async step=>{if(!values.batchExportConfigTest)return null;actions.setRunningStep(step),0===step&&values.batchExportConfigTest.steps.forEach(step=>{step.result=null});let{name,destination,interval,paused,created_at,start_at,end_at,model,filters,...config}=values.configuration,data={paused,name,interval,model,filters,destination:{type:destination,config:config}};return props.id?await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.runTestStep(props.id,step,data):await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.runTestStepNew(step,data)}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.reducers)(_ref3=>{let{props}=_ref3;return{tables:[props.service?[getEventTable(props.service),personsTable,sessionsTable]:[],{loadBatchExportConfigSuccess:(state,_ref4)=>{let{batchExportConfig}=_ref4;return batchExportConfig?[getEventTable(batchExportConfig.destination.type),personsTable,sessionsTable]:state},updateBatchExportConfigSuccess:(state,_ref5)=>{let{batchExportConfig}=_ref5;return batchExportConfig?[getEventTable(batchExportConfig.destination.type),personsTable,sessionsTable]:state}}],selectedModel:["events",{setSelectedModel:(_,_ref6)=>{let{model}=_ref6;return model},loadBatchExportConfigSuccess:(state,_ref7)=>{let{batchExportConfig}=_ref7;return batchExportConfig?batchExportConfig.model:state},updateBatchExportConfigSuccess:(state,_ref8)=>{let{batchExportConfig}=_ref8;return batchExportConfig?batchExportConfig.model:state}}],configuration:[props.service?getDefaultConfiguration(props.service):{},{loadBatchExportConfigSuccess:(state,_ref9)=>{let{batchExportConfig}=_ref9;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state},updateBatchExportConfigSuccess:(state,_ref10)=>{let{batchExportConfig}=_ref10;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state}}],savedConfiguration:[{},{loadBatchExportConfigSuccess:(state,_ref11)=>{let{batchExportConfig}=_ref11;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state},updateBatchExportConfigSuccess:(state,_ref12)=>{let{batchExportConfig}=_ref12;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state}}],runningStep:[null,{setRunningStep:(_,_ref13)=>{let{step}=_ref13;return step}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.selectors)(()=>({service:[(s,p)=>[s.batchExportConfig,p.service],(config,service)=>config?.destination.type||service],isNew:[(_,p)=>[p.id],id=>!id],requiredFields:[s=>[s.service,s.isNew,s.configuration],(service,isNew,config)=>{let generalRequiredFields=["interval","name","model"];if("Postgres"===service||"Redshift"===service)return[...generalRequiredFields,...isNew?["user"]:[],...isNew?["password"]:[],"host","port","database","schema","table_name"];if("S3"===service)return[...generalRequiredFields,"bucket_name","region","prefix",...isNew?["aws_access_key_id"]:[],...isNew?["aws_secret_access_key"]:[],...isNew?["file_format"]:[]];if("BigQuery"===service)return[...generalRequiredFields,...isNew?["json_config_file"]:[],"dataset_id","table_id"];if("HTTP"===service)return[...generalRequiredFields,"url","token"];else if("Snowflake"===service)return[...generalRequiredFields,"account","database","warehouse",...isNew?["user"]:[],...isNew&&"password"==config.authentication_type?["password"]:[],...isNew&&"keypair"==config.authentication_type?["private_key"]:[],"schema","table_name"];return generalRequiredFields}]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.listeners)(_ref14=>{let{values,actions}=_ref14;return{updateBatchExportConfigSuccess:_ref15=>{let{batchExportConfig}=_ref15;batchExportConfig&&actions.resetConfiguration(getConfigurationFromBatchExportConfig(batchExportConfig))},loadBatchExportConfigSuccess:_ref16=>{let{batchExportConfig}=_ref16;batchExportConfig&&actions.updateBatchExportConfigTest(batchExportConfig.destination.type)},runBatchExportConfigTestStepSuccess:_ref17=>{let{batchExportConfigTestStep}=_ref17;if(!values.batchExportConfigTest)return;let step=batchExportConfigTestStep||values.batchExportConfigTestStep;if(!step)return;let index=values.batchExportConfigTest.steps.findIndex(item=>item.name===step.name);index>-1&&(values.batchExportConfigTest.steps[index]=step,step.result&&"Passed"===step.result.status&&index<values.batchExportConfigTest.steps.length-1?actions.runBatchExportConfigTestStep(index+1):actions.setRunningStep(null))},runBatchExportConfigTestStepFailure:()=>{values.batchExportConfigTest&&values.runningStep&&(values.batchExportConfigTest.steps[values.runningStep].result={status:"Failed",message:"The batch export configuration could not be correctly serialized. Required fields may be missing or have invalid values"},actions.setRunningStep(null))},setConfigurationValue:async _ref18=>{let{name,value}=_ref18;if("json_config_file"===name[0]&&value)try{let loadedFile=await new Promise((resolve,reject)=>{let filereader=new FileReader;filereader.onload=e=>resolve(e.target?.result),filereader.onerror=e=>reject(e),filereader.readAsText(value[0])}),jsonConfig=JSON.parse(loadedFile);actions.setConfigurationValues({...values.configuration,project_id:jsonConfig.project_id,private_key:jsonConfig.private_key,private_key_id:jsonConfig.private_key_id,client_email:jsonConfig.client_email,token_uri:jsonConfig.token_uri})}catch(e){actions.setConfigurationManualErrors({json_config_file:"The config file is not valid"})}}}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_2__.forms)(_ref19=>{let{asyncActions,values}=_ref19;return{configuration:{errors:formdata=>Object.fromEntries(values.requiredFields.map(field=>[field,formdata[field]?void 0:"This field is required"])),submit:async formdata=>{await asyncActions.updateBatchExportConfig(formdata)}}}}),(0,kea_router__WEBPACK_IMPORTED_MODULE_4__.beforeUnload)(_ref20=>{let{actions,values}=_ref20;return{enabled:()=>values.configurationChanged,message:"Leave action?\nChanges you made will be discarded.",onConfirm:()=>{values.batchExportConfig?actions.resetConfiguration(getConfigurationFromBatchExportConfig(values.batchExportConfig)):values.service?actions.resetConfiguration(getDefaultConfiguration(values.service)):actions.resetConfiguration()}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.afterMount)(_ref21=>{let{actions}=_ref21;actions.loadBatchExportConfig(),actions.loadBatchExportConfigTest()})])},"../../frontend/src/scenes/data-pipelines/batch-exports/utils.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{l:()=>normalizeBatchExportService,x:()=>humanizeBatchExportName});var _types__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../frontend/src/types.ts");let humanizeBatchExportName=service=>"HTTP"===service?"PostHog HTTP":service,normalizeBatchExportService=service=>{var _BATCH_EXPORT_SERVICE;return null!==(_BATCH_EXPORT_SERVICE=_types__WEBPACK_IMPORTED_MODULE_0__.e2.find(s=>s.toLowerCase()===service.toLowerCase()))&&void 0!==_BATCH_EXPORT_SERVICE?_BATCH_EXPORT_SERVICE:service}}}]);