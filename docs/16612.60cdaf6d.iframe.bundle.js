(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[16612],{"./frontend/src/scenes/batch_exports/batchExportLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{B:()=>batchExportLogic,o:()=>BatchExportTab});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/api.ts"),lib_dayjs__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/lib/dayjs.ts"),scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/scenes/sceneTypes.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./frontend/src/scenes/urls.ts");let BatchExportTab=function(BatchExportTab){return BatchExportTab.Runs="runs",BatchExportTab.Logs="logs",BatchExportTab}({}),convert=run=>({...run,data_interval_start:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.data_interval_start),data_interval_end:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.data_interval_end),created_at:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.created_at),last_updated_at:run.last_updated_at?(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.last_updated_at):void 0}),mergeRuns=(oldRuns,newRuns)=>{let runs=[...oldRuns];return newRuns.forEach(rawRun=>{let newRun=convert(rawRun),index=runs.findIndex(run=>run.id===newRun.id);index>-1?runs[index]=newRun:runs.push(newRun)}),runs},batchExportLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.key)(_ref=>{let{id}=_ref;return id}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(key=>["scenes","batch_exports","batchExportLogic",key]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({loadBatchExportRuns:!0,loadNextBatchExportRuns:!0,openBackfillModal:!0,closeBackfillModal:!0,retryRun:run=>({run}),setRunsDateRange:data=>data,setActiveTab:tab=>({tab})}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.reducers)({activeTab:["runs",{setActiveTab:(_,_ref2)=>{let{tab}=_ref2;return tab}}],runsDateRange:[{from:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)().subtract(7,"day").startOf("day"),to:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)().endOf("day")},{setRunsDateRange:(_,_ref3)=>{let{from,to}=_ref3;return{from,to}}}],isBackfillModalOpen:[!1,{openBackfillModal:()=>!0,closeBackfillModal:()=>!1}]}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_3__.loaders)(_ref4=>{let{props,values}=_ref4;return{batchExportConfig:[null,{loadBatchExportConfig:async()=>{let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.get(props.id);return res},pause:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.pause(props.id),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Batch export paused. No future runs will be scheduled"),{...values.batchExportConfig,paused:!0}):null,unpause:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.unpause(props.id),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Batch export unpaused. Future runs will be scheduled"),{...values.batchExportConfig,paused:!1}):null,archive:async()=>(values.batchExportConfig&&(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.delete(props.id),kea_router__WEBPACK_IMPORTED_MODULE_4__.router.actions.replace(scenes_urls__WEBPACK_IMPORTED_MODULE_8__.j.batchExports())),null)}],batchExportRunsResponse:[null,{loadBatchExportRuns:async()=>{var _values$batchExportRu;let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.listRuns(props.id,{after:values.runsDateRange.from,before:values.runsDateRange.to.add(1,"day")});return res.results=mergeRuns(null!==(_values$batchExportRu=values.batchExportRunsResponse?.results)&&void 0!==_values$batchExportRu?_values$batchExportRu:[],res.results),res},loadNextBatchExportRuns:async()=>{var _values$batchExportRu2;let nextUrl=values.batchExportRunsResponse?.next;if(!nextUrl)return values.batchExportRunsResponse;let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.get(nextUrl);return res.results=mergeRuns(null!==(_values$batchExportRu2=values.batchExportRunsResponse?.results)&&void 0!==_values$batchExportRu2?_values$batchExportRu2:[],res.results),res}}]}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_2__.forms)(_ref5=>{let{props,actions}=_ref5;return{backfillForm:{defaults:{end_at:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)()},errors:_ref6=>{let{start_at,end_at}=_ref6;return{start_at:start_at?void 0:"Start date is required",end_at:end_at?void 0:"End date is required"}},submit:async _ref7=>{var _start_at$toISOString,_end_at$toISOString;let{start_at,end_at}=_ref7;await new Promise(resolve=>setTimeout(resolve,1e3)),await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.createBackfill(props.id,{start_at:null!==(_start_at$toISOString=start_at?.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=end_at?.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null}).catch(e=>{if(e.detail){var _e$attr;actions.setBackfillFormManualErrors({[null!==(_e$attr=e.attr)&&void 0!==_e$attr?_e$attr:"start_at"]:e.detail})}else _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.error("Unknown error occurred");throw e}),actions.closeBackfillModal(),actions.loadBatchExportRuns()}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.selectors)(()=>({groupedRuns:[s=>[s.batchExportRuns],runs=>{let groupedRuns={};return runs.forEach(run=>{let key=`${run.data_interval_start}-${run.data_interval_end}`;groupedRuns[key]||(groupedRuns[key]={data_interval_start:run.data_interval_start,data_interval_end:run.data_interval_end,runs:[],last_run_at:run.created_at}),groupedRuns[key].runs.push(run),groupedRuns[key].runs.sort((a,b)=>b.created_at.diff(a.created_at)),groupedRuns[key].last_run_at=groupedRuns[key].runs[0].created_at}),Object.values(groupedRuns).sort((a,b)=>b.data_interval_end.diff(a.data_interval_end))}],breadcrumbs:[s=>[s.batchExportConfig],config=>[{key:scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__.x.BatchExports,name:"Batch Exports",path:scenes_urls__WEBPACK_IMPORTED_MODULE_8__.j.batchExports()},{key:[scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__.x.BatchExport,config?.id||"loading"],name:config?.name}]],batchExportRuns:[s=>[s.batchExportRunsResponse],batchExportRunsResponse=>{var _batchExportRunsRespo;return null!==(_batchExportRunsRespo=batchExportRunsResponse?.results)&&void 0!==_batchExportRunsRespo?_batchExportRunsRespo:[]}],defaultTab:[s=>[s.batchExportConfig],()=>BatchExportTab.Runs]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.listeners)(_ref8=>{let{actions,cache,props}=_ref8;return{setRunsDateRange:()=>{actions.loadBatchExportRuns()},loadBatchExportRunsSuccess:()=>{clearTimeout(cache.refreshTimeout),cache.refreshTimeout=setTimeout(()=>{actions.loadBatchExportRuns()},5e3)},retryRun:async _ref9=>{let{run}=_ref9;await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.createBackfill(props.id,{start_at:run.data_interval_start.toISOString(),end_at:run.data_interval_end.toISOString()}),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Retry has been scheduled."),clearTimeout(cache.refreshTimeout),cache.refreshTimeout=setTimeout(()=>{actions.loadBatchExportRuns()},2e3)}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.beforeUnmount)(_ref10=>{let{cache}=_ref10;clearTimeout(cache.refreshTimeout)})])},"./frontend/src/scenes/batch_exports/components.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{pP:()=>BatchExportRunIcon,$o:()=>BatchExportTag});var injectStylesIntoStyleTag=__webpack_require__("./node_modules/.pnpm/style-loader@2.0.0_webpack@5.88.2/node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),BatchExports=__webpack_require__("./node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!./node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.4.31_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!./node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!./frontend/src/scenes/batch_exports/BatchExports.scss"),BatchExports_default=__webpack_require__.n(BatchExports),options={};options.insert="head",options.singleton=!1,injectStylesIntoStyleTag_default()(BatchExports_default(),options),BatchExports_default().locals;var src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip/index.ts"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function BatchExportTag(_ref){let{batchExportConfig}=_ref;return(0,jsx_runtime.jsx)(Tooltip.u,{title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:batchExportConfig.paused?"This export is paused - no future export runs will be scheduled ":"This export is active - new runs will be triggered at the configured interval."}),children:(0,jsx_runtime.jsx)(src.LemonTag,{type:batchExportConfig.paused?"default":"primary",children:batchExportConfig.paused?"Paused":"Active"})})}let combineFailedStatuses=status=>"FailedRetryable"===status?"Failed":status,colorForStatus=status=>{switch(status){case"Completed":return"success";case"ContinuedAsNew":case"Running":case"Starting":return"primary";case"Cancelled":case"Terminated":case"TimedOut":return"warning";case"Failed":case"FailedRetryable":return"danger";default:return"default"}};function BatchExportRunIcon(_ref2){let{runs,showLabel=!1}=_ref2,latestRun=runs[0],status=combineFailedStatuses(latestRun.status),color=colorForStatus(status);return(0,jsx_runtime.jsx)(Tooltip.u,{title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Run status: ",status,runs.length>1&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),"Attempts: ",runs.length]})]}),children:(0,jsx_runtime.jsx)("span",{className:(0,clsx_m.default)(`BatchExportRunIcon h-6 p-2 border-2 flex items-center justify-center rounded-full font-semibold text-xs border-${color} text-${color}-dark select-none`,"primary"===color&&"BatchExportRunIcon--pulse",showLabel?"":"w-6"),children:showLabel?(0,jsx_runtime.jsx)("span",{className:"text-center",children:status}):runs.length})})}},"./frontend/src/scenes/batch_exports/utils.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{J0:()=>intervalToFrequency,WT:()=>isRunInProgress,dv:()=>showBatchExports,qY:()=>humanizeDestination});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./frontend/src/types.ts");function intervalToFrequency(interval){return({day:"daily",hour:"hourly","every 5 minutes":"every 5 minutes"})[interval]}function isRunInProgress(run){return["Running","Starting"].includes(run.status)}function humanizeDestination(destination){return"S3"===destination.type?`s3://${destination.config.bucket_name}/${destination.config.prefix}`:"Snowflake"===destination.type?`snowflake:${destination.config.account}:${destination.config.database}:${destination.config.table_name}`:"Postgres"===destination.type?`postgresql://${destination.config.user}:***@${destination.config.host}:${destination.config.port}/${destination.config.database}`:"Redshift"===destination.type?`redshift://${destination.config.user}:***@${destination.config.host}:${destination.config.port}/${destination.config.database}`:"BigQuery"===destination.type?`bigquery:${destination.config.project_id}:${destination.config.dataset_id}:${destination.config.table_id}`:"Unknown"}function showBatchExports(){let{user}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)(scenes_userLogic__WEBPACK_IMPORTED_MODULE_1__.userLogic),{hasAvailableFeature}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)(scenes_userLogic__WEBPACK_IMPORTED_MODULE_1__.userLogic);return hasAvailableFeature(_types__WEBPACK_IMPORTED_MODULE_2__.P$.DATA_PIPELINES)||user?.is_impersonated==!0}},"./frontend/src/scenes/pipeline/BatchExportRuns.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{t_:()=>BatchExportRuns,my:()=>BatchExportRunsGrouped});var src=__webpack_require__("./frontend/@posthog/apps-common/src/index.ts"),posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.7.3_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),lemon_ui_src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),DateFilter=__webpack_require__("./frontend/src/lib/components/DateFilter/DateFilter.tsx"),NotFound=__webpack_require__("./frontend/src/lib/components/NotFound/index.tsx"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts"),components=__webpack_require__("./frontend/src/scenes/batch_exports/components.tsx"),utils=__webpack_require__("./frontend/src/scenes/batch_exports/utils.ts"),lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonCalendarSelect=__webpack_require__("./frontend/src/lib/lemon-ui/LemonCalendar/LemonCalendarSelect.tsx"),LemonField=__webpack_require__("./frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonModal=__webpack_require__("./frontend/src/lib/lemon-ui/LemonModal/index.ts"),kea_loaders_lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),dayjs=__webpack_require__("./frontend/src/lib/dayjs.ts"),teamLogic=__webpack_require__("./frontend/src/scenes/teamLogic.tsx"),pipelineBatchExportConfigurationLogic=__webpack_require__("./frontend/src/scenes/pipeline/pipelineBatchExportConfigurationLogic.tsx");let batchExportRunsLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(key=>["scenes","pipeline","batchExportRunsLogic",key]),(0,index_esm.connect)(props=>({values:[(0,teamLogic.teamLogic)(),["currentTeamId"],(0,pipelineBatchExportConfigurationLogic.t)({id:props.id,service:null}),["batchExportConfig"]]})),(0,index_esm.actions)({setDateRange:(from,to)=>({from,to}),switchLatestRuns:enabled=>({enabled}),loadRuns:!0,retryRun:run=>({run}),openBackfillModal:!0,closeBackfillModal:!0}),(0,kea_loaders_lib.loaders)(_ref2=>{let{props,values}=_ref2;return{runsPaginatedResponse:[null,{loadRuns:async()=>values.usingLatestRuns?await api.ZP.batchExports.listRuns(props.id,{}):await api.ZP.batchExports.listRuns(props.id,{start:values.dateRange.from,end:values.dateRange.to,ordering:"-data_interval_start"}),loadOlderRuns:async()=>{var _values$runsPaginated;let nextUrl=values.runsPaginatedResponse?.next;if(!nextUrl)return values.runsPaginatedResponse;let res=await api.ZP.get(nextUrl);return res.results=[...null!==(_values$runsPaginated=values.runsPaginatedResponse?.results)&&void 0!==_values$runsPaginated?_values$runsPaginated:[],...res.results],res}}]}}),(0,index_esm.reducers)({dateRange:[{from:"-2d",to:null},{setDateRange:(_,_ref3)=>{let{from,to}=_ref3;return{from:null!=from?from:"-2d",to:to}}}],usingLatestRuns:[!0,{switchLatestRuns:(_,_ref4)=>{let{enabled}=_ref4;return enabled}}],isBackfillModalOpen:[!1,{openBackfillModal:()=>!0,closeBackfillModal:()=>!1}]}),(0,lib.forms)(_ref5=>{let{props,actions}=_ref5;return{backfillForm:{defaults:{end_at:(0,dayjs.Bv)()},errors:_ref6=>{let{start_at,end_at}=_ref6;return{start_at:start_at?void 0:"Start date is required",end_at:end_at?void 0:"End date is required"}},submit:async _ref7=>{var _start_at$toISOString,_end_at$toISOString;let{start_at,end_at}=_ref7;await new Promise(resolve=>setTimeout(resolve,1e3)),await api.ZP.batchExports.createBackfill(props.id,{start_at:null!==(_start_at$toISOString=start_at?.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=end_at?.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null}).catch(e=>{if(e.detail){var _e$attr;actions.setBackfillFormManualErrors({[null!==(_e$attr=e.attr)&&void 0!==_e$attr?_e$attr:"start_at"]:e.detail})}else lemon_ui_src.lemonToast.error("Unknown error occurred");throw e}),actions.closeBackfillModal(),actions.loadRuns()}}}}),(0,index_esm.selectors)({hasMoreRunsToLoad:[s=>[s.runsPaginatedResponse],runsPaginatedResponse=>!!runsPaginatedResponse?.next],loading:[s=>[s.runsPaginatedResponseLoading],runsPaginatedResponseLoading=>runsPaginatedResponseLoading],latestRuns:[s=>[s.runsPaginatedResponse],runsPaginatedResponse=>{var _runsPaginatedRespons;return null!==(_runsPaginatedRespons=runsPaginatedResponse?.results)&&void 0!==_runsPaginatedRespons?_runsPaginatedRespons:[]}],groupedRuns:[s=>[s.runsPaginatedResponse,s.usingLatestRuns],(runsPaginatedResponse,usingLatestRuns)=>{var _runsPaginatedRespons2;if(usingLatestRuns)return[];let runs=null!==(_runsPaginatedRespons2=runsPaginatedResponse?.results)&&void 0!==_runsPaginatedRespons2?_runsPaginatedRespons2:[],groupedRuns={};return runs.forEach(run=>{let key=`${run.data_interval_start}-${run.data_interval_end}`;groupedRuns[key]||(groupedRuns[key]={data_interval_start:run.data_interval_start,data_interval_end:run.data_interval_end,runs:[],last_run_at:run.created_at}),groupedRuns[key].runs.push(run),groupedRuns[key].runs.sort((a,b)=>b.created_at.diff(a.created_at)),groupedRuns[key].last_run_at=groupedRuns[key].runs[0].created_at}),Object.values(groupedRuns)}]}),(0,index_esm.listeners)(_ref8=>{let{actions,props}=_ref8;return{setDateRange:()=>{actions.loadRuns()},switchLatestRuns:()=>{actions.loadRuns()},retryRun:async _ref9=>{let{run}=_ref9;await api.ZP.batchExports.createBackfill(props.id,{start_at:run.data_interval_start.toISOString(),end_at:run.data_interval_end.toISOString()}),lemon_ui_src.lemonToast.success("Retry has been scheduled.")}}}),(0,index_esm.afterMount)(_ref10=>{let{actions}=_ref10;actions.loadRuns()})]);var jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function BatchExportBackfill(_ref){let{id}=_ref,logic=batchExportRunsLogic({id}),{batchExportConfig,isBackfillModalOpen,isBackfillFormSubmitting}=(0,index_esm.useValues)(logic),{closeBackfillModal}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)(LemonModal.f,{title:"Backfill batch export",onClose:closeBackfillModal,isOpen:isBackfillModalOpen,width:"30rem",footer:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary","data-attr":"batch-export-backfill-cancel",disabledReason:isBackfillFormSubmitting?"Please wait...":void 0,onClick:closeBackfillModal,children:"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{form:"batch-export-backfill-form",htmlType:"submit",type:"primary","data-attr":"batch-export-backfill-submit",loading:isBackfillFormSubmitting,children:"Schedule runs"})]}),children:[(0,jsx_runtime.jsxs)("p",{children:["Backfilling a batch export will sequentially run all batch periods that fall within the range specified below. The runs will export data in ",(0,jsx_runtime.jsx)("b",{children:batchExportConfig?.interval})," intervals, from the start date until the end date is reached."]}),(0,jsx_runtime.jsxs)(lib.Form,{logic:batchExportRunsLogic,props:{id:id},formKey:"backfillForm",id:"batch-export-backfill-form",enableFormOnSubmit:!0,className:"space-y-2",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"start_at",label:"Start Date",className:"flex-1",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(LemonCalendarSelect.he,{value:value,onChange:onChange,placeholder:"Select start date"})}}),(0,jsx_runtime.jsx)(LemonField.D,{name:"end_at",label:"End date",className:"flex-1",children:_ref3=>{let{value,onChange}=_ref3;return(0,jsx_runtime.jsx)(LemonCalendarSelect.he,{value:value,onChange:onChange,placeholder:"Select end date (optional)"})}})]})]})}var pipelineAccessLogic=__webpack_require__("./frontend/src/scenes/pipeline/pipelineAccessLogic.tsx");function BatchExportRuns(_ref){let{id}=_ref,logic=batchExportRunsLogic({id}),{batchExportConfig,groupedRuns,loading,hasMoreRunsToLoad,usingLatestRuns}=(0,index_esm.useValues)(logic),{loadOlderRuns,retryRun}=(0,index_esm.useActions)(logic);if(!batchExportConfig)return(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"});let dateSelector=(0,jsx_runtime.jsx)(RunsDateSelection,{id:id});return usingLatestRuns?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[dateSelector,(0,jsx_runtime.jsx)(BatchExportLatestRuns,{id:id})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[dateSelector,(0,jsx_runtime.jsx)(BatchExportRunsGrouped,{id:id,groupedRuns:groupedRuns,loading:loading,retryRun:retryRun,hasMoreRunsToLoad:hasMoreRunsToLoad,loadOlderRuns:loadOlderRuns,interval:batchExportConfig.interval})]})}function RunsDateSelection(_ref2){let{id}=_ref2,logic=batchExportRunsLogic({id}),{dateRange,usingLatestRuns,loading}=(0,index_esm.useValues)(logic),{setDateRange,switchLatestRuns,loadRuns}=(0,index_esm.useActions)(logic),latestToggle=(0,jsx_runtime.jsx)(lemon_ui_src.LemonSwitch,{bordered:!0,label:"Show latest runs",checked:usingLatestRuns,onChange:switchLatestRuns}),dateFilter=(0,jsx_runtime.jsx)(DateFilter.f,{dateTo:dateRange.to,dateFrom:dateRange.from,disabledReason:usingLatestRuns?'Turn off "Show latest runs" to filter by data interval':void 0,onChange:(from,to)=>setDateRange(from,to),allowedRollingDateOptions:["hours","days","weeks","months","years"],makeLabel:key=>(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalendar,{})," ",key]})});return(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{onClick:loadRuns,loading:loading,type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),children:"Refresh"}),latestToggle,dateFilter]})}function BatchExportLatestRuns(_ref3){let{id}=_ref3,logic=batchExportRunsLogic({id}),{batchExportConfig,latestRuns,loading,hasMoreRunsToLoad}=(0,index_esm.useValues)(logic),{openBackfillModal,loadOlderRuns,retryRun}=(0,index_esm.useActions)(logic),{canEnableNewDestinations}=(0,index_esm.useValues)(pipelineAccessLogic.g);return batchExportConfig?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(lemon_ui_src.LemonTable,{dataSource:latestRuns,loading:loading,loadingSkeletonRows:5,footer:hasMoreRunsToLoad&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{center:!0,fullWidth:!0,onClick:loadOlderRuns,loading:loading,children:"Load more rows"})}),columns:[{title:"Status",key:"status",width:0,render:(_,run)=>(0,jsx_runtime.jsx)(components.pP,{runs:[run],showLabel:!0})},{title:"ID",key:"runId",render:(_,run)=>run.id},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:run.data_interval_start,formatDate:"MMMM\xa0DD,\xa0YYYY",formatTime:"HH:mm:ss"})},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:run.data_interval_end,formatDate:"MMMM\xa0DD,\xa0YYYY",formatTime:"HH:mm:ss"})},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,run)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:run.created_at})},{key:"actions",width:0,render:function RenderActions(_,run){if(canEnableNewDestinations)return(0,jsx_runtime.jsx)(RunRetryModal,{run:run,retryRun:retryRun})}}],emptyState:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["No runs in this time range. Your exporter runs every ",(0,jsx_runtime.jsx)("b",{children:batchExportConfig.interval}),".",(0,jsx_runtime.jsx)("br",{}),canEnableNewDestinations&&(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{type:"primary",onClick:()=>openBackfillModal(),children:"Backfill batch export"})]})}),(0,jsx_runtime.jsx)(BatchExportBackfill,{id:id})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BatchExportRunsGrouped(_ref4){let{id,groupedRuns,loading,retryRun,hasMoreRunsToLoad,loadOlderRuns,interval}=_ref4,logic=batchExportRunsLogic({id}),{canEnableNewDestinations}=(0,index_esm.useValues)(pipelineAccessLogic.g),{openBackfillModal}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(lemon_ui_src.LemonTable,{dataSource:groupedRuns,loading:loading,loadingSkeletonRows:5,footer:hasMoreRunsToLoad&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{center:!0,fullWidth:!0,onClick:loadOlderRuns,loading:loading,children:"Load more rows"})}),expandable:{noIndent:!0,expandedRowRender:groupedRuns=>(0,jsx_runtime.jsx)(lemon_ui_src.LemonTable,{dataSource:groupedRuns.runs,embedded:!0,columns:[{title:"Status",key:"status",width:0,render:(_,run)=>(0,jsx_runtime.jsx)(components.pP,{runs:[run],showLabel:!0})},{title:"ID",key:"runId",render:(_,run)=>run.id},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,run)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:run.created_at})}]})},columns:[{key:"icon",width:0,render:(_,groupedRun)=>(0,jsx_runtime.jsx)(components.pP,{runs:groupedRun.runs})},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:run.data_interval_start,formatDate:"MMMM\xa0DD,\xa0YYYY",formatTime:"HH:mm:ss"})},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:run.data_interval_end,formatDate:"MMMM\xa0DD,\xa0YYYY",formatTime:"HH:mm:ss"})},{title:"Latest run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,groupedRun)=>(0,jsx_runtime.jsx)(src.TZLabel,{time:groupedRun.last_run_at})},{key:"actions",width:0,render:function RenderActions(_,groupedRun){if(!(0,utils.WT)(groupedRun.runs[0])&&canEnableNewDestinations)return(0,jsx_runtime.jsx)(RunRetryModal,{run:groupedRun.runs[0],retryRun:retryRun})}}],emptyState:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["No runs in this time range. Your exporter runs every ",(0,jsx_runtime.jsx)("b",{children:interval}),".",(0,jsx_runtime.jsx)("br",{}),canEnableNewDestinations&&(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{type:"primary",onClick:()=>openBackfillModal(),children:"Backfill batch export"})]})}),(0,jsx_runtime.jsx)(BatchExportBackfill,{id:id})]})}function RunRetryModal(_ref5){let{run,retryRun}=_ref5;return(0,jsx_runtime.jsx)("span",{className:"flex items-center gap-1",children:(0,jsx_runtime.jsx)(lemon_ui_src.LemonButton,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),onClick:()=>lemon_ui_src.LemonDialog.open({title:"Retry export?",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"This will schedule a new run for the same interval. Any changes to the configuration will be applied to the new run."}),(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("b",{children:"Please note -"})," there may be a slight delay before the new run appears."]})]}),width:"20rem",primaryButton:{children:"Retry",onClick:()=>retryRun(run)},secondaryButton:{children:"Cancel"}})})})}},"./frontend/src/scenes/pipeline/destinationsLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{w:()=>pipelineDestinationsLogic});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./frontend/src/lib/api.ts"),lib_utils_deleteWithUndo__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./frontend/src/lib/utils/deleteWithUndo.tsx"),scenes_teamLogic__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/scenes/teamLogic.tsx"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/types.ts"),_pipelineAccessLogic__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./frontend/src/scenes/pipeline/pipelineAccessLogic.tsx"),_types__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./frontend/src/scenes/pipeline/types.ts"),_utils__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("./frontend/src/scenes/pipeline/utils.tsx");let pipelineDestinationsLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(["scenes","pipeline","destinationsLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.connect)({values:[scenes_teamLogic__WEBPACK_IMPORTED_MODULE_5__.teamLogic,["currentTeamId"],scenes_userLogic__WEBPACK_IMPORTED_MODULE_6__.userLogic,["user","hasAvailableFeature"],_pipelineAccessLogic__WEBPACK_IMPORTED_MODULE_8__.g,["canEnableNewDestinations"]]}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({toggleNode:(destination,enabled)=>({destination,enabled}),toggleNodeHogFunction:(destination,enabled)=>({destination,enabled}),deleteNode:destination=>({destination}),deleteNodeBatchExport:destination=>({destination}),deleteNodeHogFunction:destination=>({destination}),deleteNodeWebhook:destination=>({destination}),updatePluginConfig:pluginConfig=>({pluginConfig}),updateBatchExportConfig:batchExportConfig=>({batchExportConfig})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_2__.loaders)(_ref=>{let{values,actions}=_ref;return{plugins:[{},{loadPlugins:async()=>(0,_utils__WEBPACK_IMPORTED_MODULE_10__.c$)("api/organizations/@current/pipeline_destinations")}],pluginConfigs:[{},{loadPluginConfigs:async()=>{let pluginConfigs={},results=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.loadPaginatedResults(`api/projects/${values.currentTeamId}/pipeline_destination_configs`);for(let pluginConfig of results)pluginConfigs[pluginConfig.id]={...pluginConfig,name:pluginConfig.name||values.plugins[pluginConfig.plugin]?.name||"Unknown app",description:pluginConfig.description||values.plugins[pluginConfig.plugin]?.description};return pluginConfigs},toggleNodeWebhook:async _ref2=>{let{destination,enabled}=_ref2,{pluginConfigs,plugins}=values,pluginConfig=pluginConfigs[destination.id],plugin=plugins[pluginConfig.plugin];(0,_utils__WEBPACK_IMPORTED_MODULE_10__.SO)(`plugin ${enabled?"enabled":"disabled"}`,plugin,pluginConfig);let response=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.update(`api/plugin_config/${destination.id}`,{enabled});return{...pluginConfigs,[destination.id]:response}},updatePluginConfig:_ref3=>{let{pluginConfig}=_ref3;return{...values.pluginConfigs,[pluginConfig.id]:pluginConfig}},deleteNodeWebhook:async _ref4=>{let{destination}=_ref4;await (0,lib_utils_deleteWithUndo__WEBPACK_IMPORTED_MODULE_4__.S)({endpoint:`projects/${scenes_teamLogic__WEBPACK_IMPORTED_MODULE_5__.teamLogic.values.currentTeamId}/plugin_configs`,object:{id:destination.id,name:destination.name},callback:undo=>{undo&&actions.loadPluginConfigs()}});let pluginConfigs={...values.pluginConfigs};return delete pluginConfigs[destination.id],pluginConfigs}}],batchExportConfigs:[{},{loadBatchExports:async()=>{let results=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.loadPaginatedResults(`api/projects/${values.currentTeamId}/batch_exports`);return Object.fromEntries(results.map(batchExport=>[batchExport.id,batchExport]))},toggleNodeBatchExport:async _ref5=>{let{destination,enabled}=_ref5,batchExport=values.batchExportConfigs[destination.id];return enabled?await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.batchExports.unpause(destination.id):await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.batchExports.pause(destination.id),(0,_utils__WEBPACK_IMPORTED_MODULE_10__.hO)(`batch export ${enabled?"enabled":"disabled"}`,batchExport),{...values.batchExportConfigs,[destination.id]:{...batchExport,paused:!enabled}}},deleteNodeBatchExport:async _ref6=>{let{destination}=_ref6;await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.batchExports.delete(destination.id);let batchExportConfigs={...values.batchExportConfigs};return delete batchExportConfigs[destination.id],batchExportConfigs},updateBatchExportConfig:_ref7=>{let{batchExportConfig}=_ref7;return{...values.batchExportConfigs,[batchExportConfig.id]:batchExportConfig}}}],hogFunctionTemplates:[{},{loadHogFunctionTemplates:async()=>{let templates=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.hogFunctions.listTemplates();return templates.results.reduce((acc,template)=>(acc[template.id]=template,acc),{})}}],hogFunctions:[[],{loadHogFunctions:async()=>(await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.hogFunctions.list()).results,deleteNodeHogFunction:async _ref8=>{let{destination}=_ref8;return destination.backend!==_types__WEBPACK_IMPORTED_MODULE_9__.b.HogFunction?values.hogFunctions:(await (0,lib_utils_deleteWithUndo__WEBPACK_IMPORTED_MODULE_4__.S)({endpoint:`projects/${scenes_teamLogic__WEBPACK_IMPORTED_MODULE_5__.teamLogic.values.currentTeamId}/hog_functions`,object:{id:destination.hog_function.id,name:destination.name},callback:undo=>{undo&&actions.loadHogFunctions()}}),values.hogFunctions.filter(hogFunction=>hogFunction.id!==destination.hog_function.id))},toggleNodeHogFunction:async _ref9=>{let{destination,enabled}=_ref9,{hogFunctions}=values,hogFunctionIndex=hogFunctions.findIndex(hf=>hf.id===destination.hog_function.id),response=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.hogFunctions.update(destination.hog_function.id,{enabled});return[...hogFunctions.slice(0,hogFunctionIndex),response,...hogFunctions.slice(hogFunctionIndex+1)]}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.selectors)({loading:[s=>[s.pluginsLoading,s.pluginConfigsLoading,s.batchExportConfigsLoading,s.hogFunctionTemplatesLoading,s.hogFunctionsLoading],(pluginsLoading,pluginConfigsLoading,batchExportConfigsLoading,hogFunctionTemplatesLoading,hogFunctionsLoading)=>pluginsLoading||pluginConfigsLoading||batchExportConfigsLoading||hogFunctionTemplatesLoading||hogFunctionsLoading],destinations:[s=>[s.pluginConfigs,s.plugins,s.batchExportConfigs,s.hogFunctions,s.user],(pluginConfigs,plugins,batchExportConfigs,hogFunctions,user)=>{let rawBatchExports=Object.values(batchExportConfigs).filter(config=>"HTTP"!==config.destination.type||user?.is_impersonated),rawDestinations=[].concat(hogFunctions).concat(Object.values(pluginConfigs).map(pluginConfig=>({...pluginConfig,plugin_info:plugins[pluginConfig.plugin]||null}))).concat(rawBatchExports),convertedDestinations=rawDestinations.map(d=>(0,_types__WEBPACK_IMPORTED_MODULE_9__.n)(d,_types__WEBPACK_IMPORTED_MODULE_7__.We.Destination)),enabledFirst=convertedDestinations.sort((a,b)=>Number(b.enabled)-Number(a.enabled));return enabledFirst}]}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.listeners)(_ref10=>{let{values,actions}=_ref10;return{toggleNode:_ref11=>{let{destination,enabled}=_ref11;if(enabled&&!values.canEnableNewDestinations){_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.error("Data pipelines add-on is required for enabling new destinations.");return}destination.backend===_types__WEBPACK_IMPORTED_MODULE_9__.b.Plugin?actions.toggleNodeWebhook({destination:destination,enabled:enabled}):destination.backend===_types__WEBPACK_IMPORTED_MODULE_9__.b.BatchExport?actions.toggleNodeBatchExport({destination:destination,enabled:enabled}):destination.backend===_types__WEBPACK_IMPORTED_MODULE_9__.b.HogFunction&&actions.toggleNodeHogFunction(destination,enabled)},deleteNode:_ref12=>{let{destination}=_ref12;switch(destination.backend){case _types__WEBPACK_IMPORTED_MODULE_9__.b.Plugin:actions.deleteNodeWebhook(destination);break;case _types__WEBPACK_IMPORTED_MODULE_9__.b.BatchExport:actions.deleteNodeBatchExport(destination);break;case _types__WEBPACK_IMPORTED_MODULE_9__.b.HogFunction:actions.deleteNodeHogFunction(destination)}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.afterMount)(_ref13=>{let{actions}=_ref13;actions.loadPlugins(),actions.loadPluginConfigs(),actions.loadBatchExports(),actions.loadHogFunctionTemplates(),actions.loadHogFunctions()})])},"./frontend/src/scenes/pipeline/pipelineBatchExportConfigurationLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{t:()=>pipelineBatchExportConfigurationLogic});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/api.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/scenes/urls.ts"),_types__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/types.ts"),_destinationsLogic__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./frontend/src/scenes/pipeline/destinationsLogic.tsx"),_pipelineAccessLogic__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./frontend/src/scenes/pipeline/pipelineAccessLogic.tsx");function getConfigurationFromBatchExportConfig(batchExportConfig){return{name:batchExportConfig.name,destination:batchExportConfig.destination.type,paused:batchExportConfig.paused,interval:batchExportConfig.interval,model:batchExportConfig.model,...batchExportConfig.destination.config}}function getDefaultConfiguration(service){return{name:service,destination:service,model:"events",paused:!0}}function getEventTable(service){let eventsTable={type:"batch_export",id:"Events",name:"events",fields:{uuid:{name:"uuid",hogql_value:"toString(uuid)",type:"string",schema_valid:!0},timestamp:{name:"timestamp",hogql_value:"timestamp",type:"datetime",schema_valid:!0},event:{name:"event",hogql_value:"event",type:"string",schema_valid:!0},distinct_id:{name:"distinct_id",hogql_value:"toString(distinct_id)",type:"string",schema_valid:!0},properties:{name:"properties",hogql_value:"properties",type:"json",schema_valid:!0},..."S3"==service&&{person_id:{name:"person_id",hogql_value:"toString(person_id)",type:"string",schema_valid:!0},person_properties:{name:"person_properties",hogql_value:"nullIf(person_properties, '')",type:"string",schema_valid:!0},created_at:{name:"created_at",hogql_value:"created_at",type:"datetime",schema_valid:!0}},..."S3"!=service&&{team_id:{name:"team_id",hogql_value:"Postgres"==service||"Redshift"==service?"toInt32(team_id)":"team_id",type:"integer",schema_valid:!0},set:{name:"Snowflake"==service?"people_set":"set",hogql_value:"nullIf(JSONExtractString(properties, '$set'), '')",type:"string",schema_valid:!0},set_once:{name:"Snowflake"==service?"people_set_once":"set_once",hogql_value:"nullIf(JSONExtractString(properties, '$set_once'), '')",type:"string",schema_valid:!0},site_url:{name:"site_url",hogql_value:"''",type:"string",schema_valid:!0},ip:{name:"ip",hogql_value:"nullIf(JSONExtractString(properties, '$ip'), '')",type:"string",schema_valid:!0},elements_chain:{name:"elements",hogql_value:"toJSONString(elements_chain)",type:"string",schema_valid:!0}},..."BigQuery"==service&&{bq_ingested_timestamp:{name:"bq_ingested_timestamp",hogql_value:"NOW64()",type:"datetime",schema_valid:!0}}}};return eventsTable}let personsTable={type:"batch_export",id:"Persons",name:"persons",fields:{team_id:{name:"team_id",hogql_value:"team_id",type:"integer",schema_valid:!0},distinct_id:{name:"distinct_id",hogql_value:"distinct_id",type:"string",schema_valid:!0},person_id:{name:"person_id",hogql_value:"person_id",type:"string",schema_valid:!0},properties:{name:"properties",hogql_value:"properties",type:"json",schema_valid:!0},person_version:{name:"person_version",hogql_value:"person_version",type:"integer",schema_valid:!0},person_distinct_id_version:{name:"person_distinct_id_version",hogql_value:"person_distinct_id_version",type:"integer",schema_valid:!0}}},pipelineBatchExportConfigurationLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.key)(_ref=>{let{service,id}=_ref;return id?`ID:${id}`:`NEW:${service}`}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(id=>["scenes","pipeline","pipelineBatchExportConfigurationLogic",id]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.connect)(()=>({values:[_pipelineAccessLogic__WEBPACK_IMPORTED_MODULE_9__.g,["canEnableNewDestinations"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({setSavedConfiguration:configuration=>({configuration}),setSelectedModel:model=>({model})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_3__.loaders)(_ref2=>{let{props,values}=_ref2;return{batchExportConfig:[null,{loadBatchExportConfig:async()=>props.id?await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.get(props.id):null,updateBatchExportConfig:async formdata=>{if((!values.batchExportConfig||values.batchExportConfig.paused&&!0!==formdata.paused)&&!values.canEnableNewDestinations)return _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.error("Data pipelines add-on is required for enabling new destinations."),null;let{name,destination,interval,paused,created_at,start_at,end_at,model,...config}=formdata,data={paused,name,interval,model,destination:{type:destination,config:config}};if(props.id){let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.update(props.id,data);return res}let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.create(data);return kea_router__WEBPACK_IMPORTED_MODULE_4__.router.actions.replace(scenes_urls__WEBPACK_IMPORTED_MODULE_6__.j.pipelineNode(_types__WEBPACK_IMPORTED_MODULE_7__.We.Destination,res.id,_types__WEBPACK_IMPORTED_MODULE_7__.il.Configuration)),res}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.reducers)(_ref3=>{let{props}=_ref3;return{tables:[props.service?[getEventTable(props.service),personsTable]:[],{loadBatchExportConfigSuccess:(state,_ref4)=>{let{batchExportConfig}=_ref4;return batchExportConfig?[getEventTable(batchExportConfig.destination.type),personsTable]:state},updateBatchExportConfigSuccess:(state,_ref5)=>{let{batchExportConfig}=_ref5;return batchExportConfig?[getEventTable(batchExportConfig.destination.type),personsTable]:state}}],selectedModel:["events",{setSelectedModel:(_,_ref6)=>{let{model}=_ref6;return model},loadBatchExportConfigSuccess:(state,_ref7)=>{let{batchExportConfig}=_ref7;return batchExportConfig?batchExportConfig.model:state},updateBatchExportConfigSuccess:(state,_ref8)=>{let{batchExportConfig}=_ref8;return batchExportConfig?batchExportConfig.model:state}}],configuration:[props.service?getDefaultConfiguration(props.service):{},{loadBatchExportConfigSuccess:(state,_ref9)=>{let{batchExportConfig}=_ref9;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state},updateBatchExportConfigSuccess:(state,_ref10)=>{let{batchExportConfig}=_ref10;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.selectors)(()=>({service:[(s,p)=>[s.batchExportConfig,p.service],(config,service)=>config?.destination.type||service],savedConfiguration:[(s,p)=>[s.batchExportConfig,p.service],(batchExportConfig,service)=>batchExportConfig&&service?batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):service?getDefaultConfiguration(service):{}:{}],isNew:[(_,p)=>[p.id],id=>!id],requiredFields:[s=>[s.service],service=>{let generalRequiredFields=["interval","name","model"];return"Postgres"===service||"Redshift"===service?[...generalRequiredFields,"user","password","host","port","database","schema","table_name"]:"S3"===service?[...generalRequiredFields,"bucket_name","region","prefix","aws_access_key_id","aws_secret_access_key","file_format"]:"BigQuery"===service?[...generalRequiredFields,"json_config_file","dataset_id","table_id"]:"HTTP"===service?[...generalRequiredFields,"url","token"]:"Snowflake"===service?[...generalRequiredFields,"account","database","warehouse","user","password","schema","table_name"]:generalRequiredFields}]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.listeners)(_ref11=>{let{values,actions}=_ref11;return{updateBatchExportConfigSuccess:_ref12=>{let{batchExportConfig}=_ref12;batchExportConfig&&_destinationsLogic__WEBPACK_IMPORTED_MODULE_8__.w.findMounted()?.actions.updateBatchExportConfig(batchExportConfig)},setConfigurationValue:async _ref13=>{let{name,value}=_ref13;if("json_config_file"===name[0]&&value)try{let loadedFile=await new Promise((resolve,reject)=>{let filereader=new FileReader;filereader.onload=e=>resolve(e.target?.result),filereader.onerror=e=>reject(e),filereader.readAsText(value[0])}),jsonConfig=JSON.parse(loadedFile);actions.setConfigurationValues({...values.configuration,project_id:jsonConfig.project_id,private_key:jsonConfig.private_key,private_key_id:jsonConfig.private_key_id,client_email:jsonConfig.client_email,token_uri:jsonConfig.token_uri})}catch(e){actions.setConfigurationManualErrors({json_config_file:"The config file is not valid"})}}}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_2__.forms)(_ref14=>{let{asyncActions,values}=_ref14;return{configuration:{errors:formdata=>Object.fromEntries(values.requiredFields.map(field=>[field,formdata[field]?void 0:"This field is required"])),submit:async formdata=>{await asyncActions.updateBatchExportConfig(formdata)}}}}),(0,kea_router__WEBPACK_IMPORTED_MODULE_4__.beforeUnload)(_ref15=>{let{actions,values}=_ref15;return{enabled:()=>values.configurationChanged,message:"Leave action?\nChanges you made will be discarded.",onConfirm:()=>{actions.resetConfiguration()}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.afterMount)(_ref16=>{let{actions}=_ref16;actions.loadBatchExportConfig()})])},"./node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!./node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.4.31_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!./node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!./frontend/src/scenes/batch_exports/BatchExports.scss":(module,exports,__webpack_require__)=>{(exports=__webpack_require__("./node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/runtime/api.js")(!1)).push([module.id,".BatchExportRunIcon--pulse{animation:BatchExportRunIcon__pulse 2s ease-out infinite;outline:2px solid transparent;outline-offset:0}@keyframes BatchExportRunIcon__pulse{0%{outline-color:var(--primary-3000-hover);outline-offset:0}80%{outline-color:transparent;outline-offset:20px}to{outline-color:transparent;outline-offset:20px}}",""]),module.exports=exports}}]);