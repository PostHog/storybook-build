"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[8479],{"../../frontend/src/scenes/cohorts/CohortCalculationHistory.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{CohortCalculationHistory:()=>CohortCalculationHistory,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.34.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),SceneContent=__webpack_require__("../../frontend/src/layout/scenes/components/SceneContent.tsx"),SceneTitleSection=__webpack_require__("../../frontend/src/layout/scenes/components/SceneTitleSection.tsx"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts");let cohortCalculationHistorySceneLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{cohortId}=_ref;return String(cohortId)}),(0,index_esm.path)(key=>["scenes","cohorts","cohortCalculationHistorySceneLogic",key]),(0,index_esm.connect)({values:[featureFlagLogic.featureFlagLogic,["featureFlags"]]}),(0,index_esm.actions)({setPage:page=>({page}),setLimit:limit=>({limit}),setCohortMissing:!0}),(0,lib.loaders)(_ref2=>{let{props,actions,values}=_ref2;return{calculationHistoryResponse:[{results:[],count:0,next:null,previous:null},{loadCalculationHistory:async(_,breakpoint)=>{if(!props.cohortId||props.cohortId<=0)return{results:[],count:0,next:null,previous:null};breakpoint();try{let offset=(values.page-1)*values.limit;return await api.ZP.get(`api/cohort/${props.cohortId}/calculation_history/?limit=${values.limit}&offset=${offset}`)}catch(error){throw 404===error.status&&actions.setCohortMissing(),error}}}],cohort:[null,{loadCohort:async(_,breakpoint)=>{if(!props.cohortId||props.cohortId<=0)return null;breakpoint();try{return await api.ZP.cohorts.get(props.cohortId)}catch{return actions.setCohortMissing(),null}}}]}}),(0,index_esm.reducers)({page:[1,{setPage:(_,_ref3)=>{let{page}=_ref3;return page}}],limit:[100,{setLimit:(_,_ref4)=>{let{limit}=_ref4;return limit}}],cohortMissing:[!1,{setCohortMissing:()=>!0}]}),(0,index_esm.listeners)(_ref5=>{let{actions}=_ref5;return{setPage:()=>{actions.loadCalculationHistory({})},setLimit:()=>{actions.loadCalculationHistory({})}}}),(0,index_esm.selectors)({calculationHistory:[s=>[s.calculationHistoryResponse],response=>response.results],totalRecords:[s=>[s.calculationHistoryResponse],response=>response.count],hasCalculationHistoryAccess:[s=>[s.featureFlags],featureFlags=>!!featureFlags[constants.y8.COHORT_CALCULATION_HISTORY]]}),(0,index_esm.events)(_ref6=>{let{actions,props}=_ref6;return{afterMount:()=>{props.cohortId&&props.cohortId>0&&(actions.loadCalculationHistory({}),actions.loadCohort({}))}}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let scene={component:CohortCalculationHistory,logic:cohortCalculationHistorySceneLogic,paramsToProps:_ref=>{let{params:{id}}=_ref;return{id:id}}};function CohortCalculationHistory(props){let cohortId=props.id&&"new"!==props.id?parseInt(props.id):0,logic=cohortCalculationHistorySceneLogic({cohortId}),{calculationHistory,calculationHistoryResponseLoading,cohort,cohortMissing,totalRecords,page,limit,hasCalculationHistoryAccess}=(0,index_esm.useValues)(logic),{setPage}=(0,index_esm.useActions)(logic);if(!cohortId||cohortId<=0)return(0,jsx_runtime.jsxs)("div",{children:["Invalid cohort ID: ",cohortId,". Please ensure you're visiting a valid cohort."]});if(!hasCalculationHistoryAccess)return(0,jsx_runtime.jsx)(NotFound.T,{object:"page"});if(cohortMissing)return(0,jsx_runtime.jsx)(NotFound.T,{object:"cohort"});let columns=[{title:"Started",dataIndex:"started_at",render:(_,record)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:record.started_at}),sorter:!0},{title:"Count",dataIndex:"count",render:count=>null!==count?count.toLocaleString():"-"},{title:"Queries",render:(_,record)=>record.queries?.length||0},{title:"Total Query Time",render:(_,record)=>{let totalMs=record.total_query_ms;return totalMs?`${(totalMs/1e3).toFixed(2)}s`:"-"}},{title:"Max Memory Usage",render:(_,record)=>{let queries=record.queries||[];if(0===queries.length)return"-";let maxMb=Math.max(...queries.map(q=>q.memory_mb||0));return maxMb>0?`${maxMb.toFixed(1)} MB`:"-"}},{title:"Rows Read",render:(_,record)=>{let totalRows=record.total_read_rows;return totalRows?totalRows.toLocaleString():"-"}},{title:"Status",render:(_,record)=>record.error?(0,jsx_runtime.jsx)("span",{className:"text-danger",children:"Error"}):record.finished_at?(0,jsx_runtime.jsx)("span",{className:"text-success",children:"Completed"}):(0,jsx_runtime.jsx)("span",{className:"text-warning",children:"In Progress"})}];return(0,jsx_runtime.jsxs)(SceneContent._,{children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:`Calculation History - ${cohort?.name||"Cohort"}`,description:"History of all calculations performed for this cohort, including performance metrics and timing information.",resourceType:{to:urls.j.cohorts(),type:"cohort",forceIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconClock,{})},forceBackTo:{key:cohortId,name:cohort?.name||"Cohort",path:urls.j.cohort(cohortId)}}),calculationHistoryResponseLoading?(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(src.yW,{className:"h-8"}),(0,jsx_runtime.jsx)(src.yW,{className:"h-8"}),(0,jsx_runtime.jsx)(src.yW,{className:"h-8"}),(0,jsx_runtime.jsx)(src.yW,{className:"h-8"})]}):(0,jsx_runtime.jsx)(src.g3,{columns:columns,dataSource:calculationHistory,pagination:{controlled:!0,currentPage:page,pageSize:limit,entryCount:totalRecords,onForward:()=>setPage(page+1),onBackward:()=>setPage(page-1)},expandable:{expandedRowRender:record=>(0,jsx_runtime.jsxs)("div",{className:"p-4 bg-bg-light",children:[record.error&&(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)("h4",{className:"text-danger",children:"Error"}),(0,jsx_runtime.jsx)("pre",{className:"text-xs bg-danger-highlight p-2 rounded overflow-auto",children:record.error})]}),record.queries&&record.queries.length>0&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{children:"Query Details"}),(0,jsx_runtime.jsx)("div",{className:"space-y-2",children:record.queries.map((query,index)=>(0,jsx_runtime.jsxs)("div",{className:"border border-border rounded p-2",children:[(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-4 gap-4 text-xs",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("strong",{children:"Query Time:"})," ",query.query_ms,"ms"]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("strong",{children:"Memory:"})," ",query.memory_mb?.toFixed(1)," MB"]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("strong",{children:"Rows Read:"})," ",query.read_rows?.toLocaleString()]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("strong",{children:"Rows Written:"})," ",query.written_rows?.toLocaleString()]})]}),query.query&&(0,jsx_runtime.jsxs)("details",{className:"mt-2",children:[(0,jsx_runtime.jsx)("summary",{className:"cursor-pointer text-primary",children:"Show Query"}),(0,jsx_runtime.jsx)("pre",{className:"mt-2 text-xs bg-bg-3000 p-2 rounded overflow-auto",children:query.query})]})]},index))})]}),record.filters&&(0,jsx_runtime.jsxs)("div",{className:"mt-4",children:[(0,jsx_runtime.jsx)("h4",{children:"Filters Used"}),(0,jsx_runtime.jsx)("pre",{className:"text-xs bg-bg-3000 p-2 rounded overflow-auto",children:JSON.stringify(record.filters,null,2)})]})]}),rowExpandable:record=>!!(record.error||record.queries&&record.queries.length>0||record.filters)}})]})}}}]);