(window.webpackJsonp=window.webpackJsonp||[]).push([[299],{"./frontend/src/scenes/batch_exports/BatchExportEditScene.tsx":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"scene",(function(){return scene})),__webpack_require__.d(__webpack_exports__,"BatchExportsEditScene",(function(){return BatchExportsEditScene}));var PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@16.14.0/node_modules/kea/lib/index.esm.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.0.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),urls=__webpack_require__("./frontend/src/scenes/urls.ts"),kea_router_lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.3_kea@3.1.5/node_modules/kea-router/lib/index.js"),dayjs=__webpack_require__("./frontend/src/lib/dayjs.ts"),batchExportLogic=__webpack_require__("./frontend/src/scenes/batch_exports/batchExportLogic.ts");const formFields=(props,_ref)=>{let{name:name,destination:destination,interval:interval,start_at:start_at,end_at:end_at,paused:paused,...config}=_ref;const isNew="new"===props.id;return{name:name?"":"Please enter a name",destination:destination?"":"Please select a destination",interval:interval?"":"Please select a frequency",paused:"",start_at:"",end_at:"",..."S3"===destination?{bucket_name:config.bucket_name?"":"This field is required",region:config.region?"":"This field is required",prefix:config.prefix?"":"This field is required",aws_access_key_id:isNew?config.aws_access_key_id?"":"This field is required":"",aws_secret_access_key:isNew?config.aws_secret_access_key?"":"This field is required":""}:"Snowflake"===destination?{account:config.account?"":"This field is required",database:config.database?"":"This field is required",warehouse:config.warehouse?"":"This field is required",user:isNew?config.user?"":"This field is required":"",password:isNew?config.password?"":"This field is required":"",schema:config.schema?"":"This field is required",table_name:config.table_name?"":"This field is required",role:""}:{}}},batchExportsEditLogic=Object(index_esm.kea)([Object(index_esm.props)({}),Object(index_esm.key)((_ref2=>{let{id:id}=_ref2;return id})),Object(index_esm.path)((key=>["scenes","batch_exports","batchExportsEditLogic",key])),Object(index_esm.connect)((props=>({values:[Object(batchExportLogic.a)(props),["batchExportConfig","batchExportConfigLoading"]],actions:[Object(batchExportLogic.a)(props),["loadBatchExportConfig","loadBatchExportConfigSuccess"]]}))),Object(index_esm.actions)({cancelEditing:!0}),Object(lib.forms)((_ref3=>{let{props:props,actions:actions}=_ref3;return{batchExportConfigForm:{defaults:{name:""},errors:form=>formFields(props,form),submit:async _ref4=>{var _start_at$toISOString,_end_at$toISOString;let{name:name,destination:destination,interval:interval,start_at:start_at,end_at:end_at,paused:paused,...config}=_ref4;const destinationObject="S3"===destination?{type:"S3",config:config}:{type:"Snowflake",config:config},data={paused:paused,name:name,interval:interval,start_at:null!==(_start_at$toISOString=null==start_at?void 0:start_at.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=null==end_at?void 0:end_at.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null,destination:destinationObject},result="new"===props.id?await api.b.batchExports.create(data):await api.b.batchExports.update(props.id,data);await new Promise((resolve=>setTimeout(resolve,1e3))),actions.resetBatchExportConfigForm(),kea_router_lib.router.actions.replace(urls.a.batchExport(result.id))}}}})),Object(index_esm.listeners)((_ref5=>{let{values:values,props:props,actions:actions}=_ref5;return{cancelEditing:()=>{values.isNew?kea_router_lib.router.actions.push(urls.a.batchExports()):kea_router_lib.router.actions.push(urls.a.batchExport(props.id))},loadBatchExportConfigSuccess:_ref6=>{let{batchExportConfig:batchExportConfig}=_ref6;if(!batchExportConfig)return;const destination=batchExportConfig.destination.type,transformedConfig={...batchExportConfig,destination:destination,start_at:batchExportConfig.start_at?Object(dayjs.a)(batchExportConfig.start_at):null,end_at:batchExportConfig.end_at?Object(dayjs.a)(batchExportConfig.end_at):null,...batchExportConfig.destination.config},validFormFields=Object.keys(formFields(props,transformedConfig));Object.keys(transformedConfig).forEach((key=>{validFormFields.includes(key)||delete transformedConfig[key]})),actions.resetBatchExportConfigForm(transformedConfig)}}})),Object(index_esm.selectors)({isNew:[()=>[(_,props)=>props],props=>"new"===props.id],breadcrumbs:[s=>[s.batchExportConfig,s.isNew],(config,isNew)=>{var _config$name;return[{name:"Batch Exports",path:urls.a.batchExports()},...isNew?[{name:"New"}]:[{name:null!==(_config$name=null==config?void 0:config.name)&&void 0!==_config$name?_config$name:"Loading",path:null!=config&&config.id?urls.a.batchExport(config.id):void 0},{name:"Edit"}]]}]}),Object(index_esm.afterMount)((_ref7=>{let{values:values,actions:actions}=_ref7;values.isNew||(values.batchExportConfig?actions.loadBatchExportConfigSuccess(values.batchExportConfig):actions.loadBatchExportConfig())})),Object(kea_router_lib.beforeUnload)((_ref8=>{let{values:values}=_ref8;return{enabled:()=>values.batchExportConfigFormChanged,message:"Leave?\nChanges you made will be discarded."}}))]),batchExportsEditSceneLogic=Object(index_esm.kea)([Object(index_esm.props)({}),Object(index_esm.key)((_ref=>{let{id:id}=_ref;return id})),Object(index_esm.path)((key=>["scenes","batch_exports","batchExportsEditSceneLogic",key])),Object(index_esm.connect)((props=>({values:[Object(batchExportLogic.a)(props),["batchExportConfig"]]}))),Object(index_esm.selectors)({id:[()=>[(_,props)=>props],props=>props.id],breadcrumbs:[s=>[s.batchExportConfig,s.id],(config,id)=>{var _config$name;return[{name:"Batch Exports",path:urls.a.batchExports()},..."new"===id?[{name:"New"}]:[{name:null!==(_config$name=null==config?void 0:config.name)&&void 0!==_config$name?_config$name:"Loading",path:null!=config&&config.id?urls.a.batchExport(config.id):void 0},{name:"Edit"}]]}]})]);var src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),LemonBanner=__webpack_require__("./frontend/src/lib/lemon-ui/LemonBanner/index.ts"),LemonCalendarSelect=__webpack_require__("./frontend/src/lib/lemon-ui/LemonCalendar/LemonCalendarSelect.tsx"),LemonSkeleton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonSkeleton/index.tsx"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts"),Field=__webpack_require__("./frontend/src/lib/forms/Field.tsx"),Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip.tsx"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/jsx-runtime.js");function BatchExportsEditForm(props){const logic=batchExportsEditLogic(props),{isNew:isNew,batchExportConfigForm:batchExportConfigForm,isBatchExportConfigFormSubmitting:isBatchExportConfigFormSubmitting,batchExportConfigLoading:batchExportConfigLoading}=Object(index_esm.useValues)(logic),{submitBatchExportConfigForm:submitBatchExportConfigForm,cancelEditing:cancelEditing}=Object(index_esm.useActions)(logic);return Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:batchExportConfigLoading?Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)(LemonSkeleton.a,{}),Object(jsx_runtime.jsx)(LemonSkeleton.a,{}),Object(jsx_runtime.jsx)(LemonSkeleton.a,{}),Object(jsx_runtime.jsx)(LemonSkeleton.a,{})]}):Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:Object(jsx_runtime.jsxs)(lib.Form,{logic:batchExportsEditLogic,props:props,formKey:"batchExportConfigForm",className:"space-y-4",children:[Object(jsx_runtime.jsxs)("div",{className:"space-y-4 max-w-200",children:[Object(jsx_runtime.jsx)(Field.a,{name:"name",label:"Name",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"Name your workflow for future reference"})}),Object(jsx_runtime.jsxs)("div",{className:"flex gap-2 items-start flex-wrap",children:[Object(jsx_runtime.jsx)(Field.a,{name:"interval",label:"Batch interval",className:"flex-1",info:Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The intervals of data exports. For example, if you select hourly, every hour a run will be created to export that hours data."}),children:Object(jsx_runtime.jsx)(src.LemonSelect,{options:[{value:"hour",label:"Hourly"},{value:"day",label:"Daily"}]})}),Object(jsx_runtime.jsx)(Field.a,{name:"end_at",label:"End date",className:"flex-1",info:Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The date up to which data is to be exported. Leaving it unset implies that data exports will continue forever until this export is paused or deleted."}),children:_ref=>{let{value:value,onChange:onChange}=_ref;return Object(jsx_runtime.jsx)(LemonCalendarSelect.b,{value:value,onChange:onChange,placeholder:"Select end date (optional)",clearable:!0})}})]}),Object(jsx_runtime.jsx)(LemonBanner.a,{type:"info",children:"This batch exporter will schedule regular batch exports at your indicated interval until the end date. Once you have configured your exporter, you can trigger a manual export for historic data."}),isNew?Object(jsx_runtime.jsx)(Field.a,{name:"paused",children:Object(jsx_runtime.jsx)(src.LemonCheckbox,{bordered:!0,label:Object(jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Create in paused state",Object(jsx_runtime.jsx)(Tooltip.a,{title:"If selected, the Batch Exporter will be created but will be 'paused' allowing you to resumed it at a later date.",children:Object(jsx_runtime.jsx)(icons.Cb,{className:" text-lg text-muted-alt"})})]})})}):null]}),Object(jsx_runtime.jsxs)("div",{className:"space-y-4 max-w-200 w-full ",children:[Object(jsx_runtime.jsx)(src.LemonDivider,{}),Object(jsx_runtime.jsx)(Field.a,{name:"destination",label:"Destination",children:Object(jsx_runtime.jsx)(src.LemonSelect,{options:[{value:"S3",label:"S3"},{value:"Snowflake",label:"Snowflake"}]})}),batchExportConfigForm.destination?"S3"===batchExportConfigForm.destination?Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[Object(jsx_runtime.jsx)(Field.a,{name:"bucket_name",label:"Bucket",className:"flex-1",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"e.g. my-bucket"})}),Object(jsx_runtime.jsx)(Field.a,{name:"region",label:"Region",className:"flex-1",children:Object(jsx_runtime.jsx)(src.LemonSelect,{options:[{value:"us-east-1",label:"US East (N. Virginia)"},{value:"us-east-2",label:"US East (Ohio)"},{value:"us-west-1",label:"US West (N. California)"},{value:"us-west-2",label:"US West (Oregon)"},{value:"af-south-1",label:"Africa (Cape Town)"},{value:"ap-east-1",label:"Asia Pacific (Hong Kong)"},{value:"ap-south-1",label:"Asia Pacific (Mumbai)"},{value:"ap-northeast-3",label:"Asia Pacific (Osaka-Local)"},{value:"ap-northeast-2",label:"Asia Pacific (Seoul)"},{value:"ap-southeast-1",label:"Asia Pacific (Singapore)"},{value:"ap-southeast-2",label:"Asia Pacific (Sydney)"},{value:"ap-northeast-1",label:"Asia Pacific (Tokyo)"},{value:"ca-central-1",label:"Canada (Central)"},{value:"cn-north-1",label:"China (Beijing)"},{value:"cn-northwest-1",label:"China (Ningxia)"},{value:"eu-central-1",label:"Europe (Frankfurt)"},{value:"eu-west-1",label:"Europe (Ireland)"},{value:"eu-west-2",label:"Europe (London)"},{value:"eu-south-1",label:"Europe (Milan)"},{value:"eu-west-3",label:"Europe (Paris)"},{value:"eu-north-1",label:"Europe (Stockholm)"},{value:"me-south-1",label:"Middle East (Bahrain)"},{value:"sa-east-1",label:"South America (SÃ£o Paulo)"}]})})]}),Object(jsx_runtime.jsx)(Field.a,{name:"prefix",label:"Key prefix",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"e.g. posthog-events/"})}),Object(jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[Object(jsx_runtime.jsx)(Field.a,{name:"aws_access_key_id",label:"AWS Access Key ID",className:"flex-1",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:isNew?"e.g. AKIAIOSFODNN7EXAMPLE":"leave unchanged"})}),Object(jsx_runtime.jsx)(Field.a,{name:"aws_secret_access_key",label:"AWS Secret Access Key",className:"flex-1",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:isNew?"e.g. secret-key":"leave unchanged",type:"password"})})]})]}):"Snowflake"===batchExportConfigForm.destination?Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)(Field.a,{name:"user",label:"User",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-user"})}),Object(jsx_runtime.jsx)(Field.a,{name:"password",label:"Password",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-password",type:"password"})}),Object(jsx_runtime.jsx)(Field.a,{name:"account",label:"Account",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-account"})}),Object(jsx_runtime.jsx)(Field.a,{name:"database",label:"Database",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-database"})}),Object(jsx_runtime.jsx)(Field.a,{name:"warehouse",label:"Warehouse",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-warehouse"})}),Object(jsx_runtime.jsx)(Field.a,{name:"schema",label:"Schema",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-schema"})}),Object(jsx_runtime.jsx)(Field.a,{name:"table_name",label:"Table name",children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"events"})}),Object(jsx_runtime.jsx)(Field.a,{name:"role",label:"Role",showOptional:!0,children:Object(jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-role"})})]}):null:Object(jsx_runtime.jsx)("p",{className:"text-muted-alt italic",children:"Select a destination to continue configuring"})]}),Object(jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[Object(jsx_runtime.jsx)(src.LemonButton,{"data-attr":"cancel-batch-export",type:"secondary",onClick:()=>cancelEditing(),disabledReason:isBatchExportConfigFormSubmitting?"Currently being saved":void 0,children:"Cancel"}),Object(jsx_runtime.jsx)(src.LemonButton,{"data-attr":"save-batch-export",htmlType:"submit",type:"primary",onClick:submitBatchExportConfigForm,loading:isBatchExportConfigFormSubmitting,children:isNew?"Create":"Save"})]})]})})})}try{BatchExportsEditForm.displayName="BatchExportsEditForm",BatchExportsEditForm.__docgenInfo={description:"",displayName:"BatchExportsEditForm",props:{id:{defaultValue:null,description:"",name:"id",required:!0,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/batch_exports/BatchExportEditForm.tsx#BatchExportsEditForm"]={docgenInfo:BatchExportsEditForm.__docgenInfo,name:"BatchExportsEditForm",path:"frontend/src/scenes/batch_exports/BatchExportEditForm.tsx#BatchExportsEditForm"})}catch(__react_docgen_typescript_loader_error){}const scene={component:BatchExportsEditScene,logic:batchExportsEditSceneLogic,paramsToProps:_ref=>{let{params:{id:id}}=_ref;return{id:null!=id?id:"new"}}};function BatchExportsEditScene(){const{id:id}=Object(index_esm.useValues)(batchExportsEditSceneLogic),{isNew:isNew}=Object(index_esm.useValues)(batchExportsEditLogic({id:id}));return Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsx)(PageHeader.a,{title:(isNew?"New":"Edit")+" Batch Export"}),Object(jsx_runtime.jsx)("div",{className:"my-8"}),Object(jsx_runtime.jsx)(BatchExportsEditForm,{id:id})]})}},"./frontend/src/scenes/batch_exports/batchExportLogic.ts":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return batchExportLogic}));var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@16.14.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./frontend/src/lib/api.ts"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),kea_forms__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/.pnpm/kea-forms@3.0.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),lib_dayjs__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/dayjs.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/scenes/urls.ts"),kea_router__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.3_kea@3.1.5/node_modules/kea-router/lib/index.js");const mergeRuns=(oldRuns,newRuns)=>{const runs=[...oldRuns];return newRuns.forEach((rawRun=>{const newRun=(run=rawRun,{...run,data_interval_start:Object(lib_dayjs__WEBPACK_IMPORTED_MODULE_5__.a)(run.data_interval_start),data_interval_end:Object(lib_dayjs__WEBPACK_IMPORTED_MODULE_5__.a)(run.data_interval_end),created_at:Object(lib_dayjs__WEBPACK_IMPORTED_MODULE_5__.a)(run.created_at),last_updated_at:run.last_updated_at?Object(lib_dayjs__WEBPACK_IMPORTED_MODULE_5__.a)(run.last_updated_at):void 0});var run;const index=runs.findIndex((run=>run.id===newRun.id));index>-1?runs[index]=newRun:runs.push(newRun)})),runs},batchExportLogic=Object(kea__WEBPACK_IMPORTED_MODULE_0__.kea)([Object(kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),Object(kea__WEBPACK_IMPORTED_MODULE_0__.key)((_ref=>{let{id:id}=_ref;return id})),Object(kea__WEBPACK_IMPORTED_MODULE_0__.path)((key=>["scenes","batch_exports","batchExportLogic",key])),Object(kea__WEBPACK_IMPORTED_MODULE_0__.actions)({loadBatchExportRuns:!0,loadNextBatchExportRuns:!0,openBackfillModal:!0,closeBackfillModal:!0,retryRun:run=>({run:run}),setRunsDateRange:data=>data}),Object(kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({runsDateRange:[{from:Object(lib_dayjs__WEBPACK_IMPORTED_MODULE_5__.a)().subtract(7,"day").startOf("day"),to:Object(lib_dayjs__WEBPACK_IMPORTED_MODULE_5__.a)().endOf("day")},{setRunsDateRange:(_,_ref2)=>{let{from:from,to:to}=_ref2;return{from:from,to:to}}}],isBackfillModalOpen:[!1,{openBackfillModal:()=>!0,closeBackfillModal:()=>!1}]}),Object(kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)((_ref3=>{let{props:props,values:values}=_ref3;return{batchExportConfig:[null,{loadBatchExportConfig:async()=>await lib_api__WEBPACK_IMPORTED_MODULE_2__.b.batchExports.get(props.id),pause:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_2__.b.batchExports.pause(props.id),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.lemonToast.success("Batch export paused. No future runs will be scheduled"),{...values.batchExportConfig,paused:!0}):null,unpause:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_2__.b.batchExports.unpause(props.id),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.lemonToast.success("Batch export unpaused. Future runs will be scheduled"),{...values.batchExportConfig,paused:!1}):null,archive:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_2__.b.batchExports.delete(props.id),kea_router__WEBPACK_IMPORTED_MODULE_7__.router.actions.replace(scenes_urls__WEBPACK_IMPORTED_MODULE_6__.a.batchExports()),null):null}],batchExportRunsResponse:[null,{loadBatchExportRuns:async()=>{var _values$batchExportRu,_values$batchExportRu2;const res=await lib_api__WEBPACK_IMPORTED_MODULE_2__.b.batchExports.listRuns(props.id,{after:values.runsDateRange.from,before:values.runsDateRange.to.add(1,"day")});return res.results=mergeRuns(null!==(_values$batchExportRu=null===(_values$batchExportRu2=values.batchExportRunsResponse)||void 0===_values$batchExportRu2?void 0:_values$batchExportRu2.results)&&void 0!==_values$batchExportRu?_values$batchExportRu:[],res.results),res},loadNextBatchExportRuns:async()=>{var _values$batchExportRu3,_values$batchExportRu4,_values$batchExportRu5;const nextUrl=null===(_values$batchExportRu3=values.batchExportRunsResponse)||void 0===_values$batchExportRu3?void 0:_values$batchExportRu3.next;if(!nextUrl)return values.batchExportRunsResponse;const res=await lib_api__WEBPACK_IMPORTED_MODULE_2__.b.get(nextUrl);return res.results=mergeRuns(null!==(_values$batchExportRu4=null===(_values$batchExportRu5=values.batchExportRunsResponse)||void 0===_values$batchExportRu5?void 0:_values$batchExportRu5.results)&&void 0!==_values$batchExportRu4?_values$batchExportRu4:[],res.results),res}}]}})),Object(kea_forms__WEBPACK_IMPORTED_MODULE_4__.forms)((_ref4=>{let{props:props,actions:actions}=_ref4;return{backfillForm:{defaults:{end_at:Object(lib_dayjs__WEBPACK_IMPORTED_MODULE_5__.a)()},errors:_ref5=>{let{start_at:start_at,end_at:end_at}=_ref5;return{start_at:start_at?void 0:"Start date is required",end_at:end_at?void 0:"End date is required"}},submit:async _ref6=>{var _start_at$toISOString,_end_at$toISOString;let{start_at:start_at,end_at:end_at}=_ref6;await new Promise((resolve=>setTimeout(resolve,1e3))),await lib_api__WEBPACK_IMPORTED_MODULE_2__.b.batchExports.createBackfill(props.id,{start_at:null!==(_start_at$toISOString=null==start_at?void 0:start_at.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=null==end_at?void 0:end_at.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null}).catch((e=>{var _e$attr;e.detail?actions.setBackfillFormManualErrors({[null!==(_e$attr=e.attr)&&void 0!==_e$attr?_e$attr:"start_at"]:e.detail}):_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.lemonToast.error("Unknown error occurred");throw e})),actions.closeBackfillModal(),actions.loadBatchExportRuns()}}}})),Object(kea__WEBPACK_IMPORTED_MODULE_0__.selectors)((_ref7=>{let{}=_ref7;return{groupedRuns:[s=>[s.batchExportRuns],runs=>{const groupedRuns={};return runs.forEach((run=>{const key=`${run.data_interval_start}-${run.data_interval_end}`;groupedRuns[key]||(groupedRuns[key]={data_interval_start:run.data_interval_start,data_interval_end:run.data_interval_end,runs:[],last_run_at:run.created_at}),groupedRuns[key].runs.push(run),groupedRuns[key].runs.sort(((a,b)=>b.created_at.diff(a.created_at))),groupedRuns[key].last_run_at=groupedRuns[key].runs[0].created_at})),Object.values(groupedRuns).sort(((a,b)=>b.data_interval_end.diff(a.data_interval_end)))}],breadcrumbs:[s=>[s.batchExportConfig],config=>{var _config$name;return[{name:"Batch Exports",path:scenes_urls__WEBPACK_IMPORTED_MODULE_6__.a.batchExports()},{name:null!==(_config$name=null==config?void 0:config.name)&&void 0!==_config$name?_config$name:"Loading"}]}],batchExportRuns:[s=>[s.batchExportRunsResponse],batchExportRunsResponse=>{var _batchExportRunsRespo;return null!==(_batchExportRunsRespo=null==batchExportRunsResponse?void 0:batchExportRunsResponse.results)&&void 0!==_batchExportRunsRespo?_batchExportRunsRespo:[]}]}})),Object(kea__WEBPACK_IMPORTED_MODULE_0__.listeners)((_ref8=>{let{actions:actions,cache:cache,props:props}=_ref8;return{setRunsDateRange:()=>{actions.loadBatchExportRuns()},loadBatchExportRunsSuccess:()=>{clearTimeout(cache.refreshTimeout),cache.refreshTimeout=setTimeout((()=>{actions.loadBatchExportRuns()}),5e3)},retryRun:async _ref9=>{let{run:run}=_ref9;await lib_api__WEBPACK_IMPORTED_MODULE_2__.b.batchExports.createBackfill(props.id,{start_at:run.data_interval_start.toISOString(),end_at:run.data_interval_end.toISOString()}),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.lemonToast.success("Retry has been scheduled."),clearTimeout(cache.refreshTimeout),cache.refreshTimeout=setTimeout((()=>{actions.loadBatchExportRuns()}),2e3)}}})),Object(kea__WEBPACK_IMPORTED_MODULE_0__.beforeUnmount)((_ref10=>{let{cache:cache}=_ref10;clearTimeout(cache.refreshTimeout)}))])}}]);