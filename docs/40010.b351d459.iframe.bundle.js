"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[40010],{"./frontend/src/scenes/data-warehouse/editor/EditorScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{EditorScene:()=>EditorScene});var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),resizerLogic=__webpack_require__("./frontend/src/lib/components/Resizer/resizerLogic.ts");let editorSizingLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-warehouse","editor","editorSizingLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(props=>({values:[(0,resizerLogic.Z)(props.sourceNavigatorResizerProps),["desiredSize as sourceNavigatorDesiredSize"],(0,resizerLogic.Z)(props.queryPaneResizerProps),["desiredSize as queryPaneDesiredSize"]]})),(0,index_esm.selectors)({editorSceneRef:[()=>[(_,props)=>props.editorSceneRef],editorSceneRef=>editorSceneRef],sourceNavigatorWidth:[s=>[s.sourceNavigatorDesiredSize],desiredSize=>Math.max(desiredSize||350,100)],queryPaneHeight:[s=>[s.queryPaneDesiredSize],queryPaneDesiredSize=>Math.max(queryPaneDesiredSize||600,100)],queryTabsWidth:[s=>[s.queryPaneDesiredSize],desiredSize=>desiredSize||350],sourceNavigatorResizerProps:[()=>[(_,props)=>props.sourceNavigatorResizerProps],sourceNavigatorResizerProps=>sourceNavigatorResizerProps],queryPaneResizerProps:[()=>[(_,props)=>props.queryPaneResizerProps],queryPaneResizerProps=>queryPaneResizerProps]})]);var lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.2.0_kea@3.1.5/node_modules/kea-router/lib/index.js"),src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),kea_subscriptions_lib=__webpack_require__("./node_modules/.pnpm/kea-subscriptions@3.0.1_kea@3.1.5/node_modules/kea-subscriptions/lib/index.js"),LemonField=__webpack_require__("./frontend/src/lib/lemon-ui/LemonField/index.ts"),dataNodeLogic=__webpack_require__("./frontend/src/queries/nodes/DataNode/dataNodeLogic.ts"),queries_query=__webpack_require__("./frontend/src/queries/query.ts"),schema=__webpack_require__("./frontend/src/queries/schema.ts"),dataWarehouseViewsLogic=__webpack_require__("./frontend/src/scenes/data-warehouse/saved_queries/dataWarehouseViewsLogic.tsx"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let editorModelsStateKey=key=>`${key}/editorModelQueries`,activemodelStateKey=key=>`${key}/activeModelUri`,multitabEditorLogic=(0,index_esm.kea)([(0,index_esm.path)(["data-warehouse","editor","multitabEditorLogic"]),(0,index_esm.props)({}),(0,index_esm.actions)({setQueryInput:queryInput=>({queryInput}),updateState:!0,runQuery:queryOverride=>({queryOverride}),setActiveQuery:query=>({query}),setTabs:tabs=>({tabs}),addTab:tab=>({tab}),createTab:()=>null,deleteTab:tab=>({tab}),removeTab:tab=>({tab}),selectTab:tab=>({tab}),setLocalState:(key,value)=>({key,value}),initialize:!0,saveAsView:!0,saveAsViewSuccess:name=>({name}),reloadMetadata:!0,setMetadata:(query,metadata)=>({query,metadata})}),(0,index_esm.propsChanged)((_ref,oldProps)=>{let{actions}=_ref;oldProps.monaco||oldProps.editor||actions.initialize()}),(0,index_esm.reducers)(_ref2=>{let{props}=_ref2;return{queryInput:["",{setQueryInput:(_,_ref3)=>{let{queryInput}=_ref3;return queryInput}}],activeQuery:[null,{setActiveQuery:(_,_ref4)=>{let{query}=_ref4;return query}}],activeModelUri:[null,{selectTab:(_,_ref5)=>{let{tab}=_ref5;return tab}}],allTabs:[[],{addTab:(state,_ref6)=>{let{tab}=_ref6,newTabs=[...state,tab];return newTabs},removeTab:(state,_ref7)=>{let{tab:tabToRemove}=_ref7,newModels=state.filter(tab=>tab.toString()!==tabToRemove.toString());return newModels},setTabs:(_,_ref8)=>{let{tabs}=_ref8;return tabs}}],metadata:[null,{setMetadata:(_,_ref9)=>{let{query,metadata}=_ref9;return[query,metadata]}}],modelMarkers:[[],{setMetadata:(_,_ref10)=>{var _metadataResponse$err,_metadataResponse$war,_metadataResponse$not;let{query,metadata}=_ref10,model=props.editor?.getModel();if(!model||!metadata)return[];let markers=[];function noticeToMarker(error,severity){var _error$start,_error$end,_error$start2,_error$end2,_error$message;let start=model.getPositionAt(null!==(_error$start=error.start)&&void 0!==_error$start?_error$start:0),end=model.getPositionAt(null!==(_error$end=error.end)&&void 0!==_error$end?_error$end:query.length);return{start:null!==(_error$start2=error.start)&&void 0!==_error$start2?_error$start2:0,startLineNumber:start.lineNumber,startColumn:start.column,end:null!==(_error$end2=error.end)&&void 0!==_error$end2?_error$end2:query.length,endLineNumber:end.lineNumber,endColumn:end.column,message:null!==(_error$message=error.message)&&void 0!==_error$message?_error$message:"Unknown error",severity:severity,hogQLFix:error.fix}}for(let notice of null!==(_metadataResponse$err=metadata?.errors)&&void 0!==_metadataResponse$err?_metadataResponse$err:[])markers.push(noticeToMarker(notice,8));for(let notice of null!==(_metadataResponse$war=metadata?.warnings)&&void 0!==_metadataResponse$war?_metadataResponse$war:[])markers.push(noticeToMarker(notice,4));for(let notice of null!==(_metadataResponse$not=metadata?.notices)&&void 0!==_metadataResponse$not?_metadataResponse$not:[])markers.push(noticeToMarker(notice,1));return props.monaco?.editor.setModelMarkers(model,"hogql",markers),markers}}]}}),(0,index_esm.listeners)(_ref11=>{let{values,props,actions}=_ref11;return{createTab:()=>{let currentModelCount=1,allNumbers=values.allTabs.map(tab=>parseInt(tab.path.split("/").pop()||"0"));for(;allNumbers.includes(currentModelCount);)currentModelCount++;if(props.monaco){let uri=props.monaco.Uri.parse(currentModelCount.toString()),model=props.monaco.editor.createModel("","hogQL",uri);props.editor?.setModel(model),actions.addTab(uri),actions.selectTab(uri);let queries=values.allTabs.map(tab=>({query:props.monaco?.editor.getModel(tab)?.getValue()||"",path:tab.path.split("/").pop()}));actions.setLocalState(editorModelsStateKey(props.key),JSON.stringify(queries))}},selectTab:_ref12=>{let{tab}=_ref12;if(props.monaco){let model=props.monaco.editor.getModel(tab);props.editor?.setModel(model)}let path=tab.path.split("/").pop();path&&actions.setLocalState(activemodelStateKey(props.key),path)},deleteTab:_ref13=>{let{tab:tabToRemove}=_ref13;if(props.monaco){let model=props.monaco.editor.getModel(tabToRemove);if(tabToRemove==values.activeModelUri){let indexOfModel=values.allTabs.findIndex(tab=>tab.toString()===tabToRemove.toString()),nextModel=values.allTabs[indexOfModel+1]||values.allTabs[indexOfModel-1]||values.allTabs[0];actions.selectTab(nextModel)}model?.dispose(),actions.removeTab(tabToRemove);let queries=values.allTabs.map(tab=>({query:props.monaco?.editor.getModel(tab)?.getValue()||"",path:tab.path.split("/").pop()}));actions.setLocalState(editorModelsStateKey(props.key),JSON.stringify(queries))}},setLocalState:_ref14=>{let{key,value}=_ref14;localStorage.setItem(key,value)},initialize:()=>{let allModelQueries=localStorage.getItem(editorModelsStateKey(props.key)),activeModelUri=localStorage.getItem(activemodelStateKey(props.key));if(allModelQueries){props.monaco?.editor.getModels().forEach(model=>{model.dispose()});let models=JSON.parse(allModelQueries||"[]"),newModels=[];if(models.forEach(model=>{if(props.monaco){let uri=props.monaco.Uri.parse(model.path),newModel=props.monaco.editor.createModel(model.query,"hogQL",uri);props.editor?.setModel(newModel),newModels.push(uri)}}),actions.setTabs(newModels),activeModelUri){let uri=props.monaco?.Uri.parse(activeModelUri),activeModel=props.monaco?.editor.getModels().find(model=>model.uri.path===uri?.path);activeModel&&props.editor?.setModel(activeModel);let val=activeModel?.getValue();val&&(actions.setQueryInput(val),actions.runQuery()),uri&&actions.selectTab(uri)}else newModels.length&&actions.selectTab(newModels[0])}else{let model=props.editor?.getModel();model&&actions.createTab()}},setQueryInput:()=>{actions.updateState()},updateState:async(_,breakpoint)=>{await breakpoint(100);let queries=values.allTabs.map(model=>({query:props.monaco?.editor.getModel(model)?.getValue()||"",path:model.path.split("/").pop()}));localStorage.setItem(editorModelsStateKey(props.key),JSON.stringify(queries))},runQuery:_ref15=>{let{queryOverride}=_ref15;actions.setActiveQuery(queryOverride||values.queryInput)},saveAsView:async()=>{src.dn.openForm({title:"Save as view",initialValues:{viewName:""},content:(0,jsx_runtime.jsx)(LemonField.D,{name:"viewName",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"Please enter the name of the view",autoFocus:!0})}),errors:{viewName:name=>name?void 0:"You must enter a name"},onSubmit:_ref16=>{let{viewName}=_ref16;return actions.saveAsViewSuccess(viewName)}})},saveAsViewSuccess:async _ref17=>{let{name}=_ref17,query={kind:schema.OH.HogQLQuery,query:values.queryInput};await dataWarehouseViewsLogic.$.asyncActions.createDataWarehouseSavedQuery({name,query})},reloadMetadata:async(_,breakpoint)=>{let model=props.editor?.getModel();if(!model||!props.monaco)return;await breakpoint(300);let query=values.queryInput;if(""===query)return;let response=await (0,queries_query.jr)({kind:schema.OH.HogQLMetadata,language:schema.oU.hogQL,query:query});breakpoint(),actions.setMetadata(query,response)}}}),(0,kea_subscriptions_lib.Vt)(_ref18=>{let{props,actions,values}=_ref18;return{activeModelUri:activeModelUri=>{if(props.monaco){let _model=props.monaco.editor.getModel(activeModelUri),val=_model?.getValue();actions.setQueryInput(null!=val?val:""),actions.runQuery(),(0,dataNodeLogic.M)({key:values.activeTabKey,query:{kind:schema.OH.HogQLQuery,query:null!=val?val:""},doNotLoad:!val}).mount()}},queryInput:()=>{actions.reloadMetadata()}}}),(0,index_esm.selectors)({activeTabKey:[s=>[s.activeModelUri],activeModelUri=>`hogQLQueryEditor/${activeModelUri?.path}`],isValidView:[s=>[s.metadata],metadata=>!!(metadata&&metadata[1]?.isValidView)],hasErrors:[s=>[s.modelMarkers],modelMarkers=>!!(null!=modelMarkers?modelMarkers:[]).filter(e=>8===e.severity).length],error:[s=>[s.hasErrors,s.modelMarkers],(hasErrors,modelMarkers)=>{let firstError=modelMarkers.find(e=>8===e.severity);return hasErrors&&firstError?`Error on line ${firstError.startLineNumber}, column ${firstError.startColumn}`:null}]})]);var Resizer=__webpack_require__("./frontend/src/lib/components/Resizer/Resizer.tsx"),LemonBanner=__webpack_require__("./frontend/src/lib/lemon-ui/LemonBanner/index.ts"),CodeEditor=__webpack_require__("./frontend/src/lib/monaco/CodeEditor.tsx"),AutoSizer=__webpack_require__("./node_modules/.pnpm/react-virtualized@9.22.5_react-dom@18.2.0_react@18.2.0/node_modules/react-virtualized/dist/es/AutoSizer/index.js");function QueryPane(props){let{queryPaneHeight,queryPaneResizerProps}=(0,index_esm.useValues)(editorSizingLogic);return(0,jsx_runtime.jsxs)("div",{className:"relative flex flex-col w-full bg-bg-3000",style:{height:`${queryPaneHeight}px`},ref:queryPaneResizerProps.containerRef,children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[props.promptError?(0,jsx_runtime.jsx)(LemonBanner.V,{type:"warning",children:props.promptError}):null,(0,jsx_runtime.jsx)(AutoSizer.q,{children:_ref=>{let{height,width}=_ref;return(0,jsx_runtime.jsx)(CodeEditor.p,{className:"border",language:"hogQL",value:props.queryInput,height:height,width:width,...props.codeEditorProps,options:{minimap:{enabled:!1},wordWrap:"on",scrollBeyondLastLine:!1,automaticLayout:!0,fixedOverflowWidgets:!0,suggest:{showInlineDetails:!0},quickSuggestionsDelay:300}})}})]}),(0,jsx_runtime.jsx)(Resizer.w,{...queryPaneResizerProps})]})}var posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.8.5_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js");function QueryTabs(_ref){let{models,onClear,onClick,onAdd,activeModelUri}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-row overflow-scroll hide-scrollbar",children:[models.map(model=>(0,jsx_runtime.jsx)(QueryTab,{model:model,onClear:models.length>1?onClear:void 0,onClick:onClick,active:activeModelUri?.path===model.path},model.path)),(0,jsx_runtime.jsx)(src.Jp,{onClick:onAdd,icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{fontSize:14})})]})}function QueryTab(_ref2){let{model,active,onClear,onClick}=_ref2;return(0,jsx_runtime.jsxs)("button",{onClick:()=>onClick?.(model),className:(0,clsx_m.default)("space-y-px rounded-t p-1 flex flex-row items-center gap-1 hover:bg-[var(--bg-light)] cursor-pointer",active?"bg-[var(--bg-light)] border":"bg-bg-3000",onClear?"pl-3 pr-2":"px-3"),children:["Untitled",onClear&&(0,jsx_runtime.jsx)(src.Jp,{onClick:e=>{e.stopPropagation(),onClear(model)},size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{})})]})}__webpack_require__("./node_modules/.pnpm/react-data-grid@7.0.0-beta.47_react-dom@18.2.0_react@18.2.0/node_modules/react-data-grid/lib/styles.css");var bundle=__webpack_require__("./node_modules/.pnpm/react-data-grid@7.0.0-beta.47_react-dom@18.2.0_react@18.2.0/node_modules/react-data-grid/lib/bundle.js"),themeLogic=__webpack_require__("./frontend/src/layout/navigation-3000/themeLogic.ts"),ResultsTab=function(ResultsTab){return ResultsTab.Results="results",ResultsTab.Visualization="visualization",ResultsTab}(ResultsTab||{});function ResultPane(_ref){let{onQueryInputChange,onSave,saveDisabledReason,logicKey,query}=_ref,{isDarkModeOn}=(0,index_esm.useValues)(themeLogic.b),{response,responseLoading}=(0,index_esm.useValues)((0,dataNodeLogic.M)({key:logicKey,query:{kind:schema.OH.HogQLQuery,query},doNotLoad:!query})),columns=(0,react.useMemo)(()=>{var _response$columns$map;return null!==(_response$columns$map=response?.columns?.map(column=>({key:column,name:column,resizable:!0})))&&void 0!==_response$columns$map?_response$columns$map:[]},[response]),rows=(0,react.useMemo)(()=>response?.results?response?.results?.map(row=>{let rowObject={};return response.columns.forEach((column,i)=>{rowObject[column]=row[i]}),rowObject}):[],[response]);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col w-full flex-1 bg-bg-3000",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row justify-between align-center py-2 px-4 w-full h-[55px]",children:[(0,jsx_runtime.jsx)(src.TP,{activeKey:ResultsTab.Results,onChange:()=>{},tabs:[{key:ResultsTab.Results,label:"Results"}]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-1",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>onSave(),disabledReason:saveDisabledReason,children:"Save"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>onQueryInputChange(),children:"Run"})]})]}),(0,jsx_runtime.jsx)("div",{className:"flex flex-1 relative bg-dark justify-center items-center",children:responseLoading?(0,jsx_runtime.jsx)(src.$j,{className:"text-3xl"}):response?(0,jsx_runtime.jsx)("div",{className:"flex-1 absolute top-0 left-0 right-0 bottom-0",children:(0,jsx_runtime.jsx)(bundle.ZP,{className:isDarkModeOn?"rdg-dark h-full":"rdg-light h-full",columns:columns,rows:rows})}):(0,jsx_runtime.jsx)("span",{className:"text-muted mt-3",children:"Query results will appear here"})})]})}function QueryWindow(){let[monacoAndEditor,setMonacoAndEditor]=(0,react.useState)(null),[monaco,editor]=null!=monacoAndEditor?monacoAndEditor:[],codeEditorKey=`hogQLQueryEditor/${lib.router.values.location.pathname}`,logic=multitabEditorLogic({key:codeEditorKey,monaco,editor}),{allTabs,activeModelUri,queryInput,activeQuery,activeTabKey,hasErrors,error,isValidView}=(0,index_esm.useValues)(logic),{selectTab,deleteTab,createTab,setQueryInput,runQuery,saveAsView}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 flex-col h-full",children:[(0,jsx_runtime.jsx)(QueryTabs,{models:allTabs,onClick:selectTab,onClear:deleteTab,onAdd:createTab,activeModelUri:activeModelUri}),(0,jsx_runtime.jsx)(QueryPane,{queryInput:queryInput,promptError:null,codeEditorProps:{onChange:v=>{setQueryInput(null!=v?v:"")},onMount:(editor,monaco)=>{setMonacoAndEditor([monaco,editor])},onPressCmdEnter:(value,selectionType)=>{value&&"selection"===selectionType?runQuery(value):runQuery()}}}),(0,jsx_runtime.jsx)(ResultPane,{logicKey:activeTabKey,query:null!=activeQuery?activeQuery:"",onQueryInputChange:runQuery,onSave:saveAsView,saveDisabledReason:hasErrors?null!=error?error:"Query has errors":isValidView?"":"All fields must have an alias"})]})}var DataWarehouseTables=__webpack_require__("./frontend/src/scenes/data-warehouse/external/DataWarehouseTables.tsx");let SchemaSearch=()=>(0,jsx_runtime.jsx)("div",{className:"flex items-center",children:(0,jsx_runtime.jsx)(src.DF,{className:"rounded-none",type:"search",placeholder:"Search for schema","data-attr":"schema-search",fullWidth:!0})});function SourceNavigator(){let{sourceNavigatorWidth,sourceNavigatorResizerProps}=(0,index_esm.useValues)(editorSizingLogic);return(0,jsx_runtime.jsxs)("div",{ref:sourceNavigatorResizerProps.containerRef,className:"relative flex flex-col bg-bg-3000 h-full overflow-hidden",style:{width:`${sourceNavigatorWidth}px`},children:[(0,jsx_runtime.jsx)(SchemaSearch,{}),(0,jsx_runtime.jsx)(DataWarehouseTables.f,{inline:!0,collapsible:!1}),(0,jsx_runtime.jsx)(Resizer.w,{...sourceNavigatorResizerProps})]})}function EditorScene(){let ref=(0,react.useRef)(null),navigatorRef=(0,react.useRef)(null),queryPaneRef=(0,react.useRef)(null);return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:editorSizingLogic,props:{editorSceneRef:ref,navigatorRef,sourceNavigatorResizerProps:{containerRef:navigatorRef,logicKey:"source-navigator",placement:"right"},queryPaneResizerProps:{containerRef:queryPaneRef,logicKey:"query-pane",placement:"bottom"}},children:(0,jsx_runtime.jsxs)("div",{className:"w-full h-full flex flex-row overflow-hidden",ref:ref,children:[(0,jsx_runtime.jsx)(SourceNavigator,{}),(0,jsx_runtime.jsx)(QueryWindow,{})]})})}}}]);