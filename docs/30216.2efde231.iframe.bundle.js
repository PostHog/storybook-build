"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[30216],{"./frontend/src/scenes/data-model/DataModelScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{DataModelScene:()=>DataModelScene,scene:()=>scene});var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),ViewLinkModal=__webpack_require__("./frontend/src/scenes/data-warehouse/ViewLinkModal.tsx"),lib=__webpack_require__("./node_modules/.pnpm/kea-subscriptions@3.0.1_kea@3.1.5/node_modules/kea-subscriptions/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),databaseTableListLogic=__webpack_require__("./frontend/src/scenes/data-management/database/databaseTableListLogic.ts");let dataModelSceneLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-model","dataModelSceneLogic"]),(0,index_esm.connect)(()=>({values:[databaseTableListLogic.A,["posthogTablesMap","viewsMapById"]]})),(0,index_esm.actions)({traverseAncestors:viewId=>({viewId}),setNodes:nodes=>({nodes})}),(0,index_esm.reducers)({nodeMap:[{},{setNodes:(_,_ref)=>{let{nodes}=_ref;return nodes}}]}),(0,index_esm.listeners)(_ref2=>{let{actions,values}=_ref2;return{traverseAncestors:async _ref3=>{let{viewId}=_ref3,result=await api.ZP.dataWarehouseSavedQueries.ancestors(viewId);result.ancestors.forEach(ancestor=>{actions.setNodes({...values.nodeMap,[ancestor]:{nodeId:ancestor,name:values.viewsMapById[ancestor]?.name||ancestor,leaf:[...values.nodeMap[ancestor]?.leaf||[],viewId]}})})}}}),(0,index_esm.selectors)({personFields:[s=>[s.posthogTablesMap],posthogTablesMap=>posthogTablesMap.persons?.fields||[]],simplifiedPersonFields:[s=>[s.personFields],personFields=>Object.entries(personFields).filter(_ref4=>{let[_,data]=_ref4;return"view"!=data.type}).map(_ref5=>{let[column,data]=_ref5;return{column,type:data.type}})],joinedFields:[s=>[s.personFields],personFields=>Object.entries(personFields).filter(_ref6=>{let[_,data]=_ref6;return"view"==data.type}).map(_ref7=>{let[_,data]=_ref7;return data})],joinedFieldsAsNodes:[s=>[s.joinedFields],joinedFields=>joinedFields.map(field=>({nodeId:field.name,type:"view",table:field.name}))||[]],allNodes:[s=>[s.nodeMap],nodeMap=>[{nodeId:"posthog",name:"PostHog",leaf:["schema"]},...Object.values(nodeMap)]]}),(0,lib.Vt)(_ref8=>{let{actions,values}=_ref8;return{joinedFields:joinedFields=>{joinedFields.forEach(field=>{actions.setNodes({...values.nodeMap,[field.id]:{nodeId:field.id,name:values.viewsMapById[field.id]?.name||field.id,leaf:[field.name]}}),actions.traverseAncestors(field.id)})}}})]);var clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let Node=function(_ref){let{pref,className="",children}=_ref;return(0,jsx_runtime.jsx)("div",{ref:pref,className:`flex max-w-[200px] px-4 py-3 justify-center items-center space-between gap-1 bg-bg-3000 border border-black border-2 rounded-lg truncate ${className}`,children:children})};var posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.8.1_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),viewLinkLogic=__webpack_require__("./frontend/src/scenes/data-warehouse/viewLinkLogic.tsx");function TableFields(_ref){let{fixedFields,joinedFields,rowsRefs,tableName}=_ref,{toggleJoinTableModal,selectSourceTable}=(0,index_esm.useActions)(viewLinkLogic.t);return(0,jsx_runtime.jsxs)("div",{className:"",children:[(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("div",{className:"pl-4 mt-4",children:(0,jsx_runtime.jsx)("h3",{children:tableName})})}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)("div",{ref:el=>{rowsRefs.current[joinedFields.length]=el,rowsRefs.current[joinedFields.length]?.setAttribute("id","schema")},className:"pl-4 mt-4",children:(0,jsx_runtime.jsx)("h4",{children:"Schema"})}),(0,jsx_runtime.jsx)(src.g3,{className:"bg-bg-3000 rounded-none",columns:[{key:"column",render:(_,_ref2)=>{let{column}=_ref2;return column}},{key:"type",render:(_,_ref3)=>{let{type}=_ref3;return type}}],dataSource:fixedFields,loading:!1,showHeader:!1})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"px-4 my-4 flex flex-row justify-between",children:[(0,jsx_runtime.jsx)("h4",{children:"Joined Tables"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),onClick:()=>{selectSourceTable(tableName),toggleJoinTableModal()},children:"Add join"})]}),(0,jsx_runtime.jsx)(src.g3,{className:"bg-bg-3000 rounded-none",columns:[{key:"name",render:(_,_ref4,idx)=>{let{nodeId}=_ref4;return(0,jsx_runtime.jsx)("div",{ref:el=>{rowsRefs.current[idx]=el,rowsRefs.current[idx]?.setAttribute("id",nodeId)},className:"flex flex-col",children:(0,jsx_runtime.jsx)("span",{className:"font-bold",children:nodeId})})}}],loading:!1,showHeader:!1,dataSource:joinedFields})]})]})}let assignDepths=nodes=>{let nodeMap={};nodes.forEach(node=>{nodeMap[node.nodeId]={...node,depth:-1}});let assignDepthRecursive=(nodeId,currentDepth)=>{let node=nodeMap[nodeId];node&&(node.depth=currentDepth,node.leaf.forEach(leafId=>{nodeMap[leafId]&&assignDepthRecursive(leafId,currentDepth+1)}))};return nodes.forEach(node=>{-1===nodeMap[node.nodeId].depth&&assignDepthRecursive(node.nodeId,0)}),Object.values(nodeMap)},calculateNodePositions=nodesWithDepth=>{nodesWithDepth.sort((a,b)=>a.depth-b.depth);let depthRowMap={},nodePositions=nodesWithDepth.map(node=>{let col=node.depth;void 0===depthRowMap[col]&&(depthRowMap[col]=0),col>0&&0===depthRowMap[col]&&(depthRowMap[col]=depthRowMap[0]-1||0);let row=depthRowMap[col];return depthRowMap[col]=row+1,{...node,position:{x:50+250*col,y:50+150*row}}});return nodePositions},calculateTablePosition=nodePositions=>{let farthestNode=nodePositions.reduce((max,node)=>node.position.x>max.position.x?node:max),tablePosition={x:farthestNode.position.x+300,y:100};return tablePosition},calculateEdges=(nodeRefs,nodes)=>{let nodes_map=nodes.reduce((acc,node)=>(acc[node.nodeId]=node,acc),{}),dfs=function(nodeId){let visited=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Set,depth=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(visited.has(nodeId))return[];visited.add(nodeId);let node=nodes_map[nodeId];if(!node)return[];let nodeRef=nodeRefs.find(ref=>ref?.id===nodeId);if(!nodeRef)return[];let edges=[],fromWithBounds=calculateBound(node,nodeRef);for(let i=0;i<node.leaf.length;i++){let leafId=node.leaf[i],toNode=nodes_map[leafId],toRef=nodeRefs.find(ref=>ref?.id===leafId);if(toNode&&toRef){let toWithBounds=calculateBound(toNode,toRef),newEdges=calculateEdgesFromTo(fromWithBounds,toWithBounds);edges.push(...newEdges)}depth=i>0?depth+1:depth,edges.push(...dfs(leafId,visited,depth))}return edges},edges=[],visited=new Set;for(let node of nodes)visited.has(node.nodeId)||edges.push(...dfs(node.nodeId,visited));return edges},calculateBound=(node,ref)=>{if(!ref)return{...node,left:null,right:null};let{x,y}=node.position,{width,height}=ref.getBoundingClientRect();return{...node,left:{x,y:y+height/2},right:{x:x+width,y:y+height/2}}},calculateEdgesFromTo=(from,to)=>{if(!from.right||!to.left)return[];let edges=[];return edges.push({from:from.right,to:to.left}),edges},data_model_NodeCanvasWithTable=_ref=>{let{nodes,fixedFields,joinedFields,tableName}=_ref,canvasRef=(0,react.useRef)(null),[isDragging,setIsDragging]=(0,react.useState)(!1),[offset,setOffset]=(0,react.useState)({x:0,y:0}),[dragStart,setDragStart]=(0,react.useState)({x:0,y:0}),rowsRefs=(0,react.useRef)(Array(joinedFields.length).fill(null)),nodeRefs=(0,react.useRef)(Array(nodes.length).fill(null)),tableNodeRef=(0,react.useRef)(null),[nodePositions,setNodePositions]=(0,react.useState)([]),[tablePosition,setTablePosition]=(0,react.useState)({x:0,y:0}),[edges,setEdges]=(0,react.useState)([]);(0,react.useEffect)(()=>{let nodesWithDepth=assignDepths(nodes),nodePositions=calculateNodePositions(nodesWithDepth);setNodePositions(nodePositions);let tablePosition=calculateTablePosition(nodePositions);setTablePosition(tablePosition)},[nodes,fixedFields,joinedFields]),(0,react.useEffect)(()=>{let allNodes=[...nodePositions];rowsRefs.current.forEach(ref=>{let rect=ref?.getBoundingClientRect(),nodeRect=tableNodeRef.current?.getBoundingClientRect();rect&&nodeRect&&ref&&allNodes.push({nodeId:ref.id,name:"Table",position:{x:tablePosition.x,y:tablePosition.y+(rect.y-nodeRect.y)},leaf:[],depth:-1})});let calculatedEdges=calculateEdges([...nodeRefs.current,...rowsRefs.current],allNodes);setEdges(calculatedEdges)},[nodePositions,tablePosition]);let drawGrid=(ctx,canvasWidth,canvasHeight)=>{ctx.fillStyle="#000000",ctx.imageSmoothingEnabled=!0;for(let x=offset.x%10;x<canvasWidth;x+=10)for(let y=offset.y%10;y<canvasHeight;y+=10)ctx.fillRect(x,y,.5,.5)};(0,react.useEffect)(()=>{let canvas=canvasRef.current;if(canvas){let ctx=canvas.getContext("2d");if(!ctx)return;let{width,height}=canvas.getBoundingClientRect();canvas.width=width,canvas.height=height,drawGrid(ctx,width,height)}let handleResize=()=>{if(canvas){let{width,height}=canvas.getBoundingClientRect();canvas.width=width,canvas.height=height;let ctx=canvas.getContext("2d");ctx&&drawGrid(ctx,width,height)}};return window.addEventListener("resize",handleResize),()=>{window.removeEventListener("resize",handleResize)}},[offset,nodePositions]);let handleMouseUp=()=>{setIsDragging(!1)};return(0,jsx_runtime.jsxs)("div",{className:"w-full h-[100vh]",children:[(0,jsx_runtime.jsx)("canvas",{ref:canvasRef,onMouseDown:e=>{setIsDragging(!0),setDragStart({x:e.clientX-offset.x,y:e.clientY-offset.y})},onMouseMove:e=>{if(!isDragging)return;let newOffset={x:e.clientX-dragStart.x,y:e.clientY-dragStart.y};setOffset(newOffset)},onMouseUp:handleMouseUp,onMouseLeave:handleMouseUp,className:(0,clsx_m.default)("w-full h-full",isDragging?"cursor-grabbing":"cursor-grab")}),(0,jsx_runtime.jsx)("svg",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",children:edges.map((edge,index)=>{let controlPoint1X=edge.from.x+offset.x+(edge.to.x-edge.from.x)/3,controlPoint1Y=edge.from.y+offset.y,controlPoint2X=edge.to.x+offset.x-(edge.to.x-edge.from.x)/3,controlPoint2Y=edge.to.y+offset.y;return(0,jsx_runtime.jsx)("path",{d:`M ${edge.from.x+offset.x} ${edge.from.y+offset.y} 
                               C ${controlPoint1X} ${controlPoint1Y}, 
                                 ${controlPoint2X} ${controlPoint2Y}, 
                                 ${edge.to.x+offset.x} ${edge.to.y+offset.y}`,stroke:"var(--text-3000)",strokeWidth:"2",fill:"none"},index)})}),nodePositions.map((_ref2,idx)=>{let{name,position,nodeId}=_ref2;return(0,jsx_runtime.jsx)("div",{style:{position:"absolute",left:`${position.x+offset.x}px`,top:`${position.y+offset.y}px`},children:(0,jsx_runtime.jsx)(Node,{pref:el=>{nodeRefs.current[idx]=el,nodeRefs.current[idx]?.setAttribute("id",nodeId)},children:name})},nodeId)}),(0,jsx_runtime.jsx)("div",{style:{position:"absolute",left:`${tablePosition.x+offset.x}px`,top:`${tablePosition.y+offset.y}px`},children:(0,jsx_runtime.jsx)(TableFieldNode,{fixedFields:fixedFields,joinedFields:joinedFields,nodeRef:tableNodeRef,rowsRefs:rowsRefs,tableName:tableName})})]})};function TableFieldNode(_ref3){let{nodeRef,rowsRefs,fixedFields,joinedFields,tableName}=_ref3;return(0,jsx_runtime.jsx)("div",{ref:nodeRef,className:"w-[500px] bg-bg-3000 border border-black border-2 rounded-lg",children:(0,jsx_runtime.jsx)(TableFields,{fixedFields:fixedFields,joinedFields:joinedFields,rowsRefs:rowsRefs,tableName:tableName})})}let scene={component:DataModelScene,logic:dataModelSceneLogic};function DataModelScene(){let{simplifiedPersonFields,joinedFieldsAsNodes,allNodes}=(0,index_esm.useValues)(dataModelSceneLogic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(data_model_NodeCanvasWithTable,{nodes:allNodes,fixedFields:simplifiedPersonFields,joinedFields:joinedFieldsAsNodes,tableName:"persons"}),(0,jsx_runtime.jsx)(ViewLinkModal.WI,{})]})}}}]);
//# sourceMappingURL=30216.2efde231.iframe.bundle.js.map