var Ie=Object.defineProperty,Pe=Object.defineProperties;var Ne=Object.getOwnPropertyDescriptors;var ee=Object.getOwnPropertySymbols;var Ve=Object.prototype.hasOwnProperty,Be=Object.prototype.propertyIsEnumerable;var te=(p,u,a)=>u in p?Ie(p,u,{enumerable:!0,configurable:!0,writable:!0,value:a}):p[u]=a,M=(p,u)=>{for(var a in u||(u={}))Ve.call(u,a)&&te(p,a,u[a]);if(ee)for(var a of ee(u))Be.call(u,a)&&te(p,a,u[a]);return p},A=(p,u)=>Pe(p,Ne(u));var b=(p,u,a)=>new Promise((R,C)=>{var E=f=>{try{S(a.next(f))}catch(o){C(o)}},V=f=>{try{S(a.throw(f))}catch(o){C(o)}},S=f=>f.done?R(f.value):Promise.resolve(f.value).then(E,V);S((a=a.apply(p,u)).next())});(window.webpackJsonp=window.webpackJsonp||[]).push([[310],{"./frontend/src/scenes/instance/AsyncMigrations/AsyncMigrations.tsx":function(p,u,a){"use strict";a.r(u),a.d(u,"scene",function(){return pe}),a.d(u,"AsyncMigrations",function(){return X});var R=a("./node_modules/.pnpm/react@16.14.0/node_modules/react/index.js"),C=a("./frontend/src/lib/components/PageHeader.tsx"),E=a("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/tabs/index.js"),V=a("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/progress/index.js"),S=a("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/button/index.js"),f=a("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/space/index.js"),o=a("./node_modules/.pnpm/kea@3.1.0_react@16.14.0/node_modules/kea/lib/index.esm.js"),ne=a("./node_modules/.pnpm/@ant-design+icons@4.7.0_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js"),F=a("./frontend/src/lib/api.ts"),B=a("./frontend/src/scenes/userLogic.ts"),se=a("./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts"),T=a("./frontend/src/lib/components/lemonToast.tsx"),ae=a("./frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),re=a("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.0/node_modules/kea-loaders/lib/index.js"),W=a("./node_modules/.pnpm/kea-router@3.1.3_kea@3.1.0/node_modules/kea-router/lib/index.js");let g;(function(e){e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.CompletedSuccessfully=2]="CompletedSuccessfully",e[e.Errored=3]="Errored",e[e.RolledBack=4]="RolledBack",e[e.Starting=5]="Starting",e[e.FailedAtStartup=6]="FailedAtStartup"})(g||(g={}));let m;(function(e){e.Management="management",e.FutureMigrations="future",e.Settings="settings"})(m||(m={}));const ie={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},x=Object(o.kea)([Object(o.path)(["scenes","instance","AsyncMigrations","asyncMigrationsLogic"]),Object(o.connect)({values:[ae.a,["preflight"]]}),Object(o.actions)({triggerMigration:e=>({migration:e}),resumeMigration:e=>({migration:e}),rollbackMigration:e=>({migration:e}),forceStopMigration:e=>({migration:e}),forceStopMigrationWithoutRollback:e=>({migration:e}),updateMigrationStatus:(e,n,s)=>({migration:e,endpoint:n,message:s}),setActiveTab:e=>({tab:e}),updateSetting:(e,n)=>({settingKey:e,newValue:n}),loadAsyncMigrationErrors:e=>({migrationId:e}),loadAsyncMigrationErrorsSuccess:(e,n)=>({migrationId:e,errors:n}),loadAsyncMigrationErrorsFailure:(e,n)=>({migrationId:e,error:n}),openAsyncMigrationsModal:(e,n,s)=>({migration:e,endpoint:n,message:s}),closeAsyncMigrationsModal:!0}),Object(o.reducers)({activeTab:[m.Management,{setActiveTab:(e,n)=>{let{tab:s}=n;return s}}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:(e,n)=>{let{migrationId:s,errors:r}=n;return A(M({},e),{[s]:r})}}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:(e,n)=>{let{migrationId:s}=n;return A(M({},e),{[s]:!0})},loadAsyncMigrationErrorsSuccess:(e,n)=>{let{migrationId:s}=n;return A(M({},e),{[s]:!1})},loadAsyncMigrationErrorsFailure:(e,n)=>{let{migrationId:s}=n;return A(M({},e),{[s]:!1})}}],activeAsyncMigrationModal:[null,{openAsyncMigrationsModal:(e,n)=>n,closeAsyncMigrationsModal:()=>null,updateMigrationStatus:()=>null}]}),Object(re.loaders)(()=>({asyncMigrations:[[],{loadAsyncMigrations:()=>b(this,null,function*(){var e;return(e=B.a.values.user)!==null&&e!==void 0&&e.is_staff?(yield F.b.get("api/async_migrations")).results:[]})}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:()=>b(this,null,function*(){var e;return(e=B.a.values.user)!==null&&e!==void 0&&e.is_staff?(yield F.b.get("api/instance_settings")).results.filter(s=>s.key.includes("ASYNC_MIGRATIONS")):[]})}]})),Object(o.selectors)({isAnyMigrationRunning:[e=>[e.asyncMigrations],e=>e.some(n=>[g.Running,g.Starting].includes(n.status))],actionableMigrations:[e=>[e.asyncMigrations],e=>e.filter(n=>n.is_available)],futureMigrations:[e=>[e.asyncMigrations],e=>e.filter(n=>!n.is_available)]}),Object(o.listeners)(e=>{let{actions:n}=e;return{triggerMigration:s=>b(this,null,function*(){let{migration:r}=s;Object.keys(r.parameter_definitions).length>0?n.openAsyncMigrationsModal(r,"trigger","Migration triggered successfully"):n.updateMigrationStatus(r,"trigger","Migration triggered successfully")}),resumeMigration:s=>b(this,null,function*(){let{migration:r}=s;Object.keys(r.parameter_definitions).length>0?n.openAsyncMigrationsModal(r,"resume","Migration resume triggered successfully"):n.updateMigrationStatus(r,"resume","Migration resume triggered successfully")}),rollbackMigration:s=>b(this,null,function*(){let{migration:r}=s;n.updateMigrationStatus(r,"rollback","Migration rollback triggered successfully")}),forceStopMigration:s=>b(this,null,function*(){let{migration:r}=s;n.updateMigrationStatus(r,"force_stop","Force stop triggered successfully")}),forceStopMigrationWithoutRollback:s=>b(this,null,function*(){let{migration:r}=s;n.updateMigrationStatus(r,"force_stop_without_rollback","Force stop without rollback triggered successfully")}),updateMigrationStatus:s=>b(this,null,function*(){let{migration:r,endpoint:l,message:y}=s;const h=yield F.b.create(`/api/async_migrations/${r.id}/${l}`,{parameters:r.parameters});h.success?(T.d.success(y),n.loadAsyncMigrations()):T.d.error(h.error)}),updateSetting:s=>b(this,null,function*(){let{settingKey:r,newValue:l}=s;try{yield F.b.update(`/api/instance_settings/${r}`,{value:l}),T.d.success(`Instance setting ${r} updated`),n.loadAsyncMigrationSettings(),n.loadAsyncMigrations(),se.b.actions.loadSystemStatus()}catch(y){T.d.error("Failed to trigger migration")}}),loadAsyncMigrationErrors:s=>b(this,null,function*(){let{migrationId:r}=s;try{const l=yield F.b.get(`api/async_migrations/${r}/errors`);n.loadAsyncMigrationErrorsSuccess(r,l)}catch(l){n.loadAsyncMigrationErrorsFailure(r,l)}})}}),Object(o.events)(e=>{let{actions:n}=e;return{afterMount:()=>{n.loadAsyncMigrations(),n.loadAsyncMigrationSettings()}}}),Object(W.actionToUrl)(e=>{let{values:n}=e;return{setActiveTab:()=>`/instance/async_migrations${n.activeTab===m.Management?"":"/"+n.activeTab}`}}),Object(W.urlToAction)(e=>{let{actions:n,values:s}=e;return{"/instance/async_migrations(/:tab)":r=>{let{tab:l}=r;l&&l!==s.activeTab&&l!==m.Management&&n.setActiveTab(l)}}})]);var Y=a("./frontend/src/lib/components/Tooltip.tsx"),H=a("./frontend/src/lib/components/Spinner/Spinner.tsx"),oe=a("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/row/index.js"),J=a("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/col/index.js"),ce=a("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/input/index.js"),le=a("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/divider/index.js"),t=a("./node_modules/.pnpm/react@16.14.0/node_modules/react/jsx-runtime.js");function L(e){let{setting:n}=e;const{updateSetting:s}=Object(o.useActions)(x),[r,l]=Object(R.useState)(String(n.value));return Object(t.jsxs)("div",{children:[Object(t.jsx)("h4",{children:n.key}),Object(t.jsx)("p",{children:n.description}),Object(t.jsxs)(oe.a,{gutter:[8,8],children:[Object(t.jsx)(J.a,{span:8,children:Object(t.jsx)(ce.a,{value:r,onChange:y=>l(y.target.value)})}),Object(t.jsx)(J.a,{span:16,children:Object(t.jsx)(S.a,{disabled:String(n.value)===r,type:"primary",onClick:()=>s(n.key,r),children:"Update"})})]}),Object(t.jsx)(le.a,{})]},n.key)}try{L.displayName="SettingUpdateField",L.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"InstanceSetting"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:L.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(e){}var G=a("./frontend/src/lib/components/LemonTable/index.ts"),z=a("./frontend/src/lib/utils.tsx"),O=a("./frontend/src/lib/components/LemonButton/index.ts"),$=a("./frontend/src/lib/components/icons.tsx");function k(e){let{asyncMigration:n}=e;const{asyncMigrationErrorsLoading:s,asyncMigrationErrors:r}=Object(o.useValues)(x),{loadAsyncMigrationErrors:l}=Object(o.useActions)(x),y=[{title:"Error",dataIndex:"description"},{title:Object(t.jsx)(O.a,{icon:s[n.id]?Object(t.jsx)(H.a,{}):Object(t.jsx)($.IconRefresh,{}),onClick:()=>l(n.id),type:"secondary",size:"small",children:"Refresh errors"}),render:function(v,N){return Object(t.jsx)("div",{children:Object(z.O)(N.created_at)})}}];return Object(t.jsx)(G.a,{columns:y,dataSource:r[n.id],loading:s[n.id],embedded:!0})}try{k.displayName="AsyncMigrationDetails",k.__docgenInfo={description:"",displayName:"AsyncMigrationDetails",props:{asyncMigration:{defaultValue:null,description:"",name:"asyncMigration",required:!0,type:{name:"AsyncMigration"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"]={docgenInfo:k.__docgenInfo,name:"AsyncMigrationDetails",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"})}catch(e){}var Q=a("./frontend/src/lib/components/LemonButton/More.tsx"),de=a("./frontend/src/lib/components/LemonTag/LemonTag.tsx"),D=a("./node_modules/.pnpm/kea-forms@3.0.3_kea@3.1.0/node_modules/kea-forms/lib/index.js");const ue=Object(o.kea)([Object(o.path)(["scenes","instance","AsyncMigrations","asyncMigrationParameterFormLogic"]),Object(o.props)({}),Object(o.key)(e=>e.migration.id),Object(D.forms)(e=>{let{props:n}=e;return{parameters:{defaults:ge(n),submit:s=>b(this,null,function*(){x.actions.updateMigrationStatus(A(M({},n.migration),{parameters:s}),n.endpoint,n.message)})}}})]);function ge(e){const n={};return Object.keys(e.migration.parameter_definitions).forEach(s=>{e.migration.parameters[s]?n[s]=e.migration.parameters[s]:n[s]=e.migration.parameter_definitions[s][0]}),n}var me=a("./frontend/src/lib/components/LemonInput/LemonInput.tsx"),je=a("./frontend/src/lib/components/AnimatedCollapsible.tsx"),I=a("./frontend/src/lib/components/LemonModal/index.ts");function P(e){const{closeAsyncMigrationsModal:n}=Object(o.useActions)(x),[s,r]=Object(R.useState)(!0);return Object(t.jsx)(I.a,{title:"",onClose:n,isOpen:!0,simple:!0,children:Object(t.jsxs)(D.Form,{logic:ue,props:e,formKey:"parameters",enableFormOnSubmit:!0,id:"async-migration-parameters-form",className:"LemonModal__layout",children:[Object(t.jsx)(I.a.Header,{children:Object(t.jsx)("h3",{children:"Advanced migration configuration"})}),Object(t.jsxs)(I.a.Content,{children:[Object(t.jsxs)("p",{children:["This async migration allows tuning parameters used in the async migration.",s&&Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("br",{}),Object(t.jsx)("a",{onClick:()=>{r(!s)},children:"Click here to show advanced configuration."})]})]}),Object(t.jsx)(je.a,{collapsed:s,children:Object.entries(e.migration.parameter_definitions).map(l=>{let[y,[h,v]]=l;return Object(t.jsx)(D.Field,{name:y,label:Object(t.jsx)(t.Fragment,{children:v}),children:Object(t.jsx)(me.a,{type:typeof h=="number"?"number":"text"})},y)})})]}),Object(t.jsxs)(I.a.Footer,{children:[Object(t.jsx)(O.a,{form:"async-migration-parameters-form",type:"secondary","data-attr":"async-migration-parameters-cancel",className:"mr-2",onClick:n,children:"Cancel"}),Object(t.jsx)(O.a,{form:"async-migration-parameters-form",htmlType:"submit",type:"primary","data-attr":"async-migration-parameters-submit",children:"Run migration"})]})]})})}try{P.displayName="AsyncMigrationParametersModal",P.__docgenInfo={description:"",displayName:"AsyncMigrationParametersModal",props:{migration:{defaultValue:null,description:"",name:"migration",required:!0,type:{name:"AsyncMigration"}},endpoint:{defaultValue:null,description:"",name:"endpoint",required:!0,type:{name:"string"}},message:{defaultValue:null,description:"",name:"message",required:!0,type:{name:"string"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationParametersModal.tsx#AsyncMigrationParametersModal"]={docgenInfo:P.__docgenInfo,name:"AsyncMigrationParametersModal",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationParametersModal.tsx#AsyncMigrationParametersModal"})}catch(e){}const{TabPane:U}=E.a,pe={component:X,logic:x},ye=3e3;function X(){const{user:e}=Object(o.useValues)(B.a),{asyncMigrationsLoading:n,activeTab:s,asyncMigrationSettings:r,isAnyMigrationRunning:l,activeAsyncMigrationModal:y,actionableMigrations:h,futureMigrations:v}=Object(o.useValues)(x),{triggerMigration:N,resumeMigration:be,rollbackMigration:fe,forceStopMigration:Oe,forceStopMigrationWithoutRollback:xe,loadAsyncMigrations:Z,loadAsyncMigrationErrors:he,setActiveTab:Me}=Object(o.useActions)(x);Object(R.useEffect)(()=>{if(l){const d=setInterval(()=>Z(),ye);return()=>clearInterval(d)}},[l]);const q={title:"Migration",render:function(j,i){const c="https://github.com/PostHog/posthog/blob/master/posthog/async_migrations/migrations/"+i.name+".py";return Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("div",{className:"row-name",children:Object(t.jsx)("a",{href:c,children:i.name})}),Object(t.jsx)("div",{className:"row-description",children:i.description})]})}},Se={title:"Progress",render:function(j,i){const c=i.progress;return Object(t.jsx)("div",{children:Object(t.jsx)(V.a,{percent:c})})}},_={title:"Status",render:function(j,i){const c=i.status,ke=c===g.Running?"success":c===g.Errored||c===g.FailedAtStartup?"danger":c===g.Starting||c===g.RolledBack?"warning":"default";return Object(t.jsx)(de.a,{type:ke,className:"uppercase",children:ie[c]})}},ve={title:"Last operation index",render:function(j,i){return Object(t.jsx)("div",{children:i.current_operation_index})}},Ae={title:"Last query ID",render:function(j,i){return Object(t.jsx)("div",{children:Object(t.jsx)("small",{children:i.current_query_id})})}},Re={title:"Started at",render:function(j,i){const c=i.started_at;return Object(t.jsx)("div",{children:Object(z.O)(c)})}},Ce={title:"Finished at",render:function(j,i){const c=i.finished_at;return Object(t.jsx)("div",{children:Object(z.O)(c)})}},Fe={title:"",render:function(j,i){const c=i.status;return Object(t.jsx)("div",{children:c===g.NotStarted||c===g.FailedAtStartup?Object(t.jsx)(Y.a,{title:"Start",children:Object(t.jsx)(S.a,{type:"link",icon:Object(t.jsx)(ne.a,{}),onClick:()=>N(i),children:"Run"})}):c===g.Starting||c===g.Running?Object(t.jsx)(Q.a,{overlay:Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)(O.a,{status:"stealth",onClick:()=>Oe(i),fullWidth:!0,children:"Stop and rollback"}),Object(t.jsx)(O.a,{status:"stealth",onClick:()=>xe(i),fullWidth:!0,children:"Stop"})]})}):c===g.CompletedSuccessfully?Object(t.jsx)(t.Fragment,{}):c===g.Errored?Object(t.jsx)(Q.a,{overlay:Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)(O.a,{status:"stealth",onClick:()=>be(i),fullWidth:!0,children:"Resume"}),Object(t.jsx)(O.a,{status:"stealth",onClick:()=>fe(i),fullWidth:!0,children:"Rollback"})]})}):c===g.RolledBack?Object(t.jsx)(Y.a,{title:"Restart",children:Object(t.jsx)(O.a,{status:"stealth",icon:Object(t.jsx)($.IconReplay,{}),onClick:()=>N(i),fullWidth:!0})}):null})}},Ee={title:"Minimum PostHog version",render:function(j,i){return Object(t.jsx)("div",{children:i.posthog_min_version})}},Te={title:"Maximum PostHog version",render:function(j,i){return Object(t.jsx)("div",{children:i.posthog_max_version})}},w={};w[m.FutureMigrations]=[q,_,Ee,Te],w[m.Management]=[q,Se,_,ve,Ae,Re,Ce,Fe];const K={};K[m.FutureMigrations]=v,K[m.Management]=h;const Le={expandedRowRender:function(j){return j&&Object(t.jsx)(k,{asyncMigration:j})},rowExpandable:d=>d.error_count>0,onRowExpand:function(j){he(j.id)}};return Object(t.jsx)("div",{children:e!=null&&e.is_staff?Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)(C.a,{title:"Async Migrations",caption:Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("p",{children:"Manage async migrations in your instance."}),Object(t.jsxs)("p",{children:["Read about async migrations on our"," ",Object(t.jsx)("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations/overview",children:"dedicated docs page"}),"."]})]})}),Object(t.jsxs)(E.a,{activeKey:s,onTabClick:d=>Me(d),children:[Object(t.jsx)(U,{tab:`Management (${h.length})`},m.Management),v.length>0&&Object(t.jsx)(U,{tab:`Future Migrations (${v.length})`},m.FutureMigrations),Object(t.jsx)(U,{tab:"Settings"},m.Settings)]}),[m.Management,m.FutureMigrations].includes(s)?Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("div",{className:"mb-4 float-right",children:Object(t.jsx)(O.a,{icon:n?Object(t.jsx)(H.a,{}):Object(t.jsx)($.IconRefresh,{}),onClick:Z,type:"secondary",size:"small",children:"Refresh"})}),Object(t.jsx)(f.b,{}),Object(t.jsx)(G.a,{pagination:{pageSize:10},loading:n,columns:w[s],dataSource:K[s],expandable:Le}),y?Object(t.jsx)(P,M({},y)):null]}):s===m.Settings?Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("br",{}),r.map(d=>Object(t.jsx)("div",{children:Object(t.jsx)(L,{setting:d})},d.key))]}):null]}):Object(t.jsx)(C.a,{title:"Async Migrations",caption:Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("p",{children:"Only users with staff access can manage async migrations. Please contact your instance admin."}),Object(t.jsxs)("p",{children:["If you're an admin and don't have access, set ",Object(t.jsx)("code",{children:"is_staff=true"})," for your user on the PostgreSQL ",Object(t.jsx)("code",{children:"posthog_user"})," table."]})]})})})}}}]);
