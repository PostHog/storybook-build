"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[3192],{"../../frontend/src/lib/components/Subscriptions/SubscriptionsModal.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{r:()=>SubscriptionsModal});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),LemonModal=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonModal/index.ts"),Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/Spinner.tsx"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),types=__webpack_require__("../../frontend/src/types.ts"),PayGateMini=__webpack_require__("../../frontend/src/lib/components/PayGateMini/PayGateMini.tsx"),utils=__webpack_require__("../../frontend/src/lib/components/Subscriptions/utils.tsx"),kea_forms_lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),UserActivityIndicator=__webpack_require__("../../frontend/src/lib/components/UserActivityIndicator/UserActivityIndicator.tsx"),UserSelectItem=__webpack_require__("../../frontend/src/lib/components/UserSelectItem.tsx"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),SlackIntegrationHelpers=__webpack_require__("../../frontend/src/lib/integrations/SlackIntegrationHelpers.tsx"),integrationsLogic=__webpack_require__("../../frontend/src/lib/integrations/integrationsLogic.ts"),LemonBanner=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonBanner/index.ts"),lemon_ui_LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonInputSelect=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonInputSelect/LemonInputSelect.tsx"),LemonLabel=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonLabel/LemonLabel.tsx"),LemonSelect=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSelect/index.ts"),LemonSkeleton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSkeleton/index.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),preflightLogic=__webpack_require__("../../frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),membersLogic=__webpack_require__("../../frontend/src/scenes/organization/membersLogic.tsx"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/LemonToast.tsx"),lib_utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),insights_utils=__webpack_require__("../../frontend/src/scenes/insights/utils.tsx"),deleteWithUndo=__webpack_require__("../../frontend/src/lib/utils/deleteWithUndo.tsx");let subscriptionsLogic=(0,index_esm.kea)([(0,index_esm.path)(["lib","components","Subscriptions","subscriptionsLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{insightShortId,dashboardId}=_ref;return insightShortId?`insight-${insightShortId}`:dashboardId?`dashboard-${dashboardId}`:"subscriptions"}),(0,index_esm.actions)({deleteSubscription:id=>({id})}),(0,kea_loaders_lib.loaders)(_ref2=>{let{props}=_ref2;return{subscriptions:{__default:[],loadSubscriptions:async(_,breakpoint)=>{if(!props.dashboardId&&!props.insightShortId)return[];breakpoint?.();let insightId=props.insightShortId?await (0,insights_utils.gI)(props.insightShortId):void 0,response=await api.ZP.subscriptions.list({dashboardId:props.dashboardId,insightId:insightId});return breakpoint?.(),response.results}}}}),(0,index_esm.reducers)({subscriptions:{deleteSubscription:(state,_ref3)=>{let{id}=_ref3;return state.filter(a=>a.id!==id)}}}),(0,index_esm.listeners)(_ref4=>{let{actions}=_ref4;return{deleteSubscription:async _ref5=>{let{id}=_ref5;await (0,deleteWithUndo.S)({endpoint:api.ZP.subscriptions.determineDeleteEndpoint(),object:{name:"Subscription",id},callback:()=>actions.loadSubscriptions()})}}}),(0,index_esm.afterMount)(_ref6=>{let{actions}=_ref6;return actions.loadSubscriptions()})]),NEW_SUBSCRIPTION={frequency:"weekly",interval:1,start_date:(0,dayjs.Bv)().hour(9).minute(0).second(0).toISOString(),target_type:"email",byweekday:["monday"],bysetpos:1},subscriptionLogic=(0,index_esm.kea)([(0,index_esm.path)(["lib","components","Subscriptions","subscriptionLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id,insightShortId,dashboardId}=_ref;return`${insightShortId||dashboardId}-${null!=id?id:"new"}`}),(0,kea_loaders_lib.loaders)(_ref2=>{let{props}=_ref2;return{subscription:{__default:void 0,loadSubscription:async()=>props.id&&"new"!==props.id?await api.ZP.subscriptions.get(props.id):{...NEW_SUBSCRIPTION}}}}),(0,kea_forms_lib.forms)(_ref3=>{let{props,actions}=_ref3;return{subscription:{defaults:{},errors:_ref4=>{let{frequency,interval,target_value,target_type,title,start_date}=_ref4;return{frequency:frequency?void 0:"You need to set a schedule frequency",title:title?void 0:"You need to give your subscription a name",interval:interval?void 0:"You need to set an interval",start_date:start_date?void 0:"You need to set a delivery time",target_type:["slack","email","webhook"].includes(target_type)?void 0:"Unsupported target type",target_value:target_value?"email"==target_type?target_value?target_value.split(",").every(email=>(0,lib_utils.Jh)(email))?void 0:"All emails must be valid":"At least one email is required":"slack"==target_type?target_value?void 0:"A channel is required":"webhook"==target_type?(0,lib_utils.PX)(target_value)?void 0:"Must be a valid URL":void 0:"This field is required."}},submit:async(subscription,breakpoint)=>{let insightId=props.insightShortId?await (0,insights_utils.gI)(props.insightShortId):void 0,payload={...subscription,insight:insightId,dashboard:props.dashboardId};breakpoint();let updatedSub="new"===props.id?await api.ZP.subscriptions.create(payload):await api.ZP.subscriptions.update(props.id,payload);return actions.resetSubscription(),updatedSub.id!==props.id&&lib.router.actions.replace((0,utils.RJ)(updatedSub.id,props)),subscriptionsLogic.findMounted(props)?.actions.loadSubscriptions(),actions.loadSubscriptionSuccess(updatedSub),LemonToast.UJ.success("Subscription saved."),updatedSub}}}}),(0,index_esm.listeners)(_ref5=>{let{actions}=_ref5;return{setSubscriptionValue:_ref6=>{let{name,value}=_ref6,key=Array.isArray(name)?name[0]:name;"frequency"===key&&("daily"===value?actions.setSubscriptionValues({bysetpos:null,byweekday:null}):actions.setSubscriptionValues({bysetpos:NEW_SUBSCRIPTION.bysetpos,byweekday:NEW_SUBSCRIPTION.byweekday})),"target_type"===key&&actions.setSubscriptionValues({target_value:""})}}}),(0,lib.beforeUnload)(_ref7=>{let{actions,values}=_ref7;return{enabled:()=>values.subscriptionChanged,message:"Changes you made will be discarded.",onConfirm:()=>{actions.resetSubscription()}}}),(0,lib.urlToAction)(_ref8=>{let{actions}=_ref8;return{"/*/*/subscriptions/new":(_,searchParams)=>{actions.loadSubscriptionSuccess({...NEW_SUBSCRIPTION}),searchParams.target_type&&actions.setSubscriptionValue("target_type",searchParams.target_type)},"/*/*/subscriptions/:id":()=>{actions.loadSubscription()}}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function EditSubscription(_ref){let{id,insightShortId,dashboardId,onCancel,onDelete}=_ref,logicProps={id,insightShortId,dashboardId},logic=subscriptionLogic(logicProps),subscriptionslogic=subscriptionsLogic({insightShortId,dashboardId}),{meFirstMembers,membersLoading}=(0,index_esm.useValues)(membersLogic.m),{subscription,subscriptionLoading,isSubscriptionSubmitting,subscriptionChanged}=(0,index_esm.useValues)(logic),{preflight,siteUrlMisconfigured}=(0,index_esm.useValues)(preflightLogic.preflightLogic),{deleteSubscription}=(0,index_esm.useActions)(subscriptionslogic),{slackIntegrations}=(0,index_esm.useValues)(integrationsLogic.a),firstSlackIntegration=slackIntegrations?.[0],emailDisabled=!preflight?.email_service_available,parts=new Intl.DateTimeFormat("en-US",{timeZoneName:"shortGeneric"}).formatToParts(new Date),currentTimezone=parts?.find(part=>"timeZoneName"===part.type)?.value;return(0,jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:subscriptionLogic,props:logicProps,formKey:"subscription",enableFormOnSubmit:!0,className:"LemonModal__layout",children:[(0,jsx_runtime.jsx)(LemonModal.f.Header,{children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(lemon_ui_LemonButton.J,{icon:(0,jsx_runtime.jsx)(icons.ed,{}),onClick:onCancel,size:"xsmall"}),(0,jsx_runtime.jsxs)("h3",{children:["new"===id?"New":"Edit "," Subscription"]})]})}),(0,jsx_runtime.jsx)(LemonModal.f.Content,{className:"deprecated-space-y-2",children:subscription?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[subscription?.created_by?(0,jsx_runtime.jsx)(UserActivityIndicator.F,{at:subscription.created_at,by:subscription.created_by,prefix:"Created",className:"mb-4"}):null,siteUrlMisconfigured&&(0,jsx_runtime.jsx)(LemonBanner.V,{type:"warning",children:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Your ",(0,jsx_runtime.jsx)("code",{children:"SITE_URL"})," environment variable seems misconfigured. Your"," ",(0,jsx_runtime.jsx)("code",{children:"SITE_URL"})," is set to"," ",(0,jsx_runtime.jsx)("b",{children:(0,jsx_runtime.jsx)("code",{children:preflight?.site_url})})," ","but you're currently browsing this page from"," ",(0,jsx_runtime.jsx)("b",{children:(0,jsx_runtime.jsx)("code",{children:window.location.origin})}),". ",(0,jsx_runtime.jsx)("br",{}),"If this value is not configured correctly PostHog may be unable to correctly send Subscriptions."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/configuring-posthog/environment-variables?utm_medium=in-product&utm_campaign=subcriptions-system-status-site-url-misconfig",target:"_blank",targetBlankIcon:!0,children:"Learn more"})]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"title",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. Weekly team report"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"target_type",label:"Destination",children:(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:utils.gz})}),"email"===subscription.target_type?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[emailDisabled&&(0,jsx_runtime.jsx)(LemonBanner.V,{type:"error",children:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Email subscriptions are not currently possible as this PostHog instance isn't"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/self-host/configure/email",target:"_blank",targetBlankIcon:!0,children:"configured to send emails "}),"."]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"target_value",label:"Who do you want to subscribe",help:"Enter the email addresses of the users you want to share with",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(LemonInputSelect.n,{onChange:val=>onChange(val.join(",")),value:value?.split(",").filter(Boolean),disabled:emailDisabled,mode:"multiple",allowCustomValues:!0,"data-attr":"subscribed-emails",options:(0,UserSelectItem.W)(meFirstMembers.map(x=>x.user)),loading:membersLoading,placeholder:"Enter an email address"})}}),(0,jsx_runtime.jsx)(LemonField.D,{name:"invite_message",label:"Message",showOptional:!0,children:(0,jsx_runtime.jsx)(src._V,{placeholder:"Your message to new subscribers (optional)"})})]}):null,"slack"===subscription.target_type?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:firstSlackIntegration?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(LemonField.D,{name:"target_value",label:"Which Slack channel to send reports to",help:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Private channels are only shown if you have"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/webhooks/slack",target:"_blank",children:"added the PostHog Slack App"})," ","to them. You can also paste the channel ID (e.g."," ",(0,jsx_runtime.jsx)("code",{children:"C1234567890"}),") to search for channels."]}),children:_ref3=>{let{value,onChange}=_ref3;return(0,jsx_runtime.jsx)(SlackIntegrationHelpers.a,{value:value,onChange:onChange,integration:firstSlackIntegration})}})}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(LemonBanner.V,{type:"info",children:(0,jsx_runtime.jsxs)("div",{className:"flex justify-between gap-2",children:[(0,jsx_runtime.jsx)("span",{children:"Slack is not yet configured for this project. Add PostHog to your Slack workspace to continue."}),(0,jsx_runtime.jsx)(src.rU,{to:api.ZP.integrations.authorizeUrl({kind:"slack",next:window.location.pathname+"?target_type=slack"}),disableClientSideRouting:!0,children:(0,jsx_runtime.jsx)("img",{alt:"Add to Slack",height:"40",width:"139",src:"https://platform.slack-edge.com/img/add_to_slack.png",srcSet:"https://platform.slack-edge.com/img/add_to_slack.png 1x, https://platform.slack-edge.com/img/add_to_slack@2x.png 2x"})})]})})})}):null,"webhook"===subscription.target_type?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"target_value",label:"Webhook URL",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"https://example.com/webhooks/1234"})}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary mt-2",children:"Webhooks will be called with a HTTP POST request. The webhook endpoint should respond with a healthy HTTP code (2xx)."})]}):null,(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-baseline justify-between w-full",children:[(0,jsx_runtime.jsx)(LemonLabel.H,{className:"mb-2",children:"Recurrence"}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary text-right",children:currentTimezone})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center rounded border p-2 flex-wrap",children:[(0,jsx_runtime.jsx)("span",{children:"Send every"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"interval",children:(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:utils.hq})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"frequency",children:(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:1===subscription.interval?utils.nh:utils.ox})}),"weekly"===subscription.frequency&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("span",{children:"on"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"byweekday",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:utils.H3,value:value?value[0]:null,onChange:val=>onChange([val])})}})]}),"monthly"===subscription.frequency&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("span",{children:"on the"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"bysetpos",children:_ref5=>{let{value,onChange}=_ref5;return(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:utils.Go,value:value?String(value):null,onChange:val=>{onChange("string"==typeof val?parseInt(val,10):null)}})}}),(0,jsx_runtime.jsx)(LemonField.D,{name:"byweekday",children:_ref6=>{let{value,onChange}=_ref6;return(0,jsx_runtime.jsx)(LemonSelect.Yv,{dropdownMatchSelectWidth:!1,options:utils.EE,value:value?1===value.length?value[0]:"day":null,onChange:val=>onChange("day"===val?Object.values(utils.H3).map(v=>v.value):[val])})}})]}),(0,jsx_runtime.jsx)("span",{children:"by"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"start_date",children:_ref7=>{let{value,onChange}=_ref7;return(0,jsx_runtime.jsx)(LemonSelect.Yv,{options:utils.qr,value:(0,dayjs.Bv)(value).hour().toString(),onChange:val=>{onChange((0,dayjs.Bv)().hour("string"==typeof val?parseInt(val,10):0).minute(0).second(0).toISOString())}})}})]})]})]}):subscriptionLoading?(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"w-1/2 h-4"}),(0,jsx_runtime.jsx)(LemonSkeleton.y.Row,{}),(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"w-1/2 h-4"}),(0,jsx_runtime.jsx)(LemonSkeleton.y.Row,{}),(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"w-1/2 h-4"}),(0,jsx_runtime.jsx)(LemonSkeleton.y.Row,{})]}):(0,jsx_runtime.jsxs)("div",{className:"p-4 text-center",children:[(0,jsx_runtime.jsx)("h2",{children:"Not found"}),(0,jsx_runtime.jsx)("p",{children:"This subscription could not be found. It may have been deleted."})]})}),(0,jsx_runtime.jsxs)(LemonModal.f.Footer,{children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:subscription&&"new"!==id&&(0,jsx_runtime.jsx)(lemon_ui_LemonButton.J,{type:"secondary",status:"danger",onClick:()=>{"new"!==id&&(deleteSubscription(id),onDelete())},disabled:subscriptionLoading,children:"Delete subscription"})}),(0,jsx_runtime.jsx)(lemon_ui_LemonButton.J,{type:"secondary",onClick:onCancel,children:"Cancel"}),(0,jsx_runtime.jsx)(lemon_ui_LemonButton.J,{type:"primary",htmlType:"submit",loading:isSubscriptionSubmitting,disabled:!subscriptionChanged||subscriptionLoading,children:"new"===id?"Create subscription":"Save"})]})]})}var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.33.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),ProfilePicture=__webpack_require__("../../frontend/src/lib/lemon-ui/ProfilePicture/index.ts");function SubscriptionListItem(_ref){let{subscription,onClick,onDelete}=_ref;return(0,jsx_runtime.jsx)(lemon_ui_LemonButton.J,{type:"secondary",onClick:onClick,"data-attr":"subscription-list-item",fullWidth:!0,sideAction:{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{}),dropdown:{overlay:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:onDelete&&(0,jsx_runtime.jsx)(lemon_ui_LemonButton.J,{onClick:onDelete,"data-attr":"subscription-list-item-delete",status:"danger",fullWidth:!0,children:"Delete Subscription"})})}},children:(0,jsx_runtime.jsxs)("div",{className:"flex justify-between flex-auto items-center p-2",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"text-link font-medium",children:subscription.title}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-text-3000",children:(0,lib_utils.fm)(subscription.summary)})]}),"email"===subscription.target_type?(0,jsx_runtime.jsx)(ProfilePicture.r,{limit:4,people:subscription.target_value.split(",").map(email=>({email}))}):null,"slack"===subscription.target_type?(0,jsx_runtime.jsx)(icons.gx,{}):null]})})}function ManageSubscriptions(_ref2){let{insightShortId,dashboardId,onCancel,onSelect}=_ref2,logic=subscriptionsLogic({insightShortId,dashboardId}),{subscriptions,subscriptionsLoading}=(0,index_esm.useValues)(logic),{deleteSubscription}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonModal.f.Header,{children:(0,jsx_runtime.jsx)("h3",{children:" Manage Subscriptions"})}),(0,jsx_runtime.jsx)(LemonModal.f.Content,{children:subscriptionsLoading&&!subscriptions.length?(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"w-1/2 h-4"}),(0,jsx_runtime.jsx)(LemonSkeleton.y.Row,{repeat:2})]}):subscriptions.length?(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("strong",{children:subscriptions?.length})," active ",(0,lib_utils.Zi)(subscriptions.length||0,"subscription","subscriptions",!1)]}),subscriptions.map(sub=>(0,jsx_runtime.jsx)(SubscriptionListItem,{subscription:sub,onClick:()=>onSelect(sub.id),onDelete:()=>deleteSubscription(sub.id)},sub.id))]}):(0,jsx_runtime.jsxs)("div",{className:"flex flex-col p-4 items-center text-center",children:[(0,jsx_runtime.jsx)("h3",{children:"There are no subscriptions for this insight"}),(0,jsx_runtime.jsx)("p",{children:"Once subscriptions are created they will display here. "}),(0,jsx_runtime.jsx)(lemon_ui_LemonButton.J,{type:"primary",onClick:()=>onSelect("new"),children:"Add subscription"})]})}),(0,jsx_runtime.jsxs)(LemonModal.f.Footer,{children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:subscriptions.length?(0,jsx_runtime.jsx)(lemon_ui_LemonButton.J,{type:"secondary",onClick:()=>onSelect("new"),children:"Add subscription"}):null}),(0,jsx_runtime.jsx)(lemon_ui_LemonButton.J,{type:"secondary",onClick:onCancel,children:"Close"})]})]})}function SubscriptionsModal(props){let{closeModal,dashboardId,insightShortId,subscriptionId,isOpen,inline}=props,{push}=(0,index_esm.useActions)(lib.router),{userLoading}=(0,index_esm.useValues)(userLogic.userLogic);return userLoading?(0,jsx_runtime.jsx)(Spinner.$,{className:"text-2xl"}):(0,jsx_runtime.jsx)(LemonModal.f,{onClose:closeModal,isOpen:isOpen,width:600,simple:!0,title:"",inline:inline,children:(0,jsx_runtime.jsx)(PayGateMini.E,{feature:types.P$.SUBSCRIPTIONS,handleSubmit:closeModal,background:!1,className:"py-8",docsLink:"https://posthog.com/docs/user-guides/subscriptions",children:subscriptionId?(0,jsx_runtime.jsx)(EditSubscription,{id:subscriptionId,insightShortId:insightShortId,dashboardId:dashboardId,onCancel:()=>push((0,utils.h$)(props)),onDelete:()=>push((0,utils.h$)(props))}):(0,jsx_runtime.jsx)(ManageSubscriptions,{insightShortId:insightShortId,dashboardId:dashboardId,onCancel:closeModal,onSelect:id=>push((0,utils.RJ)(id,props))})})})}},"../../frontend/src/lib/components/Subscriptions/utils.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{EE:()=>monthlyWeekdayOptions,Go:()=>bysetposOptions,H3:()=>weekdayOptions,RJ:()=>urlForSubscription,gz:()=>targetTypeOptions,h$:()=>urlForSubscriptions,hq:()=>intervalOptions,nh:()=>frequencyOptionsSingular,ox:()=>frequencyOptionsPlural,qr:()=>timeOptions});var _posthog_icons__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.33.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),lib_lemon_ui_icons__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/utils.tsx"),scenes_urls__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/scenes/urls.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let urlForSubscriptions=_ref=>{let{dashboardId,insightShortId}=_ref;return insightShortId?scenes_urls__WEBPACK_IMPORTED_MODULE_3__.j.insightSubcriptions(insightShortId):dashboardId?scenes_urls__WEBPACK_IMPORTED_MODULE_3__.j.dashboardSubscriptions(dashboardId):""},urlForSubscription=(id,_ref2)=>{let{dashboardId,insightShortId}=_ref2;return insightShortId?scenes_urls__WEBPACK_IMPORTED_MODULE_3__.j.insightSubcription(insightShortId,id.toString()):dashboardId?scenes_urls__WEBPACK_IMPORTED_MODULE_3__.j.dashboardSubscription(dashboardId,id.toString()):""},targetTypeOptions=[{value:"email",label:"Email",icon:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconLetter,{})},{value:"slack",label:"Slack",icon:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)(lib_lemon_ui_icons__WEBPACK_IMPORTED_MODULE_1__.gx,{})}],intervalOptions=(0,lib_utils__WEBPACK_IMPORTED_MODULE_2__.w6)(1,13).map(x=>({value:x,label:x.toString()})),frequencyOptionsSingular=[{value:"daily",label:"day"},{value:"weekly",label:"week"},{value:"monthly",label:"month"}],frequencyOptionsPlural=[{value:"daily",label:"days"},{value:"weekly",label:"weeks"},{value:"monthly",label:"months"}],weekdayOptions=[{value:"monday",label:"Monday"},{value:"tuesday",label:"Tuesday"},{value:"wednesday",label:"Wednesday"},{value:"thursday",label:"Thursday"},{value:"friday",label:"Friday"},{value:"saturday",label:"Saturday"},{value:"sunday",label:"Sunday"}],monthlyWeekdayOptions=[...weekdayOptions,{value:"day",label:"day"}],bysetposOptions=[{value:"1",label:"first"},{value:"2",label:"second"},{value:"3",label:"third"},{value:"4",label:"fourth"},{value:"-1",label:"last"}],timeOptions=(0,lib_utils__WEBPACK_IMPORTED_MODULE_2__.w6)(0,24).map(x=>({value:String(x),label:`${String(x).padStart(2,"0")}:00`}))},"../../frontend/src/lib/integrations/SlackIntegrationHelpers.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{a:()=>SlackChannelPicker});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),usePeriodicRerender=__webpack_require__("../../frontend/src/lib/hooks/usePeriodicRerender.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),preflightLogic=__webpack_require__("../../frontend/src/scenes/PreflightCheck/preflightLogic.tsx");let slackIntegrationLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>props.id),(0,index_esm.path)(key=>["lib","integrations","slackIntegrationLogic",key]),(0,index_esm.connect)(()=>({values:[preflightLogic.preflightLogic,["siteUrlMisconfigured","preflight"]]})),(0,index_esm.actions)({loadAllSlackChannels:function(){let forceRefresh=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return{forceRefresh}},loadSlackChannelById:channelId=>({channelId})}),(0,lib.loaders)(_ref=>{let{props}=_ref;return{allSlackChannels:[null,{loadAllSlackChannels:async _ref2=>{let{forceRefresh}=_ref2;return await api.ZP.integrations.slackChannels(props.id,forceRefresh)}}],slackChannelById:[null,{loadSlackChannelById:async(_ref3,breakpoint)=>{let{channelId}=_ref3;return await breakpoint(500),(await api.ZP.integrations.slackChannelsById(props.id,channelId)).channels[0]||null}}]}}),(0,index_esm.reducers)({_fetchedSlackChannels:[[],{loadAllSlackChannelsSuccess:(_,_ref4)=>{var _allSlackChannels$cha;let{allSlackChannels}=_ref4;return null!==(_allSlackChannels$cha=allSlackChannels.channels)&&void 0!==_allSlackChannels$cha?_allSlackChannels$cha:[]}}],_fetchedSlackChannelById:[null,{loadSlackChannelByIdSuccess:(_,_ref5)=>{let{slackChannelById}=_ref5;return slackChannelById}}]}),(0,index_esm.selectors)({slackChannels:[s=>[s._fetchedSlackChannels,s._fetchedSlackChannelById],(_fetchedSlackChannels,_fetchedSlackChannelById)=>{let channels=[..._fetchedSlackChannels];return _fetchedSlackChannelById&&!channels.find(x=>x.id===_fetchedSlackChannelById.id)&&channels.push(_fetchedSlackChannelById),channels}],isMemberOfSlackChannel:[s=>[s.slackChannels],slackChannels=>channel=>{var _slackChannels$find$i;let[channelId]=channel.split("|");return null!==(_slackChannels$find$i=slackChannels.find(x=>x.id===channelId)?.is_member)&&void 0!==_slackChannels$find$i&&_slackChannels$find$i}],isPrivateChannelWithoutAccess:[s=>[s.slackChannels],slackChannels=>channel=>{var _slackChannels$find$i2;let[channelId]=channel.split("|");return null!==(_slackChannels$find$i2=slackChannels.find(x=>x.id===channelId)?.is_private_without_access)&&void 0!==_slackChannels$find$i2&&_slackChannels$find$i2}],getChannelRefreshButtonDisabledReason:[s=>[s.allSlackChannels],allSlackChannels=>()=>{let now=(0,dayjs.Bv)();if(allSlackChannels){let earliestRefresh=(0,dayjs.Bv)(allSlackChannels.lastRefreshedAt).add(5,"minutes");if(now.isBefore(earliestRefresh))return`You can refresh the channels again ${earliestRefresh.from(now)}`}return""}]})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let getSlackChannelOptions=slackChannels=>slackChannels?slackChannels.map(x=>{let name=x.is_private_without_access?"Private Channel":x.name,displayLabel=`${x.is_private?"🔒":"#"}${name} (${x.id})`;return{key:`${x.id}|#${x.name}`,labelComponent:(0,jsx_runtime.jsxs)("span",{className:"flex items-center",children:[(0,jsx_runtime.jsx)("span",{children:displayLabel}),(0,jsx_runtime.jsx)("span",{children:x.is_ext_shared?(0,jsx_runtime.jsx)(icons.Zf,{className:"ml-2"}):null})]}),label:displayLabel}}):null;function SlackChannelPicker(_ref){var _slackChannelOptions,_modifiedValue$split$;let{onChange,value,integration,disabled}=_ref,{slackChannels,allSlackChannelsLoading,slackChannelByIdLoading,isMemberOfSlackChannel,isPrivateChannelWithoutAccess,getChannelRefreshButtonDisabledReason}=(0,index_esm.useValues)(slackIntegrationLogic({id:integration.id})),{loadAllSlackChannels,loadSlackChannelById}=(0,index_esm.useActions)(slackIntegrationLogic({id:integration.id})),[localValue,setLocalValue]=(0,react.useState)(null);(0,usePeriodicRerender.o)(15e3);let rawSlackChannelOptions=(0,react.useMemo)(()=>getSlackChannelOptions(slackChannels),[slackChannels]),showSlackMembershipWarning=value&&!1===isMemberOfSlackChannel(value),modifiedValue=(0,react.useMemo)(()=>{if(value?.split("|").length===1){let channel=slackChannels.find(x=>x.id===value);if(channel)return`${channel.id}|#${channel.name}`}return value},[value,slackChannels]);return(0,react.useEffect)(()=>{disabled||loadAllSlackChannels()},[loadAllSlackChannels,disabled]),(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.nt,{onChange:val=>{var _val$;return onChange?.(null!==(_val$=val[0])&&void 0!==_val$?_val$:null)},onInputChange:val=>{val&&(loadSlackChannelById(val),setLocalValue(val))},value:modifiedValue?[modifiedValue]:[],onFocus:()=>!slackChannels.length&&!allSlackChannelsLoading&&loadAllSlackChannels(),disabled:disabled,mode:"single","data-attr":"select-slack-channel",placeholder:"Select a channel...",action:{children:(0,jsx_runtime.jsx)("span",{className:"Link",children:"Refresh channels"}),onClick:()=>loadAllSlackChannels(!0),disabledReason:getChannelRefreshButtonDisabledReason()},emptyStateComponent:(0,jsx_runtime.jsxs)("p",{className:"text-secondary italic p-1",children:["No channels found. Make sure the PostHog Slack App is installed in the channel."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/cdp/destinations/slack",target:"_blank",children:"See the docs for more information."})]}),options:null!==(_slackChannelOptions=rawSlackChannelOptions?rawSlackChannelOptions.filter(x=>{let[id]=x.key.split("|#");return!isPrivateChannelWithoutAccess(id)||id===value||id===localValue}):[])&&void 0!==_slackChannelOptions?_slackChannelOptions:modifiedValue?[{key:modifiedValue,label:null!==(_modifiedValue$split$=modifiedValue?.split("|")[1])&&void 0!==_modifiedValue$split$?_modifiedValue$split$:modifiedValue}]:[],loading:allSlackChannelsLoading||slackChannelByIdLoading}),showSlackMembershipWarning?(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,jsx_runtime.jsxs)("span",{children:["The PostHog Slack App is not in this channel. Please add it to the channel otherwise Subscriptions will fail to be delivered."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/webhooks/slack",target:"_blank",children:"See the Docs for more information"})]}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",disabledReason:getChannelRefreshButtonDisabledReason(),onClick:()=>loadAllSlackChannels(!0),loading:allSlackChannelsLoading,children:"Check again"})]})}):isPrivateChannelWithoutAccess(null!=value?value:"")?(0,jsx_runtime.jsxs)(src.Vp,{type:"info",children:["This is a private Slack channel. Ask"," ",(0,jsx_runtime.jsx)(src.YY,{user:integration.created_by,showName:!0,size:"sm"})," or connect your own Slack account to configure private channels."]}):null]})}}}]);