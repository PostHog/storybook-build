"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[52655],{"../../frontend/src/scenes/pipeline/hogfunctions/logs/HogFunctionLogs.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{x:()=>HogFunctionLogs});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.12.1_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),logsViewerLogic=__webpack_require__("../../frontend/src/scenes/pipeline/hogfunctions/logs/logsViewerLogic.tsx");let eventIdMatchers=[/Event: ([A-Za-z0-9-]+)/,/\/events\/([A-Za-z0-9-]+)\//,/event ([A-Za-z0-9-]+)/];async function runWithParallelism(items,maxParallel,asyncFn){let results=[],executing=new Set;for(let item of items){let promise=(async()=>{let result=await asyncFn(item);results.push(result)})();executing.add(promise),promise.finally(()=>executing.delete(promise)),executing.size>=maxParallel&&await Promise.race(executing)}return await Promise.all(executing),results}let loadClickhouseEvents=async(eventIds,_ref)=>{let{date_from,date_to}=_ref,query={kind:schema_general.OH.HogQLQuery,query:`
            SELECT uuid, distinct_id, event, timestamp, properties, elements_chain, person.id, person.properties, person.created_at 
            FROM events
            WHERE uuid in (${eventIds.map(x=>`'${x}'`).join(",")})
            AND timestamp > {filters.dateRange.from}
            AND timestamp < {filters.dateRange.to}
        `};return(await api.ZP.query(query,void 0,void 0,"force_blocking",{date_from:date_from,date_to:date_to})).results.map(x=>{let[uuid,distinct_id,event,timestamp,properties,elements_chain,person_id,person_properties,person_created_at]=x;return{uuid,event,distinct_id,person_id,timestamp,properties,elements_chain,person_created_at,person_properties}})},hogFunctionLogsLogic=(0,index_esm.kea)([(0,index_esm.path)(key=>["scenes","pipeline","hogfunctions","logs","hogFunctionLogsLogic",key]),(0,index_esm.props)({}),(0,index_esm.key)(_ref2=>{let{sourceType,sourceId}=_ref2;return`${sourceType}:${sourceId}`}),(0,index_esm.connect)(props=>({values:[(0,logsViewerLogic.WC)(props),["logs"]],actions:[(0,logsViewerLogic.WC)(props),["addLogGroups","setRowExpanded"]]})),(0,index_esm.actions)({setSelectingMany:selectingMany=>({selectingMany}),setSelectedForRetry:selectedForRetry=>({selectedForRetry}),selectAllForRetry:!0,retryInvocation:(groupedLogEntry,eventId)=>({groupedLogEntry,eventId}),retryInvocations:groupedLogEntries=>({groupedLogEntries}),retryInvocationStarted:groupedLogEntry=>({groupedLogEntry}),retryInvocationSuccess:groupedLogEntry=>({groupedLogEntry}),retryInvocationFailure:groupedLogEntry=>({groupedLogEntry}),retrySelectedInvocations:!0}),(0,index_esm.reducers)({selectingMany:[!1,{setSelectingMany:(_,_ref3)=>{let{selectingMany}=_ref3;return selectingMany}}],selectedForRetry:[{},{setSelectedForRetry:(state,_ref4)=>{let{selectedForRetry}=_ref4,newState={...state};return Object.keys(selectedForRetry).forEach(key=>{newState[key]=selectedForRetry[key],selectedForRetry[key]||delete newState[key]}),newState},setSelectingMany:(state,_ref5)=>{let{selectingMany}=_ref5;return selectingMany?state:{}}}],retries:[{},{retryInvocationStarted:(state,_ref6)=>{let{groupedLogEntry}=_ref6;return{...state,[groupedLogEntry.instanceId]:"pending"}},retryInvocationSuccess:(state,_ref7)=>{let{groupedLogEntry}=_ref7;return{...state,[groupedLogEntry.instanceId]:"success"}},retryInvocationFailure:(state,_ref8)=>{let{groupedLogEntry}=_ref8;return{...state,[groupedLogEntry.instanceId]:"failure"}}}]}),(0,index_esm.selectors)({retryRunning:[s=>[s.retries],retries=>Object.values(retries).some(x=>"pending"===x)],eventIdByInvocationId:[s=>[s.logs],logs=>{let eventIdByInvocationId={};for(let record of logs){let entryContainingEventId=record.entries.find(entry=>entry.message.includes("Function completed")||entry.message.includes("Suspending function")||entry.message.includes("Error executing function on event"));if(!entryContainingEventId)return;for(let matcher of eventIdMatchers){let match=entryContainingEventId.message.match(matcher);if(match){eventIdByInvocationId[record.instanceId]=match[1];break}}}return eventIdByInvocationId}]}),(0,index_esm.listeners)(_ref9=>{let{actions,props,values}=_ref9;return{retryInvocations:async _ref10=>{let{groupedLogEntries}=_ref10;await src.UJ.promise((async _values$eventIdByInvo=>{for(let groupedLogEntry of groupedLogEntries)actions.retryInvocationStarted(groupedLogEntry);1===groupedLogEntries.length&&actions.setRowExpanded(groupedLogEntries[0].instanceId,!0);let[timestampRangeStart,timestampRangeEnd]=groupedLogEntries.reduce((_ref11,x)=>{let[accStart,accEnd]=_ref11;return accStart?[x.minTimestamp.isBefore(accStart)?x.minTimestamp:accStart,x.maxTimestamp.isAfter(accEnd)?x.maxTimestamp:accEnd]:[x.minTimestamp,x.minTimestamp]},[null,null]),events=await loadClickhouseEvents(Object.values(null!==(_values$eventIdByInvo=values.eventIdByInvocationId)&&void 0!==_values$eventIdByInvo?_values$eventIdByInvo:{}),{date_from:timestampRangeStart?.subtract(1,"day").toISOString(),date_to:timestampRangeEnd?.add(1,"day").toISOString()}),eventsById={};for(let event of events)eventsById[event.uuid]=event;await runWithParallelism(groupedLogEntries,10,async groupedLogEntry=>{try{let event=eventsById[values.eventIdByInvocationId[groupedLogEntry.instanceId]];if(!event){actions.retryInvocationFailure(groupedLogEntry);return}let res=await api.ZP.hogFunctions.createTestInvocation(props.sourceId,{clickhouse_event:event,mock_async_functions:!1,configuration:{filters:{}},invocation_id:groupedLogEntry.instanceId}),newLogGroup={...groupedLogEntry,entries:[...groupedLogEntry.entries,...res.logs.map(x=>({timestamp:(0,dayjs.Bv)(x.timestamp),level:x.level.toUpperCase(),message:x.message}))]};actions.addLogGroups([newLogGroup]),actions.retryInvocationSuccess(groupedLogEntry)}catch(e){actions.retryInvocationFailure(groupedLogEntry)}}),actions.setSelectingMany(!1)})(),{success:"Retries complete!",error:"Retry failed!",pending:"Retrying..."})},retrySelectedInvocations:async()=>{let groupsToRetry=values.logs.filter(x=>values.selectedForRetry[x.instanceId]);actions.retryInvocations(groupsToRetry)},selectAllForRetry:async()=>{for(let groupedLogEntry of(actions.setSelectingMany(!0),values.logs))actions.setSelectedForRetry({[groupedLogEntry.instanceId]:!0})}}}),(0,lib.beforeUnload)(_ref12=>{let{values,cache}=_ref12;return{enabled:()=>!cache.disabledBeforeUnload&&values.retryRunning,message:"You have running retries that will be discarded if you leave. Are you sure?",onConfirm:()=>{cache.disabledBeforeUnload=!0}}})]);var LogsViewer=__webpack_require__("../../frontend/src/scenes/pipeline/hogfunctions/logs/LogsViewer.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function HogFunctionLogs(props){let logicProps={sourceType:"hog_function",sourceId:props.hogFunctionId},{selectingMany,selectedForRetry,retryRunning}=(0,index_esm.useValues)(hogFunctionLogsLogic(logicProps)),{setSelectingMany,retrySelectedInvocations,selectAllForRetry}=(0,index_esm.useActions)(hogFunctionLogsLogic(logicProps));return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:selectingMany?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!1),children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>selectAllForRetry(),children:"Select all"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"primary",onClick:()=>{src.dn.open({title:"Retry invocations",content:"Are you sure you want to retry the selected events? Please don't close the window until the invocations have completed.",secondaryButton:{children:"Cancel"},primaryButton:{children:"Retry selected events",onClick:()=>retrySelectedInvocations()}})},loading:retryRunning,disabledReason:retryRunning?"Please wait for the current retries to complete.":0===Object.values(selectedForRetry).length?"No invocations selected":void 0,children:"Retry selected"})]}):(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!0),children:"Select invocations"})})}),(0,jsx_runtime.jsx)(LogsViewer.F,{...logicProps,sourceId:props.hogFunctionId,renderColumns:columns=>[{title:"Status",key:"status",width:0,render:(_,record)=>(0,jsx_runtime.jsx)(HogFunctionLogsStatus,{record:record,hogFunctionId:props.hogFunctionId})},...columns.filter(column=>"logLevel"!==column.key)]})]})}function HogFunctionLogsStatus(_ref){var _selectedForRetry$rec;let{record,hogFunctionId}=_ref,logicProps={sourceType:"hog_function",sourceId:hogFunctionId},{retries,selectingMany,selectedForRetry,eventIdByInvocationId}=(0,index_esm.useValues)(hogFunctionLogsLogic(logicProps)),{retryInvocations,setSelectingMany,setSelectedForRetry}=(0,index_esm.useActions)(hogFunctionLogsLogic(logicProps)),thisRetry=retries[record.instanceId],status=(0,react.useMemo)(()=>{if("pending"===thisRetry)return"running";let lastEntry=record.entries[record.entries.length-1];return lastEntry.message.includes("Function completed")||lastEntry.message.includes("Execution successful")?"success":"ERROR"===lastEntry.level?"failure":"running"},[record,thisRetry]),eventId=eventIdByInvocationId?.[record.instanceId];return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[selectingMany?(0,jsx_runtime.jsx)(src.Hw,{checked:null!==(_selectedForRetry$rec=selectedForRetry[record.instanceId])&&void 0!==_selectedForRetry$rec&&_selectedForRetry$rec,onChange:checked=>setSelectedForRetry({[record.instanceId]:checked})}):null,(0,jsx_runtime.jsx)(src.oe,{type:"success"===status?"success":"failure"===status?"danger":"warning",children:(0,utils.fm)(status)}),(0,jsx_runtime.jsx)(src.d6,{items:[eventId?{label:"View event",to:urls.j.event(eventId,"")}:null,{label:"Retry event",disabledReason:eventId?void 0:"Could not find the source event",onClick:()=>retryInvocations([record])},{label:"Select for retry",onClick:()=>{setSelectingMany(!0),setSelectedForRetry({[record.instanceId]:!0})}}],children:(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{className:"rotate-90"}),loading:"pending"===thisRetry})})]})}},"../../frontend/src/scenes/pipeline/hogfunctions/logs/LogsViewer.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{F:()=>LogsViewer,n:()=>tagTypeForLevel});var _posthog_icons__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.12.1_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib_components_DateFilter_DateFilter__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),lib_components_TZLabel__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),lib_utils__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/utils.tsx"),_logsViewerLogic__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/pipeline/hogfunctions/logs/logsViewerLogic.tsx"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let tagTypeForLevel=level=>{switch(level.toLowerCase()){case"debug":return"muted";case"log":case"info":default:return"default";case"warning":case"warn":return"warning";case"error":return"danger"}};function LogsViewer(_ref){let{renderColumns=c=>c,...props}=_ref,logic=(0,_logsViewerLogic__WEBPACK_IMPORTED_MODULE_6__.WC)(props),{logs,logsLoading,hiddenLogs,hiddenLogsLoading,isThereMoreToLoad,expandedRows,filters}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(logic),{revealHiddenLogs,loadMoreLogs,setFilters,setRowExpanded}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useActions)(logic);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("div",{className:"flex-1 deprecated-space-y-2 ph-no-capture",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.DF,{className:"flex-1 min-w-120",type:"search",placeholder:"Search for messages containingâ€¦",fullWidth:!0,onChange:value=>setFilters({search:value}),allowClear:!0,prefix:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.Fragment,{children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconSearch,{})})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("div",{className:"flex items-center gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Qw,{closeOnClickInside:!1,matchWidth:!1,placement:"right-end",overlay:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:"deprecated-space-y-2 overflow-hidden max-w-100",children:_logsViewerLogic__WEBPACK_IMPORTED_MODULE_6__.SV.map(level=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{fullWidth:!0,sideIcon:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Hw,{checked:filters.levels.includes(level)}),onClick:()=>{setFilters({levels:filters.levels.includes(level)?filters.levels.filter(t=>t!=level):[...filters.levels,level]})},children:level},level))}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{size:"small",type:"secondary",tooltip:"Filtering for any log groups containing any of the selected levels",children:filters.levels.map(level=>level).join(", ")})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(lib_components_DateFilter_DateFilter__WEBPACK_IMPORTED_MODULE_3__.f,{dateTo:filters.date_to,dateFrom:filters.date_from,onChange:(from,to)=>setFilters({date_from:from||void 0,date_to:to||void 0}),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconCalendar,{})," ",key]})})]})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{onClick:revealHiddenLogs,loading:hiddenLogsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:hiddenLogs.length?void 0:"There's nothing to load",children:hiddenLogs.length?`Show ${(0,lib_utils__WEBPACK_IMPORTED_MODULE_5__.Zi)(hiddenLogs.length,"newer entry","newer entries")}`:"No new entries"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.g3,{dataSource:logs,loading:logsLoading,className:"ph-no-capture",rowKey:record=>record.instanceId,columns:renderColumns([{title:"Timestamp",key:"timestamp",dataIndex:"maxTimestamp",width:0,sorter:(a,b)=>a.maxTimestamp.unix()-b.maxTimestamp.unix(),render:(_,_ref2)=>{let{maxTimestamp}=_ref2;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(lib_components_TZLabel__WEBPACK_IMPORTED_MODULE_4__.w,{time:maxTimestamp})}},{width:0,title:"Invocation",dataIndex:"instanceId",key:"instanceId",render:(_,_ref3)=>{let{instanceId}=_ref3;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("code",{className:"whitespace-nowrap",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.rU,{className:"font-semibold",subtle:!0,onClick:()=>{setRowExpanded(instanceId,!expandedRows[instanceId])},children:instanceId})})}},{key:"logLevel",dataIndex:"logLevel",width:0,render:(_,_ref4)=>{let{instanceId,logLevel}=_ref4;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.rU,{subtle:!0,className:"flex items-center gap-2",onClick:()=>{setRowExpanded(instanceId,!expandedRows[instanceId])},children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.oe,{type:tagTypeForLevel(logLevel),children:logLevel.toUpperCase()})})}},{title:"Last message",key:"entries",dataIndex:"entries",render:(_,_ref5)=>{let{instanceId,entries}=_ref5,lastEntry=entries[entries.length-1];return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("code",{className:"whitespace-pre-wrap",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.rU,{subtle:!0,onClick:()=>{setRowExpanded(instanceId,!expandedRows[instanceId])},children:[lastEntry.message,entries.length>1&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("br",{}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("span",{className:"text-xs text-muted-alt",children:["+ ",entries.length-1," more"]})]})]})})}}]),expandable:{noIndent:!0,isRowExpanded:record=>{var _expandedRows$record$;return null!==(_expandedRows$record$=expandedRows[record.instanceId])&&void 0!==_expandedRows$record$&&_expandedRows$record$},onRowExpand:record=>setRowExpanded(record.instanceId,!0),onRowCollapse:record=>setRowExpanded(record.instanceId,!1),expandedRowRender:record=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.g3,{embedded:!0,dataSource:record.entries,columns:[{key:"spacer",width:0,render:()=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:"w-6"})},{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:(_,_ref6)=>{let{timestamp}=_ref6;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(lib_components_TZLabel__WEBPACK_IMPORTED_MODULE_4__.w,{time:timestamp})}},{title:"Level",key:"level",dataIndex:"level",render:(_,_ref7)=>{let{level}=_ref7;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.oe,{type:tagTypeForLevel(level),children:level.toUpperCase()})}},{title:"Message",key:"message",dataIndex:"message",render:(_,_ref8)=>{let{message}=_ref8;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("code",{className:"whitespace-pre-wrap",children:message})}}]})}}),!!logs.length&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{onClick:loadMoreLogs,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:isThereMoreToLoad?void 0:"There's nothing more to load",children:isThereMoreToLoad?`Load up to ${_logsViewerLogic__WEBPACK_IMPORTED_MODULE_6__.Hs} older entries`:"No older entries"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:"mb-8"})]})}},"../../frontend/src/scenes/pipeline/hogfunctions/logs/logsViewerLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Hs:()=>LOG_VIEWER_LIMIT,SV:()=>ALL_LOG_LEVELS,WC:()=>logsViewerLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_dayjs__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/dayjs.ts"),_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts");let ALL_LOG_LEVELS=["DEBUG","LOG","INFO","WARNING","ERROR"],LOG_VIEWER_LIMIT=500,loadGroupedLogs=async request=>{var _request$date_from;let query={kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_4__.OH.HogQLQuery,query:`SELECT
            instance_id,
            max(timestamp) AS latest_timestamp,
            min(timestamp) AS earliest_timestamp,
            arraySort(
                groupArray((timestamp, level, message))
            ) AS messages
        FROM log_entries
        WHERE log_source = '${request.sourceType}'
        AND log_source_id = '${request.sourceId}'
        AND timestamp > {filters.dateRange.from}
        AND timestamp < {filters.dateRange.to}
        AND instance_id in (
            SELECT DISTINCT instance_id
            FROM log_entries
            WHERE log_source = 'hog_function'
            AND log_source_id = '${request.sourceId}'
            AND timestamp > {filters.dateRange.from}
            AND timestamp < {filters.dateRange.to}
            AND lower(level) IN (${request.levels.map(level=>`'${level.toLowerCase()}'`).join(",")})
            AND message ILIKE '%${request.search}%'
            ORDER BY timestamp ${request.order}
            LIMIT ${LOG_VIEWER_LIMIT}
        )
        GROUP BY instance_id
        ORDER BY latest_timestamp DESC`};return(await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.query(query,void 0,void 0,"force_blocking",{date_from:null!==(_request$date_from=request.date_from)&&void 0!==_request$date_from?_request$date_from:"-7d",date_to:request.date_to})).results.map(result=>({instanceId:result[0],maxTimestamp:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_3__.Bv)(result[1]),minTimestamp:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_3__.Bv)(result[2]),entries:result[3].map(entry=>({timestamp:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_3__.Bv)(entry[0]),level:entry[1].toUpperCase(),message:entry[2]}))}))},sanitizeGroupedLogs=groups=>{let byId={};for(let group of groups){if(byId[group.instanceId])for(let entry of group.entries)byId[group.instanceId].entries.find(e=>e.timestamp.isSame(entry.timestamp))||byId[group.instanceId].entries.push(entry);else byId[group.instanceId]=group;byId[group.instanceId].entries.sort((a,b)=>a.timestamp.diff(b.timestamp));let highestLogLevel=group.entries.reduce((max,entry)=>Math.max(max,ALL_LOG_LEVELS.indexOf(entry.level)),0);byId[group.instanceId].logLevel=ALL_LOG_LEVELS[highestLogLevel]}return Object.values(byId).sort((a,b)=>b.maxTimestamp.diff(a.maxTimestamp))},logsViewerLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(key=>["scenes","pipeline","hogfunctions","logs","logsViewerLogic",key]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.key)(_ref=>{let{sourceType,sourceId}=_ref;return`${sourceType}:${sourceId}`}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setFilters:filters=>({filters}),addLogGroups:logGroups=>({logGroups}),setHiddenLogs:logGroups=>({logGroups}),clearHiddenLogs:!0,markLogsEnd:!0,revealHiddenLogs:!0,setRowExpanded:(instanceId,expanded)=>({instanceId,expanded}),scheduleLoadNewerLogs:!0,loadLogs:!0,loadNewerLogs:!0}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref2=>{let{props,values,actions}=_ref2;return{logs:[[],{loadLogs:async(_,breakpoint)=>{await breakpoint(10),actions.clearHiddenLogs();let logParams={levels:values.filters.levels,search:values.filters.search,sourceType:props.sourceType,sourceId:props.sourceId,date_from:values.filters.date_from,date_to:values.filters.date_to,order:"DESC"},results=await loadGroupedLogs(logParams);return await breakpoint(10),sanitizeGroupedLogs(results)},loadMoreLogs:async()=>{if(!values.oldestLogTimestamp)return values.logs;let logParams={levels:values.filters.levels,search:values.filters.search,sourceType:props.sourceType,sourceId:props.sourceId,date_to:values.oldestLogTimestamp.toISOString(),date_from:values.filters.date_from,order:"DESC"},results=await loadGroupedLogs(logParams);return results.length||actions.markLogsEnd(),sanitizeGroupedLogs([...results,...values.logs])},revealHiddenLogs:()=>{let hiddenLogs=[...values.hiddenLogs];return actions.clearHiddenLogs(),sanitizeGroupedLogs([...hiddenLogs,...values.logs])},addLogGroups:_ref3=>{let{logGroups}=_ref3;return sanitizeGroupedLogs([...logGroups,...values.logs])}}],hiddenLogs:[[],{loadNewerLogs:async(_,breakpoint)=>{if(await breakpoint(10),!values.newestLogTimestamp)return values.hiddenLogs;let logParams={levels:values.filters.levels,search:values.filters.search,sourceType:props.sourceType,sourceId:props.sourceId,date_from:values.newestLogTimestamp.toISOString(),date_to:values.filters.date_to,order:"ASC"},results=await loadGroupedLogs(logParams);await breakpoint(10);let newLogs=[],existingLogsToUpdate=[],existingLogIds=values.logs.map(log=>log.instanceId);if(values.logsLoading)return values.hiddenLogs;for(let log of results)existingLogIds.includes(log.instanceId)?existingLogsToUpdate.push(log):newLogs.push(log);return existingLogsToUpdate.length&&actions.loadLogsSuccess(sanitizeGroupedLogs([...existingLogsToUpdate,...values.logs])),actions.scheduleLoadNewerLogs(),sanitizeGroupedLogs([...newLogs,...values.hiddenLogs])},clearHiddenLogs:()=>[]}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({filters:[{search:"",levels:["LOG","INFO","WARNING","ERROR"],date_from:"-7d",date_to:void 0},{setFilters:(state,_ref4)=>{let{filters}=_ref4;return{...state,...filters}}}],isThereMoreToLoad:[!0,{markLogsEnd:()=>!1,loadLogs:()=>!0}],expandedRows:[{},{setRowExpanded:(state,_ref5)=>{let{instanceId,expanded}=_ref5;return{...state,[instanceId]:expanded}}}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(()=>({newestLogTimestamp:[s=>[s.logs,s.hiddenLogs],(logs,hiddenLogs)=>logs.concat(hiddenLogs).reduce((max,log)=>max?log.maxTimestamp.isAfter(max)?log.maxTimestamp:max:log.maxTimestamp,null)],oldestLogTimestamp:[s=>[s.logs,s.hiddenLogs],(logs,hiddenLogs)=>logs.concat(hiddenLogs).reduce((min,log)=>min?log.minTimestamp.isBefore(min)?log.minTimestamp:min:log.minTimestamp,null)]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref6=>{let{actions,cache}=_ref6;return{setFilters:async(_,breakpoint)=>{await breakpoint(500),actions.loadLogs()},loadLogsSuccess:()=>{actions.scheduleLoadNewerLogs()},scheduleLoadNewerLogs:()=>{cache.pollingTimeout&&clearTimeout(cache.pollingTimeout),cache.pollingTimeout=setTimeout(()=>actions.loadNewerLogs(),5e3)}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.events)(_ref7=>{let{actions,cache}=_ref7;return{afterMount:()=>{actions.loadLogs()},beforeUnmount:()=>{clearInterval(cache.pollingTimeout)}}})])}}]);
//# sourceMappingURL=52655.25b3469a.iframe.bundle.js.map