(window.webpackJsonp=window.webpackJsonp||[]).push([[244],{4491:function(module,exports,__webpack_require__){(exports=__webpack_require__(50)(!1)).push([module.i,".text-ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:calc(100% - 8px)}.async-migrations-scene .migration-btn{cursor:pointer}.async-migrations-scene .success{color:#77b96c}.async-migrations-scene .danger{color:#f96132}.async-migrations-scene .warning{color:#f7a501}",""]),module.exports=exports},4725:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"scene",(function(){return scene})),__webpack_require__.d(__webpack_exports__,"tooltipMessageForStatus",(function(){return tooltipMessageForStatus})),__webpack_require__.d(__webpack_exports__,"AsyncMigrations",(function(){return AsyncMigrations_AsyncMigrations}));__webpack_require__(203),__webpack_require__(213),__webpack_require__(34),__webpack_require__(140),__webpack_require__(62);var AsyncMigrationStatus,AsyncMigrationsTab,injectStylesIntoStyleTag=__webpack_require__(17),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),AsyncMigrations=__webpack_require__(4491),AsyncMigrations_default=__webpack_require__.n(AsyncMigrations),options={insert:"head",singleton:!1},react=(injectStylesIntoStyleTag_default()(AsyncMigrations_default.a,options),AsyncMigrations_default.a.locals,__webpack_require__(0)),react_default=__webpack_require__.n(react),PageHeader=__webpack_require__(297),tabs=__webpack_require__(564),modal=__webpack_require__(1243),es_progress=__webpack_require__(2564),es_button=__webpack_require__(139),space=__webpack_require__(4265),table=__webpack_require__(2686),index_esm=__webpack_require__(1),regenerator=(__webpack_require__(63),__webpack_require__(91),__webpack_require__(48),__webpack_require__(41),__webpack_require__(107),__webpack_require__(53),__webpack_require__(8)),regenerator_default=__webpack_require__.n(regenerator),asyncToGenerator=(__webpack_require__(67),__webpack_require__(13)),asyncToGenerator_default=__webpack_require__.n(asyncToGenerator),utils=__webpack_require__(10),api=__webpack_require__(21),userLogic=__webpack_require__(70);!function(AsyncMigrationStatus){AsyncMigrationStatus[AsyncMigrationStatus.NotStarted=0]="NotStarted",AsyncMigrationStatus[AsyncMigrationStatus.Running=1]="Running",AsyncMigrationStatus[AsyncMigrationStatus.CompletedSuccessfully=2]="CompletedSuccessfully",AsyncMigrationStatus[AsyncMigrationStatus.Errored=3]="Errored",AsyncMigrationStatus[AsyncMigrationStatus.RolledBack=4]="RolledBack",AsyncMigrationStatus[AsyncMigrationStatus.Starting=5]="Starting"}(AsyncMigrationStatus||(AsyncMigrationStatus={})),function(AsyncMigrationsTab){AsyncMigrationsTab.Management="management",AsyncMigrationsTab.Settings="settings"}(AsyncMigrationsTab||(AsyncMigrationsTab={}));var migrationStatusNumberToMessage={0:"Not started",1:"Running",2:"Completed successfully",3:"Errored",4:"Rolled back",5:"Starting"},asyncMigrationsLogic=Object(index_esm.kea)({path:["scenes","instance","AsyncMigrations","asyncMigrationsLogic"],actions:{triggerMigration:function triggerMigration(migrationId){return{migrationId:migrationId}},forceStopMigration:function forceStopMigration(migrationId){return{migrationId:migrationId}},setActiveTab:function setActiveTab(tab){return{tab:tab}},updateSetting:function updateSetting(settingKey,newValue){return{settingKey:settingKey,newValue:newValue}}},reducers:{activeTab:[AsyncMigrationsTab.Management,{setActiveTab:function setActiveTab(_,_ref){return _ref.tab}}]},loaders:function loaders(){return{asyncMigrations:[[],{loadAsyncMigrations:(_loadAsyncMigrations=asyncToGenerator_default()(regenerator_default.a.mark((function _callee(){var _userLogic$values$use;return regenerator_default.a.wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:if(null===(_userLogic$values$use=userLogic.a.values.user)||void 0===_userLogic$values$use?void 0:_userLogic$values$use.is_staff){_context.next=2;break}return _context.abrupt("return",[]);case 2:return _context.next=4,api.a.get("api/async_migrations");case 4:return _context.abrupt("return",_context.sent.results);case 5:case"end":return _context.stop()}}),_callee)}))),function loadAsyncMigrations(){return _loadAsyncMigrations.apply(this,arguments)})}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:(_loadAsyncMigrationSettings=asyncToGenerator_default()(regenerator_default.a.mark((function _callee2(){var _userLogic$values$use2,settings;return regenerator_default.a.wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(null===(_userLogic$values$use2=userLogic.a.values.user)||void 0===_userLogic$values$use2?void 0:_userLogic$values$use2.is_staff){_context2.next=2;break}return _context2.abrupt("return",[]);case 2:return _context2.next=4,api.a.get("api/instance_settings");case 4:return settings=_context2.sent.results,_context2.abrupt("return",settings.filter((function(setting){return setting.key.includes("ASYNC_MIGRATIONS")})));case 6:case"end":return _context2.stop()}}),_callee2)}))),function loadAsyncMigrationSettings(){return _loadAsyncMigrationSettings.apply(this,arguments)})}]};var _loadAsyncMigrationSettings,_loadAsyncMigrations},listeners:function listeners(_ref2){var _updateSetting,_forceStopMigration,_triggerMigration,actions=_ref2.actions;return{triggerMigration:(_triggerMigration=asyncToGenerator_default()(regenerator_default.a.mark((function _callee3(_ref3){var migrationId,res;return regenerator_default.a.wrap((function _callee3$(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return migrationId=_ref3.migrationId,_context3.next=3,api.a.create("/api/async_migrations/".concat(migrationId,"/trigger"));case 3:(res=_context3.sent).success?(Object(utils.wb)("Migration triggered successfully"),actions.loadAsyncMigrations()):Object(utils.A)("Failed to trigger migration",res.error);case 5:case"end":return _context3.stop()}}),_callee3)}))),function triggerMigration(_x){return _triggerMigration.apply(this,arguments)}),forceStopMigration:(_forceStopMigration=asyncToGenerator_default()(regenerator_default.a.mark((function _callee4(_ref4){var migrationId,res;return regenerator_default.a.wrap((function _callee4$(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return migrationId=_ref4.migrationId,_context4.next=3,api.a.create("/api/async_migrations/".concat(migrationId,"/force_stop"));case 3:(res=_context4.sent).success?(Object(utils.wb)("Force stop triggered successfully"),actions.loadAsyncMigrations()):Object(utils.A)("Failed to trigger force stop",res.error);case 5:case"end":return _context4.stop()}}),_callee4)}))),function forceStopMigration(_x2){return _forceStopMigration.apply(this,arguments)}),updateSetting:(_updateSetting=asyncToGenerator_default()(regenerator_default.a.mark((function _callee5(_ref5){var settingKey,newValue;return regenerator_default.a.wrap((function _callee5$(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:return settingKey=_ref5.settingKey,newValue=_ref5.newValue,_context5.prev=1,_context5.next=4,api.a.create("/api/instance_settings/".concat(settingKey),{value:newValue});case 4:Object(utils.wb)("Setting updated successfully!","Instance setting ".concat(settingKey," has been updated.")),actions.loadAsyncMigrationSettings(),_context5.next=11;break;case 8:_context5.prev=8,_context5.t0=_context5.catch(1),Object(utils.A)("Failed to trigger migration.","Please try again or contact support.");case 11:case"end":return _context5.stop()}}),_callee5,null,[[1,8]])}))),function updateSetting(_x3){return _updateSetting.apply(this,arguments)})}},events:function events(_ref6){var actions=_ref6.actions;return{afterMount:function afterMount(){actions.loadAsyncMigrations(),actions.loadAsyncMigrationSettings()}}}}),PlayCircleOutlined=__webpack_require__(4330),StopOutlined=__webpack_require__(4229),CheckCircleOutlined=__webpack_require__(504),RedoOutlined=__webpack_require__(4269),InfoCircleOutlined=__webpack_require__(635),Tooltip=__webpack_require__(47),Spinner=__webpack_require__(208),slicedToArray=__webpack_require__(12),slicedToArray_default=__webpack_require__.n(slicedToArray),row=__webpack_require__(382),col=__webpack_require__(349),input=__webpack_require__(507),divider=__webpack_require__(4218);function SettingUpdateField(_ref){var setting=_ref.setting,updateSetting=Object(index_esm.useActions)(asyncMigrationsLogic).updateSetting,_useState=Object(react.useState)(String(setting.value)),_useState2=slicedToArray_default()(_useState,2),inputValue=_useState2[0],setInputValue=_useState2[1];return react_default.a.createElement("div",{key:setting.key},react_default.a.createElement("h4",null,setting.key),react_default.a.createElement("p",null,setting.description),react_default.a.createElement(row.a,{gutter:[8,8]},react_default.a.createElement(col.a,{span:8},react_default.a.createElement(input.a,{value:inputValue,onChange:function onChange(e){return setInputValue(e.target.value)}})),react_default.a.createElement(col.a,{span:16},react_default.a.createElement(es_button.a,{disabled:String(setting.value)===inputValue,type:"primary",onClick:function onClick(){return updateSetting(setting.key,inputValue)}},"Update"))),react_default.a.createElement(divider.a,null))}try{SettingUpdateField.displayName="SettingUpdateField",SettingUpdateField.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"InstanceSetting"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:SettingUpdateField.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(__react_docgen_typescript_loader_error){}var scene={component:AsyncMigrations_AsyncMigrations},TabPane=tabs.a.TabPane,tooltipMessageForStatus={0:"Run migration",1:"Force stop migration",2:"Migration completed",3:"Re-run migration",4:"Re-run migration"};function AsyncMigrations_AsyncMigrations(){var user=Object(index_esm.useValues)(userLogic.a).user,_useValues2=Object(index_esm.useValues)(asyncMigrationsLogic),asyncMigrations=_useValues2.asyncMigrations,asyncMigrationsLoading=_useValues2.asyncMigrationsLoading,activeTab=_useValues2.activeTab,asyncMigrationSettings=_useValues2.asyncMigrationSettings,_useActions=Object(index_esm.useActions)(asyncMigrationsLogic),triggerMigration=_useActions.triggerMigration,forceStopMigration=_useActions.forceStopMigration,loadAsyncMigrations=_useActions.loadAsyncMigrations,setActiveTab=_useActions.setActiveTab,columns=[{title:"",render:function RenderTriggerButton(asyncMigration){var status=asyncMigration.status;return react_default.a.createElement(Tooltip.a,{title:tooltipMessageForStatus[status]},0===status?react_default.a.createElement(PlayCircleOutlined.a,{className:"migration-btn success",onClick:function onClick(){return triggerMigration(asyncMigration.id)}}):1===status?react_default.a.createElement(StopOutlined.a,{className:"migration-btn danger",onClick:function onClick(){return forceStopMigration(asyncMigration.id)}}):2===status?react_default.a.createElement(CheckCircleOutlined.a,{className:"success"}):3===status||4===status?react_default.a.createElement(RedoOutlined.a,{className:"migration-btn warning",onClick:function onClick(){return triggerMigration(asyncMigration.id)}}):5===status?react_default.a.createElement(Spinner.a,{size:"sm"}):null)}},{title:"Migration name",dataIndex:"name"},{title:"Description",render:function RenderError(asyncMigration){var description=asyncMigration.description;return react_default.a.createElement("small",null,react_default.a.createElement("span",null,description.slice(0,40)),description.length>40?react_default.a.createElement("a",{onClick:function onClick(){modal.a.info({title:"'".concat(asyncMigration.name,"' description"),content:react_default.a.createElement("pre",null,description),icon:react_default.a.createElement(InfoCircleOutlined.a,null),okText:"Close",width:"80%"})}}," [...]"):null)}},{title:"Progress",dataIndex:"progress",render:function RenderMigrationProgress(progress){return react_default.a.createElement("div",null,react_default.a.createElement(es_progress.a,{percent:progress}))}},{title:"Status",dataIndex:"status",render:function RenderMigrationStatus(status){return react_default.a.createElement("div",null,migrationStatusNumberToMessage[status])}},{title:"Last operation index",dataIndex:"current_operation_index"},{title:"Last query ID",dataIndex:"current_query_id",render:function RenderQueryId(queryId){return react_default.a.createElement("div",null,react_default.a.createElement("small",null,queryId))}},{title:"Celery task ID",dataIndex:"celery_task_id",render:function RenderCeleryTaskId(celeryTaskId){return react_default.a.createElement("div",null,react_default.a.createElement("small",null,celeryTaskId))}},{title:"Started at",dataIndex:"started_at",render:function RenderStartedAt(startedAt){return react_default.a.createElement("div",null,Object(utils.L)(startedAt))}},{title:"Finished at",dataIndex:"finished_at",render:function RenderFinishedAt(finishedAt){return react_default.a.createElement("div",null,Object(utils.L)(finishedAt))}}];return react_default.a.createElement("div",{className:"async-migrations-scene"},(null==user?void 0:user.is_staff)?react_default.a.createElement(react_default.a.Fragment,null,react_default.a.createElement(PageHeader.a,{title:"Async Migrations",caption:react_default.a.createElement(react_default.a.Fragment,null,react_default.a.createElement("p",null,"Manage async migrations in your instance."),react_default.a.createElement("p",null,"Read about async migrations on our"," ",react_default.a.createElement("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations"},"dedicated docs page"),"."))}),react_default.a.createElement(tabs.a,{activeKey:activeTab,onChange:function onChange(t){return setActiveTab(t)}},react_default.a.createElement(TabPane,{tab:"Management",key:AsyncMigrationsTab.Management}),react_default.a.createElement(TabPane,{tab:"Settings",key:AsyncMigrationsTab.Settings})),activeTab===AsyncMigrationsTab.Management?react_default.a.createElement(react_default.a.Fragment,null,react_default.a.createElement("div",{className:"mb float-right"},react_default.a.createElement(es_button.a,{icon:asyncMigrationsLoading?react_default.a.createElement(Spinner.a,{size:"sm"}):react_default.a.createElement(RedoOutlined.a,null),onClick:loadAsyncMigrations},"Refresh")),react_default.a.createElement(space.b,null),react_default.a.createElement(table.a,{pagination:!1,loading:asyncMigrationsLoading,columns:columns,dataSource:asyncMigrations})):activeTab===AsyncMigrationsTab.Settings?react_default.a.createElement(react_default.a.Fragment,null,react_default.a.createElement("br",null),asyncMigrationSettings.map((function(setting){return react_default.a.createElement("div",{key:setting.key},react_default.a.createElement(SettingUpdateField,{setting:setting}))}))):null):react_default.a.createElement(PageHeader.a,{title:"Async Migrations",caption:react_default.a.createElement(react_default.a.Fragment,null,react_default.a.createElement("p",null,"Only users with staff access can manage async migrations. Please contact your instance admin."),react_default.a.createElement("p",null,"If you're an admin and don't have access, set ",react_default.a.createElement("code",null,"is_staff=true")," for your user on the PostgreSQL ",react_default.a.createElement("code",null,"posthog_user")," table."))}))}}}]);