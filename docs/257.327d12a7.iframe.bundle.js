(window.webpackJsonp=window.webpackJsonp||[]).push([[257],{"./frontend/src/scenes/annotations/Annotations.tsx":function(ln,C,n){"use strict";n.r(C),n.d(C,"scene",function(){return on}),n.d(C,"Annotations",function(){return Y});var cn=n("./node_modules/core-js/modules/es.function.name.js"),W=n("./node_modules/react/index.js"),t=n.n(W),p=n("./node_modules/kea/lib/index.esm.js"),$=n("./node_modules/@babel/runtime/helpers/toConsumableArray.js"),L=n.n($),J=n("./node_modules/@babel/runtime/helpers/asyncToGenerator.js"),I=n.n(J),K=n("./node_modules/@babel/runtime/helpers/defineProperty.js"),A=n.n(K),U=n("./node_modules/@babel/runtime/regenerator/index.js"),h=n.n(U),dn=n("./node_modules/core-js/modules/es.array.concat.js"),un=n("./node_modules/core-js/modules/es.array.iterator.js"),mn=n("./node_modules/core-js/modules/es.object.to-string.js"),fn=n("./node_modules/core-js/modules/web.dom-collections.iterator.js"),j=n("./frontend/src/lib/api.ts"),D=n("./frontend/src/lib/utils.tsx"),H=n("./frontend/src/models/annotationsModel.ts"),c=n("./frontend/src/types.ts"),V=n("./frontend/src/scenes/teamLogic.tsx"),Q=n("./node_modules/kea-loaders/lib/index.js"),k=n("./node_modules/kea-forms/lib/index.js"),y=n("./frontend/src/lib/dayjs.ts"),T,E,F="MMMM\xA0DD,\xA0YYYY h:mm\xA0A",N=(T={},A()(T,c.c.Insight,"Insight"),A()(T,c.c.Project,"Project"),A()(T,c.c.Organization,"Organization"),T),B=(E={},A()(E,c.c.Insight,0),A()(E,c.c.Project,1),A()(E,c.c.Organization,2),E),x=Object(p.kea)([Object(p.path)(["scenes","annotations","logic"]),Object(p.actions)({deleteAnnotation:function(e){return{id:e}},restoreAnnotation:function(e){return{id:e}},loadAnnotationsNext:function(){return!0},setNext:function(e){return{next:e}},appendAnnotations:function(e){return{annotations:e}},openModalToCreateAnnotation:function(){return!0},openModalToEditAnnotation:function(e){return{annotation:e}},closeModal:!0}),Object(Q.loaders)(function(o){var e=o.actions;return{annotations:{__default:[],loadAnnotations:function(){var a=I()(h.a.mark(function i(){var s;return h.a.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,j.b.get("api/projects/".concat(V.a.values.currentTeamId,"/annotations/?").concat(Object(D.Db)({order:"-updated_at"})));case 2:return s=l.sent,e.setNext(s.next),l.abrupt("return",s.results);case 5:case"end":return l.stop()}},i)}));function r(){return a.apply(this,arguments)}return r}()}}}),Object(p.reducers)(function(){return{annotations:[[],{appendAnnotations:function(e,a){var r=a.annotations;return[].concat(L()(e),L()(r))}}],next:[null,{setNext:function(e,a){var r=a.next;return r}}],loadingNext:[!1,{loadAnnotationsNext:function(){return!0},appendAnnotations:function(){return!1}}],isModalOpen:[!1,{openModalToCreateAnnotation:function(){return!0},openModalToEditAnnotation:function(){return!0},closeModal:function(){return!1}}],existingModalAnnotation:[null,{openModalToCreateAnnotation:function(){return null},openModalToEditAnnotation:function(e,a){var r=a.annotation;return r}}]}}),Object(p.listeners)(function(o){var e=o.actions,a=o.values;return A()({openModalToEditAnnotation:function(i){var s=i.annotation,u=s.date_marker,l=s.scope,f=s.content;e.setAnnotationModalValues({dateMarker:Object(y.a)(u),scope:l,content:f})},openModalToCreateAnnotation:function(){e.resetAnnotationModal()},deleteAnnotation:function(i){var s=i.id;Object(D.w)({endpoint:j.b.annotations.determineDeleteEndpoint(),object:{name:"Annotation",id:s},callback:function(){return e.loadAnnotations()}})},loadAnnotationsNext:function(){var r=I()(h.a.mark(function s(){var u,l;return h.a.wrap(function(m){for(;;)switch(m.prev=m.next){case 0:if(u=[],!a.next){m.next=7;break}return m.next=4,j.b.get(a.next);case 4:l=m.sent,e.setNext(l.next),u=l.results;case 7:e.appendAnnotations(u);case 8:case"end":return m.stop()}},s)}));function i(){return r.apply(this,arguments)}return i}()},H.a.actionTypes.createGlobalAnnotationSuccess,function(){e.loadAnnotations()})}),Object(p.afterMount)(function(o){var e=o.actions;return e.loadAnnotations()}),Object(k.forms)(function(o){var e=o.actions,a=o.values;return{annotationModal:{defaults:{dateMarker:Object(y.a)(),content:"",scope:c.c.Project},errors:function(i){var s=i.content;return{content:s?null:"An annotation must have text content."}},submit:function(){var r=I()(h.a.mark(function s(u){var l,f,m;return h.a.wrap(function(v){for(;;)switch(v.prev=v.next){case 0:if(l=u.dateMarker,f=u.content,m=u.scope,!a.existingModalAnnotation){v.next=6;break}return v.next=4,j.b.annotations.update(a.existingModalAnnotation.id,{date_marker:l.toISOString(),content:f,scope:m});case 4:v.next=8;break;case 6:return v.next=8,j.b.annotations.create({date_marker:l.toISOString(),content:f,scope:m});case 8:e.loadAnnotations(),e.closeModal();case 10:case"end":return v.stop()}},s)}));function i(s){return r.apply(this,arguments)}return i}()}}})]),X=n("./frontend/src/lib/components/PageHeader.tsx"),Z=n("./frontend/src/lib/components/LemonTable/index.ts"),R=n("./frontend/src/lib/components/LemonTable/columnUtils.tsx"),S=n("./frontend/src/lib/components/LemonButton/index.ts"),w=n("./frontend/src/lib/components/LemonTag/LemonTag.tsx"),O=n("./frontend/src/lib/components/icons.tsx"),g=n("./frontend/@posthog/lemon-ui/src/index.ts"),q=n("./frontend/src/scenes/urls.ts"),_=n("./frontend/src/lib/components/Tooltip.tsx"),nn=n("./frontend/src/scenes/organizationLogic.tsx"),P=n("./frontend/src/lib/forms/Field.tsx"),tn=n("./frontend/src/lib/components/DatePicker.tsx");function en(){var o=Object(p.useValues)(x),e=o.isModalOpen,a=o.existingModalAnnotation,r=o.isAnnotationModalSubmitting,i=Object(p.useActions)(x),s=i.closeModal,u=i.deleteAnnotation,l=i.submitAnnotationModal,f=(a==null?void 0:a.scope)===c.c.Insight;return t.a.createElement(g.LemonModal,{isOpen:e,onClose:s,title:a?"Edit annotation":"New annotation",description:"Use annotations to add context to insights and dashboards.",footer:t.a.createElement("div",{className:"flex-1 flex items-center justify-between"},t.a.createElement("div",{className:"flex items-center gap-2"},a&&t.a.createElement(g.LemonButton,{form:"annotation-modal-form",type:"secondary",status:"danger",onClick:function(){u(a.id),s()},"data-attr":"delete-annotation"},"Delete annotation")),t.a.createElement("div",{className:"flex items-center gap-2"},t.a.createElement(g.LemonButton,{form:"annotation-modal-form",type:"secondary",onClick:s},"Cancel"),t.a.createElement(g.LemonButton,{form:"annotation-modal-form",htmlType:"submit",type:"primary",loading:r,"data-attr":"create-annotation-submit"},a?"Edit":"Create")))},t.a.createElement(k.Form,{logic:x,formKey:"annotationModal",id:"annotation-modal-form",enableFormOnSubmit:!0,className:"space-y-4"},t.a.createElement("div",{className:"flex gap-2"},t.a.createElement(P.a,{name:"dateMarker",label:"Date\xA0and\xA0time",className:"flex-1"},t.a.createElement(tn.a,{className:"h-10",allowClear:!1,showTime:!0,showSecond:!1,format:F})),t.a.createElement(P.a,{name:"scope",label:"Scope",className:"flex-1"},t.a.createElement(g.LemonSelect,{options:[].concat(L()((a==null?void 0:a.scope)===c.c.Insight?[{value:c.c.Insight,label:N[c.c.Insight]}]:[]),[{value:c.c.Project,label:N[c.c.Project],sideIcon:f?t.a.createElement(O.IconWarning,null):void 0,tooltip:f?"After saving, it won't be possible to make the annotation insight-scoped again.":void 0},{value:c.c.Organization,label:N[c.c.Organization],sideIcon:f?t.a.createElement(O.IconWarning,null):void 0,tooltip:f?"After saving, it won't be possible to make the annotation insight-scoped again.":void 0}]),fullWidth:!0}))),t.a.createElement(P.a,{name:"content",label:"Content"},t.a.createElement(g.LemonTextArea,{placeholder:"What's this annotation about?",onPressCmdEnter:l,"data-attr":"create-annotation-input"}))))}var on={component:Y,logic:x};function Y(){var o=Object(p.useValues)(V.a),e=o.currentTeam,a=Object(p.useValues)(nn.a),r=a.currentOrganization,i=Object(p.useValues)(x),s=i.annotations,u=i.annotationsLoading,l=i.next,f=i.loadingNext,m=Object(p.useActions)(x),G=m.loadAnnotationsNext,v=m.openModalToCreateAnnotation,an=m.openModalToEditAnnotation,sn=[{title:"Annotation",key:"annotation",width:"30%",render:function(b,d){return t.a.createElement("div",{className:"ph-no-capture"},d.content)}},{title:"Date\xA0and\xA0time",dataIndex:"date_marker",render:function(b,d){return Object(y.a)(d.date_marker).format(F)},sorter:function(b,d){return Object(y.a)(b.date_marker).diff(d.date_marker)}},{title:"Scope",key:"scope",render:function(b,d){var z=N[d.scope],rn=d.scope===c.c.Insight?'This annotation only applies to the "'.concat(d.insight_name,'" insight'):d.scope===c.c.Project?"This annotation applies to all insights in the ".concat(e==null?void 0:e.name," project"):"This annotation applies to all insights in the ".concat(r==null?void 0:r.name," organization");return t.a.createElement(_.a,{title:rn,placement:"right"},t.a.createElement(w.a,null,d.scope===c.c.Insight?t.a.createElement(g.Link,{to:q.a.insightView(d.insight_short_id),className:"flex items-center",target:"_blank"},z,t.a.createElement(O.IconOpenInNew,{className:"ml-1"})):z))},sorter:function(b,d){return B[b.scope]-B[d.scope]}},Object(R.b)(),Object(R.a)(),{key:"actions",width:0,render:function(b,d){return t.a.createElement(S.a,{icon:t.a.createElement(O.IconEdit,null),size:"small",type:"tertiary",status:"stealth",onClick:function(){return an(d)}})}}];return t.a.createElement(t.a.Fragment,null,t.a.createElement(X.a,{title:"Annotations",caption:t.a.createElement(t.a.Fragment,null,"Annotations add time-specific context to insights and dashboards.",t.a.createElement("br",null),"Manage all of this project's annotations from this page."),buttons:t.a.createElement(S.a,{type:"primary","data-attr":"create-annotation",onClick:v},"New annotation")}),t.a.createElement(Z.a,{"data-attr":"annotations-table",rowKey:"id",dataSource:s,columns:sn,defaultSorting:{columnKey:"date_marker",order:-1},noSortingCancellation:!0,loading:u,emptyState:"No annotations yet"}),l&&t.a.createElement("div",{className:"flex justify-center mt-6"},t.a.createElement(S.a,{type:"primary",loading:f,onClick:function(){G()}},"Load more annotations")),t.a.createElement(en,null))}}}]);
