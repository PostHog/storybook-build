"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[1037],{"../../products/llm_analytics/frontend/LLMAnalyticsSessionScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{LLMAnalyticsSessionScene:()=>LLMAnalyticsSessionScene,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.35.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),Link=__webpack_require__("../../frontend/src/lib/lemon-ui/Link/index.ts"),EmptyStates=__webpack_require__("../../frontend/src/scenes/insights/EmptyStates/index.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),SceneBreadcrumbs=__webpack_require__("../../frontend/src/layout/scenes/components/SceneBreadcrumbs.tsx"),LLMAnalyticsTraceEvents=__webpack_require__("../../products/llm_analytics/frontend/components/LLMAnalyticsTraceEvents.tsx"),api=__webpack_require__("../../frontend/src/lib/api.ts"),dataNodeLogic=__webpack_require__("../../frontend/src/queries/nodes/DataNode/dataNodeLogic.ts"),InsightViz=__webpack_require__("../../frontend/src/queries/nodes/InsightViz/InsightViz.tsx"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),types=__webpack_require__("../../frontend/src/types.ts"),llmAnalyticsLogic=__webpack_require__("../../products/llm_analytics/frontend/llmAnalyticsLogic.tsx");let llmAnalyticsSessionLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","llm-analytics","llmAnalyticsSessionLogic"]),(0,index_esm.connect)({values:[llmAnalyticsLogic.BK,["dateFilter"]]}),(0,index_esm.actions)({setSessionId:sessionId=>({sessionId}),setDateRange:(dateFrom,dateTo)=>({dateFrom,dateTo})}),(0,index_esm.reducers)({sessionId:["",{setSessionId:(_,_ref2)=>{let{sessionId}=_ref2;return sessionId}}],dateRange:[null,{setDateRange:(_,_ref3)=>{let{dateFrom,dateTo}=_ref3;return{dateFrom:null!=dateFrom?dateFrom:null,dateTo:null!=dateTo?dateTo:null}}}]}),(0,index_esm.selectors)({query:[s=>[s.sessionId,s.dateRange],(sessionId,dateRange)=>{let tracesQuery={kind:schema_general.OH.TracesQuery,dateRange:dateRange?.dateFrom?{date_from:dateRange.dateFrom,date_to:dateRange?.dateTo||void 0}:void 0,properties:[{type:types.FT.Event,key:"$ai_session_id",operator:"exact",value:sessionId}]};return{kind:schema_general.OH.DataTableNode,source:tracesQuery}}],breadcrumbs:[s=>[s.sessionId,s.dateFilter],(sessionId,dateFilter)=>{let sessionsUrl=urls.j.llmAnalyticsSessions(),searchParams=lib.router.values.searchParams,sessionsPath=dateFilter?.dateFrom||dateFilter?.dateTo||Object.keys(searchParams).length>0?`${sessionsUrl}?${new URLSearchParams({...searchParams,...dateFilter?.dateFrom&&{date_from:dateFilter.dateFrom},...dateFilter?.dateTo&&{date_to:dateFilter.dateTo}}).toString()}`:sessionsUrl;return[{key:"LLMAnalytics",name:"LLM analytics",path:urls.j.llmAnalyticsDashboard(),iconType:"llm_analytics"},{key:"LLMAnalyticsSessions",name:"Sessions",path:sessionsPath,iconType:"llm_analytics"},{key:["LLMAnalyticsSession",sessionId||""],name:sessionId,iconType:"llm_analytics"}]}]}),(0,lib.urlToAction)(_ref4=>{let{actions,values}=_ref4;return{[urls.j.llmAnalyticsSession(":id")]:(_ref5,_ref6)=>{let{id}=_ref5,{timestamp,date_from,date_to}=_ref6;actions.setSessionId(null!=id?id:""),timestamp?actions.setDateRange(timestamp||null):date_from||date_to?actions.setDateRange(date_from||null,date_to||null):values.dateRange?.dateFrom?actions.setDateRange(values.dateRange.dateFrom,values.dateRange.dateTo||null):values.dateFilter&&actions.setDateRange(values.dateFilter.dateFrom,values.dateFilter.dateTo)}}})]);function llmAnalyticsSessionDataLogic_getDataNodeLogicProps(_ref){let{sessionId,query,cachedResults}=_ref,insightProps={dashboardItemId:`new-Session.${sessionId}`,dataNodeCollectionId:sessionId},vizKey=(0,InsightViz.gG)(insightProps);return{query:query.source,key:vizKey,dataNodeCollectionId:sessionId,cachedResults:cachedResults||void 0}}let llmAnalyticsSessionDataLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","llm-analytics","llmAnalyticsSessionDataLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(props=>({values:[llmAnalyticsSessionLogic,["sessionId"],(0,dataNodeLogic.M)(llmAnalyticsSessionDataLogic_getDataNodeLogicProps(props)),["response","responseLoading","responseError"]]})),(0,index_esm.actions)({toggleTraceExpanded:traceId=>({traceId}),toggleGenerationExpanded:generationId=>({generationId}),loadFullTrace:traceId=>({traceId}),loadFullTraceSuccess:(traceId,trace)=>({traceId,trace}),loadFullTraceFailure:traceId=>({traceId})}),(0,index_esm.reducers)({expandedTraceIds:[new Set,{toggleTraceExpanded:(state,_ref2)=>{let{traceId}=_ref2,newSet=new Set(state);return newSet.has(traceId)?newSet.delete(traceId):newSet.add(traceId),newSet}}],expandedGenerationIds:[new Set,{toggleGenerationExpanded:(state,_ref3)=>{let{generationId}=_ref3,newSet=new Set(state);return newSet.has(generationId)?newSet.delete(generationId):newSet.add(generationId),newSet}}],fullTraces:[{},{loadFullTraceSuccess:(state,_ref4)=>{let{traceId,trace}=_ref4;return{...state,[traceId]:trace}}}],loadingFullTraces:[new Set,{loadFullTrace:(state,_ref5)=>{let{traceId}=_ref5;return new Set(state).add(traceId)},loadFullTraceSuccess:(state,_ref6)=>{let{traceId}=_ref6,newSet=new Set(state);return newSet.delete(traceId),newSet},loadFullTraceFailure:(state,_ref7)=>{let{traceId}=_ref7,newSet=new Set(state);return newSet.delete(traceId),newSet}}]}),(0,index_esm.selectors)({traces:[s=>[s.response],response=>response?.results||[]]}),(0,index_esm.listeners)(_ref8=>{let{actions,values}=_ref8;return{toggleTraceExpanded:async _ref9=>{let{traceId}=_ref9;if(values.expandedTraceIds.has(traceId)&&!values.fullTraces[traceId]&&!values.loadingFullTraces.has(traceId)){actions.loadFullTrace(traceId);let traceQuery={kind:schema_general.OH.TraceQuery,traceId};try{let response=await api.ZP.query(traceQuery);response.results&&response.results[0]?actions.loadFullTraceSuccess(traceId,response.results[0]):actions.loadFullTraceFailure(traceId)}catch(error){console.error("Error loading full trace:",error),actions.loadFullTraceFailure(traceId)}}}}})]);var utils=__webpack_require__("../../products/llm_analytics/frontend/utils.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let scene={component:LLMAnalyticsSessionScene,logic:llmAnalyticsSessionLogic};function LLMAnalyticsSessionScene(){let{sessionId,query}=(0,index_esm.useValues)(llmAnalyticsSessionLogic);return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:llmAnalyticsSessionDataLogic,props:{sessionId,query},children:(0,jsx_runtime.jsx)(SessionSceneWrapper,{})})}function SessionSceneWrapper(){let{traces,responseLoading,responseError,expandedTraceIds,expandedGenerationIds,fullTraces,loadingFullTraces}=(0,index_esm.useValues)(llmAnalyticsSessionDataLogic),{sessionId}=(0,index_esm.useValues)(llmAnalyticsSessionLogic),{toggleTraceExpanded,toggleGenerationExpanded}=(0,index_esm.useActions)(llmAnalyticsSessionDataLogic),sessionStats=traces.reduce((acc,trace)=>({totalCost:acc.totalCost+(trace.totalCost||0),totalLatency:acc.totalLatency+(trace.totalLatency||0),traceCount:acc.traceCount+1,firstSeen:!acc.firstSeen||trace.createdAt<acc.firstSeen?trace.createdAt:acc.firstSeen,lastSeen:!acc.lastSeen||trace.createdAt>acc.lastSeen?trace.createdAt:acc.lastSeen}),{totalCost:0,totalLatency:0,traceCount:0,firstSeen:"",lastSeen:""});return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:responseLoading?(0,jsx_runtime.jsx)(src.t2,{}):responseError?(0,jsx_runtime.jsx)(EmptyStates.jC,{}):traces&&0!==traces.length?(0,jsx_runtime.jsxs)("div",{className:"relative flex flex-col gap-3",children:[(0,jsx_runtime.jsx)(SceneBreadcrumbs.A,{}),(0,jsx_runtime.jsx)("div",{className:"flex items-start justify-between",children:(0,jsx_runtime.jsxs)("header",{className:"flex gap-1.5 flex-wrap",children:[(0,jsx_runtime.jsx)(src.oe,{size:"medium",className:"bg-surface-primary",children:(0,jsx_runtime.jsx)("span",{className:"font-mono",children:sessionId})}),(0,jsx_runtime.jsxs)(src.oe,{size:"medium",className:"bg-surface-primary",children:[sessionStats.traceCount," ",1===sessionStats.traceCount?"trace":"traces"]}),sessionStats.totalCost>0&&(0,jsx_runtime.jsxs)(src.oe,{size:"medium",className:"bg-surface-primary",children:["Total: ",(0,utils.K7)(sessionStats.totalCost)]}),sessionStats.totalLatency>0&&(0,jsx_runtime.jsxs)(src.oe,{size:"medium",className:"bg-surface-primary",children:[sessionStats.totalLatency.toFixed(2),"s"]})]})}),(0,jsx_runtime.jsxs)("div",{className:"bg-surface-primary border rounded p-4",children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold text-sm mb-3",children:"Traces in this session"}),(0,jsx_runtime.jsx)("div",{className:"space-y-2",children:traces.map(trace=>{var _trace$errorCount;let isTraceExpanded=expandedTraceIds.has(trace.id);return(0,jsx_runtime.jsxs)("div",{className:"border rounded",children:[(0,jsx_runtime.jsxs)("div",{className:"p-3 hover:bg-side-light cursor-pointer flex items-start gap-2",onClick:()=>toggleTraceExpanded(trace.id),children:[(0,jsx_runtime.jsx)("div",{className:"flex-shrink-0 mt-0.5",children:isTraceExpanded?(0,jsx_runtime.jsx)(posthog_icons_es.IconChevronDown,{className:"text-lg"}):(0,jsx_runtime.jsx)(posthog_icons_es.IconChevronRight,{className:"text-lg"})}),(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 mb-2 flex-wrap",children:[(0,jsx_runtime.jsxs)("strong",{className:"font-mono text-xs",children:[trace.id.slice(0,8),"..."]}),trace.traceName&&(0,jsx_runtime.jsx)("span",{className:"text-sm",children:trace.traceName}),(null!==(_trace$errorCount=trace.errorCount)&&void 0!==_trace$errorCount?_trace$errorCount:0)>0&&(0,jsx_runtime.jsx)(src.oe,{type:"danger",size:"small",children:1===trace.errorCount?"1 error":`${trace.errorCount} errors`}),"number"==typeof trace.totalLatency&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",children:[trace.totalLatency.toFixed(2),"s"]}),"number"==typeof trace.totalCost&&(0,jsx_runtime.jsx)(src.oe,{type:"muted",children:(0,utils.K7)(trace.totalCost)}),(0,jsx_runtime.jsx)(Link.r,{to:urls.j.llmAnalyticsTrace(trace.id,{timestamp:(0,utils.Wd)(trace.createdAt)}),onClick:e=>e.stopPropagation(),className:"text-xs",children:"View full trace â†’"})]}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted",children:(0,jsx_runtime.jsx)(TZLabel.w,{time:trace.createdAt})})]})]}),isTraceExpanded&&(0,jsx_runtime.jsx)("div",{className:"border-t bg-bg-light",children:(0,jsx_runtime.jsx)("div",{className:"p-3 space-y-2",children:(0,jsx_runtime.jsx)(LLMAnalyticsTraceEvents.C,{trace:fullTraces[trace.id],isLoading:loadingFullTraces.has(trace.id),expandedEventIds:expandedGenerationIds,onToggleEventExpand:toggleGenerationExpanded})})})]},trace.id)})})]})]}):(0,jsx_runtime.jsx)(EmptyStates.dV,{heading:"No traces found",detail:"This session has no traces."})})}},"../../products/llm_analytics/frontend/components/LLMAnalyticsTraceEvents.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{C:()=>LLMAnalyticsTraceEvents});var Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/index.ts"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.35.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),EventDetails=__webpack_require__("../../frontend/src/scenes/activity/explore/EventDetails.tsx"),utils=__webpack_require__("../../products/llm_analytics/frontend/utils.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function LLMAnalyticsEventCard(_ref){let{event,isExpanded,onToggleExpand}=_ref,isGeneration="$ai_generation"===event.event,isEmbedding="$ai_embedding"===event.event,eventForDetails={id:event.id,distinct_id:"",properties:event.properties,event:event.event,timestamp:event.createdAt,elements:[]},latency=event.properties.$ai_latency,hasError=event.properties.$ai_error||event.properties.$ai_is_error,model=event.properties.$ai_model||"Unknown model",cost=event.properties.$ai_total_cost_usd,spanName=event.properties.$ai_span_name||"Unnamed span";return(0,jsx_runtime.jsxs)("div",{className:"border rounded bg-bg-3000",children:[(0,jsx_runtime.jsxs)("div",{className:"p-2 hover:bg-side-light cursor-pointer flex items-center gap-2",onClick:onToggleExpand,children:[(0,jsx_runtime.jsx)("div",{className:"flex-shrink-0",children:isExpanded?(0,jsx_runtime.jsx)(posthog_icons_es.IconChevronDown,{className:"text-base"}):(0,jsx_runtime.jsx)(posthog_icons_es.IconChevronRight,{className:"text-base"})}),(0,jsx_runtime.jsxs)("div",{className:"flex-1 flex items-center gap-2 flex-wrap min-w-0",children:[(0,jsx_runtime.jsx)(src.oe,{type:isGeneration?"success":isEmbedding?"warning":"default",size:"small",className:"uppercase",children:isGeneration?"Generation":isEmbedding?"Embedding":"Span"}),hasError&&(0,jsx_runtime.jsx)(src.oe,{type:"danger",size:"small",children:"Error"}),(0,jsx_runtime.jsx)("span",{className:"text-xs truncate",children:isGeneration||isEmbedding?model:spanName}),"number"==typeof latency&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",size:"small",children:[latency.toFixed(2),"s"]}),(isGeneration||isEmbedding)&&"number"==typeof cost&&(0,jsx_runtime.jsx)(src.oe,{type:"muted",size:"small",children:(0,utils.K7)(cost)})]})]}),isExpanded&&(0,jsx_runtime.jsx)("div",{className:"border-t",children:(0,jsx_runtime.jsx)(EventDetails.T,{event:eventForDetails})})]})}function LLMAnalyticsTraceEvents(_ref){let{trace,isLoading,expandedEventIds,onToggleEventExpand}=_ref;if(isLoading)return(0,jsx_runtime.jsx)(Spinner.$,{});if(!trace)return(0,jsx_runtime.jsx)("div",{className:"text-muted text-sm",children:"Failed to load trace details"});let allEvents=trace.events?.filter(e=>"$ai_generation"===e.event||"$ai_span"===e.event||"$ai_embedding"===e.event).sort((a,b)=>new Date(a.createdAt).getTime()-new Date(b.createdAt).getTime())||[];return 0===allEvents.length?(0,jsx_runtime.jsxs)("div",{className:"text-muted text-sm",children:["No generation, span, or embedding events found in this trace.",trace.events?` (Trace has ${trace.events.length} total events)`:" (No events loaded)"]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:allEvents.map(event=>(0,jsx_runtime.jsx)(LLMAnalyticsEventCard,{event:event,isExpanded:expandedEventIds.has(event.id),onToggleExpand:()=>onToggleEventExpand(event.id)},event.id))})}}}]);