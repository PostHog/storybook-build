"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[61406],{"./frontend/src/scenes/error-tracking/ErrorTrackingScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{ErrorTrackingScene:()=>ErrorTrackingScene,scene:()=>scene});var src=__webpack_require__("./frontend/@posthog/apps-common/src/index.ts"),posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.9.2_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),lemon_ui_src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),FeedbackNotice=__webpack_require__("./frontend/src/lib/components/FeedbackNotice.tsx"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),LemonTableLink=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTable/LemonTableLink.tsx"),urls=__webpack_require__("./frontend/src/scenes/urls.ts"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts"),InsightViz=__webpack_require__("./frontend/src/queries/nodes/InsightViz/InsightViz.tsx"),Query=__webpack_require__("./frontend/src/queries/Query/Query.tsx"),AssigneeSelect=__webpack_require__("./frontend/src/scenes/error-tracking/AssigneeSelect.tsx"),api=__webpack_require__("./frontend/src/lib/api.ts"),dataNodeLogic=__webpack_require__("./frontend/src/queries/nodes/DataNode/dataNodeLogic.ts"),dayjs=__webpack_require__("./frontend/src/lib/dayjs.ts");let mergeIssues=(primaryIssue,mergingIssues)=>{let sum=value=>mergingIssues.reduce((sum,g)=>sum+g[value],primaryIssue[value]),[firstSeen,lastSeen]=mergingIssues.reduce((res,g)=>{let firstSeen=(0,dayjs.Bv)(g.first_seen),lastSeen=(0,dayjs.Bv)(g.last_seen);return[res[0].isAfter(firstSeen)?firstSeen:res[0],res[1].isBefore(lastSeen)?lastSeen:res[1]]},[(0,dayjs.Bv)(primaryIssue.first_seen),(0,dayjs.Bv)(primaryIssue.last_seen)]),volume=primaryIssue.volume;if(volume){let data=mergingIssues.reduce((sum,g)=>g.volume[3].map((num,idx)=>num+sum[idx]),primaryIssue.volume[3]);volume.splice(3,1,data)}return{...primaryIssue,occurrences:sum("occurrences"),sessions:sum("sessions"),users:sum("users"),first_seen:firstSeen.toISOString(),last_seen:lastSeen.toISOString(),volume:volume}},errorTrackingDataNodeLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","error-tracking","errorTrackingDataNodeLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(_ref=>{let{key,query}=_ref;return{values:[(0,dataNodeLogic.M)({key,query}),["response"]],actions:[(0,dataNodeLogic.M)({key,query}),["setResponse","loadData"]]}}),(0,index_esm.actions)({mergeIssues:ids=>({ids}),assignIssue:(id,assigneeId)=>({id,assigneeId})}),(0,index_esm.listeners)(_ref2=>{let{values,actions}=_ref2;return{mergeIssues:async _ref3=>{let{ids}=_ref3,results=values.response?.results,issues=results.filter(_ref4=>{let{id}=_ref4;return ids.includes(id)}),primaryIssue=issues.shift();if(primaryIssue&&issues.length>0){let mergingIds=issues.map(g=>g.id),mergedIssue=mergeIssues(primaryIssue,issues);actions.setResponse({...values.response,results:results.filter(_ref5=>{let{id}=_ref5;return!ids.includes(id)}).map(issue=>mergedIssue.id===issue.id?mergedIssue:issue)}),await api.ZP.errorTracking.mergeInto(primaryIssue.id,mergingIds),actions.loadData(!0)}},assignIssue:async _ref6=>{let{id,assigneeId}=_ref6,response=values.response;if(response){let params={assignee:assigneeId},results=response.results,recordIndex=results.findIndex(r=>r.id===id);if(recordIndex>-1){let issue={...results[recordIndex],...params};results.splice(recordIndex,1,issue),actions.setResponse({...response,results:results}),await api.ZP.errorTracking.updateIssue(issue.id,params),actions.loadData(!0)}}}}})]);var ErrorTrackingFilters=__webpack_require__("./frontend/src/scenes/error-tracking/ErrorTrackingFilters.tsx"),errorTrackingIssueSceneLogic=__webpack_require__("./frontend/src/scenes/error-tracking/errorTrackingIssueSceneLogic.ts"),errorTrackingLogic=__webpack_require__("./frontend/src/scenes/error-tracking/errorTrackingLogic.ts"),errorTrackingSceneLogic=__webpack_require__("./frontend/src/scenes/error-tracking/errorTrackingSceneLogic.ts"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let scene={component:ErrorTrackingScene,logic:errorTrackingSceneLogic.D};function ErrorTrackingScene(){let{query,selectedIssueIds}=(0,index_esm.useValues)(errorTrackingSceneLogic.D),insightProps={dashboardItemId:"new-ErrorTrackingQuery"};return(0,jsx_runtime.jsxs)(index_esm.BindLogic,{logic:errorTrackingDataNodeLogic,props:{query,key:(0,InsightViz.gG)(insightProps)},children:[(0,jsx_runtime.jsx)(Header,{}),(0,jsx_runtime.jsx)(FeedbackNotice.J,{text:"Error tracking is in closed alpha. Thanks for taking part! We'd love to hear what you think."}),(0,jsx_runtime.jsx)(ErrorTrackingFilters.ZP.FilterGroup,{}),(0,jsx_runtime.jsx)(lemon_ui_src.p2,{className:"mt-2"}),0===selectedIssueIds.length?(0,jsx_runtime.jsx)(ErrorTrackingFilters.ZP.Options,{}):(0,jsx_runtime.jsx)(ErrorTrackingActions,{}),(0,jsx_runtime.jsx)(Query.A,{query:query,context:{columns:{error:{width:"50%",render:CustomGroupTitleColumn},occurrences:{align:"center"},sessions:{align:"center"},users:{align:"center"},volume:{renderTitle:CustomVolumeColumnHeader},assignee:{render:AssigneeColumn}},showOpenEditorButton:!1,insightProps:insightProps}})]})}let ErrorTrackingActions=()=>{let{selectedIssueIds}=(0,index_esm.useValues)(errorTrackingSceneLogic.D),{setSelectedIssueIds}=(0,index_esm.useActions)(errorTrackingSceneLogic.D),{mergeIssues}=(0,index_esm.useActions)(errorTrackingDataNodeLogic);return(0,jsx_runtime.jsxs)("div",{className:"sticky top-[var(--breadcrumbs-height-compact)] z-20 py-2 bg-bg-3000 flex space-x-1",children:[(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{type:"secondary",size:"small",onClick:()=>setSelectedIssueIds([]),children:"Unselect all"}),selectedIssueIds.length>1&&(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{type:"secondary",size:"small",onClick:()=>{mergeIssues(selectedIssueIds),setSelectedIssueIds([])},children:"Merge"})]})},CustomVolumeColumnHeader=_ref=>{let{columnName}=_ref,{sparklineSelectedPeriod,sparklineOptions:options}=(0,index_esm.useValues)(errorTrackingLogic.H),{setSparklineSelectedPeriod}=(0,index_esm.useActions)(errorTrackingLogic.H);return sparklineSelectedPeriod?(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center min-w-64",children:[(0,jsx_runtime.jsx)("div",{children:columnName}),(0,jsx_runtime.jsx)(lemon_ui_src.P4,{size:"xsmall",value:sparklineSelectedPeriod,options:options,onChange:value=>setSparklineSelectedPeriod(value)})]}):null},CustomGroupTitleColumn=props=>{let{hasGroupActions}=(0,index_esm.useValues)(errorTrackingLogic.H),{selectedIssueIds}=(0,index_esm.useValues)(errorTrackingSceneLogic.D),{setSelectedIssueIds}=(0,index_esm.useActions)(errorTrackingSceneLogic.D),record=props.record,checked=selectedIssueIds.includes(record.id);return(0,jsx_runtime.jsxs)("div",{className:"flex items-start space-x-1.5 group",children:[hasGroupActions&&(0,jsx_runtime.jsx)(lemon_ui_src.Hw,{className:(0,clsx_m.default)("pt-1 group-hover:visible",!checked&&"invisible"),checked:checked,onChange:newValue=>{setSelectedIssueIds(newValue?[...new Set([...selectedIssueIds,record.id])]:selectedIssueIds.filter(id=>id!=record.id))}}),(0,jsx_runtime.jsx)(LemonTableLink.i,{title:record.name||"Unknown Type",description:(0,jsx_runtime.jsxs)("div",{className:"space-y-1",children:[(0,jsx_runtime.jsx)("div",{className:"line-clamp-1",children:record.description}),(0,jsx_runtime.jsxs)("div",{className:"space-x-1",children:[(0,jsx_runtime.jsx)(src.w4,{time:record.first_seen,className:"border-dotted border-b"}),(0,jsx_runtime.jsx)("span",{children:"|"}),(0,jsx_runtime.jsx)(src.w4,{time:record.last_seen,className:"border-dotted border-b"})]})]}),className:"flex-1",to:urls.j.errorTrackingIssue(record.id),onClick:()=>{let issueLogic=(0,errorTrackingIssueSceneLogic.H)({id:record.id});issueLogic.mount(),issueLogic.actions.setIssue(record)}})]})},AssigneeColumn=props=>{let{assignIssue}=(0,index_esm.useActions)(errorTrackingDataNodeLogic),record=props.record;return(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:(0,jsx_runtime.jsx)(AssigneeSelect.i,{assignee:record.assignee,onChange:assigneeId=>assignIssue(record.id,assigneeId)})})},Header=()=>{let{user}=(0,index_esm.useValues)(userLogic.userLogic);return(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[user?.is_staff?(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{onClick:()=>{throw Error("Oh my!")},children:"Send an exception"}):null,(0,jsx_runtime.jsx)(lemon_ui_src.Jp,{to:urls.j.errorTrackingConfiguration(),type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGear,{}),children:"Configure"})]})})}}}]);