(window.webpackJsonp=window.webpackJsonp||[]).push([[260],{"./frontend/src/scenes/instance/AsyncMigrations/AsyncMigrations.tsx":function(ye,L,s){"use strict";s.r(L),s.d(L,"scene",function(){return oe}),s.d(L,"AsyncMigrations",function(){return G});var ve=s("./node_modules/core-js/modules/es.symbol.js"),Ee=s("./node_modules/core-js/modules/es.symbol.description.js"),Me=s("./node_modules/core-js/modules/es.array.join.js"),Se=s("./node_modules/core-js/modules/es.array.map.js"),he=s("./node_modules/core-js/modules/es.function.name.js"),Ae=s("./node_modules/core-js/modules/es.regexp.exec.js"),be=s("./node_modules/core-js/modules/es.string.split.js"),P=s("./node_modules/react/index.js"),e=s.n(P),V=s("./frontend/src/lib/components/PageHeader.tsx"),$=s("./node_modules/antd/es/tabs/index.js"),J=s("./node_modules/antd/es/progress/index.js"),W=s("./node_modules/antd/es/button/index.js"),Q=s("./node_modules/antd/es/space/index.js"),b=s("./node_modules/kea/lib/index.esm.js"),X=s("./node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js"),je=s("./node_modules/core-js/modules/es.array.filter.js"),Re=s("./node_modules/core-js/modules/es.array.includes.js"),Ie=s("./node_modules/core-js/modules/es.array.iterator.js"),Oe=s("./node_modules/core-js/modules/es.array.some.js"),Te=s("./node_modules/core-js/modules/es.object.to-string.js"),Ce=s("./node_modules/core-js/modules/es.string.includes.js"),Fe=s("./node_modules/core-js/modules/web.dom-collections.iterator.js"),Z=s("./node_modules/@babel/runtime/regenerator/index.js"),f=s.n(Z),Le=s("./node_modules/regenerator-runtime/runtime.js"),q=s("./node_modules/@babel/runtime/helpers/asyncToGenerator.js"),S=s.n(q),_=s("./node_modules/@babel/runtime/helpers/defineProperty.js"),T=s.n(_),h=s("./frontend/src/lib/api.ts"),k=s("./frontend/src/scenes/userLogic.ts"),E=s("./frontend/src/lib/components/lemonToast.tsx");function B(r,n){var a=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);n&&(i=i.filter(function(u){return Object.getOwnPropertyDescriptor(r,u).enumerable})),a.push.apply(a,i)}return a}function A(r){for(var n=1;n<arguments.length;n++){var a=arguments[n]!=null?arguments[n]:{};n%2?B(Object(a),!0).forEach(function(i){T()(r,i,a[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(a)):B(Object(a)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(a,i))})}return r}var p;(function(r){r[r.NotStarted=0]="NotStarted",r[r.Running=1]="Running",r[r.CompletedSuccessfully=2]="CompletedSuccessfully",r[r.Errored=3]="Errored",r[r.RolledBack=4]="RolledBack",r[r.Starting=5]="Starting",r[r.FailedAtStartup=6]="FailedAtStartup"})(p||(p={}));var j;(function(r){r.Management="management",r.Settings="settings"})(j||(j={}));var ee={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},O=Object(b.kea)({path:["scenes","instance","AsyncMigrations","asyncMigrationsLogic"],actions:{triggerMigration:function(n){return{migrationId:n}},resumeMigration:function(n){return{migrationId:n}},rollbackMigration:function(n){return{migrationId:n}},forceStopMigration:function(n){return{migrationId:n}},forceStopMigrationWithoutRollback:function(n){return{migrationId:n}},setActiveTab:function(n){return{tab:n}},updateSetting:function(n,a){return{settingKey:n,newValue:a}},loadAsyncMigrationErrors:function(n){return{migrationId:n}},loadAsyncMigrationErrorsSuccess:function(n,a){return{migrationId:n,errors:a}},loadAsyncMigrationErrorsFailure:function(n,a){return{migrationId:n,error:a}}},reducers:{activeTab:[j.Management,{setActiveTab:function(n,a){var i=a.tab;return i}}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:function(n,a){var i=a.migrationId,u=a.errors;return A(A({},n),{},T()({},i,u))}}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:function(n,a){var i=a.migrationId;return A(A({},n),{},T()({},i,!0))},loadAsyncMigrationErrorsSuccess:function(n,a){var i=a.migrationId;return A(A({},n),{},T()({},i,!1))},loadAsyncMigrationErrorsFailure:function(n,a){var i=a.migrationId;return A(A({},n),{},T()({},i,!1))}}]},loaders:function(){return{asyncMigrations:[[],{loadAsyncMigrations:function(){var n=S()(f.a.mark(function i(){var u;return f.a.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(!((u=k.a.values.user)===null||u===void 0)&&u.is_staff){d.next=2;break}return d.abrupt("return",[]);case 2:return d.next=4,h.b.get("api/async_migrations");case 4:return d.abrupt("return",d.sent.results);case 5:case"end":return d.stop()}},i)}));function a(){return n.apply(this,arguments)}return a}()}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:function(){var n=S()(f.a.mark(function i(){var u,c;return f.a.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(!((u=k.a.values.user)===null||u===void 0)&&u.is_staff){l.next=2;break}return l.abrupt("return",[]);case 2:return l.next=4,h.b.get("api/instance_settings");case 4:return c=l.sent.results,l.abrupt("return",c.filter(function(o){return o.key.includes("ASYNC_MIGRATIONS")}));case 6:case"end":return l.stop()}},i)}));function a(){return n.apply(this,arguments)}return a}()}]}},selectors:{isAnyMigrationRunning:[function(r){return[r.asyncMigrations]},function(r){return r.some(function(n){return[p.Running,p.Starting].includes(n.status)})}]},listeners:function(n){var a=n.actions;return{triggerMigration:function(){var i=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return l=d.migrationId,t.next=3,h.b.create("/api/async_migrations/".concat(l,"/trigger"));case 3:o=t.sent,o.success?(E.a.success("Migration triggered successfully"),a.loadAsyncMigrations()):E.a.error(o.error);case 5:case"end":return t.stop()}},c)}));function u(c){return i.apply(this,arguments)}return u}(),resumeMigration:function(){var i=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return l=d.migrationId,t.next=3,h.b.create("/api/async_migrations/".concat(l,"/resume"));case 3:o=t.sent,o.success?(E.a.success("Migration resume triggered successfully"),a.loadAsyncMigrations()):E.a.error(o.error);case 5:case"end":return t.stop()}},c)}));function u(c){return i.apply(this,arguments)}return u}(),rollbackMigration:function(){var i=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return l=d.migrationId,t.next=3,h.b.create("/api/async_migrations/".concat(l,"/rollback"));case 3:o=t.sent,o.success?(E.a.success("Migration rolledback triggered successfully"),a.loadAsyncMigrations()):E.a.error(o.error);case 5:case"end":return t.stop()}},c)}));function u(c){return i.apply(this,arguments)}return u}(),forceStopMigration:function(){var i=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return l=d.migrationId,t.next=3,h.b.create("/api/async_migrations/".concat(l,"/force_stop"));case 3:o=t.sent,o.success?(E.a.success("Force stop triggered successfully"),a.loadAsyncMigrations()):E.a.error(o.error);case 5:case"end":return t.stop()}},c)}));function u(c){return i.apply(this,arguments)}return u}(),forceStopMigrationWithoutRollback:function(){var i=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return l=d.migrationId,t.next=3,h.b.create("/api/async_migrations/".concat(l,"/force_stop_without_rollback"));case 3:o=t.sent,o.success?(E.a.success("Force stop without rollback triggered successfully"),a.loadAsyncMigrations()):E.a.error(o.error);case 5:case"end":return t.stop()}},c)}));function u(c){return i.apply(this,arguments)}return u}(),updateSetting:function(){var i=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return l=d.settingKey,o=d.newValue,t.prev=1,t.next=4,h.b.update("/api/instance_settings/".concat(l),{value:o});case 4:E.a.success("Instance setting ".concat(l," updated")),a.loadAsyncMigrationSettings(),t.next=11;break;case 8:t.prev=8,t.t0=t.catch(1),E.a.error("Failed to trigger migration");case 11:case"end":return t.stop()}},c,null,[[1,8]])}));function u(c){return i.apply(this,arguments)}return u}(),loadAsyncMigrationErrors:function(){var i=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return l=d.migrationId,t.prev=1,t.next=4,h.b.get("api/async_migrations/".concat(l,"/errors"));case 4:o=t.sent,a.loadAsyncMigrationErrorsSuccess(l,o),t.next=11;break;case 8:t.prev=8,t.t0=t.catch(1),a.loadAsyncMigrationErrorsFailure(l,t.t0);case 11:case"end":return t.stop()}},c,null,[[1,8]])}));function u(c){return i.apply(this,arguments)}return u}()}},events:function(n){var a=n.actions;return{afterMount:function(){a.loadAsyncMigrations(),a.loadAsyncMigrationSettings()}}}}),U=s("./frontend/src/lib/components/Tooltip.tsx"),x=s("./frontend/src/lib/components/Spinner/Spinner.tsx"),ne=s("./node_modules/@babel/runtime/helpers/slicedToArray.js"),re=s.n(ne),te=s("./node_modules/antd/es/row/index.js"),K=s("./node_modules/antd/es/col/index.js"),ae=s("./node_modules/antd/es/input/index.js"),se=s("./node_modules/antd/es/divider/index.js");function C(r){var n=r.setting,a=Object(b.useActions)(O),i=a.updateSetting,u=Object(P.useState)(String(n.value)),c=re()(u,2),d=c[0],l=c[1];return e.a.createElement("div",{key:n.key},e.a.createElement("h4",null,n.key),e.a.createElement("p",null,n.description),e.a.createElement(te.a,{gutter:[8,8]},e.a.createElement(K.a,{span:8},e.a.createElement(ae.a,{value:d,onChange:function(M){return l(M.target.value)}})),e.a.createElement(K.a,{span:16},e.a.createElement(W.a,{disabled:String(n.value)===d,type:"primary",onClick:function(){return i(n.key,d)}},"Update"))),e.a.createElement(se.a,null))}try{C.displayName="SettingUpdateField",C.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"InstanceSetting"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:C.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(r){}var w=s("./frontend/src/lib/components/LemonTable/index.ts"),N=s("./frontend/src/lib/utils.tsx"),R=s("./frontend/src/lib/components/LemonButton/index.ts"),D=s("./frontend/src/lib/components/icons.tsx");function F(r){var n=r.asyncMigration,a=Object(b.useValues)(O),i=a.asyncMigrationErrorsLoading,u=a.asyncMigrationErrors,c=Object(b.useActions)(O),d=c.loadAsyncMigrationErrors,l=[{title:"Error",dataIndex:"description"},{title:e.a.createElement(R.a,{icon:i[n.id]?e.a.createElement(x.a,{size:"sm"}):e.a.createElement(D.IconRefresh,null),onClick:function(){return d(n.id)},type:"secondary",compact:!0},"Refresh errors"),render:function(M,t){return e.a.createElement("div",null,Object(N.M)(t.created_at))}}];return e.a.createElement(w.a,{columns:l,dataSource:u[n.id],loading:i[n.id],embedded:!0})}try{F.displayName="AsyncMigrationDetails",F.__docgenInfo={description:"",displayName:"AsyncMigrationDetails",props:{asyncMigration:{defaultValue:null,description:"",name:"asyncMigration",required:!0,type:{name:"AsyncMigration"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"]={docgenInfo:F.__docgenInfo,name:"AsyncMigrationDetails",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"})}catch(r){}var Y=s("./frontend/src/lib/components/LemonButton/More.tsx"),ie=s("./frontend/src/lib/components/LemonTag/LemonTag.tsx"),z=$.a.TabPane,oe={component:G,logic:O},le=3e3;function G(){var r=Object(b.useValues)(k.a),n=r.user,a=Object(b.useValues)(O),i=a.asyncMigrations,u=a.asyncMigrationsLoading,c=a.activeTab,d=a.asyncMigrationSettings,l=a.isAnyMigrationRunning,o=Object(b.useActions)(O),M=o.triggerMigration,t=o.resumeMigration,ce=o.rollbackMigration,ue=o.forceStopMigration,de=o.forceStopMigrationWithoutRollback,H=o.loadAsyncMigrations,ge=o.loadAsyncMigrationErrors,me=o.setActiveTab;Object(P.useEffect)(function(){if(l){var y=setInterval(function(){return H()},le);return function(){return clearInterval(y)}}},[l]);var fe=[{title:"Migration",render:function(v,m){var g="https://posthog.com/docs/self-host/configure/async-migrations/"+m.name.split("_").join("-");return e.a.createElement(e.a.Fragment,null,e.a.createElement("div",{className:"row-name"},e.a.createElement("a",{href:g},m.name)),e.a.createElement("div",{className:"row-description"},m.description))}},{title:"Progress",render:function(v,m){var g=m.progress;return e.a.createElement("div",null,e.a.createElement(J.a,{percent:g}))}},{title:"Status",render:function(v,m){var g=m.status,I=g===p.Running?"success":g===p.Errored||g===p.FailedAtStartup?"danger":g===p.Starting||g===p.RolledBack?"warning":"default";return e.a.createElement(ie.a,{type:I},ee[g])}},{title:"Last operation index",dataIndex:"current_operation_index"},{title:"Last query ID",render:function(v,m){return e.a.createElement("div",null,e.a.createElement("small",null,m.current_query_id))}},{title:"Started at",render:function(v,m){var g=m.started_at;return e.a.createElement("div",null,Object(N.M)(g))}},{title:"Finished at",render:function(v,m){var g=m.finished_at;return e.a.createElement("div",null,Object(N.M)(g))}},{title:"",render:function(v,m){var g=m.status;return e.a.createElement("div",null,g===p.NotStarted||g===p.FailedAtStartup?e.a.createElement(U.a,{title:"Start"},e.a.createElement(W.a,{type:"link",icon:e.a.createElement(X.a,null),onClick:function(){return M(m.id)}},"Run")):g===p.Running?e.a.createElement(Y.a,{overlay:e.a.createElement(e.a.Fragment,null,e.a.createElement(R.a,{type:"stealth",onClick:function(){return ue(m.id)},fullWidth:!0},"Stop and rollback"),e.a.createElement(R.a,{type:"stealth",onClick:function(){return de(m.id)},fullWidth:!0},"Stop"))}):g===p.CompletedSuccessfully?e.a.createElement(e.a.Fragment,null):g===p.Errored?e.a.createElement(Y.a,{overlay:e.a.createElement(e.a.Fragment,null,e.a.createElement(R.a,{type:"stealth",onClick:function(){return t(m.id)},fullWidth:!0},"Resume"),e.a.createElement(R.a,{type:"stealth",onClick:function(){return ce(m.id)},fullWidth:!0},"Rollback"))}):g===p.RolledBack?e.a.createElement(U.a,{title:"Restart"},e.a.createElement(R.a,{type:"stealth",icon:e.a.createElement(D.IconReplay,null),onClick:function(){return M(m.id)},fullWidth:!0})):g===p.Starting?e.a.createElement(x.a,{size:"sm"}):null)}}],pe={expandedRowRender:function(v){return v&&e.a.createElement(F,{asyncMigration:v})},rowExpandable:function(v){return v.error_count>0},onRowExpand:function(v){ge(v.id)}};return e.a.createElement("div",null,n!=null&&n.is_staff?e.a.createElement(e.a.Fragment,null,e.a.createElement(V.a,{title:"Async Migrations",caption:e.a.createElement(e.a.Fragment,null,e.a.createElement("p",null,"Manage async migrations in your instance."),e.a.createElement("p",null,"Read about async migrations on our"," ",e.a.createElement("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations"},"dedicated docs page"),"."))}),e.a.createElement($.a,{activeKey:c,onChange:function(v){return me(v)}},e.a.createElement(z,{tab:"Management",key:j.Management}),e.a.createElement(z,{tab:"Settings",key:j.Settings})),c===j.Management?e.a.createElement(e.a.Fragment,null,e.a.createElement("div",{className:"mb float-right"},e.a.createElement(R.a,{icon:u?e.a.createElement(x.a,{size:"sm"}):e.a.createElement(D.IconRefresh,null),onClick:H,type:"secondary",compact:!0},"Refresh")),e.a.createElement(Q.b,null),e.a.createElement(w.a,{pagination:{pageSize:10},loading:u,columns:fe,dataSource:i,expandable:pe})):c===j.Settings?e.a.createElement(e.a.Fragment,null,e.a.createElement("br",null),d.map(function(y){return e.a.createElement("div",{key:y.key},e.a.createElement(C,{setting:y}))})):null):e.a.createElement(V.a,{title:"Async Migrations",caption:e.a.createElement(e.a.Fragment,null,e.a.createElement("p",null,"Only users with staff access can manage async migrations. Please contact your instance admin."),e.a.createElement("p",null,"If you're an admin and don't have access, set ",e.a.createElement("code",null,"is_staff=true")," for your user on the PostgreSQL ",e.a.createElement("code",null,"posthog_user")," table."))}))}}}]);
