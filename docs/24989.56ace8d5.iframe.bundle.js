"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[24989,31840],{"../../frontend/src/scenes/data-warehouse/DataWarehouseScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{DataWarehouseScene:()=>DataWarehouseScene,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.28.1_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),LemonTable=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/index.ts"),LemonTableLink=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/LemonTableLink.tsx"),PaginationControl=__webpack_require__("../../frontend/src/lib/lemon-ui/PaginationControl/index.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),types=__webpack_require__("../../frontend/src/types.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),dist_module=__webpack_require__("../../node_modules/.pnpm/posthog-js@1.261.2_@rrweb+types@2.0.0-alpha.17/node_modules/posthog-js/dist/module.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),billingLogic=__webpack_require__("../../frontend/src/scenes/billing/billingLogic.tsx"),databaseTableListLogic=__webpack_require__("../../frontend/src/scenes/data-management/database/databaseTableListLogic.ts"),externalDataSourcesLogic=__webpack_require__("../../frontend/src/scenes/data-warehouse/externalDataSourcesLogic.ts"),dataWarehouseViewsLogic=__webpack_require__("../../frontend/src/scenes/data-warehouse/saved_queries/dataWarehouseViewsLogic.tsx");let dataWarehouseSceneLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-warehouse","dataWarehouseSceneLogic"]),(0,index_esm.connect)(()=>({values:[databaseTableListLogic.A,["dataWarehouseTables","views","databaseLoading"],externalDataSourcesLogic.W,["dataWarehouseSources","dataWarehouseSourcesLoading"],billingLogic.billingLogic,["billingPeriodUTC"],dataWarehouseViewsLogic.$,["dataWarehouseSavedQueryMapById"]],actions:[databaseTableListLogic.A,["loadDatabase"],externalDataSourcesLogic.W,["loadSources","loadSourcesSuccess"]]})),(0,index_esm.actions)({loadMoreRecentActivity:!0,setActivityCurrentPage:page=>({page}),checkAutoLoadMore:!0}),(0,lib.loaders)(()=>({totalRowsStats:[{},{loadTotalRowsStats:async()=>await api.ZP.dataWarehouse.totalRowsStats()}],recentActivityResponse:[null,{loadRecentActivityResponse:async()=>await api.ZP.dataWarehouse.recentActivity({limit:20,offset:0})}]})),(0,index_esm.reducers)(()=>({activityCurrentPage:[1,{setActivityCurrentPage:(_,_ref)=>{let{page}=_ref;return page},loadRecentActivityResponse:()=>1}],recentActivityMoreLoading:[!1,{loadMoreRecentActivity:()=>!0,loadRecentActivityResponseSuccess:()=>!1}]})),(0,index_esm.selectors)({recentActivity:[s=>[s.recentActivityResponse],response=>response?.results||[]],recentActivityHasMore:[s=>[s.recentActivityResponse],response=>!!response?.next],selfManagedTables:[s=>[s.dataWarehouseTables],dataWarehouseTables=>dataWarehouseTables.filter(table=>!table.source)],computedAllSources:[s=>[s.dataWarehouseSources,s.recentActivity,s.selfManagedTables,s.billingPeriodUTC,s.totalRowsStats],(dataWarehouseSources,recentActivity,selfManagedTables,billingPeriodUTC,totalRowsStats)=>{let billingPeriodStart=billingPeriodUTC?.start,billingPeriodEnd=billingPeriodUTC?.end;return[...(dataWarehouseSources?.results||[]).map(source=>{var _totalRowsStats$break;let sourceActivities=(recentActivity||[]).filter(a=>!billingPeriodStart||!billingPeriodEnd||(0,dayjs.Bv)(a.created_at).isAfter(billingPeriodStart.subtract(1,"millisecond"))&&(0,dayjs.Bv)(a.created_at).isBefore(billingPeriodEnd)),totalRows=null!==(_totalRowsStats$break=totalRowsStats?.breakdown_of_rows_by_source?.[source.id])&&void 0!==_totalRowsStats$break?_totalRowsStats$break:0,sortedActivities=sourceActivities.sort((a,b)=>(0,dayjs.Bv)(b.created_at).valueOf()-(0,dayjs.Bv)(a.created_at).valueOf()),lastSync=sortedActivities.length>0?sortedActivities[0].created_at:null;return{id:source.id,name:source.source_type,status:source.status,lastSync,rowCount:totalRows,url:urls.j.dataWarehouseSource(`managed-${source.id}`)}}),...(selfManagedTables||[]).map(table=>{var _table$row_count;return{id:table.id,name:table.name,status:null,lastSync:null,rowCount:null!==(_table$row_count=table.row_count)&&void 0!==_table$row_count?_table$row_count:null,url:urls.j.dataWarehouseSource(`self-managed-${table.id}`)}})]}],activityPaginationState:[s=>[s.recentActivity,s.activityCurrentPage],(recentActivity,activityCurrentPage)=>{let totalData=recentActivity.length,pageCount=Math.ceil(totalData/5),startIndex=(activityCurrentPage-1)*5,endIndex=Math.min(startIndex+5,totalData),dataSourcePage=recentActivity.slice(startIndex,endIndex);return{currentPage:activityCurrentPage,pageCount,dataSourcePage,currentStartIndex:startIndex,currentEndIndex:endIndex,entryCount:totalData,isOnLastPage:activityCurrentPage===pageCount,hasDataOnCurrentPage:dataSourcePage.length>0}}],materializedViews:[s=>[s.views,s.dataWarehouseSavedQueryMapById],(views,dataWarehouseSavedQueryMapById)=>views.filter(view=>dataWarehouseSavedQueryMapById[view.id]?.status).map(view=>({...view,type:"materialized_view",last_run_at:dataWarehouseSavedQueryMapById[view.id]?.last_run_at,status:dataWarehouseSavedQueryMapById[view.id]?.status}))],tablesLoading:[s=>[s.databaseLoading,s.dataWarehouseSourcesLoading],(databaseLoading,dataWarehouseSourcesLoading)=>databaseLoading||dataWarehouseSourcesLoading]}),(0,index_esm.listeners)(_ref2=>{let{cache,values,actions}=_ref2;return{setActivityCurrentPage:()=>{actions.checkAutoLoadMore()},checkAutoLoadMore:()=>{let{isOnLastPage,hasDataOnCurrentPage}=values.activityPaginationState,{recentActivityHasMore,recentActivityResponseLoading}=values;isOnLastPage&&hasDataOnCurrentPage&&recentActivityHasMore&&!recentActivityResponseLoading&&actions.loadMoreRecentActivity()},loadMoreRecentActivity:async()=>{try{let currentData=values.recentActivity,response=await api.ZP.dataWarehouse.recentActivity({limit:20,offset:currentData.length}),newData=[...currentData,...response.results||[]],newResponse={...response,results:newData};actions.loadRecentActivityResponseSuccess(newResponse)}catch(error){dist_module.ZP.captureException(error)}},loadSourcesSuccess:()=>{clearTimeout(cache.refreshTimeout),kea_router_lib.router.values.location.pathname.includes("data-warehouse")&&(cache.refreshTimeout=setTimeout(()=>{actions.loadSources(null)},1e4))}}}),(0,index_esm.afterMount)(_ref3=>{let{actions}=_ref3;actions.loadSources(null),actions.loadRecentActivityResponse(),actions.loadTotalRowsStats()}),(0,index_esm.beforeUnmount)(_ref4=>{let{cache}=_ref4;clearTimeout(cache.refreshTimeout)})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let scene={component:DataWarehouseScene,logic:dataWarehouseSceneLogic};function DataWarehouseScene(){var _totalRowsStats$total;let{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.featureFlagLogic),{materializedViews,activityPaginationState,computedAllSources,totalRowsStats,tablesLoading}=(0,index_esm.useValues)(dataWarehouseSceneLogic),{setActivityCurrentPage}=(0,index_esm.useActions)(dataWarehouseSceneLogic),sourcesPagination=(0,PaginationControl.h)(computedAllSources,{pageSize:5},"sources"),viewsPagination=(0,PaginationControl.h)(materializedViews||[],{pageSize:5},"views"),activityPagination={currentPage:activityPaginationState.currentPage,pageCount:activityPaginationState.pageCount,dataSourcePage:activityPaginationState.dataSourcePage,currentStartIndex:activityPaginationState.currentStartIndex,currentEndIndex:activityPaginationState.currentEndIndex,entryCount:activityPaginationState.entryCount,setCurrentPage:setActivityCurrentPage,pagination:{pageSize:5}},sourceColumns=[{title:"Name",key:"name",render:(_,source)=>{var _source$status;return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-1",children:[(0,jsx_runtime.jsx)(StatusIcon,{status:null!==(_source$status=source.status)&&void 0!==_source$status?_source$status:void 0}),source.url?(0,jsx_runtime.jsx)(LemonTableLink.i,{to:source.url,title:source.name}):(0,jsx_runtime.jsx)("span",{children:source.name})]})}},{title:"Last sync",key:"lastSync",tooltip:"Time of the last successful data synchronization",render:(_,source)=>source.lastSync?(0,jsx_runtime.jsx)(TZLabel.w,{time:source.lastSync}):"—"},{title:"Rows",key:"rowCount",align:"right",tooltip:"Total number of rows in this data source",render:(_,source)=>null!==source.rowCount?source.rowCount.toLocaleString():"0"},{title:"Status",key:"status",align:"right",render:(_,source)=>source.status?(0,jsx_runtime.jsx)(StatusTag,{status:source.status}):"—"}],viewColumns=[{title:"Name",key:"name",render:(_,view)=>(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-1",children:[(0,jsx_runtime.jsx)(StatusIcon,{status:view.status}),(0,jsx_runtime.jsx)(LemonTableLink.i,{to:urls.j.sqlEditor(void 0,view.id),title:view.name})]})},{title:"Last run",key:"last_run_at",tooltip:"Time of the last materialization run",render:(_,view)=>view.last_run_at?(0,jsx_runtime.jsx)(TZLabel.w,{time:view.last_run_at}):"Never"},{title:"Rows",key:"row_count",align:"right",tooltip:"Number of rows in the materialized view",render:(_,view)=>void 0!==view.row_count&&null!==view.row_count?view.row_count.toLocaleString():"0"},{title:"Status",key:"status",align:"right",render:(_,view)=>(0,jsx_runtime.jsx)(StatusTag,{status:view.status})}],activityColumns=[{title:"Activity",key:"name",render:(_,activity)=>(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-1",children:[(0,jsx_runtime.jsx)(StatusIcon,{status:activity.status}),(0,jsx_runtime.jsx)("span",{children:activity.name}),(0,jsx_runtime.jsx)(src.oe,{size:"medium",type:"muted",className:"px-1 rounded-lg ml-1",children:activity.type})]})},{title:"When",key:"created_at",tooltip:"Time when this job was created",render:(_,activity)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:activity.created_at})},{title:"Rows",key:"rows",align:"right",tooltip:"Number of rows processed in this job",render:(_,activity)=>null!==activity.rows?activity.rows.toLocaleString():"0"},{title:"Status",key:"status",align:"right",render:(_,activity)=>(0,jsx_runtime.jsx)(StatusTag,{status:activity.status})}],StatusIcon=_ref=>{let{status}=_ref,s=(status||"").toLowerCase();return"failed"===s||"error"===s?(0,jsx_runtime.jsx)(icons.uR,{className:"text-danger"}):"warning"===s||s.includes("billing")?(0,jsx_runtime.jsx)(icons.qV,{className:"text-warning"}):"running"===s?(0,jsx_runtime.jsx)(icons.JK,{className:"animate-spin"}):"completed"===s||"success"===s?(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{className:"text-success"}):(0,jsx_runtime.jsx)(icons.i4,{className:"text-muted"})},StatusTag=_ref2=>{let{status}=_ref2,s=(status||"").toLowerCase(),type=["failed","error"].includes(s)?"danger":"warning"===s?"warning":["completed","success"].includes(s)?"success":"running"===s?"none":"muted",size=["completed","failed","error"].includes(s)?"medium":"small";return(0,jsx_runtime.jsx)(src.oe,{size:size,type:type,className:"px-1 rounded-lg",style:"none"===type?{color:"#3b82f6",borderColor:"#3b82f6"}:void 0,children:s||"—"})},materializedCount=materializedViews.length,runningCount=materializedViews.filter(v=>v.status?.toLowerCase()==="running").length;return featureFlags[constants.y8.DATA_WAREHOUSE_SCENE]?(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsx)("h1",{className:"text-2xl font-semibold",children:"Data Warehouse"}),(0,jsx_runtime.jsx)("p",{className:"text-muted",children:"Manage your data warehouse sources and queries"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"primary",to:urls.j.dataWarehouseSourceNew(),icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),children:"New source"}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",to:urls.j.sqlEditor(),children:"Create view"})]})]}),(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,jsx_runtime.jsxs)(src.Mi,{className:"p-4 hover:transform-none",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-start gap-1",children:[(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:"Rows Processed (in current billing period)"}),(0,jsx_runtime.jsx)(src.u,{title:"Total rows processed this month by all data sources and materialized views",placement:"bottom",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-muted mt-0.5"})})]}),(0,jsx_runtime.jsxs)("div",{className:"text-2xl font-semibold mt-1",children:[(null!==(_totalRowsStats$total=totalRowsStats?.total_rows)&&void 0!==_totalRowsStats$total?_totalRowsStats$total:0).toLocaleString()," "]})]}),(0,jsx_runtime.jsxs)(src.Mi,{className:"p-4 hover:transform-none",children:[(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:"Materialized Views"}),(0,jsx_runtime.jsx)("div",{className:"text-2xl font-semibold mt-1",children:materializedCount}),runningCount>0&&(0,jsx_runtime.jsxs)("div",{className:"text-xs text-muted",children:[runningCount," running"]})]})]}),(0,jsx_runtime.jsx)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-3",children:(0,jsx_runtime.jsxs)("div",{className:"lg:col-span-2 space-y-2",children:[(0,jsx_runtime.jsxs)(src.Mi,{className:"hover:transform-none",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold text-xl",children:"Data Sources"}),(0,jsx_runtime.jsxs)(src.oe,{size:"medium",type:"muted",className:"mb-2 p-1 px-2 rounded-xl",children:[computedAllSources.length," connected"]})]}),(0,jsx_runtime.jsx)(src.Jp,{to:urls.j.pipeline(types.J9.Sources),size:"small",type:"secondary",className:"mb-3",children:"View All"})]}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:sourcesPagination.dataSourcePage,columns:sourceColumns,rowKey:"id",loading:tablesLoading,loadingSkeletonRows:3}),(0,jsx_runtime.jsx)(PaginationControl.R,{...sourcesPagination,nouns:["source","sources"]})]}),(0,jsx_runtime.jsxs)(src.Mi,{className:"hover:transform-none",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold text-xl",children:"Views"}),(0,jsx_runtime.jsxs)(src.oe,{size:"medium",type:"muted",className:"mb-2 p-1 px-2 rounded-xl",children:[materializedViews?.length||0," views"]})]}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:viewsPagination.dataSourcePage,columns:viewColumns,rowKey:"id",loading:tablesLoading,loadingSkeletonRows:3}),(0,jsx_runtime.jsx)(PaginationControl.R,{...viewsPagination,nouns:["view","views"]})]}),(0,jsx_runtime.jsxs)(src.Mi,{className:"hover:transform-none",children:[(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-between",children:(0,jsx_runtime.jsx)("h3",{className:"font-semibold text-xl",children:"Recent Activity"})}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:activityPagination.dataSourcePage,columns:activityColumns,rowKey:r=>`${r.type}-${r.name}-${r.created_at}`,loading:tablesLoading,loadingSkeletonRows:3}),(0,jsx_runtime.jsx)(PaginationControl.R,{...activityPagination,nouns:["activity","activities"]})]})]})})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"Data Warehouse"})}},"../../products/data_warehouse/DataWarehouseScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{DataWarehouseScene:()=>_frontend_src_scenes_data_warehouse_DataWarehouseScene__WEBPACK_IMPORTED_MODULE_0__.DataWarehouseScene});var _frontend_src_scenes_data_warehouse_DataWarehouseScene__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../frontend/src/scenes/data-warehouse/DataWarehouseScene.tsx")}}]);