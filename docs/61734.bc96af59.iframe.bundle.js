(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[61734],{"../../products/messaging/frontend/Campaigns/CampaignScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{CampaignScene:()=>CampaignScene,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),LemonTabs=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTabs/index.ts"),LogsViewer=__webpack_require__("../../frontend/src/scenes/hog-functions/logs/LogsViewer.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),AppMetricSummary=__webpack_require__("../../frontend/src/lib/components/AppMetrics/AppMetricSummary.tsx"),AppMetricsFilters=__webpack_require__("../../frontend/src/lib/components/AppMetrics/AppMetricsFilters.tsx"),AppMetricsTrends=__webpack_require__("../../frontend/src/lib/components/AppMetrics/AppMetricsTrends.tsx"),appMetricsLogic=__webpack_require__("../../frontend/src/lib/components/AppMetrics/appMetricsLogic.ts"),kea_forms_lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/index.ts"),sceneTypes=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts");let campaignSceneLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","messaging","frontend","campaignSceneLogic"]),(0,index_esm.props)({id:"new"}),(0,index_esm.actions)({setCurrentTab:tab=>({tab})}),(0,index_esm.reducers)({currentTab:["overview",{setCurrentTab:(_,_ref)=>{let{tab}=_ref;return tab}}]}),(0,index_esm.selectors)({breadcrumbs:[()=>[(_,props)=>props.id],id=>[{key:sceneTypes.x.Messaging,name:"Messaging",path:urls.j.messaging("campaigns")},{key:[sceneTypes.x.Messaging,"campaigns"],name:"Campaigns",path:urls.j.messaging("campaigns")},{key:sceneTypes.x.MessagingCampaign,name:"new"==id?"New campaign":"Manage campaign"}]]}),(0,lib.actionToUrl)(_ref2=>{let{props,values}=_ref2;return{setCurrentTab:()=>[urls.j.messagingCampaign(props.id||"new",values.currentTab),lib.router.values.searchParams,lib.router.values.hashParams]}}),(0,lib.urlToAction)(_ref3=>{let{actions,values}=_ref3;return{"/messaging/campaigns/:id/:tab":_ref4=>{let{tab}=_ref4;tab!==values.currentTab&&actions.setCurrentTab(tab)}}})]),NEW_CAMPAIGN={id:"new",name:"",actions:[{id:"trigger_node",type:"trigger",name:"Trigger",description:"User performs an action to start the campaign",created_at:0,updated_at:0,config:{type:"event",filters:{}}},{id:"exit_node",type:"exit",name:"Exit",description:"User moved through the campaign without errors",config:{reason:"Default exit"},created_at:0,updated_at:0}],edges:[{from:"trigger_node",to:"exit_node",type:"continue"}],trigger:{type:"event",filters:{events:[],actions:[]}},trigger_masking:{ttl:0,hash:"",threshold:0},conversion:{window_minutes:0,filters:[]},exit_condition:"exit_only_at_end",version:1,status:"draft",team_id:-1},campaignLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","messaging","frontend","Campaigns","campaignLogic"]),(0,index_esm.props)({id:"new"}),(0,index_esm.key)(props=>props.id||"new"),(0,index_esm.actions)({setCampaignActionConfig:(actionId,config)=>({actionId,config}),setCampaignAction:(actionId,action)=>({actionId,action}),setCampaignActionEdges:(actionId,edges)=>({actionId,edges}),setCampaignInfo:campaign=>({campaign}),discardChanges:!0}),(0,kea_loaders_lib.loaders)(_ref=>{let{props}=_ref;return{originalCampaign:[null,{loadCampaign:async()=>props.id&&"new"!==props.id?api.ZP.hogFlows.getHogFlow(props.id):{...NEW_CAMPAIGN},saveCampaign:async updates=>props.id&&"new"!==props.id?api.ZP.hogFlows.updateHogFlow(props.id,updates):api.ZP.hogFlows.createHogFlow(updates)}]}}),(0,kea_forms_lib.forms)(_ref2=>{let{actions}=_ref2;return{campaign:{defaults:NEW_CAMPAIGN,errors:_ref3=>{let{name,trigger}=_ref3;return{name:0===name.length?"Name is required":void 0,trigger:{type:"event"===trigger.type?void 0:"Invalid trigger type",filters:0===trigger.filters.events.length&&0===trigger.filters.actions.length?"At least one event or action is required":void 0}}},submit:async values=>{values&&actions.saveCampaign(values)},options:{showErrorsOnTouch:!0}}}}),(0,index_esm.selectors)({logicProps:[()=>[(_,props)=>props],props=>props],campaignLoading:[s=>[s.originalCampaignLoading],originalCampaignLoading=>originalCampaignLoading],edgesByActionId:[s=>[s.campaign],campaign=>campaign.edges.reduce((acc,edge)=>(acc[edge.from]||(acc[edge.from]=[]),acc[edge.from].push(edge),acc[edge.to]||(acc[edge.to]=[]),acc[edge.to].push(edge),acc),{})]}),(0,index_esm.listeners)(_ref4=>{let{actions,values}=_ref4;return{loadCampaignSuccess:async _ref5=>{let{originalCampaign}=_ref5;actions.resetCampaign(originalCampaign)},saveCampaignSuccess:async _ref6=>{let{originalCampaign}=_ref6;LemonToast.U.success("Campaign saved"),originalCampaign.id&&lib.router.actions.replace(urls.j.messagingCampaign(originalCampaign.id,campaignSceneLogic.findMounted()?.values.currentTab)),actions.resetCampaign(originalCampaign)},discardChanges:()=>{values.originalCampaign&&src.dn.open({title:"Discard changes",description:"Are you sure?",primaryButton:{children:"Discard",onClick:()=>{var _values$originalCampa;return actions.resetCampaign(null!==(_values$originalCampa=values.originalCampaign)&&void 0!==_values$originalCampa?_values$originalCampa:NEW_CAMPAIGN)}},secondaryButton:{children:"Cancel"}})},setCampaignInfo:async _ref7=>{let{campaign}=_ref7;actions.setCampaignValues(campaign)},setCampaignActionConfig:async _ref8=>{let{actionId,config}=_ref8,action=values.campaign.actions.find(action=>action.id===actionId);action&&(action.config={...action.config,...config},actions.setCampaignValues({actions:[...values.campaign.actions]}))},setCampaignAction:async _ref9=>{let{actionId,action}=_ref9,newActions=values.campaign.actions.map(a=>a.id===actionId?action:a);actions.setCampaignValues({actions:newActions})},setCampaignActionEdges:async _ref10=>{var _values$edgesByAction;let{actionId,edges}=_ref10,actionEdges=null!==(_values$edgesByAction=values.edgesByActionId[actionId])&&void 0!==_values$edgesByAction?_values$edgesByAction:[],newEdges=values.campaign.edges.filter(e=>!actionEdges.includes(e));actions.setCampaignValues({edges:[...newEdges,...edges]})}}}),(0,index_esm.afterMount)(_ref11=>{let{actions,props}=_ref11;props.id&&"new"!==props.id&&actions.loadCampaign()})]);var react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.28.1_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonLabel=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonLabel/index.ts"),types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),ActionFilter=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function HogFlowFilters(_ref){let{filters,setFilters,typeKey,buttonCopy}=_ref;return(0,jsx_runtime.jsx)(ActionFilter.T,{filters:null!=filters?filters:{},setFilters:setFilters,typeKey:null!=typeKey?typeKey:"hogflow-filters",mathAvailability:ActionFilterRow.Qq.None,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:[types.t.Events,types.t.Actions],propertiesTaxonomicGroupTypes:[types.t.EventProperties,types.t.EventFeatureFlags,types.t.Elements,types.t.PersonProperties,types.t.HogQLExpression],propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:"events"},buttonProps:{type:"secondary"},buttonCopy:null!=buttonCopy?buttonCopy:"Add filter"})}var esm=__webpack_require__("../../node_modules/.pnpm/@xyflow+system@0.0.57/node_modules/@xyflow/system/dist/esm/index.js"),dist_esm=__webpack_require__("../../node_modules/.pnpm/@xyflow+react@12.6.0_@types+react@17.0.52_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@xyflow/react/dist/esm/index.js"),kea_subscriptions_lib=__webpack_require__("../../node_modules/.pnpm/kea-subscriptions@3.0.1_kea@3.1.7_react@18.2.0_/node_modules/kea-subscriptions/lib/index.js"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),optOutCategoriesLogic=__webpack_require__("../../products/messaging/frontend/OptOuts/optOutCategoriesLogic.ts"),elk_bundled=__webpack_require__("../../node_modules/.pnpm/elkjs@0.10.0/node_modules/elkjs/lib/elk.bundled.js"),elk_bundled_default=__webpack_require__.n(elk_bundled);let TOP_HANDLE_POSITION={x:55,y:0},BOTTOM_HANDLE_POSITION={x:55,y:34},getElkPortSide=position=>{switch(position){case esm.Ly.Top:return"NORTH";case esm.Ly.Bottom:return"SOUTH";case esm.Ly.Left:return"WEST";case esm.Ly.Right:return"EAST"}},elk=new(elk_bundled_default()),getFormattedNodes=async(nodes,edges)=>{let graph={id:"root",layoutOptions:{"elk.algorithm":"layered","elk.layered.spacing.nodeNodeBetweenLayers":"75","elk.spacing.nodeNode":"50","elk.spacing.edgeEdge":"159","elk.spacing.edgeNode":"159","elk.direction":"DOWN","elk.layered.nodePlacement.strategy":"SIMPLE","elk.alignment":"CENTER","elk.layered.nodePlacement.bk.fixedAlignment":"BALANCED","elk.padding":"[left=0, top=0, right=0, bottom=0]"},children:nodes.map(node=>{let handles=node.handles?.sort((a,b)=>(a.id||"").localeCompare(b.id||"")).map(h=>({id:h.id||`${node.id}_${h.type}`,properties:{side:getElkPortSide(h.position)}}))||[];return{...node,width:110,height:34,targetPosition:"top",sourcePosition:"bottom",properties:{"org.eclipse.elk.portConstraints":"FIXED_ORDER"},ports:[...handles]}}),edges:edges.map(edge=>({...edge,id:edge.id,sources:[edge.sourceHandle||edge.source],targets:[edge.targetHandle||edge.target]}))},layoutedGraph=await elk.layout(graph),triggerNode=layoutedGraph.children?.find(node=>"trigger_node"===node.id),offsetX=triggerNode?.x||0,offsetY=triggerNode?.y||0;return layoutedGraph.children?.forEach(node=>{node.x=(node.x||0)-offsetX,node.y=(node.y||0)-offsetY}),layoutedGraph.children?.map(node=>({...node,position:{x:node.x,y:node.y}}))};function getSmartStepPath(_ref){let segment1EndY,segment3EndY,pathCommands,{sourceX,sourceY,targetX,targetY,edges,currentEdgeId,borderRadius=5}=_ref,horizontalOffset=(()=>{if(!currentEdgeId||0===edges.length)return 0;let currentEdge=edges.find(edge=>edge.id===currentEdgeId);if(!currentEdge)return 0;let conflictingEdges=edges.filter(edge=>edge.source===currentEdge.source),horizontalOffset=0;if(conflictingEdges.length>0){let sortedEdges=conflictingEdges.sort((a,b)=>{let aEdgeData=a.data.edge,bEdgeData=b.data.edge;return"branch"===aEdgeData.type&&"branch"===bEdgeData.type?(aEdgeData.index||0)-(bEdgeData.index||0):"continue"===aEdgeData.type?1:-1}),edgeIndex=sortedEdges.findIndex(edge=>edge.id===currentEdgeId);horizontalOffset=(edgeIndex-(sortedEdges.length-1)/2)*160}return horizontalOffset})();targetY-sourceY>=0?(segment1EndY=sourceY+10,segment3EndY=targetY-10):(segment1EndY=sourceY-10,segment3EndY=targetY+10);let branchX=sourceX+horizontalOffset,svgPath=(10>Math.abs(sourceX-targetX)&&0===horizontalOffset?[`M ${sourceX} ${sourceY}`,`L ${targetX} ${targetY}`]:10>Math.abs(targetX-branchX)?[`M ${sourceX} ${sourceY}`,`L ${sourceX} ${segment1EndY-borderRadius}`,`Q ${sourceX} ${segment1EndY} ${sourceX+(branchX>sourceX?borderRadius:-borderRadius)} ${segment1EndY}`,`L ${branchX-(branchX>sourceX?borderRadius:-borderRadius)} ${segment1EndY}`,`Q ${branchX} ${segment1EndY} ${branchX} ${segment1EndY+borderRadius}`,`L ${targetX} ${targetY}`]:Math.abs(targetX-sourceX)>10&&0===horizontalOffset?[`M ${sourceX} ${sourceY}`,`L ${sourceX} ${segment3EndY-borderRadius}`,`Q ${sourceX} ${segment3EndY} ${sourceX+(targetX>sourceX?borderRadius:-borderRadius)} ${segment3EndY}`,`L ${targetX-(targetX>sourceX?borderRadius:-borderRadius)} ${segment3EndY}`,`Q ${targetX} ${segment3EndY} ${targetX} ${segment3EndY+borderRadius}`,`L ${targetX} ${targetY}`]:[`M ${sourceX} ${sourceY}`,`L ${sourceX} ${segment1EndY-borderRadius}`,`Q ${sourceX} ${segment1EndY} ${sourceX+(branchX>sourceX?borderRadius:-borderRadius)} ${segment1EndY}`,`L ${branchX-(branchX>sourceX?borderRadius:-borderRadius)} ${segment1EndY}`,`Q ${branchX} ${segment1EndY} ${branchX} ${segment1EndY+borderRadius}`,`L ${branchX} ${segment3EndY-borderRadius}`,`Q ${branchX} ${segment3EndY} ${branchX-(branchX>targetX?borderRadius:-borderRadius)} ${segment3EndY}`,`L ${targetX+(branchX>targetX?borderRadius:-borderRadius)} ${segment3EndY}`,`Q ${targetX} ${segment3EndY} ${targetX} ${segment3EndY+borderRadius}`,`L ${targetX} ${targetY}`]).join(" "),labelY=segment1EndY+(segment3EndY-segment1EndY)/2,offsetX=Math.abs(branchX-sourceX),offsetY=Math.abs(labelY-sourceY);return[svgPath,branchX,labelY,offsetX,offsetY]}function EdgeLabel(_ref2){let{transform,label}=_ref2;return(0,jsx_runtime.jsx)(src.oe,{style:{transform},size:"small",className:"nodrag nopan absolute text-[0.45rem] font-sans font-medium",type:"muted",children:label})}function findXAtY(path,targetY,totalLength){let step=totalLength/1e3;for(let distance=0;distance<=totalLength;distance+=step){let point=path.getPointAtLength(distance);if(1>=Math.abs(point.y-targetY))return point.x}return null}function getPointAtYValue(pathString,distance,targetY){let svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),path=document.createElementNS("http://www.w3.org/2000/svg","path");path.setAttribute("d",pathString),svg.appendChild(path),document.body.appendChild(svg);try{let yValue;let totalLength=path.getTotalLength();if(void 0!==targetY)yValue=targetY;else{let percentageDistance=.25*totalLength,effectiveDistance=Math.max(distance,percentageDistance),clampedDistance=Math.min(effectiveDistance,totalLength);yValue=path.getPointAtLength(clampedDistance).y}let xAtY=findXAtY(path,yValue,totalLength);return{x:null!==xAtY?xAtY:0,y:yValue}}finally{document.body.removeChild(svg)}}let REACT_FLOW_EDGE_TYPES={smart:function SmartEdge(_ref3){let{id,sourceX,sourceY,targetX,targetY,sourcePosition,targetPosition,markerEnd,markerStart,data,...props}=_ref3,[edgePath]=getSmartStepPath({sourceX,sourceY,targetX,targetY,edges:(0,dist_esm.Mi)(),currentEdgeId:id}),labelPoint=getPointAtYValue(edgePath,20,sourceY+20);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(dist_esm.u5,{...props,path:edgePath,markerEnd:markerEnd,markerStart:markerStart}),(0,jsx_runtime.jsx)(dist_esm.XQ,{children:data?.label&&(0,jsx_runtime.jsx)(EdgeLabel,{transform:`translate(-50%, -50%) translate(${labelPoint.x}px,${labelPoint.y}px)`,label:data?.label||""})})]})}},getEdgeId=edge=>{var _edge$index;return`${edge.from}->${edge.to} ${null!==(_edge$index=edge.index)&&void 0!==_edge$index?_edge$index:""}`.trim()},HOG_FLOW_EDITOR_MODES=["build","test","metrics","logs"],hogFlowEditorLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.path)(key=>["scenes","hogflows","hogFlowEditorLogic",key]),(0,index_esm.key)(props=>`${props.id}`),(0,index_esm.connect)(props=>({values:[campaignLogic(props),["campaign","edgesByActionId"],(0,optOutCategoriesLogic.O)(),["categories","categoriesLoading"]],actions:[campaignLogic(props),["setCampaignInfo","setCampaignActionConfig","setCampaignAction","setCampaignActionEdges"],(0,optOutCategoriesLogic.O)(),["loadCategories"]]})),(0,index_esm.actions)({onEdgesChange:edges=>({edges}),onNodesChange:nodes=>({nodes}),onNodesDelete:deleted=>({deleted}),setNodes:nodes=>({nodes}),setDropzoneNodes:dropzoneNodes=>({dropzoneNodes}),setNodesRaw:nodes=>({nodes}),setEdges:edges=>({edges}),setSelectedNodeId:selectedNodeId=>({selectedNodeId}),resetFlowFromHogFlow:hogFlow=>({hogFlow}),setReactFlowInstance:reactFlowInstance=>({reactFlowInstance}),onDragStart:!0,onDragOver:event=>({event}),onDrop:event=>({event}),setNewDraggingNode:newDraggingNode=>({newDraggingNode}),setHighlightedDropzoneNodeId:highlightedDropzoneNodeId=>({highlightedDropzoneNodeId}),setMode:mode=>({mode}),loadActionMetricsById:(params,timezone)=>({params,timezone})}),(0,index_esm.reducers)(()=>({mode:["build",{setMode:(_,_ref)=>{let{mode}=_ref;return mode}}],nodes:[[],{setNodesRaw:(_,_ref2)=>{let{nodes}=_ref2;return nodes}}],dropzoneNodes:[[],{setDropzoneNodes:(_,_ref3)=>{let{dropzoneNodes}=_ref3;return dropzoneNodes}}],highlightedDropzoneNodeId:[null,{setHighlightedDropzoneNodeId:(_,_ref4)=>{let{highlightedDropzoneNodeId}=_ref4;return highlightedDropzoneNodeId}}],edges:[[],{setEdges:(_,_ref5)=>{let{edges}=_ref5;return edges}}],selectedNodeId:[null,{setSelectedNodeId:(_,_ref6)=>{let{selectedNodeId}=_ref6;return selectedNodeId}}],newDraggingNode:[null,{setNewDraggingNode:(_,_ref7)=>{let{newDraggingNode}=_ref7;return newDraggingNode}}],reactFlowInstance:[null,{setReactFlowInstance:(_,_ref8)=>{let{reactFlowInstance}=_ref8;return reactFlowInstance}}]})),(0,index_esm.selectors)({nodesById:[s=>[s.nodes],nodes=>nodes.reduce((acc,node)=>(acc[node.id]=node,acc),{})],selectedNode:[s=>[s.nodes,s.selectedNodeId],(nodes,selectedNodeId)=>{var _nodes$find;return null!==(_nodes$find=nodes.find(node=>node.id===selectedNodeId))&&void 0!==_nodes$find?_nodes$find:null}],selectedNodeCanBeDeleted:[s=>[s.selectedNode,s.nodes,s.edges],(selectedNode,nodes,edges)=>{if(!selectedNode)return!1;let outgoingNodes=(0,esm.xA)(selectedNode,nodes,edges);return 1===outgoingNodes.length||1===new Set(outgoingNodes.map(node=>node.id)).size}]}),(0,kea_loaders_lib.loaders)(()=>({actionMetricsById:[null,{loadActionMetricsById:async(_ref9,breakpoint)=>{let{params,timezone}=_ref9;await breakpoint(10);let response=await (0,appMetricsLogic.p)(params,timezone);await breakpoint(10);let res={};return Object.values(response).forEach(value=>{let[instanceId,metricName]=value.breakdowns;instanceId&&metricName&&(res[instanceId]=res[instanceId]||{actionId:instanceId,succeeded:0,failed:0,filtered:0},metricName in res[instanceId]&&(res[instanceId][metricName]=value.total))}),res}}]})),(0,index_esm.listeners)(_ref10=>{let{values,actions}=_ref10;return{onEdgesChange:_ref11=>{let{edges}=_ref11;actions.setEdges((0,dist_esm.yn)(edges,values.edges))},onNodesChange:_ref12=>{let{nodes}=_ref12;actions.setNodes((0,dist_esm.Fb)(nodes,values.nodes))},resetFlowFromHogFlow:_ref13=>{let{hogFlow}=_ref13;try{let edges=hogFlow.edges.map(edge=>{let isOnlyEdgeForNode=1===hogFlow.edges.filter(e=>e.from===edge.from).length;return{source:edge.from,target:edge.to,id:getEdgeId(edge),type:"smart",deletable:!1,reconnectable:!1,selectable:!1,focusable:!1,markerEnd:{type:esm.QZ.ArrowClosed},data:{edge,label:isOnlyEdgeForNode?void 0:"continue"===edge.type?"No match":`If condition #${(edge.index||0)+1} matches`},labelShowBg:!1,targetHandle:`target_${edge.to}`,sourceHandle:"continue"===edge.type?`continue_${edge.from}`:`branch_${edge.from}_${edge.index}`}}),handlesByIdByNodeId={};edges.forEach(edge=>{var _edge$sourceHandle,_edge$targetHandle;handlesByIdByNodeId[edge.source]||(handlesByIdByNodeId[edge.source]={}),handlesByIdByNodeId[edge.target]||(handlesByIdByNodeId[edge.target]={}),handlesByIdByNodeId[edge.source][null!==(_edge$sourceHandle=edge.sourceHandle)&&void 0!==_edge$sourceHandle?_edge$sourceHandle:""]={id:edge.sourceHandle,type:"source",position:esm.Ly.Bottom,...BOTTOM_HANDLE_POSITION},handlesByIdByNodeId[edge.target][null!==(_edge$targetHandle=edge.targetHandle)&&void 0!==_edge$targetHandle?_edge$targetHandle:""]={id:edge.targetHandle,type:"target",position:esm.Ly.Top,...TOP_HANDLE_POSITION}});let nodes=hogFlow.actions.map(action=>{var _handlesByIdByNodeId$;if(!HogFlowSteps[action.type])throw console.error(`Step not found for action type: ${action.type}`),Error(`Step not found for action type: ${action.type}`);return{id:action.id,type:action.type,data:action,position:{x:0,y:0},handles:Object.values(null!==(_handlesByIdByNodeId$=handlesByIdByNodeId[action.id])&&void 0!==_handlesByIdByNodeId$?_handlesByIdByNodeId$:{}),deletable:!["trigger","exit"].includes(action.type),selectable:!["exit"].includes(action.type),draggable:!1,connectable:!1}});actions.setEdges(edges),actions.setNodes(nodes)}catch(error){console.error("Error resetting flow from hog flow",error),src.UJ.error("Error updating workflow")}},setNodes:async _ref14=>{let{nodes}=_ref14,formattedNodes=await getFormattedNodes(nodes,values.edges);actions.setNodesRaw(formattedNodes)},onNodesDelete:_ref15=>{let{deleted}=_ref15;deleted.some(node=>node.id===values.selectedNodeId)&&actions.setSelectedNodeId(null);let deletedNodeIds=deleted.map(node=>node.id),updatedEdges=values.campaign.edges.map(hogFlowEdge=>{if(deletedNodeIds.includes(hogFlowEdge.to)){let deletedNode=deleted.find(node=>node.id===hogFlowEdge.to);if(deletedNode){let outgoers=(0,esm.xA)(deletedNode,values.nodes,values.edges);if(outgoers.length>0)return{...hogFlowEdge,to:outgoers[0].id}}}return hogFlowEdge}).filter(hogFlowEdge=>!deletedNodeIds.includes(hogFlowEdge.from)&&!deletedNodeIds.includes(hogFlowEdge.to)),updatedActions=values.campaign.actions.filter(action=>!deletedNodeIds.includes(action.id));actions.setCampaignInfo({actions:updatedActions,edges:updatedEdges})},onDragStart:()=>{let{nodes,edges}=values,dropzoneNodes=[];edges.forEach(edge=>{let sourceNode=nodes.find(n=>n.id===edge.source),targetNode=nodes.find(n=>n.id===edge.target);if(sourceNode&&targetNode){let sourceHandle=sourceNode.handles?.find(h=>h.id===edge.sourceHandle),targetHandle=targetNode.handles?.find(h=>h.id===edge.targetHandle),[,labelX,labelY]=getSmartStepPath({sourceX:sourceNode.position.x+(sourceHandle?.x||0),sourceY:sourceNode.position.y+(sourceHandle?.y||0),targetX:targetNode.position.x+(targetHandle?.x||0),targetY:targetNode.position.y+(targetHandle?.y||0),edges,currentEdgeId:edge.id});dropzoneNodes.push({id:`dropzone_edge_${edge.id}`,type:"dropzone",position:{x:labelX-55,y:labelY-17},data:{edge},draggable:!1,selectable:!1})}}),actions.setDropzoneNodes(dropzoneNodes)},onDragOver:_ref16=>{let{event}=_ref16;event.preventDefault(),event.dataTransfer.dropEffect="move"},onDrop:_ref17=>{let{event}=_ref17;event.preventDefault();let dropzoneNode=values.dropzoneNodes.find(x=>x.id===values.highlightedDropzoneNodeId);if(values.newDraggingNode&&dropzoneNode){let edgeToInsertNodeInto=dropzoneNode?.data.edge,step=HogFlowSteps[values.newDraggingNode];if(!step)throw Error(`Step not found for action type: ${values.newDraggingNode}`);let{action:partialNewAction,branchEdges=0}=step.create(),newAction={id:`action_${step.type}_${(0,utils.Vj)()}`,type:step.type,created_at:Date.now(),updated_at:Date.now(),...partialNewAction},edgeToBeReplacedIndex=values.campaign.edges.findIndex(edge=>getEdgeId(edge)===edgeToInsertNodeInto.id);if(-1===edgeToBeReplacedIndex)throw Error("Edge to be replaced not found");let newEdges=[...values.campaign.edges],edgeToBeReplaced=values.campaign.edges[edgeToBeReplacedIndex];newEdges.splice(edgeToBeReplacedIndex,1),newEdges.push({...edgeToBeReplaced,to:newAction.id});for(let i=0;i<branchEdges;i++)newEdges.push({...edgeToBeReplaced,index:i,type:"branch",from:newAction.id});newEdges.push({...edgeToBeReplaced,from:newAction.id});let oldActions=values.campaign.actions,newActions=[...oldActions.slice(0,-1),newAction,oldActions[oldActions.length-1]];actions.setCampaignInfo({actions:newActions,edges:newEdges}),actions.setNewDraggingNode(null),actions.setSelectedNodeId(newAction.id)}actions.setDropzoneNodes([])}}}),(0,kea_subscriptions_lib.Vt)(_ref18=>{let{actions}=_ref18;return{campaign:hogFlow=>{hogFlow&&actions.resetFlowFromHogFlow(hogFlow)}}}),(0,lib.actionToUrl)(_ref19=>{let{values}=_ref19,syncProperty=(key,value)=>[lib.router.values.location.pathname,{...lib.router.values.searchParams,[key]:value},lib.router.values.hashParams];return{setSelectedNodeId:()=>{var _values$selectedNodeI;return syncProperty("node",null!==(_values$selectedNodeI=values.selectedNodeId)&&void 0!==_values$selectedNodeI?_values$selectedNodeI:null)},setMode:()=>syncProperty("mode",values.mode)}}),(0,lib.urlToAction)(_ref20=>{let{actions}=_ref20;return{[urls.j.messagingCampaign(":id",":tab")]:(_,search)=>{let{node,mode}=search;actions.setSelectedNodeId(null!=node?node:null),mode&&HOG_FLOW_EDITOR_MODES.includes(mode)&&actions.setMode(mode)}}})]);function StepViewMetrics(_ref){var _actionMetricsById$ac;let{action}=_ref,{actionMetricsById,actionMetricsByIdLoading}=(0,index_esm.useValues)(hogFlowEditorLogic),metrics=null!==(_actionMetricsById$ac=actionMetricsById?.[action.id])&&void 0!==_actionMetricsById$ac?_actionMetricsById$ac:{actionId:action.id,succeeded:0,failed:0,filtered:0};return actionMetricsByIdLoading?(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-1 h-2 px-1",children:[(0,jsx_runtime.jsx)(src.yW,{className:"w-full h-[6px]"}),(0,jsx_runtime.jsx)(src.yW,{className:"w-full h-[6px]"}),(0,jsx_runtime.jsx)(src.yW,{className:"w-full h-[6px]"})]}):(0,jsx_runtime.jsxs)("div",{className:"flex flex-row items-center font-mono",style:{fontSize:6},children:[(0,jsx_runtime.jsx)(src.u,{title:"Successful runs of this action",children:(0,jsx_runtime.jsxs)("div",{className:"flex-1 px-1 text-success",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCheck,{})," ",(0,utils.d$)(metrics.succeeded)]})}),(0,jsx_runtime.jsx)(src.u,{title:"Failed runs of this action",children:(0,jsx_runtime.jsxs)("div",{className:"flex-1 px-1 text-error",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{})," ",(0,utils.d$)(metrics.failed)]})}),(0,jsx_runtime.jsx)(src.u,{title:"Filtered runs of this action",children:(0,jsx_runtime.jsxs)("div",{className:"flex-1 px-1 text-muted",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconFilter,{})," ",(0,utils.d$)(metrics.filtered)]})})]})}function StepView(_ref){let{action}=_ref,{selectedNode,mode}=(0,index_esm.useValues)(hogFlowEditorLogic),isSelected=selectedNode?.id===action.id,{selectedColor,colorLight,color,icon}=(0,react.useMemo)(()=>{let Step=HogFlowSteps[action.type];return{selectedColor:Step?.color?isSelected?`${Step?.color}`:`${Step?.color}20`:isSelected?"var(--border-primary)":"var(--border)",colorLight:Step?.color?`${Step?.color}20`:"var(--border)",color:Step?.color||"var(--text-secondary)",icon:Step?.icon}},[action.type,isSelected]);return(0,jsx_runtime.jsxs)("div",{className:"relative flex flex-col cursor-pointer rounded user-select-none bg-surface-primary",style:{width:110,height:"metrics"===mode?44:34,borderWidth:1,borderColor:selectedColor,boxShadow:`0px 2px 0px 0px ${colorLight}`,zIndex:0},children:[(0,jsx_runtime.jsxs)("div",{className:"relative z-10 flex gap-1 p-1 items-start w-full",children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-center h-6 items-center aspect-square rounded",style:{backgroundColor:colorLight,color},children:icon}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-between items-center gap-1",children:(0,jsx_runtime.jsx)("div",{className:"text-[0.45rem] font-sans font-medium",children:action.name})}),(0,jsx_runtime.jsx)("div",{className:"max-w-full text-[0.3rem]/1.5 text-muted text-ellipsis",children:action.description})]})]}),"metrics"===mode&&(0,jsx_runtime.jsx)("div",{style:{borderTopColor:colorLight,borderTopWidth:1},children:(0,jsx_runtime.jsx)(StepViewMetrics,{action:action})})]})}let StepConditionalBranch={type:"conditional_branch",name:"Conditional branch",description:"Branch based on a condition such as the event trigger or a person property.",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconDecisionTree,{className:"text-[#e5991e]"}),color:"#e5991e",renderNode:props=>(0,jsx_runtime.jsx)(StepConditionalBranchNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepConditionalBranchConfiguration,{node:node}),create:()=>({action:{name:"Conditional",description:"",type:"conditional_branch",on_error:"continue",config:{conditions:[{filters:{events:[{id:"$pageview",name:"$pageview",type:"events"}]}}]}},branchEdges:1})};function StepConditionalBranchNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}function StepConditionalBranchConfiguration(_ref2){let{node}=_ref2,action=node.data,{conditions}=action.config,{edgesByActionId}=(0,index_esm.useValues)(hogFlowEditorLogic),{setCampaignAction,setCampaignActionEdges}=(0,index_esm.useActions)(hogFlowEditorLogic),nodeEdges=edgesByActionId[action.id],[branchEdges,nonBranchEdges]=(0,react.useMemo)(()=>{let branchEdges=[],nonBranchEdges=[];return nodeEdges.forEach(edge=>{"branch"===edge.type&&edge.from===action.id?branchEdges.push(edge):nonBranchEdges.push(edge)}),[branchEdges.sort((a,b)=>{var _a$index,_b$index;return(null!==(_a$index=a.index)&&void 0!==_a$index?_a$index:0)-(null!==(_b$index=b.index)&&void 0!==_b$index?_b$index:0)}),nonBranchEdges]},[nodeEdges,action.id]),setConditions=conditions=>{setCampaignAction(action.id,{...action,config:{...action.config,conditions}})},addCondition=()=>{let continueEdge=nodeEdges.find(edge=>"continue"===edge.type&&edge.from===action.id);if(!continueEdge)throw Error("Continue edge not found");setConditions([...conditions,{filters:{events:[{id:"$pageview",name:"$pageview",type:"events"}]}}]),setCampaignActionEdges(action.id,[...branchEdges,{from:action.id,to:continueEdge.to,type:"branch",index:conditions.length},...nonBranchEdges])},removeCondition=index=>{let newBranchEdges=branchEdges.filter((_,i)=>i!==index).map((edge,i)=>({...edge,index:i}));setConditions(conditions.filter((_,i)=>i!==index)),setCampaignActionEdges(action.id,[...newBranchEdges,...nonBranchEdges])};return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[conditions.map((condition,index)=>{var _condition$filters;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 p-2 rounded border",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsxs)(LemonLabel.H,{children:["Condition ",index+1]}),(0,jsx_runtime.jsx)(LemonButton.J,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>removeCondition(index)})]}),(0,jsx_runtime.jsx)(HogFlowFilters,{filters:null!==(_condition$filters=condition.filters)&&void 0!==_condition$filters?_condition$filters:{},setFilters:filters=>setConditions(conditions.map((condition,i)=>i===index?{filters}:condition)),typeKey:`campaign-trigger-${index}`})]},index)}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),onClick:()=>addCondition(),children:"Add condition"})]})}let DURATION_REGEX=/^(\d*\.?\d+)([dhm])$/;function HogFlowDuration(_ref){var _value$match;let{value,onChange}=_ref,[,numberValueString,unit]=null!==(_value$match=value.match(DURATION_REGEX))&&void 0!==_value$match?_value$match:["","10","m"],numberValue=parseFloat(numberValueString);return(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.DF,{type:"number",value:numberValue,onChange:v=>onChange(`${v}${unit}`)}),(0,jsx_runtime.jsx)(src.Yv,{options:[{label:"Minute(s)",value:"m"},{label:"Hour(s)",value:"h"},{label:"Day(s)",value:"d"}],value:unit,onChange:v=>onChange(`${numberValue}${v}`)})]})}let StepDelay={type:"delay",name:"Delay",description:"Wait for a specified duration.",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconClock,{className:"text-[#a20031]"}),color:"#a20031",renderNode:props=>(0,jsx_runtime.jsx)(StepDelayNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepDelayConfiguration,{node:node}),create:()=>({action:{name:"Delay",description:"",type:"delay",on_error:"continue",config:{delay_duration:"10m"}}})};function StepDelayNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}function StepDelayConfiguration(_ref2){let{node}=_ref2,action=node.data,{delay_duration}=action.config,{setCampaignActionConfig}=(0,index_esm.useActions)(hogFlowEditorLogic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{className:"mb-0",children:"Wait for a specified duration."}),(0,jsx_runtime.jsx)(HogFlowDuration,{value:delay_duration,onChange:value=>setCampaignActionConfig(action.id,{delay_duration:value})})]})}let StepExit={type:"exit",name:"Exit",description:"Exit the campaign.",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconLeave,{}),color:"#4b4b4b",renderNode:props=>(0,jsx_runtime.jsx)(StepExitNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepExitConfiguration,{node:node}),create:()=>({action:{name:"Exit",description:"",type:"exit",config:{reason:"user_exited"}}})};function StepExitNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}function StepExitConfiguration(_){return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("div",{className:"flex flex-col",children:(0,jsx_runtime.jsx)("p",{className:"mb-1 text-lg font-semibold",children:"Exit"})})})}var CyclotronJobInputs=__webpack_require__("../../frontend/src/lib/components/CyclotronJob/CyclotronJobInputs.tsx"),hogFunctionConfigurationLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx");let hogFunctionStepLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","messaging","frontend","Campaigns","hogflows","steps"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{node}=_ref;return`${node?.id}_${node?.data.config.template_id}`}),(0,kea_loaders_lib.loaders)(_ref2=>{let{props}=_ref2;return{template:[null,{loadTemplate:async()=>{let templateId=props.node?.data.config.template_id;if(!templateId)return null;let res=await api.ZP.hogFunctions.getTemplate(templateId);if(!res)throw Error("Template not found");return res}}]}}),(0,kea_forms_lib.forms)(_ref3=>{let{props}=_ref3;return{configuration:{defaults:{inputs:props.node?.data.config.inputs}}}}),(0,index_esm.listeners)(_ref4=>{let{actions,values}=_ref4;return{loadTemplateSuccess:_ref5=>{var _values$configuration,_templateToConfigurat;let{template}=_ref5;template&&0===Object.keys(null!==(_values$configuration=values.configuration.inputs)&&void 0!==_values$configuration?_values$configuration:{}).length&&actions.setConfigurationValues({inputs:null!==(_templateToConfigurat=(0,hogFunctionConfigurationLogic.oT)(template).inputs)&&void 0!==_templateToConfigurat?_templateToConfigurat:{}})}}}),(0,index_esm.afterMount)(_ref6=>{let{props,actions}=_ref6;props.node?.data.config.template_id&&actions.loadTemplate()})]);function StepFunctionConfiguration(_ref){var _template$inputs_sche;let{node}=_ref,{configuration,templateLoading,template}=(0,index_esm.useValues)(hogFunctionStepLogic({node})),{setCampaignActionConfig}=(0,index_esm.useActions)(hogFlowEditorLogic);return((0,react.useEffect)(()=>{setCampaignActionConfig(node.id,{inputs:configuration.inputs})},[configuration.inputs,setCampaignActionConfig,node.id]),templateLoading)?(0,jsx_runtime.jsx)("div",{className:"flex justify-center items-center",children:(0,jsx_runtime.jsx)(src.$j,{})}):template?(0,jsx_runtime.jsx)(kea_forms_lib.Form,{logic:hogFunctionStepLogic,props:{node},formKey:"configuration",className:"flex flex-col gap-2",children:(0,jsx_runtime.jsx)(CyclotronJobInputs.c,{configuration:{inputs:node.data.config.inputs,inputs_schema:null!==(_template$inputs_sche=template?.inputs_schema)&&void 0!==_template$inputs_sche?_template$inputs_sche:[]},showSource:!1,sampleGlobalsWithInputs:null})}):(0,jsx_runtime.jsx)("div",{children:"Template not found!"})}let StepFunctionEmail={type:"function_email",name:"Email",description:"Send an email to the user.",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconLetter,{className:"text-[#005841]"}),color:"#005841",renderNode:props=>(0,jsx_runtime.jsx)(StepFunctionEmailNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepFunctionEmailConfiguration,{node:node}),create:()=>({action:{name:"Email",description:"",type:"function_email",on_error:"continue",config:{template_id:"template-email",inputs:{}}}})};function StepFunctionEmailNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}function StepFunctionEmailConfiguration(props){return(0,jsx_runtime.jsx)(StepFunctionConfiguration,{...props})}var icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/icons.tsx");let StepFunctionSlack={type:"function_slack",name:"Slack",description:"Send a message to a Slack channel.",icon:(0,jsx_runtime.jsx)(icons.IconSlack,{}),color:"#000000",renderNode:props=>(0,jsx_runtime.jsx)(StepFunctionSlackNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepFunctionSlackConfiguration,{node:node}),create:()=>({action:{name:"Slack",description:"",type:"function_slack",on_error:"continue",config:{template_id:"template-slack",inputs:{}}}})};function StepFunctionSlackNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}function StepFunctionSlackConfiguration(props){return(0,jsx_runtime.jsx)(StepFunctionConfiguration,{...props})}var lemon_ui_icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts");let StepFunctionSms={type:"function_sms",name:"SMS",description:"Send an SMS to the user.",icon:(0,jsx_runtime.jsx)(lemon_ui_icons.i5,{className:"text-[#f22f46]"}),color:"#f22f46",renderNode:props=>(0,jsx_runtime.jsx)(StepFunctionSmsNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepFunctionSmsConfiguration,{node:node}),create:()=>({action:{name:"SMS",description:"",type:"function_sms",on_error:"continue",config:{template_id:"template-twilio",inputs:{}}}})};function StepFunctionSmsNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}function StepFunctionSmsConfiguration(props){return(0,jsx_runtime.jsx)(StepFunctionConfiguration,{...props})}let StepFunctionWebhook={type:"function_webhook",name:"Webhook",description:"Send a webhook to an external service.",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconWebhooks,{className:"text-[#6500ae]"}),color:"#6500ae",renderNode:props=>(0,jsx_runtime.jsx)(StepFunctionWebhookNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepFunctionWebhookConfiguration,{node:node}),create:()=>({action:{name:"Webhook",description:"",type:"function_webhook",on_error:"continue",config:{template_id:"template-webhook",inputs:{}}}})};function StepFunctionWebhookNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}function StepFunctionWebhookConfiguration(props){return(0,jsx_runtime.jsx)(StepFunctionConfiguration,{...props})}let StepRandomCohortBranch={type:"random_cohort_branch",name:"Random cohort branch",description:"Randomly branch off to a different path based on cohort percentages.",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPercentage,{className:"text-[#9a004d]"}),color:"#9a004d",renderNode:props=>(0,jsx_runtime.jsx)(StepRandomCohortBranchNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepRandomCohortBranchConfiguration,{node:node}),create:()=>({action:{name:"Random cohort",description:"",type:"random_cohort_branch",on_error:"continue",config:{cohorts:[{percentage:50}]}},branchEdges:1})};function StepRandomCohortBranchNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}function StepRandomCohortBranchConfiguration(_ref2){let{node}=_ref2,action=node.data,{cohorts}=action.config,{edgesByActionId}=(0,index_esm.useValues)(hogFlowEditorLogic),{setCampaignAction,setCampaignActionEdges}=(0,index_esm.useActions)(hogFlowEditorLogic),nodeEdges=edgesByActionId[action.id],[branchEdges,nonBranchEdges]=(0,react.useMemo)(()=>{let branchEdges=[],nonBranchEdges=[];return nodeEdges.forEach(edge=>{"branch"===edge.type&&edge.from===action.id?branchEdges.push(edge):nonBranchEdges.push(edge)}),[branchEdges.sort((a,b)=>{var _a$index,_b$index;return(null!==(_a$index=a.index)&&void 0!==_a$index?_a$index:0)-(null!==(_b$index=b.index)&&void 0!==_b$index?_b$index:0)}),nonBranchEdges]},[nodeEdges,action.id]),setCohorts=cohorts=>{setCampaignAction(action.id,{...action,config:{...action.config,cohorts}})},addCohort=()=>{let continueEdge=nodeEdges.find(edge=>"continue"===edge.type&&edge.from===action.id);if(!continueEdge)throw Error("Continue edge not found");setCohorts([...cohorts,{percentage:25}]),setCampaignActionEdges(action.id,[...branchEdges,{from:action.id,to:continueEdge.to,type:"branch",index:cohorts.length},...nonBranchEdges])},removeCohort=index=>{let newBranchEdges=branchEdges.filter((_,i)=>i!==index).map((edge,i)=>({...edge,index:i}));setCohorts(cohorts.filter((_,i)=>i!==index)),setCampaignActionEdges(action.id,[...newBranchEdges,...nonBranchEdges])},updateCohortPercentage=(index,percentage)=>{setCohorts(cohorts.map((cohort,i)=>i===index?{percentage}:cohort))},totalPercentage=cohorts.reduce((sum,cohort)=>sum+cohort.percentage,0);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[cohorts.map((cohort,index)=>(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 p-2 rounded border",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsxs)(LemonLabel.H,{children:["Cohort ",index+1]}),(0,jsx_runtime.jsx)(LemonButton.J,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>removeCohort(index)})]}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("input",{type:"number",min:"0",max:"100",value:cohort.percentage,onChange:e=>updateCohortPercentage(index,parseInt(e.target.value)||0),className:"w-20 px-2 py-1 border rounded"}),(0,jsx_runtime.jsx)("span",{children:"%"})]})]},index)),100!==totalPercentage&&(0,jsx_runtime.jsxs)("div",{className:"text-sm text-orange-600",children:["Total percentage: ",totalPercentage,"% (should equal 100%)"]}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),onClick:()=>addCohort(),children:"Add cohort"})]})}let StepTrigger={type:"trigger",name:"Trigger",description:"Trigger the campaign.",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconBolt,{className:"text-[#1E88E5]"}),color:"#1E88E5",renderNode:props=>(0,jsx_runtime.jsx)(StepTriggerNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepTriggerConfiguration,{node:node}),create:()=>({action:{name:"Trigger",description:"",type:"trigger",config:{type:"event"}}})};function StepTriggerNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}function StepTriggerConfiguration(_ref2){let{node}=_ref2,action=node.data,{filters}=action.config,{setCampaignActionConfig}=(0,index_esm.useActions)(hogFlowEditorLogic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex flex-col",children:(0,jsx_runtime.jsx)("p",{className:"mb-0",children:"Choose which events or actions will enter a user into the campaign."})}),(0,jsx_runtime.jsx)(HogFlowFilters,{filters:null!=filters?filters:{},setFilters:filters=>setCampaignActionConfig(action.id,{filters}),typeKey:"campaign-trigger",buttonCopy:"Add trigger event"})]})}let StepWaitUntilCondition={type:"wait_until_condition",name:"Wait for condition",description:"Wait until a condition is met or a duration has passed.",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconHourglass,{className:"text-[#ffaa00]"}),color:"#ffaa00",renderNode:props=>(0,jsx_runtime.jsx)(StepWaitUntilConditionNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepWaitUntilConditionConfiguration,{node:node}),create:()=>({action:{name:"Wait for condition",description:"",type:"wait_until_condition",on_error:"continue",config:{condition:{filters:null},max_wait_duration:"5m"}},branchEdges:1})};function StepWaitUntilConditionNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}function StepWaitUntilConditionConfiguration(_ref2){var _condition$filters;let{node}=_ref2,action=node.data,{condition,max_wait_duration}=action.config,{setCampaignActionConfig}=(0,index_esm.useActions)(hogFlowEditorLogic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Wait time"}),(0,jsx_runtime.jsx)(HogFlowDuration,{value:max_wait_duration,onChange:value=>{setCampaignActionConfig(action.id,{max_wait_duration:value})}})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Conditions to wait for"}),(0,jsx_runtime.jsx)(HogFlowFilters,{filters:null!==(_condition$filters=condition.filters)&&void 0!==_condition$filters?_condition$filters:{},setFilters:filters=>setCampaignActionConfig(action.id,{condition:{filters}}),typeKey:"campaign-wait-until-condition"})]})]})}var preflightLogic=__webpack_require__("../../frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx");let DEFAULT_TIME_RANGE=["09:00","17:00"],DEFAULT_WEEKDAYS=["monday","tuesday","wednesday","thursday","friday"],DATE_OPTIONS=[{value:"any",label:"Any day"},{value:"weekday",label:"Weekdays"},{value:"weekend",label:"Weekends"},{value:"custom",label:"Specific days"}],TIME_OPTIONS=[{value:"any",label:"Any time"},{value:"custom",label:"Specific time range"}],WEEKDAY_OPTIONS=[{key:"monday",label:"Monday"},{key:"tuesday",label:"Tuesday"},{key:"wednesday",label:"Wednesday"},{key:"thursday",label:"Thursday"},{key:"friday",label:"Friday"},{key:"saturday",label:"Saturday"},{key:"sunday",label:"Sunday"}],TIME_RANGE_OPTIONS=Array.from({length:24},(_,i)=>({value:`${i.toString().padStart(2,"0")}:00`,label:`${i.toString().padStart(2,"0")}:00`})),StepWaitUntilTimeWindow={type:"wait_until_time_window",name:"Time window",description:"Wait until a specific time window is reached.",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconDay,{className:"text-[#005841]"}),color:"#005841",renderNode:props=>(0,jsx_runtime.jsx)(StepWaitUntilTimeWindowNode,{...props}),renderConfiguration:node=>(0,jsx_runtime.jsx)(StepWaitUntilTimeWindowConfiguration,{node:node}),create:()=>({action:{name:"Time window",description:"",type:"wait_until_time_window",on_error:"continue",config:{timezone:null,day:"any",time:"any"}},branchEdges:1})};function StepWaitUntilTimeWindowNode(_ref){let{data}=_ref;return(0,jsx_runtime.jsx)(StepView,{action:data})}let isCustomDay=day=>Array.isArray(day),isCustomTime=time=>Array.isArray(time),getDaySelectValue=day=>"any"===day||"weekday"===day||"weekend"===day?day:"custom",convertStringToDayConfig=value=>{switch(value){case"any":case"weekday":case"weekend":return value;case"custom":return DEFAULT_WEEKDAYS;default:return"any"}},getUpdatedDayConfig=value=>({day:convertStringToDayConfig(value)}),getUpdatedTimeConfig=value=>"custom"===value?{time:DEFAULT_TIME_RANGE}:{time:value},getUpdatedTimeRangeConfig=(newTime,index,currentTime)=>{let updatedTime=[...currentTime];return updatedTime[index]=newTime,{time:updatedTime}};function StepWaitUntilTimeWindowConfiguration(_ref2){let{node}=_ref2,action=node.data,{timezone,day,time}=action.config,{setCampaignActionConfig}=(0,index_esm.useActions)(hogFlowEditorLogic),{preflight}=(0,index_esm.useValues)(preflightLogic.preflightLogic),{currentTeam}=(0,index_esm.useValues)(teamLogic.teamLogic),timezoneOptions=Object.entries(preflight?.available_timezones||{}).map(_ref3=>{let[tz,offset]=_ref3;return{key:tz,label:(0,utils.wF)(tz,offset)}}),isCustomDate=isCustomDay(day),isCustomTimeRange=isCustomTime(time);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap",children:[(0,jsx_runtime.jsx)(DayConfiguration,{day:day,isCustomDate:isCustomDate,onDayChange:value=>{let config=getUpdatedDayConfig(value);setCampaignActionConfig(action.id,config)},onCustomDaysChange:newDays=>setCampaignActionConfig(action.id,{day:[...newDays]})}),(0,jsx_runtime.jsx)(src.p2,{vertical:!0}),(0,jsx_runtime.jsx)(TimeConfiguration,{time:time,isCustomTime:isCustomTimeRange,onTimeChange:value=>{let config=getUpdatedTimeConfig(value);setCampaignActionConfig(action.id,config)},onTimeRangeChange:(newTime,index)=>{if(isCustomTimeRange){let config=getUpdatedTimeRangeConfig(newTime,index,time);setCampaignActionConfig(action.id,config)}}})]}),(0,jsx_runtime.jsx)(TimezoneConfiguration,{timezone:timezone,currentTeamTimezone:currentTeam?.timezone,timezoneOptions:timezoneOptions,onTimezoneChange:newTimezone=>{if(!preflight?.available_timezones)throw Error("No timezones are available");setCampaignActionConfig(action.id,{timezone:newTimezone[0]})}})]})}function DayConfiguration(_ref4){let{day,isCustomDate,onDayChange,onCustomDaysChange}=_ref4;return(0,jsx_runtime.jsxs)("div",{className:"flex-1 flex flex-col gap-2",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Days of week"}),(0,jsx_runtime.jsx)(src.Yv,{value:getDaySelectValue(day),onChange:onDayChange,options:DATE_OPTIONS,"data-attr":"date-select"}),isCustomDate&&Array.isArray(day)&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Custom days"}),(0,jsx_runtime.jsx)(src.nt,{value:day,onChange:newDays=>onCustomDaysChange(newDays),options:WEEKDAY_OPTIONS,mode:"multiple","data-attr":"custom-days-select"})]})]})}function TimeConfiguration(_ref5){let{time,isCustomTime,onTimeChange,onTimeRangeChange}=_ref5;return(0,jsx_runtime.jsxs)("div",{className:"flex-1 flex flex-col gap-2",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Time of day"}),(0,jsx_runtime.jsx)(src.Yv,{value:isCustomTime?"custom":time,onChange:onTimeChange,options:TIME_OPTIONS,"data-attr":"time-select"}),isCustomTime&&Array.isArray(time)&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Start time"}),(0,jsx_runtime.jsx)(src.Yv,{value:time[0],onChange:value=>onTimeRangeChange(value,0),options:TIME_RANGE_OPTIONS,"data-attr":"start-time-select"})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(src.HQ,{children:"End time"}),(0,jsx_runtime.jsx)(src.Yv,{value:time[1],onChange:value=>onTimeRangeChange(value,1),options:TIME_RANGE_OPTIONS,"data-attr":"end-time-select"})]})]})]})}function TimezoneConfiguration(_ref6){let{timezone,currentTeamTimezone,timezoneOptions,onTimezoneChange}=_ref6;return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Timezone"}),(0,jsx_runtime.jsx)(src.nt,{mode:"single",placeholder:"Select a time zone",value:[timezone||currentTeamTimezone||"UTC"],popoverClassName:"z-[1000]",onChange:onTimezoneChange,options:timezoneOptions,"data-attr":"timezone-select"})]})}let HogFlowSteps={trigger:StepTrigger,conditional_branch:StepConditionalBranch,exit:StepExit,delay:StepDelay,wait_until_condition:StepWaitUntilCondition,wait_until_time_window:StepWaitUntilTimeWindow,random_cohort_branch:StepRandomCohortBranch,function_email:StepFunctionEmail,function_webhook:StepFunctionWebhook,function_sms:StepFunctionSms,function_slack:StepFunctionSlack},METRICS_INFO={succeeded:"Total number of events processed successfully",failed:"Total number of events that had errors during processing",filtered:"Total number of events that were filtered out",disabled:"Total number of events that were skipped due to the destination being permanently disabled (due to prolonged issues with the destination)"};function CampaignMetrics(_ref){var _params$instanceId;let{id}=_ref,logicKey=`hog-flow-metrics-${id}`,logic=(0,appMetricsLogic.t)({logicKey,loadOnChanges:!0,forceParams:{appSource:"hog_flow",appSourceId:id,breakdownBy:"metric_name"}}),{campaign}=(0,index_esm.useValues)(campaignLogic({id})),{appMetricsTrendsLoading,getSingleTrendSeries,appMetricsTrends,params}=(0,index_esm.useValues)(logic),{setParams}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 flex-wrap justify-between",children:[(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(src.Yv,{size:"small",options:[{title:"Workflow",options:[{label:"Overview",value:null}]},{title:"Workflow steps",options:campaign.actions.map(action=>({label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-1",children:[HogFlowSteps[action.type]?.icon," ",HogFlowSteps[action.type]?.name]}),value:action.id}))}],value:null!==(_params$instanceId=params.instanceId)&&void 0!==_params$instanceId?_params$instanceId:null,onChange:value=>setParams({...params,instanceId:null!=value?value:void 0})})}),(0,jsx_runtime.jsx)(AppMetricsFilters.f,{logicKey:logicKey})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 flex-wrap justify-center",children:[(0,jsx_runtime.jsx)(AppMetricSummary.p,{name:"Success",description:METRICS_INFO.succeeded,loading:appMetricsTrendsLoading,timeSeries:getSingleTrendSeries("succeeded"),previousPeriodTimeSeries:getSingleTrendSeries("succeeded",!0)}),(0,jsx_runtime.jsx)(AppMetricSummary.p,{name:"Failure",description:METRICS_INFO.failed,loading:appMetricsTrendsLoading,timeSeries:getSingleTrendSeries("failed"),previousPeriodTimeSeries:getSingleTrendSeries("failed",!0)}),(0,jsx_runtime.jsx)(AppMetricSummary.p,{name:"Filtered",description:METRICS_INFO.filtered,loading:appMetricsTrendsLoading,timeSeries:getSingleTrendSeries("filtered"),previousPeriodTimeSeries:getSingleTrendSeries("filtered",!0)}),(0,jsx_runtime.jsx)(AppMetricSummary.p,{name:"Disabled",description:METRICS_INFO.disabled,loading:appMetricsTrendsLoading,timeSeries:getSingleTrendSeries("disabled_permanently"),previousPeriodTimeSeries:getSingleTrendSeries("disabled_permanently",!0)})]}),(0,jsx_runtime.jsx)(AppMetricsTrends.f,{appMetricsTrends:appMetricsTrends,loading:appMetricsTrendsLoading})]})}__webpack_require__("../../node_modules/.pnpm/@xyflow+react@12.6.0_@types+react@17.0.52_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@xyflow/react/dist/style.css");var dist_module=__webpack_require__("../../node_modules/.pnpm/posthog-js@1.261.1_@rrweb+types@2.0.0-alpha.17/node_modules/posthog-js/dist/module.js"),PropertyFilters=__webpack_require__("../../frontend/src/lib/components/PropertyFilters/PropertyFilters.tsx"),LemonDivider=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonDivider/index.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonInput=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonInput/index.ts"),LemonRadio=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonRadio/index.ts"),LemonSelect=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSelect/index.ts");function CampaignOverview(props){return(0,jsx_runtime.jsx)("div",{className:"flex flex-col gap-4",children:(0,jsx_runtime.jsx)(kea_forms_lib.Form,{id:"campaign-overview",logic:campaignLogic,props:props,formKey:"campaign",enableFormOnSubmit:!0,children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-wrap gap-4 items-start",children:[(0,jsx_runtime.jsx)(BasicInfoSection,{}),(0,jsx_runtime.jsx)(TriggerSection,{...props}),(0,jsx_runtime.jsx)(ConversionGoalSection,{}),(0,jsx_runtime.jsx)(ExitConditionSection,{})]})})})}function BasicInfoSection(){return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 py-2 w-120",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(LemonInput.D,{})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"description",label:"Description",children:(0,jsx_runtime.jsx)(src._V,{placeholder:"Help your teammates understand this campaign"})})]})}function TriggerSection(props){let logic=campaignLogic(props),{campaignValidationErrors}=(0,index_esm.useValues)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col py-2 w-full",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsxs)("span",{className:"flex items-center",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconBolt,{className:"text-lg"}),(0,jsx_runtime.jsx)("span",{className:"text-lg font-semibold",children:"Trigger event"})]}),(0,jsx_runtime.jsx)("p",{className:"mb-0",children:"Choose which events or actions will enter a user into the campaign."})]}),(0,jsx_runtime.jsx)(LemonDivider.p,{}),(0,jsx_runtime.jsx)(LemonField.D,{name:["trigger","filters"],className:"max-w-200",children:_ref=>{let{value,onChange}=_ref;return(0,jsx_runtime.jsx)(HogFlowFilters,{filters:null!=value?value:{},setFilters:onChange,typeKey:"campaign-trigger",buttonCopy:"Add trigger event"})}}),campaignValidationErrors.trigger?.filters&&(0,jsx_runtime.jsx)("span",{className:"text-danger text-sm mt-2",children:campaignValidationErrors.trigger.filters})]})}function ConversionGoalSection(){return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col py-2 w-full",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-1",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconTarget,{className:"text-lg"}),(0,jsx_runtime.jsx)("span",{className:"text-lg font-semibold",children:"Conversion goal (optional)"})]}),(0,jsx_runtime.jsx)("p",{className:"mb-0",children:"Define what a user must do to be considered converted."})]}),(0,jsx_runtime.jsx)(LemonDivider.p,{}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-1 max-w-240",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-2 gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:["conversion","filters"],label:"Detect conversion from property changes",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(PropertyFilters.t,{buttonText:"Add property conversion",propertyFilters:null!=value?value:[],taxonomicGroupTypes:[types.t.PersonProperties,types.t.Cohorts,types.t.HogQLExpression],onChange:onChange,pageKey:"campaign-conversion-properties",hideBehavioralCohorts:!0})}}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsxs)(src.HQ,{children:["Detect conversion from events",(0,jsx_runtime.jsx)(src.oe,{children:"Coming soon"})]}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),onClick:()=>{dist_module.ZP.capture("messaging campaign event conversion clicked"),src.UJ.info("Event targeting coming soon!")},children:"Add event conversion"})]})]}),(0,jsx_runtime.jsx)(LemonDivider.p,{vertical:!0}),(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(LemonField.D,{name:["conversion","window"],label:"Conversion window",info:"How long after entering the campaign should we check for conversion? After this window, users will be considered for conversion.",children:_ref3=>{let{value,onChange}=_ref3;return(0,jsx_runtime.jsx)(LemonSelect.Yv,{value:value,onChange:onChange,options:[{value:86400,label:"24 hours"},{value:604800,label:"7 days"},{value:1209600,label:"14 days"},{value:2592e3,label:"30 days"}]})}})})]})]})}function ExitConditionSection(){return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1 w-full py-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-1",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconLeave,{className:"text-lg"}),(0,jsx_runtime.jsx)("span",{className:"text-lg font-semibold",children:"Exit condition"})]}),(0,jsx_runtime.jsx)("p",{className:"mb-0",children:"Choose how your users move through the campaign."})]}),(0,jsx_runtime.jsx)(LemonDivider.p,{}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exit_condition",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsx)(LemonRadio._,{value:value,onChange:onChange,options:[{value:"exit_only_at_end",label:"Exit at end of workflow"},{value:"exit_on_trigger_not_matched",label:"Exit on trigger not matched"},{value:"exit_on_conversion",label:"Exit on conversion"},{value:"exit_on_trigger_not_matched_or_conversion",label:"Exit on trigger not matched or conversion"}]})}})]})}var PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx");let CampaignSceneHeader=function(){let props=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},logic=campaignLogic(props),{campaign,campaignChanged,isCampaignSubmitting,campaignLoading,isCampaignValid}=(0,index_esm.useValues)(logic),{saveCampaign,submitCampaign,discardChanges}=(0,index_esm.useActions)(logic),isSavedCampaign=props.id&&"new"!==props.id;return(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[isSavedCampaign&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>saveCampaign({status:campaign?.status==="draft"?"active":"draft"}),loading:campaignLoading,disabledReason:campaignChanged?"Save changes first":void 0,children:campaign?.status==="draft"?"Enable":"Disable"}),(0,jsx_runtime.jsx)(src.p2,{vertical:!0})]}),isSavedCampaign&&campaignChanged&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"discard-campaign-changes",type:"secondary",onClick:()=>discardChanges(),children:"Discard changes"})}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",htmlType:"submit",form:"campaign",onClick:submitCampaign,loading:isCampaignSubmitting,disabledReason:isCampaignValid?campaignChanged?void 0:"No changes to save":"Fill in all required fields",children:"new"===props.id?"Create":"Save"})]})})};var themeLogic=__webpack_require__("../../frontend/src/layout/navigation-3000/themeLogic.ts"),clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js");let ACTION_NODES_TO_SHOW=["function_email","function_sms","function_slack","function_webhook"],DELAY_NODES_TO_SHOW=["delay","wait_until_time_window","wait_until_condition"],LOGIC_NODES_TO_SHOW=["conditional_branch","random_cohort_branch"];function HogFlowEditorToolbarNode(_ref){let{type}=_ref,{setNewDraggingNode}=(0,index_esm.useActions)(hogFlowEditorLogic),step=HogFlowSteps[type];return step?(0,jsx_runtime.jsx)("div",{draggable:!0,onDragStart:event=>{setNewDraggingNode(type),event.dataTransfer.setData("application/reactflow",type),event.dataTransfer.effectAllowed="move"},children:(0,jsx_runtime.jsx)(src.Jp,{icon:step.icon,sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconDrag,{}),fullWidth:!0,children:step.name})}):null}function HogFlowEditorPanelBuild(){return(0,jsx_runtime.jsxs)("div",{className:"flex overflow-y-auto flex-col gap-px p-2 max-h-120",children:[(0,jsx_runtime.jsxs)("span",{className:"flex gap-2 text-sm font-semibold mt-2 items-center",children:["Actions ",(0,jsx_runtime.jsx)(src.p2,{className:"flex-1"})]}),ACTION_NODES_TO_SHOW.map(type=>(0,jsx_runtime.jsx)(HogFlowEditorToolbarNode,{type:type},type)),(0,jsx_runtime.jsxs)("span",{className:"flex gap-2 text-sm font-semibold mt-2 items-center",children:["Delays ",(0,jsx_runtime.jsx)(src.p2,{className:"flex-1"})]}),DELAY_NODES_TO_SHOW.map(type=>(0,jsx_runtime.jsx)(HogFlowEditorToolbarNode,{type:type},type)),(0,jsx_runtime.jsxs)("span",{className:"flex gap-2 text-sm font-semibold mt-2 items-center",children:["Audience split ",(0,jsx_runtime.jsx)(src.p2,{className:"flex-1"})]}),LOGIC_NODES_TO_SHOW.map(type=>(0,jsx_runtime.jsx)(HogFlowEditorToolbarNode,{type:type},type))]})}var ScrollableShadows=__webpack_require__("../../frontend/src/lib/components/ScrollableShadows/ScrollableShadows.tsx");let CategorySelect=_ref=>{let{onChange,value}=_ref,{categories,categoriesLoading}=(0,index_esm.useValues)((0,optOutCategoriesLogic.O)());return(0,jsx_runtime.jsx)(src.Yv,{onChange:onChange,value:value,loading:categoriesLoading,disabledReason:!categoriesLoading&&!categories.length&&"Configure message categories in the opt-outs section",options:[{title:"Marketing",options:categories.filter(category=>"marketing"===category.category_type).map(category=>({label:category.name,value:category.id}))},{title:"Transactional",options:categories.filter(category=>"transactional"===category.category_type).map(category=>({label:category.name,value:category.id}))}],placeholder:"Select message type"})};var zod_lib=__webpack_require__("../../node_modules/.pnpm/zod@3.24.1/node_modules/zod/lib/index.mjs");let _commonActionFields={id:zod_lib.z.string(),name:zod_lib.z.string(),description:zod_lib.z.string(),on_error:zod_lib.z.enum(["continue","abort","complete","branch"]).optional(),created_at:zod_lib.z.number(),updated_at:zod_lib.z.number(),filters:zod_lib.z.any()},CyclotronInputSchema=zod_lib.z.object({value:zod_lib.z.any(),templating:zod_lib.z.enum(["hog","liquid"]).optional(),secret:zod_lib.z.boolean().optional(),bytecode:zod_lib.z.any().optional(),order:zod_lib.z.number().optional()});zod_lib.z.discriminatedUnion("type",[zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("trigger"),config:zod_lib.z.object({type:zod_lib.z.literal("event"),filters:zod_lib.z.any()})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("conditional_branch"),config:zod_lib.z.object({conditions:zod_lib.z.array(zod_lib.z.object({filters:zod_lib.z.any()})),delay_duration:zod_lib.z.string().optional()})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("random_cohort_branch"),config:zod_lib.z.object({cohorts:zod_lib.z.array(zod_lib.z.object({percentage:zod_lib.z.number()}))})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("delay"),config:zod_lib.z.object({delay_duration:zod_lib.z.string()})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("wait_until_condition"),config:zod_lib.z.object({condition:zod_lib.z.object({filters:zod_lib.z.any()}),max_wait_duration:zod_lib.z.string()})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("wait_until_time_window"),config:zod_lib.z.object({timezone:zod_lib.z.string().nullable(),day:zod_lib.z.union([zod_lib.z.literal("any"),zod_lib.z.literal("weekday"),zod_lib.z.literal("weekend"),zod_lib.z.array(zod_lib.z.enum(["monday","tuesday","wednesday","thursday","friday","saturday","sunday"]))]),time:zod_lib.z.union([zod_lib.z.literal("any"),zod_lib.z.tuple([zod_lib.z.string(),zod_lib.z.string()])])})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("function_email"),config:zod_lib.z.object({message_category_id:zod_lib.z.string().uuid().optional(),template_uuid:zod_lib.z.string().optional(),template_id:zod_lib.z.literal("template-email"),inputs:zod_lib.z.record(CyclotronInputSchema)})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("function"),config:zod_lib.z.object({template_uuid:zod_lib.z.string().uuid().optional(),template_id:zod_lib.z.string(),inputs:zod_lib.z.record(CyclotronInputSchema)})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("function_sms"),config:zod_lib.z.object({message_category_id:zod_lib.z.string().uuid().optional(),template_uuid:zod_lib.z.string().uuid().optional(),template_id:zod_lib.z.literal("template-twilio"),inputs:zod_lib.z.record(CyclotronInputSchema)})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("function_slack"),config:zod_lib.z.object({template_uuid:zod_lib.z.string().uuid().optional(),template_id:zod_lib.z.literal("template-slack"),inputs:zod_lib.z.record(CyclotronInputSchema)})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("function_webhook"),config:zod_lib.z.object({template_uuid:zod_lib.z.string().uuid().optional(),template_id:zod_lib.z.literal("template-webhook"),inputs:zod_lib.z.record(CyclotronInputSchema)})}),zod_lib.z.object({..._commonActionFields,type:zod_lib.z.literal("exit"),config:zod_lib.z.object({reason:zod_lib.z.string().optional()})})]);let isOptOutEligibleAction=action=>["function_email","function_sms"].includes(action.type);function HogFlowEditorPanelBuildDetail(){var _action$filters;let{selectedNode,categories,categoriesLoading}=(0,index_esm.useValues)(hogFlowEditorLogic),{setCampaignAction}=(0,index_esm.useActions)(hogFlowEditorLogic);if(!selectedNode)return null;let action=selectedNode.data,Step=HogFlowSteps[action.type];return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col h-full overflow-hidden",children:[(0,jsx_runtime.jsx)(ScrollableShadows.D,{direction:"vertical",className:"flex-1 min-h-0",innerClassName:"flex flex-col gap-2 p-3",styledScrollbars:!0,children:Step?.renderConfiguration(selectedNode)}),isOptOutEligibleAction(action)&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.p2,{className:"my-0"}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col p-2",children:(0,jsx_runtime.jsxs)(src.HQ,{htmlFor:"Message category",className:"flex gap-2 justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Message category"}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[!categoriesLoading&&!categories.length&&(0,jsx_runtime.jsx)(src.Jp,{to:urls.j.messaging("opt-outs"),targetBlank:!0,type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconExternal,{}),children:"Configure"}),(0,jsx_runtime.jsx)(CategorySelect,{onChange:categoryId=>{setCampaignAction(action.id,{...action,config:{...action.config,message_category_id:categoryId}})},value:action.config.message_category_id})]})]})})]}),!["trigger","exit"].includes(action.type)&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.p2,{className:"my-0"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col p-2",children:[(0,jsx_runtime.jsxs)(src.HQ,{htmlFor:"conditions",className:"flex gap-2 justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Conditions"}),(0,jsx_runtime.jsx)(src.f4,{id:"conditions",checked:!!action.filters,onChange:checked=>setCampaignAction(action.id,{...action,filters:checked?{}:null})})]}),action.filters&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{className:"mb-0",children:"Add conditions to the step. If these conditions aren't met, the user will skip this step and continue to the next one."}),(0,jsx_runtime.jsx)(HogFlowFilters,{filters:null!==(_action$filters=action.filters)&&void 0!==_action$filters?_action$filters:{},setFilters:filters=>setCampaignAction(action.id,{...action,filters}),buttonCopy:"Add filter conditions"})]})]})]})]})}let ACTION_REGEX=/\[Action:([a-zA-Z0-9_-]+)\]/g,renderWorkflowLogMessage=(campaign,message)=>{let parts=message.split(ACTION_REGEX),elements=[];for(let i=0;i<parts.length;i++)if(i%2==0)parts[i]&&elements.push(parts[i]);else{let actionId=parts[i],action=campaign.actions.find(action=>action.id===actionId),step=action?HogFlowSteps[action?.type]:void 0,stepName=step?step.name:actionId;actionId&&elements.push((0,jsx_runtime.jsxs)(src.rU,{className:"rounded p-1 -m-1 bg-border text-bg-primary",to:urls.j.messagingCampaign(campaign.id,"workflow")+`?node=${actionId}&mode=logs`,children:[step?.icon&&(0,jsx_runtime.jsx)("span",{className:"mr-1",children:step.icon}),stepName]}))}return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:elements})};function HogFlowEditorPanelLogs(){let{campaign,selectedNode}=(0,index_esm.useValues)(hogFlowEditorLogic),actionId=selectedNode?.data.id;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"border-b",children:(0,jsx_runtime.jsx)(src.Jp,{to:urls.j.messagingCampaign(campaign.id,"logs"),size:"xsmall",sideIcon:(0,jsx_runtime.jsx)(lemon_ui_icons.UE,{}),children:"Click here to open in full log viewer"})}),(0,jsx_runtime.jsx)("div",{className:"p-2 flex flex-col gap-2 overflow-y-auto",children:(0,jsx_runtime.jsx)(LogsViewer.F,{logicKey:`hog-flow-editor-panel-${actionId||"all"}`,instanceLabel:"workflow run",sourceType:"hog_flow",sourceId:campaign.id,groupByInstanceId:!selectedNode,searchGroups:actionId?[`[Action:${actionId}]`]:void 0,renderMessage:m=>renderWorkflowLogMessage(campaign,m)})})]})}var LineGraph=__webpack_require__("../../frontend/src/queries/nodes/DataVisualization/Components/Charts/LineGraph.tsx"),src_types=__webpack_require__("../../frontend/src/types.ts");function HogFlowEditorPanelMetrics(){let{selectedNode,campaign}=(0,index_esm.useValues)(hogFlowEditorLogic),{loadActionMetricsById}=(0,index_esm.useActions)(hogFlowEditorLogic),id=selectedNode?.data.id,logicKey=`hog-flow-metrics-${id||"all"}`,logic=(0,appMetricsLogic.t)({logicKey,loadOnChanges:!0,forceParams:{appSource:"hog_flow",appSourceId:campaign.id,instanceId:id,breakdownBy:"metric_name"}}),{appMetricsTrendsLoading,appMetricsTrends,params,currentTeam,getDateRangeAbsolute}=(0,index_esm.useValues)(logic);return(0,react.useEffect)(()=>{var _currentTeam$timezone;loadActionMetricsById({appSource:params.appSource,appSourceId:params.appSourceId,instanceId:void 0,breakdownBy:["instance_id","metric_name"],metricName:["succeeded","failed","filtered"],dateFrom:getDateRangeAbsolute().dateFrom.toISOString(),dateTo:getDateRangeAbsolute().dateTo.toISOString()},null!==(_currentTeam$timezone=currentTeam?.timezone)&&void 0!==_currentTeam$timezone?_currentTeam$timezone:"UTC")},[params.appSource,params.appSourceId,params.dateFrom,params.dateTo,currentTeam?.timezone,loadActionMetricsById,getDateRangeAbsolute]),(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"border-b",children:(0,jsx_runtime.jsx)(src.Jp,{to:urls.j.messagingCampaign(campaign.id,"metrics"),size:"xsmall",sideIcon:(0,jsx_runtime.jsx)(lemon_ui_icons.UE,{}),children:"Click here to open in full metrics viewer"})}),(0,jsx_runtime.jsxs)("div",{className:"p-2 flex flex-col gap-2 overflow-y-auto",children:[(0,jsx_runtime.jsx)("div",{className:"flex flex-row gap-2 flex-wrap justify-end",children:(0,jsx_runtime.jsx)(AppMetricsFilters.f,{logicKey:logicKey})}),(0,jsx_runtime.jsx)("div",{className:"relative border rounded min-h-[20rem] bg-white flex flex-1 flex-col",children:appMetricsTrendsLoading?(0,jsx_runtime.jsx)("div",{className:"flex-1 flex items-center justify-center p-8",children:(0,jsx_runtime.jsx)(src.t2,{})}):appMetricsTrends?(0,jsx_runtime.jsx)(LineGraph.x,{className:"p-2",xData:{column:{name:"date",type:{name:"DATE",isNumerical:!1},label:"Date",dataIndex:0},data:appMetricsTrends.labels},yData:appMetricsTrends.series.map(x=>({column:{name:x.name,type:{name:"INTEGER",isNumerical:!0},label:x.name,dataIndex:0},data:x.values})),visualizationType:src_types.Qb.ActionsLineGraph,chartSettings:{showLegend:!0,showTotalRow:!0}}):(0,jsx_runtime.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,jsx_runtime.jsx)("div",{className:"text-muted",children:"No data"})})})]})]})}function HogFlowEditorPanelNodeRequired(_ref){let{children}=_ref,{selectedNode}=(0,index_esm.useValues)(hogFlowEditorLogic);return selectedNode?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:children}):(0,jsx_runtime.jsx)("div",{className:"p-2",children:(0,jsx_runtime.jsx)("div",{className:"p-8 text-center rounded border bg-surface-secondary",children:(0,jsx_runtime.jsx)("div",{className:"text-muted",children:"Please select an action..."})})})}var TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),person_utils=__webpack_require__("../../frontend/src/scenes/persons/person-utils.ts"),fast_deep_equal=__webpack_require__("../../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"),fast_deep_equal_default=__webpack_require__.n(fast_deep_equal),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),queries_query=__webpack_require__("../../frontend/src/queries/query.ts"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),queries_utils=__webpack_require__("../../frontend/src/queries/utils.ts");let hogFlowEditorTestLogic=(0,index_esm.kea)([(0,index_esm.path)(key=>["products","messaging","frontend","Campaigns","hogflows","actions","workflowTestLogic",key]),(0,index_esm.props)({}),(0,index_esm.key)(props=>`${props.id}`),(0,index_esm.connect)(props=>({values:[campaignLogic(props),["campaign"]]})),(0,index_esm.actions)({setTestResult:testResult=>({testResult}),setTestResultMode:mode=>({mode}),loadSampleGlobals:payload=>({eventId:payload?.eventId}),setSampleGlobalsError:error=>({error}),cancelSampleGlobalsLoading:!0,receiveExampleGlobals:globals=>({globals})}),(0,index_esm.reducers)({testResult:[null,{setTestResult:(_,_ref)=>{let{testResult}=_ref;return testResult}}],testResultMode:["raw",{setTestResultMode:(_,_ref2)=>{let{mode}=_ref2;return mode}}],sampleGlobalsError:[null,{loadSampleGlobals:()=>null,setSampleGlobalsError:(_,_ref3)=>{let{error}=_ref3;return error}}],fetchCancelled:[!1,{loadSampleGlobals:()=>!1,cancelSampleGlobalsLoading:()=>!0}]}),(0,kea_loaders_lib.loaders)(_ref4=>{let{actions,values}=_ref4;return{sampleGlobals:[null,{loadSampleGlobals:async()=>{var _values$campaign$name,_e$message;if(!values.campaign.trigger?.filters)return null;let errorMessage="No events match these filters in the last 30 days. Showing an example $pageview event instead.";try{let query={kind:schema_general.OH.EventsQuery,fixedProperties:[values.matchingFilters],select:["*","person"],after:"-7d",limit:1,orderBy:["timestamp DESC"],modifiers:{personsOnEventsMode:"person_id_no_override_properties_on_events"}},response=await (0,queries_query.jr)(query);if(!response?.results?.[0])throw Error(errorMessage);let event=response.results[0][0],person=response.results[0][1];return{event:{uuid:event.uuid,distinct_id:event.distinct_id,timestamp:event.timestamp,elements_chain:event.elements_chain||"",url:event.url||"",event:event.event,properties:event.properties},person:person?{id:person.id,properties:person.properties,name:person.name||"Unknown person",url:`${window.location.origin}/person/${person.id}`}:void 0,groups:{},project:{id:values.campaign.team_id,name:"Default project",url:`${window.location.origin}/project/${values.campaign.team_id}`},source:{name:null!==(_values$campaign$name=values.campaign.name)&&void 0!==_values$campaign$name?_values$campaign$name:"Unnamed",url:window.location.href.split("#")[0]}}}catch(e){return e.message?.includes("breakpoint")||actions.setSampleGlobalsError(null!==(_e$message=e.message)&&void 0!==_e$message?_e$message:errorMessage),null}}}]}}),(0,index_esm.selectors)(()=>({shouldLoadSampleGlobals:[s=>[s.campaign],campaign=>!!campaign.trigger?.filters?.events?.length||!!campaign.trigger?.filters?.actions?.length],matchingFilters:[s=>[s.campaign],campaign=>{var _campaign$trigger$fil,_campaign$trigger$fil2,_campaign$trigger$fil3,_event$properties,_action$properties,_campaign$trigger$fil4;let seriesProperties={type:src_types.J2.Or,values:[]},properties={type:src_types.J2.And,values:[seriesProperties]},allPossibleEventFilters=null!==(_campaign$trigger$fil=campaign.trigger.filters?.events)&&void 0!==_campaign$trigger$fil?_campaign$trigger$fil:[],allPossibleActionFilters=null!==(_campaign$trigger$fil2=campaign.trigger.filters?.actions)&&void 0!==_campaign$trigger$fil2?_campaign$trigger$fil2:[];for(let event of allPossibleEventFilters){let eventProperties=[...null!==(_event$properties=event.properties)&&void 0!==_event$properties?_event$properties:[]];event.id&&eventProperties.push({type:src_types.FT.HogQL,key:(0,queries_utils.zP)`event = ${event.id}`}),0===eventProperties.length&&eventProperties.push({type:src_types.FT.HogQL,key:"true"}),seriesProperties.values.push({type:src_types.J2.And,values:eventProperties})}for(let action of allPossibleActionFilters){let actionProperties=[...null!==(_action$properties=action.properties)&&void 0!==_action$properties?_action$properties:[]];action.id&&actionProperties.push({type:src_types.FT.HogQL,key:(0,queries_utils.zP)`matchesAction(${parseInt(action.id)})`}),seriesProperties.values.push({type:src_types.J2.And,values:actionProperties})}if((null!==(_campaign$trigger$fil3=campaign.trigger.filters?.properties?.length)&&void 0!==_campaign$trigger$fil3?_campaign$trigger$fil3:0)>0){let globalProperties={type:src_types.J2.And,values:[]};for(let property of null!==(_campaign$trigger$fil4=campaign.trigger.filters?.properties)&&void 0!==_campaign$trigger$fil4?_campaign$trigger$fil4:[])globalProperties.values.push(property);properties.values.push(globalProperties)}return properties},{resultEqualityCheck:fast_deep_equal_default()}]})),(0,kea_forms_lib.forms)(_ref5=>{let{actions,values}=_ref5;return{testInvocation:{defaults:{mock_async_functions:!0},errors:data=>{let errors={};try{JSON.parse(JSON.stringify(data.globals))}catch{errors.globals="Invalid JSON"}return errors},submit:async testInvocation=>{try{let apiResponse=await api.ZP.hogFlows.createTestInvocation(values.campaign.id,{configuration:{},globals:JSON.parse(testInvocation.globals),mock_async_functions:testInvocation.mock_async_functions});return actions.setTestResult(apiResponse),values.testInvocation}catch(error){throw console.error("Workflow test error:",error),src.UJ.error("Error testing workflow"),error}}}}}),(0,index_esm.listeners)(_ref6=>{let{values,actions}=_ref6;return{loadSampleGlobalsSuccess:()=>{actions.setTestInvocationValue("globals",JSON.stringify(values.sampleGlobals,null,2))},cancelSampleGlobalsLoading:()=>{}}}),(0,index_esm.afterMount)(_ref7=>{var _values$campaign$name2;let{actions,values}=_ref7;actions.loadSampleGlobalsSuccess({event:{uuid:(0,utils.Vj)(),distinct_id:(0,utils.Vj)(),timestamp:(0,dayjs.Bv)().toISOString(),elements_chain:"",url:`${window.location.origin}/project/1/events/`,event:"$pageview",properties:{$current_url:window.location.href.split("#")[0],$browser:"Chrome",this_is_an_example_event:!0}},person:{id:(0,utils.Vj)(),properties:{email:"example@posthog.com"},name:"Example person",url:`${window.location.origin}/person/${(0,utils.Vj)()}`},groups:{},project:{id:1,name:"Default project",url:`${window.location.origin}/project/1`},source:{name:null!==(_values$campaign$name2=values.campaign.name)&&void 0!==_values$campaign$name2?_values$campaign$name2:"Unnamed",url:window.location.href.split("#")[0]}})})]);function HogFlowEditorPanelTest(){var _testResult$logs;let{selectedNode}=(0,index_esm.useValues)(hogFlowEditorLogic),{logicProps}=(0,index_esm.useValues)(campaignLogic),{sampleGlobals,isTestInvocationSubmitting,testResult,shouldLoadSampleGlobals}=(0,index_esm.useValues)(hogFlowEditorTestLogic(logicProps)),{submitTestInvocation,setTestResult,loadSampleGlobals}=(0,index_esm.useActions)(hogFlowEditorTestLogic(logicProps)),display=(0,person_utils.y)(sampleGlobals?.person),url=urls.j.personByDistinctId(sampleGlobals?.event?.distinct_id||"");return selectedNode?(0,jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:hogFlowEditorTestLogic,props:logicProps,formKey:"testInvocation",enableFormOnSubmit:!0,className:"flex overflow-hidden flex-col flex-1",children:[(0,jsx_runtime.jsxs)("div",{className:"flex overflow-y-auto flex-col flex-1 gap-2 p-2",children:[sampleGlobals?.event&&(0,jsx_runtime.jsxs)("div",{className:"p-3 rounded border bg-surface-secondary",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-1 items-center",children:[sampleGlobals.person&&(0,jsx_runtime.jsxs)(src.rU,{to:url,className:"flex gap-2 items-center",children:[(0,jsx_runtime.jsx)(src.YY,{name:display})," ",(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:display})]}),(0,jsx_runtime.jsx)("span",{className:"text-muted",children:"performed"}),(0,jsx_runtime.jsx)("div",{className:"space-y-1 font-semibold text-md",children:sampleGlobals.event.event})," ",(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(TZLabel.w,{time:sampleGlobals.event.timestamp})})]}),sampleGlobals.event.properties&&Object.keys(sampleGlobals.event.properties).length>0&&(0,jsx_runtime.jsxs)("div",{className:"mt-3",children:[(0,jsx_runtime.jsx)("div",{className:"mb-2 text-sm",children:"Event properties"}),(0,jsx_runtime.jsx)("div",{className:"overflow-auto max-h-32 rounded border bg-surface-primary",children:(0,jsx_runtime.jsx)("pre",{className:"p-2 text-xs whitespace-pre-wrap text-muted",children:JSON.stringify(sampleGlobals.event.properties,null,2)})})]})]}),testResult&&(0,jsx_runtime.jsxs)("div",{"data-attr":"test-results",className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0",children:"Test results"}),(0,jsx_runtime.jsx)(src.Vp,{type:"success"===testResult.status?"success":"skipped"===testResult.status?"warning":"error",children:"success"===testResult.status?"Success":"skipped"===testResult.status?"Workflow was skipped because the event did not match the filter criteria":"Error"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Test invocation logs"}),(0,jsx_runtime.jsx)(src.g3,{dataSource:null!==(_testResult$logs=testResult.logs)&&void 0!==_testResult$logs?_testResult$logs:[],columns:[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:timestamp=>(0,jsx_runtime.jsx)(TZLabel.w,{time:timestamp}),width:0},{width:100,title:"Level",key:"level",dataIndex:"level"},{title:"Message",key:"message",dataIndex:"message",render:message=>(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}],className:"ph-no-capture",rowKey:"timestamp"})]})]})]}),(0,jsx_runtime.jsx)(src.p2,{className:"my-0"}),(0,jsx_runtime.jsx)("div",{className:"p-2",children:testResult?(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>setTestResult(null),loading:isTestInvocationSubmitting,"data-attr":"clear-workflow-test-panel-new-result",children:"Clear test result"}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:"Note: Delays will be logged to indicate when they would have been executed."}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"mock_async_functions",className:"flex-1",children:_ref=>{let{value,onChange}=_ref;return(0,jsx_runtime.jsx)(src.f4,{onChange:v=>onChange(!v),checked:!value,"data-attr":"toggle-workflow-test-panel-new-mocking",label:(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"When disabled, message deliveries and other async actions will not be called. Instead they will be mocked out and logged."}),children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2",children:["Make real HTTP requests",(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-lg"})]})})})}}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>loadSampleGlobals(),tooltip:"Find the last event matching the trigger event filters, and use it to populate the globals for a test run.",disabledReason:shouldLoadSampleGlobals?void 0:"Must configure trigger event",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconRedo,{}),children:"Load new event"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary","data-attr":"test-workflow-panel-new",onClick:()=>submitTestInvocation(),icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlay,{}),loading:isTestInvocationSubmitting,disabledReason:sampleGlobals?void 0:"Must load event to run test",children:"Run test"})]})]})})})]}):null}function HogFlowEditorPanel(){let{selectedNode,mode,selectedNodeCanBeDeleted}=(0,index_esm.useValues)(hogFlowEditorLogic),{setMode,setSelectedNodeId}=(0,index_esm.useActions)(hogFlowEditorLogic),{deleteElements}=(0,dist_esm._K)(),tabs=HOG_FLOW_EDITOR_MODES.map(mode=>({label:(0,utils.fm)(mode),key:mode})),width="build"!==mode?"36rem":selectedNode?"36rem":"22rem",Step=selectedNode?HogFlowSteps[selectedNode.data.type]:null;return(0,jsx_runtime.jsx)("div",{className:"absolute flex flex-col m-0 p-2 overflow-hidden transition-[width] max-h-full right-0 justify-end",style:{width},children:(0,jsx_runtime.jsxs)("div",{className:"relative flex flex-col rounded-md overflow-hidden bg-surface-primary max-h-full z-10",style:{border:"1px solid var(--border)",boxShadow:"0 3px 0 var(--border)"},children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 border-b items-center",children:[(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("transition-all overflow-hidden flex p-1",selectedNode?"w-10 opacity-100":"w-2 opacity-0"),children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconArrowLeft,{}),onClick:()=>setSelectedNodeId(null),disabled:!selectedNode})}),(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(src.TP,{activeKey:mode,onChange:key=>setMode(key),tabs:tabs,barClassName:"-mb-px "})}),selectedNode&&(0,jsx_runtime.jsxs)("span",{className:"flex gap-1 items-center font-medium rounded-md mr-3",children:[(0,jsx_runtime.jsx)("span",{className:"text-lg",children:Step?.icon}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:selectedNode.data.name})," step",selectedNode.deletable&&(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",status:"danger",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconTrash,{}),onClick:()=>{deleteElements({nodes:[selectedNode]}),setSelectedNodeId(null)},disabledReason:selectedNodeCanBeDeleted?void 0:"Clean up branching steps first"})]})]}),"build"===mode&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:selectedNode?(0,jsx_runtime.jsx)(HogFlowEditorPanelBuildDetail,{}):(0,jsx_runtime.jsx)(HogFlowEditorPanelBuild,{})}),"test"===mode&&(0,jsx_runtime.jsx)(HogFlowEditorPanelNodeRequired,{children:(0,jsx_runtime.jsx)(HogFlowEditorPanelTest,{})}),"metrics"===mode&&(0,jsx_runtime.jsx)(HogFlowEditorPanelMetrics,{}),"logs"===mode&&(0,jsx_runtime.jsx)(HogFlowEditorPanelLogs,{})]})})}let REACT_FLOW_NODE_TYPES={dropzone:DropzoneNode,trigger:HogFlowActionNode,function:HogFlowActionNode,function_email:HogFlowActionNode,function_sms:HogFlowActionNode,function_webhook:HogFlowActionNode,function_slack:HogFlowActionNode,conditional_branch:HogFlowActionNode,delay:HogFlowActionNode,wait_until_condition:HogFlowActionNode,exit:HogFlowActionNode,random_cohort_branch:HogFlowActionNode,wait_until_time_window:HogFlowActionNode};function DropzoneNode(_ref){let{id}=_ref,[isHighlighted,setIsHighlighted]=(0,react.useState)(!1),{setHighlightedDropzoneNodeId}=(0,index_esm.useActions)(hogFlowEditorLogic);return(0,react.useEffect)(()=>{setHighlightedDropzoneNodeId(isHighlighted?id:null)},[id,isHighlighted,setHighlightedDropzoneNodeId]),(0,jsx_runtime.jsx)("div",{onDragOver:()=>setIsHighlighted(!0),onDragLeave:()=>setIsHighlighted(!1),className:(0,clsx_m.default)("flex justify-center items-center p-2 rounded border border-dashed transition-all cursor-pointer",isHighlighted?"border-primary bg-surface-primary":"border-transparent"),style:{width:110,height:34},children:(0,jsx_runtime.jsx)("div",{className:"flex flex-col justify-center items-center w-4 h-4 rounded-full border bg-surface-primary",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{className:"text-sm text-primary"})})})}function HogFlowActionNode(props){let updateNodeInternals=(0,dist_esm.Bn)(),{nodesById}=(0,index_esm.useValues)(hogFlowEditorLogic);(0,react.useEffect)(()=>{updateNodeInternals(props.id)},[props.id,updateNodeInternals]);let Step=HogFlowSteps[props.data.type],node=nodesById[props.id];return(0,jsx_runtime.jsxs)("div",{className:"transition-all hover:translate-y-[-2px]",children:[node?.handles?.map(handle=>jsx_runtime.jsx(dist_esm.HH,{className:"opacity-0",...handle,isConnectable:!1},handle.id)),Step?.renderNode(props)||(0,jsx_runtime.jsx)(StepView,{action:props.data})]})}function HogFlowEditorContent(){let{isDarkModeOn}=(0,index_esm.useValues)(themeLogic.b),{nodes,edges,dropzoneNodes}=(0,index_esm.useValues)(hogFlowEditorLogic),{onEdgesChange,onNodesChange,setSelectedNodeId,setReactFlowInstance,onNodesDelete,onDragStart,onDragOver,onDrop}=(0,index_esm.useActions)(hogFlowEditorLogic),reactFlowWrapper=(0,react.useRef)(null),reactFlowInstance=(0,dist_esm._K)();return(0,react.useEffect)(()=>{setReactFlowInstance(reactFlowInstance)},[reactFlowInstance,setReactFlowInstance]),(0,jsx_runtime.jsx)("div",{ref:reactFlowWrapper,className:"w-full h-full",children:(0,jsx_runtime.jsxs)(dist_esm.x$,{fitView:!0,nodes:[...nodes,...dropzoneNodes],edges:edges,onNodesChange:onNodesChange,onEdgesChange:onEdgesChange,onNodesDelete:onNodesDelete,onDragStart:onDragStart,onDragOver:onDragOver,onDrop:onDrop,onNodeClick:(_,node)=>node.selectable&&setSelectedNodeId(node.id),nodeTypes:REACT_FLOW_NODE_TYPES,edgeTypes:REACT_FLOW_EDGE_TYPES,nodesDraggable:!1,colorMode:isDarkModeOn?"dark":"light",onPaneClick:()=>setSelectedNodeId(null),children:[(0,jsx_runtime.jsx)(dist_esm.Aq,{gap:36,variant:dist_esm.T7.Dots}),(0,jsx_runtime.jsx)(dist_esm.ZX,{showInteractive:!1}),(0,jsx_runtime.jsx)(HogFlowEditorPanel,{})]})})}function HogFlowEditor(){let{logicProps}=(0,index_esm.useValues)(campaignLogic);return(0,jsx_runtime.jsx)(dist_esm.tV,{children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:hogFlowEditorLogic,props:logicProps,children:(0,jsx_runtime.jsx)(HogFlowEditorContent,{})})})}function CampaignWorkflow(props){let{originalCampaign,campaignLoading}=(0,index_esm.useValues)(campaignLogic(props));return(0,jsx_runtime.jsx)("div",{className:"relative border rounded-md h-[calc(100vh-210px)]",children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:campaignLogic,props:props,children:!originalCampaign&&campaignLoading?(0,jsx_runtime.jsx)(src.t2,{}):(0,jsx_runtime.jsx)(HogFlowEditor,{})})})}let scene={component:CampaignScene,logic:campaignSceneLogic,paramsToProps:_ref=>{let{params:{id,tab}}=_ref;return{id:id||"new",tab:tab||"overview"}}};function CampaignScene(props){let{currentTab}=(0,index_esm.useValues)(campaignSceneLogic),logic=campaignLogic(props),{campaignLoading,campaign}=(0,index_esm.useValues)(logic);if(campaignLoading)return(0,jsx_runtime.jsx)(src.t2,{sceneLevel:!0});let tabs=[{label:"Overview",key:"overview",content:(0,jsx_runtime.jsx)(CampaignOverview,{...props})},{label:"Workflow",key:"workflow",content:(0,jsx_runtime.jsx)(CampaignWorkflow,{...props})},props.id&&"new"!==props.id?{label:"Logs",key:"logs",content:(0,jsx_runtime.jsx)(LogsViewer.F,{sourceType:"hog_flow",sourceId:props.id,instanceLabel:"workflow run",renderMessage:m=>renderWorkflowLogMessage(campaign,m)})}:null,props.id&&"new"!==props.id?{label:"Metrics",key:"metrics",content:(0,jsx_runtime.jsx)(CampaignMetrics,{id:props.id})}:null];return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col space-y-4",children:[(0,jsx_runtime.jsx)(CampaignSceneHeader,{...props}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:currentTab,onChange:tab=>{var _props$id;return lib.router.actions.push(urls.j.messagingCampaign(null!==(_props$id=props.id)&&void 0!==_props$id?_props$id:"new",tab))},tabs:tabs})]})}},"../../products/messaging/frontend/OptOuts/optOutCategoriesLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{O:()=>optOutCategoriesLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/api.ts");let optOutCategoriesLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["products","messaging","frontend","OptOuts","optOutCategoriesLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({loadCategories:!0,deleteCategory:id=>({id}),openNewCategoryModal:!0,closeNewCategoryModal:!0}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)({categories:{__default:[],loadCategories:async()=>(await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.messaging.getCategories({category_type:"marketing"})).results||[]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({categories:[[],{loadCategoriesSuccess:(_,_ref)=>{let{categories}=_ref;return categories}}],isNewCategoryModalOpen:[!1,{openNewCategoryModal:()=>!0,closeNewCategoryModal:()=>!1}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref2=>{let{actions}=_ref2;return{deleteCategory:async _ref3=>{let{id}=_ref3;try{await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.messaging.updateCategory(id,{deleted:!0}),actions.loadCategories()}catch(error){console.error("Failed to delete category:",error)}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref4=>{let{actions}=_ref4;actions.loadCategories()})])},"../../node_modules/.pnpm/elkjs@0.10.0/node_modules/elkjs/lib sync recursive":module=>{function webpackEmptyContext(req){var e=Error("Cannot find module '"+req+"'");throw e.code="MODULE_NOT_FOUND",e}webpackEmptyContext.keys=()=>[],webpackEmptyContext.resolve=webpackEmptyContext,webpackEmptyContext.id="../../node_modules/.pnpm/elkjs@0.10.0/node_modules/elkjs/lib sync recursive",module.exports=webpackEmptyContext}}]);