"use strict";(self.webpackChunk_posthog_frontend=self.webpackChunk_posthog_frontend||[]).push([[90891],{"./frontend/src/lib/components/AnimatedCollapsible.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{r:()=>AnimatedCollapsible});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function AnimatedCollapsible(_ref){let{collapsed,children}=_ref,collapsibleSectionRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),[height,setHeight]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(collapsed?0:void 0);return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)(()=>{collapsed?setHeight(0):collapsibleSectionRef.current&&setHeight(collapsibleSectionRef.current?.getBoundingClientRect().height)},[collapsed,children]),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__.jsx)("div",{className:"collapsible overflow-hidden transition-all duration-100 ease-in-out",style:{height},children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__.jsx)("div",{ref:collapsibleSectionRef,children:children})})}},"./frontend/src/scenes/instance/AsyncMigrations/AsyncMigrations.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{AsyncMigrations:()=>AsyncMigrations,scene:()=>scene});var src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),More=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/More.tsx"),LemonProgress=__webpack_require__("./frontend/src/lib/lemon-ui/LemonProgress/index.tsx"),LemonTable=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTable/index.ts"),LemonTableLink=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTable/LemonTableLink.tsx"),LemonTabs=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTabs/index.ts"),LemonTag=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTag/LemonTag.tsx"),Spinner=__webpack_require__("./frontend/src/lib/lemon-ui/Spinner/Spinner.tsx"),Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip/index.ts"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),AnimatedCollapsible=__webpack_require__("./frontend/src/lib/components/AnimatedCollapsible.tsx"),LemonInput=__webpack_require__("./frontend/src/lib/lemon-ui/LemonInput/LemonInput.tsx"),LemonModal=__webpack_require__("./frontend/src/lib/lemon-ui/LemonModal/index.ts"),kea_loaders_lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),LemonToast=__webpack_require__("./frontend/src/lib/lemon-ui/LemonToast/LemonToast.tsx"),systemStatusLogic=__webpack_require__("./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts"),preflightLogic=__webpack_require__("./frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts");let AsyncMigrationStatus=function(AsyncMigrationStatus){return AsyncMigrationStatus[AsyncMigrationStatus.NotStarted=0]="NotStarted",AsyncMigrationStatus[AsyncMigrationStatus.Running=1]="Running",AsyncMigrationStatus[AsyncMigrationStatus.CompletedSuccessfully=2]="CompletedSuccessfully",AsyncMigrationStatus[AsyncMigrationStatus.Errored=3]="Errored",AsyncMigrationStatus[AsyncMigrationStatus.RolledBack=4]="RolledBack",AsyncMigrationStatus[AsyncMigrationStatus.Starting=5]="Starting",AsyncMigrationStatus[AsyncMigrationStatus.FailedAtStartup=6]="FailedAtStartup",AsyncMigrationStatus}({}),AsyncMigrationsTab=function(AsyncMigrationsTab){return AsyncMigrationsTab.Management="management",AsyncMigrationsTab.FutureMigrations="future",AsyncMigrationsTab.Settings="settings",AsyncMigrationsTab}({}),migrationStatusNumberToMessage={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},asyncMigrationsLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","instance","AsyncMigrations","asyncMigrationsLogic"]),(0,index_esm.connect)({values:[preflightLogic.preflightLogic,["preflight"]]}),(0,index_esm.actions)({triggerMigration:migration=>({migration}),resumeMigration:migration=>({migration}),rollbackMigration:migration=>({migration}),forceStopMigration:migration=>({migration}),forceStopMigrationWithoutRollback:migration=>({migration}),updateMigrationStatus:(migration,endpoint,message)=>({migration,endpoint,message}),setActiveTab:tab=>({tab}),updateSetting:(settingKey,newValue)=>({settingKey,newValue}),loadAsyncMigrationErrors:migrationId=>({migrationId}),loadAsyncMigrationErrorsSuccess:(migrationId,errors)=>({migrationId,errors}),loadAsyncMigrationErrorsFailure:(migrationId,error)=>({migrationId,error}),openAsyncMigrationsModal:(migration,endpoint,message)=>({migration,endpoint,message}),closeAsyncMigrationsModal:!0}),(0,index_esm.reducers)({activeTab:[AsyncMigrationsTab.Management,{setActiveTab:(_,_ref)=>{let{tab}=_ref;return tab}}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:(state,_ref2)=>{let{migrationId,errors}=_ref2;return{...state,[migrationId]:errors}}}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:(state,_ref3)=>{let{migrationId}=_ref3;return{...state,[migrationId]:!0}},loadAsyncMigrationErrorsSuccess:(state,_ref4)=>{let{migrationId}=_ref4;return{...state,[migrationId]:!1}},loadAsyncMigrationErrorsFailure:(state,_ref5)=>{let{migrationId}=_ref5;return{...state,[migrationId]:!1}}}],activeAsyncMigrationModal:[null,{openAsyncMigrationsModal:(_,payload)=>payload,closeAsyncMigrationsModal:()=>null,updateMigrationStatus:()=>null}]}),(0,kea_loaders_lib.loaders)(()=>({asyncMigrations:[[],{loadAsyncMigrations:async()=>userLogic.userLogic.values.user?.is_staff?(await api.ZP.get("api/async_migrations")).results:[]}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:async()=>userLogic.userLogic.values.user?.is_staff?(await api.ZP.get("api/instance_settings")).results.filter(setting=>setting.key.includes("ASYNC_MIGRATIONS")):[]}]})),(0,index_esm.selectors)({isAnyMigrationRunning:[s=>[s.asyncMigrations],asyncMigrations=>asyncMigrations.some(migration=>[AsyncMigrationStatus.Running,AsyncMigrationStatus.Starting].includes(migration.status))],actionableMigrations:[s=>[s.asyncMigrations],asyncMigrations=>asyncMigrations.filter(migration=>migration.is_available)],futureMigrations:[s=>[s.asyncMigrations],asyncMigrations=>asyncMigrations.filter(migration=>!migration.is_available)]}),(0,index_esm.listeners)(_ref6=>{let{actions}=_ref6;return{triggerMigration:async _ref7=>{let{migration}=_ref7;Object.keys(migration.parameter_definitions).length>0?actions.openAsyncMigrationsModal(migration,"trigger","Migration triggered successfully"):actions.updateMigrationStatus(migration,"trigger","Migration triggered successfully")},resumeMigration:async _ref8=>{let{migration}=_ref8;Object.keys(migration.parameter_definitions).length>0?actions.openAsyncMigrationsModal(migration,"resume","Migration resume triggered successfully"):actions.updateMigrationStatus(migration,"resume","Migration resume triggered successfully")},rollbackMigration:async _ref9=>{let{migration}=_ref9;actions.updateMigrationStatus(migration,"rollback","Migration rollback triggered successfully")},forceStopMigration:async _ref10=>{let{migration}=_ref10;actions.updateMigrationStatus(migration,"force_stop","Force stop triggered successfully")},forceStopMigrationWithoutRollback:async _ref11=>{let{migration}=_ref11;actions.updateMigrationStatus(migration,"force_stop_without_rollback","Force stop without rollback triggered successfully")},updateMigrationStatus:async _ref12=>{let{migration,endpoint,message}=_ref12,res=await api.ZP.create(`/api/async_migrations/${migration.id}/${endpoint}`,{parameters:migration.parameters});res.success?(LemonToast.UJ.success(message),actions.loadAsyncMigrations()):LemonToast.UJ.error(res.error)},updateSetting:async _ref13=>{let{settingKey,newValue}=_ref13;try{await api.ZP.update(`/api/instance_settings/${settingKey}`,{value:newValue}),LemonToast.UJ.success(`Instance setting ${settingKey} updated`),actions.loadAsyncMigrationSettings(),actions.loadAsyncMigrations(),systemStatusLogic.Q.actions.loadSystemStatus()}catch{LemonToast.UJ.error("Failed to trigger migration")}},loadAsyncMigrationErrors:async _ref14=>{let{migrationId}=_ref14;try{let errorsForMigration=await api.ZP.get(`api/async_migrations/${migrationId}/errors`);actions.loadAsyncMigrationErrorsSuccess(migrationId,errorsForMigration)}catch(error){actions.loadAsyncMigrationErrorsFailure(migrationId,error)}}}}),(0,index_esm.events)(_ref15=>{let{actions}=_ref15;return{afterMount:()=>{actions.loadAsyncMigrations(),actions.loadAsyncMigrationSettings()}}}),(0,kea_router_lib.actionToUrl)(_ref16=>{let{values}=_ref16;return{setActiveTab:()=>`/instance/async_migrations${values.activeTab===AsyncMigrationsTab.Management?"":"/"+values.activeTab}`}}),(0,kea_router_lib.urlToAction)(_ref17=>{let{actions,values}=_ref17;return{"/instance/async_migrations(/:tab)":_ref18=>{let{tab}=_ref18;tab&&tab!==values.activeTab&&tab!==AsyncMigrationsTab.Management&&actions.setActiveTab(tab)}}})]),asyncMigrationParameterFormLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","instance","AsyncMigrations","asyncMigrationParameterFormLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(props=>props.migration.id),(0,lib.forms)(_ref=>{let{props}=_ref;return{parameters:{defaults:defaultParameters(props),submit:async parameters=>{asyncMigrationsLogic.actions.updateMigrationStatus({...props.migration,parameters},props.endpoint,props.message)}}}})]);function defaultParameters(props){let result={};return Object.keys(props.migration.parameter_definitions).forEach(key=>{props.migration.parameters[key]?result[key]=props.migration.parameters[key]:result[key]=props.migration.parameter_definitions[key][0]}),result}var jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function AsyncMigrationParametersModal(props){let{closeAsyncMigrationsModal}=(0,index_esm.useActions)(asyncMigrationsLogic),[collapsed,setCollapsed]=(0,react.useState)(!0);return(0,jsx_runtime.jsx)(LemonModal.f,{title:"",onClose:closeAsyncMigrationsModal,isOpen:!0,simple:!0,children:(0,jsx_runtime.jsxs)(lib.Form,{logic:asyncMigrationParameterFormLogic,props:props,formKey:"parameters",enableFormOnSubmit:!0,id:"async-migration-parameters-form",className:"LemonModal__layout",children:[(0,jsx_runtime.jsx)(LemonModal.f.Header,{children:(0,jsx_runtime.jsx)("h3",{children:"Advanced migration configuration"})}),(0,jsx_runtime.jsxs)(LemonModal.f.Content,{children:[(0,jsx_runtime.jsxs)("p",{children:["This async migration allows tuning parameters used in the async migration.",collapsed&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)(src.rU,{onClick:()=>{setCollapsed(!collapsed)},children:"Show advanced configuration"})]})]}),(0,jsx_runtime.jsx)(AnimatedCollapsible.r,{collapsed:collapsed,children:Object.entries(props.migration.parameter_definitions).map(_ref=>{let[parameterName,[defaultValue,parameterDescription]]=_ref;return(0,jsx_runtime.jsx)(lib.Field,{name:parameterName,label:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:parameterDescription}),children:(0,jsx_runtime.jsx)(LemonInput.D,{type:"number"==typeof defaultValue?"number":"text"})},parameterName)})})]}),(0,jsx_runtime.jsxs)(LemonModal.f.Footer,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{form:"async-migration-parameters-form",type:"secondary","data-attr":"async-migration-parameters-cancel",className:"mr-2",onClick:closeAsyncMigrationsModal,children:"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{form:"async-migration-parameters-form",htmlType:"submit",type:"primary","data-attr":"async-migration-parameters-submit",children:"Run migration"})]})]})})}function AsyncMigrationDetails(_ref){let{asyncMigration}=_ref,{asyncMigrationErrorsLoading,asyncMigrationErrors}=(0,index_esm.useValues)(asyncMigrationsLogic),{loadAsyncMigrationErrors}=(0,index_esm.useActions)(asyncMigrationsLogic),columns=[{title:"Error",dataIndex:"description"},{title:(0,jsx_runtime.jsx)(LemonButton.J,{icon:asyncMigrationErrorsLoading[asyncMigration.id]?(0,jsx_runtime.jsx)(Spinner.$,{}):(0,jsx_runtime.jsx)(icons.tr,{}),onClick:()=>loadAsyncMigrationErrors(asyncMigration.id),type:"secondary",size:"small",children:"Refresh errors"}),render:function Render(_,asyncMigrationError){return(0,jsx_runtime.jsx)("div",{children:(0,utils.bo)(asyncMigrationError.created_at)})}}];return(0,jsx_runtime.jsx)(LemonTable.g,{columns:columns,dataSource:asyncMigrationErrors[asyncMigration.id],loading:asyncMigrationErrorsLoading[asyncMigration.id],embedded:!0})}function SettingUpdateField(_ref){let{setting}=_ref,{updateSetting}=(0,index_esm.useActions)(asyncMigrationsLogic),[inputValue,setInputValue]=(0,react.useState)(String(setting.value));return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{children:setting.key}),(0,jsx_runtime.jsx)("p",{children:setting.description}),(0,jsx_runtime.jsxs)("div",{className:"flex space-x-2",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/3",children:(0,jsx_runtime.jsx)(src.DF,{value:inputValue,onChange:setInputValue})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",disabledReason:String(setting.value)===inputValue&&"Edit the value to save it",onClick:()=>updateSetting(setting.key,inputValue),children:"Update"})})]}),(0,jsx_runtime.jsx)(src.p2,{})]},setting.key)}let scene={component:AsyncMigrations,logic:asyncMigrationsLogic};function AsyncMigrations(){let{user}=(0,index_esm.useValues)(userLogic.userLogic),{asyncMigrationsLoading,activeTab,asyncMigrationSettings,isAnyMigrationRunning,activeAsyncMigrationModal,actionableMigrations,futureMigrations}=(0,index_esm.useValues)(asyncMigrationsLogic),{triggerMigration,resumeMigration,rollbackMigration,forceStopMigration,forceStopMigrationWithoutRollback,loadAsyncMigrations,loadAsyncMigrationErrors,setActiveTab}=(0,index_esm.useActions)(asyncMigrationsLogic);(0,react.useEffect)(()=>{if(isAnyMigrationRunning){let interval=setInterval(()=>loadAsyncMigrations(),3e3);return()=>clearInterval(interval)}},[isAnyMigrationRunning]);let nameColumn={title:"Migration",render:function Render(_,asyncMigration){let link="https://github.com/PostHog/posthog/blob/master/posthog/async_migrations/migrations/"+asyncMigration.name+".py";return(0,jsx_runtime.jsx)(LemonTableLink.i,{to:link,title:asyncMigration.name,description:asyncMigration.description})}},statusColumn={title:"Status",render:function Render(_,asyncMigration){let status=asyncMigration.status,type=status===AsyncMigrationStatus.Running?"success":status===AsyncMigrationStatus.Errored||status===AsyncMigrationStatus.FailedAtStartup?"danger":status===AsyncMigrationStatus.Starting?"warning":status===AsyncMigrationStatus.RolledBack?"warning":"default";return(0,jsx_runtime.jsx)(LemonTag.o,{type:type,className:"uppercase",children:migrationStatusNumberToMessage[status]})}},columns={};columns[AsyncMigrationsTab.FutureMigrations]=[nameColumn,statusColumn,{title:"Minimum PostHog version",render:function Render(_,asyncMigration){return(0,jsx_runtime.jsx)("div",{children:asyncMigration.posthog_min_version})}},{title:"Maximum PostHog version",render:function Render(_,asyncMigration){return(0,jsx_runtime.jsx)("div",{children:asyncMigration.posthog_max_version})}}],columns[AsyncMigrationsTab.Management]=[nameColumn,{title:"Progress",render:function Render(_,asyncMigration){let progress=asyncMigration.progress;return(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(LemonProgress.b,{percent:progress})})}},statusColumn,{title:"Last operation index",render:function Render(_,asyncMigration){return(0,jsx_runtime.jsx)("div",{children:asyncMigration.current_operation_index})}},{title:"Last query ID",render:function Render(_,asyncMigration){return(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("small",{children:asyncMigration.current_query_id})})}},{title:"Started at",render:function Render(_,asyncMigration){let startedAt=asyncMigration.started_at;return(0,jsx_runtime.jsx)("div",{children:(0,utils.bo)(startedAt)})}},{title:"Finished at",render:function Render(_,asyncMigration){let finishedAt=asyncMigration.finished_at;return(0,jsx_runtime.jsx)("div",{children:(0,utils.bo)(finishedAt)})}},{title:"",render:function Render(_,asyncMigration){let status=asyncMigration.status;return(0,jsx_runtime.jsx)("div",{children:status===AsyncMigrationStatus.NotStarted||status===AsyncMigrationStatus.FailedAtStartup?(0,jsx_runtime.jsx)(Tooltip.u,{title:"Start",children:(0,jsx_runtime.jsx)(LemonButton.J,{size:"small",icon:(0,jsx_runtime.jsx)(icons.Ud,{}),onClick:()=>triggerMigration(asyncMigration),children:"Run"})}):status===AsyncMigrationStatus.Starting||status===AsyncMigrationStatus.Running?(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>forceStopMigration(asyncMigration),fullWidth:!0,children:"Stop and rollback"}),(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>forceStopMigrationWithoutRollback(asyncMigration),fullWidth:!0,children:"Stop"})]})}):status===AsyncMigrationStatus.CompletedSuccessfully?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{}):status===AsyncMigrationStatus.Errored?(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>resumeMigration(asyncMigration),fullWidth:!0,children:"Resume"}),(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>rollbackMigration(asyncMigration),fullWidth:!0,children:"Rollback"})]})}):status===AsyncMigrationStatus.RolledBack?(0,jsx_runtime.jsx)(Tooltip.u,{title:"Restart",children:(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(icons.ys,{}),onClick:()=>triggerMigration(asyncMigration),fullWidth:!0})}):null})}}];let migrations={};migrations[AsyncMigrationsTab.FutureMigrations]=futureMigrations,migrations[AsyncMigrationsTab.Management]=actionableMigrations;let tabs=[{key:AsyncMigrationsTab.Management,label:`Management (${actionableMigrations.length})`},{key:AsyncMigrationsTab.Settings,label:"Settings"}];return futureMigrations.length>0&&tabs.splice(1,0,{key:AsyncMigrationsTab.FutureMigrations,label:`Future Migrations (${futureMigrations.length})`}),(0,jsx_runtime.jsx)("div",{children:user?.is_staff?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{caption:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"Manage async migrations in your instance."}),(0,jsx_runtime.jsxs)("p",{children:["Read about async migrations on our"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/self-host/configure/async-migrations/overview",children:"dedicated docs page"}),"."]})]})}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:activeTab,onChange:setActiveTab,tabs:tabs}),[AsyncMigrationsTab.Management,AsyncMigrationsTab.FutureMigrations].includes(activeTab)?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"mb-4 float-right",children:(0,jsx_runtime.jsx)(LemonButton.J,{icon:asyncMigrationsLoading?(0,jsx_runtime.jsx)(Spinner.$,{}):(0,jsx_runtime.jsx)(icons.tr,{}),onClick:loadAsyncMigrations,type:"secondary",size:"small",children:"Refresh"})}),(0,jsx_runtime.jsx)(LemonTable.g,{pagination:{pageSize:10},loading:asyncMigrationsLoading,columns:columns[activeTab],dataSource:migrations[activeTab],expandable:{expandedRowRender:function renderExpand(asyncMigration){return asyncMigration&&(0,jsx_runtime.jsx)(AsyncMigrationDetails,{asyncMigration:asyncMigration})},rowExpandable:asyncMigration=>asyncMigration.error_count>0,onRowExpand:function getErrors(asyncMigration){loadAsyncMigrationErrors(asyncMigration.id)}}}),activeAsyncMigrationModal?(0,jsx_runtime.jsx)(AsyncMigrationParametersModal,{...activeAsyncMigrationModal}):null]}):activeTab===AsyncMigrationsTab.Settings?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),asyncMigrationSettings.map(setting=>(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(SettingUpdateField,{setting:setting})},setting.key))]}):null]}):(0,jsx_runtime.jsx)(PageHeader.m,{caption:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"Only users with staff access can manage async migrations. Please contact your instance admin."}),(0,jsx_runtime.jsxs)("p",{children:["If you're an admin and don't have access, set ",(0,jsx_runtime.jsx)("code",{children:"is_staff=true"})," for your user on the PostgreSQL ",(0,jsx_runtime.jsx)("code",{children:"posthog_user"})," table."]})]})})})}},"./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{D:()=>ConfigMode,Q:()=>systemStatusLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./frontend/src/lib/api.ts"),lib_lemon_ui_LemonToast_LemonToast__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./frontend/src/lib/lemon-ui/LemonToast/LemonToast.tsx"),lib_utils__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/utils.tsx"),lib_utils_eventUsageLogic__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/lib/utils/eventUsageLogic.ts"),scenes_PreflightCheck_preflightLogic__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./frontend/src/scenes/userLogic.ts");let ConfigMode=function(ConfigMode){return ConfigMode.View="view",ConfigMode.Edit="edit",ConfigMode.Saving="saving",ConfigMode}({}),EDITABLE_INSTANCE_SETTINGS=["RECORDINGS_TTL_WEEKS","RECORDINGS_PERFORMANCE_EVENTS_TTL_WEEKS","EMAIL_ENABLED","EMAIL_HOST","EMAIL_PORT","EMAIL_HOST_USER","EMAIL_HOST_PASSWORD","EMAIL_USE_TLS","EMAIL_USE_SSL","EMAIL_DEFAULT_FROM","EMAIL_REPLY_TO","AGGREGATE_BY_DISTINCT_IDS_TEAMS","PERSON_ON_EVENTS_ENABLED","STRICT_CACHING_TEAMS","SLACK_APP_CLIENT_ID","SLACK_APP_CLIENT_SECRET","SLACK_APP_SIGNING_SECRET","PARALLEL_DASHBOARD_ITEM_CACHE","RATE_LIMIT_ENABLED","RATE_LIMITING_ALLOW_LIST_TEAMS","SENTRY_AUTH_TOKEN","SENTRY_ORGANIZATION","HEATMAP_SAMPLE_N"],systemStatusLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","instance","SystemStatus","systemStatusLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setTab:tab=>({tab}),setOpenSections:sections=>({sections}),setInstanceConfigMode:mode=>({mode}),updateInstanceConfigValue:(key,value)=>({key,value}),clearInstanceConfigEditing:!0,saveInstanceConfig:!0,setUpdatedInstanceConfigCount:count=>({count}),increaseUpdatedInstanceConfigCount:!0}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(()=>({systemStatus:[null,{loadSystemStatus:async()=>{var _await$api$get$result;return!(0,lib_utils__WEBPACK_IMPORTED_MODULE_5__.Pc)()||scenes_PreflightCheck_preflightLogic__WEBPACK_IMPORTED_MODULE_7__.preflightLogic.values.preflight?.cloud&&!scenes_userLogic__WEBPACK_IMPORTED_MODULE_8__.userLogic.values.user?.is_staff?null:null!==(_await$api$get$result=(await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.get("api/instance_status")).results)&&void 0!==_await$api$get$result?_await$api$get$result:null}}],instanceSettings:[[],{loadInstanceSettings:async()=>{var _await$api$get$result2;return null!==(_await$api$get$result2=(await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.get("api/instance_settings")).results)&&void 0!==_await$api$get$result2?_await$api$get$result2:[]}}],queries:[null,{loadQueries:async()=>(await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.get("api/instance_status/queries")).results}]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({tab:["overview",{setTab:(_,_ref)=>{let{tab}=_ref;return tab}}],error:[null,{loadSystemStatusFailure:(_,_ref2)=>{let{error}=_ref2;return error}}],openSections:[["0"],{persist:!0},{setOpenSections:(_,_ref3)=>{let{sections}=_ref3;return sections}}],instanceConfigMode:[ConfigMode.View,{setInstanceConfigMode:(_,_ref4)=>{let{mode}=_ref4;return mode}}],instanceConfigEditingState:[{},{updateInstanceConfigValue:(s,_ref5)=>{let{key,value}=_ref5;if(void 0!==value)return{...s,[key]:value};let newState={...s};return delete newState[key],newState},clearInstanceConfigEditing:()=>({})}],updatedInstanceConfigCount:[null,{setUpdatedInstanceConfigCount:(_,_ref6)=>{let{count}=_ref6;return count},loadInstanceSettings:()=>null,increaseUpdatedInstanceConfigCount:state=>(null!=state?state:0)+1}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(()=>({overview:[s=>[s.systemStatus],status=>status?status.overview:[]],editableInstanceSettings:[s=>[s.instanceSettings],instanceSettings=>instanceSettings.filter(item=>item.editable&&EDITABLE_INSTANCE_SETTINGS.includes(item.key))]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref7=>{let{actions,values}=_ref7;return{setTab:_ref8=>{let{tab}=_ref8;"metrics"===tab&&actions.loadQueries(),actions.setInstanceConfigMode(ConfigMode.View)},updateInstanceConfigValue:_ref9=>{let{key,value}=_ref9,previousValue=values.editableInstanceSettings.find(item=>item.key===key)?.value;value&&previousValue==value&&actions.updateInstanceConfigValue(key,void 0)},saveInstanceConfig:async(_,breakpoint)=>{actions.setUpdatedInstanceConfigCount(0),await Promise.all(Object.entries(values.instanceConfigEditingState).map(async _ref10=>{let[key,value]=_ref10;await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.update(`api/instance_settings/${key}`,{value}),lib_utils_eventUsageLogic__WEBPACK_IMPORTED_MODULE_6__.vx.actions.reportInstanceSettingChange(key,value),actions.increaseUpdatedInstanceConfigCount()})),await breakpoint(1e3),values.updatedInstanceConfigCount===Object.keys(values.instanceConfigEditingState).length&&(actions.loadInstanceSettings(),actions.clearInstanceConfigEditing(),actions.setInstanceConfigMode(ConfigMode.View),lib_lemon_ui_LemonToast_LemonToast__WEBPACK_IMPORTED_MODULE_4__.UJ.success("Instance settings updated"))}}}),(0,kea_router__WEBPACK_IMPORTED_MODULE_2__.actionToUrl)(_ref11=>{let{values}=_ref11;return{setTab:()=>"/instance/"+("overview"===values.tab?"status":values.tab)}}),(0,kea_router__WEBPACK_IMPORTED_MODULE_2__.urlToAction)(_ref12=>{let{actions,values}=_ref12;return{"/instance(/:tab)":_ref13=>{let{tab}=_ref13,currentTab=tab&&["metrics","settings","staff_users"].includes(tab)?tab:"overview";currentTab!==values.tab&&actions.setTab(currentTab)}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.events)(_ref14=>{let{actions}=_ref14;return{afterMount:()=>{actions.loadSystemStatus()}}})])}}]);