"use strict";(self.webpackChunk_posthog_frontend=self.webpackChunk_posthog_frontend||[]).push([[73086,98095],{"./frontend/src/scenes/max/Max.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{EmptyThreadLoading:()=>EmptyThreadLoading,GenerationFailureThread:()=>GenerationFailureThread,Thread:()=>Thread,ThreadWithFailedGeneration:()=>ThreadWithFailedGeneration,ThreadWithForm:()=>ThreadWithForm,ThreadWithRateLimit:()=>ThreadWithRateLimit,Welcome:()=>Welcome,WelcomeLoadingSuggestions:()=>WelcomeLoadingSuggestions,WelcomeSuggestionsAvailable:()=>WelcomeSuggestionsAvailable,__namedExportsOrder:()=>__namedExportsOrder,default:()=>Max_stories});var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),api_mock=__webpack_require__("./frontend/src/lib/api.mock.ts"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),projectLogic=__webpack_require__("./frontend/src/scenes/projectLogic.ts"),browser=__webpack_require__("./frontend/src/mocks/browser.tsx"),schema_assistant_messages=__webpack_require__("./frontend/src/queries/schema/schema-assistant-messages.ts");let failureMessage_namespaceObject=JSON.parse('{"type":"ai/failure","content":"Oops! It looks like I’m having trouble generating this trends insight. Could you please try again?","id":"test-failure-message"}'),summaryMessage_namespaceObject=JSON.parse('{"type":"ai","content":"Looks like no pageviews have occured. Get some damn users.","id":"test-summary-message"}'),visualizationMessage_namespaceObject=JSON.parse('{"type":"ai/viz","plan":"Test plan","query":{"aggregation_group_type_index":null,"breakdownFilter":{"breakdown_hide_other_aggregation":null,"breakdown_histogram_bin_count":null,"breakdown_limit":null,"breakdowns":[{"group_type_index":null,"histogram_bin_count":null,"normalize_url":null,"property":"$current_url","type":"event"}]},"compareFilter":null,"dateRange":{"date_from":"-30d","date_to":null,"explicitDate":false},"filterTestAccounts":true,"interval":"day","kind":"TrendsQuery","properties":[],"samplingFactor":null,"series":[{"custom_name":"Pageviews","event":"$pageview","fixedProperties":null,"kind":"EventsNode","math":"total","math_group_type_index":null,"math_property":null,"name":null,"orderBy":null,"properties":null,"response":null}],"trendsFilter":{"aggregationAxisFormat":"numeric","aggregationAxisPostfix":null,"aggregationAxisPrefix":null,"breakdown_histogram_bin_count":null,"decimalPlaces":null,"display":"ActionsBar","formula":null,"hiddenLegendIndexes":null,"showLabelsOnSeries":null,"showLegend":false,"showPercentStackView":false,"showValuesOnSeries":false,"smoothingIntervals":1,"yAxisScaleType":null}},"id":"test-visualization-message"}'),CONVERSATION_ID="b1b4b3b4-1b3b-4b3b-1b3b4b3b4b3b",humanMessage={type:schema_assistant_messages.pj.Human,content:"What are my most popular pages?",id:"human-1"},reasoningMessage1={type:schema_assistant_messages.pj.Reasoning,content:"Picking relevant events and properties",id:"reasoning-1"},reasoningMessage2={type:schema_assistant_messages.pj.Reasoning,content:"Generating trends",id:"reasoning-2"};function generateChunk(events){return events.map(event=>event.startsWith("event:")?`${event}
`:`${event}

`).join("")}let chatResponseChunk=generateChunk(["event: conversation",`data: ${JSON.stringify({id:CONVERSATION_ID})}`,"event: message",`data: ${JSON.stringify(humanMessage)}`,"event: message",`data: ${JSON.stringify(reasoningMessage1)}`,"event: message",`data: ${JSON.stringify(reasoningMessage2)}`,"event: message",`data: ${JSON.stringify(visualizationMessage_namespaceObject)}`,"event: message",`data: ${JSON.stringify(summaryMessage_namespaceObject)}`]);generateChunk(["event: message",`data: ${JSON.stringify(reasoningMessage1)}`,"event: message",`data: ${JSON.stringify(reasoningMessage2)}`]);let generationFailure={type:schema_assistant_messages.PP.GenerationError},responseWithReasoningStepsOnly={...visualizationMessage_namespaceObject,answer:null},generationFailureChunk=generateChunk(["event: message",`data: ${JSON.stringify(responseWithReasoningStepsOnly)}`,"event: status",`data: ${JSON.stringify(generationFailure)}`]),failureChunk=generateChunk(["event: message",`data: ${JSON.stringify(failureMessage_namespaceObject)}`]),formMessage={type:schema_assistant_messages.pj.Assistant,content:"Does this look like a good summary of what your product does?",id:"assistant-1",meta:{form:{options:[{value:"Yes, save this",variant:"primary"},{value:"No, not quite right"}]}}},formChunk=generateChunk(["event: message",`data: ${JSON.stringify(formMessage)}`]);var Max=__webpack_require__("./frontend/src/scenes/max/Max.tsx"),maxGlobalLogic=__webpack_require__("./frontend/src/scenes/max/maxGlobalLogic.ts"),maxLogic=__webpack_require__("./frontend/src/scenes/max/maxLogic.ts"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let Max_stories={title:"Scenes-App/Max AI",decorators:[(0,browser.x8)({post:{"/api/environments/:team_id/conversations/":(_,res,ctx)=>res(ctx.text(chatResponseChunk))}})],parameters:{layout:"fullscreen",viewMode:"story",mockDate:"2023-01-28"}},Template=_ref=>{let{conversationId:CONVERSATION_ID}=_ref,{acceptDataProcessing}=(0,index_esm.useActions)(maxGlobalLogic.V);return(0,react.useEffect)(()=>{acceptDataProcessing()},[]),(0,jsx_runtime.jsx)("div",{className:"relative flex flex-col h-fit",children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:maxLogic.v,props:{conversationId:CONVERSATION_ID},children:(0,jsx_runtime.jsx)(Max.MaxInstance,{})})})},Welcome=()=>{(0,browser.ok)({post:{"/api/environments/:team_id/query/":()=>[200,{questions:["What are my most popular pages?","Where are my users located?","Who are the biggest customers?","Which feature drives most usage?"]}]}});let{acceptDataProcessing}=(0,index_esm.useActions)(maxGlobalLogic.V);return(0,react.useEffect)(()=>{acceptDataProcessing(!1)},[]),(0,jsx_runtime.jsx)(Template,{conversationId:CONVERSATION_ID})},WelcomeSuggestionsAvailable=()=>{let{loadCurrentProjectSuccess}=(0,index_esm.useActions)(projectLogic.K);return(0,react.useEffect)(()=>{loadCurrentProjectSuccess({...api_mock.w8,product_description:"A Storybook test."})},[]),(0,jsx_runtime.jsx)(Welcome,{})},WelcomeLoadingSuggestions=()=>{(0,browser.ok)({post:{"/api/environments/:team_id/query/":(_req,_res,ctx)=>[ctx.delay("infinite")]}});let{loadCurrentProjectSuccess}=(0,index_esm.useActions)(projectLogic.K);return(0,react.useEffect)(()=>{loadCurrentProjectSuccess({...api_mock.w8,product_description:"A Storybook test."})},[]),(0,jsx_runtime.jsx)(Template,{conversationId:CONVERSATION_ID})};WelcomeLoadingSuggestions.parameters={testOptions:{waitForLoadersToDisappear:!1}};let Thread=()=>{let{askMax}=(0,index_esm.useActions)((0,maxLogic.v)({conversationId:CONVERSATION_ID}));return(0,react.useEffect)(()=>{askMax(humanMessage.content)},[]),(0,jsx_runtime.jsx)(Template,{conversationId:CONVERSATION_ID})},EmptyThreadLoading=()=>{(0,browser.ok)({post:{"/api/environments/:team_id/conversations/":(_req,_res,ctx)=>[ctx.delay("infinite")]}});let{askMax}=(0,index_esm.useActions)((0,maxLogic.v)({conversationId:CONVERSATION_ID}));return(0,react.useEffect)(()=>{askMax(humanMessage.content)},[]),(0,jsx_runtime.jsx)(Template,{conversationId:CONVERSATION_ID})};EmptyThreadLoading.parameters={testOptions:{waitForLoadersToDisappear:!1}};let GenerationFailureThread=()=>{(0,browser.ok)({post:{"/api/environments/:team_id/conversations/":(_,res,ctx)=>res(ctx.text(generationFailureChunk))}});let{askMax,setMessageStatus}=(0,index_esm.useActions)((0,maxLogic.v)({conversationId:CONVERSATION_ID})),{threadRaw,threadLoading}=(0,index_esm.useValues)((0,maxLogic.v)({conversationId:CONVERSATION_ID}));return(0,react.useEffect)(()=>{askMax(humanMessage.content)},[]),(0,react.useEffect)(()=>{2!==threadRaw.length||threadLoading||setMessageStatus(1,"error")},[threadRaw.length,threadLoading]),(0,jsx_runtime.jsx)(Template,{conversationId:CONVERSATION_ID})},ThreadWithFailedGeneration=()=>{(0,browser.ok)({post:{"/api/environments/:team_id/conversations/":(_,res,ctx)=>res(ctx.text(failureChunk))}});let{askMax}=(0,index_esm.useActions)((0,maxLogic.v)({conversationId:CONVERSATION_ID}));return(0,react.useEffect)(()=>{askMax(humanMessage.content)},[]),(0,jsx_runtime.jsx)(Template,{conversationId:CONVERSATION_ID})},ThreadWithRateLimit=()=>{(0,browser.ok)({post:{"/api/environments/:team_id/conversations/":(_,res,ctx)=>res(ctx.text(chatResponseChunk),ctx.status(429))}});let{askMax}=(0,index_esm.useActions)((0,maxLogic.v)({conversationId:CONVERSATION_ID}));return(0,react.useEffect)(()=>{askMax("Is Bielefeld real?")},[]),(0,jsx_runtime.jsx)(Template,{conversationId:CONVERSATION_ID})},ThreadWithForm=()=>{(0,browser.ok)({post:{"/api/environments/:team_id/conversations/":(_,res,ctx)=>res(ctx.text(formChunk))}});let{askMax}=(0,index_esm.useActions)((0,maxLogic.v)({conversationId:CONVERSATION_ID}));return(0,react.useEffect)(()=>{askMax(humanMessage.content)},[]),(0,jsx_runtime.jsx)(Template,{conversationId:CONVERSATION_ID})};Welcome.parameters={...Welcome.parameters,docs:{...Welcome.parameters?.docs,source:{originalSource:"() => {\n  useStorybookMocks({\n    post: {\n      '/api/environments/:team_id/query/': () => [200, {\n        questions: ['What are my most popular pages?', 'Where are my users located?', 'Who are the biggest customers?', 'Which feature drives most usage?']\n      }]\n    }\n  });\n  const {\n    acceptDataProcessing\n  } = useActions(maxGlobalLogic);\n  useEffect(() => {\n    // We override data processing opt-in to false, so that wee see the welcome screen as a first-time user would\n    acceptDataProcessing(false);\n  }, []);\n  return <Template conversationId={CONVERSATION_ID} />;\n}",...Welcome.parameters?.docs?.source}}},WelcomeSuggestionsAvailable.parameters={...WelcomeSuggestionsAvailable.parameters,docs:{...WelcomeSuggestionsAvailable.parameters?.docs,source:{originalSource:"() => {\n  const {\n    loadCurrentProjectSuccess\n  } = useActions(projectLogic);\n  useEffect(() => {\n    loadCurrentProjectSuccess({\n      ...MOCK_DEFAULT_PROJECT,\n      product_description: 'A Storybook test.'\n    });\n  }, []);\n  return <Welcome />;\n}",...WelcomeSuggestionsAvailable.parameters?.docs?.source}}},WelcomeLoadingSuggestions.parameters={...WelcomeLoadingSuggestions.parameters,docs:{...WelcomeLoadingSuggestions.parameters?.docs,source:{originalSource:"() => {\n  useStorybookMocks({\n    post: {\n      '/api/environments/:team_id/query/': (_req, _res, ctx) => [ctx.delay('infinite')]\n    }\n  });\n  const {\n    loadCurrentProjectSuccess\n  } = useActions(projectLogic);\n  useEffect(() => {\n    loadCurrentProjectSuccess({\n      ...MOCK_DEFAULT_PROJECT,\n      product_description: 'A Storybook test.'\n    });\n  }, []);\n  return <Template conversationId={CONVERSATION_ID} />;\n}",...WelcomeLoadingSuggestions.parameters?.docs?.source}}},Thread.parameters={...Thread.parameters,docs:{...Thread.parameters?.docs,source:{originalSource:"() => {\n  const {\n    askMax\n  } = useActions(maxLogic({\n    conversationId: CONVERSATION_ID\n  }));\n  useEffect(() => {\n    askMax(humanMessage.content);\n  }, []);\n  return <Template conversationId={CONVERSATION_ID} />;\n}",...Thread.parameters?.docs?.source}}},EmptyThreadLoading.parameters={...EmptyThreadLoading.parameters,docs:{...EmptyThreadLoading.parameters?.docs,source:{originalSource:"() => {\n  useStorybookMocks({\n    post: {\n      '/api/environments/:team_id/conversations/': (_req, _res, ctx) => [ctx.delay('infinite')]\n    }\n  });\n  const {\n    askMax\n  } = useActions(maxLogic({\n    conversationId: CONVERSATION_ID\n  }));\n  useEffect(() => {\n    askMax(humanMessage.content);\n  }, []);\n  return <Template conversationId={CONVERSATION_ID} />;\n}",...EmptyThreadLoading.parameters?.docs?.source}}},GenerationFailureThread.parameters={...GenerationFailureThread.parameters,docs:{...GenerationFailureThread.parameters?.docs,source:{originalSource:"() => {\n  useStorybookMocks({\n    post: {\n      '/api/environments/:team_id/conversations/': (_, res, ctx) => res(ctx.text(generationFailureChunk))\n    }\n  });\n  const {\n    askMax,\n    setMessageStatus\n  } = useActions(maxLogic({\n    conversationId: CONVERSATION_ID\n  }));\n  const {\n    threadRaw,\n    threadLoading\n  } = useValues(maxLogic({\n    conversationId: CONVERSATION_ID\n  }));\n  useEffect(() => {\n    askMax(humanMessage.content);\n  }, []);\n  useEffect(() => {\n    if (threadRaw.length === 2 && !threadLoading) {\n      setMessageStatus(1, 'error');\n    }\n  }, [threadRaw.length, threadLoading]);\n  return <Template conversationId={CONVERSATION_ID} />;\n}",...GenerationFailureThread.parameters?.docs?.source}}},ThreadWithFailedGeneration.parameters={...ThreadWithFailedGeneration.parameters,docs:{...ThreadWithFailedGeneration.parameters?.docs,source:{originalSource:"() => {\n  useStorybookMocks({\n    post: {\n      '/api/environments/:team_id/conversations/': (_, res, ctx) => res(ctx.text(failureChunk))\n    }\n  });\n  const {\n    askMax\n  } = useActions(maxLogic({\n    conversationId: CONVERSATION_ID\n  }));\n  useEffect(() => {\n    askMax(humanMessage.content);\n  }, []);\n  return <Template conversationId={CONVERSATION_ID} />;\n}",...ThreadWithFailedGeneration.parameters?.docs?.source}}},ThreadWithRateLimit.parameters={...ThreadWithRateLimit.parameters,docs:{...ThreadWithRateLimit.parameters?.docs,source:{originalSource:"() => {\n  useStorybookMocks({\n    post: {\n      '/api/environments/:team_id/conversations/': (_, res, ctx) => res(ctx.text(chatResponseChunk), ctx.status(429))\n    }\n  });\n  const {\n    askMax\n  } = useActions(maxLogic({\n    conversationId: CONVERSATION_ID\n  }));\n  useEffect(() => {\n    askMax('Is Bielefeld real?');\n  }, []);\n  return <Template conversationId={CONVERSATION_ID} />;\n}",...ThreadWithRateLimit.parameters?.docs?.source}}},ThreadWithForm.parameters={...ThreadWithForm.parameters,docs:{...ThreadWithForm.parameters?.docs,source:{originalSource:"() => {\n  useStorybookMocks({\n    post: {\n      '/api/environments/:team_id/conversations/': (_, res, ctx) => res(ctx.text(formChunk))\n    }\n  });\n  const {\n    askMax\n  } = useActions(maxLogic({\n    conversationId: CONVERSATION_ID\n  }));\n  useEffect(() => {\n    askMax(humanMessage.content);\n  }, []);\n  return <Template conversationId={CONVERSATION_ID} />;\n}",...ThreadWithForm.parameters?.docs?.source}}};let __namedExportsOrder=["Welcome","WelcomeSuggestionsAvailable","WelcomeLoadingSuggestions","Thread","EmptyThreadLoading","GenerationFailureThread","ThreadWithFailedGeneration","ThreadWithRateLimit","ThreadWithForm"]},"./frontend/src/queries/schema/schema-assistant-messages.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{KC:()=>AssistantEventType,PP:()=>AssistantGenerationStatusType,pj:()=>AssistantMessageType});let AssistantMessageType=function(AssistantMessageType){return AssistantMessageType.Human="human",AssistantMessageType.Assistant="ai",AssistantMessageType.Reasoning="ai/reasoning",AssistantMessageType.Visualization="ai/viz",AssistantMessageType.Failure="ai/failure",AssistantMessageType.Router="ai/router",AssistantMessageType}({}),AssistantEventType=function(AssistantEventType){return AssistantEventType.Status="status",AssistantEventType.Message="message",AssistantEventType.Conversation="conversation",AssistantEventType}({}),AssistantGenerationStatusType=function(AssistantGenerationStatusType){return AssistantGenerationStatusType.Acknowledged="ack",AssistantGenerationStatusType.GenerationError="generation_error",AssistantGenerationStatusType}({})},"./frontend/src/scenes/max/Max.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Max:()=>Max,MaxInstance:()=>MaxInstance,scene:()=>scene});var posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.10.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),NotFound=__webpack_require__("./frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),constants=__webpack_require__("./frontend/src/lib/constants.tsx"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),featureFlagLogic=__webpack_require__("./frontend/src/lib/logic/featureFlagLogic.ts"),sidePanelSettingsLogic=__webpack_require__("./frontend/src/layout/navigation-3000/sidepanel/panels/sidePanelSettingsLogic.tsx"),floating_ui_core=__webpack_require__("./node_modules/.pnpm/@floating-ui+core@1.6.0/node_modules/@floating-ui/core/dist/floating-ui.core.mjs"),src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),HedgehogBuddy=__webpack_require__("./frontend/src/lib/components/HedgehogBuddy/HedgehogBuddy.tsx"),hedgehogBuddyLogic=__webpack_require__("./frontend/src/lib/components/HedgehogBuddy/hedgehogBuddyLogic.ts"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),maxGlobalLogic=__webpack_require__("./frontend/src/scenes/max/maxGlobalLogic.ts"),maxLogic=__webpack_require__("./frontend/src/scenes/max/maxLogic.ts"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let HEADLINES=["How can I help you build?","What are you curious about?","How can I help you understand users?","What do you want to know today?"];function Intro(){let{hedgehogConfig}=(0,index_esm.useValues)(hedgehogBuddyLogic.r),{acceptDataProcessing}=(0,index_esm.useActions)(maxGlobalLogic.V),{dataProcessingAccepted}=(0,index_esm.useValues)(maxGlobalLogic.V),{conversation}=(0,index_esm.useValues)(maxLogic.v),[hedgehogDirection,setHedgehogDirection]=(0,react.useState)("right"),headline=(0,react.useMemo)(()=>HEADLINES[parseInt((conversation?.id||(0,utils.Vj)()).split("-").at(-1),16)%HEADLINES.length],[conversation?.id]);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex",children:(0,jsx_runtime.jsx)(src.J2,{overlay:(0,jsx_runtime.jsxs)("div",{className:"m-1.5",children:[(0,jsx_runtime.jsxs)("p",{className:"font-medium text-pretty mb-1.5",children:["Hi! I use OpenAI services to analyze your data,",(0,jsx_runtime.jsx)("br",{}),"so that you can focus on building. This ",(0,jsx_runtime.jsx)("em",{children:"can"})," include",(0,jsx_runtime.jsx)("br",{}),"personal data of your users, if you're capturing it.",(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("em",{children:"Your data won't be used for training models."})]}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>acceptDataProcessing(),children:"Got it, I accept OpenAI processing data"})]}),placement:`${hedgehogDirection}-end`,middleware:[(0,floating_ui_core.cv)(-12)],showArrow:!0,visible:!dataProcessingAccepted,children:(0,jsx_runtime.jsx)(HedgehogBuddy.CV,{static:!0,hedgehogConfig:{...hedgehogConfig,walking_enabled:!1,controls_enabled:!1},onClick:actor=>{.01>Math.random()?actor.setOnFire():actor.setRandomAnimation()},onActorLoaded:actor=>setTimeout(()=>{actor.setAnimation("wave"),actor.direction="right"},100),onPositionChange:actor=>setHedgehogDirection(actor.direction)})})}),(0,jsx_runtime.jsxs)("div",{className:"text-center mb-3",children:[(0,jsx_runtime.jsx)("h2",{className:"text-2xl font-bold mb-2 text-balance",children:headline}),(0,jsx_runtime.jsx)("div",{className:"text-muted text-balance",children:"I'm Max, here to help you build a succesful product. Ask me about your product and your users."})]})]})}var clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js");function QuestionInput(){let{question,threadGrouped,threadLoading,inputDisabled,submissionDisabledReason}=(0,index_esm.useValues)(maxLogic.v),{askMax,setQuestion}=(0,index_esm.useActions)(maxLogic.v),textAreaRef=(0,react.useRef)(null),isFloating=threadGrouped.length>0;return(0,react.useEffect)(()=>{threadLoading&&textAreaRef.current?.focus()},[threadLoading]),(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)(isFloating?"w-full max-w-[43rem] sticky z-10 self-center p-1 mx-4 mb-3 bottom-3 border border-[var(--glass-border-3000)] rounded-lg backdrop-blur bg-[var(--glass-bg-3000)]":"w-[min(44rem,100%)] relative"),children:[(0,jsx_runtime.jsx)(src._V,{ref:textAreaRef,value:question,onChange:value=>setQuestion(value),placeholder:threadLoading?"Thinking…":isFloating?"Ask follow-up":"Ask away",onPressEnter:()=>{question&&!submissionDisabledReason&&askMax(question)},disabled:inputDisabled,minRows:1,maxRows:10,className:(0,clsx_m.default)("p-3",isFloating&&"border-border-bold"),autoFocus:!0}),(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("absolute top-0 bottom-0 flex items-center",isFloating?"right-3":"right-2"),children:(0,jsx_runtime.jsx)(src.Jp,{type:isFloating&&!question?"secondary":"primary",onClick:()=>askMax(question),tooltip:"Let's go!",disabledReason:submissionDisabledReason,size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconArrowRight,{})})})]})}function QuestionSuggestions(){let{dataProcessingAccepted}=(0,index_esm.useValues)(maxGlobalLogic.V),{visibleSuggestions,allSuggestionsLoading,currentProject}=(0,index_esm.useValues)(maxLogic.v),{askMax,shuffleVisibleSuggestions}=(0,index_esm.useActions)(maxLogic.v),{openSettingsPanel}=(0,index_esm.useActions)(sidePanelSettingsLogic.A);return currentProject&&!currentProject.product_description?(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"primary",sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconOpenSidebar,{}),className:"relative",onClick:()=>{openSettingsPanel({settingId:"core-memory"}),setTimeout(()=>document.getElementById("product-description-textarea")?.focus(),1)},children:"Tell me a bit about your product, and I'll offer better answers and suggestions"}):(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center flex-wrap gap-x-2 gap-y-1.5 w-[min(48rem,100%)]",children:allSuggestionsLoading?Array.from({length:3}).map((_,index)=>(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"secondary",disabled:!0,style:{width:["35%","42.5%","50%"][index]},children:(0,jsx_runtime.jsx)(src.yW,{className:"h-3 w-full"})},index)):visibleSuggestions?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[visibleSuggestions.map((suggestion,index)=>(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>askMax(suggestion),size:"xsmall",type:"secondary",sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconArrowUpRight,{}),center:!0,className:"shrink",disabledReason:dataProcessingAccepted?void 0:"Please accept OpenAI processing data",children:suggestion},index)),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:shuffleVisibleSuggestions,size:"xsmall",type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconShuffle,{}),tooltip:"Shuffle suggestions"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>openSettingsPanel({settingId:"core-memory"}),size:"xsmall",type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGear,{}),tooltip:"Edit product description"})]})]}):null})}var InsightDetails=__webpack_require__("./frontend/src/lib/components/Cards/InsightCard/InsightDetails.tsx"),TopHeading=__webpack_require__("./frontend/src/lib/components/Cards/InsightCard/TopHeading.tsx"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts"),LemonMarkdown=__webpack_require__("./frontend/src/lib/lemon-ui/LemonMarkdown/index.ts"),dist_module=__webpack_require__("./node_modules/.pnpm/posthog-js@1.215.5/node_modules/posthog-js/dist/module.js"),urls=__webpack_require__("./frontend/src/scenes/urls.ts"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts"),bundle_mjs=__webpack_require__("./node_modules/.pnpm/tailwind-merge@2.2.2/node_modules/tailwind-merge/dist/bundle-mjs.mjs"),Query=__webpack_require__("./frontend/src/queries/Query/Query.tsx"),schema_general=__webpack_require__("./frontend/src/queries/schema/schema-general.ts"),max_utils=__webpack_require__("./frontend/src/scenes/max/utils.ts");function Thread(){let{threadGrouped}=(0,index_esm.useValues)(maxLogic.v);return(0,jsx_runtime.jsx)("div",{className:"flex flex-col items-stretch w-full max-w-200 self-center gap-2 grow p-4",children:threadGrouped.map((group,index)=>(0,jsx_runtime.jsx)(MessageGroup,{messages:group,index:index,isFinal:index===threadGrouped.length-1},index))})}function MessageGroup(_ref){let{messages,isFinal:isFinalGroup}=_ref,{user}=(0,index_esm.useValues)(userLogic.userLogic),groupType="human"===messages[0].type?"human":"ai";return(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("relative flex gap-2","human"===groupType?"flex-row-reverse ml-10":"mr-10"),children:[(0,jsx_runtime.jsx)(src.u,{placement:"human"===groupType?"right":"left",title:"human"===groupType?"You":"Max",children:(0,jsx_runtime.jsx)(src.YY,{user:"human"===groupType?{...user,hedgehog_config:void 0}:{hedgehog_config:{...user?.hedgehog_config,use_as_profile:!0}},size:"lg",className:"mt-1 border"})}),(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("flex flex-col gap-2 min-w-0 w-full","human"===groupType?"items-end":"items-start"),children:[messages.map((message,messageIndex)=>{let key=message.id||messageIndex;return(0,max_utils.Q1)(message)?(0,jsx_runtime.jsx)(MessageTemplate,{type:"human",boxClassName:"error"===message.status?"border-danger":void 0,children:(0,jsx_runtime.jsx)(LemonMarkdown.j,{children:message.content||"*No text.*"})},key):(0,max_utils.Gn)(message)||(0,max_utils.W$)(message)?(0,jsx_runtime.jsx)(TextAnswer,{message:message,interactable:messageIndex===messages.length-1,isFinalGroup:isFinalGroup},key):(0,max_utils.N_)(message)?(0,jsx_runtime.jsx)(VisualizationAnswer,{message:message,status:message.status},messageIndex):(0,max_utils.DB)(message)?(0,jsx_runtime.jsxs)(MessageTemplate,{type:"ai",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsxs)("span",{children:[message.content,"…"]}),(0,jsx_runtime.jsx)(src.$j,{className:"text-xl"})]}),message.substeps?.map((substep,substepIndex)=>jsx_runtime.jsx(LemonMarkdown.j,{className:"mt-1.5 leading-6 px-1 text-[0.6875rem] font-semibold bg-accent-3000 rounded w-fit",children:substep},substepIndex))]},key):null}),messages.at(-1)?.status==="error"&&(0,jsx_runtime.jsx)(MessageTemplate,{type:"ai",boxClassName:"border-warning",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconWarning,{className:"text-xl text-warning"}),(0,jsx_runtime.jsx)("i",{children:"Max is generating this answer one more time because the previous attempt has failed."})]})})]})]})}let MessageTemplate=react.forwardRef(function MessageTemplate(_ref2,ref){let{type,children,className,boxClassName,action}=_ref2;return(0,jsx_runtime.jsxs)("div",{className:(0,bundle_mjs.m6)("flex flex-col gap-1 w-full","human"===type?"items-end":"items-start",className),ref:ref,children:[(0,jsx_runtime.jsx)("div",{className:(0,bundle_mjs.m6)("border py-2 px-3 rounded-lg bg-bg-light","human"===type&&"font-medium",boxClassName),children:children}),action]})}),TextAnswer=react.forwardRef(function TextAnswer(_ref3,ref){let{message,interactable,isFinalGroup}=_ref3,retriable=!!(interactable&&isFinalGroup),action="completed"!==message.status?null:(0,max_utils.W$)(message)&&!message.content?.includes("usage limit")&&retriable?(0,jsx_runtime.jsx)(RetriableFailureActions,{}):(0,max_utils.Gn)(message)&&interactable?message.meta?.form?.options&&isFinalGroup?(0,jsx_runtime.jsx)(AssistantMessageForm,{form:message.meta.form}):(0,jsx_runtime.jsx)(SuccessActions,{retriable:retriable}):null;return(0,jsx_runtime.jsx)(MessageTemplate,{type:"ai",boxClassName:"error"===message.status||"ai/failure"===message.type?"border-danger":void 0,ref:ref,action:action,children:(0,jsx_runtime.jsx)(LemonMarkdown.j,{children:message.content||"*Max has failed to generate an answer. Please try again.*"})})});function AssistantMessageForm(_ref4){let{form}=_ref4,{askMax}=(0,index_esm.useActions)(maxLogic.v);return(0,jsx_runtime.jsx)("div",{className:"flex flex-wrap gap-2 mt-1",children:form.options.map(option=>(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>askMax(option.value),size:"small",type:option.variant&&["primary","secondary","tertiary"].includes(option.variant)?option.variant:"secondary",children:option.value},option.value))})}function VisualizationAnswer(_ref5){let{message,status}=_ref5,query=(0,react.useMemo)(()=>message.answer?{kind:schema_general.OH.InsightVizNode,source:(0,max_utils.YO)(message.answer),showHeader:!0}:null,[message]);return"completed"!==status?null:query&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)(MessageTemplate,{type:"ai",className:"w-full",boxClassName:"w-full",children:[(0,jsx_runtime.jsx)("div",{className:"min-h-80 flex",children:(0,jsx_runtime.jsx)(Query.A,{query:query,readOnly:!0,embedded:!0})}),(0,jsx_runtime.jsxs)("div",{className:"relative mb-1",children:[(0,jsx_runtime.jsx)(src.Jp,{to:urls.j.insightNew(void 0,void 0,query),sideIcon:(0,jsx_runtime.jsx)(icons.pF,{}),size:"xsmall",targetBlank:!0,className:"absolute right-0 -top-px",children:"Open as new insight"}),(0,jsx_runtime.jsx)(InsightDetails.qH,{query:query.source,heading:(0,jsx_runtime.jsx)(TopHeading.l,{query:query})}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-4 mt-1 *:grow",children:[(0,jsx_runtime.jsx)(InsightDetails.g4,{properties:query.source.properties}),(0,jsx_runtime.jsx)(InsightDetails.d8,{query:query.source})]})]})]})})}function RetriableFailureActions(){let{retryLastMessage}=(0,index_esm.useActions)(maxLogic.v);return(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconRefresh,{}),type:"tertiary",size:"small",tooltip:"Try again",onClick:()=>retryLastMessage(),children:"Try again"})}function SuccessActions(_ref6){let{retriable}=_ref6,{traceId}=(0,index_esm.useValues)(maxLogic.v),{retryLastMessage}=(0,index_esm.useActions)(maxLogic.v),[rating,setRating]=(0,react.useState)(null),[feedback,setFeedback]=(0,react.useState)(""),[feedbackInputStatus,setFeedbackInputStatus]=(0,react.useState)("hidden");function submitRating(newRating){rating||(setRating(newRating),dist_module.ZP.capture("$ai_metric",{$ai_metric_name:"quality",$ai_metric_value:newRating,$ai_trace_id:traceId}),"bad"===newRating&&setFeedbackInputStatus("pending"))}function submitFeedback(){feedback&&(dist_module.ZP.capture("$ai_feedback",{$ai_feedback_text:feedback,$ai_trace_id:traceId}),setFeedbackInputStatus("submitted"))}return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:["bad"!==rating&&(0,jsx_runtime.jsx)(src.Jp,{icon:"good"===rating?(0,jsx_runtime.jsx)(posthog_icons_es.IconThumbsUpFilled,{}):(0,jsx_runtime.jsx)(posthog_icons_es.IconThumbsUp,{}),type:"tertiary",size:"small",tooltip:"Good answer",onClick:()=>submitRating("good")}),"good"!==rating&&(0,jsx_runtime.jsx)(src.Jp,{icon:"bad"===rating?(0,jsx_runtime.jsx)(posthog_icons_es.IconThumbsDownFilled,{}):(0,jsx_runtime.jsx)(posthog_icons_es.IconThumbsDown,{}),type:"tertiary",size:"small",tooltip:"Bad answer",onClick:()=>submitRating("bad")}),retriable&&(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconRefresh,{}),type:"tertiary",size:"small",tooltip:"Try again",onClick:()=>retryLastMessage()})]}),"hidden"!==feedbackInputStatus&&(0,jsx_runtime.jsxs)(MessageTemplate,{type:"ai",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-1",children:[(0,jsx_runtime.jsx)("h4",{className:"m-0 text-sm grow",children:"pending"===feedbackInputStatus?"What disappointed you about the answer?":"Thank you for your feedback!"}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),type:"tertiary",size:"xsmall",onClick:()=>setFeedbackInputStatus("hidden")})]}),"pending"===feedbackInputStatus&&(0,jsx_runtime.jsxs)("div",{className:"flex w-full gap-2 items-center mt-1.5",children:[(0,jsx_runtime.jsx)(src.DF,{placeholder:"Help us improve Max…",fullWidth:!0,value:feedback,onChange:newValue=>setFeedback(newValue),onPressEnter:()=>submitFeedback(),autoFocus:!0}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>submitFeedback(),disabledReason:feedback?void 0:"Please type a few words!",children:"Submit"})]})]})]})}let scene={component:Max};function Max(){let{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.h);return featureFlags[constants.y8.ARTIFICIAL_HOG]?(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:maxLogic.v,props:{conversationId:null},children:(0,jsx_runtime.jsx)(MaxInstance,{})}):(0,jsx_runtime.jsx)(NotFound.T,{object:"page",caption:"You don't have access to AI features yet."})}function MaxInstance(){let{threadGrouped}=(0,index_esm.useValues)(maxLogic.v),{openSettingsPanel}=(0,index_esm.useActions)(sidePanelSettingsLogic.A),headerButtons=(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGear,{}),onClick:()=>{openSettingsPanel({settingId:"core-memory"}),setTimeout(()=>document.getElementById("product-description-textarea")?.focus(),1)},children:"Settings"});return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{delimited:!0,buttons:headerButtons}),threadGrouped.length?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(Thread,{}),(0,jsx_runtime.jsx)(QuestionInput,{})]}):(0,jsx_runtime.jsxs)("div",{className:"relative flex flex-col gap-3 px-4 items-center grow justify-center",children:[(0,jsx_runtime.jsx)(Intro,{}),(0,jsx_runtime.jsx)(QuestionInput,{}),(0,jsx_runtime.jsx)(QuestionSuggestions,{})]})]})}},"./frontend/src/scenes/max/maxGlobalLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{V:()=>maxGlobalLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js");let maxGlobalLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","max","maxGlobalLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({acceptDataProcessing:testOnlyOverride=>({testOnlyOverride})}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({dataProcessingAccepted:[!1,{persist:!0},{acceptDataProcessing:(_,_ref)=>{let{testOnlyOverride}=_ref;return null==testOnlyOverride||testOnlyOverride}}]})])},"./frontend/src/scenes/max/maxLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{v:()=>maxLogic});var esm_exports=__webpack_require__("./node_modules/.pnpm/@sentry+core@7.112.1/node_modules/@sentry/core/esm/exports.js");__webpack_require__("./node_modules/.pnpm/d3@7.8.2/node_modules/d3/src/index.js");var __defProp=Object.defineProperty,__defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value,__publicField=(obj,key,value)=>__defNormalProp(obj,"symbol"!=typeof key?key+"":key,value);class ParseError extends Error{constructor(message,options){super(message),__publicField(this,"type"),__publicField(this,"field"),__publicField(this,"value"),__publicField(this,"line"),this.name="ParseError",this.type=options.type,this.field=options.field,this.value=options.value,this.line=options.line}}function noop(_arg){}function createParser(callbacks){let{onEvent=noop,onError=noop,onRetry=noop,onComment}=callbacks,incompleteLine="",isFirstChunk=!0,id,data="",eventType="";function parseLine(line){if(""===line){dispatchEvent();return}if(line.startsWith(":")){onComment&&onComment(line.slice(line.startsWith(": ")?2:1));return}let fieldSeparatorIndex=line.indexOf(":");if(-1!==fieldSeparatorIndex){let field=line.slice(0,fieldSeparatorIndex),offset=" "===line[fieldSeparatorIndex+1]?2:1;processField(field,line.slice(fieldSeparatorIndex+offset),line);return}processField(line,"",line)}function processField(field,value,line){switch(field){case"event":eventType=value;break;case"data":data=`${data}${value}
`;break;case"id":id=value.includes("\0")?void 0:value;break;case"retry":/^\d+$/.test(value)?onRetry(parseInt(value,10)):onError(new ParseError(`Invalid \`retry\` value: "${value}"`,{type:"invalid-retry",value,line}));break;default:onError(new ParseError(`Unknown field "${field.length>20?`${field.slice(0,20)}\u2026`:field}"`,{type:"unknown-field",field,value,line}))}}function dispatchEvent(){data.length>0&&onEvent({id,event:eventType||void 0,data:data.endsWith(`
`)?data.slice(0,-1):data}),id=void 0,data="",eventType=""}return{feed:function feed(newChunk){let chunk=isFirstChunk?newChunk.replace(/^\xEF\xBB\xBF/,""):newChunk,[complete,incomplete]=splitLines(`${incompleteLine}${chunk}`);for(let line of complete)parseLine(line);incompleteLine=incomplete,isFirstChunk=!1},reset:function reset(options={}){incompleteLine&&options.consume&&parseLine(incompleteLine),id=void 0,data="",eventType="",incompleteLine=""}}}function splitLines(chunk){let lines=[],incompleteLine="",totalLength=chunk.length;for(let i=0;i<totalLength;i++){let char=chunk[i];"\r"===char&&chunk[i+1]===`
`?(lines.push(incompleteLine),incompleteLine="",i++):"\r"===char||char===`
`?(lines.push(incompleteLine),incompleteLine=""):incompleteLine+=char}return[lines,incompleteLine]}var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),max_utils=__webpack_require__("./frontend/src/scenes/max/utils.ts"),projectLogic=__webpack_require__("./frontend/src/scenes/projectLogic.ts"),schema_assistant_messages=__webpack_require__("./frontend/src/queries/schema/schema-assistant-messages.ts"),schema_general=__webpack_require__("./frontend/src/queries/schema/schema-general.ts"),maxGlobalLogic=__webpack_require__("./frontend/src/scenes/max/maxGlobalLogic.ts");let FAILURE_MESSAGE={type:schema_assistant_messages.pj.Failure,content:"Oops! It looks like I’m having trouble generating this trends insight. Could you please try again?",status:"completed"},maxLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","max","maxLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{conversationId}=_ref;return conversationId||"new-conversation"}),(0,index_esm.connect)({values:[projectLogic.K,["currentProject"],maxGlobalLogic.V,["dataProcessingAccepted"]]}),(0,index_esm.actions)({askMax:prompt=>({prompt}),setThreadLoaded:function(){let testOnlyOverride=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return{testOnlyOverride}},addMessage:message=>({message}),replaceMessage:(index,message)=>({index,message}),setMessageStatus:(index,status)=>({index,status}),setQuestion:question=>({question}),setVisibleSuggestions:suggestions=>({suggestions}),shuffleVisibleSuggestions:!0,retryLastMessage:!0,scrollThreadToBottom:!0,setConversation:conversation=>({conversation}),setTraceId:traceId=>({traceId})}),(0,index_esm.reducers)({question:["",{setQuestion:(_,_ref2)=>{let{question}=_ref2;return question},askMax:()=>""}],conversation:[(_,props)=>props.conversationId?{id:props.conversationId}:null,{setConversation:(_,_ref3)=>{let{conversation}=_ref3;return conversation}}],threadRaw:[[],{addMessage:(state,_ref4)=>{let{message}=_ref4;return[...state,message]},replaceMessage:(state,_ref5)=>{let{message,index}=_ref5;return[...state.slice(0,index),message,...state.slice(index+1)]},setMessageStatus:(state,_ref6)=>{let{index,status}=_ref6;return[...state.slice(0,index),{...state[index],status},...state.slice(index+1)]}}],threadLoading:[!1,{askMax:()=>!0,setThreadLoaded:(_,_ref7)=>{let{testOnlyOverride}=_ref7;return testOnlyOverride}}],visibleSuggestions:[null,{setVisibleSuggestions:(_,_ref8)=>{let{suggestions}=_ref8;return suggestions}}],traceId:[null,{setTraceId:(_,_ref9)=>{let{traceId}=_ref9;return traceId}}]}),(0,lib.loaders)({allSuggestions:[null,{loadSuggestions:async _ref10=>{let{refresh}=_ref10;return(await api.ZP.query({kind:schema_general.OH.SuggestedQuestionsQuery},void 0,void 0,refresh)).questions}}]}),(0,index_esm.listeners)(_ref11=>{let{actions,values}=_ref11;return{[projectLogic.K.actionTypes.updateCurrentProjectSuccess]:_ref12=>{let{payload}=_ref12;payload?.product_description&&actions.loadSuggestions({refresh:"blocking"})},[projectLogic.K.actionTypes.loadCurrentProjectSuccess]:_ref13=>{let{currentProject}=_ref13;currentProject?.product_description&&actions.loadSuggestions({refresh:"async_except_on_cache_miss"})},loadSuggestionsSuccess:()=>{actions.shuffleVisibleSuggestions()},shuffleVisibleSuggestions:()=>{if(!values.allSuggestions)throw Error("No question suggestions to shuffle");let allSuggestionsWithoutCurrentlyVisible=values.allSuggestions.filter(suggestion=>!values.visibleSuggestions?.includes(suggestion));actions.setVisibleSuggestions(allSuggestionsWithoutCurrentlyVisible.slice(0,3).sort((a,b)=>a.length-b.length))},askMax:async _ref14=>{let{prompt}=_ref14;actions.addMessage({type:schema_assistant_messages.pj.Human,content:prompt,status:"completed"});try{let traceId=(0,utils.Vj)();actions.setTraceId(traceId);let response=await api.ZP.conversations.create({content:prompt,conversation:values.conversation?.id,trace_id:traceId}),reader=response.body?.getReader();if(!reader)return;let decoder=new TextDecoder,parser=createParser({onEvent:_ref15=>{let{data,event}=_ref15;if(event===schema_assistant_messages.KC.Message){let parsedResponse=parseResponse(data);if(!parsedResponse)return;(0,max_utils.Q1)(parsedResponse)?actions.replaceMessage(values.threadRaw.length-1,{...parsedResponse,status:"completed"}):"completed"===values.threadRaw[values.threadRaw.length-1].status?actions.addMessage({...parsedResponse,status:parsedResponse.id?"completed":"loading"}):parsedResponse&&actions.replaceMessage(values.threadRaw.length-1,{...parsedResponse,status:parsedResponse.id?"completed":"loading"})}else if(event===schema_assistant_messages.KC.Status){let parsedResponse=parseResponse(data);if(!parsedResponse)return;parsedResponse.type===schema_assistant_messages.PP.GenerationError&&actions.setMessageStatus(values.threadRaw.length-1,"error")}else if(event===schema_assistant_messages.KC.Conversation){let parsedResponse=parseResponse(data);if(!parsedResponse)return;actions.setConversation(parsedResponse)}}});for(;;){let{done,value}=await reader.read();if(parser.feed(decoder.decode(value)),done)break}}catch(e){let relevantErrorMessage={...FAILURE_MESSAGE,id:(0,utils.Vj)()};e instanceof api.MS&&429===e.status?relevantErrorMessage.content="You've reached my usage limit for now. Please try again later.":(0,esm_exports.Tb)(e),values.threadRaw[values.threadRaw.length-1]?.status==="loading"?actions.replaceMessage(values.threadRaw.length-1,relevantErrorMessage):values.threadRaw[values.threadRaw.length-1]?.status!=="error"&&actions.addMessage(relevantErrorMessage)}actions.setThreadLoaded()},retryLastMessage:()=>{let lastMessage=values.threadRaw.filter(max_utils.Q1).pop();lastMessage&&actions.askMax(lastMessage.content)},addMessage:payload=>{((0,max_utils.Q1)(payload.message)||(0,max_utils.N_)(payload.message))&&actions.scrollThreadToBottom()},replaceMessage:payload=>{(0,max_utils.N_)(payload.message)&&actions.scrollThreadToBottom()},scrollThreadToBottom:()=>{requestAnimationFrame(()=>{let mainEl=document.querySelector("main");mainEl?.scrollTo({top:mainEl?.scrollHeight,behavior:"smooth"})})}}}),(0,index_esm.selectors)({threadGrouped:[s=>[s.threadRaw,s.threadLoading],(thread,threadLoading)=>{let threadGrouped=[];for(let i=0;i<thread.length;i++){let currentMessage=thread[i],previousMessage=thread[i-1];if(currentMessage.type.split("/")[0]===previousMessage?.type.split("/")[0]){let lastThreadSoFar=threadGrouped[threadGrouped.length-1];currentMessage.id&&previousMessage.type===schema_assistant_messages.pj.Reasoning?lastThreadSoFar[lastThreadSoFar.length-1]=currentMessage:lastThreadSoFar.push(currentMessage)}else threadGrouped.push([currentMessage])}if(threadLoading){let finalMessageSoFar=threadGrouped.at(-1)?.at(-1);if(finalMessageSoFar?.type===schema_assistant_messages.pj.Human||finalMessageSoFar?.id){let thinkingMessage={type:schema_assistant_messages.pj.Reasoning,content:"Thinking",status:"completed",id:"loader"};finalMessageSoFar.type===schema_assistant_messages.pj.Human?threadGrouped.push([thinkingMessage]):threadGrouped[threadGrouped.length-1].push(thinkingMessage)}}return threadGrouped}],formPending:[s=>[s.threadRaw],threadRaw=>{let lastMessage=threadRaw[threadRaw.length-1];return!!(lastMessage&&(0,max_utils.Gn)(lastMessage))&&!!lastMessage.meta?.form}],inputDisabled:[s=>[s.formPending],formPending=>formPending],submissionDisabledReason:[s=>[s.formPending,s.dataProcessingAccepted,s.question,s.threadLoading],(formPending,dataProcessingAccepted,question,threadLoading)=>dataProcessingAccepted?formPending?"Please choose one of the options above":question?threadLoading?"Thinking…":void 0:"I need some input first":"Please accept OpenAI processing data"]}),(0,index_esm.afterMount)(_ref16=>{let{actions,values}=_ref16;values.currentProject?.product_description&&actions.loadSuggestions({refresh:"async_except_on_cache_miss"})})]);function parseResponse(response){try{return JSON.parse(response)}catch{return null}}},"./frontend/src/scenes/max/utils.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{DB:()=>isReasoningMessage,Gn:()=>isAssistantMessage,N_:()=>isVisualizationMessage,Q1:()=>isHumanMessage,W$:()=>isFailureMessage,YO:()=>castAssistantQuery});var _queries_schema_schema_assistant_messages__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./frontend/src/queries/schema/schema-assistant-messages.ts"),_queries_utils__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./frontend/src/queries/utils.ts");function isReasoningMessage(message){return message?.type===_queries_schema_schema_assistant_messages__WEBPACK_IMPORTED_MODULE_0__.pj.Reasoning}function isVisualizationMessage(message){return message?.type===_queries_schema_schema_assistant_messages__WEBPACK_IMPORTED_MODULE_0__.pj.Visualization}function isHumanMessage(message){return message?.type===_queries_schema_schema_assistant_messages__WEBPACK_IMPORTED_MODULE_0__.pj.Human}function isAssistantMessage(message){return message?.type===_queries_schema_schema_assistant_messages__WEBPACK_IMPORTED_MODULE_0__.pj.Assistant}function isFailureMessage(message){return message?.type===_queries_schema_schema_assistant_messages__WEBPACK_IMPORTED_MODULE_0__.pj.Failure}function castAssistantTrendsQuery(query){return query}function castAssistantFunnelsQuery(query){return query}function castAssistantRetentionQuery(query){return query}function castAssistantQuery(query){if((0,_queries_utils__WEBPACK_IMPORTED_MODULE_1__.kX)(query))return castAssistantTrendsQuery(query);if((0,_queries_utils__WEBPACK_IMPORTED_MODULE_1__.Wl)(query))return castAssistantFunnelsQuery(query);if((0,_queries_utils__WEBPACK_IMPORTED_MODULE_1__.I5)(query))return castAssistantRetentionQuery(query);throw Error("Unsupported query type")}}}]);
//# sourceMappingURL=scenes-max-Max-stories.187931cc.iframe.bundle.js.map