"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[88838],{"../../products/llm_observability/frontend/LLMObservabilityTraceScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{LLMObservabilityTraceScene:()=>LLMObservabilityTraceScene,renderModelRow:()=>renderModelRow,scene:()=>scene});var classnames=__webpack_require__("../../node_modules/.pnpm/classnames@2.5.1/node_modules/classnames/index.js"),classnames_default=__webpack_require__.n(classnames),clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),index_module=__webpack_require__("../../node_modules/.pnpm/use-debounce@9.0.3_react@18.2.0/node_modules/use-debounce/dist/index.module.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.27.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),JSONViewer=__webpack_require__("../../frontend/src/lib/components/JSONViewer.tsx"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),ViewRecordingButton=__webpack_require__("../../frontend/src/lib/components/ViewRecordingButton/ViewRecordingButton.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),css_classes=__webpack_require__("../../frontend/src/lib/utils/css-classes.ts"),EmptyStates=__webpack_require__("../../frontend/src/scenes/insights/EmptyStates/index.ts"),PersonDisplay=__webpack_require__("../../frontend/src/scenes/persons/PersonDisplay.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),ConversationMessagesDisplay=__webpack_require__("../../products/llm_observability/frontend/ConversationDisplay/ConversationMessagesDisplay.tsx"),LemonRadio=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonRadio/index.ts"),llmObservabilityTraceLogic=__webpack_require__("../../products/llm_observability/frontend/llmObservabilityTraceLogic.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function DisplayOptionsModal(){let{displayOptionsModalVisible,displayOption}=(0,index_esm.useValues)(llmObservabilityTraceLogic.TY),{hideDisplayOptionsModal,setDisplayOption}=(0,index_esm.useActions)(llmObservabilityTraceLogic.TY),displayOptions=[{value:llmObservabilityTraceLogic.zY.ExpandAll,label:"Expand all messages by default"},{value:llmObservabilityTraceLogic.zY.CollapseExceptOutputAndLastInput,label:"Collapse all messages by default, except for the last input message and all output messages"}];return(0,jsx_runtime.jsx)(src.fQ,{isOpen:displayOptionsModalVisible,title:"Display Options",onClose:hideDisplayOptionsModal,footer:(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:hideDisplayOptionsModal,children:"Done"}),children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)("p",{className:"text-muted",children:"Choose how generation conversation messages should be displayed by default:"}),(0,jsx_runtime.jsx)(LemonRadio._,{value:displayOption,onChange:setDisplayOption,options:displayOptions})]})})}var MetadataHeader=__webpack_require__("../../products/llm_observability/frontend/ConversationDisplay/MetadataHeader.tsx");function ParametersHeader(_ref){let{eventProperties}=_ref;return(0,jsx_runtime.jsx)("div",{className:"flex flex-row flex-wrap gap-2",children:eventProperties.$ai_model_parameters&&Object.entries(eventProperties.$ai_model_parameters).map(_ref2=>{let[key,value]=_ref2;return null!==value&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",children:[key,": ",`${value}`]},key)})})}var LLMInputOutput=__webpack_require__("../../products/llm_observability/frontend/LLMInputOutput.tsx"),SearchHighlight=__webpack_require__("../../products/llm_observability/frontend/SearchHighlight.tsx"),CopyToClipboard=__webpack_require__("../../frontend/src/lib/components/CopyToClipboard.tsx");function FeedbackTag(_ref){let{properties}=_ref,{$ai_feedback_text:feedbackText}=properties,feedbackPreview="string"==typeof feedbackText?feedbackText.slice(0,5):"",text=feedbackText||"No feedback provided";return(0,jsx_runtime.jsx)(src.oe,{className:"bg-surface-primary cursor-default",children:(0,jsx_runtime.jsx)(CopyToClipboard.D,{iconSize:"xsmall",description:"user feedback",tooltipMessage:text,explicitValue:String(feedbackText),children:`User feedback${feedbackPreview?`: ${feedbackPreview}...`:""}`})})}function MetricTag(_ref){let{properties}=_ref,{$ai_metric_name:metricName,$ai_metric_value:metricValue}=properties,strValue=String(metricValue),isValueLong=strValue.length>10,name=metricName?(0,utils.UV)(metricName):"Metric",value=isValueLong?`${strValue.slice(0,10)}...`:strValue,title=`${name}: ${value}`,description=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[metricName&&(0,jsx_runtime.jsxs)("span",{children:["Metric: ",metricName,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("br",{})]}),metricValue,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("span",{children:"Click to copy the value"})]});return(0,jsx_runtime.jsx)(src.oe,{className:"bg-surface-primary cursor-default",children:(0,jsx_runtime.jsx)(CopyToClipboard.D,{iconSize:"xsmall",description:"metric",explicitValue:strValue,tooltipMessage:isValueLong?description:"Click to copy the value",children:title})})}var llmObservabilityPlaygroundLogic=__webpack_require__("../../products/llm_observability/frontend/llmObservabilityPlaygroundLogic.ts"),dataNodeLogic=__webpack_require__("../../frontend/src/queries/nodes/DataNode/dataNodeLogic.ts"),InsightViz=__webpack_require__("../../frontend/src/queries/nodes/InsightViz/InsightViz.tsx"),searchUtils=__webpack_require__("../../products/llm_observability/frontend/searchUtils.ts"),frontend_utils=__webpack_require__("../../products/llm_observability/frontend/utils.ts");function getDataNodeLogicProps(_ref){let{traceId,query,cachedResults}=_ref,insightProps={dashboardItemId:`new-Trace.${traceId}`,dataNodeCollectionId:traceId},vizKey=(0,InsightViz.gG)(insightProps);return{query:query.source,key:vizKey,dataNodeCollectionId:traceId,cachedResults:cachedResults||void 0}}let FEEDBACK_EVENTS=new Set(["$ai_feedback","$ai_metric"]),llmObservabilityTraceDataLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","llm-observability","llmObservabilityTraceLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(props=>({values:[llmObservabilityTraceLogic.TY,["eventId","searchQuery"],(0,dataNodeLogic.M)(getDataNodeLogicProps(props)),["response","responseLoading","responseError"]]})),(0,index_esm.selectors)({trace:[s=>[s.response],response=>response?.results?.[0]],showableEvents:[s=>[s.trace],trace=>trace?trace.events.filter(event=>!FEEDBACK_EVENTS.has(event.event)):[]],filteredEvents:[s=>[s.showableEvents,s.searchQuery],(showableEvents,searchQuery)=>searchQuery.trim()?showableEvents.filter(event=>(0,searchUtils.jo)(event,searchQuery)):showableEvents],filteredTree:[(s,p)=>[p.traceId,s.trace,s.searchQuery,s.filteredEvents],(traceId,trace,searchQuery,filteredEvents)=>searchQuery.trim()?restoreTree(filteredEvents,traceId):restoreTree(trace?.events||[],traceId)],mostRelevantEvent:[s=>[s.filteredEvents,s.searchQuery],(filteredEvents,searchQuery)=>{if(!searchQuery.trim()||!filteredEvents.length)return null;let query=searchQuery.toLowerCase().trim(),best=filteredEvents.map(event=>{let score=0;return"$ai_generation"===event.event&&(score+=10),(event.properties.$ai_span_name||event.event||"").toLowerCase().includes(query)&&(score+=5),(event.properties.$ai_model||"").toLowerCase().includes(query)&&(score+=3),JSON.stringify(event.properties.$ai_input||event.properties.$ai_input_state||"").toLowerCase().includes(query)&&(score+=2),JSON.stringify(event.properties.$ai_output||event.properties.$ai_output_choices||event.properties.$ai_output_state||"").toLowerCase().includes(query)&&(score+=2),{event,score}}).sort((a,b)=>b.score-a.score)[0];return best?.event||null}],searchOccurrences:[s=>[s.showableEvents,s.searchQuery,s.trace],(showableEvents,searchQuery,trace)=>{if(!searchQuery.trim())return[];let query=searchQuery.toLowerCase().trim(),traceOccurrences=(0,searchUtils.ll)(trace,query);return[...traceOccurrences,...(0,searchUtils.Pi)(showableEvents,query),...(0,searchUtils.zl)(showableEvents,query,frontend_utils.VL)]}],metricEvents:[s=>[s.trace],trace=>trace?.events.filter(event=>"$ai_metric"===event.event&&event.properties.$ai_metric_value)],feedbackEvents:[s=>[s.trace],trace=>trace?.events.filter(event=>"$ai_feedback"===event.event&&event.properties.$ai_feedback_text)],metricsAndFeedbackEvents:[s=>[s.metricEvents,s.feedbackEvents],(metricEvents,feedbackEvents)=>[...null!=metricEvents?metricEvents:[],...null!=feedbackEvents?feedbackEvents:[]].map(event=>{var _event$properties$$ai,_event$properties$$ai2;return{metric:"$ai_metric"===event.event?null!==(_event$properties$$ai=event.properties.$ai_metric_name)&&void 0!==_event$properties$$ai?_event$properties$$ai:"Metric":"User feedback",value:null!==(_event$properties$$ai2=event.properties.$ai_metric_value)&&void 0!==_event$properties$$ai2?_event$properties$$ai2:event.properties.$ai_feedback_text}})],event:[(s,p)=>[p.traceId,s.eventId,s.trace,s.showableEvents],(traceId,eventId,trace,showableEvents)=>eventId&&eventId!==traceId?showableEvents?.length&&showableEvents.find(event=>event.id===eventId)||null:trace||null],tree:[s=>[s.filteredTree],filteredTree=>filteredTree],enrichedTree:[s=>[s.filteredTree],filteredTree=>filteredTree.map(enrichNode)]})]);function extractTotalCost(event){return event.properties.$ai_total_cost_usd||0}function extractLatency(event){return event.properties.$ai_latency||0}function enrichNode(node){var _node$aggregation$tot,_node$aggregation$tot2;return{...node,children:node.children?.map(enrichNode),displayTotalCost:null!==(_node$aggregation$tot=node.aggregation?.totalCost)&&void 0!==_node$aggregation$tot?_node$aggregation$tot:extractTotalCost(node.event),displayLatency:null!==(_node$aggregation$tot2=node.aggregation?.totalLatency)&&void 0!==_node$aggregation$tot2?_node$aggregation$tot2:extractLatency(node.event),displayUsage:node.aggregation?(0,frontend_utils.Pz)(node.aggregation):(0,frontend_utils.Pz)(node.event)}}function aggregateSpanMetrics(node){var _event$properties$$ai3,_event$properties$$ai4,_event$properties$$ai5,_event$properties$$ai6;let event=node.event,hasGenerationChildren=!1,totalCost=null!==(_event$properties$$ai3=event.properties.$ai_total_cost_usd)&&void 0!==_event$properties$$ai3?_event$properties$$ai3:0,totalLatency=null!==(_event$properties$$ai4=event.properties.$ai_latency)&&void 0!==_event$properties$$ai4?_event$properties$$ai4:0,inputTokens=null!==(_event$properties$$ai5=event.properties.$ai_input_tokens)&&void 0!==_event$properties$$ai5?_event$properties$$ai5:0,outputTokens=null!==(_event$properties$$ai6=event.properties.$ai_output_tokens)&&void 0!==_event$properties$$ai6?_event$properties$$ai6:0,shouldAggregateCost=void 0===event.properties.$ai_total_cost_usd,shouldAggregateLatency=void 0===event.properties.$ai_latency,shouldAggregateInputTokens=void 0===event.properties.$ai_input_tokens,shouldAggregateOutputTokens=void 0===event.properties.$ai_output_tokens;if(node.children&&node.children.length>0)for(let child of node.children)if("$ai_generation"===child.event.event&&(hasGenerationChildren=!0),child.children&&child.children.length>0){let childAgg=aggregateSpanMetrics(child);shouldAggregateCost&&(totalCost+=childAgg.totalCost),shouldAggregateLatency&&(totalLatency+=childAgg.totalLatency),shouldAggregateInputTokens&&(inputTokens+=childAgg.inputTokens),shouldAggregateOutputTokens&&(outputTokens+=childAgg.outputTokens),childAgg.hasGenerationChildren&&(hasGenerationChildren=!0)}else shouldAggregateCost&&(totalCost+=child.event.properties.$ai_total_cost_usd||0),shouldAggregateLatency&&(totalLatency+=child.event.properties.$ai_latency||0),shouldAggregateInputTokens&&(inputTokens+=child.event.properties.$ai_input_tokens||0),shouldAggregateOutputTokens&&(outputTokens+=child.event.properties.$ai_output_tokens||0);return{totalCost,totalLatency,inputTokens,outputTokens,hasGenerationChildren}}function restoreTree(events,traceId){let childrenMap=new Map,idMap=new Map,visitedNodes=new Set;for(let event of events){var _ref2,_event$properties$$ai7,_event$properties$$ai8;if(FEEDBACK_EVENTS.has(event.event))continue;let eventId=null!==(_ref2=null!==(_event$properties$$ai7=event.properties.$ai_generation_id)&&void 0!==_event$properties$$ai7?_event$properties$$ai7:event.properties.$ai_span_id)&&void 0!==_ref2?_ref2:event.id;idMap.set(eventId,event);let parentId=null!==(_event$properties$$ai8=event.properties.$ai_parent_id)&&void 0!==_event$properties$$ai8?_event$properties$$ai8:event.properties.$ai_trace_id;if(null!=parentId){let existingEvents=childrenMap.get(parentId);existingEvents?existingEvents.push(eventId):childrenMap.set(parentId,[eventId])}}function traverse(spanId){if(visitedNodes.has(spanId))return console.warn("Circular reference detected in trace tree:",spanId),null;let event=idMap.get(spanId);if(!event)return null;visitedNodes.add(spanId);let children=childrenMap.get(spanId),result={event,children:children?.map(child=>traverse(child)).filter(node=>null!==node)};return result.children&&result.children.length>0&&"$ai_generation"!==event.event&&(result.aggregation=aggregateSpanMetrics(result)),visitedNodes.delete(spanId),result}return(childrenMap.get(traceId)||[]).map(childId=>traverse(childId)).filter(node=>null!==node)}var copyToClipboard=__webpack_require__("../../frontend/src/lib/utils/copyToClipboard.tsx");function buildEventExport(event,children){let isGeneration="$ai_generation"===event.event,result={type:isGeneration?"generation":"span",name:(0,frontend_utils.hG)(event)};if(isGeneration&&(event.properties.$ai_model&&(result.model=event.properties.$ai_model),event.properties.$ai_provider&&(result.provider=event.properties.$ai_provider)),isGeneration){var _event$properties$$ai;let inputMessages=(0,frontend_utils.VL)(event.properties.$ai_input,"user"),outputMessages=(0,frontend_utils.VL)(null!==(_event$properties$$ai=event.properties.$ai_output_choices)&&void 0!==_event$properties$$ai?_event$properties$$ai:event.properties.$ai_output,"assistant"),messages=[];inputMessages.length>0&&messages.push(...inputMessages),outputMessages.length>0&&messages.push(...outputMessages),messages.length>0&&(result.messages=messages),event.properties.$ai_tools&&(result.available_tools=event.properties.$ai_tools)}else void 0!==event.properties.$ai_input_state&&(result.input=event.properties.$ai_input_state),void 0!==event.properties.$ai_output_state&&(result.output=event.properties.$ai_output_state);event.properties.$ai_error?result.error=event.properties.$ai_error:event.properties.$ai_is_error&&(result.error="Error occurred (details not available)");let metrics={};return event.properties.$ai_latency&&(metrics.latency=event.properties.$ai_latency),(event.properties.$ai_input_tokens||event.properties.$ai_output_tokens)&&(metrics.tokens={input:event.properties.$ai_input_tokens||0,output:event.properties.$ai_output_tokens||0}),event.properties.$ai_total_cost_usd&&(metrics.cost=event.properties.$ai_total_cost_usd),Object.keys(metrics).length>0&&(result.metrics=metrics),children&&children.length>0&&(result.children=children.map(child=>buildEventExport(child.event,child.children))),result}function buildMinimalTraceJSON(trace,tree){let result={trace_id:trace.id,timestamp:trace.createdAt,total_tokens:{input:trace.inputTokens||0,output:trace.outputTokens||0},events:tree.map(node=>buildEventExport(node.event,node.children))};return trace.traceName&&(result.name=trace.traceName),trace.totalCost&&(result.total_cost=trace.totalCost),result}async function exportTraceToClipboard(trace,tree){let jsonString=JSON.stringify(buildMinimalTraceJSON(trace,tree),null,2);await (0,copyToClipboard.v)(jsonString,"trace data")}let scene={component:LLMObservabilityTraceScene,logic:llmObservabilityTraceLogic.TY};function LLMObservabilityTraceScene(){let{traceId,query}=(0,index_esm.useValues)(llmObservabilityTraceLogic.TY);return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:llmObservabilityTraceDataLogic,props:{traceId,query},children:(0,jsx_runtime.jsx)(TraceSceneWrapper,{})})}function TraceSceneWrapper(){let{eventId}=(0,index_esm.useValues)(llmObservabilityTraceLogic.TY),{enrichedTree,trace,event,responseLoading,responseError,feedbackEvents,metricEvents,searchQuery}=(0,index_esm.useValues)(llmObservabilityTraceDataLogic);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:responseLoading?(0,jsx_runtime.jsx)(src.t2,{}):responseError?(0,jsx_runtime.jsx)(EmptyStates.jC,{}):trace?(0,jsx_runtime.jsxs)("div",{className:"relative deprecated-space-y-4 flex flex-col",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-start justify-between",children:[(0,jsx_runtime.jsx)(TraceMetadata,{trace:trace,metricEvents:metricEvents,feedbackEvents:feedbackEvents}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(CopyTraceButton,{trace:trace,tree:enrichedTree}),(0,jsx_runtime.jsx)(DisplayOptionsButton,{})]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 min-h-0 gap-4 flex-col md:flex-row",children:[(0,jsx_runtime.jsx)(TraceSidebar,{trace:trace,eventId:eventId,tree:enrichedTree}),(0,jsx_runtime.jsx)(EventContent,{event:event,tree:enrichedTree,searchQuery:searchQuery})]})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"trace"})})}function Chip(_ref){let{title,children,icon}=_ref;return(0,jsx_runtime.jsx)(src.u,{title:title,children:(0,jsx_runtime.jsxs)(src.oe,{size:"medium",className:"bg-surface-primary",icon:icon,children:[(0,jsx_runtime.jsx)("span",{className:"sr-only",children:title}),children]})})}function UsageChip(_ref2){let{event}=_ref2,usage=(0,frontend_utils.Pz)(event);return usage?(0,jsx_runtime.jsx)(Chip,{title:"Usage",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconAIText,{}),children:usage}):null}function TraceMetadata(_ref3){let{trace,metricEvents,feedbackEvents}=_ref3;return(0,jsx_runtime.jsxs)("header",{className:"flex gap-2 flex-wrap",children:["person"in trace&&(0,jsx_runtime.jsx)(Chip,{title:"Person",children:(0,jsx_runtime.jsx)(PersonDisplay.I,{withIcon:"sm",person:trace.person})}),(0,jsx_runtime.jsx)(UsageChip,{event:trace}),"number"==typeof trace.inputCost&&(0,jsx_runtime.jsx)(Chip,{title:"Input cost",icon:(0,jsx_runtime.jsx)(icons.Cz,{}),children:(0,frontend_utils.K7)(trace.inputCost)}),"number"==typeof trace.outputCost&&(0,jsx_runtime.jsx)(Chip,{title:"Output cost",icon:(0,jsx_runtime.jsx)(icons.BD,{}),children:(0,frontend_utils.K7)(trace.outputCost)}),"number"==typeof trace.totalCost&&(0,jsx_runtime.jsx)(Chip,{title:"Total cost",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconReceipt,{}),children:(0,frontend_utils.K7)(trace.totalCost)}),metricEvents.map(metric=>(0,jsx_runtime.jsx)(MetricTag,{properties:metric.properties},metric.id)),feedbackEvents.map(feedback=>(0,jsx_runtime.jsx)(FeedbackTag,{properties:feedback.properties},feedback.id))]})}function TraceSidebar(_ref4){let{trace,eventId,tree}=_ref4,ref=(0,react.useRef)(null),{mostRelevantEvent,searchOccurrences}=(0,index_esm.useValues)(llmObservabilityTraceDataLogic),{searchQuery}=(0,index_esm.useValues)(llmObservabilityTraceLogic.TY),{setSearchQuery,setEventId}=(0,index_esm.useActions)(llmObservabilityTraceLogic.TY),[searchValue,setSearchValue]=(0,react.useState)(searchQuery);(0,react.useEffect)(()=>{setSearchValue(searchQuery)},[searchQuery]);let debouncedSetSearchQuery=(0,index_module.y1)(value=>{setSearchQuery(value)},300);return(0,react.useEffect)(()=>{if(eventId&&ref.current){let selectedNode=ref.current.querySelector("[aria-current=true]");selectedNode&&selectedNode.scrollIntoView({block:"center"})}},[eventId]),(0,react.useEffect)(()=>{mostRelevantEvent&&searchQuery.trim()&&setEventId(mostRelevantEvent.id)},[mostRelevantEvent,searchQuery,setEventId]),(0,jsx_runtime.jsxs)("aside",{className:"sticky bottom-[var(--scene-padding)] border-primary max-h-fit bg-surface-primary border rounded overflow-hidden flex flex-col w-full md:w-80",ref:ref,children:[(0,jsx_runtime.jsx)("h3",{className:"font-medium text-sm px-2 my-2",children:"Tree"}),(0,jsx_runtime.jsx)(src.p2,{className:"m-0"}),(0,jsx_runtime.jsxs)("div",{className:"p-2",children:[(0,jsx_runtime.jsx)(src.DF,{placeholder:"Search trace...",prefix:(0,jsx_runtime.jsx)(posthog_icons_es.IconSearch,{}),value:searchValue,onChange:value=>{setSearchValue(value),debouncedSetSearchQuery(value)},size:"small"}),searchValue.trim()&&(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted ml-1 mt-1",children:searchOccurrences.length>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[searchOccurrences.length," ",1===searchOccurrences.length?"occurrence":"occurrences"]}):"No occurrences"})]}),(0,jsx_runtime.jsxs)("ul",{className:"overflow-y-auto p-1 *:first:mt-0 overflow-x-hidden",children:[(0,jsx_runtime.jsx)(TreeNode,{topLevelTrace:trace,node:{event:trace,displayTotalCost:trace.totalCost||0,displayLatency:trace.totalLatency||0,displayUsage:(0,frontend_utils.Pz)(trace)},isSelected:!eventId||eventId===trace.id,searchQuery:searchQuery}),(0,jsx_runtime.jsx)(TreeNodeChildren,{tree:tree,trace:trace,selectedEventId:eventId,searchQuery:searchQuery})]})]})}function NestingGroup(_ref5){let{onToggle,isCollapsed,children}=_ref5;return(0,jsx_runtime.jsxs)("li",{className:(0,clsx_m.default)("flex items-stretch min-w-0",isCollapsed&&"text-border hover:text-muted"),children:[(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("mb-1 ml-1 cursor-pointer",!isCollapsed&&"text-border hover:text-muted"),onClick:onToggle,children:(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("w-0 h-full my-0 ml-1 mr-2 border-l border-current",isCollapsed&&"border-dashed")})}),(0,jsx_runtime.jsx)("ul",{className:"flex-1 min-w-0",children:children})]})}let TreeNode=react.memo(function TraceNode(_ref6){let{topLevelTrace,node,isSelected,searchQuery}=_ref6,totalCost=node.displayTotalCost,latency=node.displayLatency,usage=node.displayUsage,item=node.event,children=[(0,frontend_utils.A_)(item)&&item.properties.$ai_is_error&&(0,jsx_runtime.jsx)(src.oe,{type:"danger",children:"Error"},"error-tag"),latency>=.01&&(0,jsx_runtime.jsx)(src.oe,{type:"muted",children:(0,frontend_utils.DB)(latency)},"latency-tag"),(null!=usage||null!=totalCost)&&(0,jsx_runtime.jsxs)("span",{children:[usage,null!=usage&&null!=totalCost&&(0,jsx_runtime.jsx)("span",{children:" / "}),null!=totalCost&&(0,frontend_utils.K7)(totalCost)]},"usage-tag")],hasChildren=children.some(child=>!!child);return(0,jsx_runtime.jsx)("li",{className:"mt-0.5","aria-current":isSelected,children:(0,jsx_runtime.jsxs)(src.rU,{to:urls.j.llmObservabilityTrace(topLevelTrace.id,{event:item.id,timestamp:(0,frontend_utils.sl)(topLevelTrace.createdAt),...searchQuery?.trim()&&{search:searchQuery}}),className:classnames_default()("flex flex-col gap-1 p-1 text-xs rounded min-h-8 justify-center hover:!bg-accent-highlight-secondary",isSelected&&"!bg-accent-highlight-secondary"),children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row items-center gap-1.5",children:[(0,jsx_runtime.jsx)(EventTypeTag,{event:item,size:"small"}),(0,jsx_runtime.jsx)(src.u,{title:(0,frontend_utils.hG)(item),children:searchQuery?.trim()?(0,jsx_runtime.jsx)(SearchHighlight.t,{string:(0,frontend_utils.hG)(item),substring:searchQuery,className:"flex-1"}):(0,jsx_runtime.jsx)("span",{className:"flex-1 truncate",children:(0,frontend_utils.hG)(item)})})]}),renderModelRow(item,searchQuery),hasChildren&&(0,jsx_runtime.jsx)("div",{className:"flex flex-row flex-wrap text-secondary items-center gap-1.5",children:children})]})},item.id)});function renderModelRow(event,searchQuery){if((0,frontend_utils.A_)(event)&&"$ai_generation"===event.event){if(!event.properties.$ai_span_name)return null;let model=event.properties.$ai_model;return event.properties.$ai_provider&&(model=`${model} (${event.properties.$ai_provider})`),searchQuery?.trim()?(0,jsx_runtime.jsx)(SearchHighlight.t,{string:model,substring:searchQuery,className:"flex-1"}):(0,jsx_runtime.jsxs)("span",{className:"flex-1 truncate",children:[" ",model," "]})}return null}function TreeNodeChildren(_ref7){let{tree,trace,selectedEventId,searchQuery}=_ref7,[isCollapsed,setIsCollapsed]=(0,react.useState)(!1);return(0,jsx_runtime.jsx)(NestingGroup,{isCollapsed:isCollapsed,onToggle:()=>setIsCollapsed(!isCollapsed),children:isCollapsed?(0,jsx_runtime.jsxs)("div",{className:"text-secondary hover:text-default text-xxs cursor-pointer p-1",onClick:()=>setIsCollapsed(!1),children:["Show ",(0,utils.Zi)(tree.length,"collapsed child","collapsed children")]}):tree.map(node=>(0,jsx_runtime.jsxs)(react.Fragment,{children:[(0,jsx_runtime.jsx)(TreeNode,{topLevelTrace:trace,node:node,isSelected:!!selectedEventId&&selectedEventId===node.event.id,searchQuery:searchQuery}),node.children&&(0,jsx_runtime.jsx)(TreeNodeChildren,{tree:node.children,trace:trace,selectedEventId:selectedEventId,searchQuery:searchQuery})]},node.event.id))})}function EventContentDisplay(_ref8){let{input,output,raisedError}=_ref8;return input||output?(0,jsx_runtime.jsx)(LLMInputOutput.D,{inputDisplay:(0,jsx_runtime.jsx)("div",{className:"p-2 text-xs border rounded bg-[var(--color-bg-fill-secondary)]",children:(0,utils.Kn)(input)?(0,jsx_runtime.jsx)(JSONViewer.C,{src:input,collapsed:4}):(0,jsx_runtime.jsx)("span",{className:"font-mono",children:JSON.stringify(null!=input?input:null)})}),outputDisplay:(0,jsx_runtime.jsx)("div",{className:(0,css_classes.cn)("p-2 text-xs border rounded",raisedError?"bg-[var(--color-bg-fill-error-tertiary)]":"bg-[var(--color-bg-fill-success-tertiary)]"),children:(0,utils.Kn)(output)?(0,jsx_runtime.jsx)(JSONViewer.C,{src:output,collapsed:4}):(0,jsx_runtime.jsx)("span",{className:"font-mono",children:JSON.stringify(null!=output?output:null)})})}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})}function findNodeForEvent(tree,eventId){for(let node of tree){if(node.event.id===eventId)return node;if(node.children){let result=findNodeForEvent(node.children,eventId);if(result)return result}}return null}let EventContent=react.memo(_ref9=>{var _event$properties$$ai2,_event$properties$$ai3;let{event,tree,searchQuery}=_ref9,{setupPlaygroundFromEvent}=(0,index_esm.useActions)(llmObservabilityPlaygroundLogic.x),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.featureFlagLogic),[viewMode,setViewMode]=(0,react.useState)("conversation"),node=event&&(0,frontend_utils.A_)(event)?findNodeForEvent(tree,event.id):null,aggregation=node?.aggregation||null,showPlaygroundButton=event&&(0,frontend_utils.A_)(event)&&"$ai_generation"===event.event&&featureFlags[constants.y8.LLM_OBSERVABILITY_PLAYGROUND];return(0,jsx_runtime.jsx)("div",{className:"flex-1 bg-surface-primary max-h-fit border rounded flex flex-col border-primary p-4 overflow-y-auto",children:event?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("header",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-row flex items-center gap-2",children:[(0,jsx_runtime.jsx)(EventTypeTag,{event:event}),(0,jsx_runtime.jsx)("h3",{className:"text-lg font-semibold p-0 m-0 truncate flex-1",children:(0,frontend_utils.hG)(event)})]}),(0,frontend_utils.A_)(event)?(0,jsx_runtime.jsx)(MetadataHeader.I,{isError:event.properties.$ai_is_error,inputTokens:event.properties.$ai_input_tokens,outputTokens:event.properties.$ai_output_tokens,cacheReadTokens:event.properties.$ai_cache_read_input_tokens,cacheWriteTokens:event.properties.$ai_cache_creation_input_tokens,totalCostUsd:event.properties.$ai_total_cost_usd,model:event.properties.$ai_model,latency:event.properties.$ai_latency}):(0,jsx_runtime.jsx)(MetadataHeader.I,{inputTokens:event.inputTokens,outputTokens:event.outputTokens,totalCostUsd:event.totalCost,latency:event.totalLatency}),(0,frontend_utils.A_)(event)&&(0,jsx_runtime.jsx)(ParametersHeader,{eventProperties:event.properties}),aggregation&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-row flex-wrap items-center gap-2",children:[aggregation.totalCost>0&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",size:"small",children:["Total Cost: ",(0,frontend_utils.K7)(aggregation.totalCost)]}),aggregation.totalLatency>0&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",size:"small",children:["Total Latency: ",(0,frontend_utils.DB)(aggregation.totalLatency)]}),(aggregation.inputTokens>0||aggregation.outputTokens>0)&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",size:"small",children:["Tokens: ",aggregation.inputTokens," → ",aggregation.outputTokens," (∑"," ",aggregation.inputTokens+aggregation.outputTokens,")"]})]}),(showPlaygroundButton||(0,frontend_utils.W$)(event))&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-row items-center gap-2",children:[showPlaygroundButton&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconChat,{}),onClick:()=>{let model,input,tools;if(event){if((0,frontend_utils.A_)(event)){var _event$properties$$ai;model=event.properties.$ai_model,input=null!==(_event$properties$$ai=event.properties.$ai_input)&&void 0!==_event$properties$$ai?_event$properties$$ai:event.properties.$ai_input_state,tools=event.properties.$ai_tools}setupPlaygroundFromEvent({model,input,tools})}},tooltip:"Try this prompt in the playground",children:"Try in Playground"}),(0,frontend_utils.W$)(event)&&(0,jsx_runtime.jsx)(ViewRecordingButton.Z,{inModal:!0,type:"secondary",size:"xsmall","data-attr":"llm-observability",sessionId:(0,frontend_utils.mL)(event)||void 0,timestamp:(0,frontend_utils.sl)(event.createdAt)})]})]}),(0,jsx_runtime.jsx)(src.TP,{activeKey:viewMode,onChange:setViewMode,tabs:[{key:"conversation",label:"Conversation",content:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,frontend_utils.A_)(event)?"$ai_generation"===event.event?(0,jsx_runtime.jsx)(ConversationMessagesDisplay.F4,{inputNormalized:(0,frontend_utils.VL)(event.properties.$ai_input,"user",event.properties.$ai_tools),outputNormalized:(0,frontend_utils.VL)(null!==(_event$properties$$ai2=event.properties.$ai_output_choices)&&void 0!==_event$properties$$ai2?_event$properties$$ai2:event.properties.$ai_output,"assistant"),errorData:event.properties.$ai_error,httpStatus:event.properties.$ai_http_status,raisedError:event.properties.$ai_is_error,searchQuery:searchQuery}):"$ai_embedding"===event.event?(0,jsx_runtime.jsx)(EventContentDisplay,{input:event.properties.$ai_input,output:"Embedding vector generated"}):(0,jsx_runtime.jsx)(EventContentDisplay,{input:event.properties.$ai_input_state,output:null!==(_event$properties$$ai3=event.properties.$ai_output_state)&&void 0!==_event$properties$$ai3?_event$properties$$ai3:event.properties.$ai_error,raisedError:event.properties.$ai_is_error}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(TraceMetricsTable,{}),(0,jsx_runtime.jsx)(EventContentDisplay,{input:event.inputState,output:event.outputState})]})})},{key:"raw",label:"Raw",content:(0,jsx_runtime.jsx)("div",{className:"p-2",children:(0,jsx_runtime.jsx)(JSONViewer.C,{src:event,collapsed:2})})}]}),(0,jsx_runtime.jsx)(DisplayOptionsModal,{})]}):(0,jsx_runtime.jsx)(EmptyStates.dV,{heading:"Event not found",detail:"Check if the event ID is correct."})})});function EventTypeTag(_ref10){let{event,size}=_ref10,eventType="trace",tagType="completion";if((0,frontend_utils.A_)(event))switch(event.event){case"$ai_generation":eventType="generation",tagType="success";break;case"$ai_embedding":eventType="embedding",tagType="warning";break;default:eventType="span",tagType="default"}return(0,jsx_runtime.jsx)(src.oe,{className:"uppercase",type:tagType,size:size,children:eventType})}function CopyTraceButton(_ref11){let{trace,tree}=_ref11,handleCopyTrace=async()=>{await exportTraceToClipboard(trace,tree)};return(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconCopy,{}),onClick:handleCopyTrace,tooltip:"Copy trace to clipboard",children:"Copy Trace"})}function DisplayOptionsButton(){let{showDisplayOptionsModal}=(0,index_esm.useActions)(llmObservabilityTraceLogic.TY);return(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGear,{}),onClick:showDisplayOptionsModal,tooltip:"Configure how generation conversation messages are displayed",children:"Display Options"})}function TraceMetricsTable(){let{metricsAndFeedbackEvents}=(0,index_esm.useValues)(llmObservabilityTraceDataLogic);return metricsAndFeedbackEvents?.length?(0,jsx_runtime.jsxs)("div",{className:"mb-3",children:[(0,jsx_runtime.jsxs)("h4",{className:"flex items-center gap-x-1.5 text-xs font-semibold mb-2",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconMessage,{className:"text-base"}),"Metrics and user feedback"]}),(0,jsx_runtime.jsx)(src.g3,{columns:[{title:"Metric",key:"metric",render:(_,_ref12)=>{let{metric}=_ref12;return(0,jsx_runtime.jsx)("span",{children:(0,utils.UV)(metric)})},width:"40%"},{title:"Value",key:"value",render:(_,_ref13)=>{let{value}=_ref13;return(0,jsx_runtime.jsx)("span",{children:null!=value?value:"–"})},width:"60%"}],dataSource:metricsAndFeedbackEvents})]}):null}EventContent.displayName="EventContent"}}]);