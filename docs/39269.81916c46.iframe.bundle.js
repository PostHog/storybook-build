"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[39269],{"../../frontend/src/scenes/sessions/SessionProfileScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{SessionProfileScene:()=>SessionProfileScene,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.35.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),CopyToClipboard=__webpack_require__("../../frontend/src/lib/components/CopyToClipboard.tsx"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),ViewRecordingButton=__webpack_require__("../../frontend/src/lib/components/ViewRecordingButton/ViewRecordingButton.tsx"),Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/Spinner.tsx"),PersonDisplay=__webpack_require__("../../frontend/src/scenes/persons/PersonDisplay.tsx"),sceneTypes=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts"),scenes=__webpack_require__("../../frontend/src/scenes/scenes.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),SceneContent=__webpack_require__("../../frontend/src/layout/scenes/components/SceneContent.tsx"),SceneDivider=__webpack_require__("../../frontend/src/layout/scenes/components/SceneDivider.tsx"),SceneTitleSection=__webpack_require__("../../frontend/src/layout/scenes/components/SceneTitleSection.tsx"),types=__webpack_require__("../../frontend/src/types.ts"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),utils=__webpack_require__("../../frontend/src/queries/utils.ts");let sessionProfileLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","sessions","sessionProfileLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(props=>props.sessionId),(0,index_esm.actions)({loadSessionData:!0,loadSessionEvents:!0,loadMoreSessionEvents:!0,loadEventDetails:(eventId,eventName)=>({eventId,eventName}),setHasMoreEvents:hasMore=>({hasMore}),updateEventsOffset:offset=>({offset}),loadTotalEventCount:!0,setSortOrder:sortOrder=>({sortOrder}),loadRecordingAvailability:!0,setEventsListFolded:isFolded=>({isFolded}),loadSupportTicketEvents:!0}),(0,index_esm.reducers)({hasMoreEvents:[!0,{loadSessionEventsSuccess:(_,_ref)=>{let{sessionEvents}=_ref;return 50===sessionEvents.length},setHasMoreEvents:(_,_ref2)=>{let{hasMore}=_ref2;return hasMore}}],eventsOffset:[0,{loadSessionEventsSuccess:(_,_ref3)=>{let{sessionEvents}=_ref3;return sessionEvents.length},loadMoreSessionEvents:state=>state,updateEventsOffset:(_,_ref4)=>{let{offset}=_ref4;return offset},setSortOrder:()=>0}],sortOrder:["asc",{setSortOrder:(_,_ref5)=>{let{sortOrder}=_ref5;return sortOrder}}],eventsListFolded:[!1,{setEventsListFolded:(_,_ref6)=>{let{isFolded}=_ref6;return isFolded}}]}),(0,lib.loaders)(_ref7=>{let{props,values}=_ref7;return{sessionData:[null,{loadSessionData:async()=>{let sessionQuery=(0,utils.zP)`
                        SELECT
                            session_id,
                            distinct_id,
                            $start_timestamp,
                            $end_timestamp,
                            $entry_current_url,
                            $end_current_url,
                            $urls,
                            $num_uniq_urls,
                            $pageview_count,
                            $autocapture_count,
                            $screen_count,
                            $session_duration,
                            $channel_type,
                            $is_bounce,
                            $entry_hostname,
                            $entry_pathname,
                            $entry_utm_source,
                            $entry_utm_campaign,
                            $entry_utm_medium,
                            $entry_referring_domain,
                            $last_external_click_url
                        FROM sessions
                        WHERE $start_timestamp >= UUIDv7ToDateTime(toUUID(${props.sessionId}))
                            AND $start_timestamp <= UUIDv7ToDateTime(toUUID(${props.sessionId})) + INTERVAL 1 HOUR
                            AND session_id = ${props.sessionId}
                        LIMIT 1
                    `,response=await api.ZP.queryHogQL(sessionQuery),row=response.results?.[0];if(!row)return null;let distinct_id=row[1],person_properties=null;if(distinct_id&&"$posthog_cookieless"!==distinct_id)try{let personQuery=(0,utils.zP)`
                                SELECT properties
                                FROM persons
                                WHERE id IN (
                                    SELECT person_id 
                                    FROM person_distinct_ids 
                                    WHERE distinct_id = ${distinct_id}
                                    LIMIT 1
                                )
                                LIMIT 1
                            `,personResponse=await api.ZP.queryHogQL(personQuery),personRow=personResponse.results?.[0];personRow&&personRow[0]&&(person_properties=JSON.parse(personRow[0]))}catch(e){console.error("Failed to fetch person properties:",e)}return{session_id:row[0],distinct_id:row[1],start_timestamp:row[2],end_timestamp:row[3],entry_current_url:row[4],end_current_url:row[5],urls:row[6]||[],num_uniq_urls:row[7]||0,pageview_count:row[8]||0,autocapture_count:row[9]||0,screen_count:row[10]||0,session_duration:row[11]||0,channel_type:row[12],is_bounce:row[13]||!1,entry_hostname:row[14],entry_pathname:row[15],entry_utm_source:row[16],entry_utm_campaign:row[17],entry_utm_medium:row[18],entry_referring_domain:row[19],last_external_click_url:row[20],person_properties}}}],sessionEvents:[null,{loadSessionEvents:async()=>{let eventsQuery="asc"===(values.sortOrder||"asc")?(0,utils.zP)`
                        SELECT
                            uuid,
                            event,
                            timestamp,
                            properties.$window_id,
                            properties.$current_url,
                            properties.$event_type,
                            properties.$screen_name,
                            properties.$pathname,
                            properties.$exception_type,
                            properties.$exception_message,
                            properties.$console_log_level,
                            properties.$response_status,
                            properties.$exception_list,
                            distinct_id
                        FROM events
                        WHERE timestamp >= UUIDv7ToDateTime(toUUID(${props.sessionId}))
                            AND timestamp <= UUIDv7ToDateTime(toUUID(${props.sessionId})) + INTERVAL 2 DAY
                            AND \`$session_id\` = ${props.sessionId}
                        ORDER BY timestamp ASC
                        LIMIT 50
                    `:(0,utils.zP)`
                        SELECT
                            uuid,
                            event,
                            timestamp,
                            properties.$window_id,
                            properties.$current_url,
                            properties.$event_type,
                            properties.$screen_name,
                            properties.$pathname,
                            properties.$exception_type,
                            properties.$exception_message,
                            properties.$console_log_level,
                            properties.$response_status,
                            properties.$exception_list,
                            distinct_id
                        FROM events
                        WHERE timestamp >= UUIDv7ToDateTime(toUUID(${props.sessionId}))
                            AND timestamp <= UUIDv7ToDateTime(toUUID(${props.sessionId})) + INTERVAL 2 DAY
                            AND \`$session_id\` = ${props.sessionId}
                        ORDER BY timestamp DESC
                        LIMIT 50
                    `;return((await api.ZP.queryHogQL(eventsQuery)).results||[]).map(row=>{let properties={};if(null!=row[3]&&(properties.$window_id=row[3]),null!=row[4]&&(properties.$current_url=row[4]),null!=row[5]&&(properties.$event_type=row[5]),null!=row[6]&&(properties.$screen_name=row[6]),null!=row[7]&&(properties.$pathname=row[7]),null!=row[8]&&(properties.$exception_type=row[8]),null!=row[9]&&(properties.$exception_message=row[9]),null!=row[10]&&(properties.$console_log_level=row[10]),null!=row[11]&&(properties.$response_status=row[11]),null!=row[12])try{properties.$exception_list=JSON.parse(row[12])}catch(e){console.error(e),properties.$exception_list=[]}return{id:row[0],event:row[1],timestamp:row[2],properties,distinct_id:row[13],fullyLoaded:!1}})},loadMoreSessionEvents:async(_,breakpoint)=>{await breakpoint(500);let currentEvents=values.sessionEvents||[],offset=values.eventsOffset,eventsQuery="asc"===(values.sortOrder||"asc")?(0,utils.zP)`
                        SELECT
                            uuid,
                            event,
                            timestamp,
                            properties.$window_id,
                            properties.$current_url,
                            properties.$event_type,
                            properties.$screen_name,
                            properties.$pathname,
                            properties.$exception_type,
                            properties.$exception_message,
                            properties.$console_log_level,
                            properties.$response_status,
                            properties.$exception_list,
                            distinct_id
                        FROM events
                        WHERE timestamp >= UUIDv7ToDateTime(toUUID(${props.sessionId}))
                            AND timestamp <= UUIDv7ToDateTime(toUUID(${props.sessionId})) + INTERVAL 2 DAY
                            AND \`$session_id\` = ${props.sessionId}
                        ORDER BY timestamp ASC
                        LIMIT 50
                        OFFSET ${offset}
                    `:(0,utils.zP)`
                        SELECT
                            uuid,
                            event,
                            timestamp,
                            properties.$window_id,
                            properties.$current_url,
                            properties.$event_type,
                            properties.$screen_name,
                            properties.$pathname,
                            properties.$exception_type,
                            properties.$exception_message,
                            properties.$console_log_level,
                            properties.$response_status,
                            properties.$exception_list,
                            distinct_id
                        FROM events
                        WHERE timestamp >= UUIDv7ToDateTime(toUUID(${props.sessionId}))
                            AND timestamp <= UUIDv7ToDateTime(toUUID(${props.sessionId})) + INTERVAL 2 DAY
                            AND \`$session_id\` = ${props.sessionId}
                        ORDER BY timestamp DESC
                        LIMIT 50
                        OFFSET ${offset}
                    `;return[...currentEvents,...((await api.ZP.queryHogQL(eventsQuery)).results||[]).map(row=>{let properties={};if(null!=row[3]&&(properties.$window_id=row[3]),null!=row[4]&&(properties.$current_url=row[4]),null!=row[5]&&(properties.$event_type=row[5]),null!=row[6]&&(properties.$screen_name=row[6]),null!=row[7]&&(properties.$pathname=row[7]),null!=row[8]&&(properties.$exception_type=row[8]),null!=row[9]&&(properties.$exception_message=row[9]),null!=row[10]&&(properties.$console_log_level=row[10]),null!=row[11]&&(properties.$response_status=row[11]),null!=row[12])try{properties.$exception_list=JSON.parse(row[12])}catch(e){console.error(e),properties.$exception_list=[]}return{id:row[0],event:row[1],timestamp:row[2],properties,distinct_id:row[13],fullyLoaded:!1}})]}}],eventDetails:[{},{loadEventDetails:async _ref8=>{let{eventId,eventName}=_ref8,detailsQuery=(0,utils.zP)`
                        SELECT properties, uuid
                        FROM events
                        WHERE event = ${eventName}
                        AND timestamp >= UUIDv7ToDateTime(toUUID(${props.sessionId}))
                        AND timestamp <= UUIDv7ToDateTime(toUUID(${props.sessionId})) + INTERVAL 2 DAY
                        AND uuid = ${eventId}
                        LIMIT 1
                    `,response=await api.ZP.queryHogQL(detailsQuery);if(!response.results||0===response.results.length)return{};let[propertiesJson,uuid]=response.results[0];return{[uuid]:JSON.parse(propertiesJson)}}}],totalEventCount:[null,{loadTotalEventCount:async()=>{let countQuery=(0,utils.zP)`
                        SELECT count(*) as total
                        FROM events
                        WHERE timestamp >= UUIDv7ToDateTime(toUUID(${props.sessionId}))
                            AND timestamp <= UUIDv7ToDateTime(toUUID(${props.sessionId})) + INTERVAL 2 DAY
                            AND \`$session_id\` = ${props.sessionId}
                    `,response=await api.ZP.queryHogQL(countQuery);return response.results?.[0]?.[0]||0}}],hasRecording:[!1,{loadRecordingAvailability:async()=>{var _response$results$len;let startTime=`UUIDv7ToDateTime(toUUID('${props.sessionId}'))`,endTime=`${startTime} + INTERVAL 1 DAY`,response=await api.ZP.recordings.list({kind:schema_general.OH.RecordingsQuery,session_ids:[props.sessionId],date_from:startTime,date_to:endTime,limit:1});return(null!==(_response$results$len=response.results?.length)&&void 0!==_response$results$len?_response$results$len:0)>0}}],supportTicketEvents:[[],{loadSupportTicketEvents:async()=>{let ticketsQuery=(0,utils.zP)`
                        SELECT
                            uuid,
                            event,
                            timestamp,
                            properties.zendesk_ticket_id,
                            distinct_id
                        FROM events
                        WHERE timestamp >= UUIDv7ToDateTime(toUUID(${props.sessionId}))
                            AND timestamp <= UUIDv7ToDateTime(toUUID(${props.sessionId})) + INTERVAL 2 DAY
                            AND \`$session_id\` = ${props.sessionId}
                            AND event = 'support_ticket'
                        ORDER BY timestamp DESC
                    `;return((await api.ZP.queryHogQL(ticketsQuery)).results||[]).map(row=>{let properties={};return null!=row[3]&&(properties.zendesk_ticket_id=row[3]),{id:row[0],event:row[1],timestamp:row[2],properties,distinct_id:row[4],fullyLoaded:!1}})}}]}}),(0,index_esm.selectors)({sessionId:[()=>[(_,props)=>props.sessionId],sessionId=>sessionId],sessionDuration:[s=>[s.sessionData],sessionData=>sessionData?.session_duration||null],uniqueUrlCount:[s=>[s.sessionData],sessionData=>sessionData?.num_uniq_urls||0],categorizedEventCount:[s=>[s.sessionData],sessionData=>sessionData?(sessionData.pageview_count||0)+(sessionData.autocapture_count||0)+(sessionData.screen_count||0):0],otherEventCount:[s=>[s.totalEventCount,s.sessionData],(totalEventCount,sessionData)=>totalEventCount&&sessionData?Math.max(0,totalEventCount-((sessionData.pageview_count||0)+(sessionData.autocapture_count||0)+(sessionData.screen_count||0))):0],isInitialLoading:[s=>[s.sessionDataLoading,s.sessionEventsLoading,s.sessionData,s.sessionEvents],(sessionDataLoading,sessionEventsLoading,sessionData,sessionEvents)=>sessionDataLoading&&null===sessionData||sessionEventsLoading&&null===sessionEvents],isLoadingMore:[s=>[s.sessionEventsLoading,s.sessionEvents],(sessionEventsLoading,sessionEvents)=>sessionEventsLoading&&null!==sessionEvents]}),(0,index_esm.listeners)(_ref9=>{let{actions,values}=_ref9;return{loadSessionData:()=>{actions.loadSessionEvents(),actions.loadTotalEventCount(),actions.loadRecordingAvailability(),actions.loadSupportTicketEvents()},setSortOrder:()=>{actions.setHasMoreEvents(!0),actions.loadSessionEvents()},loadMoreSessionEventsSuccess:_ref10=>{let{sessionEvents}=_ref10,previousCount=values.eventsOffset,newCount=sessionEvents.length,fetchedCount=newCount-previousCount;fetchedCount<50&&actions.setHasMoreEvents(!1),fetchedCount>0&&actions.updateEventsOffset(newCount)},loadEventDetailsSuccess:_ref11=>{let{eventDetails}=_ref11,events=values.sessionEvents;if(!events||!eventDetails||0===Object.keys(eventDetails).length)return;let updatedEvents=events.map(event=>{let fullProperties=eventDetails[event.id];return fullProperties?{...event,properties:{...event.properties,...fullProperties},fullyLoaded:!0}:event});actions.loadSessionEventsSuccess(updatedEvents)}}}),(0,index_esm.events)(_ref12=>{let{actions}=_ref12;return{afterMount:()=>{actions.loadSessionData()}}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function DetailRow(_ref){let{label,value,className}=_ref;return(0,jsx_runtime.jsxs)("div",{className:`flex gap-2 ${className||""}`,children:[(0,jsx_runtime.jsxs)("span",{className:"text-secondary min-w-32",children:[label,":"]}),(0,jsx_runtime.jsx)("span",{className:"truncate",children:value})]})}function DetailSection(_ref2){let{title,children,defaultExpanded=!0,showBorder=!0}=_ref2,[isExpanded,setIsExpanded]=(0,react.useState)(defaultExpanded);return(0,jsx_runtime.jsxs)("div",{className:showBorder?"border-t border-border":"",children:[(0,jsx_runtime.jsxs)("div",{className:"flex ml-1 gap-2 items-center justify-start cursor-pointer hover:bg-surface-primary",onClick:()=>setIsExpanded(!isExpanded),children:[(0,jsx_runtime.jsx)(src.Jp,{icon:isExpanded?(0,jsx_runtime.jsx)(posthog_icons_es.IconCollapse,{}):(0,jsx_runtime.jsx)(posthog_icons_es.IconExpand,{}),size:"small",onClick:e=>{e.stopPropagation(),setIsExpanded(!isExpanded)}}),(0,jsx_runtime.jsx)("h4",{className:"text-sm font-semibold mt-2",children:title})]}),isExpanded&&(0,jsx_runtime.jsx)("div",{className:"px-4 pb-4 space-y-2",children:children})]})}function SessionDetailsCard(){let{sessionData,isInitialLoading,supportTicketEvents}=(0,index_esm.useValues)(sessionProfileLogic),hasSupportTickets=supportTicketEvents.length>0;if(!sessionData||isInitialLoading)return null;let hasAttribution=sessionData.entry_utm_source||sessionData.entry_utm_campaign||sessionData.entry_utm_medium||sessionData.entry_referring_domain,hasUrls=sessionData.entry_current_url||sessionData.end_current_url||sessionData.last_external_click_url||sessionData.urls&&sessionData.urls.length>0;return(0,jsx_runtime.jsxs)(src.Mi,{className:"p-2",hoverEffect:!1,children:[(0,jsx_runtime.jsxs)(DetailSection,{title:"Session Properties",defaultExpanded:!0,showBorder:!1,children:[sessionData.channel_type&&(0,jsx_runtime.jsx)(DetailRow,{label:"Channel type",value:(0,jsx_runtime.jsx)(src.oe,{children:sessionData.channel_type})}),(0,jsx_runtime.jsx)(DetailRow,{label:"Is bounce",value:(0,jsx_runtime.jsx)(src.oe,{type:sessionData.is_bounce?"warning":"success",children:sessionData.is_bounce?"Yes":"No"})}),sessionData.entry_hostname&&(0,jsx_runtime.jsx)(DetailRow,{label:"Entry hostname",value:sessionData.entry_hostname}),sessionData.entry_pathname&&(0,jsx_runtime.jsx)(DetailRow,{label:"Entry pathname",value:sessionData.entry_pathname})]}),hasAttribution&&(0,jsx_runtime.jsxs)(DetailSection,{title:"Attribution",defaultExpanded:!1,children:[sessionData.entry_referring_domain&&(0,jsx_runtime.jsx)(DetailRow,{label:"Referring domain",value:sessionData.entry_referring_domain}),sessionData.entry_utm_source&&(0,jsx_runtime.jsx)(DetailRow,{label:"UTM source",value:sessionData.entry_utm_source}),sessionData.entry_utm_campaign&&(0,jsx_runtime.jsx)(DetailRow,{label:"UTM campaign",value:sessionData.entry_utm_campaign}),sessionData.entry_utm_medium&&(0,jsx_runtime.jsx)(DetailRow,{label:"UTM medium",value:sessionData.entry_utm_medium})]}),hasUrls&&(0,jsx_runtime.jsxs)(DetailSection,{title:"URLs",defaultExpanded:!1,children:[sessionData.entry_current_url&&(0,jsx_runtime.jsx)(DetailRow,{label:"Entry URL",value:(0,jsx_runtime.jsx)(src.rU,{to:sessionData.entry_current_url,target:"_blank",className:"truncate block",children:sessionData.entry_current_url})}),sessionData.end_current_url&&(0,jsx_runtime.jsx)(DetailRow,{label:"Exit URL",value:(0,jsx_runtime.jsx)(src.rU,{to:sessionData.end_current_url,target:"_blank",className:"truncate block",children:sessionData.end_current_url})}),sessionData.last_external_click_url&&(0,jsx_runtime.jsx)(DetailRow,{label:"Last external click",value:(0,jsx_runtime.jsx)(src.rU,{to:sessionData.last_external_click_url,target:"_blank",className:"truncate block",children:sessionData.last_external_click_url})}),sessionData.urls&&sessionData.urls.length>0&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex gap-2",children:(0,jsx_runtime.jsxs)("span",{className:"text-secondary min-w-32",children:["All URLs (",sessionData.urls.length,"):"]})}),(0,jsx_runtime.jsx)("div",{className:"ml-32 space-y-1 max-h-60 overflow-y-auto",children:sessionData.urls.map((url,index)=>(0,jsx_runtime.jsx)("div",{className:"text-xs truncate",children:(0,jsx_runtime.jsxs)(src.rU,{to:url,target:"_blank",children:[index+1,". ",url]})},index))})]})]}),hasSupportTickets&&(0,jsx_runtime.jsx)(DetailSection,{title:"Support tickets",defaultExpanded:!1,children:supportTicketEvents.map((event,index)=>{let ticketId=event.properties?.zendesk_ticket_id,zendeskUrl=ticketId?`https://posthoghelp.zendesk.com/agent/tickets/${ticketId}`:null;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[index>0&&(0,jsx_runtime.jsx)(src.p2,{className:"my-2"}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,jsx_runtime.jsxs)("span",{className:"text-secondary min-w-32",children:[(0,jsx_runtime.jsx)(TZLabel.w,{time:event.timestamp,formatDate:"MMM DD, h:mm A"}),":"]}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 items-center",children:zendeskUrl?(0,jsx_runtime.jsxs)(src.rU,{to:zendeskUrl,target:"_blank",children:["Ticket #",ticketId]}):(0,jsx_runtime.jsx)("span",{className:"text-muted-alt",children:"No ticket ID"})})]})]},event.id)})})]})}var clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),Errors_utils=__webpack_require__("../../frontend/src/lib/components/Errors/utils.ts"),PropertyKeyInfo=__webpack_require__("../../frontend/src/lib/components/PropertyKeyInfo.tsx"),TaxonomicFilter_types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),ErrorDisplay=__webpack_require__("../../frontend/src/lib/components/Errors/ErrorDisplay.tsx"),EventPropertyTabs=__webpack_require__("../../frontend/src/lib/components/EventPropertyTabs/EventPropertyTabs.tsx"),SimpleKeyValueList=__webpack_require__("../../frontend/src/lib/components/SimpleKeyValueList.tsx"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),lemon_ui_Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/index.ts");function SessionEventDetails(_ref){let{event}=_ref;return event.fullyLoaded?(0,jsx_runtime.jsx)("div",{className:"mx-2",children:(0,jsx_runtime.jsx)(EventPropertyTabs.d,{size:"small",event:event,tabContentComponentFn:_ref2=>{let{event,properties,promotedKeys,tabKey}=_ref2;switch(tabKey){case"error_display":let eventId=("uuid"in event?event.uuid:null)||("id"in event?event.id:null)||(0,dayjs.Bv)(event.timestamp).toISOString()||`error-${event.timestamp}`;return(0,jsx_runtime.jsx)(ErrorDisplay.Xr,{eventProperties:properties,eventId:eventId});case"raw":return(0,jsx_runtime.jsx)("pre",{className:"text-xs text-secondary whitespace-pre-wrap",children:JSON.stringify(event,null,2)});default:return(0,jsx_runtime.jsx)(SimpleKeyValueList.u,{item:properties,promotedKeys:promotedKeys})}}})}):(0,jsx_runtime.jsxs)("div",{className:"px-4 py-3 flex items-center gap-2 text-secondary",children:[(0,jsx_runtime.jsx)(lemon_ui_Spinner.$,{textColored:!0}),(0,jsx_runtime.jsx)("span",{children:"Loading event details..."})]})}function ExceptionTitlePill(_ref){let{event}=_ref,errorProps=(0,Errors_utils.OZ)(event.properties||{}),type=errorProps.type,value=errorProps.value;return type||value?(0,jsx_runtime.jsxs)("div",{className:"flex gap-1 px-2 py-0.5 rounded border border-danger-dark bg-danger-highlight text-xs font-mono truncate max-w-md",children:[type&&(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:type}),type&&value&&(0,jsx_runtime.jsx)("span",{children:":"}),value&&(0,jsx_runtime.jsx)("span",{className:"truncate",children:value})]}):(0,jsx_runtime.jsx)("span",{className:"text-muted-alt text-xs",children:"Exception"})}function eventToIcon(event){switch(event){case"$pageview":case"$screen":return posthog_icons_es.IconEye;case"$pageleave":return posthog_icons_es.IconLeave;case"$autocapture":return posthog_icons_es.IconBolt;case"$exception":case"error":return posthog_icons_es.IconTerminal;default:if(event&&event.startsWith("$"))return posthog_icons_es.IconLogomark;if(null!=event)return posthog_icons_es.IconCursor;return posthog_icons_es.BaseIcon}}function getEventHighlightColor(event){if("$exception"===event.event?.toLowerCase()||event.properties?.$exception_message)return"danger";let logLevel=event.properties?.$console_log_level;if("error"===logLevel)return"danger";if("warn"===logLevel)return"warning";let responseStatus=event.properties?.$response_status||event.properties?.status_code;return responseStatus&&responseStatus>=400?"danger":null}function SessionEventItem(_ref2){let{event,index,isExpanded,onToggleExpand,onLoadEventDetails}=_ref2,EventIcon=eventToIcon(event.event),highlightColor=getEventHighlightColor(event),handleToggle=()=>{isExpanded||event.fullyLoaded||!onLoadEventDetails||onLoadEventDetails(event.id,event.event),onToggleExpand(index)};return(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("border border-border rounded overflow-hidden transition-all bg-surface-primary",!isExpanded&&"hover:bg-secondary-3000-hover-light",isExpanded&&"border-accent",isExpanded&&"danger"===highlightColor&&"border-danger-dark",isExpanded&&"warning"===highlightColor&&"border-warning-dark",isExpanded&&"primary"===highlightColor&&"border-primary-dark"),style:{zIndex:+!!isExpanded},children:[(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("flex items-center justify-between px-2 py-1 cursor-pointer","danger"===highlightColor&&"bg-fill-error-highlight","warning"===highlightColor&&"bg-fill-warning-highlight","primary"===highlightColor&&"bg-fill-success-highlight"),onClick:handleToggle,children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 flex-1 overflow-hidden",children:[(0,jsx_runtime.jsx)("div",{className:"flex items-center p-0.5",children:(0,jsx_runtime.jsx)(EventIcon,{})}),(0,jsx_runtime.jsx)(TZLabel.w,{time:event.timestamp,formatDate:"MMMM DD, YYYY",formatTime:"h:mm:ss A",showPopover:!1,className:"text-xs text-muted-alt min-w-32"}),(0,jsx_runtime.jsx)(PropertyKeyInfo.T,{value:event.event,type:TaxonomicFilter_types.t.Events,className:"font-semibold truncate max-w-80",disablePopover:!0}),"$exception"===event.event?(0,jsx_runtime.jsx)(ExceptionTitlePill,{event:event}):event.properties?.$pathname&&event.properties?.$host&&(0,jsx_runtime.jsxs)("span",{className:"text-muted-alt truncate text-xs",children:["- ",event.properties.$host,event.properties.$pathname]})]}),(0,jsx_runtime.jsx)(src.Jp,{icon:isExpanded?(0,jsx_runtime.jsx)(posthog_icons_es.IconCollapse,{}):(0,jsx_runtime.jsx)(posthog_icons_es.IconExpand,{}),size:"small",noPadding:!0,onClick:e=>{e.stopPropagation(),handleToggle()}})]}),isExpanded&&(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("border-t border-border","danger"===highlightColor&&"bg-fill-error-highlight","warning"===highlightColor&&"bg-fill-warning-highlight","primary"===highlightColor&&"bg-fill-success-highlight"),children:(0,jsx_runtime.jsx)("div",{className:"max-h-[400px] overflow-y-auto",children:(0,jsx_runtime.jsx)(SessionEventDetails,{event:event})})})]})}function SessionEventsList(){let{sessionEvents,totalEventCount,isInitialLoading,isLoadingMore,hasMoreEvents,sortOrder,eventsListFolded}=(0,index_esm.useValues)(sessionProfileLogic),{loadEventDetails,loadMoreSessionEvents,setSortOrder,setEventsListFolded}=(0,index_esm.useActions)(sessionProfileLogic),[expandedIndices,setExpandedIndices]=(0,react.useState)(new Set),handleToggleExpand=index=>{setExpandedIndices(prev=>{let newSet=new Set(prev);return newSet.has(index)?newSet.delete(index):newSet.add(index),newSet})};return isInitialLoading?(0,jsx_runtime.jsx)(src.Mi,{className:"p-6",children:(0,jsx_runtime.jsx)("div",{className:"text-muted-alt text-center",children:"Loading events..."})}):sessionEvents&&sessionEvents?.length!==0?(0,jsx_runtime.jsxs)(src.Mi,{className:"overflow-hidden p-0",hoverEffect:!1,children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between bg-surface-primary p-3",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",icon:eventsListFolded?(0,jsx_runtime.jsx)(posthog_icons_es.IconExpand,{}):(0,jsx_runtime.jsx)(posthog_icons_es.IconCollapse,{}),onClick:()=>setEventsListFolded(!eventsListFolded)}),(0,jsx_runtime.jsxs)("h3",{className:"text-lg font-semibold m-0",children:["Events (",null!=totalEventCount?totalEventCount:sessionEvents.length,")"]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconSort,{className:(0,clsx_m.default)({"rotate-180":"asc"===sortOrder})}),onClick:()=>setSortOrder("asc"===sortOrder?"desc":"asc"),tooltip:"asc"===sortOrder?"Sorted: Oldest first":"Sorted: Newest first",children:"asc"===sortOrder?"Oldest first":"Newest first"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",onClick:()=>{setExpandedIndices(new Set)},children:"Collapse All"})]})]}),!eventsListFolded&&(0,jsx_runtime.jsxs)("div",{className:"p-2 space-y-1 max-h-[600px] overflow-y-auto bg-primary border-t border-border",onScroll:e=>{if(!hasMoreEvents||isLoadingMore||!loadMoreSessionEvents)return;let target=e.currentTarget;target.scrollHeight-target.scrollTop-target.clientHeight<200&&loadMoreSessionEvents()},children:[sessionEvents?.map((event,index)=>jsx_runtime.jsx(SessionEventItem,{event:{...event,fullyLoaded:!0},index:index,isExpanded:expandedIndices.has(index),onToggleExpand:handleToggleExpand,onLoadEventDetails:loadEventDetails},event.id)),hasMoreEvents&&(0,jsx_runtime.jsx)("div",{className:"text-center py-4 text-muted-alt",children:isLoadingMore?"Loading more events...":"Scroll for more"})]})]}):(0,jsx_runtime.jsx)(src.Mi,{className:"p-6",children:(0,jsx_runtime.jsx)("div",{className:"text-muted-alt text-center",children:"No events found"})})}var lib_utils=__webpack_require__("../../frontend/src/lib/utils.tsx");function MetricCard(_ref){let{title,value,isLoading,subtitle}=_ref;return(0,jsx_runtime.jsx)(src.Mi,{hoverEffect:!1,className:"p-4 flex flex-col flex-1 justify-between max-w-80 min-h-36",children:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"text-sm font-semibold text-muted-alt mb-1",children:title}),isLoading?(0,jsx_runtime.jsx)(src.yW,{className:"h-8 w-24"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"text-3xl font-bold text-primary my-2 truncate",children:null!=value?value:"-"}),subtitle&&(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted",children:subtitle})]})]})})}function SessionMetricsCard(){let{sessionData,sessionDuration,uniqueUrlCount,totalEventCount,otherEventCount,isInitialLoading}=(0,index_esm.useValues)(sessionProfileLogic);return(0,jsx_runtime.jsx)("div",{className:"@container",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col @md:flex-row gap-4 @md:justify-between",children:[(0,jsx_runtime.jsx)(MetricCard,{title:"Duration",value:null!==sessionDuration?(0,lib_utils.C7)(sessionDuration):null,subtitle:null!==sessionDuration?`${sessionDuration} seconds`:void 0,isLoading:isInitialLoading}),(0,jsx_runtime.jsx)(MetricCard,{title:"Unique URLs",value:uniqueUrlCount,isLoading:isInitialLoading}),(0,jsx_runtime.jsx)(MetricCard,{title:"Total Events",value:totalEventCount,subtitle:sessionData?.pageview_count!==void 0&&sessionData?.autocapture_count!==void 0&&sessionData?.screen_count!==void 0?`${sessionData.pageview_count} pageviews, ${sessionData.autocapture_count} autocapture, ${sessionData.screen_count} screens${otherEventCount>0?` + ${otherEventCount} other`:""}`:void 0,isLoading:isInitialLoading})]})})}let scene={component:SessionProfileScene,logic:sessionProfileLogic,paramsToProps:_ref=>{let{params:{id}}=_ref;return{sessionId:decodeURIComponent(id)}}};function SessionProfileScene(){let{sessionId,sessionData,isInitialLoading,sessionDataLoading,sessionEventsLoading,hasRecording,hasRecordingLoading}=(0,index_esm.useValues)(sessionProfileLogic),{loadSessionData}=(0,index_esm.useActions)(sessionProfileLogic);return sessionData||isInitialLoading?isInitialLoading?(0,jsx_runtime.jsx)(Spinner.t,{sceneLevel:!0}):(0,jsx_runtime.jsxs)(SceneContent._,{children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:"Session Profile",resourceType:{type:scenes.lc[sceneTypes.x.SessionProfile].iconType||"default_icon_type"},forceBackTo:{name:scenes.lc[sceneTypes.x.ExploreSessions].name,path:urls.j.activity(types.ZO.ExploreSessions),key:"sessions"},actions:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ViewRecordingButton.Z,{sessionId:sessionData?.session_id,recordingStatus:hasRecording?"active":"none",inModal:!0,size:"small",type:"secondary",loading:hasRecordingLoading}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconRefresh,{}),onClick:()=>loadSessionData(),loading:sessionDataLoading||sessionEventsLoading,children:"Refresh"})]})}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:sessionProfileLogic,props:{sessionId},children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[sessionData&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-x-6 gap-y-2",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted-alt",children:"Session ID"}),(0,jsx_runtime.jsx)("div",{className:"font-mono text-sm",children:(0,jsx_runtime.jsx)(CopyToClipboard.D,{description:"session ID",children:sessionId})})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted-alt",children:"Person"}),(0,jsx_runtime.jsx)("div",{className:"text-sm",children:(0,jsx_runtime.jsx)(PersonDisplay.I,{person:{distinct_id:sessionData.distinct_id,properties:sessionData.person_properties||void 0},withIcon:!0})})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted-alt",children:"Start time"}),(0,jsx_runtime.jsx)("div",{className:"text-sm",children:(0,jsx_runtime.jsx)(TZLabel.w,{time:sessionData.start_timestamp})})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted-alt",children:"End time"}),(0,jsx_runtime.jsx)("div",{className:"text-sm",children:(0,jsx_runtime.jsx)(TZLabel.w,{time:sessionData.end_timestamp})})]})]}),(0,jsx_runtime.jsx)(SessionMetricsCard,{}),(0,jsx_runtime.jsx)(SessionDetailsCard,{}),(0,jsx_runtime.jsx)(SessionEventsList,{})]})})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"session"})}}}]);
//# sourceMappingURL=39269.81916c46.iframe.bundle.js.map