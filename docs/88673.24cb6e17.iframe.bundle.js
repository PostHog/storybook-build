"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[88673],{"../../frontend/src/scenes/hog-functions/configuration/HogFunctionConfiguration.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{g:()=>HogFunctionConfiguration});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.22.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),core_esm=__webpack_require__("../../node_modules/.pnpm/@dnd-kit+core@6.0.8_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@dnd-kit/core/dist/core.esm.js"),sortable_esm=__webpack_require__("../../node_modules/.pnpm/@dnd-kit+sortable@7.0.2_@dnd-kit+core@6.0.8_react-dom@18.2.0_react@18.2.0__react@18.2.0__react@18.2.0/node_modules/@dnd-kit/sortable/dist/sortable.esm.js"),utilities_esm=__webpack_require__("../../node_modules/.pnpm/@dnd-kit+utilities@3.2.1_react@18.2.0/node_modules/@dnd-kit/utilities/dist/utilities.esm.js"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),CodeEditorInline=__webpack_require__("../../frontend/src/lib/monaco/CodeEditorInline.tsx"),CodeEditorResizable=__webpack_require__("../../frontend/src/lib/monaco/CodeEditorResizable.tsx"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),copyToClipboard=__webpack_require__("../../frontend/src/lib/utils/copyToClipboard.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),EmailTemplater=__webpack_require__("../../frontend/src/scenes/hog-functions/email-templater/EmailTemplater.tsx");function formatJsonValue(value){return null==value?"{}":"string"!=typeof value?JSON.stringify(value,null,2):value}let cyclotronJobInputLogic=(0,index_esm.kea)({path:["components","cyclotron-jobs","cyclotronJobInputLogic"],props:{},key:props=>`json_validation_${props.fieldKey}`,actions:{setJsonValue:value=>({value}),validateJson:value=>({value}),setError:error=>({error})},reducers:{jsonValue:["",{setJsonValue:(_state,_ref)=>{let{value}=_ref;return value}}],error:[null,{setError:(_state,_ref2)=>{let{error}=_ref2;return error}}]},selectors:{hasError:[s=>[s.error],error=>!!error]},listeners:_ref3=>{let{actions,props}=_ref3;return{setJsonValue:async(_ref4,breakpoint)=>{let{value}=_ref4;if(!value||""===value.trim()){actions.setError(null);return}props.onChange?.(value),await breakpoint(600);try{JSON.parse(value),actions.setError(null)}catch(e){let errorMessage=e.message||"Invalid JSON";errorMessage.includes("'u'")&&value.includes("undefined")&&(errorMessage="Error: 'undefined' is not allowed in JSON. Use null instead."),actions.setError(errorMessage)}}}},propsChanged(_ref5){let{actions,props}=_ref5;void 0!==props.initialValue&&actions.setJsonValue(formatJsonValue(props.initialValue))}});var FlaggedFeature=__webpack_require__("../../frontend/src/lib/components/FlaggedFeature.tsx"),dist_module=__webpack_require__("../hogvm/typescript/dist/module.js"),fuse_esm=__webpack_require__("../../node_modules/.pnpm/fuse.js@6.6.2/node_modules/fuse.js/dist/fuse.esm.js");let HOG_USAGE_EXAMPLES=[{key:"ternary",example:"$1 = true ? 'Yes' : 'No'",description:"Ternary operation (if this then that else other)"},{key:"default",example:"$1 ?? 'Default value'",description:"Default value (if this is null or undefined, use this)"}],HOG_STL_EXAMPLES=Object.entries(dist_module.iG).map(_ref=>{let[key,value]=_ref;return{key,example:value.example,description:value.description}}),cyclotronJobTemplateSuggestionsLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref2=>{let{templating}=_ref2;return templating}),(0,index_esm.path)(key=>["components","cyclotron-jobs","cyclotronJobTemplateSuggestionsLogic",key]),(0,index_esm.actions)({setSearch:search=>({search})}),(0,index_esm.reducers)({search:["",{setSearch:(_,_ref3)=>{let{search}=_ref3;return search}}]}),(0,index_esm.selectors)({allOptions:[(_,p)=>[p.templating],templating=>"hog"===templating?[...HOG_USAGE_EXAMPLES,...HOG_STL_EXAMPLES]:[]],optionsFuse:[s=>[s.allOptions],allOptions=>new fuse_esm.Z(allOptions,{keys:["description","example"],threshold:.3})],optionsFiltered:[s=>[s.allOptions,s.optionsFuse,s.search],(allOptions,optionsFuse,search)=>search?optionsFuse.search(search).map(result=>result.item):allOptions]})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function CyclotronJobTemplateSuggestionsItem(_ref){let{option,onSelect}=_ref;return(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,role:"menuitem",size:"small",onClick:()=>onSelect(option),children:(0,jsx_runtime.jsxs)("div",{className:"flex-col flex-1",children:[(0,jsx_runtime.jsx)("code",{className:"text-sm font-semibold font-monospace",children:option.example}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary",children:option.description})]})})}function CyclotronJobTemplateSuggestions(_ref2){let{templating,setTemplating,onOptionSelect}=_ref2,logic=cyclotronJobTemplateSuggestionsLogic({templating}),{search,optionsFiltered}=(0,index_esm.useValues)(logic),{setSearch}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex overflow-hidden flex-col flex-1 gap-1 max-w-100",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1 p-2 flex-0",children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-1",children:[(0,jsx_runtime.jsx)(src.DF,{type:"search",placeholder:"Search templating options",autoFocus:!0,value:search,onChange:setSearch,fullWidth:!0}),setTemplating?(0,jsx_runtime.jsx)(FlaggedFeature.P,{flag:"cdp-hog-input-liquid",children:(0,jsx_runtime.jsx)(src.Yv,{value:templating,onChange:setTemplating,options:[{label:"Hog",value:"hog"},{label:"Liquid",value:"liquid"}],tooltip:"Change the templating language"})}):null]}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-secondary",children:["Below are a list of available functions for templating your inputs using ",(0,jsx_runtime.jsx)("b",{children:templating}),"."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/cdp/destinations/customizing-destinations#customizing-payload",children:"Learn more"})]})]}),(0,jsx_runtime.jsxs)("ul",{className:"flex overflow-y-auto flex-col flex-1 gap-px p-2 border-t max-w-100",children:[optionsFiltered.map(value=>(0,jsx_runtime.jsx)("li",{children:(0,jsx_runtime.jsx)(CyclotronJobTemplateSuggestionsItem,{option:value,onSelect:onOptionSelect})},value.key)),"liquid"===templating?(0,jsx_runtime.jsx)("li",{children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconExternal,{}),to:"https://liquidjs.com/filters/overview.html",targetBlank:!0,children:"Liquid documentation"})}):null]})]})}function CyclotronJobTemplateSuggestionsButton(_ref3){let{onOptionSelect,...props}=_ref3,[showPopover,setShowPopover]=(0,react.useState)(!1);return(0,jsx_runtime.jsx)(src.Qw,{closeOnClickInside:!1,visible:showPopover,matchWidth:!1,actionable:!0,onVisibilityChange:visible=>setShowPopover(visible),overlay:(0,jsx_runtime.jsx)(CyclotronJobTemplateSuggestions,{...props,onOptionSelect:option=>{onOptionSelect(option),setShowPopover(!1)}}),overflowHidden:!0,children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconCode,{}),tooltip:"Supports templating - click to see available options"})})}var IntegrationChoice=__webpack_require__("../../frontend/src/lib/components/CyclotronJob/integrations/IntegrationChoice.tsx");function CyclotronJobInputIntegration(_ref){let{schema,persistForUnload,...props}=_ref;return(0,jsx_runtime.jsx)(IntegrationChoice.a,{...props,schema:schema,integration:schema.integration,redirectUrl:`${window.location.pathname}?integration_target=${schema.key}`,beforeRedirect:()=>persistForUnload?.()})}var kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts");let googleAdsIntegrationLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>props.id),(0,index_esm.path)(key=>["lib","integrations","googleAdsIntegrationLogic",key]),(0,index_esm.actions)({loadGoogleAdsConversionActions:(customerId,parentId)=>({customerId,parentId}),loadGoogleAdsAccessibleAccounts:!0}),(0,kea_loaders_lib.loaders)(_ref=>{let{props}=_ref;return{googleAdsConversionActions:[null,{loadGoogleAdsConversionActions:async _ref2=>{let{customerId,parentId}=_ref2;return(await api.ZP.integrations.googleAdsConversionActions(props.id,{customerId,parentId})).conversionActions}}],googleAdsAccessibleAccounts:[null,{loadGoogleAdsAccessibleAccounts:async()=>(await api.ZP.integrations.googleAdsAccounts(props.id)).accessibleAccounts}]}})]),getGoogleAdsAccountOptions=googleAdsAccounts=>googleAdsAccounts?googleAdsAccounts.map(customer=>({key:`${customer.id}/${customer.parent_id}`,labelComponent:(0,jsx_runtime.jsxs)("span",{className:"flex items-center",children:[customer.name," (",customer.id.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3"),")"]}),label:`${customer.name} (${customer.id.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3")})`})):null,getGoogleAdsConversionActionOptions=googleAdsConversionActions=>googleAdsConversionActions?googleAdsConversionActions.map(_ref=>{let{id,name}=_ref;return{key:id,labelComponent:(0,jsx_runtime.jsxs)("span",{className:"flex items-center",children:[name," (",id,")"]}),label:`${name} (${id})`}}):null;function GoogleAdsConversionActionPicker(_ref2){let{onChange,value,requiresFieldValue,integration,disabled}=_ref2,{googleAdsConversionActions,googleAdsConversionActionsLoading}=(0,index_esm.useValues)(googleAdsIntegrationLogic({id:integration.id})),{loadGoogleAdsConversionActions}=(0,index_esm.useActions)(googleAdsIntegrationLogic({id:integration.id})),googleAdsConversionActionOptions=(0,react.useMemo)(()=>getGoogleAdsConversionActionOptions(googleAdsConversionActions),[googleAdsConversionActions]);return(0,react.useEffect)(()=>{requiresFieldValue&&loadGoogleAdsConversionActions(requiresFieldValue.split("/")[0],requiresFieldValue.split("/")[1])},[loadGoogleAdsConversionActions,requiresFieldValue]),(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.nt,{onChange:val=>{var _val$;return onChange?.(null!==(_val$=val[0])&&void 0!==_val$?_val$:null)},value:value?[value]:[],onFocus:()=>!googleAdsConversionActions&&!googleAdsConversionActionsLoading&&requiresFieldValue&&loadGoogleAdsConversionActions(requiresFieldValue.split("/")[0],requiresFieldValue.split("/")[1]),disabled:disabled,mode:"single","data-attr":"select-google-ads-conversion-action",placeholder:"Select a Conversion Action...",options:null!=googleAdsConversionActionOptions?googleAdsConversionActionOptions:value?[{key:value,label:value}]:[],loading:googleAdsConversionActionsLoading})})}function GoogleAdsCustomerIdPicker(_ref3){let{onChange,value,integration,disabled}=_ref3,{googleAdsAccessibleAccounts,googleAdsAccessibleAccountsLoading}=(0,index_esm.useValues)(googleAdsIntegrationLogic({id:integration.id})),{loadGoogleAdsAccessibleAccounts}=(0,index_esm.useActions)(googleAdsIntegrationLogic({id:integration.id})),googleAdsAccountOptions=(0,react.useMemo)(()=>getGoogleAdsAccountOptions(googleAdsAccessibleAccounts),[googleAdsAccessibleAccounts]);return(0,react.useEffect)(()=>{disabled||loadGoogleAdsAccessibleAccounts()},[loadGoogleAdsAccessibleAccounts,disabled]),(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.nt,{onChange:val=>{var _val$2;return onChange?.(null!==(_val$2=val[0])&&void 0!==_val$2?_val$2:null)},value:value?[value]:[],onFocus:()=>!googleAdsAccessibleAccounts&&!googleAdsAccessibleAccountsLoading&&loadGoogleAdsAccessibleAccounts(),disabled:disabled,mode:"single","data-attr":"select-google-ads-customer-id-channel",placeholder:"Select a Customer ID...",options:null!=googleAdsAccountOptions?googleAdsAccountOptions:value?[{key:value,label:value.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3")}]:[],loading:googleAdsAccessibleAccountsLoading})})}var integrationsLogic=__webpack_require__("../../frontend/src/lib/integrations/integrationsLogic.ts"),preflightLogic=__webpack_require__("../../frontend/src/scenes/PreflightCheck/preflightLogic.tsx");let linearIntegrationLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>props.id),(0,index_esm.path)(key=>["lib","integrations","linearIntegrationLogic",key]),(0,index_esm.connect)({values:[preflightLogic.preflightLogic,["siteUrlMisconfigured","preflight"]]}),(0,index_esm.actions)({loadAllLinearTeams:()=>({})}),(0,kea_loaders_lib.loaders)(_ref=>{let{props}=_ref;return{linearTeams:[[],{loadAllLinearTeams:async()=>(await api.ZP.integrations.linearTeams(props.id)).teams}]}})]);function LinearTeamPicker(_ref){let{onChange,value,integration,disabled}=_ref,logic=linearIntegrationLogic({id:integration.id}),{linearTeams,linearTeamsLoading}=(0,index_esm.useValues)(logic),{loadAllLinearTeams}=(0,index_esm.useActions)(logic),linearTeamOptions=(0,react.useMemo)(()=>linearTeams?linearTeams.map(x=>({key:x.id,label:x.name})):[],[linearTeams]);return(0,react.useEffect)(()=>{disabled||loadAllLinearTeams()},[loadAllLinearTeams,disabled]),(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.nt,{onChange:val=>{var _val$;onChange?.(null!==(_val$=val[0])&&void 0!==_val$?_val$:null)},value:value?[value]:[],onFocus:()=>!linearTeams.length&&!linearTeamsLoading&&loadAllLinearTeams(),disabled:disabled,mode:"single","data-attr":"select-linear-team",placeholder:"Select a team...",options:linearTeamOptions,loading:linearTeamsLoading})})}let linkedInAdsIntegrationLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>props.id),(0,index_esm.path)(key=>["lib","integrations","linkedInAdsIntegrationLogic",key]),(0,index_esm.actions)({loadLinkedInAdsConversionRules:accountId=>accountId,loadLinkedInAdsAccounts:!0}),(0,kea_loaders_lib.loaders)(_ref=>{let{props}=_ref;return{linkedInAdsConversionRules:[null,{loadLinkedInAdsConversionRules:async customerId=>(await api.ZP.integrations.linkedInAdsConversionRules(props.id,customerId)).conversionRules}],linkedInAdsAccounts:[null,{loadLinkedInAdsAccounts:async()=>(await api.ZP.integrations.linkedInAdsAccounts(props.id)).adAccounts}]}})]),getLinkedInAdsAccountOptions=linkedInAdsAccounts=>linkedInAdsAccounts?linkedInAdsAccounts.map(account=>({key:account.id.toString(),labelComponent:(0,jsx_runtime.jsxs)("span",{className:"flex items-center",children:[account.name," (",account.id.toString(),")"]}),label:`${account.name}`})):null,getLinkedInAdsConversionRuleOptions=linkedInAdsConversionRules=>linkedInAdsConversionRules?linkedInAdsConversionRules.map(_ref=>{let{id,name}=_ref;return{key:id.toString(),labelComponent:(0,jsx_runtime.jsxs)("span",{className:"flex items-center",children:[name," (",id,")"]}),label:`${name} (${id})`}}):null;function LinkedInAdsConversionRulePicker(_ref2){let{onChange,value,requiresFieldValue,integration,disabled}=_ref2,{linkedInAdsConversionRules,linkedInAdsConversionRulesLoading}=(0,index_esm.useValues)(linkedInAdsIntegrationLogic({id:integration.id})),{loadLinkedInAdsConversionRules}=(0,index_esm.useActions)(linkedInAdsIntegrationLogic({id:integration.id})),linkedInAdsConversionRuleOptions=(0,react.useMemo)(()=>getLinkedInAdsConversionRuleOptions(linkedInAdsConversionRules),[linkedInAdsConversionRules]);return(0,react.useEffect)(()=>{requiresFieldValue&&loadLinkedInAdsConversionRules(requiresFieldValue)},[loadLinkedInAdsConversionRules,requiresFieldValue]),(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.nt,{onChange:val=>{var _val$;return onChange?.(null!==(_val$=val[0])&&void 0!==_val$?_val$:null)},value:value?[value]:[],onFocus:()=>!linkedInAdsConversionRules&&!linkedInAdsConversionRulesLoading&&requiresFieldValue&&loadLinkedInAdsConversionRules(requiresFieldValue),disabled:disabled,mode:"single","data-attr":"select-linkedin-ads-conversion-action",placeholder:"Select a Conversion Action...",options:null!=linkedInAdsConversionRuleOptions?linkedInAdsConversionRuleOptions:value?[{key:value,label:value}]:[],loading:linkedInAdsConversionRulesLoading})})}function LinkedInAdsAccountIdPicker(_ref3){let{onChange,value,integration,disabled}=_ref3,{linkedInAdsAccounts,linkedInAdsAccountsLoading}=(0,index_esm.useValues)(linkedInAdsIntegrationLogic({id:integration.id})),{loadLinkedInAdsAccounts}=(0,index_esm.useActions)(linkedInAdsIntegrationLogic({id:integration.id})),linkedInAdsAccountOptions=(0,react.useMemo)(()=>getLinkedInAdsAccountOptions(linkedInAdsAccounts),[linkedInAdsAccounts]);return(0,react.useEffect)(()=>{disabled||loadLinkedInAdsAccounts()},[loadLinkedInAdsAccounts]),(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.nt,{onChange:val=>{var _val$2;return onChange?.(null!==(_val$2=val[0])&&void 0!==_val$2?_val$2:null)},value:value?[value]:[],onFocus:()=>!linkedInAdsAccounts&&!linkedInAdsAccountsLoading&&loadLinkedInAdsAccounts(),disabled:disabled,mode:"single","data-attr":"select-linkedin-ads-customer-id-channel",placeholder:"Select a Account ID...",options:null!=linkedInAdsAccountOptions?linkedInAdsAccountOptions:value?[{key:value,label:value.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3")}]:[],loading:linkedInAdsAccountsLoading})})}var SlackIntegrationHelpers=__webpack_require__("../../frontend/src/lib/integrations/SlackIntegrationHelpers.tsx");function CyclotronJobInputIntegrationField(_ref){let requiresFieldValue,{schema,value,onChange,configuration}=_ref,{integrationsLoading,integrations}=(0,index_esm.useValues)(integrationsLogic.a);if(integrationsLoading)return(0,jsx_runtime.jsx)(src.yW,{className:"h-10"});let relatedSchemaIntegration=configuration.inputs_schema?.find(input=>input.key===schema.integration_key);if(!relatedSchemaIntegration)return(0,jsx_runtime.jsxs)("div",{className:"text-danger",children:["Bad configuration: integration key ",schema.integration_key," not found in schema"]});let integrationId=configuration.inputs?.[relatedSchemaIntegration.key]?.value,integration=integrations?.find(integration=>integration.id===integrationId);if(schema.requires_field){let requiresFieldSchema=configuration.inputs_schema?.find(input=>input.key===schema.requires_field);if(!requiresFieldSchema)return(0,jsx_runtime.jsxs)("div",{className:"text-danger",children:["Bad configuration: required key ",schema.requires_field," not found in schema"]});let requiresField=configuration.inputs?.[requiresFieldSchema.key];if(!(requiresFieldValue=requiresField?.value))return(0,jsx_runtime.jsxs)("div",{className:"p-2 h-10 italic rounded border border-dashed text-secondary",children:["Configure ",requiresFieldSchema.label," to continue"]})}return integration?"slack_channel"===schema.integration_field?(0,jsx_runtime.jsx)(SlackIntegrationHelpers.a,{value:value,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):"google_ads_conversion_action"===schema.integration_field&&requiresFieldValue?(0,jsx_runtime.jsx)(GoogleAdsConversionActionPicker,{value:value,requiresFieldValue:requiresFieldValue,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):"google_ads_customer_id"===schema.integration_field?(0,jsx_runtime.jsx)(GoogleAdsCustomerIdPicker,{value:value,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):"linkedin_ads_conversion_rule_id"===schema.integration_field&&requiresFieldValue?(0,jsx_runtime.jsx)(LinkedInAdsConversionRulePicker,{value:value,requiresFieldValue:requiresFieldValue,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):"linkedin_ads_account_id"===schema.integration_field?(0,jsx_runtime.jsx)(LinkedInAdsAccountIdPicker,{value:value,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):"linear_team"===schema.integration_field?(0,jsx_runtime.jsx)(LinearTeamPicker,{value:value,onChange:x=>onChange?.(x),integration:integration}):(0,jsx_runtime.jsx)("div",{className:"text-danger",children:(0,jsx_runtime.jsxs)("p",{children:["Unsupported integration type: ",schema.integration]})}):(0,jsx_runtime.jsxs)("div",{className:"p-2 h-10 italic rounded border border-dashed text-secondary",children:["Configure ",relatedSchemaIntegration.label," to continue"]})}function CyclotronJobInputs(_ref){let{configuration,onInputSchemaChange,onInputChange,showSource}=_ref;if(!configuration.inputs_schema?.length)return(0,jsx_runtime.jsx)("span",{className:"italic text-secondary",children:"This function does not require any input variables."});let inputSchemas=configuration.inputs_schema,inputSchemaIds=inputSchemas.map(schema=>schema.key);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(core_esm.LB,{collisionDetection:core_esm.pE,onDragEnd:_ref2=>{let{active,over}=_ref2;if(over&&active.id!==over.id){let oldIndex=inputSchemaIds.indexOf(active.id),newIndex=inputSchemaIds.indexOf(over.id);onInputSchemaChange?.(sortable_esm.Rp(inputSchemas,oldIndex,newIndex))}},children:(0,jsx_runtime.jsx)(sortable_esm.Fo,{disabled:!showSource,items:inputSchemaIds,strategy:sortable_esm.qw,children:configuration.inputs_schema?.filter(i=>!i.hidden).map(schema=>jsx_runtime.jsx(CyclotronJobInputWithSchema,{schema:schema,configuration:configuration,onInputSchemaChange:onInputSchemaChange,onInputChange:onInputChange,showSource:showSource},schema.key))})})})}let typeList=["string","number","boolean","dictionary","choice","json","integration","email"];function JsonConfigField(props){var _props$input$templati;let key=(0,react.useMemo)(()=>`json_field_${(0,utils.Vj)()}`,[]),templatingKind=null!==(_props$input$templati=props.input.templating)&&void 0!==_props$input$templati?_props$input$templati:"hog",logic=cyclotronJobInputLogic({fieldKey:key,initialValue:props.input.value,onChange:value=>props.onChange?.({...props.input,value})}),{error,jsonValue}=(0,index_esm.useValues)(logic),{setJsonValue}=(0,index_esm.useActions)(logic),formattedValue=(0,react.useMemo)(()=>formatJsonValue(props.input.value),[props.input.value]),panels=[{key:1,header:"Click to edit",content:(0,jsx_runtime.jsx)(LemonField.D.Pure,{error:error,children:(0,jsx_runtime.jsxs)("span",{className:(0,clsx_m.default)("group relative",props.className),children:[(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:props.templating?"hog"===templatingKind?"hogJson":"liquid":"json",value:formattedValue,embedded:!0,onChange:value=>setJsonValue(value||"{}"),options:{lineNumbers:"off",minimap:{enabled:!1},scrollbar:{vertical:"hidden",verticalScrollbarSize:0}},globals:props.templating?props.sampleGlobalsWithInputs:void 0}),props.templating?(0,jsx_runtime.jsx)("span",{className:"absolute top-0 right-0 z-10 p-px opacity-0 transition-opacity group-hover:opacity-100",children:(0,jsx_runtime.jsx)(CyclotronJobTemplateSuggestionsButton,{templating:templatingKind,value:jsonValue,setTemplating:templating=>props.onChange?.({...props.input,templating}),onOptionSelect:option=>{(0,copyToClipboard.v)(`{${option.example}}`,"template code")}})}):null]})}),className:"p-0"}];return(0,jsx_runtime.jsx)(src.JL,{embedded:!1,panels:panels,size:"xsmall"})}function EmailTemplateField(_ref3){let{value,onChange,sampleGlobalsWithInputs}=_ref3;return(0,jsx_runtime.jsx)(EmailTemplater.N,{variables:sampleGlobalsWithInputs,value:value,onChange:onChange})}function CyclotronJobTemplateInput(props){var _props$input$templati2,_props$input$value;let templating=null!==(_props$input$templati2=props.input.templating)&&void 0!==_props$input$templati2?_props$input$templati2:"hog";return props.templating?(0,jsx_runtime.jsxs)("span",{className:(0,clsx_m.default)("group relative",props.className),children:[(0,jsx_runtime.jsx)(CodeEditorInline.s,{minHeight:"37",value:null!==(_props$input$value=props.input.value)&&void 0!==_props$input$value?_props$input$value:"",onChange:val=>props.onChange?.({...props.input,value:null!=val?val:""}),language:"hog"===props.input.templating?"hogTemplate":"liquid",globals:props.sampleGlobalsWithInputs}),(0,jsx_runtime.jsx)("span",{className:"absolute top-0 right-0 z-10 p-px opacity-0 transition-opacity group-hover:opacity-100",children:(0,jsx_runtime.jsx)(CyclotronJobTemplateSuggestionsButton,{templating:templating,value:props.input.value,setTemplating:templating=>props.onChange?.({...props.input,templating}),onOptionSelect:option=>{props.onChange?.({...props.input,value:`${props.input.value} {${option.example}}`})}})})]}):(0,jsx_runtime.jsx)(src.DF,{type:"text",value:props.input.value,onChange:val=>props.onChange?.({...props.input,value:val})})}function DictionaryField(_ref4){var _input$value;let{input,onChange,templating}=_ref4,value=null!==(_input$value=input.value)&&void 0!==_input$value?_input$value:{},[entries,setEntries]=(0,react.useState)(Object.entries(value)),prevFilteredEntriesRef=(0,react.useRef)(entries);return(0,react.useEffect)(()=>{let filteredEntries=entries.filter(_ref5=>{let[key,val]=_ref5;return""!==key.trim()||""!==val.trim()});if((0,utils.h0)(filteredEntries,prevFilteredEntriesRef.current))return;prevFilteredEntriesRef.current=filteredEntries;let val=Object.fromEntries(filteredEntries);onChange?.({...input,value:val})},[entries,onChange]),(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[entries.map((_ref6,index)=>{let[key,val]=_ref6;return(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,jsx_runtime.jsx)(src.DF,{value:key,className:"flex-1 min-w-60",onChange:key=>{let newEntries=[...entries];newEntries[index]=[key,newEntries[index][1]],setEntries(newEntries)},placeholder:"Key"}),(0,jsx_runtime.jsx)(CyclotronJobTemplateInput,{className:"overflow-hidden flex-2",input:{...input,value:val},onChange:val=>{var _val$value;let newEntries=[...entries];newEntries[index]=[newEntries[index][0],null!==(_val$value=val.value)&&void 0!==_val$value?_val$value:""],val.templating&&onChange?.({...input,templating:val.templating}),setEntries(newEntries)},templating:templating}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),size:"small",onClick:()=>{let newEntries=[...entries];newEntries.splice(index,1),setEntries(newEntries)}})]},index)}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),size:"small",type:"secondary",onClick:()=>{setEntries([...entries,["",""]])},children:"Add entry"})]})}function CyclotronJobInputRenderer(_ref7){var _schema$templating,_schema$choices;let{onChange,schema,disabled,input,configuration}=_ref7,templating=null===(_schema$templating=schema.templating)||void 0===_schema$templating||_schema$templating,onValueChange=value=>onChange?.({...input,value});switch(schema.type){case"string":return(0,jsx_runtime.jsx)(CyclotronJobTemplateInput,{input:input,onChange:disabled?()=>{}:onChange,className:"ph-no-capture",templating:templating});case"number":return(0,jsx_runtime.jsx)(src.DF,{type:"number",value:input.value,onChange:onValueChange,className:"ph-no-capture"});case"json":return(0,jsx_runtime.jsx)(JsonConfigField,{input:input,onChange:onChange,className:"ph-no-capture",templating:templating});case"choice":return(0,jsx_runtime.jsx)(src.Yv,{fullWidth:!0,value:input.value,className:"ph-no-capture",onChange:onValueChange,options:null!==(_schema$choices=schema.choices)&&void 0!==_schema$choices?_schema$choices:[],disabled:disabled});case"dictionary":return(0,jsx_runtime.jsx)(DictionaryField,{input:input,onChange:onChange,templating:templating});case"boolean":return(0,jsx_runtime.jsx)(src.f4,{checked:input.value,onChange:checked=>onValueChange(checked),disabled:disabled});case"integration":return(0,jsx_runtime.jsx)(CyclotronJobInputIntegration,{schema:schema,value:input.value,onChange:onValueChange});case"integration_field":return(0,jsx_runtime.jsx)(CyclotronJobInputIntegrationField,{schema:schema,value:input.value,onChange:onValueChange,configuration:configuration});case"email":return(0,jsx_runtime.jsx)(EmailTemplateField,{schema:schema,value:input.value,onChange:onValueChange});default:return(0,jsx_runtime.jsxs)("strong",{className:"text-danger",children:['Unknown field type "',(0,jsx_runtime.jsx)("code",{children:schema.type}),'".']})}}function CyclotronJobInputSchemaControls(_ref8){let{value,onChange,onDone,configuration}=_ref8,_onChange=data=>{if(data?.key?.length===0){setLocalVariableError("Input variable name cannot be empty");return}onChange(data?{...value,...data}:null)},[localVariableValue,setLocalVariableValue]=(0,react.useState)(value.key),[localVariableError,setLocalVariableError]=(0,react.useState)(null);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap flex-1 gap-2 items-center",children:[(0,jsx_runtime.jsx)(src.Yv,{size:"small",options:typeList.map(type=>({label:(0,utils.fm)(type),value:type})),value:value.type,className:"w-30",onChange:type=>_onChange({type})}),(0,jsx_runtime.jsx)(src.Hw,{size:"small",checked:value.required,onChange:required=>_onChange({required}),label:"Required",bordered:!0}),(0,jsx_runtime.jsx)(src.Hw,{size:"small",checked:value.secret,onChange:secret=>_onChange({secret}),label:"Secret",bordered:!0}),(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconTrash,{}),size:"small",onClick:()=>onChange(null)}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>onDone(),children:"Done"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap flex-1 gap-2",children:[(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Display label",children:(0,jsx_runtime.jsx)(src.DF,{className:"min-w-60",size:"small",value:value.label,onChange:label=>_onChange({label}),placeholder:"Display label"})}),(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Input variable name",error:localVariableError,children:(0,jsx_runtime.jsx)(src.DF,{size:"small",value:localVariableValue,onChange:key=>setLocalVariableValue(key),onBlur:()=>_onChange({key:localVariableValue}),placeholder:"Variable name"})})]}),(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Description",children:(0,jsx_runtime.jsx)(src._V,{minRows:1,value:value.description,onChange:description=>_onChange({description}),placeholder:"Description"})}),"choice"===value.type&&(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Choices",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,value:value.choices?.map(choice=>choice.value),onChange:choices=>_onChange({choices:choices.map(value=>({label:value,value}))}),placeholder:"Choices"})}),"integration"===value.type&&(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Integration kind",children:(0,jsx_runtime.jsx)(src.Yv,{value:value.integration,onChange:integration=>_onChange({integration}),options:[{label:"Slack",value:"slack"},{label:"Salesforce",value:"salesforce"},{label:"Hubspot",value:"hubspot"}],placeholder:"Choose kind"})}),(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Default value",children:(0,jsx_runtime.jsx)(CyclotronJobInputRenderer,{schema:value,input:{value:value.default},onChange:val=>_onChange({default:val.value}),configuration:configuration})})]})}function CyclotronJobInputWithSchema(_ref9){var _configuration$inputs;let{schema,configuration,onInputSchemaChange,onInputChange,showSource}=_ref9,{attributes,listeners,setNodeRef,transform,transition}=(0,sortable_esm.nB)({id:schema.key}),[editing,setEditing]=(0,react.useState)(!1),value=null!==(_configuration$inputs=configuration.inputs?.[schema.key])&&void 0!==_configuration$inputs?_configuration$inputs:{value:null};return(0,react.useEffect)(()=>{showSource||setEditing(!1)},[showSource]),(0,jsx_runtime.jsx)("div",{ref:setNodeRef,style:{transform:utilities_esm.ux.Transform.toString(transform),transition},children:editing?(0,jsx_runtime.jsx)("div",{className:"p-2 rounded border border-dashed deprecated-space-y-4",children:(0,jsx_runtime.jsx)(CyclotronJobInputSchemaControls,{value:schema,onChange:newSchema=>{let inputsSchema=configuration.inputs_schema||[];if(newSchema){let modifiedSchema={...schema,...newSchema};inputsSchema=inputsSchema.map(s=>s.key===schema.key?modifiedSchema:s)}else inputsSchema=inputsSchema.filter(s=>s.key!==schema.key);newSchema?.key&&onInputChange?.(newSchema.key,value),newSchema?.type&&newSchema.type!==schema.type&&onInputChange?.(schema.key,{value:null}),onInputSchemaChange?.(inputsSchema)},onDone:()=>setEditing(!1),configuration:configuration})}):(0,jsx_runtime.jsx)(LemonField.D,{name:`inputs.${schema.key}`,help:schema.description,children:_ref10=>{let{value,onChange:_onChange}=_ref10,onChange=newValue=>{_onChange({...value,...newValue})};return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,jsx_runtime.jsxs)(src.HQ,{className:showSource?"cursor-grab":"",showOptional:!schema.required,...attributes,...listeners,children:[schema.label||schema.key,schema.secret?(0,jsx_runtime.jsx)(src.u,{title:"This input is marked as secret. It will be encrypted and not visible after saving.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconLock,{})}):void 0]}),showSource&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",className:"font-mono",children:["inputs.",schema.key]}),(0,jsx_runtime.jsx)("div",{className:"flex-1"}),showSource&&(0,jsx_runtime.jsx)(src.Jp,{size:"small",noPadding:!0,icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGear,{}),onClick:()=>setEditing(!0)})]}),value?.secret?(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center p-1 rounded border border-dashed",children:[(0,jsx_runtime.jsx)("span",{className:"flex-1 p-1 italic text-secondary",children:"This value is secret and is not displayed here."}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{onChange({value:""})},size:"small",type:"secondary",children:"Edit"})]}):(0,jsx_runtime.jsx)(CyclotronJobInputRenderer,{schema:schema,input:null!=value?value:{value:""},onChange:onChange,configuration:configuration})]})}})})}var NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),PayGateButton=__webpack_require__("../../frontend/src/lib/components/PayGateMini/PayGateButton.tsx"),PayGateMini=__webpack_require__("../../frontend/src/lib/components/PayGateMini/PayGateMini.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),useFeatureFlag=__webpack_require__("../../frontend/src/lib/hooks/useFeatureFlag.ts"),More=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/More.tsx"),hogFunctionConfigurationLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),editor_main=__webpack_require__("../../node_modules/.pnpm/monaco-editor@0.49.0/node_modules/monaco-editor/esm/vs/editor/editor.main.js"),hogFunctionTestLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionTestLogic.tsx");function HogFunctionTestPlaceholder(_ref){let{title,description}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"p-3 space-y-2 rounded border bg-accent-3000",children:[(0,jsx_runtime.jsx)("h2",{className:"flex-1 m-0",children:title||"Testing"}),(0,jsx_runtime.jsx)("p",{children:description||"Save your configuration to enable testing"})]})}let HogFunctionTestEditor=_ref2=>{let{value,onChange,readOnly=!1}=_ref2,editorRef=(0,react.useRef)(null),decorationsRef=(0,react.useRef)([]),handleValidation=newValue=>{if(!editorRef.current?.getModel())return;let model=editorRef.current.getModel();editor_main.editor.setModelMarkers(model,"owner",[]),decorationsRef.current=editorRef.current.deltaDecorations(decorationsRef.current,[]);try{JSON.parse(newValue)}catch(err){let match=err.message.match(/position (\d+)/);if(match){let position=parseInt(match[1],10),pos=model.getPositionAt(position);editor_main.editor.setModelMarkers(model,"owner",[{startLineNumber:pos.lineNumber,startColumn:pos.column,endLineNumber:pos.lineNumber,endColumn:pos.column+1,message:err.message,severity:editor_main.MarkerSeverity.Error}]),decorationsRef.current=editorRef.current.deltaDecorations(decorationsRef.current,[{range:{startLineNumber:pos.lineNumber,startColumn:1,endLineNumber:pos.lineNumber,endColumn:model.getLineLength(pos.lineNumber)+1},options:{isWholeLine:!0,className:"bg-danger-highlight",glyphMarginClassName:"text-danger flex items-center justify-center",glyphMarginHoverMessage:{value:err.message}}}]),editorRef.current.revealLineInCenter(pos.lineNumber)}}};return(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",value:value,height:400,onChange:newValue=>{readOnly||(onChange?.(newValue),handleValidation(null!=newValue?newValue:""))},onMount:editor=>{editorRef.current=editor,handleValidation(value)},options:{lineNumbers:"on",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"auto",verticalScrollbarSize:14},folding:!0,glyphMargin:!0,readOnly:readOnly}})};function HogFunctionTest(){var _testResult$logs;let{logicProps,canLoadSampleGlobals}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{isTestInvocationSubmitting,testResult,expanded,sampleGlobalsLoadingAndNotCancelled,sampleGlobalsError,type,savedGlobals,testInvocation,testResultMode,sortedTestsResult,jsonError}=(0,index_esm.useValues)((0,hogFunctionTestLogic.g)(logicProps)),{submitTestInvocation,setTestResult,toggleExpanded,loadSampleGlobals,deleteSavedGlobals,setSampleGlobals,saveGlobals,setTestResultMode,cancelSampleGlobalsLoading}=(0,index_esm.useActions)((0,hogFunctionTestLogic.g)(logicProps)),testResultsRef=(0,react.useRef)(null),inactive=!expanded;return(0,jsx_runtime.jsxs)(lib.Form,{logic:hogFunctionTestLogic.g,props:logicProps,formKey:"testInvocation",enableFormOnSubmit:!0,children:[(0,jsx_runtime.jsxs)("div",{ref:testResultsRef,className:(0,clsx_m.default)("p-3 rounded border deprecated-space-y-2",expanded?"bg-surface-primary":"bg-surface-secondary",expanded?"min-h-120":""),children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-end items-center",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("h2",{className:"flex gap-2 items-center mb-0",children:(0,jsx_runtime.jsx)("span",{children:"Testing"})}),inactive?(0,jsx_runtime.jsx)("p",{children:"Click here to test your function with an example event"}):null]}),inactive?(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"expand-hog-testing",type:"secondary",onClick:()=>{toggleExpanded(),setTimeout(()=>{testResultsRef.current?.scrollIntoView({behavior:"smooth",block:"start"})},100)},children:"Start testing"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[testResult?(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>setTestResult(null),loading:isTestInvocationSubmitting,"data-attr":"clear-hog-test-result",children:"Clear test result"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(More.T,{dropdown:{closeOnClickInside:!1},overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"mock_async_functions",children:_ref3=>{let{value,onChange}=_ref3;return(0,jsx_runtime.jsx)(src.f4,{onChange:v=>onChange(!v),checked:!value,"data-attr":"toggle-hog-test-mocking",className:"px-2 py-1",label:(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"When disabled, async functions such as `fetch` will not be called. Instead they will be mocked out and logged."}),children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2",children:["Make real HTTP requests",(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-lg"})]})})})}}),(0,jsx_runtime.jsx)(src.p2,{}),savedGlobals.map((_ref4,index)=>{let{name,globals}=_ref4;return(0,jsx_runtime.jsxs)("div",{className:"flex justify-between w-full",children:[(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"open-hog-test-data",onClick:()=>setSampleGlobals(globals),fullWidth:!0,className:"flex-1",children:name},index),(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"delete-hog-test-data",size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>deleteSavedGlobals(index),tooltip:"Delete saved test data"})]},index)}),testInvocation.globals&&(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,"data-attr":"save-hog-test-data",onClick:()=>{let name=prompt("Name this test data");name&&saveGlobals(name,JSON.parse(testInvocation.globals))},disabledReason:(()=>{try{JSON.parse(testInvocation.globals)}catch(e){return"Invalid globals JSON"}})(),children:"Save test data"})]})}),canLoadSampleGlobals?(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>{sampleGlobalsLoadingAndNotCancelled?cancelSampleGlobalsLoading():loadSampleGlobals()},tooltip:"Find the last event matching filters, and use it to populate the globals below.",icon:sampleGlobalsLoadingAndNotCancelled?(0,jsx_runtime.jsx)(src.$j,{}):void 0,children:sampleGlobalsLoadingAndNotCancelled?"Cancel loading":"Load new event"}):null,(0,jsx_runtime.jsx)(src.Jp,{type:"primary","data-attr":"test-hog-function",onClick:submitTestInvocation,loading:isTestInvocationSubmitting,children:"Test function"})]}),expanded&&(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"hide-hog-testing",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>toggleExpanded(),tooltip:"Hide testing"})]})]}),expanded?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:testResult?(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2","data-attr":"test-results",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"success"===testResult.status?"success":"skipped"===testResult.status?"warning":"error",children:"success"===testResult.status?"Success":"skipped"===testResult.status?`${type.charAt(0).toUpperCase()+type.slice(1)} was skipped because the event did not match the filter criteria`:"Error"}),"transformation"===type&&"error"!==testResult.status?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-between items-center",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Transformation result"}),sortedTestsResult?.hasDiff&&(0,jsx_runtime.jsx)(src.P4,{size:"xsmall",options:[{value:"raw",label:"Output"},{value:"diff",label:"Diff"}],onChange:value=>setTestResultMode(value),value:testResultMode})]}),(0,jsx_runtime.jsx)("p",{children:"Below you can see the event after the transformation has been applied."}),testResult.result?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!sortedTestsResult?.hasDiff&&(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:"skipped"===testResult.status?"The event was not modified as it did not match the filter criteria.":"The event was unmodified by the transformation."}),(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",originalValue:sortedTestsResult?.hasDiff&&"diff"===testResultMode?sortedTestsResult?.input:void 0,value:sortedTestsResult?.output,height:400,options:{readOnly:!0,lineNumbers:"off",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"hidden",verticalScrollbarSize:0},folding:!0}})]}):(0,jsx_runtime.jsx)(src.Vp,{type:"warning",children:"The event was dropped by the transformation. If this is expected then great news! If not, you should double check the configuration."})]}):null,(0,jsx_runtime.jsx)(src.HQ,{children:"Test invocation logs"}),(0,jsx_runtime.jsx)(src.g3,{dataSource:null!==(_testResult$logs=testResult.logs)&&void 0!==_testResult$logs?_testResult$logs:[],columns:[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:timestamp=>(0,jsx_runtime.jsx)(TZLabel.w,{time:timestamp}),width:0},{width:100,title:"Level",key:"level",dataIndex:"level"},{title:"Message",key:"message",dataIndex:"message",render:message=>(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}],className:"ph-no-capture",rowKey:"timestamp",pagination:{pageSize:200,hideOnSinglePage:!0}})]}):(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"globals",children:_ref5=>{let{value,onChange}=_ref5;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"broadcast"===type?"The test broadcast will be sent with this sample data:":"Here are all the global variables you can use in your code:"}),sampleGlobalsError?(0,jsx_runtime.jsx)("div",{className:"text-warning",children:sampleGlobalsError}):null]}),(0,jsx_runtime.jsx)(HogFunctionTestEditor,{value:value,onChange:onChange,readOnly:sampleGlobalsLoadingAndNotCancelled})]})}})})}):null]}),jsonError&&(0,jsx_runtime.jsxs)(src.Vp,{type:"error",children:["JSON Error: ",jsonError]})]})}var urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts");function HogFunctionMessageTesting(){let{logicProps,configurationChanged}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{isTestInvocationSubmitting,testResult}=(0,index_esm.useValues)((0,hogFunctionTestLogic.g)(logicProps)),{submitTestInvocation}=(0,index_esm.useActions)((0,hogFunctionTestLogic.g)(logicProps)),getTestMessageGlobals=email=>({event:{event:"$broadcast",elements_chain:"",timestamp:(0,dayjs.Bv)().toISOString()},person:{properties:{email}}});return(0,jsx_runtime.jsx)(HogFunctionTestPlaceholder,{title:"Test broadcast",description:(0,jsx_runtime.jsxs)(lib.Form,{logic:hogFunctionTestLogic.g,props:logicProps,formKey:"testInvocation",enableFormOnSubmit:!0,children:[(0,jsx_runtime.jsx)("p",{children:"Test your broadcast message with a sample email before sending it to your users."}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-end",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"globals",className:"flex-1",children:_ref=>{let{value,onChange}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.DF,{type:"email",placeholder:"test@example.com",value:value?.person?.properties?.email,onChange:value=>{onChange(JSON.stringify({...getTestMessageGlobals(value)}))}})})}}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:submitTestInvocation,loading:isTestInvocationSubmitting,disabledReason:configurationChanged?"Save or clear changes to test broadcast":void 0,children:"Test broadcast"})]}),testResult&&(0,jsx_runtime.jsx)(src.Vp,{type:"success"===testResult.status?"success":"skipped"===testResult.status?"warning":"error",className:"mt-2",children:"success"===testResult.status?"Success":"skipped"===testResult.status?"Broadcast was skipped because the event did not match the filter criteria":"Error"})]})})}function HogFunctionBroadcastDelivery(){let{logicProps,configurationChanged,personsCount,personsCountLoading,personsListQuery,broadcastLoading}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{sendBroadcast}=(0,index_esm.useActions)((0,hogFunctionConfigurationLogic.nM)(logicProps)),{id}=logicProps;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(HogFunctionMessageTesting,{}),(0,jsx_runtime.jsx)(HogFunctionTestPlaceholder,{title:"Send broadcast",description:id&&"new"!==id?(0,jsx_runtime.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,jsx_runtime.jsxs)(src.Jp,{type:"primary",onClick:()=>{src.dn.open({title:"Confirm Broadcast",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("p",{children:["Emails will be sent to"," ",(0,jsx_runtime.jsxs)(src.rU,{to:(0,kea_router_lib.combineUrl)(urls.j.activity(),{},{q:personsListQuery}).url,target:"_blank",children:[personsCount," person",(0,jsx_runtime.jsx)("span",{children:1===personsCount?"":"s"})," matching the filters."]})]}),(0,jsx_runtime.jsx)("p",{children:"Are you sure you want to send this broadcast?"})]}),primaryButton:{children:"Send",onClick:sendBroadcast},secondaryButton:{children:"Cancel"}})},loading:personsCountLoading||broadcastLoading,disabledReason:configurationChanged?"Save or clear changes to send broadcast":void 0,children:["Send to ",personsCount," email",(0,jsx_runtime.jsx)("span",{children:1===personsCount?"":"s"})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("strong",{children:"Please note:"})," Clicking the button above will synchronously send to all the e-mails. While this is fine for testing with small lists, please don't use this for production use cases yet."]})]}):(0,jsx_runtime.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,jsx_runtime.jsxs)(src.Jp,{type:"primary",disabledReason:"Must save to send broadcast",children:["Send to ",personsCount," email",(0,jsx_runtime.jsx)("span",{children:1===personsCount?"":"s"})]}),(0,jsx_runtime.jsx)("div",{children:"Save your configuration to send a broadcast. Nothing will be sent until you manually send the broadcast above."})]})})]})}var HogFunctionFilters=__webpack_require__("../../frontend/src/scenes/hog-functions/filters/HogFunctionFilters.tsx"),types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),ActionFilter=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts"),src_types=__webpack_require__("../../frontend/src/types.ts");let humanize=value=>("string"==typeof value&&null!=value?value:"").toLowerCase().replace(/_/g," ").replace(/-/g," ").replace(/\b\w/g,char=>char.toUpperCase()),MappingSummary=(0,react.memo)(function MappingSummary(_ref){var _mapping$filters$even,_mapping$filters$acti,_mapping$filters$even2,_mapping$filters$acti2,_ref2;let{mapping}=_ref,events=null!==(_mapping$filters$even=mapping.filters?.events?.map(event=>{var _event$name;return null!==(_event$name=event.name)&&void 0!==_event$name?_event$name:event.id}))&&void 0!==_mapping$filters$even?_mapping$filters$even:[],actions=null!==(_mapping$filters$acti=mapping.filters?.actions?.map(action=>{var _action$name;return null!==(_action$name=action.name)&&void 0!==_action$name?_action$name:action.id}))&&void 0!==_mapping$filters$acti?_mapping$filters$acti:[],propertyFiltersCount=(null!==(_mapping$filters$even2=mapping.filters?.events?.filter(event=>{var _event$properties$len;return null!==(_event$properties$len=event.properties?.length)&&void 0!==_event$properties$len?_event$properties$len:0}))&&void 0!==_mapping$filters$even2?_mapping$filters$even2:[]).length+(null!==(_mapping$filters$acti2=mapping.filters?.actions?.filter(action=>{var _action$properties$le;return null!==(_action$properties$le=action.properties?.length)&&void 0!==_action$properties$le?_action$properties$le:0}))&&void 0!==_mapping$filters$acti2?_mapping$filters$acti2:[]).length,eventSummary=[...events,...actions].join(", "),firstInput=mapping.inputs_schema?.[0],firstInputValue=null!==(_ref2=firstInput?.key?mapping.inputs?.[firstInput.key]?.value:null)&&void 0!==_ref2?_ref2:"(custom value)";return(0,jsx_runtime.jsxs)("span",{className:"flex flex-1 gap-4 items-center",children:[(0,jsx_runtime.jsxs)("span",{children:[eventSummary?humanize(eventSummary):(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:"All events"})," ",propertyFiltersCount?(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:(0,jsx_runtime.jsx)(src.u,{title:`Events have ${propertyFiltersCount} additional filters`,children:(0,jsx_runtime.jsx)(posthog_icons_es.IconFilter,{})})}):null]}),(0,jsx_runtime.jsx)(posthog_icons_es.IconArrowRight,{className:"text-secondary"}),(0,jsx_runtime.jsx)("span",{children:mapping.name?humanize(mapping.name):"object"==typeof firstInputValue?JSON.stringify(firstInputValue):humanize(firstInputValue)}),(0,jsx_runtime.jsx)("span",{className:"flex-1"}),mapping.disabled?(0,jsx_runtime.jsx)(src.oe,{type:"danger",children:"Disabled"}):null]})});function HogFunctionMapping(_ref3){var _mapping$filters,_mapping$inputs_schem,_mapping$inputs;let{index,mapping,onChange}=_ref3,{groupsTaxonomicTypes}=(0,index_esm.useValues)(groupsModel.$),{showSource}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"p-3 pl-10 deprecated-space-y-2",children:[mapping.disabled?(0,jsx_runtime.jsx)(src.Vp,{type:"warning",className:"p-2",action:{children:"Enable",onClick:()=>onChange({...mapping,disabled:!1})},children:"This mapping is disabled. It will not trigger the function."}):null,(0,jsx_runtime.jsx)(src.HQ,{children:"Match events and actions"}),(0,jsx_runtime.jsx)(ActionFilter.T,{filters:null!==(_mapping$filters=mapping.filters)&&void 0!==_mapping$filters?_mapping$filters:{},setFilters:f=>onChange({...mapping,filters:f}),typeKey:"match-group",mathAvailability:ActionFilterRow.Qq.None,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:[types.t.Events,types.t.Actions],propertiesTaxonomicGroupTypes:[types.t.EventProperties,types.t.EventFeatureFlags,types.t.Elements,types.t.PersonProperties,types.t.HogQLExpression,...groupsTaxonomicTypes],propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:src_types.DC.EVENTS},buttonProps:{type:"secondary"},buttonCopy:"Add event matcher"}),(0,jsx_runtime.jsx)(lib.Group,{name:["mappings",index],children:(0,jsx_runtime.jsx)(CyclotronJobInputs,{configuration:{inputs_schema:null!==(_mapping$inputs_schem=mapping.inputs_schema)&&void 0!==_mapping$inputs_schem?_mapping$inputs_schem:[],inputs:null!==(_mapping$inputs=mapping.inputs)&&void 0!==_mapping$inputs?_mapping$inputs:{}},onInputSchemaChange:schema=>{onChange({...mapping,inputs_schema:schema})},onInputChange:(key,value)=>{onChange({...mapping,inputs:{...mapping.inputs,[key]:value}})},showSource:showSource})}),showSource?(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),size:"small",type:"secondary",className:"my-4",onClick:()=>{var _mapping$inputs_schem2,_mapping$inputs_schem3;onChange({...mapping,inputs_schema:[...null!==(_mapping$inputs_schem2=mapping.inputs_schema)&&void 0!==_mapping$inputs_schem2?_mapping$inputs_schem2:[],{type:"string",key:`var_${(null!==(_mapping$inputs_schem3=mapping.inputs_schema?.length)&&void 0!==_mapping$inputs_schem3?_mapping$inputs_schem3:0)+1}`,label:"",required:!1}]})},children:"Add input variable"}):null]})})}function HogFunctionMappings(){let{useMapping,mappingTemplates,configuration}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),[activeKeys,setActiveKeys]=(0,react.useState)([]);return((0,react.useEffect)(()=>{configuration.mappings?.length===1&&setActiveKeys([0])},[configuration.mappings?.length]),useMapping)?(0,jsx_runtime.jsx)(LemonField.D,{name:"mappings",children:_ref4=>{let{value,onChange}=_ref4,addMapping=template=>{let mappingTemplate=mappingTemplates.find(t=>t.name===template);if(mappingTemplate){let{name,...mapping}=mappingTemplate,inputs=mapping.inputs_schema?Object.fromEntries(mapping.inputs_schema.filter(m=>void 0!==m.default).map(m=>[m.key,{value:structuredClone(m.default)}])):{};onChange([...value,{...mapping,name,inputs}]),setActiveKeys([...activeKeys,value.length])}},duplicateMapping=mapping=>{let index=value.findIndex(m=>m===mapping);if(-1!==index){let newMappings=[...value];newMappings.splice(index+1,0,mapping),onChange(newMappings),setActiveKeys([index+1])}},removeMapping=mapping=>{let index=value.findIndex(m=>m===mapping);-1!==index&&(onChange(value.filter((_,i)=>i!==index)),setActiveKeys(activeKeys.filter(i=>i!==index)))},toggleDisabled=mapping=>{let index=value.findIndex(m=>m===mapping);-1!==index&&onChange(value.map((m,i)=>i===index?{...m,disabled:!m.disabled}:m))},renameMapping=mapping=>{src.dn.openForm({title:"Rename mapping",initialValues:{mappingName:mapping.name},content:(0,jsx_runtime.jsx)(LemonField.D,{name:"mappingName",children:(0,jsx_runtime.jsx)(src.DF,{"data-attr":"mapping-name",placeholder:"Please enter the new name",autoFocus:!0})}),errors:{mappingName:name=>name?void 0:"You must enter a name"},onSubmit:async _ref5=>{let{mappingName}=_ref5,index=value.findIndex(m=>m===mapping);-1!==index&&onChange(value.map((m,i)=>i===index?{...m,name:mappingName}:m))}})},addMappingButton=mappingTemplates.length?(0,jsx_runtime.jsx)(src.Yv,{placeholder:"Add mapping",onChange:template=>{addMapping(template)},options:mappingTemplates.map(t=>({label:t.name,value:t.name}))}):null;return(0,jsx_runtime.jsxs)("div",{className:"p-3 rounded border bg-surface-primary",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-start",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Mappings"}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-secondary",children:"Configure which events should act as triggers including filters and custom transformations"})]}),addMappingButton]}),(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:value.length?(0,jsx_runtime.jsx)("div",{className:"-mx-3 border-t border-b",children:(0,jsx_runtime.jsx)(src.JL,{multiple:!0,embedded:!0,activeKeys:activeKeys,onChange:activeKeys=>setActiveKeys(activeKeys),panels:value.map((mapping,index)=>({key:index,header:{children:(0,jsx_runtime.jsx)(MappingSummary,{mapping:mapping}),sideAction:{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{}),dropdown:{overlay:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-px",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>toggleDisabled(mapping),children:mapping.disabled?"Enable":"Disable"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>renameMapping(mapping),children:"Rename"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>duplicateMapping(mapping),children:"Duplicate"}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",onClick:()=>removeMapping(mapping),children:"Remove"})]})}}},className:"p-0 bg-accent-light",content:(0,jsx_runtime.jsx)(HogFunctionMapping,{index:index,mapping:mapping,onChange:mapping=>{mapping?onChange(value.map((m,i)=>i===index?mapping:m)):onChange(value.filter((_,i)=>i!==index))}},index)}))})}):(0,jsx_runtime.jsx)(src.Vp,{type:"warning",className:"p-2",children:"You have no mappings configured which effectively means the function is disabled as there is nothing to trigger it."})})]})}}):null}var Sparkline=__webpack_require__("../../frontend/src/lib/components/Sparkline.tsx"),LemonBanner=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonBanner/index.ts"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),Query=__webpack_require__("../../frontend/src/queries/Query/Query.tsx");function HogFunctionEventEstimates(){var _sparkline$count,_sparkline$count2;let{sparkline,sparklineLoading,eventsDataTableNode,showEventsList,type}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{setShowEventsList}=(0,index_esm.useActions)(hogFunctionConfigurationLogic.nM);if(!eventsDataTableNode)return null;let dataTableNode={...eventsDataTableNode,full:!0},insightUrl=urls.j.insightNew({type:src_types.dw.SQL,query:dataTableNode}),canvasUrl=urls.j.canvas()+"#🦔="+btoa(JSON.stringify({type:"doc",content:[{type:"ph-query",attrs:{query:dataTableNode}}]}));return(0,jsx_runtime.jsxs)("div",{className:"relative p-3 deprecated-space-y-2 border rounded bg-surface-primary",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Matching events"}),sparkline&&!sparklineLoading?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[sparkline.count>8e3&&"transformation"!==type?(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"warning",children:[(0,jsx_runtime.jsx)("b",{children:"Warning:"})," This destination would have triggered"," ",(0,jsx_runtime.jsxs)("strong",{children:[null!==(_sparkline$count=sparkline.count)&&void 0!==_sparkline$count?_sparkline$count:0," time",1!==sparkline.count?"s":""]})," ","in the last 7 days. Consider the impact of this function on your destination."]}):(0,jsx_runtime.jsxs)("p",{children:["This ",type," would have triggered"," ",(0,jsx_runtime.jsxs)("strong",{children:[null!==(_sparkline$count2=sparkline.count)&&void 0!==_sparkline$count2?_sparkline$count2:0," time",1!==sparkline.count?"s":""]})," ","in the last 7 days."]}),"warning"in sparkline&&sparkline.warning&&(0,jsx_runtime.jsx)(LemonBanner.V,{type:"info",children:sparkline.warning}),(0,jsx_runtime.jsx)(Sparkline.b,{type:"bar",className:"w-full h-20",data:sparkline.data,labels:sparkline.labels})]}):sparklineLoading?(0,jsx_runtime.jsx)("div",{className:"min-h-20",children:(0,jsx_runtime.jsx)(src.t2,{})}):(0,jsx_runtime.jsx)("p",{children:"The expected volume could not be calculated"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 pt-2 border-t border-dashed",children:[(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>setShowEventsList(!showEventsList),fullWidth:!0,center:!0,children:showEventsList?"Hide matching events":"Show matching events"}),showEventsList?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex items-start justify-end",children:(0,jsx_runtime.jsx)(src.Yv,{placeholder:"Open in...",onChange:target=>{"insight"===target?window.open(insightUrl,"_blank"):"canvas"===target&&window.open(canvasUrl,"_blank")},options:[{label:"New insight",value:"insight"},{label:"New canvas",value:"canvas"}]})}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col flex-1 overflow-y-auto border rounded max-h-200",children:eventsDataTableNode&&(0,jsx_runtime.jsx)(Query.A,{query:{...eventsDataTableNode,full:!1,showEventFilter:!1,showPropertyFilter:!1,embedded:!0,showOpenEditorButton:!1,showHogQLEditor:!1,showTimings:!1}})})]}):null]})]})}var MaxTool=__webpack_require__("../../frontend/src/scenes/max/MaxTool.tsx"),HogFunctionStatusIndicator=__webpack_require__("../../frontend/src/scenes/hog-functions/misc/HogFunctionStatusIndicator.tsx"),HogFunctionStatusTag=__webpack_require__("../../frontend/src/scenes/hog-functions/misc/HogFunctionStatusTag.tsx"),CodeSnippet=__webpack_require__("../../frontend/src/lib/components/CodeSnippet/index.ts"),LemonLabel=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonLabel/index.ts");function HogFunctionSourceWebhookInfo(){let{logicProps}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{id}=logicProps;return(0,jsx_runtime.jsxs)("div",{className:"p-3 rounded border deprecated-space-y-2 bg-surface-primary",children:[(0,jsx_runtime.jsx)(LemonLabel.H,{children:"Webhook URL"}),(0,jsx_runtime.jsx)(CodeSnippet.O,{thing:"Webhook URL",children:id?window.location.origin+"/public/webhooks/"+id:"The webhook URL will be shown here once you save"}),(0,jsx_runtime.jsxs)("p",{className:"text-sm",children:["Use this URL in your external system to send events to PostHog. The webhook can be called with a POST request and any JSON payload. You can then use the configuration options to parse the"," ",(0,jsx_runtime.jsx)("code",{children:"request.body"})," or ",(0,jsx_runtime.jsx)("code",{children:"request.headers"})," to map to the required fields."]})]})}let hogFunctionSourceWebhookTestLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{var _ref2;let{id,templateId}=_ref;return null!==(_ref2=null!=id?id:templateId)&&void 0!==_ref2?_ref2:"new"}),(0,index_esm.path)(id=>["scenes","pipeline","hogfunctions","hogFunctionSourceWebhookTestLogic",id]),(0,index_esm.connect)(props=>({values:[(0,hogFunctionConfigurationLogic.nM)(props),["configuration","templateId"]]})),(0,index_esm.actions)({setTestResult:result=>({result}),toggleExpanded:expanded=>({expanded})}),(0,index_esm.reducers)({expanded:[!1,{toggleExpanded:(state,_ref3)=>{let{expanded}=_ref3;return void 0===expanded?!state:expanded}}],testResult:[null,{setTestResult:(_,_ref4)=>{let{result}=_ref4;return result}}]}),(0,lib.forms)(_ref5=>{let{props,actions}=_ref5;return{testInvocation:{defaults:{mock_request:!0,headers:`{
  "Content-Type": "application/json"
}`,body:`{
  "event": "my example event",
  "distinct_id": "webhook-test-123"
}`},alwaysShowErrors:!0,errors:_ref6=>{let{headers,body}=_ref6;return{headers:headers?(0,utils.Cy)(headers)?void 0:"Invalid JSON":"Required",body:body?(0,utils.Cy)(body)?void 0:"Invalid JSON":"Required"}},submit:async data=>{var _props$id;actions.setTestResult(null);let response=await fetch(`${window.location.origin}/public/webhooks/${null!==(_props$id=props.id)&&void 0!==_props$id?_props$id:"unknown"}`,{method:"POST",headers:(0,utils.Cy)(data.headers),body:data.body});actions.setTestResult({status:response.status,body:await response.text()})}}}}),(0,index_esm.selectors)({exampleCurlRequest:[s=>[s.testInvocation,(_,props)=>props],(testInvocation,props)=>{var _props$id2;let headersJson=(0,utils.Cy)(testInvocation.headers),headers=headersJson?Object.entries(headersJson).map(_ref7=>{let[key,value]=_ref7;return`-H "${key}: ${value}"`}).join(" "):"";return`curl -X POST ${headers} \\
  -d '${testInvocation.body}' \\
  ${window.location.origin}/public/webhooks/${null!==(_props$id2=props.id)&&void 0!==_props$id2?_props$id2:"unknown"}`}]})]);function HogFunctionSourceWebhookTest(){let{logicProps,configurationChanged}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{isTestInvocationSubmitting,testResult,expanded,exampleCurlRequest}=(0,index_esm.useValues)(hogFunctionSourceWebhookTestLogic(logicProps)),{submitTestInvocation,setTestResult,toggleExpanded}=(0,index_esm.useActions)(hogFunctionSourceWebhookTestLogic(logicProps)),testResultsRef=(0,react.useRef)(null),unsaved=!logicProps.id;return(0,jsx_runtime.jsx)(lib.Form,{logic:hogFunctionSourceWebhookTestLogic,props:logicProps,formKey:"testInvocation",enableFormOnSubmit:!0,children:(0,jsx_runtime.jsxs)("div",{ref:testResultsRef,className:(0,clsx_m.default)("p-3 rounded border",expanded?"bg-surface-primary":"bg-surface-secondary",expanded?"min-h-120":""),children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-end items-center mb-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("h2",{className:"flex gap-2 items-center mb-0",children:(0,jsx_runtime.jsx)("span",{children:"Testing"})}),expanded?null:unsaved?(0,jsx_runtime.jsx)("p",{children:"Testing tools are only available after creating the webhook"}):(0,jsx_runtime.jsx)("p",{children:"Click here to test your webhook"})]}),expanded?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"mock_request",children:_ref=>{let{value,onChange}=_ref;return(0,jsx_runtime.jsx)(src.f4,{onChange:v=>onChange(!v),checked:!value,"data-attr":"toggle-hog-test-mocking",className:"px-2 py-1",label:(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"When disabled, the webhook request will be sent but only tested without creating events or performing HTTP requests."}),children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2",children:["Debug webhook request only",(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-lg"})]})})})}}),expanded&&(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"hide-hog-testing",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>toggleExpanded(),tooltip:"Hide testing"})]}):(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"expand-hog-testing",type:"secondary",disabledReason:unsaved?"Testing tools are only available after creating the webhook":void 0,onClick:()=>{toggleExpanded(),setTimeout(()=>{testResultsRef.current?.scrollIntoView({behavior:"smooth",block:"start"})},100)},children:"Start testing"})]}),expanded?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)(src.Vp,{type:configurationChanged?"warning":"info",className:"mb-2",children:[configurationChanged?(0,jsx_runtime.jsx)("span",{children:"You have unsaved changes."}):null,(0,jsx_runtime.jsx)("span",{children:"Testing is performed against the latest saved configuration and will create real events."})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"headers",label:"HTTP Headers",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:(0,jsx_runtime.jsx)("div",{})}),(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",value:value,onChange:onChange,maxHeight:200})]})}}),(0,jsx_runtime.jsx)(LemonField.D,{name:"body",label:"HTTP Body",children:_ref3=>{let{value,onChange}=_ref3;return(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",value:value,onChange:onChange,maxHeight:200})}}),(0,jsx_runtime.jsx)(src.p2,{className:"my-4"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-between items-center",children:[(0,jsx_runtime.jsxs)(src.HQ,{className:"flex-1",children:["Response",testResult&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.oe,{type:testResult.status>=200&&testResult.status<300?"success":"danger",children:testResult.status})})]}),testResult?(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>setTestResult(null),children:"Clear"}):null,(0,jsx_runtime.jsx)(src.Jp,{type:"primary","data-attr":"test-hog-webhook",onClick:submitTestInvocation,loading:isTestInvocationSubmitting,size:"small",children:"Test webhook"})]}),testResult?(0,jsx_runtime.jsx)("div",{className:"flex flex-col gap-2",children:(0,jsx_runtime.jsx)(CodeSnippet.O,{thing:"Response body",children:testResult.body})}):isTestInvocationSubmitting?(0,jsx_runtime.jsx)(src.yW,{className:"h-12"}):(0,jsx_runtime.jsx)("p",{children:"No response yet"})]})]}),(0,jsx_runtime.jsx)(src.p2,{className:"my-4"}),(0,jsx_runtime.jsx)(CodeSnippet.O,{thing:"Example request",children:exampleCurlRequest})]}):null]})})}var HogFunctionIcon=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/HogFunctionIcon.tsx");function HogFunctionConfiguration(_ref){var _displayOptions$embed,_displayOptions$hideP,_displayOptions$hideO,_displayOptions$showF,_displayOptions$showE,_displayOptions$showS,_displayOptions$showE2,_displayOptions$canEd,_displayOptions$showP,_displayOptions$showT,_configuration$inputs,_configuration$inputs2;let{templateId,id,logicKey,displayOptions={}}=_ref,logicProps={templateId,id,logicKey},logic=(0,hogFunctionConfigurationLogic.nM)(logicProps),{isConfigurationSubmitting,configurationChanged,showSource,configuration,loading,loaded,hogFunction,willReEnableOnSave,willChangeEnabledOnSave,sampleGlobalsWithInputs,showPaygate,hasAddon,personsCount,personsCountLoading,personsListQuery,template,templateHasChanged,type,usesGroups,hasGroupsAddon,mightDropEvents,oldHogCode,newHogCode,featureFlags}=(0,index_esm.useValues)(logic),{submitConfiguration,resetForm,setShowSource,duplicate,resetToTemplate,duplicateFromTemplate,setConfigurationValue,deleteHogFunction,setOldHogCode,setNewHogCode,clearHogCodeDiff,reportAIHogFunctionPrompted,reportAIHogFunctionAccepted,reportAIHogFunctionRejected,reportAIHogFunctionPromptOpen}=(0,index_esm.useActions)(logic),canEditTransformationHogCode=(0,useFeatureFlag.y)("HOG_TRANSFORMATIONS_CUSTOM_HOG_ENABLED"),aiHogFunctionCreation=!!featureFlags[constants.y8.AI_HOG_FUNCTION_CREATION],sourceCodeRef=(0,react.useRef)(null);if(loading&&!loaded)return(0,jsx_runtime.jsx)(src.t2,{});if(!loaded)return(0,jsx_runtime.jsx)(NotFound.T,{object:"Hog function"});let isLegacyPlugin=(template?.id||hogFunction?.template?.id)?.startsWith("plugin-"),isSegmentPlugin=(template?.id||hogFunction?.template?.id)?.startsWith("segment-"),headerButtons=(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:!templateId&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!isLegacyPlugin&&(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,onClick:()=>duplicate(),children:"Duplicate"}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",fullWidth:!0,onClick:()=>deleteHogFunction(),children:"Delete"})]})}),(0,jsx_runtime.jsx)(src.p2,{vertical:!0})]})}),saveButtons=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[configurationChanged?(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",htmlType:"reset",onClick:()=>resetForm(),disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress…":void 0:"No changes",children:"Clear changes"}):null,(0,jsx_runtime.jsxs)(src.Jp,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,children:[templateId?"Create":"Save",willReEnableOnSave?" & re-enable":willChangeEnabledOnSave?` & ${configuration.enabled?"enable":"disable"}`:""]})]});if(showPaygate)return(0,jsx_runtime.jsx)(PayGateMini.E,{feature:src_types.P$.DATA_PIPELINES});let embedded=null!==(_displayOptions$embed=displayOptions.embedded)&&void 0!==_displayOptions$embed&&_displayOptions$embed,includeHeaderButtons=!(null!==(_displayOptions$hideP=displayOptions.hidePageHeader)&&void 0!==_displayOptions$hideP&&_displayOptions$hideP),showOverview=!(null!==(_displayOptions$hideO=displayOptions.hideOverview)&&void 0!==_displayOptions$hideO&&_displayOptions$hideO),showFilters=null!==(_displayOptions$showF=displayOptions.showFilters)&&void 0!==_displayOptions$showF?_displayOptions$showF:["destination","internal_destination","site_destination","broadcast","email","transformation"].includes(type),showExpectedVolume=null!==(_displayOptions$showE=displayOptions.showExpectedVolume)&&void 0!==_displayOptions$showE?_displayOptions$showE:["destination","site_destination","transformation"].includes(type),showStatus=null!==(_displayOptions$showS=displayOptions.showStatus)&&void 0!==_displayOptions$showS?_displayOptions$showS:["destination","internal_destination","email","transformation"].includes(type),showEnabled=null!==(_displayOptions$showE2=displayOptions.showEnabled)&&void 0!==_displayOptions$showE2?_displayOptions$showE2:["destination","internal_destination","email","site_destination","site_app","transformation","broadcast"].includes(type),canEditSource=null!==(_displayOptions$canEd=displayOptions.canEditSource)&&void 0!==_displayOptions$canEd?_displayOptions$canEd:!isLegacyPlugin&&!isSegmentPlugin&&(["destination","email","site_destination","site_app","source_webhook"].includes(type)||"transformation"===type&&canEditTransformationHogCode),showPersonsCount=null!==(_displayOptions$showP=displayOptions.showPersonsCount)&&void 0!==_displayOptions$showP?_displayOptions$showP:["broadcast"].includes(type),showTesting=null!==(_displayOptions$showT=displayOptions.showTesting)&&void 0!==_displayOptions$showT?_displayOptions$showT:["destination","internal_destination","transformation","email"].includes(type),showLeftPanel=showOverview||showExpectedVolume||showPersonsCount||showFilters;return(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-3",children:(0,jsx_runtime.jsxs)(index_esm.BindLogic,{logic:hogFunctionConfigurationLogic.nM,props:logicProps,children:[includeHeaderButtons&&(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[headerButtons,saveButtons]})}),hogFunction?.filters?.bytecode_error?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)(src.Vp,{type:"error",children:[(0,jsx_runtime.jsx)("b",{children:"Error saving filters:"})," ",hogFunction.filters.bytecode_error]})}):["template-google-ads","template-meta-ads","template-tiktok-ads","template-snapchat-ads","template-linkedin-ads","template-reddit-pixel","template-tiktok-pixel","template-snapchat-pixel","template-reddit-conversions-api"].includes(null!=templateId?templateId:"")||template?.status==="alpha"?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)(src.Vp,{type:"warning",children:[(0,jsx_runtime.jsx)("p",{children:"This destination is currently in an experimental state. For many cases this will work just fine but for others there may be unexpected issues and we do not offer official customer support for it in these cases."}),["template-reddit-conversions-api","template-snapchat-ads"].includes(null!=templateId?templateId:"")?(0,jsx_runtime.jsx)("span",{className:"mt-2",children:"The receiving destination imposes a rate limit of 10 events per second. Exceeding this limit may result in some events failing to be delivered."}):null]})}):null,(0,jsx_runtime.jsx)(lib.Form,{logic:hogFunctionConfigurationLogic.nM,props:logicProps,formKey:"configuration",className:"deprecated-space-y-3",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-4 items-start",children:[showLeftPanel&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1 gap-4 min-w-100",children:[(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("p-3 deprecated-space-y-2 bg-surface-primary",!embedded&&"border rounded"),children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 items-center min-h-16",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"icon_url",children:_ref2=>{var _ref3;let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(HogFunctionIcon.g,{logicKey:null!==(_ref3=null!=id?id:templateId)&&void 0!==_ref3?_ref3:"new",src:value,onChange:val=>onChange(val)})}}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1 justify-start items-start py-1",children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:configuration.name}),template&&(0,jsx_runtime.jsx)(HogFunctionStatusTag.B,{status:template.status})]}),showStatus&&(0,jsx_runtime.jsx)(HogFunctionStatusIndicator.F,{hogFunction:hogFunction}),showEnabled&&(0,jsx_runtime.jsx)(LemonField.D,{name:"enabled",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsx)(src.f4,{label:"Enabled",onChange:()=>onChange(!value),checked:value,disabled:loading,bordered:!0})}})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{type:"text",disabled:loading})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"description",label:"Description",info:"Add a description to share context with other team members",children:(0,jsx_runtime.jsx)(src._V,{disabled:loading})}),isLegacyPlugin||isSegmentPlugin?null:hogFunction?.template&&!hogFunction.template.id.startsWith("template-blank-")?(0,jsx_runtime.jsx)(src.Qw,{showArrow:!0,overlay:(0,jsx_runtime.jsxs)("div",{className:"p-1 max-w-120",children:[(0,jsx_runtime.jsxs)("p",{children:["This function was built from the template"," ",(0,jsx_runtime.jsx)("b",{children:hogFunction.template.name}),". If the template is updated, this function is not affected unless you choose to update it."]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 gap-2 items-center pt-2 border-t",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(src.Jp,{children:"Close"})}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>duplicateFromTemplate(),children:"New function from template"}),templateHasChanged?(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>resetToTemplate(),children:"Update"}):null]})]}),children:(0,jsx_runtime.jsx)("div",{className:"text-xs rounded border border-dashed text-secondary",children:(0,jsx_runtime.jsxs)(src.rU,{subtle:!0,className:"flex flex-wrap gap-1 items-center p-2",children:["Built from template:",(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:hogFunction?.template.name}),(0,jsx_runtime.jsx)(HogFunctionStatusTag.B,{status:hogFunction.template.status}),templateHasChanged?(0,jsx_runtime.jsx)(src.oe,{type:"success",children:"Update available!"}):null]})})}):null]}),"source_webhook"===type&&(0,jsx_runtime.jsx)(HogFunctionSourceWebhookInfo,{}),showFilters&&(0,jsx_runtime.jsx)(HogFunctionFilters.B,{}),showPersonsCount&&(0,jsx_runtime.jsxs)("div",{className:"relative p-3 rounded border deprecated-space-y-2 bg-surface-primary",children:[(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(src.HQ,{children:"Matching persons"})}),personsCount&&!personsCountLoading?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Found"," ",(0,jsx_runtime.jsx)(src.rU,{to:(0,kea_router_lib.combineUrl)(urls.j.activity(),{},{q:personsListQuery}).url,target:"_blank",children:(0,jsx_runtime.jsxs)("strong",{children:[null!=personsCount?personsCount:0," ",1!==personsCount?"people":"person"]})})," ","to send to."]}):personsCountLoading?(0,jsx_runtime.jsx)("div",{className:"min-h-20",children:(0,jsx_runtime.jsx)(src.t2,{})}):(0,jsx_runtime.jsx)("p",{children:"The expected volume could not be calculated"})]}),showExpectedVolume?(0,jsx_runtime.jsx)(HogFunctionEventEstimates,{}):null]}),(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4 flex-2 min-w-100",children:[mightDropEvents&&(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)(src.Vp,{type:"info",children:[(0,jsx_runtime.jsx)("b",{children:"Warning:"})," This transformation can filter out events, dropping them irreversibly. Make sure to double check your configuration, and use filters to limit the events that this transformation is applied to."]})}),(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("p-3 deprecated-space-y-2 bg-surface-primary",!embedded&&"border rounded"),children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[usesGroups&&!hasGroupsAddon?(0,jsx_runtime.jsx)(src.Vp,{type:"warning",children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2 items-center",children:["This function appears to use Groups but you do not have the Groups Analytics addon. Without it, you may see empty values where you use templates like ",'"{groups.kind.properties}"',(0,jsx_runtime.jsx)(PayGateButton.R,{feature:src_types.P$.GROUP_ANALYTICS,type:"secondary"})]})}):null,(0,jsx_runtime.jsx)(CyclotronJobInputs,{configuration:{inputs_schema:null!==(_configuration$inputs=configuration.inputs_schema)&&void 0!==_configuration$inputs?_configuration$inputs:[],inputs:null!==(_configuration$inputs2=configuration.inputs)&&void 0!==_configuration$inputs2?_configuration$inputs2:{}},onInputSchemaChange:schema=>{setConfigurationValue("inputs_schema",schema)},onInputChange:(key,input)=>{setConfigurationValue(`inputs.${key}`,input)},showSource:showSource}),showSource&&canEditSource?(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),size:"small",type:"secondary",className:"my-4",onClick:()=>{var _configuration$inputs3,_configuration$inputs4;setConfigurationValue("inputs_schema",[...null!==(_configuration$inputs3=configuration.inputs_schema)&&void 0!==_configuration$inputs3?_configuration$inputs3:[],{type:"string",key:`input_${(null!==(_configuration$inputs4=configuration.inputs_schema?.length)&&void 0!==_configuration$inputs4?_configuration$inputs4:0)+1}`,label:"",required:!1}])},children:"Add input variable"}):null]})}),(0,jsx_runtime.jsx)(HogFunctionMappings,{}),canEditSource&&(0,jsx_runtime.jsxs)("div",{ref:sourceCodeRef,className:(0,clsx_m.default)("p-3 rounded border deprecated-space-y-2",showSource?"bg-surface-primary":"bg-surface-secondary"),children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-end items-center",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0",children:"Edit source"}),showSource?null:(0,jsx_runtime.jsx)("p",{children:"Click here to edit the function's source code"})]}),showSource?(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"secondary",onClick:()=>setShowSource(!1),children:"Hide source code"}):(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>{setShowSource(!0),setTimeout(()=>{sourceCodeRef.current?.scrollIntoView({behavior:"smooth",block:"start"})},100)},disabledReason:hasAddon||"transformation"===type?void 0:"Editing the source code requires the Data Pipelines addon",children:"Edit source code"})]}),showSource?(0,jsx_runtime.jsx)(LemonField.D,{name:"hog",children:_ref5=>{var _ref6;let{value,onChange}=_ref5;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[type.startsWith("site_")?null:(0,jsx_runtime.jsxs)("span",{className:"text-xs text-secondary",children:["This is the underlying Hog code that will run whenever this triggers."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/hog",children:"See the docs"})," ","for more info"]}),mightDropEvents&&(0,jsx_runtime.jsxs)(src.Vp,{type:"warning",className:"mt-2",children:[(0,jsx_runtime.jsx)("b",{children:"Warning:"})," Returning null or undefined will drop the event. If this is unintentional, return the event object instead."]}),aiHogFunctionCreation?(0,jsx_runtime.jsx)(MaxTool.Z,{name:"create_hog_transformation_function",displayName:"Write and tweak Hog code",context:{current_hog_code:null!=value?value:""},callback:toolOutput=>{setOldHogCode(null!=value?value:""),setNewHogCode(toolOutput),reportAIHogFunctionPrompted()},onMaxOpen:()=>{reportAIHogFunctionPromptOpen()},suggestions:[],introOverride:{headline:"What transformation do you want to create?",description:"Let me help you quickly write the code for your transformation, and tweak it."},children:(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:type.startsWith("site_")?"typescript":"hog",value:null!==(_ref6=null!=newHogCode?newHogCode:value)&&void 0!==_ref6?_ref6:"",originalValue:oldHogCode&&newHogCode?oldHogCode:void 0,onChange:v=>{oldHogCode&&newHogCode&&clearHogCodeDiff(),onChange(null!=v?v:"")},globals:sampleGlobalsWithInputs,showDiffActions:!!(oldHogCode&&newHogCode),onAcceptChanges:()=>{newHogCode&&onChange(newHogCode),reportAIHogFunctionAccepted(),clearHogCodeDiff()},onRejectChanges:()=>{oldHogCode&&onChange(oldHogCode),reportAIHogFunctionRejected(),clearHogCodeDiff()},options:{minimap:{enabled:!1},wordWrap:"on",scrollBeyondLastLine:!1,automaticLayout:!0,fixedOverflowWidgets:!0,suggest:{showInlineDetails:!0},quickSuggestionsDelay:300,readOnly:!!(oldHogCode&&newHogCode)}})}):(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:type.startsWith("site_")?"typescript":"hog",value:null!=value?value:"",onChange:v=>onChange(null!=v?v:""),globals:sampleGlobalsWithInputs,options:{minimap:{enabled:!1},wordWrap:"on",scrollBeyondLastLine:!1,automaticLayout:!0,fixedOverflowWidgets:!0,suggest:{showInlineDetails:!0},quickSuggestionsDelay:300}})]})}}):null]}),showTesting?(0,jsx_runtime.jsx)(HogFunctionTest,{}):null,"source_webhook"===type&&(0,jsx_runtime.jsx)(HogFunctionSourceWebhookTest,{}),"broadcast"===type&&(0,jsx_runtime.jsx)(HogFunctionBroadcastDelivery,{}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-end",children:saveButtons})]})]})})]})})}},"../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Af:()=>convertToHogFunctionInvocationGlobals,nM:()=>hogFunctionConfigurationLogic,r9:()=>sanitizeConfiguration});var src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),fast_deep_equal=__webpack_require__("../../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"),fast_deep_equal_default=__webpack_require__.n(fast_deep_equal),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),kea_subscriptions_lib=__webpack_require__("../../node_modules/.pnpm/kea-subscriptions@3.0.1_kea@3.1.5_react@18.2.0_/node_modules/kea-subscriptions/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),saveToLogic=__webpack_require__("../../frontend/src/lib/components/SaveTo/saveToLogic.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),deleteWithUndo=__webpack_require__("../../frontend/src/lib/utils/deleteWithUndo.tsx"),defineProperty=__webpack_require__("../../node_modules/.pnpm/@babel+runtime@7.24.0/node_modules/@babel/runtime/helpers/esm/defineProperty.js"),liquid_browser=__webpack_require__("../../node_modules/.pnpm/liquidjs@10.21.1/node_modules/liquidjs/dist/liquid.browser.mjs");let LIQUID_REGEX=/\{\{(.*?)\}\}|{%(.*?)%}/g;class LiquidRenderer{static get liquid(){return this._liquid||(this._liquid=new liquid_browser.Kj({outputEscape:"escape"})),this._liquid}static parse(template){let decodedTemplate=template.replace(LIQUID_REGEX,match=>match.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&amp;/g,"&"));return this.liquid.parse(decodedTemplate)}}(0,defineProperty.Z)(LiquidRenderer,"_liquid",null);var dist_module=__webpack_require__("../../node_modules/.pnpm/posthog-js@1.253.4_@rrweb+types@2.0.0-alpha.17/node_modules/posthog-js/dist/module.js"),person_utils=__webpack_require__("../../frontend/src/scenes/persons/person-utils.ts"),pipelineNodeLogic=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineNodeLogic.tsx"),projectLogic=__webpack_require__("../../frontend/src/scenes/projectLogic.ts"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),projectTreeLogic=__webpack_require__("../../frontend/src/layout/panel-layout/ProjectTree/projectTreeLogic.tsx"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts"),DataTable_utils=__webpack_require__("../../frontend/src/queries/nodes/DataTable/utils.ts"),query=__webpack_require__("../../frontend/src/queries/query.ts"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),queries_utils=__webpack_require__("../../frontend/src/queries/utils.ts"),types=__webpack_require__("../../frontend/src/types.ts"),sub_templates=__webpack_require__("../../frontend/src/scenes/hog-functions/sub-templates/sub-templates.ts");let VALIDATION_RULES={SITE_DESTINATION_REQUIRES_MAPPINGS:data=>"site_destination"!==data.type||data.mappings&&0!==data.mappings.length?void 0:"You must add at least one mapping",INTERNAL_DESTINATION_REQUIRES_FILTERS:data=>"internal_destination"===data.type&&data.filters?.events?.length===0?"You must choose a filter":void 0},NEW_FUNCTION_TEMPLATE={id:"new",free:!1,type:"destination",name:"",description:"",inputs_schema:[],hog:"print('Hello, world!');",status:"stable"},TYPES_WITH_GLOBALS=["transformation","destination"],TYPES_WITH_SPARKLINE=["destination","site_destination","transformation"],TYPES_WITH_VOLUME_WARNING=["destination","site_destination"];function sanitizeConfiguration(data){function sanitizeInputs(data){let sanitizedInputs={};return data.inputs_schema?.forEach(inputSchema=>{var _inputSchema$templati,_input$templating;let templatingEnabled=null===(_inputSchema$templati=inputSchema.templating)||void 0===_inputSchema$templati||_inputSchema$templati,input=data.inputs?.[inputSchema.key],secret=input?.secret,value=input?.value;if(secret){sanitizedInputs[inputSchema.key]={value:"********",secret:!0};return}if("json"===inputSchema.type&&"string"==typeof value)try{value=JSON.parse(value)}catch(e){}sanitizedInputs[inputSchema.key]={value:value,templating:templatingEnabled?null!==(_input$templating=input?.templating)&&void 0!==_input$templating?_input$templating:"hog":void 0}}),sanitizedInputs}return{...data,filters:data.filters,mappings:data.mappings?.map(mapping=>({...mapping,inputs:sanitizeInputs(mapping)})),inputs:sanitizeInputs(data),masking:data.masking?.hash?data.masking:null,icon_url:data.icon_url}}let templateToConfiguration=template=>{var _template$type;function getInputs(inputs_schema){let inputs={};return inputs_schema?.forEach(schema=>{void 0!==schema.default&&(inputs[schema.key]={value:schema.default})}),inputs}function getMappingInputs(inputs_schema){let inputs={};return inputs_schema?.forEach(schema=>{void 0!==schema.default&&(inputs[schema.key]={value:schema.default})}),inputs}return{type:null!==(_template$type=template.type)&&void 0!==_template$type?_template$type:"destination",kind:template.kind,name:template.name,description:"string"==typeof template.description?template.description:"",inputs_schema:template.inputs_schema,filters:template.filters,mappings:template.mappings?.map(mapping=>({...mapping,inputs:getMappingInputs(mapping.inputs_schema)})),hog:template.hog,icon_url:template.icon_url,inputs:getInputs(template.inputs_schema),enabled:!0}};function convertToHogFunctionInvocationGlobals(event,person){var _team$id,_team$name,_event$uuid,_event$elements_chain,_event$uuid2,_person$uuid;let team=teamLogic.teamLogic.findMounted()?.values?.currentTeam,projectUrl=`${window.location.origin}/project/${team?.id}`;return{project:{id:null!==(_team$id=team?.id)&&void 0!==_team$id?_team$id:0,name:null!==(_team$name=team?.name)&&void 0!==_team$name?_team$name:"Default project",url:projectUrl},event:{uuid:null!==(_event$uuid=event.uuid)&&void 0!==_event$uuid?_event$uuid:"",event:event.event,distinct_id:event.distinct_id,elements_chain:null!==(_event$elements_chain=event.elements_chain)&&void 0!==_event$elements_chain?_event$elements_chain:"",properties:event.properties,timestamp:event.timestamp,url:`${projectUrl}/events/${encodeURIComponent(null!==(_event$uuid2=event.uuid)&&void 0!==_event$uuid2?_event$uuid2:"")}/${encodeURIComponent(event.timestamp)}`},person:{id:null!==(_person$uuid=person.uuid)&&void 0!==_person$uuid?_person$uuid:"",properties:person.properties,name:(0,person_utils.y)(person),url:`${projectUrl}/person/${encodeURIComponent(event.distinct_id)}`},groups:{}}}function mightDropEvents(code){let sanitizedCode=code.replace(/\/\*[\s\S]*?\*\/|\/\/.*/g,"").replace(/\s+/g," ").trim();if(!sanitizedCode)return!1;if(sanitizedCode.includes("return null")||sanitizedCode.includes("return undefined")||/\breturn\b\s*;/.test(sanitizedCode)||/\breturn\b\s*$/.test(sanitizedCode)||/\bif\s*\([^)]*\)\s*\{\s*\breturn\s+(null|undefined)\b/.test(sanitizedCode))return!0;let nullVarMatch=code.match(/\blet\s+(\w+)\s*:?=\s*(null|undefined)/g);if(nullVarMatch){for(let varName of nullVarMatch.map(match=>match.match(/\blet\s+(\w+)/)?.[1]).filter(Boolean))if(RegExp(`\\breturn\\s+${varName}\\b`).test(code))return!0}return!1}let hogFunctionConfigurationLogic=(0,index_esm.kea)([(0,index_esm.path)(id=>["scenes","pipeline","hogFunctionConfigurationLogic",id]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{var _ref2;let{id,templateId,logicKey}=_ref,baseKey=null!==(_ref2=null!=id?id:templateId)&&void 0!==_ref2?_ref2:"new";return logicKey?`${logicKey}_${baseKey}`:baseKey}),(0,index_esm.connect)(_ref3=>{let{id}=_ref3;return{values:[projectLogic.K,["currentProjectId","currentProject"],groupsModel.$,["groupTypes"],userLogic.userLogic,["hasAvailableFeature"],featureFlagLogic.featureFlagLogic,["featureFlags"]],actions:[(0,pipelineNodeLogic.y)({id:`hog-${id}`,stage:types.We.Destination}),["setBreadcrumbTitle"]]}}),(0,index_esm.actions)({setShowSource:showSource=>({showSource}),resetForm:!0,upsertHogFunction:configuration=>({configuration}),duplicate:!0,duplicateFromTemplate:!0,resetToTemplate:!0,deleteHogFunction:!0,sparklineQueryChanged:sparklineQuery=>({sparklineQuery}),personsCountQueryChanged:personsCountQuery=>({personsCountQuery}),loadSampleGlobals:payload=>({eventId:payload?.eventId}),setUnsavedConfiguration:configuration=>({configuration}),persistForUnload:!0,setSampleGlobalsError:error=>({error}),setSampleGlobals:sampleGlobals=>({sampleGlobals}),setShowEventsList:showEventsList=>({showEventsList}),sendBroadcast:!0,setOldHogCode:oldHogCode=>({oldHogCode}),setNewHogCode:newHogCode=>({newHogCode}),clearHogCodeDiff:!0,reportAIHogFunctionPrompted:!0,reportAIHogFunctionAccepted:!0,reportAIHogFunctionRejected:!0,reportAIHogFunctionPromptOpen:!0}),(0,index_esm.reducers)(_ref4=>{let{props}=_ref4;return{sampleGlobals:[null,{setSampleGlobals:(_,_ref5)=>{let{sampleGlobals}=_ref5;return sampleGlobals}}],showSource:[!!(!props.id&&props.templateId?.startsWith("template-blank-")),{setShowSource:(_,_ref6)=>{let{showSource}=_ref6;return showSource}}],hasHadSubmissionErrors:[!1,{upsertHogFunctionFailure:()=>!0}],unsavedConfiguration:[null,{persist:!0},{setUnsavedConfiguration:(_,_ref7)=>{let{configuration}=_ref7;return configuration?{timestamp:Date.now(),configuration}:null}}],sampleGlobalsError:[null,{loadSampleGlobals:()=>null,setSampleGlobalsError:(_,_ref8)=>{let{error}=_ref8;return error}}],showEventsList:[!1,{setShowEventsList:(_,_ref9)=>{let{showEventsList}=_ref9;return showEventsList}}],oldHogCode:[null,{setOldHogCode:(_,_ref10)=>{let{oldHogCode}=_ref10;return oldHogCode},clearHogCodeDiff:()=>null}],newHogCode:[null,{setNewHogCode:(_,_ref11)=>{let{newHogCode}=_ref11;return newHogCode},clearHogCodeDiff:()=>null}]}}),(0,kea_loaders_lib.loaders)(_ref12=>{let{actions,props,values}=_ref12;return{template:[null,{loadTemplate:async()=>{if(!props.templateId)return null;if("new"===props.templateId)return{...NEW_FUNCTION_TEMPLATE};let dbTemplates=!!values.featureFlags[constants.y8.GET_HOG_TEMPLATES_FROM_DB],res=await api.ZP.hogFunctions.getTemplate(props.templateId,dbTemplates);if(!res)throw Error("Template not found");return res}}],hogFunction:[null,{loadHogFunction:async()=>props.id&&"new"!==props.id?await api.ZP.hogFunctions.get(props.id):null,upsertHogFunction:async _ref13=>{let{configuration}=_ref13,res=props.id&&"new"!==props.id?await api.ZP.hogFunctions.update(props.id,configuration):await api.ZP.hogFunctions.create(configuration);return dist_module.ZP.capture("hog function saved",{id:res.id,template_id:res.template?.id,template_name:res.template?.name,type:res.type,enabled:res.enabled}),src.UJ.success("Configuration saved"),(0,projectTreeLogic.BI)("hog_function/",res.id),res}}],sparkline:[null,{sparklineQueryChanged:async(_ref14,breakpoint)=>{var _result$results$0$dat;let{sparklineQuery}=_ref14;if(!TYPES_WITH_SPARKLINE.includes(values.type))return null;null===values.sparkline?await breakpoint(100):await breakpoint(1e3);let result=await (0,query.jr)(sparklineQuery);breakpoint();let dataValues=null!==(_result$results$0$dat=result?.results?.[0]?.data)&&void 0!==_result$results$0$dat?_result$results$0$dat:[];if(TYPES_WITH_VOLUME_WARNING.includes(values.type)){let[underThreshold,overThreshold]=dataValues.reduce((acc,val)=>(acc[0].push(Math.min(val,1e3)),acc[1].push(Math.max(0,val-1e3)),acc),[[],[]]);return{data:[{name:"Low volume",values:underThreshold,color:"success"},{name:"High volume",values:overThreshold,color:"warning"}],count:result?.results?.[0]?.count,labels:result?.results?.[0]?.labels}}return{data:[{name:"Volume",values:dataValues,color:"success"}],count:result?.results?.[0]?.count,labels:result?.results?.[0]?.labels,warning:"transformation"===values.type?"Historical volume may not reflect future volume after transformation is applied.":void 0}}}],personsCount:[null,{personsCountQueryChanged:async(_ref15,breakpoint)=>{var _result$results$0$;let{personsCountQuery}=_ref15;if("broadcast"!==values.type)return null;null===values.personsCount?await breakpoint(100):await breakpoint(1e3);let result=await (0,query.jr)(personsCountQuery);return breakpoint(),null!==(_result$results$0$=result?.results?.[0]?.[0])&&void 0!==_result$results$0$?_result$results$0$:null}}],sampleGlobals:[null,{loadSampleGlobals:async(_ref16,breakpoint)=>{var _values$configuration,_e$message;let{eventId}=_ref16;if(!values.lastEventQuery)return values.sampleGlobals;let errorMessage="No events match these filters in the last 30 days. Showing an example $pageview event instead.";try{await breakpoint(null===values.sampleGlobals?10:1e3);let response=await (0,query.jr)({...values.lastEventQuery,properties:eventId?[{type:types.FT.HogQL,key:`uuid = '${eventId}'`}]:void 0});if(!response?.results?.[0]&&values.lastEventSecondQuery&&(response=await (0,query.jr)({...values.lastEventSecondQuery,properties:eventId?[{type:types.FT.HogQL,key:`uuid = '${eventId}'`}]:void 0})),!response?.results?.[0])throw Error(errorMessage);let event=response?.results?.[0]?.[0],person=response?.results?.[0]?.[1],globals=convertToHogFunctionInvocationGlobals(event,person);return globals.groups={},values.groupTypes.forEach((groupType,index)=>{let tuple=response?.results?.[0]?.[2+index];if(tuple&&Array.isArray(tuple)&&tuple[2]){let properties={};try{properties=JSON.parse(tuple[3])}catch(e){}globals.groups[groupType.group_type]={type:groupType.group_type,index:tuple[1],id:tuple[2],url:`${window.location.origin}/groups/${tuple[1]}/${encodeURIComponent(tuple[2])}`,properties}}}),globals.source={name:null!==(_values$configuration=values.configuration?.name)&&void 0!==_values$configuration?_values$configuration:"Unnamed",url:window.location.href.split("#")[0]},globals}catch(e){return(0,index_esm.isBreakpoint)(e)||actions.setSampleGlobalsError(null!==(_e$message=e.message)&&void 0!==_e$message?_e$message:errorMessage),values.exampleInvocationGlobals}}}],broadcast:[!1,{sendBroadcast:async()=>{let id=values.hogFunction?.id;return id?(await api.ZP.hogFunctions.sendBroadcast(id),src.UJ.success("Broadcast sent!"),!0):(src.UJ.error("No broadcast to send"),!1)}}]}}),(0,lib.forms)(_ref17=>{let{values,props,asyncActions}=_ref17;return{configuration:{defaults:{},alwaysShowErrors:!0,errors:data=>({name:data.name?void 0:"Name is required",mappings:VALIDATION_RULES.SITE_DESTINATION_REQUIRES_MAPPINGS(data),filters:VALIDATION_RULES.INTERNAL_DESTINATION_REQUIRES_FILTERS(data),...values.inputFormErrors}),submit:async data=>{if(data.hog&&new Blob([data.hog]).size>102400){src.UJ.error("Hog code exceeds maximum size of 100KB. Please simplify your code or contact support to increase the limit.");return}let payload=sanitizeConfiguration(data);if(payload.template_id=props.templateId||values.hogFunction?.template?.id,values.hasAddon||"transformation"===values.type||delete payload.hog,!props.id||"new"===props.id){let type=values.type,typeFolder="site_app"===type?"Site apps":"transformation"===type?"Transformations":"source_webhook"===type?"Sources":"broadcast"===type?"Broadcasts":"messaging_campaign"===type?"Campaigns":"Destinations",folder=await (0,saveToLogic.tp)({defaultFolder:`Unfiled/${typeFolder}`});"string"==typeof folder&&(payload._create_in_folder=folder)}await asyncActions.upsertHogFunction(payload)}}}}),(0,index_esm.selectors)(()=>({logicProps:[()=>[(_,props)=>props],props=>props],type:[s=>[s.configuration,s.hogFunction],(configuration,hogFunction)=>{var _ref18,_configuration$type;return null!==(_ref18=null!==(_configuration$type=configuration?.type)&&void 0!==_configuration$type?_configuration$type:hogFunction?.type)&&void 0!==_ref18?_ref18:"loading"}],hasAddon:[s=>[s.hasAvailableFeature],hasAvailableFeature=>hasAvailableFeature(types.P$.DATA_PIPELINES)],hasGroupsAddon:[s=>[s.hasAvailableFeature],hasAvailableFeature=>hasAvailableFeature(types.P$.GROUP_ANALYTICS)],showPaygate:[s=>[s.template,s.hasAddon],(template,hasAddon)=>template&&!template.free&&!hasAddon],useMapping:[s=>[s.hogFunction,s.template],(hogFunction,template)=>Array.isArray(hogFunction?.mappings)||template?.mapping_templates?.length],defaultFormState:[s=>[s.template,s.hogFunction],(template,hogFunction)=>template?templateToConfiguration(template):null!=hogFunction?hogFunction:null],templateId:[s=>[s.template,s.hogFunction],(template,hogFunction)=>template?.id||hogFunction?.template?.id],loading:[s=>[s.hogFunctionLoading,s.templateLoading],(hogFunctionLoading,templateLoading)=>hogFunctionLoading||templateLoading],loaded:[s=>[s.hogFunction,s.template],(hogFunction,template)=>!!hogFunction||!!template],contextId:[s=>[s.configuration],configuration=>(0,sub_templates.Ud)(configuration.filters?.events?.[0]?.id)],inputFormErrors:[s=>[s.configuration],configuration=>{var _configuration$inputs;let inputs=null!==(_configuration$inputs=configuration.inputs)&&void 0!==_configuration$inputs?_configuration$inputs:{},inputErrors={};return configuration.inputs_schema?.forEach(inputSchema=>{var _input$templating2;let key=inputSchema.key,input=inputs[key],language=null!==(_input$templating2=input?.templating)&&void 0!==_input$templating2?_input$templating2:"hog",value=input?.value;if(input?.secret)return;let getTemplatingError=value=>{if("liquid"===language&&"string"==typeof value)try{LiquidRenderer.parse(value)}catch(e){return`Liquid template error: ${e.message}`}},addTemplatingError=value=>{let templatingError=getTemplatingError(value);templatingError&&(inputErrors[key]=templatingError)},missing=null==value||""===value;if(inputSchema.required&&missing&&(inputErrors[key]="This field is required"),"json"===inputSchema.type&&"string"==typeof value){try{JSON.parse(value)}catch(e){inputErrors[key]="Invalid JSON"}addTemplatingError(value)}if("email"===inputSchema.type&&value){let combinedErrors=Object.values({html:value.html?getTemplatingError(value.html):"HTML is required",subject:value.subject?getTemplatingError(value.subject):"Subject is required",from:value.from?getTemplatingError(value.from):"From is required",to:value.to?getTemplatingError(value.to):"To is required"}).filter(v=>!!v).join(", ");combinedErrors&&(inputErrors[key]=combinedErrors)}if("string"===inputSchema.type&&"string"==typeof value&&addTemplatingError(value),"dictionary"===inputSchema.type)for(let val of Object.values(null!=value?value:{}))"string"==typeof val&&addTemplatingError(val)}),Object.keys(inputErrors).length>0?{inputs:inputErrors}:null}],willReEnableOnSave:[s=>[s.configuration,s.hogFunction],(configuration,hogFunction)=>{var _hogFunction$status$s;return configuration?.enabled&&(null!==(_hogFunction$status$s=hogFunction?.status?.state)&&void 0!==_hogFunction$status$s?_hogFunction$status$s:0)>=3}],willChangeEnabledOnSave:[s=>[s.configuration,s.hogFunction],(configuration,hogFunction)=>{var _hogFunction$enabled;return configuration?.enabled!==(null!==(_hogFunction$enabled=hogFunction?.enabled)&&void 0!==_hogFunction$enabled&&_hogFunction$enabled)}],exampleInvocationGlobals:[s=>[s.configuration,s.currentProject,s.groupTypes,s.contextId],(configuration,currentProject,groupTypes,contextId)=>{var _configuration$name;let currentUrl=window.location.href.split("#")[0],eventId=(0,utils.Vj)(),personId=(0,utils.Vj)(),globals={event:{uuid:eventId,distinct_id:(0,utils.Vj)(),timestamp:(0,dayjs.Bv)().toISOString(),elements_chain:"",url:`${window.location.origin}/project/${currentProject?.id}/events/`,..."error-tracking"===contextId?{event:configuration?.filters?.events?.[0].id||"$error_tracking_issue_created",properties:{name:"Test issue",description:"This is the issue description"}}:"activity-log"===contextId?{event:"$activity_log_entry_created",properties:{activity:"created",scope:"Insight",item_id:"abcdef"}}:{event:"$pageview",properties:{$current_url:currentUrl,$browser:"Chrome",this_is_an_example_event:!0}}},person:"error-tracking"!==contextId?{id:personId,properties:{email:"example@posthog.com"},name:"Example person",url:`${window.location.origin}/person/${personId}`}:void 0,groups:{},project:{id:currentProject?.id||0,name:currentProject?.name||"",url:`${window.location.origin}/project/${currentProject?.id}`},source:{name:null!==(_configuration$name=configuration?.name)&&void 0!==_configuration$name?_configuration$name:"Unnamed",url:currentUrl}};return"error-tracking"!==contextId&&groupTypes.forEach(groupType=>{let id=(0,utils.Vj)();globals.groups[groupType.group_type]={id:id,type:groupType.group_type,index:groupType.group_type_index,url:`${window.location.origin}/groups/${groupType.group_type_index}/${encodeURIComponent(id)}`,properties:{}}}),globals}],sampleGlobalsWithInputs:[s=>[s.sampleGlobals,s.exampleInvocationGlobals,s.configuration],(sampleGlobals,exampleInvocationGlobals,configuration)=>{let inputs={};for(let input of configuration?.inputs_schema||[])inputs[input.key]=input.type;return"source_webhook"===configuration.type?{request:{body:{},headers:{},ip:"127.0.0.1"},inputs}:{...null!=sampleGlobals?sampleGlobals:exampleInvocationGlobals,inputs}}],matchingFilters:[s=>[s.configuration,s.useMapping],(configuration,useMapping)=>{var _configuration$filter,_configuration$filter2,_configuration$filter3,_event$properties,_action$properties,_configuration$filter4;if(useMapping&&!configuration.mappings?.length)return{type:types.J2.And,values:[{type:types.J2.And,values:[{type:types.FT.HogQL,key:"false"}]}]};let seriesProperties={type:types.J2.Or,values:[]},properties={type:types.J2.And,values:[seriesProperties]},allPossibleEventFilters=null!==(_configuration$filter=configuration.filters?.events)&&void 0!==_configuration$filter?_configuration$filter:[],allPossibleActionFilters=null!==(_configuration$filter2=configuration.filters?.actions)&&void 0!==_configuration$filter2?_configuration$filter2:[];if(Array.isArray(configuration.mappings))for(let mapping of configuration.mappings)mapping.filters?.events&&allPossibleEventFilters.push(...mapping.filters.events),mapping.filters?.actions&&allPossibleActionFilters.push(...mapping.filters.actions);for(let event of allPossibleEventFilters){let eventProperties=[...null!==(_event$properties=event.properties)&&void 0!==_event$properties?_event$properties:[]];event.id&&eventProperties.push({type:types.FT.HogQL,key:(0,queries_utils.zP)`event = ${event.id}`}),0===eventProperties.length&&eventProperties.push({type:types.FT.HogQL,key:"true"}),seriesProperties.values.push({type:types.J2.And,values:eventProperties})}for(let action of allPossibleActionFilters){let actionProperties=[...null!==(_action$properties=action.properties)&&void 0!==_action$properties?_action$properties:[]];action.id&&actionProperties.push({type:types.FT.HogQL,key:(0,queries_utils.zP)`matchesAction(${parseInt(action.id)})`}),seriesProperties.values.push({type:types.J2.And,values:actionProperties})}if((null!==(_configuration$filter3=configuration.filters?.properties?.length)&&void 0!==_configuration$filter3?_configuration$filter3:0)>0){let globalProperties={type:types.J2.And,values:[]};for(let property of null!==(_configuration$filter4=configuration.filters?.properties)&&void 0!==_configuration$filter4?_configuration$filter4:[])globalProperties.values.push(property);properties.values.push(globalProperties)}return properties},{resultEqualityCheck:fast_deep_equal_default()}],filtersContainPersonProperties:[s=>[s.configuration],configuration=>{let filters=configuration.filters,containsPersonProperties=!1;return filters?.properties&&!containsPersonProperties&&(containsPersonProperties=filters.properties.some(p=>"person"===p.type)),filters?.actions&&!containsPersonProperties&&(containsPersonProperties=filters.actions.some(a=>a.properties?.some(p=>"person"===p.type))),filters?.events&&!containsPersonProperties&&(containsPersonProperties=filters.events.some(e=>e.properties?.some(p=>"person"===p.type))),containsPersonProperties}],sparklineQuery:[s=>[s.configuration,s.matchingFilters,s.type],(configuration,matchingFilters,type)=>TYPES_WITH_SPARKLINE.includes(type)?{kind:schema_general.OH.TrendsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,series:[{kind:schema_general.OH.EventsNode,event:null,name:"All Events",math:types.vN.TotalCount}],properties:matchingFilters,interval:"day",dateRange:{date_from:"-7d"},trendsFilter:{display:types.Qb.ActionsBar},modifiers:{personsOnEventsMode:"person_id_no_override_properties_on_events"}}:null,{resultEqualityCheck:fast_deep_equal_default()}],personsCountQuery:[s=>[s.configuration,s.type],(configuration,type)=>"broadcast"!==type?null:{kind:schema_general.OH.ActorsQuery,properties:configuration.filters?.properties,select:["count()"]},{resultEqualityCheck:fast_deep_equal_default()}],personsListQuery:[s=>[s.configuration,s.type],(configuration,type)=>"broadcast"!==type?null:{kind:schema_general.OH.DataTableNode,source:{kind:schema_general.OH.ActorsQuery,properties:configuration.filters?.properties,select:["person","properties.email","created_at"]},full:!0},{resultEqualityCheck:fast_deep_equal_default()}],baseEventsQuery:[s=>[s.configuration,s.matchingFilters,s.groupTypes,s.type],(configuration,matchingFilters,groupTypes,type)=>{if(!TYPES_WITH_GLOBALS.includes(type))return null;let query={kind:schema_general.OH.EventsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,fixedProperties:[matchingFilters],select:["*","person"],after:"-7d",orderBy:["timestamp DESC"],modifiers:{personsOnEventsMode:"person_id_no_override_properties_on_events"}};return groupTypes.forEach(groupType=>{let name=(0,queries_utils.cM)(groupType.group_type);query.select.push(`tuple(${name}.created_at, ${name}.index, ${name}.key, ${name}.properties, ${name}.updated_at)`)}),query},{resultEqualityCheck:fast_deep_equal_default()}],eventsDataTableNode:[s=>[s.baseEventsQuery],baseEventsQuery=>baseEventsQuery?{kind:schema_general.OH.DataTableNode,source:{...baseEventsQuery,select:(0,DataTable_utils.Qi)(schema_general.OH.EventsQuery)}}:null],lastEventQuery:[s=>[s.baseEventsQuery],baseEventsQuery=>baseEventsQuery?{...baseEventsQuery,limit:1}:null,{resultEqualityCheck:fast_deep_equal_default()}],lastEventSecondQuery:[s=>[s.lastEventQuery],lastEventQuery=>lastEventQuery?{...lastEventQuery,after:"-30d"}:null],templateHasChanged:[s=>[s.hogFunction,s.configuration],(hogFunction,configuration)=>hogFunction?.template?.hog&&hogFunction.template.hog!==configuration.hog],mappingTemplates:[s=>[s.hogFunction,s.template],(hogFunction,template)=>{var _ref19,_template$mapping_tem;return null!==(_ref19=null!==(_template$mapping_tem=template?.mapping_templates)&&void 0!==_template$mapping_tem?_template$mapping_tem:hogFunction?.template?.mapping_templates)&&void 0!==_ref19?_ref19:[]}],usesGroups:[s=>[s.configuration],configuration=>{let configStr=JSON.stringify(configuration);return configStr.includes("groups.")||configStr.includes("{groups}")}],mightDropEvents:[s=>[s.configuration,s.type],(configuration,type)=>"transformation"===type&&mightDropEvents(configuration.hog||"")],currentHogCode:[s=>[s.newHogCode,s.configuration],(newHogCode,configuration)=>{var _ref20;return null!==(_ref20=null!=newHogCode?newHogCode:configuration.hog)&&void 0!==_ref20?_ref20:""}],canLoadSampleGlobals:[s=>[s.lastEventQuery],lastEventQuery=>!!lastEventQuery]})),(0,index_esm.listeners)(_ref21=>{let{actions,values,cache}=_ref21;return{reportAIHogFunctionPrompted:()=>{dist_module.ZP.capture("ai_hog_function_prompted",{type:values.type})},reportAIHogFunctionAccepted:()=>{dist_module.ZP.capture("ai_hog_function_accepted",{type:values.type})},reportAIHogFunctionRejected:()=>{dist_module.ZP.capture("ai_hog_function_rejected",{type:values.type})},reportAIHogFunctionPromptOpen:()=>{dist_module.ZP.capture("ai_hog_function_prompt_open",{type:values.type})},loadTemplateSuccess:()=>actions.resetForm(),loadHogFunctionSuccess:()=>{var _values$hogFunction$n;actions.resetForm(),actions.setBreadcrumbTitle(null!==(_values$hogFunction$n=values.hogFunction?.name)&&void 0!==_values$hogFunction$n?_values$hogFunction$n:"Unnamed")},upsertHogFunctionSuccess:()=>{var _values$hogFunction$n2;actions.resetForm(),actions.setBreadcrumbTitle(null!==(_values$hogFunction$n2=values.hogFunction?.name)&&void 0!==_values$hogFunction$n2?_values$hogFunction$n2:"Unnamed")},upsertHogFunctionFailure:_ref22=>{let{errorObject}=_ref22,maybeValidationError=errorObject.data;maybeValidationError?.type==="validation_error"?setTimeout(()=>{maybeValidationError.attr.includes("inputs__")?actions.setConfigurationManualErrors({inputs:{[maybeValidationError.attr.split("__")[1]]:maybeValidationError.detail}}):actions.setConfigurationManualErrors({[maybeValidationError.attr]:maybeValidationError.detail})},1):(console.error(errorObject),src.UJ.error("Error submitting configuration"))},resetForm:()=>{var _cache$configFromUrl,_cache$paramsFromUrl,_values$unsavedConfig,_config$mappings,_values$configuration2;let baseConfig=values.defaultFormState;if(!baseConfig)return;let config={...baseConfig,...null!==(_cache$configFromUrl=cache.configFromUrl)&&void 0!==_cache$configFromUrl?_cache$configFromUrl:{}};values.template?.mapping_templates&&(config.mappings=[...null!==(_config$mappings=config.mappings)&&void 0!==_config$mappings?_config$mappings:[],...values.template.mapping_templates.filter(t=>t.include_by_default).map(template=>({...template,inputs:template.inputs_schema?.reduce((acc,input)=>(acc[input.key]={value:input.default},acc),{})}))]);let paramsFromUrl=null!==(_cache$paramsFromUrl=cache.paramsFromUrl)&&void 0!==_cache$paramsFromUrl?_cache$paramsFromUrl:{},unsavedConfigurationToApply=(null!==(_values$unsavedConfig=values.unsavedConfiguration?.timestamp)&&void 0!==_values$unsavedConfig?_values$unsavedConfig:0)>Date.now()-3e5?values.unsavedConfiguration?.configuration:null;if(actions.resetConfiguration(config),unsavedConfigurationToApply&&actions.setConfigurationValues(unsavedConfigurationToApply),actions.setUnsavedConfiguration(null),paramsFromUrl.integration_target&&paramsFromUrl.integration_id){let inputs=null!==(_values$configuration2=values.configuration?.inputs)&&void 0!==_values$configuration2?_values$configuration2:{};inputs[paramsFromUrl.integration_target]={value:paramsFromUrl.integration_id},actions.setConfigurationValues({inputs})}},duplicate:async()=>{if(values.hogFunction){let newConfig={...values.configuration,name:`${values.configuration.name} (copy)`},originalTemplate=values.hogFunction.template;kea_router_lib.router.actions.push(urls.j.hogFunctionNew(originalTemplate.id),void 0,{configuration:newConfig})}},duplicateFromTemplate:async()=>{if(values.hogFunction?.template){let newConfig={...values.hogFunction.template};kea_router_lib.router.actions.push(urls.j.hogFunctionNew(values.hogFunction.template.id),void 0,{configuration:newConfig})}},resetToTemplate:async()=>{var _values$hogFunction$t,_config$inputs,_values$configuration3,_config$filters;let template=null!==(_values$hogFunction$t=values.hogFunction?.template)&&void 0!==_values$hogFunction$t?_values$hogFunction$t:values.template;if(template){let config=templateToConfiguration(template),inputs=null!==(_config$inputs=config.inputs)&&void 0!==_config$inputs?_config$inputs:{};Object.entries(null!==(_values$configuration3=values.configuration.inputs)&&void 0!==_values$configuration3?_values$configuration3:{}).forEach(_ref23=>{var _inputs$key;let[key,value]=_ref23;inputs[key]=null!==(_inputs$key=inputs[key])&&void 0!==_inputs$key?_inputs$key:value}),actions.setConfigurationValues({...config,filters:null!==(_config$filters=config.filters)&&void 0!==_config$filters?_config$filters:values.configuration.filters,name:values.configuration.name,description:values.configuration.description}),src.UJ.success("Template updates applied but not saved.")}},setConfigurationValue:()=>{values.hasHadSubmissionErrors&&actions.setConfigurationManualErrors({})},deleteHogFunction:async()=>{let hogFunction=values.hogFunction;hogFunction&&(await (0,deleteWithUndo.S)({endpoint:`projects/${values.currentProjectId}/hog_functions`,object:{id:hogFunction.id,name:hogFunction.name},callback(undo){undo?(kea_router_lib.router.actions.replace(urls.j.hogFunction(hogFunction.id)),(0,projectTreeLogic.BI)("hog_function/",hogFunction.id)):(0,projectTreeLogic.qJ)("hog_function/",hogFunction.id)}}),kea_router_lib.router.actions.replace(urls.j.hogFunction(hogFunction.id)))},persistForUnload:()=>{actions.setUnsavedConfiguration(values.configuration)}}}),(0,index_esm.afterMount)(_ref24=>{let{props,actions,cache}=_ref24;if(cache.paramsFromUrl={integration_id:kea_router_lib.router.values.searchParams.integration_id,integration_target:kea_router_lib.router.values.searchParams.integration_target},props.templateId?(cache.configFromUrl=kea_router_lib.router.values.hashParams.configuration,actions.loadTemplate()):props.id&&"new"!==props.id&&actions.loadHogFunction(),kea_router_lib.router.values.searchParams.integration_target){let searchParams=kea_router_lib.router.values.searchParams;delete searchParams.integration_id,delete searchParams.integration_target,kea_router_lib.router.actions.replace(kea_router_lib.router.values.location.pathname,searchParams,kea_router_lib.router.values.hashParams)}}),(0,kea_subscriptions_lib.Vt)(_ref25=>{let{props,actions,cache}=_ref25;return{hogFunction:hogFunction=>{hogFunction&&props.templateId&&(cache.disabledBeforeUnload=!0,kea_router_lib.router.actions.replace(urls.j.hogFunction(hogFunction.id)))},sparklineQuery:async sparklineQuery=>{sparklineQuery&&actions.sparklineQueryChanged(sparklineQuery)},personsCountQuery:async personsCountQuery=>{personsCountQuery&&actions.personsCountQueryChanged(personsCountQuery)}}}),(0,kea_router_lib.beforeUnload)(_ref26=>{let{values,cache}=_ref26;return{enabled:newLocation=>{if(cache.disabledBeforeUnload||values.unsavedConfiguration||!values.configurationChanged)return!1;let oldRoute=kea_router_lib.router.values.location.pathname.replace(/\/project\/\d+/,"").split("/"),newRoute=newLocation?.pathname.replace(/\/project\/\d+/,"").split("/");if(!newRoute||newRoute.length!==oldRoute.length)return!0;for(let i=0;i<oldRoute.length-1;i++)if(oldRoute[i]!==newRoute[i])return!0;let possibleMenuIds=[types.il.Configuration,types.il.Testing];return!(possibleMenuIds.includes(newRoute[newRoute.length-1])&&possibleMenuIds.includes(oldRoute[newRoute.length-1]))},message:"Changes you made will be discarded.",onConfirm:()=>{cache.disabledBeforeUnload=!0}}})])},"../../frontend/src/scenes/hog-functions/configuration/hogFunctionTestLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{g:()=>hogFunctionTestLogic});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/utils.tsx"),lib_utils_getAppContext__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/utils/getAppContext.ts"),_models_groupsModel__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/models/groupsModel.ts"),_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx");let convertToTransformationEvent=result=>{var _result$properties,_properties$$ip;let properties=null!==(_result$properties=result.properties)&&void 0!==_result$properties?_result$properties:{};return properties.$ip=null!==(_properties$$ip=properties.$ip)&&void 0!==_properties$$ip?_properties$$ip:"89.160.20.129",delete properties.$transformations_failed,delete properties.$transformations_succeeded,delete properties.$transformations_skipped,{event:result.event,uuid:result.uuid,distinct_id:result.distinct_id,timestamp:result.timestamp,properties}},convertFromTransformationEvent=result=>(delete result.properties.$transformations_failed,delete result.properties.$transformations_succeeded,delete result.properties.$transformations_skipped,{event:result.event,uuid:result.uuid,distinct_id:result.distinct_id,timestamp:result.timestamp,properties:result.properties}),hogFunctionTestLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.key)(_ref=>{var _ref2;let{id,templateId}=_ref;return null!==(_ref2=null!=id?id:templateId)&&void 0!==_ref2?_ref2:"new"}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(id=>["scenes","pipeline","hogfunctions","hogFunctionTestLogic",id]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.connect)(props=>({values:[(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.nM)(props),["configuration","templateId","configurationHasErrors","sampleGlobals","sampleGlobalsLoading","exampleInvocationGlobals","sampleGlobalsError","type","currentHogCode"],_models_groupsModel__WEBPACK_IMPORTED_MODULE_6__.$,["groupTypes"]],actions:[(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.nM)(props),["touchConfigurationField","loadSampleGlobalsSuccess","loadSampleGlobals","setSampleGlobals"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({setTestResult:result=>({result}),toggleExpanded:expanded=>({expanded}),saveGlobals:(name,globals)=>({name,globals}),deleteSavedGlobals:index=>({index}),setTestResultMode:mode=>({mode}),receiveExampleGlobals:globals=>({globals}),setJsonError:error=>({error}),validateJson:(value,editor,decorations)=>({value,editor,decorations}),setDecorationIds:decorationIds=>({decorationIds}),cancelSampleGlobalsLoading:!0}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.reducers)({expanded:[!1,{toggleExpanded:(state,_ref3)=>{let{expanded}=_ref3;return void 0===expanded?!state:expanded}}],testResult:[null,{setTestResult:(_,_ref4)=>{let{result}=_ref4;return result}}],testResultMode:["diff",{setTestResultMode:(_,_ref5)=>{let{mode}=_ref5;return mode}}],savedGlobals:[[],{persist:!0,prefix:`${(0,lib_utils_getAppContext__WEBPACK_IMPORTED_MODULE_5__.ev)()}__`},{saveGlobals:(state,_ref6)=>{let{name,globals}=_ref6;return[...state,{name,globals}]},deleteSavedGlobals:(state,_ref7)=>{let{index}=_ref7;return state.filter((_,i)=>i!==index)}}],jsonError:[null,{setJsonError:(_,_ref8)=>{let{error}=_ref8;return error}}],currentDecorationIds:[[],{setDecorationIds:(_,_ref9)=>{let{decorationIds}=_ref9;return decorationIds},setJsonError:()=>[]}],fetchCancelled:[!1,{loadSampleGlobals:()=>!1,cancelSampleGlobalsLoading:()=>!0,toggleExpanded:()=>!1}]}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.listeners)(_ref10=>{let{values,actions}=_ref10;return{loadSampleGlobalsSuccess:()=>{values.expanded&&!values.fetchCancelled&&values.sampleGlobals&&actions.receiveExampleGlobals(values.sampleGlobals)},setSampleGlobals:_ref11=>{let{sampleGlobals}=_ref11;actions.receiveExampleGlobals(sampleGlobals)},receiveExampleGlobals:_ref12=>{let{globals}=_ref12;if(globals){if("transformation"===values.type){let event=convertToTransformationEvent(globals.event);actions.setTestInvocationValue("globals",JSON.stringify(event,null,2))}else actions.setTestInvocationValue("globals",JSON.stringify(globals,null,2))}},validateJson:_ref13=>{let{value,editor,decorations}=_ref13;if(!editor?.getModel())return;let model=editor.getModel();try{JSON.parse(value),actions.setJsonError(null),editor.removeDecorations(decorations)}catch(err){actions.setJsonError(err.message);let match=err.message.match(/position (\d+)/);if(!match)return;let position=parseInt(match[1],10),pos=model.getPositionAt(position);editor.createDecorationsCollection([{range:{startLineNumber:pos.lineNumber,startColumn:pos.column,endLineNumber:pos.lineNumber,endColumn:pos.column+1},options:{isWholeLine:!0,className:"bg-danger-highlight",glyphMarginClassName:"text-danger flex items-center justify-center",glyphMarginHoverMessage:{value:err.message}}}]),editor.revealLineInCenter(pos.lineNumber)}},setTestResult:_ref14=>{let{result}=_ref14;result&&setTimeout(()=>{let testResults=document.querySelector('[data-attr="test-results"]');testResults&&testResults.scrollIntoView({behavior:"smooth",block:"start"});let editors=document.querySelectorAll('[data-attr="test-results"] .monaco-editor');if(editors.length>0&&values.sortedTestsResult?.hasDiff){let monacoEditor=editors[editors.length-1].querySelector(".monaco-scrollable-element");if(monacoEditor){let inputLines=values.sortedTestsResult.input.split("\n"),outputLines=values.sortedTestsResult.output.split("\n"),diffLineIndex=0;for(let i=0;i<Math.max(inputLines.length,outputLines.length);i++)if(inputLines[i]!==outputLines[i]){diffLineIndex=i;break}monacoEditor.scrollTop=Math.max(0,(diffLineIndex-2)*19)}}},100)},cancelSampleGlobalsLoading:()=>{}}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_2__.forms)(_ref15=>{let{props,actions,values}=_ref15;return{testInvocation:{defaults:{mock_async_functions:!1},alwaysShowErrors:!0,errors:_ref16=>{let{globals}=_ref16;return{globals:globals?(0,lib_utils__WEBPACK_IMPORTED_MODULE_4__.Cy)(globals)?void 0:"Invalid JSON":"Required"}},submit:async data=>{if(values.configurationHasErrors){let configLogic=(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.nM)(props),errorMessages=Object.entries(configLogic.values.inputFormErrors?.inputs||{}).map(_ref17=>{let[key,error]=_ref17;return`${key}: ${"string"==typeof error?error:"Invalid format"}`}),message=errorMessages.length>0?`Please fix the following errors:
${errorMessages.join("\n")}`:"Please fix the configuration errors before testing.";_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.UJ.error(message,{toastId:"hogfunction-validation-error"}),configLogic.actions.touchConfigurationField&&configLogic.actions.touchConfigurationField("inputs");return}let parsedData=(0,lib_utils__WEBPACK_IMPORTED_MODULE_4__.Cy)(data.globals),configuration=(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.r9)(values.configuration);configuration.template_id=values.templateId,configuration.hog=values.currentHogCode;let globals="transformation"===values.type?{event:parsedData}:parsedData;try{var _props$id;let res=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.hogFunctions.createTestInvocation(null!==(_props$id=props.id)&&void 0!==_props$id?_props$id:"new",{globals,mock_async_functions:data.mock_async_functions,configuration});"transformation"===values.type&&res.result&&(res.result=convertFromTransformationEvent(res.result)),actions.setTestResult(res)}catch(e){_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.UJ.error(`An unexpected server error occurred while testing the function. ${e}`)}}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.selectors)(()=>({sortedTestsResult:[s=>[s.configuration,s.testResult,s.testInvocation],(configuration,testResult,testInvocation)=>{if(!testResult||"transformation"!==configuration.type)return null;let input=JSON.stringify(JSON.parse(testInvocation.globals),null,2),output=JSON.stringify(testResult.result,null,2);return{input,output,hasDiff:input!==output}}],sampleGlobalsLoadingAndNotCancelled:[s=>[s.sampleGlobalsLoading,s.fetchCancelled],(sampleGlobalsLoading,fetchCancelled)=>sampleGlobalsLoading&&!fetchCancelled]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.afterMount)(_ref18=>{let{actions,values}=_ref18;actions.receiveExampleGlobals(values.exampleInvocationGlobals)})])},"../../frontend/src/scenes/hog-functions/email-templater/EmailTemplater.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{N:()=>EmailTemplater});var src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),CodeEditorInline=__webpack_require__("../../frontend/src/lib/monaco/CodeEditorInline.tsx"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),dist=__webpack_require__("../../node_modules/.pnpm/react-email-editor@1.7.11_react@18.2.0/node_modules/react-email-editor/dist/index.js"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),types=__webpack_require__("../../frontend/src/types.ts");let emailTemplaterLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.path)(()=>["scenes","pipeline","hogfunctions","emailTemplaterLogic"]),(0,index_esm.actions)({setEmailEditorRef:emailEditorRef=>({emailEditorRef}),onEmailEditorReady:!0,setIsModalOpen:isModalOpen=>({isModalOpen}),applyTemplate:template=>({template}),closeWithConfirmation:!0}),(0,index_esm.reducers)({emailEditorRef:[null,{setEmailEditorRef:(_,_ref)=>{let{emailEditorRef}=_ref;return emailEditorRef}}],isEmailEditorReady:[!1,{setIsModalOpen:()=>!1,onEmailEditorReady:()=>!0}],isModalOpen:[!1,{setIsModalOpen:(_,_ref2)=>{let{isModalOpen}=_ref2;return isModalOpen}}],appliedTemplate:[null,{applyTemplate:(_,_ref3)=>{let{template}=_ref3;return template}}]}),(0,kea_loaders_lib.loaders)(()=>({templates:[[],{loadTemplates:async()=>(await api.ZP.messaging.getTemplates()).results}],personPropertyDefinitions:[[],{loadPersonPropertyDefinitions:async()=>(await api.ZP.propertyDefinitions.list({type:types.ll.Person,limit:1e3})).results}]})),(0,index_esm.selectors)({logicProps:[()=>[(_,props)=>props],props=>props],mergeTags:[s=>[s.personPropertyDefinitions],personPropertyDefinitions=>{let tags={};return personPropertyDefinitions.forEach(property=>{tags[property.name]={name:property.name,value:`{{person.properties["${property.name}"]}}`,sample:property.example||`Sample ${property.name}`}}),tags}]}),(0,lib.forms)(_ref4=>{let{actions,values,props}=_ref4;return{emailTemplate:{defaults:{from:"",subject:"",to:"",html:"",design:null,text:""},submit:async value=>{let editor=values.emailEditorRef?.editor;if(!editor||!values.isEmailEditorReady)return;let[htmlData,textData]=await Promise.all([new Promise(res=>editor.exportHtml(res)),new Promise(res=>editor.exportPlainText(res))]),finalValues={...value,html:escapeHTMLStringCurlies(htmlData.html),text:textData.text,design:htmlData.design};props.onChange(finalValues),actions.setIsModalOpen(!1)}}}}),(0,index_esm.listeners)(_ref5=>{let{props,values,actions}=_ref5;return{onEmailEditorReady:()=>{props.value?.design&&values.emailEditorRef?.editor?.loadDesign(props.value.design)},setEmailTemplateValue:_ref6=>{let{name,value}=_ref6;if(values.isModalOpen||"html"===name)return;let key=Array.isArray(name)?name[0]:name;props.onChange({...props.value,[key]:value})},applyTemplate:_ref7=>{let{template}=_ref7,emailTemplateContent=template.content.email;actions.setEmailTemplateValues(emailTemplateContent)},closeWithConfirmation:()=>{values.emailTemplateChanged?src.dn.open({title:"Discard changes",description:"Are you sure you want to discard your changes?",primaryButton:{onClick:()=>{var _props$value;actions.resetEmailTemplate(null!==(_props$value=props.value)&&void 0!==_props$value?_props$value:void 0),actions.setIsModalOpen(!1)},children:"Discard"},secondaryButton:{children:"Keep editing"}}):actions.setIsModalOpen(!1)}}}),(0,index_esm.propsChanged)((_ref8,oldProps)=>{let{actions,props}=_ref8;props.value&&!(0,utils.h0)(props.value,oldProps.value)&&actions.resetEmailTemplate(props.value)}),(0,index_esm.afterMount)(_ref9=>{let{actions,props}=_ref9;props.value&&actions.resetEmailTemplate(props.value),actions.loadTemplates(),actions.loadPersonPropertyDefinitions()})]);function escapeHTMLStringCurlies(htmlString){let doc=new DOMParser().parseFromString(htmlString,"text/html");function escapeCurlyBraces(text){return text.replace(/{/g,"\\{")}function processNode(node){node.nodeType===Node.ELEMENT_NODE?"STYLE"===node.tagName||"SCRIPT"===node.tagName?node.textContent=escapeCurlyBraces(node.textContent||""):Array.from(node.childNodes).forEach(processNode):node.nodeType===Node.COMMENT_NODE&&(node.nodeValue=escapeCurlyBraces(node.nodeValue||""))}return processNode(doc.head),processNode(doc.body),new XMLSerializer().serializeToString(doc)}var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function EmailTemplaterForm(_ref){let{mode}=_ref,{logicProps,appliedTemplate,templates,templatesLoading,mergeTags}=(0,index_esm.useValues)(emailTemplaterLogic),{setEmailEditorRef,onEmailEditorReady,setIsModalOpen,applyTemplate}=(0,index_esm.useActions)(emailTemplaterLogic),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.featureFlagLogic),isMessagingTemplatesEnabled=featureFlags[constants.y8.MESSAGING_LIBRARY];return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[isMessagingTemplatesEnabled&&templates.length>0&&(0,jsx_runtime.jsx)(src.Yv,{className:"mb-2",placeholder:"Start from a template (optional)",loading:templatesLoading,value:appliedTemplate?.id,options:templates.map(template=>({label:template.name,value:template.id})),onChange:id=>{let template=templates.find(t=>t.id===id);template&&applyTemplate(template)},"data-attr":"email-template-selector"}),(0,jsx_runtime.jsxs)(lib.Form,{className:"flex overflow-hidden flex-col flex-1 rounded border",logic:emailTemplaterLogic,props:logicProps,formKey:"emailTemplate",children:[(logicProps.emailMetaFields||["from","to","subject"]).map(field=>(0,jsx_runtime.jsx)(LemonField.D,{name:field,className:"gap-1 pl-2 border-b shrink-0",renderError:()=>null,children:_ref2=>{let{value,onChange,error}=_ref2;return(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)(src.HQ,{className:error?"text-danger":"",children:(0,utils.fm)(field)}),(0,jsx_runtime.jsx)(CodeEditorInline.s,{embedded:!0,className:"flex-1",globals:logicProps.variables,value:value,onChange:onChange})]})}},field)),"full"===mode?(0,jsx_runtime.jsx)(dist.default,{ref:r=>setEmailEditorRef(r),onReady:()=>onEmailEditorReady(),minHeight:20,options:{mergeTags,displayMode:"email",features:{preview:!0,imageEditor:!0,stockImages:!1}}}):(0,jsx_runtime.jsx)(LemonField.D,{name:"html",className:"flex relative flex-col",children:_ref3=>{let{value}=_ref3;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex absolute inset-0 justify-center items-end p-2 opacity-0 transition-opacity hover:opacity-100",children:[(0,jsx_runtime.jsx)("div",{className:"absolute inset-0 opacity-50 bg-surface-primary"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",size:"small",onClick:()=>setIsModalOpen(!0),children:"Click to modify content"})]}),(0,jsx_runtime.jsx)("iframe",{srcDoc:value,className:"flex-1"})]})}})]})]})}function EmailTemplaterModal(){let{isModalOpen,isEmailEditorReady,emailTemplateChanged}=(0,index_esm.useValues)(emailTemplaterLogic),{closeWithConfirmation,submitEmailTemplate}=(0,index_esm.useActions)(emailTemplaterLogic);return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isModalOpen,width:"90vw",onClose:()=>closeWithConfirmation(),hasUnsavedInput:emailTemplateChanged,children:(0,jsx_runtime.jsx)("div",{className:"h-[80vh] flex",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,jsx_runtime.jsx)("div",{className:"shrink-0",children:(0,jsx_runtime.jsx)("h2",{children:"Editing email template"})}),(0,jsx_runtime.jsx)(EmailTemplaterForm,{mode:"full"}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center mt-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>closeWithConfirmation(),children:"Discard changes"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>submitEmailTemplate(),disabledReason:isEmailEditorReady?void 0:"Loading email editor...",children:"Save"})]})]})})})}function EmailTemplater(props){return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:emailTemplaterLogic,props:props,children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,jsx_runtime.jsx)(EmailTemplaterForm,{mode:"preview"}),(0,jsx_runtime.jsx)(EmailTemplaterModal,{})]})})}},"../../frontend/src/scenes/hog-functions/filters/HogFunctionFilters.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{B:()=>HogFunctionFilters});var src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),chartjs_plugin_trendline=__webpack_require__("../../node_modules/.pnpm/chartjs-plugin-trendline@2.1.2/node_modules/chartjs-plugin-trendline/src/chartjs-plugin-trendline.js"),clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),PropertyFilters=__webpack_require__("../../frontend/src/lib/components/PropertyFilters/PropertyFilters.tsx"),types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),TestAccountFiltersSwitch=__webpack_require__("../../frontend/src/lib/components/TestAccountFiltersSwitch.tsx"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),ActionFilter=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),src_types=__webpack_require__("../../frontend/src/types.ts"),hogFunctionConfigurationLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx"),useFeatureFlag=__webpack_require__("../../frontend/src/lib/hooks/useFeatureFlag.ts"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let getFilterOptions=contextId=>{switch(contextId){case"error-tracking":return[{label:"Error tracking issue created",value:"$error_tracking_issue_created"},{label:"Error tracking issue reopened",value:"$error_tracking_issue_reopened"}];case"insight-alerts":return[{label:"Insight alert firing",value:"$insight_alert_firing"}];default:return[{label:"Team activity",value:"$activity_log_entry_created"},{label:"Early access feature updated",value:"$early_access_feature_updated"}]}},getSimpleFilterValue=value=>value?.events?.[0]?.id,setSimpleFilterValue=(options,value)=>({events:[{name:options.find(option=>option.value===value)?.label,id:value,type:"events"}]});function HogFunctionFiltersInternal(){let{contextId}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),options=(0,react.useMemo)(()=>getFilterOptions(contextId),[contextId]),hasAlertRouting=(0,useFeatureFlag.y)("ERROR_TRACKING_ALERT_ROUTING"),taxonomicGroupTypes=(0,react.useMemo)(()=>hasAlertRouting&&"error-tracking"===contextId?[types.t.ErrorTrackingIssues]:"insight-alerts"===contextId?[types.t.Events]:[],[contextId,hasAlertRouting]);return(0,jsx_runtime.jsx)("div",{className:"p-3 rounded border deprecated-space-y-2 bg-surface-primary",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:"Trigger",children:_ref=>{var _value$properties;let{value,onChange}=_ref;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary",children:"Choose what event should trigger this destination"}),(0,jsx_runtime.jsx)(src.Yv,{options:options,value:getSimpleFilterValue(value),onChange:value=>onChange(setSimpleFilterValue(options,value)),placeholder:"Select a filter"}),taxonomicGroupTypes.length>0?(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:null!==(_value$properties=value?.properties)&&void 0!==_value$properties?_value$properties:[],taxonomicGroupTypes:taxonomicGroupTypes,onChange:properties=>{onChange({...value,properties})},pageKey:`hog-function-internal-property-filters-${contextId}`,buttonSize:"small",disablePopover:!0},contextId):null]})}})})}function sanitizeActionFilters(filters){if(!filters)return{};let sanitized={};return filters.events&&(sanitized.events=filters.events.map(f=>({id:f.id,type:"events",name:f.name,order:f.order,properties:f.properties}))),filters.actions&&(sanitized.actions=filters.actions.map(f=>({id:f.id,type:"actions",name:f.name,order:f.order,properties:f.properties}))),sanitized}function HogFunctionFilters(_ref){let{embedded=!1}=_ref,{groupsTaxonomicTypes}=(0,index_esm.useValues)(groupsModel.$),{configuration,type,useMapping,filtersContainPersonProperties}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM);if("broadcast"===type)return(0,jsx_runtime.jsx)("div",{className:"p-3 border rounded deprecated-space-y-2 bg-surface-primary",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:"Filters",children:_ref2=>{var _value$properties;let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:null!==(_value$properties=value?.properties)&&void 0!==_value$properties?_value$properties:[],taxonomicGroupTypes:[types.t.PersonProperties,types.t.Cohorts,types.t.HogQLExpression],onChange:properties=>{onChange({...value,properties})},pageKey:`HogFunctionPropertyFilters.${chartjs_plugin_trendline.id}`,metadataSource:{kind:schema_general.OH.ActorsQuery}})}})});if("internal_destination"===type)return(0,jsx_runtime.jsx)(HogFunctionFiltersInternal,{});let isLegacyPlugin=configuration?.template?.id?.startsWith("plugin-"),showMasking="destination"===type&&!isLegacyPlugin,isTransformation="transformation"===type;return(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("deprecated-space-y-2 rounded bg-surface-primary",!embedded&&"border p-3",embedded&&"p-2"),children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:useMapping?"Global filters":"Filters",info:useMapping?"Filters applied to all events before they reach a mapping":"Filters applied to all events",children:_ref3=>{var _filters$filter_test_,_filters$properties;let{value,onChange}=_ref3,filters=null!=value?value:{};return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[useMapping&&(0,jsx_runtime.jsx)("p",{className:"mb-0 text-sm text-secondary",children:"Filters here apply for all events that could trigger this function, regardless of mappings."}),!isTransformation&&(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:null!==(_filters$filter_test_=filters?.filter_test_accounts)&&void 0!==_filters$filter_test_&&_filters$filter_test_,onChange:filter_test_accounts=>onChange({...filters,filter_test_accounts}),fullWidth:!0}),(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:null!==(_filters$properties=filters?.properties)&&void 0!==_filters$properties?_filters$properties:[],taxonomicGroupTypes:isTransformation?[types.t.EventProperties,types.t.HogQLExpression]:[types.t.EventProperties,types.t.PersonProperties,types.t.EventFeatureFlags,types.t.Elements,types.t.HogQLExpression,...groupsTaxonomicTypes],onChange:properties=>{onChange({...filters,properties})},pageKey:`HogFunctionPropertyFilters.${chartjs_plugin_trendline.id}`}),useMapping?null:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-between w-full gap-2",children:(0,jsx_runtime.jsx)(src.HQ,{children:isTransformation?"Match events":"Match events and actions"})}),(0,jsx_runtime.jsxs)("p",{className:"mb-0 text-xs text-secondary",children:["If set, the ",type," will only run if the ",(0,jsx_runtime.jsx)("b",{children:"event matches any"})," of the below."]}),(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:null!=value?value:{},setFilters:payload=>{onChange({...value,...sanitizeActionFilters(payload)})},typeKey:"plugin-filters",mathAvailability:ActionFilterRow.Qq.None,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:isTransformation?[types.t.Events]:[types.t.Events,types.t.Actions],propertiesTaxonomicGroupTypes:isTransformation?[types.t.EventProperties,types.t.HogQLExpression]:[types.t.EventProperties,types.t.EventFeatureFlags,types.t.Elements,types.t.PersonProperties,types.t.HogQLExpression,...groupsTaxonomicTypes],propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:src_types.DC.EVENTS},buttonCopy:"Add event matcher"}),!1]})]})}}),filtersContainPersonProperties?(0,jsx_runtime.jsx)(src.Vp,{type:"warning",children:"You are filtering on Person properties. Be aware that this filtering applies at the time the event is processed so if Person Profiles are not enabled or the person property has not been set by then then the filters may not work as expected."}):null,showMasking?(0,jsx_runtime.jsx)(LemonField.D,{name:"masking",label:"Trigger options",children:_ref4=>{var _value$hash;let{value,onChange}=_ref4;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[(0,jsx_runtime.jsx)(src.Yv,{options:[{value:null,label:"Run every time"},{value:"all",label:"Run once per interval"},{value:"{person.id}",label:"Run once per person per interval"},{value:"{concat(person.id, event.event)}",label:"Run once per person per event name per interval"}],value:null!==(_value$hash=value?.hash)&&void 0!==_value$hash?_value$hash:null,onChange:val=>{var _value$ttl;return onChange({hash:val,ttl:null!==(_value$ttl=value?.ttl)&&void 0!==_value$ttl?_value$ttl:1800})}}),configuration.masking?.hash?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[(0,jsx_runtime.jsx)("span",{children:"of"}),(0,jsx_runtime.jsx)(src.Yv,{value:value?.ttl,onChange:val=>onChange({...value,ttl:val}),options:[{value:300,label:"5 minutes"},{value:900,label:"15 minutes"},{value:1800,label:"30 minutes"},{value:3600,label:"1 hour"},{value:7200,label:"2 hours"},{value:14400,label:"4 hours"},{value:28800,label:"8 hours"},{value:43200,label:"12 hours"},{value:86400,label:"24 hours"}]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[(0,jsx_runtime.jsx)("span",{children:"or until"}),(0,jsx_runtime.jsx)(src.Yv,{value:value?.threshold,onChange:val=>onChange({...value,threshold:val}),options:[{value:null,label:"Not set"},{value:1e3,label:"1000 events"},{value:1e4,label:"10,000 events"},{value:1e5,label:"100,000 events"},{value:1e6,label:"1,000,000 events"}]})]})]}):null]})}}):null]})}},"../../frontend/src/scenes/hog-functions/logs/HogFunctionLogs.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{x:()=>HogFunctionLogs});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.22.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),hogFunctionTestLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionTestLogic.tsx"),api=__webpack_require__("../../frontend/src/lib/api.ts"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),queries_utils=__webpack_require__("../../frontend/src/queries/utils.ts"),logsViewerLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/logs/logsViewerLogic.tsx");let eventIdMatchers=[/Event: ([A-Za-z0-9-]+)/,/\/events\/([A-Za-z0-9-]+)\//,/event ([A-Za-z0-9-]+)/];async function runWithParallelism(items,maxParallel,asyncFn){let results=[],executing=new Set;for(let item of items){let promise=(async()=>{let result=await asyncFn(item);results.push(result)})();executing.add(promise),promise.finally(()=>executing.delete(promise)),executing.size>=maxParallel&&await Promise.race(executing)}return await Promise.all(executing),results}let loadClickhouseEvents=async(eventIds,_ref)=>{let{date_from,date_to}=_ref,query=(0,queries_utils.zP)`
        SELECT uuid, distinct_id, event, timestamp, properties, elements_chain, person.id, person.properties, person.created_at 
        FROM events
        WHERE uuid in (${queries_utils.zP.raw(eventIds.map(x=>`'${x}'`).join(","))})
        AND timestamp > {filters.dateRange.from}
        AND timestamp < {filters.dateRange.to}`;return(await api.ZP.queryHogQL(query,{refresh:"force_blocking",filtersOverride:{date_from:date_from,date_to:date_to}})).results.map(x=>{let[uuid,distinct_id,event,timestamp,properties,elements_chain,person_id,person_properties,person_created_at]=x;return{uuid,event,distinct_id,person_id,timestamp,properties,elements_chain,person_created_at,person_properties}})},hogFunctionLogsLogic=(0,index_esm.kea)([(0,index_esm.path)(key=>["scenes","pipeline","hogfunctions","logs","hogFunctionLogsLogic",key]),(0,index_esm.props)({}),(0,index_esm.key)(_ref2=>{let{sourceType,sourceId}=_ref2;return`${sourceType}:${sourceId}`}),(0,index_esm.connect)(props=>({values:[(0,logsViewerLogic.WC)(props),["logs"]],actions:[(0,logsViewerLogic.WC)(props),["addLogGroups","setRowExpanded"]]})),(0,index_esm.actions)({setSelectingMany:selectingMany=>({selectingMany}),setSelectedForRetry:selectedForRetry=>({selectedForRetry}),selectAllForRetry:!0,retryInvocation:(groupedLogEntry,eventId)=>({groupedLogEntry,eventId}),retryInvocations:groupedLogEntries=>({groupedLogEntries}),retryInvocationStarted:groupedLogEntry=>({groupedLogEntry}),retryInvocationSuccess:groupedLogEntry=>({groupedLogEntry}),retryInvocationFailure:groupedLogEntry=>({groupedLogEntry}),retrySelectedInvocations:!0}),(0,index_esm.reducers)({selectingMany:[!1,{setSelectingMany:(_,_ref3)=>{let{selectingMany}=_ref3;return selectingMany}}],selectedForRetry:[{},{setSelectedForRetry:(state,_ref4)=>{let{selectedForRetry}=_ref4,newState={...state};return Object.keys(selectedForRetry).forEach(key=>{newState[key]=selectedForRetry[key],selectedForRetry[key]||delete newState[key]}),newState},setSelectingMany:(state,_ref5)=>{let{selectingMany}=_ref5;return selectingMany?state:{}}}],retries:[{},{retryInvocationStarted:(state,_ref6)=>{let{groupedLogEntry}=_ref6;return{...state,[groupedLogEntry.instanceId]:"pending"}},retryInvocationSuccess:(state,_ref7)=>{let{groupedLogEntry}=_ref7;return{...state,[groupedLogEntry.instanceId]:"success"}},retryInvocationFailure:(state,_ref8)=>{let{groupedLogEntry}=_ref8;return{...state,[groupedLogEntry.instanceId]:"failure"}}}]}),(0,index_esm.selectors)({retryRunning:[s=>[s.retries],retries=>Object.values(retries).some(x=>"pending"===x)],eventIdByInvocationId:[s=>[s.logs],logs=>{let eventIdByInvocationId={};for(let record of logs){let entryContainingEventId=record.entries.find(entry=>entry.message.includes("Function completed")||entry.message.includes("Suspending function")||entry.message.includes("Error executing function on event"));if(!entryContainingEventId)return;for(let matcher of eventIdMatchers){let match=entryContainingEventId.message.match(matcher);if(match){eventIdByInvocationId[record.instanceId]=match[1];break}}}return eventIdByInvocationId}]}),(0,index_esm.listeners)(_ref9=>{let{actions,props,values}=_ref9;return{retryInvocations:async _ref10=>{let{groupedLogEntries}=_ref10;await src.UJ.promise((async _values$eventIdByInvo=>{for(let groupedLogEntry of groupedLogEntries)actions.retryInvocationStarted(groupedLogEntry);1===groupedLogEntries.length&&actions.setRowExpanded(groupedLogEntries[0].instanceId,!0);let[timestampRangeStart,timestampRangeEnd]=groupedLogEntries.reduce((_ref11,x)=>{let[accStart,accEnd]=_ref11;return accStart?[x.minTimestamp.isBefore(accStart)?x.minTimestamp:accStart,x.maxTimestamp.isAfter(accEnd)?x.maxTimestamp:accEnd]:[x.minTimestamp,x.minTimestamp]},[null,null]),events=await loadClickhouseEvents(Object.values(null!==(_values$eventIdByInvo=values.eventIdByInvocationId)&&void 0!==_values$eventIdByInvo?_values$eventIdByInvo:{}),{date_from:timestampRangeStart?.subtract(1,"day").toISOString(),date_to:timestampRangeEnd?.add(1,"day").toISOString()}),eventsById={};for(let event of events)eventsById[event.uuid]=event;await runWithParallelism(groupedLogEntries,10,async groupedLogEntry=>{try{let event=eventsById[values.eventIdByInvocationId[groupedLogEntry.instanceId]];if(!event){actions.retryInvocationFailure(groupedLogEntry);return}let res=await api.ZP.hogFunctions.createTestInvocation(props.sourceId,{clickhouse_event:event,mock_async_functions:!1,configuration:{filters:{}},invocation_id:groupedLogEntry.instanceId}),newLogGroup={...groupedLogEntry,entries:[...groupedLogEntry.entries,...res.logs.map(x=>({timestamp:(0,dayjs.Bv)(x.timestamp),level:x.level.toUpperCase(),message:x.message}))]};actions.addLogGroups([newLogGroup]),actions.retryInvocationSuccess(groupedLogEntry)}catch(e){actions.retryInvocationFailure(groupedLogEntry)}}),actions.setSelectingMany(!1)})(),{success:"Retries complete!",error:"Retry failed!",pending:"Retrying..."})},retrySelectedInvocations:async()=>{let groupsToRetry=values.logs.filter(x=>values.selectedForRetry[x.instanceId]);actions.retryInvocations(groupsToRetry)},selectAllForRetry:async()=>{for(let groupedLogEntry of(actions.setSelectingMany(!0),values.logs))actions.setSelectedForRetry({[groupedLogEntry.instanceId]:!0})}}}),(0,lib.beforeUnload)(_ref12=>{let{values,cache}=_ref12;return{enabled:()=>!cache.disabledBeforeUnload&&values.retryRunning,message:"You have running retries that will be discarded if you leave. Are you sure?",onConfirm:()=>{cache.disabledBeforeUnload=!0}}})]);var LogsViewer=__webpack_require__("../../frontend/src/scenes/hog-functions/logs/LogsViewer.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function HogFunctionLogs(props){let logicProps={sourceType:"hog_function",sourceId:props.hogFunctionId},{selectingMany,selectedForRetry,retryRunning}=(0,index_esm.useValues)(hogFunctionLogsLogic(logicProps)),{setSelectingMany,retrySelectedInvocations,selectAllForRetry}=(0,index_esm.useActions)(hogFunctionLogsLogic(logicProps));return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:selectingMany?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!1),children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>selectAllForRetry(),children:"Select all"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"primary",onClick:()=>{src.dn.open({title:"Retry invocations",content:"Are you sure you want to retry the selected events? Please don't close the window until the invocations have completed.",secondaryButton:{children:"Cancel"},primaryButton:{children:"Retry selected events",onClick:()=>retrySelectedInvocations()}})},loading:retryRunning,disabledReason:retryRunning?"Please wait for the current retries to complete.":0===Object.values(selectedForRetry).length?"No invocations selected":void 0,children:"Retry selected"})]}):(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!0),children:"Select invocations"})})}),(0,jsx_runtime.jsx)(LogsViewer.F,{...logicProps,sourceId:props.hogFunctionId,renderColumns:columns=>[{title:"Status",key:"status",width:0,render:(_,record)=>(0,jsx_runtime.jsx)(HogFunctionLogsStatus,{record:record,hogFunctionId:props.hogFunctionId})},...columns.filter(column=>"logLevel"!==column.key)]})]})}function HogFunctionLogsStatus(_ref){var _selectedForRetry$rec;let{record,hogFunctionId}=_ref,logicProps={sourceType:"hog_function",sourceId:hogFunctionId},{loadSampleGlobals,toggleExpanded}=(0,index_esm.useActions)((0,hogFunctionTestLogic.g)({id:hogFunctionId})),{retries,selectingMany,selectedForRetry,eventIdByInvocationId}=(0,index_esm.useValues)(hogFunctionLogsLogic(logicProps)),{retryInvocations,setSelectingMany,setSelectedForRetry}=(0,index_esm.useActions)(hogFunctionLogsLogic(logicProps)),thisRetry=retries[record.instanceId],status=(0,react.useMemo)(()=>{if("pending"===thisRetry)return"running";let lastEntry=record.entries[record.entries.length-1];return lastEntry.message.includes("Function completed")||lastEntry.message.includes("Execution successful")?"success":"ERROR"===lastEntry.level?"failure":"running"},[record,thisRetry]),eventId=eventIdByInvocationId?.[record.instanceId];return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[selectingMany?(0,jsx_runtime.jsx)(src.Hw,{checked:null!==(_selectedForRetry$rec=selectedForRetry[record.instanceId])&&void 0!==_selectedForRetry$rec&&_selectedForRetry$rec,onChange:checked=>setSelectedForRetry({[record.instanceId]:checked})}):null,(0,jsx_runtime.jsx)(src.oe,{type:"success"===status?"success":"failure"===status?"danger":"warning",children:(0,utils.fm)(status)}),(0,jsx_runtime.jsx)(src.d6,{items:[eventId?{label:"View event",to:urls.j.event(eventId,"")}:null,{label:"Retry event",disabledReason:eventId?void 0:"Could not find the source event",onClick:()=>retryInvocations([record])},{label:"Select for retry",onClick:()=>{setSelectingMany(!0),setSelectedForRetry({[record.instanceId]:!0})}},{label:"Test with this event in configuration",onClick:()=>{loadSampleGlobals({eventId}),toggleExpanded(!0),lib.router.actions.push(urls.j.hogFunction(hogFunctionId)+"?tab=configuration")}}],children:(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{className:"rotate-90"}),loading:"pending"===thisRetry})})]})}},"../../frontend/src/scenes/hog-functions/logs/LogsViewer.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{F:()=>LogsViewer,n:()=>tagTypeForLevel});var _posthog_icons__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.22.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib_components_DateFilter_DateFilter__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),lib_components_TZLabel__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),lib_utils__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/utils.tsx"),_logsViewerLogic__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/hog-functions/logs/logsViewerLogic.tsx"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let tagTypeForLevel=level=>{switch(level.toLowerCase()){case"debug":return"muted";case"log":case"info":default:return"default";case"warning":case"warn":return"warning";case"error":return"danger"}};function LogsViewer(_ref){let{renderColumns=c=>c,...props}=_ref,logic=(0,_logsViewerLogic__WEBPACK_IMPORTED_MODULE_6__.WC)(props),{logs,logsLoading,hiddenLogs,hiddenLogsLoading,isThereMoreToLoad,expandedRows,filters}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(logic),{revealHiddenLogs,loadMoreLogs,setFilters,setRowExpanded}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useActions)(logic);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("div",{className:"flex-1 deprecated-space-y-2 ph-no-capture",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.DF,{className:"flex-1 min-w-120",type:"search",placeholder:"Search for messages containing…",fullWidth:!0,onChange:value=>setFilters({search:value}),allowClear:!0,prefix:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.Fragment,{children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconSearch,{})})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("div",{className:"flex items-center gap-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Qw,{closeOnClickInside:!1,matchWidth:!1,placement:"right-end",overlay:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:"deprecated-space-y-2 overflow-hidden max-w-100",children:_logsViewerLogic__WEBPACK_IMPORTED_MODULE_6__.SV.map(level=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{fullWidth:!0,sideIcon:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Hw,{checked:filters.levels.includes(level)}),onClick:()=>{setFilters({levels:filters.levels.includes(level)?filters.levels.filter(t=>t!=level):[...filters.levels,level]})},children:level},level))}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{size:"small",type:"secondary",tooltip:"Filtering for any log groups containing any of the selected levels",children:filters.levels.map(level=>level).join(", ")})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(lib_components_DateFilter_DateFilter__WEBPACK_IMPORTED_MODULE_3__.f,{dateTo:filters.date_to,dateFrom:filters.date_from,onChange:(from,to)=>setFilters({date_from:from||void 0,date_to:to||void 0}),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconCalendar,{})," ",key]})})]})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{onClick:revealHiddenLogs,loading:hiddenLogsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:hiddenLogs.length?void 0:"There's nothing to load",children:hiddenLogs.length?`Show ${(0,lib_utils__WEBPACK_IMPORTED_MODULE_5__.Zi)(hiddenLogs.length,"newer entry","newer entries")}`:"No new entries"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.g3,{dataSource:logs,loading:logsLoading,className:"ph-no-capture",rowKey:record=>record.instanceId,columns:renderColumns([{title:"Timestamp",key:"timestamp",dataIndex:"maxTimestamp",width:0,sorter:(a,b)=>a.maxTimestamp.unix()-b.maxTimestamp.unix(),render:(_,_ref2)=>{let{maxTimestamp}=_ref2;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(lib_components_TZLabel__WEBPACK_IMPORTED_MODULE_4__.w,{time:maxTimestamp})}},{width:0,title:"Invocation",dataIndex:"instanceId",key:"instanceId",render:(_,_ref3)=>{let{instanceId}=_ref3;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("code",{className:"whitespace-nowrap",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.rU,{className:"font-semibold",subtle:!0,onClick:()=>{setRowExpanded(instanceId,!expandedRows[instanceId])},children:instanceId})})}},{key:"logLevel",dataIndex:"logLevel",width:0,render:(_,_ref4)=>{let{instanceId,logLevel}=_ref4;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.rU,{subtle:!0,className:"flex items-center gap-2",onClick:()=>{setRowExpanded(instanceId,!expandedRows[instanceId])},children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.oe,{type:tagTypeForLevel(logLevel),children:logLevel.toUpperCase()})})}},{title:"Last message",key:"entries",dataIndex:"entries",render:(_,_ref5)=>{let{instanceId,entries}=_ref5,lastEntry=entries[entries.length-1];return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("code",{className:"whitespace-pre-wrap",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.rU,{subtle:!0,onClick:()=>{setRowExpanded(instanceId,!expandedRows[instanceId])},children:[lastEntry.message,entries.length>1&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("br",{}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("span",{className:"text-xs text-muted-alt",children:["+ ",entries.length-1," more"]})]})]})})}}]),expandable:{noIndent:!0,isRowExpanded:record=>{var _expandedRows$record$;return null!==(_expandedRows$record$=expandedRows[record.instanceId])&&void 0!==_expandedRows$record$&&_expandedRows$record$},onRowExpand:record=>setRowExpanded(record.instanceId,!0),onRowCollapse:record=>setRowExpanded(record.instanceId,!1),expandedRowRender:record=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.g3,{embedded:!0,dataSource:record.entries,columns:[{key:"spacer",width:0,render:()=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:"w-6"})},{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:(_,_ref6)=>{let{timestamp}=_ref6;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(lib_components_TZLabel__WEBPACK_IMPORTED_MODULE_4__.w,{time:timestamp})}},{title:"Level",key:"level",dataIndex:"level",render:(_,_ref7)=>{let{level}=_ref7;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.oe,{type:tagTypeForLevel(level),children:level.toUpperCase()})}},{title:"Message",key:"message",dataIndex:"message",render:(_,_ref8)=>{let{message}=_ref8;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("code",{className:"whitespace-pre-wrap",children:message})}}]})}}),!!logs.length&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{onClick:loadMoreLogs,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:isThereMoreToLoad?void 0:"There's nothing more to load",children:isThereMoreToLoad?`Load up to ${_logsViewerLogic__WEBPACK_IMPORTED_MODULE_6__.Hs} older entries`:"No older entries"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:"mb-8"})]})}},"../../frontend/src/scenes/hog-functions/logs/logsViewerLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Hs:()=>LOG_VIEWER_LIMIT,SV:()=>ALL_LOG_LEVELS,WC:()=>logsViewerLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_dayjs__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/dayjs.ts"),_queries_utils__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/queries/utils.ts");let ALL_LOG_LEVELS=["DEBUG","LOG","INFO","WARNING","ERROR"],LOG_VIEWER_LIMIT=500,loadGroupedLogs=async request=>{var _request$date_from;let query=(0,_queries_utils__WEBPACK_IMPORTED_MODULE_4__.zP)`
        SELECT
            instance_id,
            max(timestamp) AS latest_timestamp,
            min(timestamp) AS earliest_timestamp,
            arraySort(
                groupArray((timestamp, level, message))
            ) AS messages
        FROM log_entries
        WHERE log_source = ${request.sourceType}
        AND log_source_id = ${request.sourceId}
        AND timestamp > {filters.dateRange.from}
        AND timestamp < {filters.dateRange.to}
        AND instance_id in (
            SELECT DISTINCT instance_id
            FROM log_entries
            WHERE log_source = 'hog_function'
            AND log_source_id = ${request.sourceId}
            AND timestamp > {filters.dateRange.from}
            AND timestamp < {filters.dateRange.to}
            AND lower(level) IN (${_queries_utils__WEBPACK_IMPORTED_MODULE_4__.zP.raw(request.levels.map(level=>`'${level.toLowerCase()}'`).join(","))})
            AND message ILIKE '%${_queries_utils__WEBPACK_IMPORTED_MODULE_4__.zP.raw(request.search)}%'
            ORDER BY timestamp ${_queries_utils__WEBPACK_IMPORTED_MODULE_4__.zP.raw(request.order)}
            LIMIT ${LOG_VIEWER_LIMIT}
        )
        GROUP BY instance_id
        ORDER BY latest_timestamp DESC`;return(await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.queryHogQL(query,{refresh:"force_blocking",filtersOverride:{date_from:null!==(_request$date_from=request.date_from)&&void 0!==_request$date_from?_request$date_from:"-7d",date_to:request.date_to}})).results.map(result=>({instanceId:result[0],maxTimestamp:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_3__.Bv)(result[1]),minTimestamp:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_3__.Bv)(result[2]),entries:result[3].map(entry=>({timestamp:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_3__.Bv)(entry[0]),level:entry[1].toUpperCase(),message:entry[2]}))}))},sanitizeGroupedLogs=groups=>{let byId={};for(let group of groups){if(byId[group.instanceId])for(let entry of group.entries)byId[group.instanceId].entries.find(e=>e.timestamp.isSame(entry.timestamp))||byId[group.instanceId].entries.push(entry);else byId[group.instanceId]=group;byId[group.instanceId].entries.sort((a,b)=>a.timestamp.diff(b.timestamp));let highestLogLevel=group.entries.reduce((max,entry)=>Math.max(max,ALL_LOG_LEVELS.indexOf(entry.level)),0);byId[group.instanceId].logLevel=ALL_LOG_LEVELS[highestLogLevel]}return Object.values(byId).sort((a,b)=>b.maxTimestamp.diff(a.maxTimestamp))},logsViewerLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(key=>["scenes","pipeline","hogfunctions","logs","logsViewerLogic",key]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.key)(_ref=>{let{sourceType,sourceId}=_ref;return`${sourceType}:${sourceId}`}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setFilters:filters=>({filters}),addLogGroups:logGroups=>({logGroups}),setHiddenLogs:logGroups=>({logGroups}),clearHiddenLogs:!0,markLogsEnd:!0,revealHiddenLogs:!0,setRowExpanded:(instanceId,expanded)=>({instanceId,expanded}),scheduleLoadNewerLogs:!0,loadLogs:!0,loadNewerLogs:!0}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref2=>{let{props,values,actions}=_ref2;return{logs:[[],{loadLogs:async(_,breakpoint)=>{await breakpoint(10),actions.clearHiddenLogs();let logParams={levels:values.filters.levels,search:values.filters.search,sourceType:props.sourceType,sourceId:props.sourceId,date_from:values.filters.date_from,date_to:values.filters.date_to,order:"DESC"},results=await loadGroupedLogs(logParams);return await breakpoint(10),sanitizeGroupedLogs(results)},loadMoreLogs:async()=>{if(!values.oldestLogTimestamp)return values.logs;let logParams={levels:values.filters.levels,search:values.filters.search,sourceType:props.sourceType,sourceId:props.sourceId,date_to:values.oldestLogTimestamp.toISOString(),date_from:values.filters.date_from,order:"DESC"},results=await loadGroupedLogs(logParams);return results.length||actions.markLogsEnd(),sanitizeGroupedLogs([...results,...values.logs])},revealHiddenLogs:()=>{let hiddenLogs=[...values.hiddenLogs];return actions.clearHiddenLogs(),sanitizeGroupedLogs([...hiddenLogs,...values.logs])},addLogGroups:_ref3=>{let{logGroups}=_ref3;return sanitizeGroupedLogs([...logGroups,...values.logs])}}],hiddenLogs:[[],{loadNewerLogs:async(_,breakpoint)=>{if(await breakpoint(10),!values.newestLogTimestamp)return values.hiddenLogs;let logParams={levels:values.filters.levels,search:values.filters.search,sourceType:props.sourceType,sourceId:props.sourceId,date_from:values.newestLogTimestamp.toISOString(),date_to:values.filters.date_to,order:"ASC"},results=await loadGroupedLogs(logParams);await breakpoint(10);let newLogs=[],existingLogsToUpdate=[],existingLogIds=values.logs.map(log=>log.instanceId);if(values.logsLoading)return values.hiddenLogs;for(let log of results)existingLogIds.includes(log.instanceId)?existingLogsToUpdate.push(log):newLogs.push(log);return existingLogsToUpdate.length&&actions.loadLogsSuccess(sanitizeGroupedLogs([...existingLogsToUpdate,...values.logs])),actions.scheduleLoadNewerLogs(),sanitizeGroupedLogs([...newLogs,...values.hiddenLogs])},clearHiddenLogs:()=>[]}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({filters:[{search:"",levels:["LOG","INFO","WARNING","ERROR"],date_from:"-7d",date_to:void 0},{setFilters:(state,_ref4)=>{let{filters}=_ref4;return{...state,...filters}}}],isThereMoreToLoad:[!0,{markLogsEnd:()=>!1,loadLogs:()=>!0}],expandedRows:[{},{setRowExpanded:(state,_ref5)=>{let{instanceId,expanded}=_ref5;return{...state,[instanceId]:expanded}}}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(()=>({newestLogTimestamp:[s=>[s.logs,s.hiddenLogs],(logs,hiddenLogs)=>logs.concat(hiddenLogs).reduce((max,log)=>max?log.maxTimestamp.isAfter(max)?log.maxTimestamp:max:log.maxTimestamp,null)],oldestLogTimestamp:[s=>[s.logs,s.hiddenLogs],(logs,hiddenLogs)=>logs.concat(hiddenLogs).reduce((min,log)=>min?log.minTimestamp.isBefore(min)?log.minTimestamp:min:log.minTimestamp,null)]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref6=>{let{actions,cache}=_ref6;return{setFilters:async(_,breakpoint)=>{await breakpoint(500),actions.loadLogs()},loadLogsSuccess:()=>{actions.scheduleLoadNewerLogs()},scheduleLoadNewerLogs:()=>{cache.pollingTimeout&&clearTimeout(cache.pollingTimeout),cache.pollingTimeout=setTimeout(()=>actions.loadNewerLogs(),5e3)}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.events)(_ref7=>{let{actions,cache}=_ref7;return{afterMount:()=>{actions.loadLogs()},beforeUnmount:()=>{clearInterval(cache.pollingTimeout)}}})])},"../../frontend/src/scenes/pipeline/pipelineNodeLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{y:()=>pipelineNodeLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_router__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),lib_utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/utils.tsx"),scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/scenes/urls.ts"),_layout_navigation_3000_sidepanel_types__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../frontend/src/layout/navigation-3000/sidepanel/types.ts"),_types__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/types.ts"),_pipelineNodeNewLogic__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineNodeNewLogic.tsx"),_types__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/scenes/pipeline/types.ts");let pipelineNodeLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.key)(_ref=>{let{id}=_ref;return id}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(id=>["scenes","pipeline","pipelineNodeLogic",id]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setCurrentTab:function(){let tab=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_types__WEBPACK_IMPORTED_MODULE_5__.il.Configuration;return{tab}},setBreadcrumbTitle:title=>({title}),setProjectTreeRef:projectTreeRef=>({projectTreeRef})}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)(()=>({currentTab:[_types__WEBPACK_IMPORTED_MODULE_5__.il.Configuration,{setCurrentTab:(_,_ref2)=>{let{tab}=_ref2;return tab}}],breadcrumbTitle:["",{setBreadcrumbTitle:(_,_ref3)=>{let{title}=_ref3;return title}}],projectTreeRef:[null,{setProjectTreeRef:(_,_ref4)=>{let{projectTreeRef}=_ref4;return projectTreeRef}}]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(()=>({breadcrumbs:[(s,p)=>[p.id,p.stage,s.breadcrumbTitle],(id,stage,breadcrumbTitle)=>[{key:scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__.x.Pipeline,name:"Data pipeline",path:scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipeline()},{key:stage||"unknown",name:stage?(0,lib_utils__WEBPACK_IMPORTED_MODULE_2__.fm)(_pipelineNodeNewLogic__WEBPACK_IMPORTED_MODULE_6__.U[stage]||""):"Unknown",path:scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipeline(stage?_pipelineNodeNewLogic__WEBPACK_IMPORTED_MODULE_6__.U[stage]:void 0)},{key:[scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__.x.PipelineNode,id],name:breadcrumbTitle}]],[_layout_navigation_3000_sidepanel_types__WEBPACK_IMPORTED_MODULE_8__.f]:[s=>[s.node],node=>node.backend===_types__WEBPACK_IMPORTED_MODULE_7__.b.Plugin?{activity_scope:_types__WEBPACK_IMPORTED_MODULE_5__.jc.PLUGIN,activity_item_id:`${node.id}`}:null],nodeBackend:[s=>[s.node],node=>node.backend],node:[(_,p)=>[p.id],id=>"string"==typeof id?0===id.indexOf("hog-")?{backend:_types__WEBPACK_IMPORTED_MODULE_7__.b.HogFunction,id:`${id}`.replace("hog-","")}:{backend:_types__WEBPACK_IMPORTED_MODULE_7__.b.BatchExport,id}:{backend:_types__WEBPACK_IMPORTED_MODULE_7__.b.Plugin,id}],tabs:[s=>[s.nodeBackend],nodeBackend=>{let tabs=Object.values(_types__WEBPACK_IMPORTED_MODULE_5__.il);return nodeBackend===_types__WEBPACK_IMPORTED_MODULE_7__.b.BatchExport?tabs.filter(t=>t!==_types__WEBPACK_IMPORTED_MODULE_5__.il.History):tabs}],id:[(_,p)=>[p.id],id=>id],stage:[(_,p)=>[p.stage],stage=>stage]})),(0,kea_router__WEBPACK_IMPORTED_MODULE_1__.actionToUrl)(_ref5=>{let{values,props}=_ref5;return{setCurrentTab:()=>[scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipelineNode(props.stage,props.id,values.currentTab)]}}),(0,kea_router__WEBPACK_IMPORTED_MODULE_1__.urlToAction)(_ref6=>{let{props,actions,values}=_ref6;return{[scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipelineNode(props.stage,props.id,":nodeTab")]:_ref7=>{let{nodeTab}=_ref7;if(nodeTab!==values.currentTab&&Object.values(_types__WEBPACK_IMPORTED_MODULE_5__.il).includes(nodeTab)&&actions.setCurrentTab(nodeTab),"string"==typeof props.id&&(props.id.startsWith("managed-")||props.id.startsWith("self-managed-"))){kea_router__WEBPACK_IMPORTED_MODULE_1__.router.actions.replace(scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.dataWarehouseSource(props.id.toString()));return}let match=kea_router__WEBPACK_IMPORTED_MODULE_1__.router.values.location.pathname.match(/\/pipeline\/([^/]+)\/hog-([^/]+)\/?/);if(match){let{projectTreeRef}=values,type="hog_function/",ref=match[2];projectTreeRef&&projectTreeRef.type===type&&projectTreeRef.ref===ref||actions.setProjectTreeRef({type,ref})}}}})])},"../../frontend/src/scenes/pipeline/pipelineNodeNewLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Q:()=>pipelineNodeNewLogic,U:()=>NODE_STAGE_TO_PIPELINE_TAB});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),lib_utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/utils.tsx"),scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/scenes/urls.ts"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/types.ts"),_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/scenes/pipeline/utils.tsx");let NODE_STAGE_TO_PIPELINE_TAB={[_types__WEBPACK_IMPORTED_MODULE_6__.We.Transformation]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.Transformations,[_types__WEBPACK_IMPORTED_MODULE_6__.We.Destination]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.Destinations,[_types__WEBPACK_IMPORTED_MODULE_6__.We.SiteApp]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.SiteApps,[_types__WEBPACK_IMPORTED_MODULE_6__.We.Source]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.Sources},pipelineNodeNewLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)(()=>({values:[scenes_userLogic__WEBPACK_IMPORTED_MODULE_5__.userLogic,["user"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(id=>["scenes","pipeline","pipelineNodeNewLogic",id]),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)({plugins:[{},{loadPlugins:async()=>(0,_utils__WEBPACK_IMPORTED_MODULE_7__.c$)("api/organizations/@current/pipeline_destinations")}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({loading:[s=>[s.pluginsLoading],pluginsLoading=>pluginsLoading],breadcrumbs:[(_,p)=>[p.stage,p.pluginId,p.kind,p.batchExportDestination],(stage,pluginId,kind,batchDestination)=>{let parsedStage=stage?stage.replace("-"," "):null;return[{key:scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__.x.Pipeline,name:"Data pipeline",path:scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipeline()},{key:stage||"unknown",name:stage?(0,lib_utils__WEBPACK_IMPORTED_MODULE_2__.fm)(NODE_STAGE_TO_PIPELINE_TAB[stage]||""):"Unknown",path:scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipeline(stage?NODE_STAGE_TO_PIPELINE_TAB[stage]:void 0)},{key:pluginId||batchDestination||"Unknown",name:kind?`New ${(0,lib_utils__WEBPACK_IMPORTED_MODULE_2__.fm)(kind)} source`:pluginId?"New":batchDestination?`New ${batchDestination} destination`:`New ${parsedStage}`.trim()}]}],projectTreeRef:[s=>[s.loading],()=>({type:"hog_function/",ref:null})]})])}}]);
//# sourceMappingURL=88673.24cb6e17.iframe.bundle.js.map