"use strict";(self.webpackChunk_posthog_frontend=self.webpackChunk_posthog_frontend||[]).push([[38895],{"./frontend/src/scenes/debug/hog/HogRepl.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{HogRepl:()=>HogRepl,ReplChunk:()=>ReplChunk,ReplResultsTable:()=>ReplResultsTable,scene:()=>scene});var dist_module=__webpack_require__("./node_modules/.pnpm/@posthog+hogvm@1.0.67_luxon@3.5.0/node_modules/@posthog/hogvm/dist/module.js"),src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),JSONViewer=__webpack_require__("./frontend/src/lib/components/JSONViewer.tsx"),CodeEditorInline=__webpack_require__("./frontend/src/lib/monaco/CodeEditorInline.tsx"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),render=__webpack_require__("./frontend/src/queries/nodes/HogQLX/render.tsx"),lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),hog=__webpack_require__("./frontend/src/lib/hog.ts"),urls=__webpack_require__("./frontend/src/scenes/urls.ts");let hogReplLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","debug","HogRepl"]),(0,index_esm.actions)({runCode:code=>({code}),setResult:(index,result,error)=>({index,result,error}),print:(index,line)=>({index,line}),setBytecode:(index,bytecode,locals)=>({index,bytecode,locals}),setVMState:(index,state)=>({index,state}),setCurrentCode:code=>({code}),runCurrentCode:!0,editFromHere:index=>({index}),setReplChunks:replChunks=>({replChunks})}),(0,index_esm.reducers)({currentCode:["",{setCurrentCode:(_,_ref)=>{let{code}=_ref;return code}}],replChunks:[[],{setReplChunks:(_,_ref2)=>{let{replChunks}=_ref2;return replChunks},runCode:(state,_ref3)=>{let{code}=_ref3;return[...state,{code,status:"pending"}]},setResult:(state,_ref4)=>{let{index,result,error}=_ref4;return state.map((chunk,i)=>i===index?{...chunk,result,error,status:error?"error":"success"}:chunk)},setBytecode:(state,_ref5)=>{let{index,bytecode,locals}=_ref5;return state.map((chunk,i)=>i===index?{...chunk,bytecode,locals}:chunk)},print:(state,_ref6)=>{let{index,line}=_ref6;return state.map((chunk,i)=>{var _chunk$print;return i===index?{...chunk,print:[...null!==(_chunk$print=chunk.print)&&void 0!==_chunk$print?_chunk$print:[],line]}:chunk})},setVMState:(state,_ref7)=>{let{index,state:vmState}=_ref7;return state.map((chunk,i)=>i===index?{...chunk,state:vmState}:chunk)}}]}),(0,index_esm.selectors)({lastLocals:[s=>[s.replChunks],replChunks=>{for(let i=replChunks.length-1;i>=0;i--)if(replChunks[i].locals)return replChunks[i].locals}],lastState:[s=>[s.replChunks],replChunks=>{for(let i=replChunks.length-1;i>=0;i--)if(replChunks[i].state)return replChunks[i].state}],lastLocalGlobals:[s=>[s.lastLocals],lastLocals=>{if(lastLocals)return lastLocals.reduce((acc,local)=>({...acc,[local[0]]:"local"}),{})}]}),(0,index_esm.listeners)(_ref8=>{let{actions,values}=_ref8;return{editFromHere:_ref9=>{let{index}=_ref9,code=[...values.replChunks.slice(index).map(chunk=>chunk.code),values.currentCode].join("\n");actions.setCurrentCode(code.replace(/\n+$/,"")),actions.setReplChunks(values.replChunks.slice(0,index))},runCode:async _ref10=>{let{code}=_ref10,index=values.replChunks.length-1,{lastLocals,lastState}=values;try{var _lastState$stack,_lastState$upvalues,_lastState$ops,_lastState$asyncSteps,_lastState$declaredFu,_lastState$throwStack,_lastState$maxMemUsed,_lastState$syncDurati,_result$state$stack$l,_lastLocals$length;let res=await api.ZP.hog.create(code,lastLocals,!0),[_h,version,...bytecode]=res.bytecode,locals=res.locals;actions.setBytecode(index,bytecode,locals);let nextBytecode=[_h,version];for(let replChunk of values.replChunks)replChunk.bytecode&&nextBytecode.push(...replChunk.bytecode);let ip=nextBytecode.length-bytecode.length;35===nextBytecode[nextBytecode.length-1]&&nextBytecode.pop();let nextStack=[...null!==(_lastState$stack=lastState?.stack)&&void 0!==_lastState$stack?_lastState$stack:[]];nextStack.length!==lastLocals?.length&&nextStack.splice(null!==(_lastLocals$length=lastLocals?.length)&&void 0!==_lastLocals$length?_lastLocals$length:0);let state={stack:null!=nextStack?nextStack:[],bytecodes:{root:{bytecode:nextBytecode}},callStack:[{ip:ip,chunk:"root",stackStart:0,argCount:0,closure:(0,dist_module.CK)((0,dist_module.lq)("local",{name:"",argCount:0,upvalueCount:0,ip:ip,chunk:"root"}))}],upvalues:null!==(_lastState$upvalues=lastState?.upvalues)&&void 0!==_lastState$upvalues?_lastState$upvalues:[],ops:null!==(_lastState$ops=lastState?.ops)&&void 0!==_lastState$ops?_lastState$ops:0,asyncSteps:null!==(_lastState$asyncSteps=lastState?.asyncSteps)&&void 0!==_lastState$asyncSteps?_lastState$asyncSteps:0,declaredFunctions:null!==(_lastState$declaredFu=lastState?.declaredFunctions)&&void 0!==_lastState$declaredFu?_lastState$declaredFu:{},throwStack:null!==(_lastState$throwStack=lastState?.throwStack)&&void 0!==_lastState$throwStack?_lastState$throwStack:[],maxMemUsed:null!==(_lastState$maxMemUsed=lastState?.maxMemUsed)&&void 0!==_lastState$maxMemUsed?_lastState$maxMemUsed:0,syncDuration:null!==(_lastState$syncDurati=lastState?.syncDuration)&&void 0!==_lastState$syncDurati?_lastState$syncDurati:0},result=await (0,hog.u)(state,{repl:!0,functions:{print:function(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];actions.print(index,args)}}}),response=void 0!==result.result?result.result:(null!==(_result$state$stack$l=result.state?.stack?.length)&&void 0!==_result$state$stack$l?_result$state$stack$l:0)>0?result.state?.stack?.[result.state.stack.length-1]:"null";actions.setResult(index,response),actions.setVMState(index,result.state)}catch(error){console.error(error),actions.setResult(index,void 0,(error.error||error.message||error).toString())}},runCurrentCode:()=>{actions.runCode(values.currentCode),actions.setCurrentCode("")}}}),(0,lib.actionToUrl)(_ref11=>{let{values}=_ref11,fn=()=>{if(values.replChunks.length>0){if(JSON.stringify(values.replChunks).length>1048576){let newCode=values.replChunks.map(chunk=>chunk.code).join("\n");return newCode.length>1048576?[urls.j.debugHog(),void 0,void 0,{replace:!0}]:[urls.j.debugHog(),void 0,{code:newCode},{replace:!0}]}return[urls.j.debugHog(),void 0,{repl:values.replChunks,code:values.currentCode},{replace:!0}]}};return{setReplChunks:fn,runCode:fn,setResult:fn,setBytecode:fn,print:fn,setVMState:fn,setCurrentCode:fn}}),(0,lib.urlToAction)(_ref12=>{let{actions,values}=_ref12;return{[urls.j.debugHog()]:(_,__,_ref13)=>{let{repl,code}=_ref13;(repl||code)&&!values.currentCode&&0===values.replChunks.length&&(actions.setReplChunks(repl),actions.setCurrentCode(code))}}})]);var jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function ReplResultsTable(_ref){let{response}=_ref,[activeTab,setActiveTab]=(0,react.useState)("table");return(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,onChange:setActiveTab,tabs:[{key:"table",label:"Table",content:(0,jsx_runtime.jsx)(src.g3,{columns:response.columns.map((col,index)=>({dataIndex:index,title:col})),dataSource:response.results})},{key:"json",label:"JSON",content:(0,jsx_runtime.jsx)(JSONViewer.C,{name:!1,src:response})},{key:"raw",label:"Raw",content:(0,jsx_runtime.jsx)("div",{children:(0,dist_module.dY)(response)})}]})})}function printRichHogOutput(arg){if("object"==typeof arg&&null!==arg){if("__hx_tag"in arg)return(0,render.E)(arg);if("results"in arg&&"columns"in arg&&Array.isArray(arg.results)&&Array.isArray(arg.columns))return(0,jsx_runtime.jsx)(ReplResultsTable,{response:arg})}return(0,dist_module.dY)(arg)}function ReplChunk(_ref2){let{chunk:{code,result,print,error,status},editFromHere}=_ref2;return(0,jsx_runtime.jsxs)("div",{className:"pb-2 border-b border-gray-300",children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",className:"float-right",onClick:editFromHere,children:"\uD83D\uDCDD"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-start",children:[(0,jsx_runtime.jsx)("span",{style:{color:"blue"},children:">"}),(0,jsx_runtime.jsx)("div",{className:"flex-1 whitespace-pre-wrap ml-2",children:code})]}),"pending"===status&&(0,jsx_runtime.jsx)("div",{className:"flex items-center ml-4 mt-2",children:(0,jsx_runtime.jsxs)("svg",{className:"animate-spin h-5 w-5 text-gray-500 mr-2",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,jsx_runtime.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,jsx_runtime.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v8z"})]})}),print&&Array.isArray(print)?(0,jsx_runtime.jsxs)("div",{className:"flex items-start mt-2",children:[(0,jsx_runtime.jsx)("span",{style:{color:"green"},children:"#"}),(0,jsx_runtime.jsx)("div",{className:"flex-1 whitespace-pre-wrap ml-2",children:print.map((line,index)=>(0,jsx_runtime.jsx)("div",{children:line.map((arg,argIndex)=>(0,jsx_runtime.jsxs)(react.Fragment,{children:[printRichHogOutput(arg),argIndex<line.length-1?" ":""]},argIndex))},index))})]}):null,"success"===status&&void 0!==result&&(0,jsx_runtime.jsxs)("div",{className:"flex items-start mt-2",children:[(0,jsx_runtime.jsx)("span",{style:{color:"green"},children:"<"}),(0,jsx_runtime.jsx)("div",{className:"flex-1 whitespace-pre-wrap ml-2",children:printRichHogOutput(result)})]}),"error"===status&&(0,jsx_runtime.jsxs)("div",{className:"flex items-start mt-2",children:[(0,jsx_runtime.jsx)("span",{className:"text-danger",children:"!"}),(0,jsx_runtime.jsx)("div",{className:"flex-1 whitespace-pre-wrap ml-2 text-danger",children:error})]})]})}function HogRepl(){let{replChunks,currentCode,lastLocalGlobals}=(0,index_esm.useValues)(hogReplLogic),{runCurrentCode,setCurrentCode,editFromHere}=(0,index_esm.useActions)(hogReplLogic);return(0,jsx_runtime.jsx)("div",{className:"p-4 bg-white text-black font-mono",children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[replChunks.map((chunk,index)=>(0,jsx_runtime.jsx)(ReplChunk,{chunk:chunk,editFromHere:()=>editFromHere(index)},index)),(0,jsx_runtime.jsxs)("div",{className:"flex items-start",children:[(0,jsx_runtime.jsx)("span",{style:{color:"blue"},children:">"}),(0,jsx_runtime.jsx)("div",{className:"w-full",style:{marginLeft:-10,marginTop:-7,marginRight:-5,marginBottom:-5},children:(0,jsx_runtime.jsx)(CodeEditorInline.s,{language:"hog",embedded:!0,className:"flex-1 bg-transparent focus:outline-none resize-none ml-2 p-0",value:currentCode,onChange:value=>setCurrentCode(null!=value?value:""),onPressCmdEnter:runCurrentCode,onPressUpNoValue:()=>{var _hogReplLogic$findMou;let replChunks=null!==(_hogReplLogic$findMou=hogReplLogic.findMounted()?.values.replChunks)&&void 0!==_hogReplLogic$findMou?_hogReplLogic$findMou:[];replChunks.length>0&&editFromHere(replChunks.length-1)},options:{fontSize:14,padding:{top:0,bottom:0}},globals:lastLocalGlobals,autoFocus:!0})}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"primary",onClick:runCurrentCode,children:"⌘⏎"})]})]})})}let scene={component:HogRepl,logic:hogReplLogic}}}]);