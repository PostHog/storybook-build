var Pe=Object.defineProperty,Fe=Object.defineProperties;var Ne=Object.getOwnPropertyDescriptors;var ie=Object.getOwnPropertySymbols;var De=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var re=(M,p,s)=>p in M?Pe(M,p,{enumerable:!0,configurable:!0,writable:!0,value:s}):M[p]=s,C=(M,p)=>{for(var s in p||(p={}))De.call(p,s)&&re(M,s,p[s]);if(ie)for(var s of ie(p))ke.call(p,s)&&re(M,s,p[s]);return M},F=(M,p)=>Fe(M,Ne(p));var f=(M,p,s)=>new Promise((h,L)=>{var R=v=>{try{I(s.next(v))}catch(g){L(g)}},N=v=>{try{I(s.throw(v))}catch(g){L(g)}},I=v=>v.done?h(v.value):Promise.resolve(v.value).then(R,N);I((s=s.apply(M,p)).next())});(window.webpackJsonp=window.webpackJsonp||[]).push([[296],{"./frontend/src/scenes/instance/AsyncMigrations/AsyncMigrations.tsx":function(M,p,s){"use strict";s.r(p),s.d(p,"scene",function(){return ye}),s.d(p,"AsyncMigrations",function(){return te});var h=s("./node_modules/.pnpm/react@16.14.0/node_modules/react/index.js"),L=s("./frontend/src/lib/components/PageHeader.tsx"),R=s("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/tabs/index.js"),N=s("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/progress/index.js"),I=s("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/button/index.js"),v=s("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/space/index.js"),g=s("./node_modules/.pnpm/kea@3.1.0_react@16.14.0/node_modules/kea/lib/index.esm.js"),z=s("./node_modules/.pnpm/@ant-design+icons@4.7.0_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js"),_=s("./frontend/src/lib/api.ts"),x=s("./frontend/src/scenes/userLogic.ts"),w=s("./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts"),D=s("./frontend/src/lib/components/lemonToast.tsx"),a=s("./frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),r=s("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.0/node_modules/kea-loaders/lib/index.js"),o=s("./node_modules/.pnpm/kea-router@3.1.3_kea@3.1.0/node_modules/kea-router/lib/index.js");let d;(function(e){e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.CompletedSuccessfully=2]="CompletedSuccessfully",e[e.Errored=3]="Errored",e[e.RolledBack=4]="RolledBack",e[e.Starting=5]="Starting",e[e.FailedAtStartup=6]="FailedAtStartup"})(d||(d={}));let l;(function(e){e.Management="management",e.FutureMigrations="future",e.Settings="settings"})(l||(l={}));const A={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},b=Object(g.kea)([Object(g.path)(["scenes","instance","AsyncMigrations","asyncMigrationsLogic"]),Object(g.connect)({values:[a.a,["preflight"]]}),Object(g.actions)({triggerMigration:e=>({migration:e}),resumeMigration:e=>({migration:e}),rollbackMigration:e=>({migration:e}),forceStopMigration:e=>({migration:e}),forceStopMigrationWithoutRollback:e=>({migration:e}),updateMigrationStatus:(e,n,i)=>({migration:e,endpoint:n,message:i}),setActiveTab:e=>({tab:e}),updateSetting:(e,n)=>({settingKey:e,newValue:n}),loadAsyncMigrationErrors:e=>({migrationId:e}),loadAsyncMigrationErrorsSuccess:(e,n)=>({migrationId:e,errors:n}),loadAsyncMigrationErrorsFailure:(e,n)=>({migrationId:e,error:n}),openAsyncMigrationsModal:(e,n,i)=>({migration:e,endpoint:n,message:i}),closeAsyncMigrationsModal:!0}),Object(g.reducers)({activeTab:[l.Management,{setActiveTab:(e,n)=>{let{tab:i}=n;return i}}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:(e,n)=>{let{migrationId:i,errors:c}=n;return F(C({},e),{[i]:c})}}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:(e,n)=>{let{migrationId:i}=n;return F(C({},e),{[i]:!0})},loadAsyncMigrationErrorsSuccess:(e,n)=>{let{migrationId:i}=n;return F(C({},e),{[i]:!1})},loadAsyncMigrationErrorsFailure:(e,n)=>{let{migrationId:i}=n;return F(C({},e),{[i]:!1})}}],activeAsyncMigrationModal:[null,{openAsyncMigrationsModal:(e,n)=>n,closeAsyncMigrationsModal:()=>null,updateMigrationStatus:()=>null}]}),Object(r.loaders)(()=>({asyncMigrations:[[],{loadAsyncMigrations:()=>f(this,null,function*(){var e;return(e=x.a.values.user)!==null&&e!==void 0&&e.is_staff?(yield _.b.get("api/async_migrations")).results:[]})}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:()=>f(this,null,function*(){var e;return(e=x.a.values.user)!==null&&e!==void 0&&e.is_staff?(yield _.b.get("api/instance_settings")).results.filter(i=>i.key.includes("ASYNC_MIGRATIONS")):[]})}]})),Object(g.selectors)({isAnyMigrationRunning:[e=>[e.asyncMigrations],e=>e.some(n=>[d.Running,d.Starting].includes(n.status))],actionableMigrations:[e=>[e.asyncMigrations],e=>e.filter(n=>n.is_available)],futureMigrations:[e=>[e.asyncMigrations],e=>e.filter(n=>!n.is_available)]}),Object(g.listeners)(e=>{let{actions:n}=e;return{triggerMigration:i=>f(this,null,function*(){let{migration:c}=i;Object.keys(c.parameter_definitions).length>0?n.openAsyncMigrationsModal(c,"trigger","Migration triggered successfully"):n.updateMigrationStatus(c,"trigger","Migration triggered successfully")}),resumeMigration:i=>f(this,null,function*(){let{migration:c}=i;Object.keys(c.parameter_definitions).length>0?n.openAsyncMigrationsModal(c,"resume","Migration resume triggered successfully"):n.updateMigrationStatus(c,"resume","Migration resume triggered successfully")}),rollbackMigration:i=>f(this,null,function*(){let{migration:c}=i;n.updateMigrationStatus(c,"rollback","Migration rollback triggered successfully")}),forceStopMigration:i=>f(this,null,function*(){let{migration:c}=i;n.updateMigrationStatus(c,"force_stop","Force stop triggered successfully")}),forceStopMigrationWithoutRollback:i=>f(this,null,function*(){let{migration:c}=i;n.updateMigrationStatus(c,"force_stop_without_rollback","Force stop without rollback triggered successfully")}),updateMigrationStatus:i=>f(this,null,function*(){let{migration:c,endpoint:y,message:S}=i;const T=yield _.b.create(`/api/async_migrations/${c.id}/${y}`,{parameters:c.parameters});T.success?(D.d.success(S),n.loadAsyncMigrations()):D.d.error(T.error)}),updateSetting:i=>f(this,null,function*(){let{settingKey:c,newValue:y}=i;try{yield _.b.update(`/api/instance_settings/${c}`,{value:y}),D.d.success(`Instance setting ${c} updated`),n.loadAsyncMigrationSettings(),n.loadAsyncMigrations(),w.b.actions.loadSystemStatus()}catch(S){D.d.error("Failed to trigger migration")}}),loadAsyncMigrationErrors:i=>f(this,null,function*(){let{migrationId:c}=i;try{const y=yield _.b.get(`api/async_migrations/${c}/errors`);n.loadAsyncMigrationErrorsSuccess(c,y)}catch(y){n.loadAsyncMigrationErrorsFailure(c,y)}})}}),Object(g.events)(e=>{let{actions:n}=e;return{afterMount:()=>{n.loadAsyncMigrations(),n.loadAsyncMigrationSettings()}}}),Object(o.actionToUrl)(e=>{let{values:n}=e;return{setActiveTab:()=>`/instance/async_migrations${n.activeTab===l.Management?"":"/"+n.activeTab}`}}),Object(o.urlToAction)(e=>{let{actions:n,values:i}=e;return{"/instance/async_migrations(/:tab)":c=>{let{tab:y}=c;y&&y!==i.activeTab&&y!==l.Management&&n.setActiveTab(y)}}})]);var P=s("./frontend/src/lib/components/Tooltip.tsx"),U=s("./frontend/src/lib/components/Spinner/Spinner.tsx"),oe=s("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/row/index.js"),X=s("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/col/index.js"),ce=s("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/input/index.js"),le=s("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/divider/index.js"),t=s("./node_modules/.pnpm/react@16.14.0/node_modules/react/jsx-runtime.js");function B(e){let{setting:n}=e;const{updateSetting:i}=Object(g.useActions)(b),[c,y]=Object(h.useState)(String(n.value));return Object(t.jsxs)("div",{children:[Object(t.jsx)("h4",{children:n.key}),Object(t.jsx)("p",{children:n.description}),Object(t.jsxs)(oe.a,{gutter:[8,8],children:[Object(t.jsx)(X.a,{span:8,children:Object(t.jsx)(ce.a,{value:c,onChange:S=>y(S.target.value)})}),Object(t.jsx)(X.a,{span:16,children:Object(t.jsx)(I.a,{disabled:String(n.value)===c,type:"primary",onClick:()=>i(n.key,c),children:"Update"})})]}),Object(t.jsx)(le.a,{})]},n.key)}try{B.displayName="SettingUpdateField",B.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"InstanceSetting"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:B.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(e){}var q=s("./frontend/src/lib/components/LemonTable/index.ts"),H=s("./frontend/src/lib/utils.tsx"),E=s("./frontend/src/lib/components/LemonButton/index.ts"),Q=s("./frontend/src/lib/components/icons.tsx");function V(e){let{asyncMigration:n}=e;const{asyncMigrationErrorsLoading:i,asyncMigrationErrors:c}=Object(g.useValues)(b),{loadAsyncMigrationErrors:y}=Object(g.useActions)(b),S=[{title:"Error",dataIndex:"description"},{title:Object(t.jsx)(E.a,{icon:i[n.id]?Object(t.jsx)(U.a,{}):Object(t.jsx)(Q.IconRefresh,{}),onClick:()=>y(n.id),type:"secondary",size:"small",children:"Refresh errors"}),render:function(k,W){return Object(t.jsx)("div",{children:Object(H.O)(W.created_at)})}}];return Object(t.jsx)(q.a,{columns:S,dataSource:c[n.id],loading:i[n.id],embedded:!0})}try{V.displayName="AsyncMigrationDetails",V.__docgenInfo={description:"",displayName:"AsyncMigrationDetails",props:{asyncMigration:{defaultValue:null,description:"",name:"asyncMigration",required:!0,type:{name:"AsyncMigration"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"]={docgenInfo:V.__docgenInfo,name:"AsyncMigrationDetails",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"})}catch(e){}var ee=s("./frontend/src/lib/components/LemonButton/More.tsx"),de=s("./frontend/src/lib/components/LemonTag/LemonTag.tsx"),G=s("./node_modules/.pnpm/kea-forms@3.0.3_kea@3.1.0/node_modules/kea-forms/lib/index.js");const ue=Object(g.kea)([Object(g.path)(["scenes","instance","AsyncMigrations","asyncMigrationParameterFormLogic"]),Object(g.props)({}),Object(g.key)(e=>e.migration.id),Object(G.forms)(e=>{let{props:n}=e;return{parameters:{defaults:ge(n),submit:i=>f(this,null,function*(){b.actions.updateMigrationStatus(F(C({},n.migration),{parameters:i}),n.endpoint,n.message)})}}})]);function ge(e){const n={};return Object.keys(e.migration.parameter_definitions).forEach(i=>{e.migration.parameters[i]?n[i]=e.migration.parameters[i]:n[i]=e.migration.parameter_definitions[i][0]}),n}var me=s("./frontend/src/lib/components/LemonInput/LemonInput.tsx"),pe=s("./frontend/src/lib/components/AnimatedCollapsible.tsx"),K=s("./frontend/src/lib/components/LemonModal/index.ts");function $(e){const{closeAsyncMigrationsModal:n}=Object(g.useActions)(b),[i,c]=Object(h.useState)(!0);return Object(t.jsx)(K.a,{title:"",onClose:n,isOpen:!0,simple:!0,children:Object(t.jsxs)(G.Form,{logic:ue,props:e,formKey:"parameters",enableFormOnSubmit:!0,id:"async-migration-parameters-form",className:"LemonModal__layout",children:[Object(t.jsx)(K.a.Header,{children:Object(t.jsx)("h3",{children:"Advanced migration configuration"})}),Object(t.jsxs)(K.a.Content,{children:[Object(t.jsxs)("p",{children:["This async migration allows tuning parameters used in the async migration.",i&&Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("br",{}),Object(t.jsx)("a",{onClick:()=>{c(!i)},children:"Click here to show advanced configuration."})]})]}),Object(t.jsx)(pe.a,{collapsed:i,children:Object.entries(e.migration.parameter_definitions).map(y=>{let[S,[T,k]]=y;return Object(t.jsx)(G.Field,{name:S,label:Object(t.jsx)(t.Fragment,{children:k}),children:Object(t.jsx)(me.a,{type:typeof T=="number"?"number":"text"})},S)})})]}),Object(t.jsxs)(K.a.Footer,{children:[Object(t.jsx)(E.a,{form:"async-migration-parameters-form",type:"secondary","data-attr":"async-migration-parameters-cancel",className:"mr-2",onClick:n,children:"Cancel"}),Object(t.jsx)(E.a,{form:"async-migration-parameters-form",htmlType:"submit",type:"primary","data-attr":"async-migration-parameters-submit",children:"Run migration"})]})]})})}try{$.displayName="AsyncMigrationParametersModal",$.__docgenInfo={description:"",displayName:"AsyncMigrationParametersModal",props:{migration:{defaultValue:null,description:"",name:"migration",required:!0,type:{name:"AsyncMigration"}},endpoint:{defaultValue:null,description:"",name:"endpoint",required:!0,type:{name:"string"}},message:{defaultValue:null,description:"",name:"message",required:!0,type:{name:"string"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationParametersModal.tsx#AsyncMigrationParametersModal"]={docgenInfo:$.__docgenInfo,name:"AsyncMigrationParametersModal",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationParametersModal.tsx#AsyncMigrationParametersModal"})}catch(e){}const{TabPane:Y}=R.a,ye={component:te,logic:b},je=3e3;function te(){const{user:e}=Object(g.useValues)(x.a),{asyncMigrationsLoading:n,activeTab:i,asyncMigrationSettings:c,isAnyMigrationRunning:y,activeAsyncMigrationModal:S,actionableMigrations:T,futureMigrations:k}=Object(g.useValues)(b),{triggerMigration:W,resumeMigration:fe,rollbackMigration:be,forceStopMigration:Oe,forceStopMigrationWithoutRollback:Me,loadAsyncMigrations:ne,loadAsyncMigrationErrors:Se,setActiveTab:he}=Object(g.useActions)(b);Object(h.useEffect)(()=>{if(y){const j=setInterval(()=>ne(),je);return()=>clearInterval(j)}},[y]);const se={title:"Migration",render:function(O,u){const m="https://github.com/PostHog/posthog/blob/master/posthog/async_migrations/migrations/"+u.name+".py";return Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("div",{className:"row-name",children:Object(t.jsx)("a",{href:m,children:u.name})}),Object(t.jsx)("div",{className:"row-description",children:u.description})]})}},ve={title:"Progress",render:function(O,u){const m=u.progress;return Object(t.jsx)("div",{children:Object(t.jsx)(N.a,{percent:m})})}},ae={title:"Status",render:function(O,u){const m=u.status,_e=m===d.Running?"success":m===d.Errored||m===d.FailedAtStartup?"danger":m===d.Starting||m===d.RolledBack?"warning":"default";return Object(t.jsx)(de.a,{type:_e,className:"uppercase",children:A[m]})}},xe={title:"Last operation index",render:function(O,u){return Object(t.jsx)("div",{children:u.current_operation_index})}},Ae={title:"Last query ID",render:function(O,u){return Object(t.jsx)("div",{children:Object(t.jsx)("small",{children:u.current_query_id})})}},Ee={title:"Started at",render:function(O,u){const m=u.started_at;return Object(t.jsx)("div",{children:Object(H.O)(m)})}},Ce={title:"Finished at",render:function(O,u){const m=u.finished_at;return Object(t.jsx)("div",{children:Object(H.O)(m)})}},Ie={title:"",render:function(O,u){const m=u.status;return Object(t.jsx)("div",{children:m===d.NotStarted||m===d.FailedAtStartup?Object(t.jsx)(P.a,{title:"Start",children:Object(t.jsx)(I.a,{type:"link",icon:Object(t.jsx)(z.a,{}),onClick:()=>W(u),children:"Run"})}):m===d.Starting||m===d.Running?Object(t.jsx)(ee.a,{overlay:Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)(E.a,{status:"stealth",onClick:()=>Oe(u),fullWidth:!0,children:"Stop and rollback"}),Object(t.jsx)(E.a,{status:"stealth",onClick:()=>Me(u),fullWidth:!0,children:"Stop"})]})}):m===d.CompletedSuccessfully?Object(t.jsx)(t.Fragment,{}):m===d.Errored?Object(t.jsx)(ee.a,{overlay:Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)(E.a,{status:"stealth",onClick:()=>fe(u),fullWidth:!0,children:"Resume"}),Object(t.jsx)(E.a,{status:"stealth",onClick:()=>be(u),fullWidth:!0,children:"Rollback"})]})}):m===d.RolledBack?Object(t.jsx)(P.a,{title:"Restart",children:Object(t.jsx)(E.a,{status:"stealth",icon:Object(t.jsx)(Q.IconReplay,{}),onClick:()=>W(u),fullWidth:!0})}):null})}},Te={title:"Minimum PostHog version",render:function(O,u){return Object(t.jsx)("div",{children:u.posthog_min_version})}},Le={title:"Maximum PostHog version",render:function(O,u){return Object(t.jsx)("div",{children:u.posthog_max_version})}},J={};J[l.FutureMigrations]=[se,ae,Te,Le],J[l.Management]=[se,ve,ae,xe,Ae,Ee,Ce,Ie];const Z={};Z[l.FutureMigrations]=k,Z[l.Management]=T;const Re={expandedRowRender:function(O){return O&&Object(t.jsx)(V,{asyncMigration:O})},rowExpandable:j=>j.error_count>0,onRowExpand:function(O){Se(O.id)}};return Object(t.jsx)("div",{children:e!=null&&e.is_staff?Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)(L.a,{title:"Async Migrations",caption:Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("p",{children:"Manage async migrations in your instance."}),Object(t.jsxs)("p",{children:["Read about async migrations on our"," ",Object(t.jsx)("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations/overview",children:"dedicated docs page"}),"."]})]})}),Object(t.jsxs)(R.a,{activeKey:i,onTabClick:j=>he(j),children:[Object(t.jsx)(Y,{tab:`Management (${T.length})`},l.Management),k.length>0&&Object(t.jsx)(Y,{tab:`Future Migrations (${k.length})`},l.FutureMigrations),Object(t.jsx)(Y,{tab:"Settings"},l.Settings)]}),[l.Management,l.FutureMigrations].includes(i)?Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("div",{className:"mb-4 float-right",children:Object(t.jsx)(E.a,{icon:n?Object(t.jsx)(U.a,{}):Object(t.jsx)(Q.IconRefresh,{}),onClick:ne,type:"secondary",size:"small",children:"Refresh"})}),Object(t.jsx)(v.b,{}),Object(t.jsx)(q.a,{pagination:{pageSize:10},loading:n,columns:J[i],dataSource:Z[i],expandable:Re}),S?Object(t.jsx)($,C({},S)):null]}):i===l.Settings?Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("br",{}),c.map(j=>Object(t.jsx)("div",{children:Object(t.jsx)(B,{setting:j})},j.key))]}):null]}):Object(t.jsx)(L.a,{title:"Async Migrations",caption:Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("p",{children:"Only users with staff access can manage async migrations. Please contact your instance admin."}),Object(t.jsxs)("p",{children:["If you're an admin and don't have access, set ",Object(t.jsx)("code",{children:"is_staff=true"})," for your user on the PostgreSQL ",Object(t.jsx)("code",{children:"posthog_user"})," table."]})]})})})}},"./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts":function(M,p,s){"use strict";s.d(p,"a",function(){return x}),s.d(p,"b",function(){return D});var h=s("./frontend/src/lib/api.ts"),L=s("./node_modules/.pnpm/kea@3.1.0_react@16.14.0/node_modules/kea/lib/index.esm.js"),R=s("./frontend/src/scenes/userLogic.ts"),N=s("./frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),I=s("./frontend/src/scenes/organizationLogic.tsx"),v=s("./frontend/src/lib/constants.tsx"),g=s("./frontend/src/lib/utils.tsx"),z=s("./frontend/src/lib/components/lemonToast.tsx"),_=s("./frontend/src/lib/utils/eventUsageLogic.ts");let x;(function(a){a.View="view",a.Edit="edit",a.Saving="saving"})(x||(x={}));const w=["RECORDINGS_TTL_WEEKS","EMAIL_ENABLED","EMAIL_HOST","EMAIL_PORT","EMAIL_HOST_USER","EMAIL_HOST_PASSWORD","EMAIL_USE_TLS","EMAIL_USE_SSL","EMAIL_DEFAULT_FROM","EMAIL_REPLY_TO","AGGREGATE_BY_DISTINCT_IDS_TEAMS","PERSON_ON_EVENTS_ENABLED","GROUPS_ON_EVENTS_ENABLED","STRICT_CACHING_TEAMS","SLACK_APP_CLIENT_ID","SLACK_APP_CLIENT_SECRET","SLACK_APP_SIGNING_SECRET","PARALLEL_DASHBOARD_ITEM_CACHE","SENTRY_AUTH_TOKEN","SENTRY_ORGANIZATION"],D=Object(L.kea)({path:["scenes","instance","SystemStatus","systemStatusLogic"],actions:{setTab:a=>({tab:a}),setOpenSections:a=>({sections:a}),setAnalyzeModalOpen:a=>({isOpen:a}),setAnalyzeQuery:a=>({query:a}),openAnalyzeModalWithQuery:a=>({query:a}),setInstanceConfigMode:a=>({mode:a}),updateInstanceConfigValue:(a,r)=>({key:a,value:r}),clearInstanceConfigEditing:!0,saveInstanceConfig:!0,setUpdatedInstanceConfigCount:a=>({count:a}),increaseUpdatedInstanceConfigCount:!0},loaders:a=>{let{values:r}=a;return{systemStatus:[null,{loadSystemStatus:()=>f(this,null,function*(){var o,d,l;return!Object(g.lb)()||(o=N.a.values.preflight)!==null&&o!==void 0&&o.cloud&&!((d=R.a.values.user)!==null&&d!==void 0&&d.is_staff)?null:(l=(yield h.b.get("api/instance_status")).results)!==null&&l!==void 0?l:null})}],instanceSettings:[[],{loadInstanceSettings:()=>f(this,null,function*(){var o;return(o=(yield h.b.get("api/instance_settings")).results)!==null&&o!==void 0?o:[]})}],queries:[null,{loadQueries:()=>f(this,null,function*(){return(yield h.b.get("api/instance_status/queries")).results})}],analyzeQueryResult:[null,{setAnalyzeModalOpen:()=>null,runAnalyzeQuery:()=>f(this,null,function*(){return(yield h.b.create("api/instance_status/analyze_ch_query",{query:r.analyzeQuery})).results})}]}},reducers:{tab:["overview",{setTab:(a,r)=>{let{tab:o}=r;return o}}],error:[null,{loadSystemStatusFailure:(a,r)=>{let{error:o}=r;return o}}],openSections:[["0"],{persist:!0},{setOpenSections:(a,r)=>{let{sections:o}=r;return o}}],analyzeModalOpen:[!1,{setAnalyzeModalOpen:(a,r)=>{let{isOpen:o}=r;return o},openAnalyzeModalWithQuery:()=>!0}],analyzeQuery:["",{setAnalyzeQuery:(a,r)=>{let{query:o}=r;return o},openAnalyzeModalWithQuery:(a,r)=>{let{query:o}=r;return o}}],instanceConfigMode:[x.View,{setInstanceConfigMode:(a,r)=>{let{mode:o}=r;return o}}],instanceConfigEditingState:[{},{updateInstanceConfigValue:(a,r)=>{let{key:o,value:d}=r;if(d!==void 0)return F(C({},a),{[o]:d});const l=C({},a);return delete l[o],l},clearInstanceConfigEditing:()=>({})}],updatedInstanceConfigCount:[null,{setUpdatedInstanceConfigCount:(a,r)=>{let{count:o}=r;return o},loadInstanceSettings:()=>null,increaseUpdatedInstanceConfigCount:a=>(a!=null?a:0)+1}]},selectors:()=>({overview:[a=>[a.systemStatus],a=>a?a.overview:[]],showAnalyzeQueryButton:[()=>[N.a.selectors.preflight,I.a.selectors.currentOrganization,R.a.selectors.user],(a,r,o)=>a!=null&&a.cloud?!!(o!=null&&o.is_staff):!!(r!=null&&r.membership_level)&&r.membership_level>=v.p.Admin],editableInstanceSettings:[a=>[a.instanceSettings],a=>a.filter(r=>r.editable&&w.includes(r.key))]}),listeners:a=>{let{actions:r,values:o}=a;return{setTab:d=>{let{tab:l}=d;l==="metrics"&&r.loadQueries(),r.setInstanceConfigMode(x.View)},updateInstanceConfigValue:d=>{var l;let{key:A,value:b}=d;const P=(l=o.editableInstanceSettings.find(U=>U.key===A))===null||l===void 0?void 0:l.value;b&&P==b&&r.updateInstanceConfigValue(A,void 0)},saveInstanceConfig:(d,l)=>f(this,null,function*(){r.setUpdatedInstanceConfigCount(0),Object.entries(o.instanceConfigEditingState).map(A=>f(this,null,function*(){let[b,P]=A;try{yield h.b.update(`api/instance_settings/${b}`,{value:P}),_.e.actions.reportInstanceSettingChange(b,P),r.increaseUpdatedInstanceConfigCount()}catch(U){z.d.error("There was an error updating instance settings \u2013 please try again"),yield l(1e3),r.loadInstanceSettings()}})),yield l(1e3),o.updatedInstanceConfigCount===Object.keys(o.instanceConfigEditingState).length&&(r.loadInstanceSettings(),r.clearInstanceConfigEditing(),r.setInstanceConfigMode(x.View),z.d.success("Instance settings updated"))})}},events:a=>{let{actions:r}=a;return{afterMount:()=>{r.loadSystemStatus()}}},actionToUrl:a=>{let{values:r}=a;return{setTab:()=>"/instance/"+(r.tab==="overview"?"status":r.tab)}},urlToAction:a=>{let{actions:r,values:o}=a;return{"/instance(/:tab)":d=>{let{tab:l}=d;const A=l&&["metrics","settings","staff_users","kafka_inspector"].includes(l)?l:"overview";A!==o.tab&&r.setTab(A)}}}})}}]);
