"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[88558],{"../../frontend/src/scenes/groups/GroupsNew.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{GroupsNew:()=>GroupsNew,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.35.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/LemonToast.tsx"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),sceneTypes=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts");let NEW_GROUP={},groupsNewLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>`${props.groupTypeIndex}-new`),(0,index_esm.path)(key=>["scenes","groupsNew","groupsNewLogic",key]),(0,index_esm.connect)(()=>({values:[groupsModel.$,["aggregationLabel"],featureFlagLogic.featureFlagLogic,["featureFlags"]]})),(0,index_esm.selectors)({logicProps:[()=>[(_,props)=>props],props=>props],groupTypeName:[s=>[s.aggregationLabel,s.logicProps],(aggregationLabel,logicProps)=>aggregationLabel(logicProps.groupTypeIndex).singular],groupTypeNamePlural:[s=>[s.aggregationLabel,s.logicProps],(aggregationLabel,logicProps)=>aggregationLabel(logicProps.groupTypeIndex).plural],breadcrumbs:[s=>[s.logicProps,s.groupTypeName],(logicProps,groupTypeName)=>[{key:sceneTypes.x.Groups,name:(0,utils.fm)(groupTypeName),path:urls.j.groups(logicProps.groupTypeIndex),iconType:"group"},{key:sceneTypes.x.GroupsNew,name:`Create ${groupTypeName}`,iconType:"group"}]]}),(0,index_esm.actions)({saveGroup:groupParams=>({groupParams}),addFormProperty:()=>({}),removeFormProperty:index=>({index})}),(0,index_esm.reducers)({createdGroup:[null,{saveGroupSuccess:(_,_ref)=>{let{createdGroup}=_ref;return createdGroup},resetGroup:()=>null}],customProperties:[[],{addProperty:state=>[...state,{name:"",type:"string",value:""}],removeProperty:(state,_ref2)=>{let{index}=_ref2;return state.filter((_,i)=>i!==index)},updateProperty:(state,_ref3)=>{let{index,field,value}=_ref3;return state.map((prop,i)=>i===index?{...prop,[field]:value}:prop)},resetGroup:()=>[]}]}),(0,lib.forms)(_ref4=>{let{actions,props}=_ref4;return{group:{defaults:NEW_GROUP,errors:_ref5=>{let{group_key,name,customProperties}=_ref5,errors={name:name?.trim()?void 0:"Group name cannot be empty",group_key:group_key?.trim()?void 0:"Group key cannot be empty"};if(customProperties&&customProperties.length>0){let customPropertyErrors=[],hasCustomPropertyErrors=!1;customProperties.forEach((prop,index)=>{let propertyErrors={};prop?.name?.trim()||(propertyErrors.name="Property name cannot be empty",hasCustomPropertyErrors=!0),-1!==customProperties.findIndex((p,i)=>i!==index&&p?.name?.trim()===prop?.name?.trim())&&prop?.name?.trim()&&(propertyErrors.name="Property name must be unique",hasCustomPropertyErrors=!0),prop?.name?.trim().toLowerCase()==="name"&&(propertyErrors.name='Property name "name" is reserved',hasCustomPropertyErrors=!0),customPropertyErrors[index]=propertyErrors}),hasCustomPropertyErrors&&(errors.customProperties=customPropertyErrors)}return errors},submit:formData=>{let flattenedCustomProperties=flattenProperties(formData.customProperties||[]),group_properties={name:formData.name,...flattenedCustomProperties},groupData={group_key:formData.group_key,group_type_index:props.groupTypeIndex,group_properties};actions.saveGroup(groupData)}}}}),(0,kea_loaders_lib.loaders)(()=>({createdGroup:[null,{saveGroup:async _ref6=>{let{groupParams}=_ref6;try{let newGroup=await api.ZP.groups.create(groupParams);return LemonToast.UJ.success("Group saved"),newGroup}catch(error){throw LemonToast.UJ.error("Failed to save group"),error}}}]})),(0,index_esm.listeners)(_ref7=>{let{actions,values}=_ref7;return{submitGroup:()=>{values.groupHasErrors&&LemonToast.UJ.error("There was an error submitting this group. Make sure all fields are filled correctly.")},saveGroupSuccess:()=>actions.resetGroup(),addFormProperty:()=>{let currentProperties=values.group.customProperties||[];actions.setGroupValue("customProperties",[...currentProperties,{name:"",type:"string",value:""}])},removeFormProperty:_ref8=>{let{index}=_ref8,currentProperties=values.group.customProperties||[];actions.setGroupValue("customProperties",currentProperties.filter((_,i)=>i!==index))}}}),(0,kea_router_lib.actionToUrl)(_ref9=>{let{values}=_ref9;return{saveGroupSuccess:()=>urls.j.groups(values.logicProps.groupTypeIndex)}}),(0,index_esm.afterMount)(_ref10=>{let{props,values}=_ref10;values.featureFlags[constants.y8.CRM_ITERATION_ONE]||kea_router_lib.router.actions.push(urls.j.groups(props.groupTypeIndex))}),(0,index_esm.beforeUnmount)(_ref11=>{let{actions}=_ref11;return actions.resetGroup()})]);function flattenProperties(properties){return properties.filter(prop=>prop.name.trim()&&prop.value.trim()).reduce((acc,prop)=>{let key=prop.name.trim(),value=prop.value;if("boolean"===prop.type)"true"===value?value=!0:"false"===value?value=!1:"null"===value&&(value=null);else if("string"===prop.type){let numericValue=Number(value);!isNaN(numericValue)&&isFinite(numericValue)&&""!==value.trim()&&(value=numericValue)}return acc[key]=value,acc},{})}var SceneContent=__webpack_require__("../../frontend/src/layout/scenes/components/SceneContent.tsx"),SceneDivider=__webpack_require__("../../frontend/src/layout/scenes/components/SceneDivider.tsx"),SceneTitleSection=__webpack_require__("../../frontend/src/layout/scenes/components/SceneTitleSection.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let scene={component:GroupsNew,logic:groupsNewLogic,paramsToProps:_ref=>{let{params:{groupTypeIndex}}=_ref;return{groupTypeIndex:parseInt(null!=groupTypeIndex?groupTypeIndex:"0")}}};function GroupsNew(){let{logicProps,group,groupTypeName,groupTypeNamePlural}=(0,index_esm.useValues)(groupsNewLogic),{addFormProperty,removeFormProperty,setGroupValue}=(0,index_esm.useActions)(groupsNewLogic);return(0,jsx_runtime.jsx)(lib.Form,{id:"group",logic:groupsNewLogic,props:logicProps,formKey:"group",enableFormOnSubmit:!0,children:(0,jsx_runtime.jsxs)(SceneContent._,{className:"groups-new",children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:`New ${groupTypeName} group`,resourceType:{type:"group"},actions:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"cancel-group",type:"secondary",size:"small",onClick:()=>{kea_router_lib.router.actions.push(urls.j.groups(logicProps.groupTypeIndex))},children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"primary","data-attr":"save-group",htmlType:"submit",form:"group",children:"Save"})]}),forceBackTo:{name:`People / Groups / ${(0,lib.capitalizeFirstLetter)(groupTypeNamePlural)}`,path:urls.j.groups(logicProps.groupTypeIndex),key:"groups"}}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2 max-w-200 gap-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 flex-wrap",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{"data-attr":"group-name"})})}),(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"group_key",label:"ID",children:(0,jsx_runtime.jsx)(src.DF,{"data-attr":"group-key"})})})]}),(0,jsx_runtime.jsx)(src.p2,{className:"my-4"})]}),(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2 max-w-214 gap-4",children:(0,jsx_runtime.jsxs)("div",{className:"mt-4",children:[(0,jsx_runtime.jsx)("h3",{className:"text-md font-medium mb-2",children:"Properties"}),group.customProperties&&group.customProperties.length>0&&(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-2 text-s font-medium",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:"Name"}),(0,jsx_runtime.jsx)("div",{className:"flex-1",children:"Type"}),(0,jsx_runtime.jsx)("div",{className:"flex-1",children:"Value"}),(0,jsx_runtime.jsx)("div",{className:"w-8"})," "]}),group.customProperties&&group.customProperties.map((_,index)=>(0,jsx_runtime.jsx)(lib.Group,{name:["customProperties",index],children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-2 items-start",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. is_subscribed"})})}),(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"type",children:(0,jsx_runtime.jsx)(src.P4,{onChange:value=>{setGroupValue("customProperties",(group.customProperties||[]).map((prop,i)=>i===index?{...prop,type:value,value:"string"===value?"":"true"}:prop))},value:group.customProperties?.[index]?.type||"string",options:[{value:"string",label:"Text or Number"},{value:"boolean",label:"Boolean or Null"}],size:"small"})})}),(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"value",children:group.customProperties?.[index]?.type==="boolean"?(0,jsx_runtime.jsx)(src.P4,{onChange:value=>{setGroupValue("customProperties",(group.customProperties||[]).map((prop,i)=>i===index?{...prop,value}:prop))},value:group.customProperties?.[index]?.value||"true",options:[{value:"true",label:"True"},{value:"false",label:"False"},{value:"null",label:"Null"}],size:"small"}):(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. subscription_tier"})})}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconTrash,{}),size:"small",type:"secondary",status:"danger",onClick:()=>removeFormProperty(index),"data-attr":`remove-property-${index}`})]})},index)),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),type:"secondary",onClick:addFormProperty,"data-attr":"add-property",children:"Add property"})]})})]})})}}}]);