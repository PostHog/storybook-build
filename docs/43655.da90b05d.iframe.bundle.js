(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[43655],{"../../frontend/src/scenes/experiments/Experiment.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Experiment:()=>Experiment,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.24.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),SeriesGlyph=__webpack_require__("../../frontend/src/lib/components/SeriesGlyph.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),groupsAccessLogic=__webpack_require__("../../frontend/src/lib/introductions/groupsAccessLogic.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonRadio=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonRadio/index.ts");__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSelect/index.ts");var utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),eventUsageLogic=__webpack_require__("../../frontend/src/lib/utils/eventUsageLogic.ts"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),experimentsLogic=__webpack_require__("../../frontend/src/scenes/experiments/experimentsLogic.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),experiments_experimentLogic=__webpack_require__("../../frontend/src/scenes/experiments/experimentLogic.tsx"),experiments_utils=__webpack_require__("../../frontend/src/scenes/experiments/utils.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let ExperimentFormFields=()=>{var _experiment$parameter;let{formMode,experiment,groupTypes,aggregationLabel,hasPrimaryMetricSet,validExistingFeatureFlag}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{addVariant,removeVariant,setExperiment,submitExperiment,setExperimentType,validateFeatureFlag}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{webExperimentsAvailable,unavailableFeatureFlagKeys}=(0,index_esm.useValues)(experimentsLogic.OK),{groupsAccessStatus}=(0,index_esm.useValues)(groupsAccessLogic.e),{reportExperimentFeatureFlagModalOpened,reportExperimentFeatureFlagSelected}=(0,index_esm.useActions)(eventUsageLogic.vx),[showFeatureFlagSelector,setShowFeatureFlagSelector]=(0,react.useState)(!1);return(0,jsx_runtime.jsxs)("div",{children:[hasPrimaryMetricSet&&"duplicate"!==formMode&&(0,jsx_runtime.jsx)(src.Vp,{type:"info",className:"my-4",children:"Fill out the details below to create your experiment based off of the insight."}),"duplicate"===formMode&&(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"my-4",children:["We'll copy all settings, including metrics and exposure configuration, from theÂ ",(0,jsx_runtime.jsxs)(src.rU,{target:"_blank",className:"font-semibold items-center",to:urls.j.experiment(experiment.id),children:["original experiment",(0,jsx_runtime.jsx)(icons.pF,{fontSize:"18"})]}),"."]}),(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-8",children:[(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-6 max-w-120",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"Pricing page conversion","data-attr":"experiment-name",onBlur:()=>{!experiment.feature_flag_key&&setExperiment({feature_flag_key:generateFeatureFlagKey(experiment.name,unavailableFeatureFlagKeys)})}})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"feature_flag_key",label:"Feature flag key",help:(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsx)("span",{children:"Each experiment is backed by a feature flag."}),(0,jsx_runtime.jsxs)(LemonButton.J,{type:"secondary",size:"xsmall",onClick:()=>{reportExperimentFeatureFlagModalOpened(),setShowFeatureFlagSelector(!0)},children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconToggle,{className:"mr-1"}),"Link to existing feature flag"]})]}),children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"pricing-page-conversion","data-attr":"experiment-feature-flag-key"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"description",label:"Description",children:(0,jsx_runtime.jsx)(src._V,{placeholder:"The goal of this experiment is ...","data-attr":"experiment-description"})})]}),(0,jsx_runtime.jsx)(SelectExistingFeatureFlagModal,{isOpen:showFeatureFlagSelector,onClose:()=>setShowFeatureFlagSelector(!1),onSelect:flag=>{reportExperimentFeatureFlagSelected(flag.key),setExperiment({feature_flag_key:flag.key,parameters:{...experiment.parameters,feature_flag_variants:flag.filters?.multivariate?.variants||[]}}),validateFeatureFlag(flag.key),setShowFeatureFlagSelector(!1)}}),webExperimentsAvailable&&(0,jsx_runtime.jsxs)("div",{className:"mt-10",children:[(0,jsx_runtime.jsx)("h3",{className:"mb-1",children:"Experiment type"}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary font-medium tracking-normal",children:"Select your experiment setup, this cannot be changed once saved."}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(LemonRadio._,{value:experiment.type,className:"deprecated-space-y-2 -mt-2",onChange:type=>{setExperimentType(type)},options:[{value:"product",label:(0,jsx_runtime.jsxs)("div",{className:"translate-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"Product experiment"}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary",children:"Use custom code to manage how variants modify your product."})]})},{value:"web",label:(0,jsx_runtime.jsxs)("div",{className:"translate-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"No-code web experiment"}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary",children:"Define variants on your website using the PostHog toolbar, no coding required."})]})}]})]}),groupsAccessStatus===groupsAccessLogic.Q.AlreadyUsing&&(0,jsx_runtime.jsxs)("div",{className:"mt-10",children:[(0,jsx_runtime.jsx)("h3",{children:"Participant type"}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary  max-w-150",children:"Determines on what level you want to aggregate metrics. You can change this later, but flag values for users will change so you need to reset the experiment for accurate results."}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(LemonRadio._,{value:void 0!=experiment.parameters.aggregation_group_type_index?experiment.parameters.aggregation_group_type_index:-1,onChange:rawGroupTypeIndex=>{let groupTypeIndex=-1!==rawGroupTypeIndex?rawGroupTypeIndex:void 0;setExperiment({parameters:{...experiment.parameters,aggregation_group_type_index:null!=groupTypeIndex?groupTypeIndex:void 0}})},options:[{value:-1,label:"Persons"},...Array.from(groupTypes.values()).map(groupType=>({value:groupType.group_type_index,label:(0,utils.fm)(aggregationLabel(groupType.group_type_index).plural)}))]})]}),validExistingFeatureFlag&&(0,jsx_runtime.jsxs)("div",{className:"mt-10",children:[(0,jsx_runtime.jsx)("h3",{className:"mb-1",children:"Variants"}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(src.Vp,{type:"info",className:"mb-8",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)("div",{children:"Existing feature flag configuration will be applied to the experiment."}),(0,jsx_runtime.jsx)(src.rU,{to:urls.j.featureFlag(validExistingFeatureFlag.id),target:"_blank",className:"flex items-center",children:(0,jsx_runtime.jsx)(icons.pF,{className:"ml-1"})})]})})]}),!validExistingFeatureFlag&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"mt-10",children:[(0,jsx_runtime.jsx)("h3",{className:"mb-1",children:"Variants"}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-secondary",children:["Add up to ",constants.Rp-1," variants to test against your control."]}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-2 gap-4 max-w-160",children:[(0,jsx_runtime.jsxs)("div",{className:"max-w-60",children:[(0,jsx_runtime.jsx)("h3",{children:"Control"}),(0,jsx_runtime.jsx)("div",{className:"flex items-center",children:(0,jsx_runtime.jsxs)(lib.Group,{name:["parameters","feature_flag_variants",0],children:[(0,jsx_runtime.jsx)(SeriesGlyph.jc,{index:0,className:"h-7 w-7 text-base"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"key",className:"ml-2 flex-grow",children:(0,jsx_runtime.jsx)(src.DF,{disabled:!0,"data-attr":"experiment-variant-key","data-key-index":0,className:"ph-ignore-input",fullWidth:!0,autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:!1})})]},0)}),(0,jsx_runtime.jsx)("div",{className:"text-muted text-xs mt-2",children:"Included automatically, cannot be edited or removed"})]}),(0,jsx_runtime.jsxs)("div",{className:"max-w-100",children:[(0,jsx_runtime.jsx)("h3",{children:"Test(s)"}),experiment.parameters.feature_flag_variants?.map((_,index)=>0===index?null:jsx_runtime.jsx(lib.Group,{name:["parameters","feature_flag_variants",index],children:jsx_runtime.jsxs("div",{className:`flex items-center deprecated-space-x-2 ${index>1&&"mt-2"}`,children:[jsx_runtime.jsx(SeriesGlyph.jc,{index:index,className:"h-7 w-7 text-base"}),jsx_runtime.jsx(LemonField.D,{name:"key",className:"flex-grow",children:jsx_runtime.jsx(src.DF,{"data-attr":"experiment-variant-key","data-key-index":index.toString(),className:"ph-ignore-input",fullWidth:!0,autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:!1})}),jsx_runtime.jsx("div",{className:`${1===index&&"pr-9"}`,children:1!==index&&jsx_runtime.jsx(src.u,{title:"Delete this variant",placement:"top-start",children:jsx_runtime.jsx(LemonButton.J,{size:"small",icon:jsx_runtime.jsx(posthog_icons_es.IconTrash,{}),onClick:()=>removeVariant(index)})})})]},`variant-${index}`)},index)),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-xs ml-9 mr-20 mt-2",children:"Alphanumeric, hyphens and underscores only"}),(null!==(_experiment$parameter=experiment.parameters.feature_flag_variants.length)&&void 0!==_experiment$parameter?_experiment$parameter:0)<constants.Rp&&(0,jsx_runtime.jsx)(LemonButton.J,{className:"ml-9 mt-2",type:"secondary",onClick:()=>addVariant(),icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),"data-attr":"add-test-variant",children:"Add test variant"})]})]})]}),(0,jsx_runtime.jsx)("div",{className:"mt-10 pb-6 max-w-150",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"parameters.ensure_experience_continuity",children:_ref=>{let{value,onChange}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"border rounded p-4",children:[(0,jsx_runtime.jsx)(src.Hw,{id:"continuity-checkbox",label:"Persist flag across authentication steps",onChange:()=>onChange(!value),fullWidth:!0,checked:value}),(0,jsx_runtime.jsxs)("div",{className:"text-secondary text-sm pl-7",children:["If your feature flag is evaluated for anonymous users, use this option to ensure the flag value remains consistent after the user logs in. Depending on your setup, this option may not always be appropriate. Note that this feature requires creating profiles for anonymous users."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/feature-flags/creating-feature-flags#persisting-feature-flags-across-authentication-steps",target:"_blank",children:"Learn more"})]})]})}})})]})]}),(0,jsx_runtime.jsx)(LemonButton.J,{className:"mt-2",type:"primary","data-attr":"save-experiment",onClick:()=>submitExperiment(),children:"Save as draft"})]})};function ExperimentForm(){let{props}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);return(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(lib.Form,{id:"experiment-step",logic:experiments_experimentLogic.Wl,formKey:"experiment",props:props,enableFormOnSubmit:!0,className:"deprecated-space-y-6 experiment-form",children:(0,jsx_runtime.jsx)(ExperimentFormFields,{})})})}let generateFeatureFlagKey=(name,unavailableFeatureFlagKeys)=>{let baseKey=name.toLowerCase().replace(/[^A-Za-z0-9-_]+/g,"-").replace(/-+$/,"").replace(/^-+/,""),key=baseKey,counter=1;for(;unavailableFeatureFlagKeys.has(key);)key=`${baseKey}-${counter}`,counter++;return key},SelectExistingFeatureFlagModal=_ref2=>{let{isOpen,onClose,onSelect}=_ref2,{featureFlags}=(0,index_esm.useValues)(experimentsLogic.OK);return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:onClose,title:"Choose an existing feature flag",children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"text-muted mb-2 max-w-xl",children:["Select an existing feature flag to use with this experiment. The feature flag must use multiple variants with ",(0,jsx_runtime.jsx)("code",{children:"'control'"})," as the first, and not be associated with an existing experiment."]}),(0,jsx_runtime.jsx)(src.g3,{dataSource:featureFlags.results,useURLForSorting:!1,columns:[{title:"Key",dataIndex:"key",sorter:(a,b)=>(a.key||"").localeCompare(b.key||""),render:(key,flag)=>(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:key}),(0,jsx_runtime.jsx)(src.rU,{to:urls.j.featureFlag(flag.id),target:"_blank",className:"flex items-center",children:(0,jsx_runtime.jsx)(icons.pF,{className:"ml-1"})})]})},{title:"Name",dataIndex:"name",sorter:(a,b)=>(a.name||"").localeCompare(b.name||"")},{title:null,render:function RenderActions(_,flag){let disabledReason;try{(0,experiments_utils.i3)(flag)}catch(error){disabledReason=error.message}return(0,jsx_runtime.jsx)(LemonButton.J,{size:"xsmall",type:"primary",disabledReason:disabledReason,onClick:()=>{onSelect(flag),onClose()},children:"Select"})}}]})]})})};var AuthorizedUrlList=__webpack_require__("../../frontend/src/lib/components/AuthorizedUrlList/AuthorizedUrlList.tsx"),authorizedUrlListLogic=__webpack_require__("../../frontend/src/lib/components/AuthorizedUrlList/authorizedUrlListLogic.ts"),LemonDialog=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonDialog/index.ts");function WebExperimentImplementationDetails(_ref){let{experiment}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h2",{className:"font-semibold text-lg mb-2",children:"Implementation"}),(0,jsx_runtime.jsxs)("div",{className:"border p-6 rounded bg-surface-primary deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold leading-tight text-base text-current",children:"Define variant changes directly on your website"}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-secondary",children:"Use our toolbar to select elements and apply transformations for each variant."}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(LemonButton.J,{size:"small",type:"secondary",onClick:()=>{LemonDialog.d.open({title:"Select a domain",description:experiment?.id?"Choose the domain on which to edit this experiment":"Choose the domain on which to create this experiment",content:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(AuthorizedUrlList.t,{experimentId:experiment?.id,type:authorizedUrlListLogic.uw.TOOLBAR_URLS})}),primaryButton:{children:"Close",type:"secondary"}})},sideIcon:(0,jsx_runtime.jsx)(icons.UE,{}),children:"Launch toolbar on your website"})})]})]})})}function ExploreAsInsightButton(_ref){let{query}=_ref;return(0,jsx_runtime.jsx)(LemonButton.J,{className:"ml-auto -translate-y-2",size:"xsmall",type:"primary",icon:(0,jsx_runtime.jsx)(icons.Ii,{}),to:urls.j.insightNew({query}),targetBlank:!0,children:"Explore as Insight"})}var kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),dist=__webpack_require__("../../node_modules/.pnpm/ts-pattern@4.3.0/node_modules/ts-pattern/dist/index.js"),queries_query=__webpack_require__("../../frontend/src/queries/query.ts"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),metricQueryUtils=__webpack_require__("../../frontend/src/scenes/experiments/metricQueryUtils.ts"),types=__webpack_require__("../../frontend/src/types.ts");let filterFunnelSteps=(steps,variants)=>steps.filter(step=>(0,dist.EQ)(step.breakdown_value).with(void 0,()=>!1).with(dist.P.array(dist.P.string),values=>values.some(value=>variants.includes(value))).otherwise(()=>variants.includes(step.breakdown_value))),resultsBreakdownLogic=(0,index_esm.kea)([(0,index_esm.props)({experiment:{},metric:{}}),(0,index_esm.key)(props=>`${props.experiment.id}-${props.metricIndex}-${props.isPrimary?"primary":"secondary"}`),(0,index_esm.path)(key=>["scenes","experiment","experimentResultBreakdownLogic",key]),(0,index_esm.actions)({loadBreakdownResults:!0}),(0,index_esm.selectors)({query:[()=>[(_,props)=>props],_ref=>{let{experiment,metric}=_ref;if(!metric)return null;let exposureEventNode=(0,metricQueryUtils.YL)(experiment.exposure_criteria?.exposure_config,{featureFlagKey:experiment.feature_flag_key,featureFlagVariants:experiment.parameters.feature_flag_variants});return(0,metricQueryUtils.qC)((0,metricQueryUtils.jV)(exposureEventNode),(0,metricQueryUtils.pm)({filterTestAccounts:!!experiment.exposure_criteria?.filterTestAccounts,dateRange:(0,metricQueryUtils.zZ)(experiment),breakdownFilter:{breakdown:"$feature_flag_called"===exposureEventNode.event?"$feature_flag_response":`$feature/${experiment.feature_flag_key}`,breakdown_type:"event"},funnelsFilter:{layout:constants.xp.vertical,breakdownAttributionType:types.q9.Step,breakdownAttributionValue:0,funnelOrderType:(0,schema_general.N4)(metric)&&metric.funnel_order_type||types.kO.ORDERED,funnelStepReference:types.XF.total,funnelVizType:types.Ui.Steps,funnelWindowInterval:14,funnelWindowIntervalUnit:types.ih.Day}}),(0,metricQueryUtils.cc)({showTable:!0,showLastComputation:!0,showLastComputationRefresh:!1}))(metric)||null}]}),(0,kea_loaders_lib.loaders)(_ref2=>{let{props,values}=_ref2;return{breakdownResults:[null,{loadBreakdownResults:async()=>{try{let{experiment}=props,query=values.query;if(!query)throw Error("No query returned from queryBuilder");if(query.source.kind===schema_general.OH.TrendsQuery)return[];let response=await (0,queries_query.jr)(query);if(!response?.results)throw Error("No results returned from query");let results=response.results,variants=experiment.parameters.feature_flag_variants.map(_ref3=>{let{key}=_ref3;return key});return results=(0,dist.EQ)(results).with(dist.P.array(dist.P.array({breakdown_value:dist.P.any})),nestedSteps=>nestedSteps.map(stepGroup=>filterFunnelSteps(stepGroup,variants)).filter(steps=>steps.length>0)).with(dist.P.array({breakdown_value:dist.P.any}),flatSteps=>filterFunnelSteps(flatSteps,variants)).otherwise(()=>[])}catch(error){throw Error(error instanceof Error?`Failed to load experiment results: ${error.message}`:"Failed to load experiment results")}}}]}}),(0,index_esm.afterMount)(_ref4=>{let{actions,props}=_ref4,{metric,experiment}=props;experiment&&metric&&metric.kind===schema_general.OH.ExperimentMetric&&metric.metric_type===schema_general.Tu.FUNNEL&&actions.loadBreakdownResults()})]),isExperimentVariantFunnels=variant=>"success_count"in variant&&"failure_count"in variant,calculateLegacyExposureCount=result=>result.variants?result.variants.reduce((acc,variant)=>isExperimentVariantFunnels(variant)?acc+variant.success_count+variant.failure_count:acc+variant.count,0):-1,calculateExposureCount=result=>[result.baseline,...result.variant_results||[]].reduce((acc,_ref)=>{let{number_of_samples}=_ref;return acc+number_of_samples},0),calculateExposureDifference=(result,breakdownResults)=>{let breakdownResultsTotalExposureCount=breakdownResults?breakdownResults.reduce((acc,result)=>acc+result[0].count,0):0;return(0,experiments_experimentLogic.Oi)(result)?calculateExposureCount(result)-breakdownResultsTotalExposureCount:calculateLegacyExposureCount(result)-breakdownResultsTotalExposureCount},ResultsBreakdownContent=_ref2=>{let{result,children}=_ref2,{query,breakdownResults,breakdownResultsLoading}=(0,index_esm.useValues)(resultsBreakdownLogic),exposureDifference=calculateExposureDifference(result,breakdownResults);return children&&"function"==typeof children?children({query,breakdownResults,breakdownResultsLoading,exposureDifference}):null},ResultsBreakdown=_ref=>{let{result,experiment,metricIndex,isPrimary,children}=_ref;return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:resultsBreakdownLogic,props:{experiment,metric:result.metric,metricIndex,isPrimary},children:(0,jsx_runtime.jsx)(ResultsBreakdownContent,{result:result,children:children})})};var Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/Spinner.tsx");let ResultsBreakdownSkeleton=()=>(0,jsx_runtime.jsx)("div",{className:"space-y-4",children:(0,jsx_runtime.jsx)("div",{className:"border rounded-lg p-4 bg-bg-light space-y-3",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-center gap-2 font-normal",children:[(0,jsx_runtime.jsx)(Spinner.$,{className:"text-lg"}),(0,jsx_runtime.jsx)("span",{children:"Loading breakdown"})]})})}),ResultsInsightInfoBanner=_ref=>{let{exposureDifference}=_ref;return 0===exposureDifference?null:(0,jsx_runtime.jsx)(src.Vp,{type:"info",className:"mb-4",children:(0,jsx_runtime.jsx)("div",{className:"items-center inline-flex flex-wrap",children:(0,jsx_runtime.jsxs)("span",{children:["Insight results may be slightly different from exposure results due to a difference in data processing methods. We're actively working on fixing this.Â ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/experiments/common-questions",className:"font-semibold text-primary hover:text-primary-dark",children:"Learn more in our docs"}),"."]})})})};var Query=__webpack_require__("../../frontend/src/queries/Query/Query.tsx");let ResultsQuery=_ref=>{let{query,breakdownResults}=_ref;if(query.source.kind===schema_general.OH.TrendsQuery)return null;let fakeInsightId=Math.random().toString(36).substring(2,15);return(0,jsx_runtime.jsx)(Query.A,{query:query,context:{insightProps:{dashboardItemId:fakeInsightId,cachedInsight:{short_id:fakeInsightId,query,result:breakdownResults,disable_baseline:!0},doNotLoad:!0}},readOnly:!0})};var ExperimentImplementationDetails=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentImplementationDetails.tsx"),ExperimentMetricForm=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentMetricForm.tsx"),modalsLogic=__webpack_require__("../../frontend/src/scenes/experiments/modalsLogic.ts");function ExperimentMetricModal(_ref){let{experimentId,isSecondary}=_ref,{experiment,experimentLoading,editingPrimaryMetricIndex,editingSecondaryMetricIndex}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{setMetric,updateExperimentMetrics,setExperiment,restoreUnmodifiedExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closePrimaryMetricModal,closeSecondaryMetricModal}=(0,index_esm.useActions)(modalsLogic.l),{isPrimaryMetricModalOpen,isSecondaryMetricModalOpen}=(0,index_esm.useValues)(modalsLogic.l),metricIdx=isSecondary?editingSecondaryMetricIndex:editingPrimaryMetricIndex,metricsField=isSecondary?"metrics_secondary":"metrics",handleSetMetric=(0,react.useCallback)(newMetric=>{null!=metricIdx&&setMetric({metricIdx,metric:newMetric,isSecondary})},[metricIdx,isSecondary,setMetric]);if(null==metricIdx)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let metrics=experiment[metricsField],metric=metrics[metricIdx],onClose=()=>{restoreUnmodifiedExperiment(),isSecondary?closeSecondaryMetricModal():closePrimaryMetricModal()};return(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isSecondary?isSecondaryMetricModalOpen:isPrimaryMetricModalOpen,onClose:onClose,width:1e3,title:"Edit experiment metric",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center w-full",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",status:"danger",onClick:()=>{src.dn.open({title:"Delete this metric?",content:(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:"This action cannot be undone."}),primaryButton:{children:"Delete",type:"primary",onClick:()=>{setExperiment({[metricsField]:metrics.filter((_,idx)=>idx!==metricIdx)}),updateExperimentMetrics(),isSecondary?closeSecondaryMetricModal():closePrimaryMetricModal()},size:"small"},secondaryButton:{children:"Cancel",type:"tertiary",size:"small"}})},children:"Delete"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 ml-auto",children:[(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-metric-form",type:"secondary",onClick:onClose,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-metric-form",onClick:()=>{updateExperimentMetrics(),isSecondary?closeSecondaryMetricModal():closePrimaryMetricModal()},type:"primary",loading:experimentLoading,"data-attr":"save-experiment-metric",children:"Save"})]})]}),children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{className:"mb-1",children:"Name (optional)"}),(0,jsx_runtime.jsx)(src.DF,{value:metric.name,onChange:newName=>{setMetric({metricIdx,metric:{...metric,name:newName},isSecondary})}})]}),(0,jsx_runtime.jsx)(ExperimentMetricForm.U,{metric:metric,handleSetMetric:handleSetMetric,filterTestAccounts:experiment.exposure_criteria?.filterTestAccounts||!1})]})}var TaxonomicFilter_types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),TestAccountFiltersSwitch=__webpack_require__("../../frontend/src/lib/components/TestAccountFiltersSwitch.tsx"),LemonBanner=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonBanner/index.ts"),ActionFilter=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),AggregationSelect=__webpack_require__("../../frontend/src/scenes/insights/filters/AggregationSelect.tsx"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),filtersToQueryNode=__webpack_require__("../../frontend/src/queries/nodes/InsightQuery/utils/filtersToQueryNode.ts"),queryNodeToFilter=__webpack_require__("../../frontend/src/queries/nodes/InsightQuery/utils/queryNodeToFilter.ts"),Selectors=__webpack_require__("../../frontend/src/scenes/experiments/Metrics/Selectors.tsx");function FunnelsMetricForm(_ref){var _currentMetric$funnel,_currentMetric$funnel2;let{isSecondary=!1}=_ref,{currentTeam}=(0,index_esm.useValues)(teamLogic.teamLogic),{experiment,isExperimentRunning,editingPrimaryMetricIndex,editingSecondaryMetricIndex}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{setFunnelsMetric}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),hasFilters=(currentTeam?.test_account_filters||[]).length>0,metrics=isSecondary?experiment.metrics_secondary:experiment.metrics,metricIdx=isSecondary?editingSecondaryMetricIndex:editingPrimaryMetricIndex;if(!metricIdx&&0!==metricIdx)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let currentMetric=metrics[metricIdx],actionFilterProps={...Selectors.dF,actionsTaxonomicGroupTypes:[TaxonomicFilter_types.t.Events,TaxonomicFilter_types.t.Actions]};return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Name (optional)"}),(0,jsx_runtime.jsx)(src.DF,{value:currentMetric.name,onChange:newName=>{setFunnelsMetric({metricIdx,name:newName,isSecondary})}})]}),(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(currentMetric.funnels_query),setFilters:_ref2=>{let{actions,events,data_warehouse}=_ref2;setFunnelsMetric({metricIdx,series:(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.None),isSecondary})},typeKey:"experiment-metric",mathAvailability:ActionFilterRow.Qq.None,buttonCopy:"Add funnel step",showSeriesIndicator:!0,seriesIndicatorType:"numeric",sortable:!0,showNestedArrow:!0,...actionFilterProps}),(0,jsx_runtime.jsxs)("div",{className:"mt-4 deprecated-space-y-4",children:[(0,jsx_runtime.jsx)(Selectors.xE,{value:(0,AggregationSelect.eV)(null!==(_currentMetric$funnel=currentMetric.funnels_query.aggregation_group_type_index)&&void 0!==_currentMetric$funnel?_currentMetric$funnel:void 0,null!==(_currentMetric$funnel2=currentMetric.funnels_query.funnelsFilter?.funnelAggregateByHogQL)&&void 0!==_currentMetric$funnel2?_currentMetric$funnel2:void 0),onChange:value=>{setFunnelsMetric({metricIdx,funnelAggregateByHogQL:value,isSecondary})}}),(0,jsx_runtime.jsx)(Selectors.IF,{funnelWindowInterval:currentMetric.funnels_query?.funnelsFilter?.funnelWindowInterval,funnelWindowIntervalUnit:currentMetric.funnels_query?.funnelsFilter?.funnelWindowIntervalUnit,onFunnelWindowIntervalChange:funnelWindowInterval=>{setFunnelsMetric({metricIdx,funnelWindowInterval:funnelWindowInterval,isSecondary})},onFunnelWindowIntervalUnitChange:funnelWindowIntervalUnit=>{setFunnelsMetric({metricIdx,funnelWindowIntervalUnit:funnelWindowIntervalUnit||void 0,isSecondary})}}),(0,jsx_runtime.jsx)(Selectors.f$,{value:(()=>{let breakdownAttributionType=currentMetric.funnels_query?.funnelsFilter?.breakdownAttributionType,breakdownAttributionValue=currentMetric.funnels_query?.funnelsFilter?.breakdownAttributionValue;return breakdownAttributionType?breakdownAttributionType===types.q9.Step?`${breakdownAttributionType}/${breakdownAttributionValue||0}`:breakdownAttributionType:types.q9.FirstTouch})(),onChange:value=>{let[breakdownAttributionType,breakdownAttributionValue]=(value||"").split("/");setFunnelsMetric({metricIdx,breakdownAttributionType:breakdownAttributionType,breakdownAttributionValue:breakdownAttributionValue?parseInt(breakdownAttributionValue):void 0,isSecondary})},stepsLength:currentMetric.funnels_query?.series?.length}),(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=currentMetric.funnels_query?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{setFunnelsMetric({metricIdx,filterTestAccounts:checked,isSecondary})},fullWidth:!0})]}),isExperimentRunning&&(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema_general.OH.InsightVizNode,source:currentMetric.funnels_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})}var injectStylesIntoStyleTag=__webpack_require__("../../node_modules/.pnpm/style-loader@2.0.0_webpack@5.88.2/node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),TrendsMetricForm=__webpack_require__("../../node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!../../node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.5.6_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!../../node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!../../frontend/src/scenes/experiments/Metrics/TrendsMetricForm.scss"),TrendsMetricForm_default=__webpack_require__.n(TrendsMetricForm),options={};options.insert="head",options.singleton=!1,injectStylesIntoStyleTag_default()(TrendsMetricForm_default(),options),TrendsMetricForm_default().locals;var dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),experiments_constants=__webpack_require__("../../frontend/src/scenes/experiments/constants.ts");function TrendsMetricForm_TrendsMetricForm(_ref){let{isSecondary=!1}=_ref,{experiment,isExperimentRunning,editingPrimaryMetricIndex,editingSecondaryMetricIndex}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{setTrendsMetric,setTrendsExposureMetric,setExperiment}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{currentTeam}=(0,index_esm.useValues)(teamLogic.teamLogic),hasFilters=(currentTeam?.test_account_filters||[]).length>0,[activeTab,setActiveTab]=(0,react.useState)("main"),metrics=isSecondary?experiment.metrics_secondary:experiment.metrics,metricIdx=isSecondary?editingSecondaryMetricIndex:editingPrimaryMetricIndex;if(!metricIdx&&0!==metricIdx)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let currentMetric=metrics[metricIdx],isDataWarehouseMetric=currentMetric.count_query?.series[0]?.kind===schema_general.OH.DataWarehouseNode;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,onChange:newKey=>setActiveTab(newKey),tabs:[{key:"main",label:"Main metric",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Name (optional)"}),(0,jsx_runtime.jsx)(src.DF,{value:currentMetric.name,onChange:newName=>{setTrendsMetric({metricIdx,name:newName,isSecondary})}})]}),(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(currentMetric.count_query),setFilters:_ref2=>{let{actions,events,data_warehouse}=_ref2,series=(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.All);series[0].kind===schema_general.OH.DataWarehouseNode&&setExperiment({...experiment,[isSecondary?"metrics_secondary":"metrics"]:metrics.map((metric,idx)=>idx===metricIdx?{...metric,exposure_query:void 0}:metric)}),setTrendsMetric({metricIdx,series,isSecondary})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!0,entitiesLimit:1,showNumericalPropsOnly:!0,allowedMathTypes:experiments_constants.BK,...Selectors.dF}),(0,jsx_runtime.jsx)("div",{className:"mt-4 deprecated-space-y-4",children:(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:!!hasFilters&&!!currentMetric.count_query?.filterTestAccounts,onChange:checked=>{setTrendsMetric({metricIdx,filterTestAccounts:checked,isSecondary})},fullWidth:!0})}),isExperimentRunning&&(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema_general.OH.InsightVizNode,source:currentMetric.count_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})},{key:"exposure",label:"Exposure",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsxs)(src.Jp,{className:`trends-metric-form__exposure-button flex-1 cursor-pointer p-4 rounded border ${currentMetric.exposure_query?"border-primary":"border-accent bg-accent-highlight-secondary"}`,onClick:()=>{setExperiment({...experiment,[isSecondary?"metrics_secondary":"metrics"]:metrics.map((metric,idx)=>idx===metricIdx?{...metric,exposure_query:void 0}:metric)})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Default"}),!currentMetric.exposure_query&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--accent)"})]}),(0,jsx_runtime.jsxs)("div",{className:"text-secondary text-sm leading-relaxed mt-1",children:["Uses the number of unique users who trigger the"," ",(0,jsx_runtime.jsx)(src.oe,{children:"$feature_flag_called"})," event as your exposure count. This is the recommended setting for most experiments, as it accurately tracks variant exposure."]})]}),(0,jsx_runtime.jsxs)(src.Jp,{className:`trends-metric-form__exposure-button flex-1 cursor-pointer p-4 rounded border ${currentMetric.exposure_query?"border-accent bg-accent-highlight-secondary":"border-primary"}`,disabledReason:isDataWarehouseMetric?"Custom exposure events are not supported for data warehouse metrics. Please contact support if you need this feature.":void 0,onClick:()=>{setExperiment({...experiment,[isSecondary?"metrics_secondary":"metrics"]:metrics.map((metric,idx)=>idx===metricIdx?{...metric,exposure_query:{kind:schema_general.OH.TrendsQuery,series:[{kind:schema_general.OH.EventsNode,name:"$feature_flag_called",event:"$feature_flag_called",math:types.vN.UniqueUsers}],interval:"day",dateRange:{date_from:(0,dayjs.Bv)().subtract(constants.uq,"day").format("YYYY-MM-DDTHH:mm"),date_to:(0,dayjs.Bv)().endOf("d").format("YYYY-MM-DDTHH:mm"),explicitDate:!0},trendsFilter:{display:types.Qb.ActionsLineGraph},filterTestAccounts:!0}}:metric)})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Custom"}),currentMetric.exposure_query&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--accent)"})]}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm leading-relaxed mt-1",children:"Define your own exposure metric for specific use cases, such as counting by sessions instead of users. This gives you full control but requires careful configuration."})]})]}),currentMetric.exposure_query&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(currentMetric.exposure_query),setFilters:_ref3=>{let{actions,events,data_warehouse}=_ref3;setTrendsExposureMetric({metricIdx,series:(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.All),isSecondary})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!0,entitiesLimit:1,showNumericalPropsOnly:!0,...Selectors.dF}),(0,jsx_runtime.jsx)("div",{className:"mt-4 deprecated-space-y-4",children:(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=currentMetric.exposure_query?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{setTrendsExposureMetric({metricIdx,filterTestAccounts:checked,isSecondary})},fullWidth:!0})}),isExperimentRunning&&(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," ","days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema_general.OH.InsightVizNode,source:currentMetric.exposure_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})]})}]})})}function LegacyMetricModal(_ref){let{experimentId,isSecondary}=_ref,{experiment,experimentLoading,getInsightType,editingPrimaryMetricIndex,editingSecondaryMetricIndex}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{updateExperimentMetrics,setExperiment,restoreUnmodifiedExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closePrimaryMetricModal,closeSecondaryMetricModal}=(0,index_esm.useActions)(modalsLogic.l),{isPrimaryMetricModalOpen,isSecondaryMetricModalOpen}=(0,index_esm.useValues)(modalsLogic.l),metricIdx=isSecondary?editingSecondaryMetricIndex:editingPrimaryMetricIndex,metricsField=isSecondary?"metrics_secondary":"metrics";if(!metricIdx&&0!==metricIdx)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let metrics=experiment[metricsField],metric=metrics[metricIdx],insightType=getInsightType(metric),funnelStepsLength=metric?.funnels_query?.series?.length||0,onClose=()=>{restoreUnmodifiedExperiment(),isSecondary?closeSecondaryMetricModal():closePrimaryMetricModal()};return(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isSecondary?isSecondaryMetricModalOpen:isPrimaryMetricModalOpen,onClose:onClose,width:1e3,title:"Edit experiment metric",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center w-full",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",status:"danger",onClick:()=>{src.dn.open({title:"Delete this metric?",content:(0,jsx_runtime.jsx)("div",{className:"text-sm text-secondary",children:"This action cannot be undone."}),primaryButton:{children:"Delete",type:"primary",onClick:()=>{setExperiment({[metricsField]:metrics.filter((_,idx)=>idx!==metricIdx)}),updateExperimentMetrics(),isSecondary?closeSecondaryMetricModal():closePrimaryMetricModal()},size:"small"},secondaryButton:{children:"Cancel",type:"tertiary",size:"small"}})},children:"Delete"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 ml-auto",children:[(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-goal-form",type:"secondary",onClick:onClose,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{disabledReason:insightType===types.dw.FUNNELS&&funnelStepsLength<2&&"The experiment needs at least two funnel steps.",form:"edit-experiment-goal-form",onClick:()=>{updateExperimentMetrics(),isSecondary?closeSecondaryMetricModal():closePrimaryMetricModal()},type:"primary",loading:experimentLoading,"data-attr":"create-annotation-submit",children:"Save"})]})]}),children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center w-full gap-2 mb-4",children:[(0,jsx_runtime.jsx)("span",{children:"Metric type"}),(0,jsx_runtime.jsx)(src.Yv,{"data-attr":"metrics-selector",value:insightType,onChange:newInsightType=>{setExperiment({...experiment,[metricsField]:[...metrics.slice(0,metricIdx),newInsightType===types.dw.TRENDS?(0,experiments_utils.ug)():(0,experiments_utils.xs)(),...metrics.slice(metricIdx+1)]})},options:[{value:types.dw.TRENDS,label:(0,jsx_runtime.jsx)("b",{children:"Trends"})},{value:types.dw.FUNNELS,label:(0,jsx_runtime.jsx)("b",{children:"Funnels"})}]})]}),insightType===types.dw.TRENDS?(0,jsx_runtime.jsx)(TrendsMetricForm_TrendsMetricForm,{isSecondary:isSecondary}):(0,jsx_runtime.jsx)(FunnelsMetricForm,{isSecondary:isSecondary})]})}function MetricSourceModal(_ref){let{experimentId,isSecondary}=_ref,{experiment,usesNewQueryRunner}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{setExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closePrimaryMetricSourceModal,closeSecondaryMetricSourceModal,openPrimaryMetricModal,openSecondaryMetricModal,openPrimarySharedMetricModal,openSecondarySharedMetricModal}=(0,index_esm.useActions)(modalsLogic.l),{isPrimaryMetricSourceModalOpen,isSecondaryMetricSourceModalOpen}=(0,index_esm.useValues)(modalsLogic.l),metricsField=isSecondary?"metrics_secondary":"metrics",closeCurrentModal=isSecondary?closeSecondaryMetricSourceModal:closePrimaryMetricSourceModal,openMetricModal=isSecondary?openSecondaryMetricModal:openPrimaryMetricModal,openSharedMetricModal=isSecondary?openSecondarySharedMetricModal:openPrimarySharedMetricModal;return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isSecondary?isSecondaryMetricSourceModalOpen:isPrimaryMetricSourceModalOpen,onClose:closeCurrentModal,width:1e3,title:"Choose metric source",children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 cursor-pointer p-4 rounded border hover:border-accent",onClick:()=>{closeCurrentModal();let defaultMetric=usesNewQueryRunner?(0,experiments_utils.US)():(0,experiments_utils.xs)(),newMetrics=[...experiment[metricsField],defaultMetric];setExperiment({[metricsField]:newMetrics}),openMetricModal(newMetrics.length-1)},children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,jsx_runtime.jsx)("span",{children:"Single-use"})}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Create a new metric specific to this experiment."})]}),(0,jsx_runtime.jsxs)("div",{className:"flex-1 cursor-pointer p-4 rounded border hover:border-accent",onClick:()=>{closeCurrentModal(),openSharedMetricModal(null)},children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,jsx_runtime.jsx)("span",{children:"Shared"})}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Use a pre-configured metric that can be reused across experiments."})]})]})})}var ObjectTags=__webpack_require__("../../frontend/src/lib/components/ObjectTags/ObjectTags.tsx"),LemonTable=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/index.ts"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),components=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentView/components.tsx");function SharedMetricModal(_ref){let{experimentId,isSecondary}=_ref,{experiment,compatibleSharedMetrics,editingSharedMetricId,primaryMetricsLengthWithSharedMetrics,secondaryMetricsLengthWithSharedMetrics}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{addSharedMetricsToExperiment,removeSharedMetricFromExperiment,restoreUnmodifiedExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closePrimarySharedMetricModal,closeSecondarySharedMetricModal}=(0,index_esm.useActions)(modalsLogic.l),{isPrimarySharedMetricModalOpen,isSecondarySharedMetricModalOpen}=(0,index_esm.useValues)(modalsLogic.l),[selectedMetricIds,setSelectedMetricIds]=(0,react.useState)([]),mode=editingSharedMetricId?"edit":"create",{hasAvailableFeature}=(0,index_esm.useValues)(userLogic.userLogic);if(!compatibleSharedMetrics)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let onClose=()=>{restoreUnmodifiedExperiment(),isSecondary?closeSecondarySharedMetricModal():closePrimarySharedMetricModal()},availableSharedMetrics=compatibleSharedMetrics.filter(metric=>!experiment.saved_metrics.some(savedMetric=>savedMetric.saved_metric===metric.id)),availableTags=Array.from(new Set(availableSharedMetrics.filter(metric=>metric.tags).flatMap(metric=>metric.tags).filter(Boolean))).sort();return(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isSecondary?isSecondarySharedMetricModalOpen:isPrimarySharedMetricModalOpen,onClose:onClose,width:500,title:"create"===mode?"Select one or more shared metrics":"Shared metric",footer:(0,jsx_runtime.jsxs)("div",{className:"flex justify-between w-full",children:[(0,jsx_runtime.jsx)("div",{children:editingSharedMetricId&&(0,jsx_runtime.jsx)(src.Jp,{status:"danger",onClick:()=>{removeSharedMetricFromExperiment(editingSharedMetricId),isSecondary?closeSecondarySharedMetricModal():closePrimarySharedMetricModal()},type:"secondary",children:"Remove from experiment"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:onClose,type:"secondary",children:"Cancel"}),"create"===mode&&(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{addSharedMetricsToExperiment(selectedMetricIds,{type:isSecondary?"secondary":"primary"}),isSecondary?closeSecondarySharedMetricModal():closePrimarySharedMetricModal()},type:"primary",disabledReason:0===selectedMetricIds.length?"Please select at least one metric":!isSecondary&&primaryMetricsLengthWithSharedMetrics+selectedMetricIds.length>experiments_constants.C?`You can only add up to ${experiments_constants.C} primary metrics.`:isSecondary&&secondaryMetricsLengthWithSharedMetrics+selectedMetricIds.length>experiments_constants.Zy?`You can only add up to ${experiments_constants.Zy} secondary metrics.`:void 0,children:selectedMetricIds.length<2?"Add metric":"Add metrics"})]})]}),children:["create"===mode&&(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:availableSharedMetrics.length>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[experiment.saved_metrics.length>0&&(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:`Hiding ${experiment.saved_metrics.length} shared ${experiment.saved_metrics.length>1?"metrics":"metric"} already in use with this experiment.`}),hasAvailableFeature(types.P$.TAGGING)&&availableTags.length>0&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Quick select:"}),availableTags.map((tag,index)=>(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"secondary",onClick:()=>{setSelectedMetricIds(availableSharedMetrics.filter(metric=>metric.tags?.includes(tag)).map(metric=>metric.id))},children:tag},index))]}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:availableSharedMetrics,columns:[{title:"",key:"checkbox",render:(_,metric)=>(0,jsx_runtime.jsx)("input",{type:"checkbox",checked:selectedMetricIds.includes(metric.id),onChange:e=>{e.target.checked?setSelectedMetricIds([...selectedMetricIds,metric.id]):setSelectedMetricIds(selectedMetricIds.filter(id=>id!==metric.id))}})},{title:"Name",dataIndex:"name",key:"name"},{title:"Description",dataIndex:"description",key:"description"},...hasAvailableFeature(types.P$.TAGGING)?[{title:"Tags",dataIndex:"tags",key:"tags",render:(_,metric)=>(0,jsx_runtime.jsx)(ObjectTags.D,{tags:metric.tags||[],staticOnly:!0})}]:[],{title:"Type",key:"type",render:(_,metric)=>metric.query.kind===schema_general.OH.ExperimentMetric?metric.query.metric_type:metric.query.kind===schema_general.OH.ExperimentTrendsQuery?"Trend":"Funnel"}],footer:(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center m-2",children:(0,jsx_runtime.jsx)(src.Jp,{to:urls.j.experimentsSharedMetrics(),size:"xsmall",type:"tertiary",children:"See all shared metrics"})})})]}):(0,jsx_runtime.jsx)(src.Vp,{className:"w-full",type:"info",action:{children:"New shared metric",to:urls.j.experimentsSharedMetric("new")},children:compatibleSharedMetrics.length>0?"All of your shared metrics are already in this experiment.":"You don't have any shared metrics that match the experiment type. Shared metrics let you create reusable metrics that you can quickly add to any experiment."})}),editingSharedMetricId&&(0,jsx_runtime.jsx)("div",{children:(()=>{let metric=compatibleSharedMetrics.find(m=>m.id===editingSharedMetricId);return metric?(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold m-0 flex items-center",children:metric.name}),(0,jsx_runtime.jsx)(src.rU,{target:"_blank",className:"font-semibold flex items-center",to:urls.j.experimentsSharedMetric(metric.id),children:(0,jsx_runtime.jsx)(icons.pF,{fontSize:"18"})})]}),metric.description&&(0,jsx_runtime.jsx)("p",{className:"mt-2",children:metric.description}),"ExperimentTrendsQuery"===metric.query.kind&&(0,jsx_runtime.jsx)(components.EV,{query:metric.query.count_query}),"ExperimentFunnelsQuery"===metric.query.kind&&(0,jsx_runtime.jsx)(components.AG,{query:metric.query.funnels_query})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})})()})]})}var legacyExperimentCalculations=__webpack_require__("../../frontend/src/scenes/experiments/legacyExperimentCalculations.tsx");function AddPrimaryMetric(){let{primaryMetricsLengthWithSharedMetrics}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{openPrimaryMetricSourceModal}=(0,index_esm.useActions)(modalsLogic.l);return(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),type:"secondary",size:"xsmall",onClick:()=>{openPrimaryMetricSourceModal()},disabledReason:primaryMetricsLengthWithSharedMetrics>=experiments_constants.C?`You can only add up to ${experiments_constants.C} primary metrics.`:void 0,children:"Add primary metric"})}function AddSecondaryMetric(){let{secondaryMetricsLengthWithSharedMetrics}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{openSecondaryMetricSourceModal}=(0,index_esm.useActions)(modalsLogic.l);return(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),type:"secondary",size:"xsmall",onClick:()=>{openSecondaryMetricSourceModal()},disabledReason:secondaryMetricsLengthWithSharedMetrics>=experiments_constants.Zy?`You can only add up to ${experiments_constants.Zy} secondary metrics.`:void 0,children:"Add secondary metric"})}var shared_utils=__webpack_require__("../../frontend/src/scenes/experiments/MetricsView/shared/utils.ts"),lib_utils=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/utils.js");let ResultErrorCode=function(ResultErrorCode){return ResultErrorCode.NO_CONTROL_VARIANT="no-control-variant",ResultErrorCode.NO_TEST_VARIANT="no-test-variant",ResultErrorCode.NO_EXPOSURES="no-exposures",ResultErrorCode}({});function ErrorChecklist(_ref){let{error,metric}=_ref,{experiment,variants,getInsightType}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);if(!error)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let{statusCode,hasDiagnostics}=error;function ChecklistItem(_ref2){let{errorCode,value}=_ref2,failureText={[ResultErrorCode.NO_CONTROL_VARIANT]:"Events with the control variant not received",[ResultErrorCode.NO_TEST_VARIANT]:"Events with at least one test variant not received",[ResultErrorCode.NO_EXPOSURES]:"Exposure events not received"},successText={[ResultErrorCode.NO_CONTROL_VARIANT]:"Events with the control variant received",[ResultErrorCode.NO_TEST_VARIANT]:"Events with at least one test variant received",[ResultErrorCode.NO_EXPOSURES]:"Exposure events have been received"},insightType=getInsightType(metric),hasMissingExposure=errorCode===ResultErrorCode.NO_EXPOSURES,requiredEvent=insightType===types.dw.TRENDS?hasMissingExposure?metric.exposure_query?.series[0]?.event||"$feature_flag_called":metric.count_query?.series[0]?.event:metric.funnels_query?.series[0]?.event,query={kind:schema_general.OH.DataTableNode,full:!0,source:{kind:schema_general.OH.EventsQuery,select:["*","event",`properties."$feature/${experiment.feature_flag?.key}"`,"timestamp"],orderBy:["timestamp DESC"],after:experiment.start_date,event:requiredEvent,properties:[{key:`$feature/${experiment.feature_flag?.key}`,value:hasMissingExposure?variants.map(variant=>variant.key):errorCode===ResultErrorCode.NO_CONTROL_VARIANT?["control"]:variants.slice(1).map(variant=>variant.key),operator:"exact",type:"event"},...hasMissingExposure?[{key:"$feature_flag",value:[experiment.feature_flag?.key],operator:"exact",type:"event"}]:[]],filterTestAccounts:metric.count_query?.filter_test_accounts},propertiesViaUrl:!0,showPersistentColumnConfigurator:!0};return(0,jsx_runtime.jsx)("div",{className:"flex items-center deprecated-space-x-2",children:!1===value?(0,jsx_runtime.jsxs)("span",{className:"flex items-center deprecated-space-x-2",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCheck,{className:"text-success",fontSize:16}),(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:successText[errorCode]})]}):(0,jsx_runtime.jsxs)("span",{className:"flex items-center deprecated-space-x-2",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{className:"text-danger",fontSize:16}),(0,jsx_runtime.jsx)("span",{children:failureText[errorCode]}),(0,jsx_runtime.jsx)(src.u,{title:"Verify missing events in the Activity tab",children:(0,jsx_runtime.jsx)(src.rU,{target:"_blank",className:"font-semibold",to:(0,lib_utils.combineUrl)(urls.j.activity(types.ZO.ExploreEvents),{},{q:query}).url,children:(0,jsx_runtime.jsx)(icons.pF,{fontSize:"16",className:"-ml-1"})})})]})})}if(hasDiagnostics){let checklistItems=[];for(let[errorCode,value]of Object.entries(error.detail))Object.values(ResultErrorCode).includes(errorCode)&&checklistItems.push((0,jsx_runtime.jsx)(ChecklistItem,{errorCode:errorCode,value:value},errorCode));return(0,jsx_runtime.jsx)("div",{children:checklistItems})}return 504===statusCode?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("h2",{className:"text-xl font-semibold leading-tight",children:"Experiment results timed out"}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-center text-balance",children:"This may occur when the experiment has a large amount of data or is particularly complex. We are actively working on fixing this. In the meantime, please try refreshing the experiment to retrieve the results."})]}):(0,jsx_runtime.jsx)("div",{children:error.detail})}function ChartEmptyState(_ref){let{height,experimentStarted,hasMinimumExposure,error,metric}=_ref;return(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center w-full",style:{height:`${height}px`},children:experimentStarted?hasMinimumExposure?(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center text-secondary cursor-default text-[12px] font-normal",children:error?.hasDiagnostics?(0,jsx_runtime.jsx)(ErrorChecklist,{error:error,metric:metric}):(0,jsx_runtime.jsx)(src.u,{title:error?"string"==typeof error?error:error.message||error.detail||error.error||JSON.stringify(error):"An error occurred",children:(0,jsx_runtime.jsx)(src.oe,{size:"small",type:"danger",className:"mr-1 cursor-pointer",children:"Error"})})}):(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-center text-secondary cursor-default text-[12px] font-normal",children:[(0,jsx_runtime.jsx)(src.oe,{size:"small",className:"mr-2",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconActivity,{fontSize:"1em"})}),(0,jsx_runtime.jsxs)("span",{children:["Waiting for ",experiments_constants.Kn,"+ exposures to show results"]})]}):(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-center text-secondary cursor-default text-[12px] font-normal",children:[(0,jsx_runtime.jsx)(src.oe,{size:"small",className:"mr-2",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconClock,{fontSize:"1em"})}),(0,jsx_runtime.jsx)("span",{children:"Waiting for experiment to startâ¦"})]})})}var lemon_ui_Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/index.ts");function ChartLoadingState(_ref){let{height}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-center gap-2 text-[14px] font-normal",style:{height:`${height}px`},children:[(0,jsx_runtime.jsx)(lemon_ui_Spinner.$,{className:"text-lg"}),(0,jsx_runtime.jsx)("span",{children:"Loading resultsâ¦"})]})}var themeLogic=__webpack_require__("../../frontend/src/layout/navigation-3000/themeLogic.ts");function useChartColors(){let{isDarkModeOn}=(0,index_esm.useValues)(themeLogic.b);return{TICK_TEXT_COLOR:"var(--text-tertiary)",BOUNDARY_LINES:"var(--border-primary)",ZERO_LINE:"var(--border-bold)",BAR_NEGATIVE:isDarkModeOn?"#c32f45":"#f84257",BAR_POSITIVE:isDarkModeOn?"#12a461":"#36cd6f",BAR_DEFAULT:isDarkModeOn?"rgb(121 121 121)":"rgb(217 217 217)",BAR_CONTROL:isDarkModeOn?"rgba(217, 217, 217, 0.2)":"rgba(217, 217, 217, 0.4)",BAR_MIDDLE_POINT:"black",BAR_MIDDLE_POINT_CONTROL:"rgba(0, 0, 0, 0.4)"}}let COLORS={TICK_TEXT_COLOR:"var(--text-tertiary)",BOUNDARY_LINES:"var(--border-primary)",ZERO_LINE:"var(--border-bold)"};function GridLines(_ref){let{tickValues,valueToX,height}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:tickValues.map(value=>{let x=valueToX(value);return(0,jsx_runtime.jsx)("line",{x1:x,y1:0,x2:x,y2:height,stroke:0===value?COLORS.ZERO_LINE:COLORS.BOUNDARY_LINES,strokeWidth:0===value?1:.5},value)})})}let MetricTitle=_ref=>{let{metric,metricType}=_ref,getTextClassName=text=>text.includes(" ")?"break-words":"truncate",shouldShowTooltip=text=>!text.includes(" ")&&text.length>15,wrapWithTooltip=(text,element)=>shouldShowTooltip(text)?(0,jsx_runtime.jsx)(src.u,{title:text,children:element}):element;if(metric.name){let element=(0,jsx_runtime.jsx)("span",{className:getTextClassName(metric.name),children:metric.name});return wrapWithTooltip(metric.name,element)}if(metric.kind===schema_general.OH.ExperimentMetric){let title=(0,shared_utils.vD)(metric),element=(0,jsx_runtime.jsx)("span",{className:getTextClassName(title),children:title});return wrapWithTooltip(title,element)}if(metricType===types.dw.TRENDS&&metric.count_query?.series?.[0]?.name){let name=metric.count_query.series[0].name,element=(0,jsx_runtime.jsx)("span",{className:getTextClassName(name),children:name});return wrapWithTooltip(name,element)}if(metricType===types.dw.FUNNELS&&metric.funnels_query?.series){let series=metric.funnels_query.series;if(series.length>0){let firstStep=series[0]?.name,lastStep=series[series.length-1]?.name;return(0,jsx_runtime.jsxs)("div",{className:"inline-flex flex-wrap items-center gap-1 min-w-0",children:[(0,jsx_runtime.jsxs)("div",{className:"inline-flex items-center gap-1 min-w-0",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconFunnels,{className:"text-secondary flex-shrink-0",fontSize:"14"}),wrapWithTooltip(firstStep,(0,jsx_runtime.jsx)("span",{className:getTextClassName(firstStep),children:firstStep}))]}),(0,jsx_runtime.jsxs)("div",{className:"inline-flex items-center gap-1 min-w-0 @max-[200px]:ml-5",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconArrowRight,{className:"text-secondary flex-shrink-0",fontSize:"14"}),wrapWithTooltip(lastStep,(0,jsx_runtime.jsx)("span",{className:getTextClassName(lastStep),children:lastStep}))]})]})}}return(0,jsx_runtime.jsx)("span",{className:"text-secondary break-words",children:"Untitled metric"})},MetricHeader=_ref=>{let{metricIndex,metric,metricType,isPrimaryMetric,canDuplicateMetric=!0,onDuplicateMetricClick}=_ref,{openPrimaryMetricModal,openSecondaryMetricModal,openPrimarySharedMetricModal,openSecondarySharedMetricModal}=(0,index_esm.useActions)(modalsLogic.l);return(0,jsx_runtime.jsx)("div",{className:"text-xs font-semibold",children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-1",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"text-xs font-semibold flex-grow flex items-start min-w-0",children:[(0,jsx_runtime.jsxs)("span",{className:"mr-1 flex-shrink-0",children:[metricIndex+1,"."]}),(0,jsx_runtime.jsx)(MetricTitle,{metric:metric,metricType:metricType})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-1",children:[(0,jsx_runtime.jsx)(src.Jp,{className:"flex-shrink-0",type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{fontSize:"12"}),tooltip:"Edit",onClick:()=>{(isPrimaryMetric?metric.isSharedMetric?openPrimarySharedMetricModal:openPrimaryMetricModal:metric.isSharedMetric?openSecondarySharedMetricModal:openSecondaryMetricModal)(metric.isSharedMetric?metric.sharedMetricId:metricIndex)}}),(0,jsx_runtime.jsx)(src.Jp,{className:"flex-shrink-0",type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconCopy,{fontSize:"12"}),tooltip:"Duplicate",disabledReason:canDuplicateMetric?void 0:`You can only have up to ${isPrimaryMetric?experiments_constants.C:experiments_constants.Zy} ${isPrimaryMetric?"primary":"secondary"} metrics.`,onClick:()=>{if(metric.isSharedMetric){src.dn.open({title:"Duplicate this shared metric?",content:(0,jsx_runtime.jsx)("div",{className:"text-sm text-secondary max-w-lg",children:(0,jsx_runtime.jsx)("p",{children:"We'll take you to the form to customize and save this metric. Your new version will appear in your shared metrics, ready to add to your experiment."})}),primaryButton:{children:"Duplicate metric",to:urls.j.experimentsSharedMetric(metric.sharedMetricId,"duplicate"),type:"primary",size:"small"},secondaryButton:{children:"Cancel",type:"tertiary",size:"small"}});return}onDuplicateMetricClick(metric)}})]})]}),(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-x-1",children:[(0,jsx_runtime.jsx)(src.oe,{type:"muted",size:"small",children:(0,shared_utils.Xj)(metric)}),metric.isSharedMetric&&(0,jsx_runtime.jsx)(src.oe,{type:"option",size:"small",children:"Shared"})]})]})})};function WinningVariantText(_ref){let{result,experimentId}=_ref,{getInsightType,experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),highestProbabilityVariant=(0,legacyExperimentCalculations.jl)(result),index=(0,legacyExperimentCalculations.SP)(result,highestProbabilityVariant||"",getInsightType(experiment.metrics[0]));if(highestProbabilityVariant&&null!==index&&result){let{probability}=result;return(0,jsx_runtime.jsxs)("div",{className:"items-center inline-flex flex-wrap",children:[(0,jsx_runtime.jsx)(components.Aw,{experimentId:experimentId,variantKey:highestProbabilityVariant}),(0,jsx_runtime.jsx)("span",{children:"Â is winning with aÂ "}),(0,jsx_runtime.jsxs)("span",{className:"font-semibold items-center",children:[`${(100*probability[highestProbabilityVariant]).toFixed(2)}% probability`,"Â "]}),(0,jsx_runtime.jsx)("span",{children:"of being best.Â "})]})}return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})}function SignificanceText(_ref2){let{metricIndex,isSecondary=!1}=_ref2,{isPrimaryMetricSignificant,isSecondaryMetricSignificant}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);return(0,jsx_runtime.jsxs)("div",{className:"flex-wrap",children:[(0,jsx_runtime.jsx)("span",{children:"Your results areÂ "}),(0,jsx_runtime.jsxs)("span",{className:"font-semibold",children:[`${(isSecondary?isSecondaryMetricSignificant(metricIndex):isPrimaryMetricSignificant(metricIndex))?"significant":"not significant"}`,"."]})]})}function Overview(_ref3){let{metricIndex=0}=_ref3,{experimentId,legacyPrimaryMetricsResults}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),result=legacyPrimaryMetricsResults?.[metricIndex];return result?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)("div",{className:"items-center inline-flex flex-wrap",children:[(0,jsx_runtime.jsx)(WinningVariantText,{result:result,experimentId:experimentId}),(0,jsx_runtime.jsx)(SignificanceText,{metricIndex:metricIndex})]})}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})}var SummaryTable=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentView/SummaryTable.tsx");function ChartModal(_ref){let{isOpen,onClose,metric,metricIndex,isSecondary,result,experimentId,experiment}=_ref,isLegacyResult=result&&(result.kind===schema_general.OH.ExperimentTrendsQuery||result.kind===schema_general.OH.ExperimentFunnelsQuery);return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:onClose,width:1200,title:`Metric results: ${metric.name||"Untitled metric"}`,footer:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:onClose,children:"Close"}),children:isLegacyResult?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(components.bD,{result:result})}),(0,jsx_runtime.jsx)(src.Vp,{type:result?.significant?"success":"info",className:"mb-4",children:(0,jsx_runtime.jsxs)("div",{className:"items-center inline-flex flex-wrap",children:[(0,jsx_runtime.jsx)(WinningVariantText,{result:result,experimentId:experimentId}),(0,jsx_runtime.jsx)(SignificanceText,{metricIndex:metricIndex,isSecondary:isSecondary})]})}),(0,jsx_runtime.jsx)(SummaryTable.H,{metric:metric,metricIndex:metricIndex,isSecondary:isSecondary}),(0,jsx_runtime.jsx)(components.TX,{result:result,showTable:!0})]}):(0,jsx_runtime.jsx)(ResultsBreakdown,{result:result,experiment:experiment,metricIndex:metricIndex,isPrimary:!isSecondary,children:_ref2=>{let{query,breakdownResults,breakdownResultsLoading,exposureDifference}=_ref2;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[query&&(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(ExploreAsInsightButton,{query:query})}),(0,jsx_runtime.jsx)(src.Vp,{type:result?.significant?"success":"info",className:"mb-4",children:(0,jsx_runtime.jsxs)("div",{className:"items-center inline-flex flex-wrap",children:[(0,jsx_runtime.jsx)(WinningVariantText,{result:result,experimentId:experimentId}),(0,jsx_runtime.jsx)(SignificanceText,{metricIndex:metricIndex,isSecondary:isSecondary})]})}),(0,jsx_runtime.jsx)(SummaryTable.H,{metric:metric,metricIndex:metricIndex,isSecondary:isSecondary}),breakdownResultsLoading&&(0,jsx_runtime.jsx)(ResultsBreakdownSkeleton,{}),query&&breakdownResults&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ResultsInsightInfoBanner,{exposureDifference:exposureDifference}),(0,jsx_runtime.jsx)(ResultsQuery,{query:query,breakdownResults:breakdownResults})]})]})}})})}function useSvgResizeObserver(){let deps=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],ticksSvgRef=(0,react.useRef)(null),chartSvgRef=(0,react.useRef)(null),[ticksSvgHeight,setTicksSvgHeight]=(0,react.useState)(0),[chartSvgHeight,setChartSvgHeight]=(0,react.useState)(0);return(0,react.useEffect)(()=>{let ticksSvg=ticksSvgRef.current,chartSvg=chartSvgRef.current,resizeObserver=new ResizeObserver(entries=>{for(let entry of entries)entry.target===ticksSvg?setTicksSvgHeight(entry.contentRect.height):entry.target===chartSvg&&setChartSvgHeight(entry.contentRect.height)});return ticksSvg&&resizeObserver.observe(ticksSvg),chartSvg&&resizeObserver.observe(chartSvg),()=>{resizeObserver.disconnect()}},deps),{ticksSvgRef,chartSvgRef,ticksSvgHeight,chartSvgHeight}}function TickPanel(_ref){let{tickValues,valueToX,viewBoxWidth,tickPanelHeight,svgRef}=_ref;return(0,jsx_runtime.jsx)("svg",{ref:svgRef,viewBox:`0 0 ${viewBoxWidth} ${tickPanelHeight}`,preserveAspectRatio:"xMidYMid meet",className:"ml-12 max-w-[1000px]",style:{minHeight:`${tickPanelHeight}px`},children:tickValues.map(value=>{let x=valueToX(value);return(0,jsx_runtime.jsx)("g",{children:(0,jsx_runtime.jsx)("text",{x:x,y:tickPanelHeight/2,textAnchor:"middle",dominantBaseline:"middle",fontSize:9,fill:COLORS.TICK_TEXT_COLOR,fontWeight:"600",children:(0,shared_utils.wo)(value)})},value)})})}function MetricsChartLayout(_ref){let{isFirstMetric,tickValues,chartBound,metricTitlePanel,chartContent,viewBoxWidth=800,horizontalPadding=20,tickPanelHeight=20}=_ref,{ticksSvgRef,chartSvgRef,ticksSvgHeight,chartSvgHeight}=useSvgResizeObserver([tickValues,chartBound]),metricTitlePanelHeight=Math.max(chartSvgHeight,80);return(0,jsx_runtime.jsx)("div",{className:"rounded bg-[var(--bg-table)]",children:(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsxs)("div",{className:"w-1/5 border-r border-primary",children:[isFirstMetric&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{style:{height:`${ticksSvgHeight}px`}}),(0,jsx_runtime.jsx)("div",{className:"w-full border-t border-primary"})]}),(0,jsx_runtime.jsx)("div",{className:"p-2",style:{height:`${metricTitlePanelHeight}px`},children:metricTitlePanel})]}),(0,jsx_runtime.jsxs)("div",{className:"w-4/5 min-w-[780px]",children:[isFirstMetric&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:(0,jsx_runtime.jsx)(TickPanel,{svgRef:ticksSvgRef,tickValues:tickValues,valueToX:value=>(0,shared_utils.wq)(value,chartBound,viewBoxWidth,horizontalPadding),viewBoxWidth:viewBoxWidth,tickPanelHeight:tickPanelHeight})}),(0,jsx_runtime.jsx)("div",{className:"w-full border-t border-primary"})]}),(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:"function"==typeof chartContent?chartContent(chartSvgRef):chartContent})]})]})})}var clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js");function SignificanceHighlight(_ref){let{metricIndex=0,isSecondary=!1,className=""}=_ref,{isPrimaryMetricSignificant,isSecondaryMetricSignificant,significanceDetails}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),isSignificant=isSecondary?isSecondaryMetricSignificant(metricIndex):isPrimaryMetricSignificant(metricIndex),result=isSignificant?{color:"success",label:"Significant"}:{color:"primary",label:"Not significant"},inner=isSignificant?(0,jsx_runtime.jsxs)("div",{className:"bg-success-highlight text-success-light px-1.5 py-0.5 flex items-center gap-1 rounded border border-success-light",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconTrending,{fontSize:20,fontWeight:600}),(0,jsx_runtime.jsx)("span",{className:"text-xs font-semibold",children:result.label})]}):(0,jsx_runtime.jsxs)("div",{className:"bg-warning-highlight text-warning-dark px-1.5 py-0.5 flex items-center gap-1 rounded border border-warning",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconMinus,{fontSize:20,fontWeight:600}),(0,jsx_runtime.jsx)("span",{className:"text-xs font-semibold",children:result.label})]}),details=significanceDetails(metricIndex);return details?(0,jsx_runtime.jsx)(src.u,{title:details,children:(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)({"cursor-default":!0,"bg-[var(--bg-table)]":!0,[className]:!0}),children:inner})}):(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)({"bg-[var(--bg-table)]":!0,[className]:!0}),children:inner})}var LemonProgress=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonProgress/index.tsx");function VariantTooltip(_ref){let{tooltipData,experimentId,result,metricType,conversionRateForVariant,countDataForVariant,exposureCountDataForVariant,credibleIntervalForVariant}=_ref;return(0,jsx_runtime.jsx)("div",{className:"fixed -translate-x-1/2 -translate-y-full bg-[var(--bg-surface-primary)] border border-[var(--border-primary)] px-3 py-2 rounded-md text-[13px] shadow-md pointer-events-none z-[103] min-w-[300px]",style:{left:tooltipData.x,top:tooltipData.y},children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)(components.Aw,{experimentId:experimentId,variantKey:tooltipData.variant}),(0,jsx_runtime.jsxs)("div",{className:"inline-flex",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold mb-1",children:"Win probability:"}),result?.probability?.[tooltipData.variant]!==void 0?(0,jsx_runtime.jsxs)("span",{className:"flex items-center justify-between flex-1 pl-6",children:[(0,jsx_runtime.jsx)(LemonProgress.b,{className:"w-3/4 mr-4",percent:100*result.probability[tooltipData.variant]}),(0,jsx_runtime.jsxs)("span",{className:"font-semibold",children:[(100*result.probability[tooltipData.variant]).toFixed(2),"%"]})]}):(0,jsx_runtime.jsx)("span",{children:"â"})]}),metricType===types.dw.TRENDS?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsxs)("span",{className:"text-secondary font-semibold",children:[metricType===types.dw.TRENDS&&result.exposure_query?.series?.[0]?.math?(0,jsx_runtime.jsx)("span",{children:"Total"}):(0,jsx_runtime.jsx)("span",{children:"Count"}),(0,jsx_runtime.jsx)("span",{children:":"})]}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(()=>{let count=countDataForVariant(result,tooltipData.variant);return null!==count?(0,utils.Lc)(count):(0,jsx_runtime.jsx)("span",{children:"â"})})()})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Exposure:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(()=>{let exposure=exposureCountDataForVariant(result,tooltipData.variant);return null!==exposure?(0,utils.Lc)(exposure):"â"})()})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Mean:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(()=>{let variant=result.variants.find(v=>v.key===tooltipData.variant);return variant?.count&&variant?.absolute_exposure?(variant.count/variant.absolute_exposure).toFixed(2):"â"})()})]})]}):(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Conversion rate:"}),(0,jsx_runtime.jsxs)("span",{className:"font-semibold",children:[conversionRateForVariant(result,tooltipData.variant)?.toFixed(2),"%"]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Delta:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"control"===tooltipData.variant?(0,jsx_runtime.jsx)("em",{className:"text-secondary",children:"Baseline"}):(()=>{let deltaResult=(0,legacyExperimentCalculations.YD)(result,tooltipData.variant,metricType);return deltaResult?(0,jsx_runtime.jsx)("span",{className:deltaResult.isPositive?"text-success":"text-danger",children:`${deltaResult.isPositive?"+":""}${deltaResult.deltaPercent.toFixed(2)}%`}):"â"})()})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Credible interval:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(()=>{let interval=credibleIntervalForVariant(result,tooltipData.variant,metricType),[lower,upper]=interval?[interval[0]/100,interval[1]/100]:[0,0];return`[${lower>0?"+":""}${(100*lower).toFixed(2)}%, ${upper>0?"+":""}${(100*upper).toFixed(2)}%]`})()})]})]})})}function generateViolinPath(x1,x2,y,height,deltaX){let points=[],maxWidth=height/2;for(let i=0;i<=20;i++){let t=i/20,x=x1+(deltaX-x1)*t,z=(t-1)*2,width=Math.exp(-.5*z*z)*maxWidth;points.push([x,y+height/2-width])}for(let i=0;i<=20;i++){let t=i/20,x=deltaX+(x2-deltaX)*t,z=2*t,width=Math.exp(-.5*z*z)*maxWidth;points.push([x,y+height/2-width])}for(let i=20;i>=0;i--){let t=i/20,x=deltaX+(x2-deltaX)*t,z=2*t,width=Math.exp(-.5*z*z)*maxWidth;points.push([x,y+height/2+width])}for(let i=20;i>=0;i--){let t=i/20,x=x1+(deltaX-x1)*t,z=(t-1)*2,width=Math.exp(-.5*z*z)*maxWidth;points.push([x,y+height/2+width])}return`
        M ${points[0][0]} ${points[0][1]}
        ${points.map(point=>`L ${point[0]} ${point[1]}`).join(" ")}
        Z
    `}let DeltaChartContext=(0,react.createContext)(null);function useDeltaChartContext(){let context=(0,react.useContext)(DeltaChartContext);if(!context)throw Error("useDeltaChartContext must be used within a DeltaChartContextProvider");return context}function useChartDimensions(variants){var variantCount;let scaleAddition=(variantCount=variants.length)<3?6:variantCount<4?3:+(variantCount<5),barHeight=10+scaleAddition,barPadding=10+scaleAddition,chartHeight=barPadding+(barHeight+barPadding)*variants.length;return{barHeight,barPadding,viewBoxWidth:800,horizontalPadding:20,chartHeight}}function hasEnoughDataForResults(variantExposureCount,variantMetricValue){return variantExposureCount>=experiments_constants.Kn&&variantMetricValue>experiments_constants.GI}function VariantBar(_ref){let hasEnoughData,{variant,index}=_ref,{result,metricType,dimensions,valueToX,experimentId,featureFlags,colors,tooltip:{setTooltipData},credibleIntervalForVariant,metricIndex,isSecondary,openVariantDeltaTimeseriesModal}=useDeltaChartContext(),{barHeight,barPadding}=dimensions,interval=credibleIntervalForVariant(result,variant.key,metricType),[lower,upper]=interval?[interval[0]/100,interval[1]/100]:[0,0],deltaResult=(0,legacyExperimentCalculations.YD)(result,variant.key,metricType),delta=deltaResult?.delta||0;if(metricType===types.dw.TRENDS){let controlVariant=result.variants.find(v=>"control"===v.key),variantData=result.variants.find(v=>v.key===variant.key);hasEnoughData=!!(variantData?.count&&variantData?.absolute_exposure&&controlVariant?.count&&controlVariant?.absolute_exposure)&&hasEnoughDataForResults(variantData.absolute_exposure,variantData.count)}else{let variantData=result.variants.find(v=>v.key===variant.key);hasEnoughData=!!variantData&&hasEnoughDataForResults(variantData.failure_count+variantData.success_count,variantData.success_count)}let y=barPadding+(barHeight+barPadding)*index,x1=valueToX(lower),x2=valueToX(upper),deltaX=valueToX(delta);return(0,jsx_runtime.jsx)("g",{onMouseEnter:e=>{let rect=e.currentTarget.getBoundingClientRect();setTooltipData({x:rect.left+rect.width/2,y:rect.top-10,variant:variant.key})},onMouseLeave:()=>setTooltipData(null),onClick:()=>{featureFlags[constants.y8.EXPERIMENT_INTERVAL_TIMESERIES]&&openVariantDeltaTimeseriesModal()},className:featureFlags[constants.y8.EXPERIMENT_INTERVAL_TIMESERIES]?"cursor-pointer":"",children:hasEnoughData?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("foreignObject",{x:x1-8,y:y+barHeight/2-10,width:"90",height:"16",transform:"translate(-90, 0)",children:(0,jsx_runtime.jsx)(components.Aw,{className:"justify-end mt-0.5",experimentId:experimentId,variantKey:variant.key,fontSize:10,muted:!0})}),"control"===variant.key?(0,jsx_runtime.jsx)("path",{d:generateViolinPath(x1,x2,y,barHeight,deltaX),fill:colors.BAR_CONTROL,stroke:colors.BOUNDARY_LINES,strokeWidth:1,strokeDasharray:"2,2"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("defs",{children:(0,jsx_runtime.jsx)("linearGradient",{id:`gradient-${metricIndex}-${variant.key}-${isSecondary?"secondary":"primary"}`,x1:"0",x2:"1",y1:"0",y2:"0",children:lower<0&&upper>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("stop",{offset:"0%",stopColor:colors.BAR_NEGATIVE}),(0,jsx_runtime.jsx)("stop",{offset:`${-lower/(upper-lower)*100}%`,stopColor:colors.BAR_NEGATIVE}),(0,jsx_runtime.jsx)("stop",{offset:`${-lower/(upper-lower)*100}%`,stopColor:colors.BAR_POSITIVE}),(0,jsx_runtime.jsx)("stop",{offset:"100%",stopColor:colors.BAR_POSITIVE})]}):(0,jsx_runtime.jsx)("stop",{offset:"100%",stopColor:upper<=0?colors.BAR_NEGATIVE:colors.BAR_POSITIVE})})}),(0,jsx_runtime.jsx)("path",{d:generateViolinPath(x1,x2,y,barHeight,deltaX),fill:`url(#gradient-${metricIndex}-${variant.key}-${isSecondary?"secondary":"primary"})`})]}),(0,jsx_runtime.jsx)("g",{transform:`translate(${deltaX}, 0)`,children:(0,jsx_runtime.jsx)("line",{x1:0,y1:y,x2:0,y2:y+barHeight,stroke:"control"===variant.key?colors.BAR_MIDDLE_POINT_CONTROL:colors.BAR_MIDDLE_POINT,strokeWidth:2,vectorEffect:"non-scaling-stroke",shapeRendering:"crispEdges"})})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("foreignObject",{x:valueToX(0)-150,y:y+barHeight/2-10,width:"90",height:"16",children:(0,jsx_runtime.jsx)(components.Aw,{className:"justify-end mt-0.5",experimentId:experimentId,variantKey:variant.key,fontSize:10,muted:!0})}),(0,jsx_runtime.jsx)("rect",{x:valueToX(0)-50,y:y+barHeight/2-8,width:"100",height:"16",rx:"3",ry:"3",fill:"var(--bg-light)"}),(0,jsx_runtime.jsx)("rect",{x:valueToX(0)-50,y:y+barHeight/2-8,width:"100",height:"16",rx:"3",ry:"3",fill:"var(--border-light)",strokeWidth:"0"}),(0,jsx_runtime.jsx)("text",{x:valueToX(0),y:y+barHeight/2,fontSize:"10",textAnchor:"middle",dominantBaseline:"middle",fill:"var(--muted)",children:"Not enough data yet"})]})},variant.key)}function ChartSVG(_ref2){let{chartSvgRef}=_ref2,{dimensions,tickValues,valueToX,variants}=useDeltaChartContext(),{viewBoxWidth,chartHeight}=dimensions;return(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:(0,jsx_runtime.jsxs)("svg",{ref:chartSvgRef,viewBox:`0 0 ${viewBoxWidth} ${chartHeight}`,preserveAspectRatio:"xMidYMid meet",className:"ml-12 max-w-[1000px]",style:{minHeight:`${chartHeight}px`},children:[(0,jsx_runtime.jsx)("g",{className:"grid-lines-layer",children:(0,jsx_runtime.jsx)(GridLines,{tickValues:tickValues,valueToX:valueToX,height:chartHeight})}),(0,jsx_runtime.jsx)("g",{className:"variant-bars-layer",children:variants.map((variant,index)=>(0,jsx_runtime.jsx)(VariantBar,{variant:variant,index:index},variant.key))})]})})}function ChartControls(){let{metricIndex,isSecondary,primaryMetricsLengthWithSharedMetrics,setIsModalOpen}=useDeltaChartContext();return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"absolute top-2 left-2 z-[102]",children:(0,jsx_runtime.jsx)(SignificanceHighlight,{metricIndex:metricIndex,isSecondary:isSecondary})}),(isSecondary||!isSecondary&&primaryMetricsLengthWithSharedMetrics>1)&&(0,jsx_runtime.jsx)("div",{className:"absolute bottom-2 left-2 flex justify-center bg-[var(--bg-table)] z-[101]",children:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGraph,{}),onClick:()=>setIsModalOpen(!0),children:"Details"})})]})}function ChartTooltips(){let{tooltip:{tooltipData},experimentId,result,metricType,conversionRateForVariant,countDataForVariant,exposureCountDataForVariant,credibleIntervalForVariant}=useDeltaChartContext();return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:tooltipData&&(0,jsx_runtime.jsx)(VariantTooltip,{tooltipData:tooltipData,experimentId:experimentId,result:result,metricType:metricType,conversionRateForVariant:conversionRateForVariant,countDataForVariant:countDataForVariant,exposureCountDataForVariant:exposureCountDataForVariant,credibleIntervalForVariant:credibleIntervalForVariant})})}function DeltaChartContent(_ref3){let{chartSvgRef}=_ref3,{result,metric,hasMinimumExposureForResults,resultsLoading,experiment,error,dimensions}=useDeltaChartContext(),{chartHeight}=dimensions;return result&&hasMinimumExposureForResults?(0,jsx_runtime.jsxs)("div",{className:"relative w-full max-w-screen",children:[(0,jsx_runtime.jsx)(ChartControls,{}),(0,jsx_runtime.jsx)(ChartSVG,{chartSvgRef:chartSvgRef}),(0,jsx_runtime.jsx)(ChartTooltips,{})]}):resultsLoading?(0,jsx_runtime.jsx)(ChartLoadingState,{height:chartHeight}):(0,jsx_runtime.jsx)("div",{className:"relative w-full max-w-screen",children:(0,jsx_runtime.jsx)(ChartEmptyState,{height:chartHeight,experimentStarted:!!experiment.start_date,hasMinimumExposure:hasMinimumExposureForResults,metric:metric,error:error})})}function DeltaChart(_ref4){let{isSecondary,result,error,variants,metricType,metricIndex,isFirstMetric,metric,tickValues,chartBound}=_ref4,{experimentId,experiment,primaryMetricsResultsLoading,secondaryMetricsResultsLoading,featureFlags,primaryMetricsLengthWithSharedMetrics,hasMinimumExposureForResults,secondaryMetricsLengthWithSharedMetrics}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{duplicateMetric,updateExperimentMetrics}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{openVariantDeltaTimeseriesModal}=(0,index_esm.useActions)(modalsLogic.l),resultsLoading=isSecondary?secondaryMetricsResultsLoading:primaryMetricsResultsLoading,dimensions=useChartDimensions(variants),{viewBoxWidth:VIEW_BOX_WIDTH,horizontalPadding:HORIZONTAL_PADDING}=dimensions,colors=useChartColors(),[isModalOpen,setIsModalOpen]=(0,react.useState)(!1),[tooltipData,setTooltipData]=(0,react.useState)(null),[emptyStateTooltipVisible,setEmptyStateTooltipVisible]=(0,react.useState)(!1),[tooltipPosition,setTooltipPosition]=(0,react.useState)({x:0,y:0}),metricTitlePanel=(0,jsx_runtime.jsx)(MetricHeader,{metricIndex:metricIndex,metric:metric,metricType:metricType,isPrimaryMetric:!isSecondary,canDuplicateMetric:isSecondary?secondaryMetricsLengthWithSharedMetrics<experiments_constants.Zy:primaryMetricsLengthWithSharedMetrics<experiments_constants.C,onDuplicateMetricClick:()=>{duplicateMetric({metricIndex,isSecondary}),updateExperimentMetrics()}}),contextValue={result,error,metricIndex,isSecondary,metricType,metric,tickValues,chartBound,experimentId:experimentId,experiment,variants,hasMinimumExposureForResults,featureFlags,primaryMetricsLengthWithSharedMetrics,valueToX:value=>HORIZONTAL_PADDING+(value/chartBound+1)/2*(VIEW_BOX_WIDTH-2*HORIZONTAL_PADDING),credibleIntervalForVariant:legacyExperimentCalculations.fv,conversionRateForVariant:legacyExperimentCalculations.Wd,countDataForVariant:legacyExperimentCalculations.PZ,exposureCountDataForVariant:legacyExperimentCalculations.MB,dimensions,isModalOpen,setIsModalOpen,resultsLoading,openVariantDeltaTimeseriesModal,colors,tooltip:{tooltipData,setTooltipData,emptyStateTooltipVisible,setEmptyStateTooltipVisible,tooltipPosition,setTooltipPosition}};return(0,jsx_runtime.jsxs)(DeltaChartContext.Provider,{value:contextValue,children:[(0,jsx_runtime.jsx)(MetricsChartLayout,{isFirstMetric:isFirstMetric,tickValues:tickValues,chartBound:chartBound,metricTitlePanel:metricTitlePanel,chartContent:chartSvgRef=>(0,jsx_runtime.jsx)(DeltaChartContent,{chartSvgRef:chartSvgRef}),viewBoxWidth:VIEW_BOX_WIDTH,horizontalPadding:HORIZONTAL_PADDING}),(0,jsx_runtime.jsx)(ChartModal,{isOpen:isModalOpen,onClose:()=>setIsModalOpen(!1),metric:metric,metricIndex:metricIndex,isSecondary:isSecondary,result:result,experimentId:experimentId,experiment:experiment})]})}function MetricsViewLegacy(_ref){let{isSecondary}=_ref,{experiment,getInsightType,legacyPrimaryMetricsResults,legacySecondaryMetricsResults,primaryMetricsResultsErrors,secondaryMetricsResultsErrors}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),variants=experiment?.feature_flag?.filters?.multivariate?.variants;if(!variants)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let results=isSecondary?legacySecondaryMetricsResults:legacyPrimaryMetricsResults,errors=isSecondary?secondaryMetricsResultsErrors:primaryMetricsResultsErrors,hasSomeResults=results?.some(result=>result?.insight),metrics=isSecondary?experiment.metrics_secondary:experiment.metrics,sharedMetrics=experiment.saved_metrics.filter(sharedMetric=>sharedMetric.metadata.type===(isSecondary?"secondary":"primary")).map(sharedMetric=>({...sharedMetric.query,name:sharedMetric.name,sharedMetricId:sharedMetric.saved_metric,isSharedMetric:!0}));sharedMetrics&&(metrics=[...metrics,...sharedMetrics]);let maxAbsValue=Math.max(...metrics.flatMap((metric,metricIndex)=>{let result=results?.[metricIndex];return result?variants.flatMap(variant=>{let insightType=getInsightType(metric),interval=(0,legacyExperimentCalculations.fv)(result,variant.key,insightType);return interval?[Math.abs(interval[0]/100),Math.abs(interval[1]/100)]:[]}):[]})),padding=Math.max(.05*maxAbsValue,.1),chartBound=maxAbsValue+padding,commonTickValues=(0,shared_utils.Zj)(chartBound);return(0,jsx_runtime.jsxs)("div",{className:"mb-4 -mt-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/2 pt-5",children:(0,jsx_runtime.jsxs)("div",{className:"inline-flex items-center deprecated-space-x-2 mb-0",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0 font-semibold text-lg leading-6",children:isSecondary?"Secondary metrics":"Primary metrics"}),metrics.length>0&&(0,jsx_runtime.jsx)(src.u,{title:isSecondary?"Secondary metrics capture additional outcomes or behaviors affected by your experiment. They help you understand broader impacts and potential side effects beyond the primary goal.":"Primary metrics represent the main goal of your experiment. They directly measure whether your hypothesis was successful and are the key factor in deciding if the test achieved its primary objective.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-lg"})}),hasSomeResults&&!isSecondary&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.p2,{vertical:!0,className:"mx-2"}),(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)("div",{className:"p-2",children:[(0,jsx_runtime.jsxs)("p",{className:"mb-4",children:["Each bar shows how a variant is performing compared to the control (the gray bar) for this metric, using a"," ",(0,jsx_runtime.jsx)("strong",{children:"95% credible interval."}),' That means there\'s a 95% chance the true difference for that variant falls within this range. The vertical "0%" line is your baseline:']}),(0,jsx_runtime.jsxs)("ul",{className:"mb-4 list-disc pl-4",children:[(0,jsx_runtime.jsxs)("li",{children:[(0,jsx_runtime.jsx)("strong",{children:"To the right (green):"})," The metric is higher (an improvement)."]}),(0,jsx_runtime.jsxs)("li",{children:[(0,jsx_runtime.jsx)("strong",{children:"To the left (red):"})," The metric is lower (a decrease)."]})]}),(0,jsx_runtime.jsx)("p",{className:"mb-4",children:"The shape of each bar represents the probability distribution. The true value is more likely to be near the center (where the bar is wider) than at the edges (where it tapers off)."}),(0,jsx_runtime.jsx)("p",{className:"mb-4",children:"The control (baseline) is always shown in gray. Other bars will be green or redâor even a mixâdepending on whether the change is positive or negative."}),(0,jsx_runtime.jsx)("img",{src:"https://res.cloudinary.com/dmukukwp6/image/upload/violin_plot_screenshot_acca775d36.png",width:700,className:"rounded border object-contain",alt:"How to read metrics"})]}),children:(0,jsx_runtime.jsx)("span",{className:"text-xs text-secondary cursor-help",children:"How to read"})})]})]})}),(0,jsx_runtime.jsx)("div",{className:"w-1/2 flex flex-col justify-end",children:(0,jsx_runtime.jsx)("div",{className:"ml-auto",children:metrics.length>0&&(0,jsx_runtime.jsx)("div",{className:"mb-2 mt-4 justify-end",children:isSecondary?(0,jsx_runtime.jsx)(AddSecondaryMetric,{}):(0,jsx_runtime.jsx)(AddPrimaryMetric,{})})})})]}),metrics.length>0?(0,jsx_runtime.jsx)("div",{className:"w-full overflow-x-auto",children:(0,jsx_runtime.jsx)("div",{className:"min-w-[1000px]",children:metrics.map((metric,metricIndex)=>{let result=results?.[metricIndex],isFirstMetric=0===metricIndex;return(0,jsx_runtime.jsx)("div",{className:`w-full border border-primary bg-light ${1===metrics.length?"rounded":isFirstMetric?"rounded-t":metricIndex===metrics.length-1?"rounded-b":""}`,children:(0,jsx_runtime.jsx)(DeltaChart,{isSecondary:!!isSecondary,result:result,error:errors?.[metricIndex],variants:variants,metricType:getInsightType(metric),metricIndex:metricIndex,isFirstMetric:isFirstMetric,metric:metric,tickValues:commonTickValues,chartBound:chartBound})},metricIndex)})})}):(0,jsx_runtime.jsx)("div",{className:"border rounded bg-surface-primary pt-6 pb-8 text-secondary mt-2",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col items-center mx-auto deprecated-space-y-3",children:[(0,jsx_runtime.jsx)(icons.Ii,{fontSize:"30"}),(0,jsx_runtime.jsxs)("div",{className:"text-sm text-center text-balance max-w-sm",children:[(0,jsx_runtime.jsx)("p",{children:`Add up to ${isSecondary?experiments_constants.Zy:experiments_constants.C} ${isSecondary?"secondary":"primary"} metrics.`}),(0,jsx_runtime.jsx)("p",{children:isSecondary?"Secondary metrics provide additional context and help detect unintended side effects.":"Primary metrics represent the main goal of the experiment and directly measure if your hypothesis was successful."})]}),isSecondary?(0,jsx_runtime.jsx)(AddSecondaryMetric,{}):(0,jsx_runtime.jsx)(AddPrimaryMetric,{})]})})]})}var Chart=__webpack_require__("../../frontend/src/lib/Chart.ts"),LemonModal=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonModal/index.ts");let DELTA=[.16,.17,.15,.16,.14,.15,.145,.15,.155,.148,.15,.147,.152,.15],UPPER_BOUND=[.26,.27,.24,.24,.21,.21,.2,.2,.195,.183,.182,.177,.182,.18],LOWER_BOUND=[.06,.07,.06,.08,.07,.09,.09,.1,.115,.113,.118,.117,.122,.12],VariantDeltaTimeseries=()=>{let{closeVariantDeltaTimeseriesModal}=(0,index_esm.useActions)(modalsLogic.l),{isVariantDeltaTimeseriesModalOpen}=(0,index_esm.useValues)(modalsLogic.l);return(0,react.useEffect)(()=>{isVariantDeltaTimeseriesModalOpen&&setTimeout(()=>{let ctx=document.getElementById("variantDeltaChart");if(!ctx){console.error("Canvas element not found");return}let existingChart=Chart.kL.getChart(ctx);existingChart&&existingChart.destroy(),ctx.style.width="100%",ctx.style.height="100%";let config={type:"line",data:{labels:["Day 1","Day 2","Day 3","Day 4","Day 5","Day 6","Day 7","Day 8","Day 9","Day 10","Day 11","Day 12","Day 13","Day 14"],datasets:[{label:"Upper Bound",data:UPPER_BOUND,borderColor:"rgba(200, 200, 200, 1)",fill:!1,tension:0,pointRadius:0},{label:"Lower Bound",data:LOWER_BOUND,borderColor:"rgba(200, 200, 200, 1)",fill:"-1",backgroundColor:"rgba(200, 200, 200, 0.2)",tension:0,pointRadius:0},{label:"Delta",data:DELTA,borderColor:"rgba(0, 100, 255, 1)",borderWidth:2,fill:!1,tension:0,pointRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"nearest",axis:"x"},scales:{y:{beginAtZero:!0,grid:{display:!1},ticks:{count:6,callback:value=>`${(100*Number(value)).toFixed(1)}%`}}},plugins:{legend:{display:!1},tooltip:{callbacks:{labelPointStyle:function(){return{pointStyle:"circle",rotation:0}}},usePointStyle:!0,boxWidth:16,boxHeight:1},crosshair:!1}}};new Chart.kL(ctx,config)},0)},[isVariantDeltaTimeseriesModalOpen]),(0,jsx_runtime.jsx)(LemonModal.f,{isOpen:isVariantDeltaTimeseriesModalOpen,onClose:()=>{closeVariantDeltaTimeseriesModal()},width:800,title:"Variant performance over time",footer:(0,jsx_runtime.jsx)(LemonButton.J,{form:"secondary-metric-modal-form",type:"secondary",onClick:()=>{},children:"Close"}),children:(0,jsx_runtime.jsx)("div",{className:"relative h-[400px]",children:(0,jsx_runtime.jsx)("canvas",{id:"variantDeltaChart"})})})};function ConfidenceIntervalAxis(_ref){let{chartRadius}=_ref,tickValues=(0,shared_utils.Zj)(chartRadius),{ticksSvgRef,ticksSvgHeight}=useSvgResizeObserver([tickValues,chartRadius]);return(0,jsx_runtime.jsxs)("div",{className:"flex border-t border-l border-r rounded-t",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/5 border-r border-primary",children:(0,jsx_runtime.jsx)("div",{style:{height:`${ticksSvgHeight}px`}})}),(0,jsx_runtime.jsx)("div",{className:"w-4/5 min-w-[780px]",children:(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:(0,jsx_runtime.jsx)("svg",{ref:ticksSvgRef,viewBox:"0 0 800 20",preserveAspectRatio:"xMidYMid meet",className:"ml-12 max-w-[1000px]",style:{minHeight:"20px"},children:tickValues.map(value=>{let x=(0,shared_utils.wq)(value,chartRadius,800,20);return(0,jsx_runtime.jsx)("g",{children:(0,jsx_runtime.jsx)("text",{x:x,y:10,textAnchor:"middle",dominantBaseline:"middle",fontSize:9,fill:COLORS.TICK_TEXT_COLOR,fontWeight:"600",children:(0,shared_utils.wo)(value)})},value)})})})})]})}function GridLines_GridLines(_ref){let{tickValues,chartRadius,chartHeight}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:tickValues.map(value=>{let x=(0,shared_utils.wq)(value,chartRadius,800,20);return(0,jsx_runtime.jsx)("line",{x1:x,y1:0,x2:x,y2:chartHeight,stroke:0===value?COLORS.ZERO_LINE:COLORS.BOUNDARY_LINES,strokeWidth:0===value?1:.5},value)})})}function useTooltipHover(){let[hoveredVariant,setHoveredVariant]=(0,react.useState)(null),[hoveredTooltip,setHoveredTooltip]=(0,react.useState)(null),hideTimeoutRef=(0,react.useRef)(null);return(0,react.useEffect)(()=>()=>{hideTimeoutRef.current&&clearTimeout(hideTimeoutRef.current)},[]),{showTooltip:variantKey=>{hideTimeoutRef.current&&(clearTimeout(hideTimeoutRef.current),hideTimeoutRef.current=null),setHoveredVariant(variantKey),setHoveredTooltip(null)},hideTooltip:()=>{hideTimeoutRef.current=setTimeout(()=>{setHoveredVariant(null),setHoveredTooltip(null)},150)},showTooltipFromTooltip:variantKey=>{hideTimeoutRef.current&&(clearTimeout(hideTimeoutRef.current),hideTimeoutRef.current=null),setHoveredTooltip(variantKey),setHoveredVariant(null)},isTooltipVisible:variantKey=>hoveredVariant===variantKey||hoveredTooltip===variantKey}}function VariantGradient(_ref){let{metricIndex,variantKey,isSecondary,lower,upper,colors}=_ref;return(0,jsx_runtime.jsx)("linearGradient",{id:`gradient-${metricIndex}-${variantKey}-${isSecondary?"secondary":"primary"}`,x1:"0",x2:"1",y1:"0",y2:"0",children:lower<0&&upper>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("stop",{offset:"0%",stopColor:colors.BAR_NEGATIVE}),(0,jsx_runtime.jsx)("stop",{offset:`${-lower/(upper-lower)*100}%`,stopColor:colors.BAR_NEGATIVE}),(0,jsx_runtime.jsx)("stop",{offset:`${-lower/(upper-lower)*100}%`,stopColor:colors.BAR_POSITIVE}),(0,jsx_runtime.jsx)("stop",{offset:"100%",stopColor:colors.BAR_POSITIVE})]}):(0,jsx_runtime.jsx)("stop",{offset:"100%",stopColor:upper<=0?colors.BAR_NEGATIVE:colors.BAR_POSITIVE})})}function VariantBar_VariantBar(_ref2){let{variantResult,index,chartRadius,metricIndex,isSecondary,onMouseEnter,onMouseLeave,chartHeight,totalBars}=_ref2,interval=(0,shared_utils.nM)(variantResult),[lower,upper]=interval?[interval[0],interval[1]]:[0,0],delta=interval?(interval[0]+interval[1])/2:0,hasEnoughData=!!interval,colors=useChartColors(),y=Math.max(0,(chartHeight-(12+28*totalBars))/2)+12+28*index,x1=(0,shared_utils.wq)(lower,chartRadius,800,20),x2=(0,shared_utils.wq)(upper,chartRadius,800,20),deltaX=(0,shared_utils.wq)(delta,chartRadius,800,20);return(0,jsx_runtime.jsx)("g",{onMouseEnter:onMouseEnter,onMouseLeave:onMouseLeave,className:"cursor-pointer",children:hasEnoughData?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("text",{x:x1-8,y:y+8,fontSize:"10",textAnchor:"end",dominantBaseline:"middle",fill:"var(--text-secondary)",fontWeight:"600",children:variantResult.key}),(0,jsx_runtime.jsx)("defs",{children:(0,jsx_runtime.jsx)(VariantGradient,{metricIndex:metricIndex,variantKey:variantResult.key,isSecondary:isSecondary,lower:lower,upper:upper,colors:colors})}),(0,shared_utils.YL)(variantResult)?(0,jsx_runtime.jsx)("path",{d:generateViolinPath(x1,x2,y,16,deltaX),fill:`url(#gradient-${metricIndex}-${variantResult.key}-${isSecondary?"secondary":"primary"})`}):(0,jsx_runtime.jsx)("rect",{x:x1,y:y,width:x2-x1,height:16,fill:`url(#gradient-${metricIndex}-${variantResult.key}-${isSecondary?"secondary":"primary"})`,rx:3,ry:3}),(0,jsx_runtime.jsx)("line",{x1:deltaX,y1:y,x2:deltaX,y2:y+16,stroke:colors.BAR_MIDDLE_POINT,strokeWidth:2,shapeRendering:"crispEdges"})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("text",{x:(0,shared_utils.wq)(0,chartRadius,800,20)-150,y:y+8,fontSize:"10",textAnchor:"end",dominantBaseline:"middle",fill:"var(--text-secondary)",fontWeight:"600",children:variantResult.key}),(0,jsx_runtime.jsx)("rect",{x:(0,shared_utils.wq)(0,chartRadius,800,20)-50,y:y+8-8,width:"100",height:"16",rx:"3",ry:"3",fill:"var(--border-light)"}),(0,jsx_runtime.jsx)("text",{x:(0,shared_utils.wq)(0,chartRadius,800,20),y:y+8,fontSize:"10",textAnchor:"middle",dominantBaseline:"middle",fill:"var(--muted)",children:"Not enough data yet"})]})},variantResult.key)}function VariantTooltip_VariantTooltip(_ref){let{variantResult,index,chartRadius,chartSvgRef,isVisible,onMouseEnter,onMouseLeave}=_ref;if(!isVisible||!chartSvgRef.current)return null;let interval=(0,shared_utils.nM)(variantResult),[lower,upper]=interval?[interval[0],interval[1]]:[0,0],x1=(0,shared_utils.wq)(lower,chartRadius,800,20),x2=(0,shared_utils.wq)(upper,chartRadius,800,20),svgRect=chartSvgRef.current.getBoundingClientRect(),svgViewBox=chartSvgRef.current.viewBox.baseVal,screenX=svgRect.left+(x1+x2)/2/svgViewBox.width*svgRect.width,screenY=svgRect.top+(12+28*index)/svgViewBox.height*svgRect.height,intervalPercent=interval?`[${(100*lower).toFixed(2)}%, ${(100*upper).toFixed(2)}%]`:"N/A",intervalLabel=(0,shared_utils.qr)(variantResult);return(0,jsx_runtime.jsx)("div",{className:"fixed -translate-x-1/2 -translate-y-full bg-[var(--bg-surface-primary)] border border-[var(--border-primary)] px-3 py-2 rounded-md text-[13px] shadow-md z-[100] min-w-[300px]",style:{left:screenX,top:screenY-10,pointerEvents:"auto"},onMouseEnter:onMouseEnter,onMouseLeave:onMouseLeave,children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:variantResult.key}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Samples:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:variantResult.number_of_samples})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Sum:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:variantResult.sum})]}),(0,shared_utils.YL)(variantResult)?(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Chance to win:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(0,shared_utils.kU)(variantResult.chance_to_win)})]}):(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"P-value:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(0,shared_utils.L5)(variantResult.p_value)})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Significant:"}),(0,jsx_runtime.jsx)("span",{className:`font-semibold ${variantResult.significant?"text-success":"text-muted"}`,children:variantResult.significant?"Yes":"No"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Delta:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"control"===variantResult.key?(0,jsx_runtime.jsx)("em",{className:"text-secondary",children:"Baseline"}):(()=>{let deltaPercent=interval?(lower+upper)/2*100:0,isPositive=deltaPercent>0;return(0,jsx_runtime.jsx)("span",{className:isPositive?"text-success":"text-danger",children:`${isPositive?"+":""}${deltaPercent.toFixed(2)}%`})})()})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsxs)("span",{className:"text-secondary font-semibold",children:[intervalLabel,":"]}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:intervalPercent})]})]})})}function Chart_Chart(_ref){let{chartSvgRef,variantResults,chartRadius,metricIndex,tickValues,isSecondary}=_ref,{showTooltip,hideTooltip,showTooltipFromTooltip,isTooltipVisible}=useTooltipHover(),chartHeight=Math.max(12+28*variantResults.length,70);return(0,jsx_runtime.jsxs)("div",{className:"relative w-full",children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:(0,jsx_runtime.jsxs)("svg",{ref:chartSvgRef,viewBox:`0 0 800 ${chartHeight}`,preserveAspectRatio:"xMidYMid meet",className:"ml-12 max-w-[1000px]",children:[(0,jsx_runtime.jsx)("g",{className:"grid-lines-layer",children:(0,jsx_runtime.jsx)(GridLines_GridLines,{tickValues:tickValues,chartRadius:chartRadius,chartHeight:chartHeight})}),(0,jsx_runtime.jsx)("g",{className:"variant-bars-layer",children:variantResults.map((variantResult,index)=>(0,jsx_runtime.jsx)(VariantBar_VariantBar,{variantResult:variantResult,index:index,chartRadius:chartRadius,metricIndex:metricIndex,isSecondary:isSecondary,chartHeight:chartHeight,totalBars:variantResults.length,onMouseEnter:()=>showTooltip(variantResult.key),onMouseLeave:hideTooltip},`variant-bar-${variantResult.key}`))})]})}),variantResults.map((variantResult,index)=>(0,jsx_runtime.jsx)(VariantTooltip_VariantTooltip,{variantResult:variantResult,index:index,chartRadius:chartRadius,chartSvgRef:chartSvgRef,isVisible:isTooltipVisible(variantResult.key),onMouseEnter:()=>showTooltipFromTooltip(variantResult.key),onMouseLeave:hideTooltip},`tooltip-${variantResult.key}`))]})}function DetailsButton(_ref){let{isSecondary,experiment,setIsModalOpen}=_ref,primaryMetricsLength=experiment.metrics.length+experiment.saved_metrics.filter(savedMetric=>savedMetric.metadata?.type==="primary").length;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(isSecondary||!isSecondary&&primaryMetricsLength>1)&&(0,jsx_runtime.jsx)("div",{className:"absolute top-2 left-2 flex justify-center bg-[var(--bg-table)] z-[101]",children:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGraph,{}),onClick:()=>setIsModalOpen(!0),children:"Details"})})})}var kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),dist_module=__webpack_require__("../../node_modules/.pnpm/posthog-js@1.257.0_@rrweb+types@2.0.0-alpha.17/node_modules/posthog-js/dist/module.js");function ResultDetails(_ref){let{experiment,result,metric,metricIndex,isSecondary}=_ref,columns=[{key:"variant",title:"Variant",render:(_,item)=>(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:item.key})},{key:"total-users",title:"Total users",render:(_,item)=>(0,utils.Lc)(item.number_of_samples)},{key:"value",title:"mean"===metric.metric_type?"Mean":"Conversion rate",render:(_,item)=>{let value=item.sum/item.number_of_samples;return"mean"===metric.metric_type?value.toFixed(2):`${(100*value).toFixed(2)}%`}},{key:"statistical_measure",title:result.variant_results?.[0]&&(0,shared_utils.YL)(result.variant_results[0])?"Chance to win":"p-value",render:(_,item)=>"control"===item.key?"â":(0,shared_utils.YL)(item)?(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,shared_utils.kU)(item.chance_to_win)}):(0,shared_utils.VB)(item)?(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,shared_utils.L5)(item.p_value)}):"â"},{key:"significant",title:"Significant",render:(_,item)=>{if("control"===item.key||!("significant"in item))return"â";let label=item.significant?"Yes":"No";return item.significant?(0,jsx_runtime.jsx)("div",{className:"text-success font-semibold",children:label}):label}},{key:"interval",title:result.variant_results?.[0]?`${(0,shared_utils.qr)(result.variant_results[0])} (95%)`:"Confidence interval (95%)",render:(_,item)=>{if("control"===item.key)return"â";let interval=(0,shared_utils.nM)(item);return interval?`[${(100*interval[0]).toFixed(2)}%, ${(100*interval[1]).toFixed(2)}%]`:"â"}},{key:"recordings",title:"",render:(_,item)=>{let variantKey=item.key,filters=(0,experiments_utils.l_)(experiment,metric,variantKey);return(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconRewindPlay,{}),tooltip:"Watch recordings of people who were exposed to this variant.",disabledReason:0===filters.length?"Unable to identify recordings for this metric":void 0,type:"secondary",onClick:()=>{var _experiment$exposure_;let filterGroup={filter_group:{type:types.J2.And,values:[{type:types.J2.And,values:filters}]},date_from:experiment?.start_date,date_to:experiment?.end_date,filter_test_accounts:null!==(_experiment$exposure_=experiment.exposure_criteria?.filterTestAccounts)&&void 0!==_experiment$exposure_&&_experiment$exposure_};kea_router_lib.router.actions.push(urls.j.replay(types.yd.Home,filterGroup)),dist_module.ZP.capture("viewed recordings from experiment",{variant:variantKey})},children:"View recordings"})}}],dataSource=[...result.baseline?[{...result.baseline,key:"control"}]:[],...result.variant_results||[]];return(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsx)(src.g3,{columns:columns,dataSource:dataSource,loading:!1}),"funnel"===metric.metric_type&&(0,jsx_runtime.jsx)(ResultsBreakdown,{result:result,experiment:experiment,metricIndex:metricIndex,isPrimary:!isSecondary,children:_ref2=>{let{query,breakdownResultsLoading,breakdownResults,exposureDifference}=_ref2;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[breakdownResultsLoading&&(0,jsx_runtime.jsx)(ResultsBreakdownSkeleton,{}),query&&breakdownResults&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ResultsInsightInfoBanner,{exposureDifference:exposureDifference}),(0,jsx_runtime.jsx)(ResultsQuery,{query:query,breakdownResults:breakdownResults})]})]})}})]})}function DetailsModal(_ref){let{isOpen,onClose,metric,result,experiment,metricIndex,isSecondary}=_ref;return result.metric=metric,(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:onClose,width:1200,title:`Metric results: ${metric.name||"Untitled metric"}`,footer:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:onClose,children:"Close"}),children:(0,jsx_runtime.jsx)(ResultDetails,{result:result,experiment:experiment,metric:metric,metricIndex:metricIndex,isSecondary:isSecondary})})}function MetricRow(_ref){let{metric,metricType,result,isSecondary,metrics,metricIndex,chartRadius,error}=_ref,{experiment,secondaryMetricsResultsLoading,primaryMetricsResultsLoading,hasMinimumExposureForResults,primaryMetricsLengthWithSharedMetrics,secondaryMetricsLengthWithSharedMetrics}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{duplicateMetric,updateExperimentMetrics}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),resultsLoading=isSecondary?secondaryMetricsResultsLoading:primaryMetricsResultsLoading,canDuplicateMetric=(isSecondary?secondaryMetricsLengthWithSharedMetrics:primaryMetricsLengthWithSharedMetrics)<(isSecondary?experiments_constants.Zy:experiments_constants.C),variantResults=result?.variant_results||[],tickValues=(0,shared_utils.Zj)(chartRadius),{chartSvgRef,chartSvgHeight}=useSvgResizeObserver([tickValues,chartRadius]),panelHeight=Math.max(chartSvgHeight,60),[isModalOpen,setIsModalOpen]=(0,react.useState)(!1);return(0,jsx_runtime.jsx)("div",{className:`w-full border border-primary bg-light ${metricIndex===metrics.length-1?"rounded-b":""}`,children:(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/5 border-r border-primary",children:(0,jsx_runtime.jsx)("div",{className:"p-2",style:{height:`${panelHeight}px`},children:(0,jsx_runtime.jsx)(MetricHeader,{metricIndex:metricIndex,metric:metric,metricType:metricType,isPrimaryMetric:!isSecondary,canDuplicateMetric:canDuplicateMetric,onDuplicateMetricClick:()=>{duplicateMetric({metricIndex,isSecondary}),updateExperimentMetrics()}})})}),(0,jsx_runtime.jsx)("div",{className:"w-4/5 min-w-[780px]",style:{height:`${panelHeight}px`},children:resultsLoading?(0,jsx_runtime.jsx)(ChartLoadingState,{height:panelHeight}):result&&hasMinimumExposureForResults?(0,jsx_runtime.jsxs)("div",{className:"relative",children:[(0,jsx_runtime.jsx)(Chart_Chart,{chartSvgRef:chartSvgRef,variantResults:variantResults,chartRadius:chartRadius,metricIndex:metricIndex,tickValues:tickValues,isSecondary:isSecondary}),(0,jsx_runtime.jsx)(DetailsButton,{metric:metric,isSecondary:isSecondary,experiment:experiment,setIsModalOpen:setIsModalOpen}),(0,jsx_runtime.jsx)(DetailsModal,{isOpen:isModalOpen,onClose:()=>setIsModalOpen(!1),metric:metric,result:result,experiment:experiment,metricIndex:metricIndex,isSecondary:isSecondary})]}):(0,jsx_runtime.jsx)(ChartEmptyState,{height:panelHeight,experimentStarted:!!experiment.start_date,hasMinimumExposure:hasMinimumExposureForResults,metric:metric,error:error})})]})})}function Metrics(_ref){let{isSecondary}=_ref,{experiment,getInsightType,primaryMetricsResults,secondaryMetricsResults,secondaryMetricsResultsErrors,primaryMetricsResultsErrors,hasMinimumExposureForResults}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);if(!experiment?.feature_flag?.filters?.multivariate?.variants)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let results=isSecondary?secondaryMetricsResults:primaryMetricsResults,errors=isSecondary?secondaryMetricsResultsErrors:primaryMetricsResultsErrors,metrics=isSecondary?experiment.metrics_secondary:experiment.metrics,sharedMetrics=experiment.saved_metrics.filter(sharedMetric=>sharedMetric.metadata.type===(isSecondary?"secondary":"primary")).map(sharedMetric=>({...sharedMetric.query,name:sharedMetric.name,sharedMetricId:sharedMetric.saved_metric,isSharedMetric:!0}));sharedMetrics&&(metrics=[...metrics,...sharedMetrics]);let maxAbsValue=Math.max(...results.flatMap(result=>(result?.variant_results||[]).flatMap(variant=>{let interval=(0,shared_utils.nM)(variant);return interval?[Math.abs(interval[0]),Math.abs(interval[1])]:[]}))),axisMargin=Math.max(.05*maxAbsValue,.1),chartRadius=maxAbsValue+axisMargin;return(0,jsx_runtime.jsxs)("div",{className:"mb-4 -mt-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/2 pt-5",children:(0,jsx_runtime.jsxs)("div",{className:"inline-flex items-center deprecated-space-x-2 mb-0",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0 font-semibold text-lg leading-6",children:isSecondary?"Secondary metrics":"Primary metrics"}),metrics.length>0&&(0,jsx_runtime.jsx)(src.u,{title:isSecondary?"Secondary metrics capture additional outcomes or behaviors affected by your experiment. They help you understand broader impacts and potential side effects beyond the primary goal.":"Primary metrics represent the main goal of your experiment. They directly measure whether your hypothesis was successful and are the key factor in deciding if the test achieved its primary objective.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-lg"})})]})}),(0,jsx_runtime.jsx)("div",{className:"w-1/2 flex flex-col justify-end",children:(0,jsx_runtime.jsx)("div",{className:"ml-auto",children:metrics.length>0&&(0,jsx_runtime.jsx)("div",{className:"mb-2 mt-4 justify-end",children:isSecondary?(0,jsx_runtime.jsx)(AddSecondaryMetric,{}):(0,jsx_runtime.jsx)(AddPrimaryMetric,{})})})})]}),metrics.length>0?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("div",{className:"w-full overflow-x-auto",children:(0,jsx_runtime.jsx)("div",{className:"min-w-[1000px]",children:(0,jsx_runtime.jsxs)("div",{className:"rounded bg-[var(--bg-table)]",children:[(0,jsx_runtime.jsx)(ConfidenceIntervalAxis,{chartRadius:chartRadius}),metrics.map((metric,metricIndex)=>{let result=results[metricIndex];return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(MetricRow,{metrics:metrics,metricIndex:metricIndex,result:results[metricIndex],metric:metric,metricType:getInsightType(metric),isSecondary:!!isSecondary,chartRadius:chartRadius,error:errors[metricIndex]}),1===metrics.length&&result&&hasMinimumExposureForResults&&!isSecondary&&(0,jsx_runtime.jsx)("div",{className:"mt-2",children:(0,jsx_runtime.jsx)(ResultDetails,{metric:metric,result:{...results[metricIndex],metric:metric},experiment:experiment,metricIndex:metricIndex,isSecondary:!!isSecondary})})]},metricIndex)})]})})})}):(0,jsx_runtime.jsx)("div",{className:"border rounded bg-surface-primary pt-6 pb-8 text-secondary mt-2",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col items-center mx-auto deprecated-space-y-3",children:[(0,jsx_runtime.jsx)(icons.Ii,{fontSize:"30"}),(0,jsx_runtime.jsxs)("div",{className:"text-sm text-center text-balance max-w-sm",children:[(0,jsx_runtime.jsxs)("p",{children:["Add up toÂ ",isSecondary?experiments_constants.Zy:experiments_constants.C,"Â ",(0,jsx_runtime.jsx)("span",{children:isSecondary?"secondary":"primary"})," metrics."]}),(0,jsx_runtime.jsx)("p",{children:isSecondary?"Secondary metrics provide additional context and help detect unintended side effects.":"Primary metrics represent the main goal of the experiment and directly measure if your hypothesis was successful."})]}),isSecondary?(0,jsx_runtime.jsx)(AddSecondaryMetric,{}):(0,jsx_runtime.jsx)(AddPrimaryMetric,{})]})})]})}let RunningTimeCalculatorModalStep=_ref=>{let{children,stepNumber,title,description}=_ref;return(0,jsx_runtime.jsx)("div",{className:"space-y-6",children:(0,jsx_runtime.jsxs)("div",{className:"rounded bg-light p-4 space-y-3",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("span",{className:"rounded-full bg-muted text-white w-6 h-6 flex items-center justify-center font-semibold",children:stepNumber}),(0,jsx_runtime.jsx)("h4",{className:"font-semibold m-0",children:title})]}),(0,jsx_runtime.jsx)("p",{className:"text-muted",children:description}),(0,jsx_runtime.jsx)("div",{className:"space-y-2",children:children})]})})},exposureEstimateConfigToFilter=_ref=>{let{eventFilter}=_ref;return eventFilter?{actions:eventFilter.entityType===TaxonomicFilter_types.t.Actions?[{id:eventFilter.event?Number(eventFilter.event):0,kind:schema_general.OH.ActionsNode,type:"actions",name:eventFilter.name||"",properties:eventFilter.properties||[]}]:[],events:eventFilter.entityType===TaxonomicFilter_types.t.Events?[{id:eventFilter.event||"$pageview",kind:schema_general.OH.EventsNode,type:"events",name:eventFilter.name||"$pageview",properties:eventFilter.properties||[]}]:[]}:{events:[],actions:[]}},EventSelectorStep=_ref2=>{let{exposureEstimateConfig,onSetFilter}=_ref2,filter=exposureEstimateConfig?exposureEstimateConfigToFilter(exposureEstimateConfig):{events:[{id:"$pageview",kind:schema_general.OH.EventsNode,type:"events",name:"$pageview",properties:[]}]};return(0,jsx_runtime.jsx)(RunningTimeCalculatorModalStep,{stepNumber:1,title:"Estimate experiment traffic",description:"Choose an event to estimate the number of users who will be exposed to your experiment. We'll use data from the last 14 days to calculate the minimum sample size and estimated duration for your experiment.",children:(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,hideRename:!0,typeKey:"running-time-calculator",filters:filter,actionsTaxonomicGroupTypes:[TaxonomicFilter_types.t.Events,TaxonomicFilter_types.t.Actions],entitiesLimit:1,mathAvailability:ActionFilterRow.Qq.None,setFilters:_ref3=>{let{events,actions}=_ref3,eventFilter=events?.[0]||actions?.[0];eventFilter&&onSetFilter(eventFilter)}})})};var LemonInput=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonInput/index.ts"),LemonSegmentedButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSegmentedButton/index.ts"),Tooltip=__webpack_require__("../../frontend/src/lib/lemon-ui/Tooltip/index.ts"),fast_deep_equal=__webpack_require__("../../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"),fast_deep_equal_default=__webpack_require__.n(fast_deep_equal);let calculateVariance=(metric,averageEventsPerUser,averagePropertyValuePerUser)=>metric?metric.metric_type===schema_general.Tu.MEAN&&metric.source.math===types.xu.TotalCount?2*averageEventsPerUser:metric.metric_type===schema_general.Tu.MEAN&&metric.source.math===types.xu.Sum?.25*averagePropertyValuePerUser**2:null:null,calculateRecommendedSampleSize=(metric,minimumDetectableEffect,variance,averageEventsPerUser,averagePropertyValuePerUser,automaticConversionRateDecimal,manualConversionRate,conversionRateInputType,numberOfVariants)=>{let d,sampleSizeFormula;if(!metric)return null;let minimumDetectableEffectDecimal=minimumDetectableEffect/100;if(metric.metric_type===schema_general.Tu.MEAN&&metric.source.math===types.xu.TotalCount)sampleSizeFormula=16*variance/(d=minimumDetectableEffectDecimal*averageEventsPerUser)**2;else if(metric.metric_type===schema_general.Tu.MEAN&&metric.source.math===types.xu.Sum)sampleSizeFormula=16*variance/(d=minimumDetectableEffectDecimal*averagePropertyValuePerUser)**2;else if(metric.metric_type===schema_general.Tu.FUNNEL){let conversionRate=conversionRateInputType===ConversionRateInputType.MANUAL?manualConversionRate/100:automaticConversionRateDecimal;if(d=minimumDetectableEffectDecimal*conversionRate,null===conversionRate)return null;sampleSizeFormula=16*conversionRate*(1-conversionRate)/d**2}return d&&sampleSizeFormula?sampleSizeFormula*numberOfVariants:null},ConversionRateInputType=function(ConversionRateInputType){return ConversionRateInputType.MANUAL="manual",ConversionRateInputType.AUTOMATIC="automatic",ConversionRateInputType}({}),defaultExposureEstimateConfig={eventFilter:{event:"$pageview",name:"$pageview",properties:[],entityType:TaxonomicFilter_types.t.Events},metric:null,conversionRateInputType:ConversionRateInputType.AUTOMATIC,manualConversionRate:2,uniqueUsers:null},applyMathTrendsQuery=metric=>query=>query?metric.metric_type===schema_general.Tu.MEAN?{...query,series:[...query.series.slice(0,-1),{...query.series.at(-1),math:types.D7.Average}]}:query:void 0,runningTimeCalculatorLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","experiments","RunningTimeCalculator","runningTimeCalculatorLogic"]),(0,index_esm.connect)(_ref=>{let{experimentId}=_ref;return{values:[(0,experiments_experimentLogic.Wl)({experimentId}),["experiment"]]}}),(0,index_esm.actions)({setMetricIndex:value=>({value}),setMetricResult:value=>({value}),setConversionRateInputType:value=>({value}),setManualConversionRate:value=>({value}),setExposureEstimateConfig:value=>({value}),setMinimumDetectableEffect:value=>({value})}),(0,index_esm.reducers)({_exposureEstimateConfig:[null,{setExposureEstimateConfig:(_,_ref2)=>{let{value}=_ref2;return value}}],_metricIndex:[null,{setMetricIndex:(_,_ref3)=>{let{value}=_ref3;return value}}],_conversionRateInputType:[ConversionRateInputType.AUTOMATIC,{setConversionRateInputType:(_,_ref4)=>{let{value}=_ref4;return value}}],_manualConversionRate:[2,{setManualConversionRate:(_,_ref5)=>{let{value}=_ref5;return value}}],_minimumDetectableEffect:[null,{setMinimumDetectableEffect:(_,_ref6)=>{let{value}=_ref6;return value}}]}),(0,kea_loaders_lib.loaders)(_ref7=>{let{values}=_ref7;return{metricResult:{loadMetricResult:async()=>{var _values$exposureEstim,_result$results$0$cou,_result$results$1$cou,_result$results$1$cou2,_result$results$0$cou2;if(null===values.metricIndex)return null;let metric=values.metric;if(!metric)return null;let eventFilter=null!==(_values$exposureEstim=values.exposureEstimateConfig?.eventFilter)&&void 0!==_values$exposureEstim?_values$exposureEstim:{event:"$pageview",name:"$pageview",properties:[],entityType:TaxonomicFilter_types.t.Events},exposureEventNode=(0,metricQueryUtils.s6)(eventFilter,{mathProps:{math:types.vN.UniqueUsers}}),query=(0,metricQueryUtils.qC)((0,metricQueryUtils.pm)({filterTestAccounts:!!values.experiment.exposure_criteria?.filterTestAccounts,dateRange:(0,metricQueryUtils.e6)(),funnelsFilter:{funnelVizType:types.Ui.Steps},trendsFilter:{}}),(0,metricQueryUtils.Te)(exposureEventNode),applyMathTrendsQuery(metric))(metric);if(!query)return null;let result=await (0,queries_query.jr)(query,void 0,"force_blocking");if((0,schema_general.Gt)(metric))return{uniqueUsers:null!==(_result$results$0$cou=result?.results?.[0]?.count)&&void 0!==_result$results$0$cou?_result$results$0$cou:null,...metric.source.math===types.xu.TotalCount?{averageEventsPerUser:null!==(_result$results$1$cou=result?.results?.[1]?.count)&&void 0!==_result$results$1$cou?_result$results$1$cou:null}:{},...metric.source.math===types.xu.Sum?{averagePropertyValuePerUser:null!==(_result$results$1$cou2=result?.results?.[1]?.count)&&void 0!==_result$results$1$cou2?_result$results$1$cou2:null}:{}};if((0,schema_general.N4)(metric)){let firstStepCount=result?.results?.[0]?.count,automaticConversionRateDecimal=firstStepCount&&firstStepCount>0?(result?.results?.at(-1)?.count||0)/firstStepCount:null;return{uniqueUsers:null!==(_result$results$0$cou2=result?.results?.[0]?.count)&&void 0!==_result$results$0$cou2?_result$results$0$cou2:null,automaticConversionRateDecimal:automaticConversionRateDecimal}}return{}},setMetricResult:_ref8=>{let{value}=_ref8;return value}}}}),(0,index_esm.listeners)(_ref9=>{let{actions,values}=_ref9;return{setMetricIndex:()=>{if(values.metric){var _values$exposureEstim2;actions.setExposureEstimateConfig({...null!==(_values$exposureEstim2=values.exposureEstimateConfig)&&void 0!==_values$exposureEstim2?_values$exposureEstim2:defaultExposureEstimateConfig,metric:values.metric})}actions.loadMetricResult()},setManualConversionRate:()=>{var _values$exposureEstim3;actions.setExposureEstimateConfig({...null!==(_values$exposureEstim3=values.exposureEstimateConfig)&&void 0!==_values$exposureEstim3?_values$exposureEstim3:{eventFilter:null,metric:null,conversionRateInputType:ConversionRateInputType.MANUAL,uniqueUsers:null},manualConversionRate:values._manualConversionRate})},loadMetricResultSuccess:()=>{let uniqueUsers=values.metricResult?.uniqueUsers;if(uniqueUsers!==values.exposureEstimateConfig?.uniqueUsers){var _values$exposureEstim4;actions.setExposureEstimateConfig({...null!==(_values$exposureEstim4=values.exposureEstimateConfig)&&void 0!==_values$exposureEstim4?_values$exposureEstim4:{eventFilter:null,metric:null,conversionRateInputType:ConversionRateInputType.AUTOMATIC,manualConversionRate:null},uniqueUsers})}}}}),(0,index_esm.selectors)({defaultMetricIndex:[s=>[s.experiment,s.exposureEstimateConfig],(experiment,exposureEstimateConfig)=>{if(!experiment?.metrics||!exposureEstimateConfig?.metric)return null;let metricIndex=experiment.metrics.findIndex(m=>fast_deep_equal_default()(m,exposureEstimateConfig.metric));if(metricIndex>=0)return metricIndex;let sharedMetricIndex=experiment.saved_metrics.filter(m=>"primary"===m.metadata.type).findIndex(m=>fast_deep_equal_default()(m.query,exposureEstimateConfig.metric));return sharedMetricIndex>=0?experiment.metrics.length+sharedMetricIndex:null}],metricIndex:[s=>[s._metricIndex,s.defaultMetricIndex],(metricIndex,defaultMetricIndex)=>null!=metricIndex?metricIndex:defaultMetricIndex],exposureEstimateConfig:[s=>[s._exposureEstimateConfig,s.experiment],(localExposureEstimateConfig,experiment)=>localExposureEstimateConfig||(experiment.parameters.exposure_estimate_config?{...defaultExposureEstimateConfig,...experiment.parameters.exposure_estimate_config}:defaultExposureEstimateConfig)],conversionRateInputType:[s=>[s._conversionRateInputType,s.exposureEstimateConfig],(conversionRateInputType,exposureEstimateConfig)=>conversionRateInputType?exposureEstimateConfig?exposureEstimateConfig.conversionRateInputType:ConversionRateInputType.AUTOMATIC:conversionRateInputType],manualConversionRate:[s=>[s._manualConversionRate,s.exposureEstimateConfig],(manualConversionRate,exposureEstimateConfig)=>exposureEstimateConfig?.conversionRateInputType===ConversionRateInputType.MANUAL?exposureEstimateConfig.manualConversionRate:manualConversionRate],minimumDetectableEffect:[s=>[s._minimumDetectableEffect,s.experiment],(minimumDetectableEffect,experiment)=>{var _ref10;return null!==(_ref10=null!=minimumDetectableEffect?minimumDetectableEffect:experiment?.parameters?.minimum_detectable_effect)&&void 0!==_ref10?_ref10:experiments_experimentLogic.zi}],metric:[s=>[s.metricIndex,s.experiment],(metricIndex,experiment)=>{if(null===metricIndex)return null;if(metricIndex<experiment.metrics.length)return experiment.metrics[metricIndex];let sharedMetricIndex=metricIndex-experiment.metrics.length,sharedMetric=experiment.saved_metrics.filter(m=>"primary"===m.metadata.type)[sharedMetricIndex];return sharedMetric?.query}],uniqueUsers:[s=>[s.metricResult,s.exposureEstimateConfig],(metricResult,exposureEstimateConfig)=>{var _exposureEstimateConf;return metricResult&&null!==metricResult.uniqueUsers?metricResult.uniqueUsers:null!==(_exposureEstimateConf=exposureEstimateConfig?.uniqueUsers)&&void 0!==_exposureEstimateConf?_exposureEstimateConf:null}],averageEventsPerUser:[s=>[s.metricResult],metricResult=>{var _metricResult$average;return null!==(_metricResult$average=metricResult?.averageEventsPerUser)&&void 0!==_metricResult$average?_metricResult$average:null}],averagePropertyValuePerUser:[s=>[s.metricResult],metricResult=>{var _metricResult$average2;return null!==(_metricResult$average2=metricResult?.averagePropertyValuePerUser)&&void 0!==_metricResult$average2?_metricResult$average2:null}],automaticConversionRateDecimal:[s=>[s.metricResult],metricResult=>{var _metricResult$automat;return null!==(_metricResult$automat=metricResult?.automaticConversionRateDecimal)&&void 0!==_metricResult$automat?_metricResult$automat:null}],variance:[s=>[s.metric,s.averageEventsPerUser,s.averagePropertyValuePerUser],(metric,averageEventsPerUser,averagePropertyValuePerUser)=>calculateVariance(metric,averageEventsPerUser,averagePropertyValuePerUser)],standardDeviation:[s=>[s.variance],variance=>variance?Math.sqrt(variance):null],numberOfVariants:[s=>[s.experiment],experiment=>experiment.feature_flag?.filters.multivariate?.variants.length],recommendedSampleSize:[s=>[s.metric,s.minimumDetectableEffect,s.variance,s.averageEventsPerUser,s.averagePropertyValuePerUser,s.automaticConversionRateDecimal,s.manualConversionRate,s.conversionRateInputType,s.numberOfVariants],(metric,minimumDetectableEffect,variance,averageEventsPerUser,averagePropertyValuePerUser,automaticConversionRateDecimal,manualConversionRate,conversionRateInputType,numberOfVariants)=>calculateRecommendedSampleSize(metric,minimumDetectableEffect,variance,averageEventsPerUser,averagePropertyValuePerUser,automaticConversionRateDecimal,manualConversionRate,conversionRateInputType,numberOfVariants)],recommendedRunningTime:[s=>[s.recommendedSampleSize,s.uniqueUsers],(recommendedSampleSize,uniqueUsers)=>recommendedSampleSize/(uniqueUsers/14)]})]),UniqueUsersPanel=_ref=>{let{uniqueUsers}=_ref;return uniqueUsers?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Unique users"}),(0,jsx_runtime.jsxs)("div",{className:"font-semibold",children:["~",(0,utils.Lc)(uniqueUsers,0)," persons"]}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-muted",children:["Last ",14," days"]})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})},AverageEventsPerUserPanel=_ref2=>{let{averageEventsPerUser}=_ref2;return averageEventsPerUser?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Avg. events per user"}),(0,jsx_runtime.jsxs)("div",{className:"font-semibold",children:["~",(0,utils.Lc)(averageEventsPerUser,0)]})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})},AveragePropertyValuePerUserPanel=_ref3=>{let{averagePropertyValuePerUser}=_ref3;return averagePropertyValuePerUser?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Avg. property value per user"}),(0,jsx_runtime.jsxs)("div",{className:"font-semibold",children:["~",(0,utils.Lc)(averagePropertyValuePerUser,0)]})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})},StandardDeviationPanel=_ref4=>{let{standardDeviation}=_ref4;return standardDeviation?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"card-secondary",children:[(0,jsx_runtime.jsx)("span",{children:"Est. standard deviation"}),(0,jsx_runtime.jsx)(src.u,{className:"ml-1",title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:'The estimated standard deviation of the metric in the last 14 days. It\'s the "human-readable" version of the amount of dispersion in the dataset, and is calculated as the square root of the variance. The variance informs the recommended sample size.'}),children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary ml-1"})})]}),(0,jsx_runtime.jsxs)("div",{className:"font-semibold",children:["~",(0,utils.Lc)(standardDeviation,0)]})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})},FunnelMetricDataPanel=_ref=>{let{onChangeType}=_ref,{experimentId}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{conversionRateInputType,uniqueUsers,automaticConversionRateDecimal,manualConversionRate}=(0,index_esm.useValues)(runningTimeCalculatorLogic({experimentId})),{setConversionRateInputType,setManualConversionRate}=(0,index_esm.useActions)(runningTimeCalculatorLogic({experimentId}));return(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,jsx_runtime.jsx)(UniqueUsersPanel,{uniqueUsers:null!=uniqueUsers?uniqueUsers:0}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"card-secondary",children:[(0,jsx_runtime.jsx)("span",{children:"Conversion rate input"}),(0,jsx_runtime.jsx)(Tooltip.u,{className:"ml-1",title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("strong",{children:"Automatic:"})," Uses historical conversion rate between your exposure event and the conversion event. It may not always be representative of expected performance.",(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"Manual:"})," Allows you to set a custom conversion rate based on your own knowledge of the funnel."]}),children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary ml-1"})})]}),(0,jsx_runtime.jsx)(LemonSegmentedButton.P,{className:"mt-2",size:"small",options:[{label:"Manual",value:ConversionRateInputType.MANUAL},{label:"Automatic",value:ConversionRateInputType.AUTOMATIC}],onChange:value=>{setConversionRateInputType(value),onChangeType(value)},value:conversionRateInputType}),conversionRateInputType===ConversionRateInputType.MANUAL&&(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(LemonInput.D,{className:"w-[80px] mt-2",min:0,step:1,max:100,type:"number",value:manualConversionRate||void 0,onChange:newValue=>{null!=newValue&&newValue>=0&&setManualConversionRate(newValue)}}),(0,jsx_runtime.jsx)("div",{children:"%"})]}),conversionRateInputType===ConversionRateInputType.AUTOMATIC&&(0,jsx_runtime.jsxs)("div",{className:"font-semibold mt-2",children:["~",(0,utils.Lc)(100*automaticConversionRateDecimal,2),"%"]})]})]})})},MeanMetricDataPanel=()=>{let{experimentId}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{uniqueUsers,averageEventsPerUser,averagePropertyValuePerUser,standardDeviation}=(0,index_esm.useValues)(runningTimeCalculatorLogic({experimentId}));return(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,jsx_runtime.jsx)(UniqueUsersPanel,{uniqueUsers:null!=uniqueUsers?uniqueUsers:0}),(0,jsx_runtime.jsx)(AverageEventsPerUserPanel,{averageEventsPerUser:averageEventsPerUser}),(0,jsx_runtime.jsx)(AveragePropertyValuePerUserPanel,{averagePropertyValuePerUser:averagePropertyValuePerUser}),(0,jsx_runtime.jsx)(StandardDeviationPanel,{standardDeviation:standardDeviation})]})},MetricSelectorStep=_ref=>{let{onChangeMetric,onChangeFunnelConversionRateType}=_ref,{experimentId}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{experiment,metric,metricIndex,metricResultLoading}=(0,index_esm.useValues)(runningTimeCalculatorLogic({experimentId})),{setMetricIndex}=(0,index_esm.useActions)(runningTimeCalculatorLogic({experimentId})),metricOptions=[...experiment.metrics.map((metric,index)=>({metric:metric,index,isSharedMetric:!1})),...experiment.saved_metrics.filter(sharedMetric=>"primary"===sharedMetric.metadata.type).map((sharedMetric,index)=>sharedMetric.query&&(sharedMetric.query.kind===schema_general.OH.ExperimentMetric||void 0!==sharedMetric.query.metric_type)?{metric:sharedMetric.query,index:experiment.metrics.length+index,isSharedMetric:!0}:null).filter(option=>null!==option)];return(0,jsx_runtime.jsxs)(RunningTimeCalculatorModalStep,{stepNumber:2,title:"Select a metric",description:"Choose a metric to analyze. We'll use historical data from this metric to estimate the experiment duration.",children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary mb-2",children:"Experiment metric"}),(0,jsx_runtime.jsx)(src.Yv,{options:metricOptions.map((option,index)=>({label:(0,jsx_runtime.jsxs)("div",{className:"cursor-default text-xs font-semibold whitespace-nowrap overflow-hidden text-ellipsis flex-grow flex items-center",children:[(0,jsx_runtime.jsxs)("span",{className:"mr-1",children:[index+1,"."]}),(0,jsx_runtime.jsx)(MetricTitle,{metric:option.metric}),option.isSharedMetric&&(0,jsx_runtime.jsx)("span",{className:"ml-1",children:(0,jsx_runtime.jsx)(src.oe,{children:"Shared"})})]}),value:option.index})),value:metricIndex,onChange:value=>{if(null!==value){setMetricIndex(value);let selectedOption=metricOptions.find(option=>option.index===value);selectedOption&&onChangeMetric(selectedOption.metric)}}})]}),metricResultLoading?(0,jsx_runtime.jsx)("div",{className:"border-t pt-2",children:(0,jsx_runtime.jsx)("div",{className:"h-[100px] flex items-center justify-center",children:(0,jsx_runtime.jsx)(src.$j,{className:"text-3xl transform -translate-y-[-10px]"})})}):(0,jsx_runtime.jsxs)("div",{className:"border-t pt-2",children:[metric?.metric_type===schema_general.Tu.MEAN&&(0,jsx_runtime.jsx)(MeanMetricDataPanel,{}),metric?.metric_type===schema_general.Tu.FUNNEL&&(0,jsx_runtime.jsx)(FunnelMetricDataPanel,{onChangeType:onChangeFunnelConversionRateType})]})]})},RunningTimeCalculatorModalFooter=_ref=>{let{onClose,onSave}=_ref;return(0,jsx_runtime.jsx)("div",{className:"flex items-center w-full",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 ml-auto",children:[(0,jsx_runtime.jsx)(LemonButton.J,{form:"edit-experiment-metric-form",type:"secondary",onClick:onClose,children:"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{form:"edit-experiment-metric-form",onClick:onSave,type:"primary",children:"Save"})]})})};function RunningTimeCalculatorModal(){let{experimentId}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{isCalculateRunningTimeModalOpen}=(0,index_esm.useValues)(modalsLogic.l),{experiment,minimumDetectableEffect,recommendedSampleSize,recommendedRunningTime,exposureEstimateConfig,metricResultLoading,uniqueUsers}=(0,index_esm.useValues)(runningTimeCalculatorLogic({experimentId})),{updateExperiment}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{setMinimumDetectableEffect,setExposureEstimateConfig}=(0,index_esm.useActions)(runningTimeCalculatorLogic({experimentId})),{closeCalculateRunningTimeModal}=(0,index_esm.useActions)(modalsLogic.l);return(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isCalculateRunningTimeModalOpen,onClose:closeCalculateRunningTimeModal,width:700,title:"Calculate estimated running time",footer:(0,jsx_runtime.jsx)(RunningTimeCalculatorModalFooter,{onClose:closeCalculateRunningTimeModal,onSave:()=>{updateExperiment({parameters:{...experiment?.parameters,exposure_estimate_config:exposureEstimateConfig,recommended_running_time:recommendedRunningTime,recommended_sample_size:recommendedSampleSize||void 0,minimum_detectable_effect:minimumDetectableEffect||void 0}}),closeCalculateRunningTimeModal()}}),children:[(0,jsx_runtime.jsx)(EventSelectorStep,{exposureEstimateConfig:exposureEstimateConfig,onSetFilter:filter=>setExposureEstimateConfig({...null!=exposureEstimateConfig?exposureEstimateConfig:{metric:null,conversionRateInputType:ConversionRateInputType.AUTOMATIC,manualConversionRate:null,uniqueUsers:null},eventFilter:{event:filter.id,name:filter.name,properties:filter.properties,entityType:"events"===filter.type?TaxonomicFilter_types.t.Events:TaxonomicFilter_types.t.Actions}})}),exposureEstimateConfig&&(0,jsx_runtime.jsx)(MetricSelectorStep,{onChangeMetric:metric=>setExposureEstimateConfig({...exposureEstimateConfig,metric}),onChangeFunnelConversionRateType:type=>setExposureEstimateConfig({...exposureEstimateConfig,conversionRateInputType:type})}),(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-6",children:!metricResultLoading&&null!==uniqueUsers&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(RunningTimeCalculatorModalStep,{stepNumber:3,title:"Choose minimum detectable effect",description:"The minimum detectable effect (MDE) is the smallest relative improvement you want to be able to detect with statistical significance. A smaller MDE requires more participants but can detect subtler changes.",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.DF,{className:"w-[80px]",min:0,step:1,type:"number",value:minimumDetectableEffect,onChange:newValue=>{newValue&&setMinimumDetectableEffect(newValue)}}),(0,jsx_runtime.jsx)("div",{children:"%"})]})}),null!==recommendedSampleSize&&null!==recommendedRunningTime&&(0,jsx_runtime.jsx)(RunningTimeCalculatorModalStep,{stepNumber:4,title:"Estimated experiment size & duration",description:"These are just statistical estimates â you can conclude the experiment earlier if a significant effect is detected. Running shorter may make results less reliable.",children:(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-2 gap-4 pt-2",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Recommended sample size"}),(0,jsx_runtime.jsxs)("div",{className:"text-lg font-semibold",children:["~",(0,utils.Lc)(recommendedSampleSize,0)," users"]})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Estimated running time"}),(0,jsx_runtime.jsxs)("div",{className:"text-lg font-semibold",children:["~",(0,utils.Lc)(recommendedRunningTime,1)," days"]})]})]})})]})})]})}var featureFlagLogic=__webpack_require__("../../frontend/src/scenes/feature-flags/featureFlagLogic.ts");function HoldoutSelector_HoldoutSelector(){let{experiment,holdouts,isExperimentRunning}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{setExperiment,reportExperimentHoldoutAssigned}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),holdoutOptions=holdouts.map(holdout=>({value:holdout.id,label:holdout.name}));return holdoutOptions.unshift({value:null,label:"No holdout"}),(0,jsx_runtime.jsxs)("div",{className:"mt-3",children:[(0,jsx_runtime.jsxs)("div",{className:"inline-flex deprecated-space-x-1",children:[(0,jsx_runtime.jsx)("h4",{className:"font-semibold mb-0",children:"Holdout group"}),(0,jsx_runtime.jsx)(src.u,{title:"Exclude a stable group of users from the experiment. This cannot be changed once the experiment is launched.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-base"})})]}),(0,jsx_runtime.jsx)("div",{className:"mt-1",children:(0,jsx_runtime.jsx)(src.Yv,{disabledReason:isExperimentRunning&&!experiment.end_date&&"The holdout group cannot be changed once the experiment is launched.",size:"xsmall",options:holdoutOptions,value:experiment.holdout_id||null,onChange:value=>{setExperiment({...experiment,holdout_id:value}),reportExperimentHoldoutAssigned({experimentId:experiment.id,holdoutId:value})},"data-attr":"experiment-holdout-selector"})})]})}var useUploadFiles=__webpack_require__("../../frontend/src/lib/hooks/useUploadFiles.ts");function VariantScreenshot(_ref){let{variantKey,rolloutPercentage}=_ref,{experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{updateExperimentVariantImages,reportExperimentVariantScreenshotUploaded}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),[mediaIds,setMediaIds]=(0,react.useState)((()=>{let variantImages=experiment.parameters?.variant_screenshot_media_ids?.[variantKey];return variantImages?Array.isArray(variantImages)?variantImages:[variantImages]:[]})()),[loadingImages,setLoadingImages]=(0,react.useState)({}),[selectedImageIndex,setSelectedImageIndex]=(0,react.useState)(null),{setFilesToUpload,filesToUpload,uploading}=(0,useUploadFiles.nc)({onUpload:(_,__,id)=>{if(id&&mediaIds.length<5){let newMediaIds=[...mediaIds,id];setMediaIds(newMediaIds),updateExperimentVariantImages({...experiment.parameters?.variant_screenshot_media_ids,[variantKey]:newMediaIds}),reportExperimentVariantScreenshotUploaded(experiment.id)}else mediaIds.length>=5&&src.UJ.error("Maximum of 5 images allowed")},onError:detail=>{src.UJ.error(`Error uploading image: ${detail}`)}}),handleImageLoad=mediaId=>{setLoadingImages(prev=>({...prev,[mediaId]:!1}))},handleImageError=mediaId=>{setLoadingImages(prev=>({...prev,[mediaId]:!1}))},handleDelete=indexToDelete=>{let newMediaIds=mediaIds.filter((_,index)=>index!==indexToDelete);setMediaIds(newMediaIds),updateExperimentVariantImages({...experiment.parameters?.variant_screenshot_media_ids,[variantKey]:newMediaIds})},widthClass=(()=>{switch(mediaIds.length<5?mediaIds.length+1:mediaIds.length){case 1:case 2:default:return"w-20";case 3:return"w-16";case 4:return"w-14";case 5:return"w-12"}})();return(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 items-start",children:[mediaIds.map((mediaId,index)=>(0,jsx_runtime.jsx)("div",{className:"relative",children:(0,jsx_runtime.jsx)("div",{className:"text-secondary inline-flex flow-row items-center gap-1 cursor-pointer",children:(0,jsx_runtime.jsxs)("div",{onClick:()=>setSelectedImageIndex(index),className:"cursor-zoom-in relative",children:[(0,jsx_runtime.jsxs)("div",{className:`relative flex overflow-hidden select-none ${widthClass} h-16 rounded before:absolute before:inset-0 before:border before:rounded`,children:[loadingImages[mediaId]&&(0,jsx_runtime.jsx)(src.yW,{className:"absolute inset-0"}),(0,jsx_runtime.jsx)("img",{className:"w-full h-full object-cover",src:mediaId.startsWith("data:")?mediaId:`/uploaded_media/${mediaId}`,onError:()=>handleImageError(mediaId),onLoad:()=>handleImageLoad(mediaId)})]}),(0,jsx_runtime.jsx)("div",{className:"absolute -inset-2 group",children:(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:e=>{e.stopPropagation(),handleDelete(index)},size:"small",tooltip:"Remove",tooltipPlacement:"right",noPadding:!0,className:"group-hover:flex hidden absolute right-0 top-0"})})]})})},mediaId)),mediaIds.length<5&&(0,jsx_runtime.jsx)("div",{className:`relative ${widthClass} h-16`,children:(0,jsx_runtime.jsx)(src.mH,{accept:"image/*",multiple:!1,onChange:setFilesToUpload,loading:uploading,value:filesToUpload,callToAction:(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center w-full h-16 border border-dashed rounded cursor-pointer hover:border-accent",children:(0,jsx_runtime.jsx)("span",{className:"text-2xl text-secondary",children:"+"})})})})]}),(0,jsx_runtime.jsx)(src.fQ,{isOpen:null!==selectedImageIndex,onClose:()=>setSelectedImageIndex(null),title:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsxs)("span",{children:["Screenshot ",null!==selectedImageIndex?selectedImageIndex+1:""]}),(0,jsx_runtime.jsx)(src.p2,{className:"my-0 mx-1",vertical:!0}),(0,jsx_runtime.jsx)(components.Aw,{experimentId:experiment.id,variantKey:variantKey}),void 0!==rolloutPercentage&&(0,jsx_runtime.jsxs)("span",{className:"text-secondary text-sm",children:["(",rolloutPercentage,"% rollout)"]})]}),children:null!==selectedImageIndex&&mediaIds[selectedImageIndex]&&(0,jsx_runtime.jsx)("img",{src:mediaIds[selectedImageIndex]?.startsWith("data:")?mediaIds[selectedImageIndex]:`/uploaded_media/${mediaIds[selectedImageIndex]}`,alt:`Screenshot ${selectedImageIndex+1}: ${variantKey}`,className:"max-w-full max-h-[80vh] overflow-auto"})})]})}function DistributionModal(_ref){var _experiment$feature_f;let{experimentId}=_ref,{experiment,experimentLoading}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{updateDistribution}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closeDistributionModal}=(0,index_esm.useActions)(modalsLogic.l),{isDistributionModalOpen}=(0,index_esm.useValues)(modalsLogic.l),_featureFlagLogic=(0,featureFlagLogic.hk)({id:null!==(_experiment$feature_f=experiment.feature_flag?.id)&&void 0!==_experiment$feature_f?_experiment$feature_f:null}),{featureFlag,areVariantRolloutsValid,variantRolloutSum}=(0,index_esm.useValues)(_featureFlagLogic),{setFeatureFlagFilters,distributeVariantsEqually}=(0,index_esm.useActions)(_featureFlagLogic),handleRolloutPercentageChange=(index,value)=>{if(!featureFlag?.filters?.multivariate)return;let numericValue=value||0,updatedVariants=featureFlag.filters.multivariate.variants.map((variant,i)=>i===index?{...variant,rollout_percentage:numericValue}:variant);setFeatureFlagFilters({...featureFlag.filters,multivariate:{...featureFlag.filters.multivariate,variants:updatedVariants}},null)};return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isDistributionModalOpen,onClose:closeDistributionModal,width:600,title:"Change experiment distribution",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:closeDistributionModal,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{updateDistribution(featureFlag),closeDistributionModal()},type:"primary",loading:experimentLoading,disabled:!areVariantRolloutsValid,children:"Save"})]}),children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:"Adjusting variant distribution may impact the validity of your results. Adjust only if you're aware of how changes will affect your experiment."}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold mb-0",children:"Variant distribution"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",onClick:distributeVariantsEqually,tooltip:"Redistribute variant rollout percentages equally",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconBalance,{}),children:"Distribute equally"})]}),(0,jsx_runtime.jsx)(src.g3,{dataSource:featureFlag?.filters?.multivariate?.variants||[],columns:[{title:"Variant",dataIndex:"key",render:value=>(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:value})},{title:"Rollout Percentage",dataIndex:"rollout_percentage",render:(_,record,index)=>(0,jsx_runtime.jsx)(src.DF,{type:"number",value:record.rollout_percentage,onChange:value=>handleRolloutPercentageChange(index,value),min:0,max:100,suffix:(0,jsx_runtime.jsx)("span",{children:"%"})})}]}),!areVariantRolloutsValid&&(0,jsx_runtime.jsxs)("p",{className:"text-danger mt-2",children:["Percentage rollouts must sum to 100 (currently ",variantRolloutSum,")."]})]}),(0,jsx_runtime.jsx)(HoldoutSelector_HoldoutSelector,{})]})})}function DistributionTable(){let{openDistributionModal}=(0,index_esm.useActions)(modalsLogic.l),{experimentId,experiment,legacyPrimaryMetricsResults}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{reportExperimentReleaseConditionsViewed}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),result=legacyPrimaryMetricsResults?.[0],onSelectElement=variant=>{src.dn.open({title:"Select a domain",description:"Choose the domain on which to preview this experiment variant",content:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(AuthorizedUrlList.t,{query:"?__experiment_id="+experiment?.id+"&__experiment_variant="+variant,experimentId:experiment?.id,type:authorizedUrlListLogic.uw.WEB_EXPERIMENTS})}),primaryButton:{children:"Close",type:"secondary"}})},className=experiment?.type==="web"?"w-1/2.5":"w-1/3",columns=[{className:className,key:"key",title:"Variant",render:function Key(_,item){return result&&result.insight?(0,jsx_runtime.jsx)(components.Aw,{experimentId:experimentId,variantKey:item.key}):(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:item.key})}},{className:className,key:"rollout_percentage",title:"Rollout",render:function Key(_,item){return(0,jsx_runtime.jsx)("div",{children:`${item.rollout_percentage}%`})}},{className:className,key:"variant_screenshot",title:"Screenshot",render:function Key(_,item){return item.key===`holdout-${experiment.holdout?.id}`?(0,jsx_runtime.jsx)("div",{className:"h-16"}):(0,jsx_runtime.jsx)("div",{className:"my-2",children:(0,jsx_runtime.jsx)(VariantScreenshot,{variantKey:item.key,rolloutPercentage:item.rollout_percentage})})}}];"web"===experiment.type&&columns.push({className:className,key:"preview_web_experiment",title:"Preview",render:function Key(_,item){return(0,jsx_runtime.jsx)("div",{className:"my-2",children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:e=>{e.preventDefault(),onSelectElement(item.key)},sideIcon:(0,jsx_runtime.jsx)(icons.UE,{}),children:"Preview variant"})})}});let holdoutData=experiment.holdout?[{key:`holdout-${experiment.holdout.id}`,rollout_percentage:experiment.holdout.filters[0].rollout_percentage}]:[],tableData=[...(experiment.feature_flag?.filters.multivariate?.variants||[]).map(variant=>({...variant,rollout_percentage:variant.rollout_percentage*((100-(experiment.holdout?.filters[0].rollout_percentage||0))/100)})),...holdoutData];return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/2",children:(0,jsx_runtime.jsx)("h2",{className:"font-semibold text-lg",children:"Distribution"})}),(0,jsx_runtime.jsx)("div",{className:"w-1/2 flex flex-col justify-end",children:(0,jsx_runtime.jsx)("div",{className:"ml-auto mb-2",children:(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconFlag,{}),onClick:()=>{openDistributionModal(),reportExperimentReleaseConditionsViewed(experiment.id)},type:"secondary",size:"xsmall",className:"font-semibold",children:"Manage distribution"})})})]}),experiment.holdout&&(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"mb-4",children:["This experiment has a holdout group of ",experiment.holdout.filters[0].rollout_percentage,"%. The variants are modified to show their relative rollout percentage."]}),(0,jsx_runtime.jsx)(src.g3,{loading:!1,columns:columns,dataSource:tableData,rowClassName:item=>item.key===`holdout-${experiment.holdout?.id}`?"dark:bg-fill-primary bg-mid":""})]})}var colors=__webpack_require__("../../frontend/src/lib/colors.ts");function getExposureCriteriaLabel(exposureCriteria){let exposureConfig=exposureCriteria?.exposure_config;return exposureConfig?`Custom (${exposureConfig.event})`:"Default ($feature_flag_called)"}function Exposures(){let{experimentId,exposures,exposuresLoading,exposureCriteria}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{openExposureCriteriaModal}=(0,index_esm.useActions)(modalsLogic.l),chartRef=(0,react.useRef)(null);(0,react.useEffect)(()=>{if(chartRef.current&&(chartRef.current.destroy(),chartRef.current=null),!exposures||!exposures?.timeseries?.length)return;let ctx=document.getElementById("exposuresChart");if(!ctx)return;let labels=exposures.timeseries[0].days,datasets=exposures.timeseries.map((series,index)=>({label:series.variant,data:series.exposure_counts,borderColor:(0,colors._r)(index),backgroundColor:(0,colors.qc)(index),fill:!1,tension:0,borderWidth:2,pointRadius:0}));1===exposures.timeseries[0].days.length&&(labels=[(0,dayjs.Bv)(labels[0]).subtract(1,"day").format("YYYY-MM-DD"),...labels],datasets=datasets.map(dataset=>({...dataset,data:[0,...dataset.data]})));let config={type:"line",data:{labels,datasets},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"nearest",axis:"x"},scales:{y:{beginAtZero:!0,grid:{display:!0}}},plugins:{legend:{display:!1,labels:{boxWidth:4,boxPadding:20,pointStyle:"dash"}},crosshair:!1}}};try{chartRef.current=new Chart.kL(ctx,config)}catch(error){console.error("Error creating chart:",error)}return()=>{chartRef.current&&(chartRef.current.destroy(),chartRef.current=null)}},[exposures]);let chartWrapperClasses="relative border rounded bg-surface-primary p-4 h-[280px]";return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center deprecated-space-x-2 mb-2",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0 font-semibold text-lg leading-6.5",children:"Exposures"}),(0,jsx_runtime.jsx)(src.u,{title:"Shows the daily cumulative count of unique users exposed to each variant throughout the experiment duration.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-lg"})})]}),exposuresLoading?(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)(chartWrapperClasses,"flex justify-center items-center"),children:(0,jsx_runtime.jsx)(src.$j,{className:"text-5xl"})}):exposures?.timeseries?.length?(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)(chartWrapperClasses,"w-full md:w-2/3"),children:(0,jsx_runtime.jsx)("canvas",{id:"exposuresChart"})}),(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)(chartWrapperClasses,"border rounded bg-surface-primary p-4"),children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-between mb-4",children:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h3",{className:"card-secondary",children:"Exposure criteria"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("div",{className:"text-sm font-semibold",children:getExposureCriteriaLabel(exposureCriteria)}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{fontSize:"12"}),size:"xsmall",className:"flex items-center gap-2",type:"secondary",onClick:()=>openExposureCriteriaModal()})]})]})}),exposures?.timeseries.length>0&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h3",{className:"card-secondary",children:"Total exposures"}),(0,jsx_runtime.jsx)("div",{className:"overflow-auto max-h-[150px]",children:(0,jsx_runtime.jsx)(src.g3,{dataSource:exposures?.timeseries||[],columns:[{title:"Variant",key:"variant",render:function Variant(_,series){return(0,jsx_runtime.jsx)(components.Aw,{experimentId:experimentId,variantKey:series.variant})}},{title:"Exposures",key:"exposures",render:function Exposures(_,series){return(0,utils.Lc)(exposures?.total_exposures[series.variant])}},{title:"%",key:"percentage",render:function Percentage(_,series){let total=0;if(exposures?.total_exposures)for(let[_,value]of Object.entries(exposures.total_exposures))total+=Number(value);return(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:total?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(exposures?.total_exposures[series.variant]/total*100).toFixed(1),"%"]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"-%"})})}}]})})]})]})]}):(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)(chartWrapperClasses,"flex justify-center items-center"),children:(0,jsx_runtime.jsxs)("div",{className:"text-center",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCorrelationAnalysis,{className:"text-3xl mb-2 text-tertiary"}),(0,jsx_runtime.jsx)("div",{className:"text-md font-semibold leading-tight mb-2",children:"No exposures yet"}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-center text-balance text-tertiary",children:"Exposures will appear here once the first participant has been exposed."}),(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{fontSize:"12"}),size:"xsmall",className:"flex items-center gap-2",type:"secondary",onClick:()=>openExposureCriteriaModal(),children:"Edit exposure criteria"})})]})})]})}function PreLaunchChecklist(){let{experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{openDescriptionModal,openPrimaryMetricSourceModal,openCalculateRunningTimeModal}=(0,index_esm.useActions)(modalsLogic.l);return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"flex items-center deprecated-space-x-2 mb-2",children:(0,jsx_runtime.jsx)("h2",{className:"mb-0 font-semibold text-lg leading-6",children:"Pre-launch checklist"})}),(0,jsx_runtime.jsx)("div",{className:"bg-bg-light rounded p-4 border",children:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-3 mb-6",children:[experiment.description?(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{className:"text-success flex-none w-6 h-6"}):(0,jsx_runtime.jsx)("div",{className:"flex-none w-5 h-5 rounded-full border-2 border-orange"}),(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[(0,jsx_runtime.jsx)("div",{className:`text-xs font-semibold ${experiment.description?"text-success":""}`,children:"Step 1"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:`font-semibold ${experiment.description?"text-muted line-through":""}`,children:"Add hypothesis"}),(0,jsx_runtime.jsx)("div",{className:`text-sm ${experiment.description?"text-muted line-through":"text-muted"}`,children:"Document what you expect to learn from this experiment"})]}),!experiment.description&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>{openDescriptionModal()},children:"Add hypothesis"})]})]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-3 mb-6",children:[experiment.metrics?.length>0?(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{className:"text-success flex-none w-6 h-6"}):(0,jsx_runtime.jsx)("div",{className:"flex-none w-5 h-5 rounded-full border-2 border-orange"}),(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[(0,jsx_runtime.jsx)("div",{className:`text-xs font-semibold ${experiment.metrics?.length>0?"text-success":""}`,children:"Step 2"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:`font-semibold ${experiment.metrics?.length>0?"text-muted line-through":""}`,children:"Add first metric"}),(0,jsx_runtime.jsx)("div",{className:`text-sm ${experiment.metrics?.length>0?"text-muted line-through":"text-muted"}`,children:"Define your experiment's primary success metric"})]}),!(experiment.metrics?.length>0)&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>{openPrimaryMetricSourceModal()},children:"Add metric"})]})]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-3",children:[experiment.parameters?.recommended_running_time?(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{className:"text-success flex-none w-6 h-6"}):(0,jsx_runtime.jsx)("div",{className:"flex-none w-5 h-5 rounded-full border-2 border-orange"}),(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[(0,jsx_runtime.jsx)("div",{className:`text-xs font-semibold ${experiment.parameters?.recommended_running_time?"text-success":""}`,children:"Step 3"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:`font-semibold ${experiment.parameters?.recommended_running_time?"text-muted line-through":""}`,children:"Calculate experiment duration"}),(0,jsx_runtime.jsx)("div",{className:`text-sm ${experiment.parameters?.recommended_running_time?"text-muted line-through":"text-muted"}`,children:"Determine how long your experiment needs to run"})]}),!experiment.parameters?.recommended_running_time&&experiment.metrics?.length>0&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:openCalculateRunningTimeModal,children:"Calculate"})]})]})]})]})})]})}function RunningTime(){let{experiment,actualRunningTime}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{openCalculateRunningTimeModal}=(0,index_esm.useActions)(modalsLogic.l),recommendedSampleSize=experiment.parameters.recommended_sample_size,minimumDetectableEffect=experiment.parameters.minimum_detectable_effect,recommendedRunningTime=experiment.parameters.recommended_running_time;return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center deprecated-space-x-2 mb-2",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0 font-semibold text-lg leading-6",children:"Running time"}),recommendedRunningTime?(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{fontSize:"12"}),size:"xsmall",className:"flex items-center gap-2",type:"secondary",onClick:()=>openCalculateRunningTimeModal()}):null]}),(0,jsx_runtime.jsx)("div",{className:"relative border rounded bg-surface-primary p-4 h-[280px] overflow-y-auto",children:recommendedSampleSize&&recommendedRunningTime?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonProgress.b,{className:"w-full border",bgColor:"var(--bg-table)",size:"medium",percent:actualRunningTime/recommendedRunningTime*100}),(0,jsx_runtime.jsxs)("div",{className:"text-center mt-2 mb-4 text-xs text-muted",children:[actualRunningTime," of ",(0,utils.Lc)(recommendedRunningTime,0)," days completed (",Math.round(actualRunningTime/recommendedRunningTime*100),"%)"]}),(0,jsx_runtime.jsxs)("div",{className:"space-y-3",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary mb-1",children:"Recommended sample size"}),(0,jsx_runtime.jsxs)("div",{className:"text-sm font-semibold",children:[(0,utils.Lc)(recommendedSampleSize,0)," users"]})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary mb-1",children:"Estimated running time"}),(0,jsx_runtime.jsxs)("div",{className:"text-sm font-semibold",children:[(0,utils.Lc)(recommendedRunningTime,0)," days"]})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary mb-1",children:"Minimum detectable effect"}),(0,jsx_runtime.jsxs)("div",{className:"text-sm font-semibold",children:[minimumDetectableEffect,"%"]})]})]})]}):(0,jsx_runtime.jsx)("div",{className:"flex justify-center items-center h-full",children:(0,jsx_runtime.jsxs)("div",{className:"text-center",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalculator,{className:"text-3xl mb-2 text-tertiary"}),(0,jsx_runtime.jsx)("div",{className:"text-md font-semibold leading-tight mb-3",children:"No running time yet"}),(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{fontSize:"12"}),size:"xsmall",className:"flex items-center gap-2",type:"secondary",onClick:()=>openCalculateRunningTimeModal(),children:"Calculate running time"})})]})})})]})}function ExperimentHeader(){let{isExperimentRunning}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!isExperimentRunning&&(0,jsx_runtime.jsx)("div",{className:"w-1/2",children:(0,jsx_runtime.jsx)(PreLaunchChecklist,{})}),(0,jsx_runtime.jsxs)("div",{className:"flex w-full space-x-4",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/4",children:(0,jsx_runtime.jsx)(RunningTime,{})}),(0,jsx_runtime.jsx)("div",{className:"w-3/4",children:(0,jsx_runtime.jsx)(Exposures,{})})]})]})}function ExposureCriteriaModal(){let{experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{restoreUnmodifiedExperiment,setExposureCriteria,updateExposureCriteria}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{closeExposureCriteriaModal}=(0,index_esm.useActions)(modalsLogic.l),{isExposureCriteriaModalOpen}=(0,index_esm.useValues)(modalsLogic.l),{currentTeam}=(0,index_esm.useValues)(teamLogic.teamLogic),hasFilters=(currentTeam?.test_account_filters||[]).length>0;return(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isExposureCriteriaModalOpen,onClose:closeExposureCriteriaModal,width:860,title:"Edit exposure criteria",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-exposure-form",type:"secondary",onClick:()=>{restoreUnmodifiedExperiment(),closeExposureCriteriaModal()},children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-exposure-form",onClick:()=>{updateExposureCriteria(),closeExposureCriteriaModal()},type:"primary",children:"Save"})]}),children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsxs)(src.Jp,{className:`trends-metric-form__exposure-button flex-1 cursor-pointer p-4 rounded border ${experiment.exposure_criteria?.exposure_config?"border-primary":"border-accent bg-accent-highlight-secondary"}`,onClick:()=>{setExposureCriteria({exposure_config:void 0})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Default"}),!experiment.exposure_criteria?.exposure_config&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--accent)"})]}),(0,jsx_runtime.jsxs)("div",{className:"text-secondary text-sm leading-relaxed mt-1",children:["When a ",(0,jsx_runtime.jsx)(src.oe,{children:"$feature_flag_called"})," event is recorded, a user is considered"," ",(0,jsx_runtime.jsx)("strong",{children:"exposed"})," to the experiment and included in the analysis."]})]}),(0,jsx_runtime.jsxs)(src.Jp,{className:`trends-metric-form__exposure-button flex-1 cursor-pointer p-4 rounded border ${experiment.exposure_criteria?.exposure_config?"border-accent bg-accent-highlight-secondary":"border-primary"}`,onClick:()=>{setExposureCriteria({exposure_config:{kind:schema_general.OH.ExperimentEventExposureConfig,event:"$feature_flag_called",properties:[]}})},children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{children:"Custom"}),experiment.exposure_criteria?.exposure_config&&(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{fontSize:18,color:"var(--accent)"})]}),(0,jsx_runtime.jsxs)("div",{className:"text-secondary text-sm leading-relaxed mt-1",children:["If you can't rely on the ",(0,jsx_runtime.jsx)(src.oe,{children:"$feature_flag_called"})," event, you can select a custom event to signal that users reached the part of your app where the experiment runs. You can also filter out users you would like to exclude from the analysis."]})]})]}),experiment.exposure_criteria?.exposure_config&&(0,jsx_runtime.jsx)("div",{className:"mb-4",children:(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,experiments_utils.m3)(experiment.exposure_criteria.exposure_config),setFilters:_ref=>{let{events}=_ref,entity=events?.[0];entity&&setExposureCriteria({exposure_config:(0,experiments_utils.ZE)(entity)})},typeKey:"experiment-exposure-config",buttonCopy:"Add graph series",showSeriesIndicator:!0,hideRename:!0,entitiesLimit:1,mathAvailability:ActionFilterRow.Qq.None,showNumericalPropsOnly:!0,actionsTaxonomicGroupTypes:[TaxonomicFilter_types.t.Events],propertiesTaxonomicGroupTypes:Selectors.dF.propertiesTaxonomicGroupTypes})}),(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)("label",{className:"block text-sm font-medium text-default mb-2",children:"Multiple variant handling"}),(0,jsx_runtime.jsx)(src.Yv,{value:experiment.exposure_criteria?.multiple_variant_handling||"exclude",onChange:value=>{setExposureCriteria({multiple_variant_handling:value})},options:[{value:"exclude",label:"Exclude from analysis","data-attr":"multiple-handling-exclude"},{value:"first_seen",label:"Use first seen variant","data-attr":"multiple-handling-first-seen"}],placeholder:"Select handling method",fullWidth:!0}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-muted mt-1",children:[experiment.exposure_criteria?.multiple_variant_handling==="first_seen"&&"Users exposed to multiple variants will be analyzed using their first seen variant.",(!experiment.exposure_criteria?.multiple_variant_handling||experiment.exposure_criteria?.multiple_variant_handling==="exclude")&&"Users exposed to multiple variants will be excluded from the analysis (recommended)."]})]}),(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=experiment.exposure_criteria?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{setExposureCriteria({filterTestAccounts:checked})},fullWidth:!0})]})}var Info=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentView/Info.tsx"),LoadingBar=__webpack_require__("../../frontend/src/lib/lemon-ui/LoadingBar/index.ts"),LemonSlider=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSlider/index.ts"),insightLogic=__webpack_require__("../../frontend/src/scenes/insights/insightLogic.tsx");function FunnelCalculation(_ref){let{experimentId}=_ref,{minimumDetectableEffect,experiment,conversionMetrics,recommendedRunningTime,variants}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),funnelConversionRate=conversionMetrics?.totalRate*100||0,conversionRate=100*conversionMetrics.totalRate,funnelSampleSize=(0,legacyExperimentCalculations.nu)(minimumDetectableEffect,conversionRate)*variants.length,baselineConversionRate=funnelConversionRate.toFixed(1),minimumAcceptableConversionRate=(funnelConversionRate+(minimumDetectableEffect||5)).toFixed(1),recommendedSampleSize=(0,utils.Lc)(funnelSampleSize||0);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap",children:[!experiment?.start_date&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4 w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Baseline Conversion Rate"}),(0,jsx_runtime.jsxs)("div",{className:"l4",children:[baselineConversionRate,"%"]})]}),(0,jsx_runtime.jsxs)("div",{className:"mb-4 w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Minimum Acceptable Conversion Rate"}),(0,jsx_runtime.jsxs)("div",{className:"l4",children:[minimumAcceptableConversionRate,"%"]})]})]}),(0,jsx_runtime.jsxs)("div",{className:"w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Recommended Sample Size"}),(0,jsx_runtime.jsxs)("div",{className:"pb-4",children:[(0,jsx_runtime.jsxs)("span",{className:"l4",children:["~",recommendedSampleSize]})," persons"]})]}),!experiment?.start_date&&(0,jsx_runtime.jsxs)("div",{className:"w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Recommended running time"}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("span",{className:"l4",children:["~",recommendedRunningTime]})," days"]})]})]})}function TrendCalculation(_ref2){let{experimentId}=_ref2,{minimumDetectableEffect,experiment,trendResults}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),trendCount=trendResults[0]?.count||0,trendExposure=(0,legacyExperimentCalculations.j$)(minimumDetectableEffect,trendCount),baselineCount=(0,utils.Lc)(trendCount||0),minimumAcceptableCount=(0,utils.Lc)(trendCount+Math.ceil((minimumDetectableEffect||5)/100*trendCount)||0),recommendedRunningTime=(0,utils.Lc)(trendExposure||0);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap",children:[!experiment?.start_date&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4 w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Baseline Count"}),(0,jsx_runtime.jsx)("div",{className:"l4",children:baselineCount})]}),(0,jsx_runtime.jsxs)("div",{className:"mb-4 w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Minimum Acceptable Count"}),(0,jsx_runtime.jsx)("div",{className:"l4",children:minimumAcceptableCount})]})]}),(0,jsx_runtime.jsxs)("div",{className:"w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Recommended running time"}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("span",{className:"l4",children:["~",recommendedRunningTime]})," days"]})]})]})}function DataCollectionCalculator(_ref3){let{experimentId}=_ref3,{getInsightType,firstPrimaryMetric,minimumDetectableEffect,experiment,conversionMetrics}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{setExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),insightType=getInsightType(firstPrimaryMetric),insightLogicInstance=(0,insightLogic.zm)({dashboardItemId:insightType===types.dw.FUNNELS?experiments_constants.Wx.Funnels:experiments_constants.Wx.Trends,syncWithUrl:!1}),{insightProps}=(0,index_esm.useValues)(insightLogicInstance),query=null;experiment.metrics.length>0&&(query={kind:schema_general.OH.InsightVizNode,source:insightType===types.dw.FUNNELS?firstPrimaryMetric.funnels_query:firstPrimaryMetric.count_query});let funnelConversionRate=conversionMetrics?.totalRate*100||0,sliderMaxValue=0;return sliderMaxValue=insightType===types.dw.FUNNELS?100-funnelConversionRate<50?100-funnelConversionRate:50:100,(0,jsx_runtime.jsx)("div",{className:"flex",children:(0,jsx_runtime.jsxs)("div",{className:"w-full",children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4 experiment-preview-row",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)("b",{children:"Minimum detectable effect"}),(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"The Minimum detectable effect represents the smallest change that you want to be able to detect in your experiment."}),(0,jsx_runtime.jsx)("div",{children:"To make things easier, we initially set this value to a reasonable default. However, we encourage you to review and adjust it based on your specific goals."}),(0,jsx_runtime.jsxs)("div",{children:["Read more in the"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/experiments/sample-size-running-time#minimum-detectable-effect-mde",children:"documentation."})]})]}),closeDelayMs:200,children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-base ml-1"})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonSlider.j,{value:minimumDetectableEffect,min:1,max:sliderMaxValue,step:1,onChange:value=>{setExperiment({parameters:{...experiment.parameters,minimum_detectable_effect:value}})},className:"w-5/6"}),(0,jsx_runtime.jsx)(src.DF,{className:"w-1/6","data-attr":"min-detectable-effect",type:"number",min:1,max:sliderMaxValue,defaultValue:5,suffix:(0,jsx_runtime.jsx)("span",{children:"%"}),value:minimumDetectableEffect,onChange:value=>{value&&setExperiment({parameters:{...experiment.parameters,minimum_detectable_effect:value}})}})]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col experiment-preview-row",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"info",className:"mb-4",children:"The calculations are based on the events received in the last 14 days. This event count may differ from what was considered in earlier estimates."}),insightType===types.dw.TRENDS?(0,jsx_runtime.jsx)(TrendCalculation,{experimentId:experimentId}):(0,jsx_runtime.jsx)(FunnelCalculation,{experimentId:experimentId}),(0,jsx_runtime.jsx)("div",{className:"hidden",children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:insightLogic.zm,props:insightProps,children:(0,jsx_runtime.jsx)(Query.A,{query:query,context:{insightProps},readOnly:!0})})})]})]})})}function DataCollection(){let{experimentId,experiment,getInsightType,funnelResultsPersonsTotal,actualRunningTime,minimumDetectableEffect,firstPrimaryMetric}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{openExperimentCollectionGoalModal}=(0,index_esm.useActions)(modalsLogic.l),insightType=getInsightType(firstPrimaryMetric),recommendedRunningTime=experiment?.parameters?.recommended_running_time||1,recommendedSampleSize=experiment?.parameters?.recommended_sample_size||100,experimentProgressPercent=insightType===types.dw.FUNNELS?funnelResultsPersonsTotal(0)/recommendedSampleSize*100:actualRunningTime/recommendedRunningTime*100,hasHighRunningTime=recommendedRunningTime>62,GoalTooltip=()=>experiment?.parameters?.minimum_detectable_effect?(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{children:`Based on the Minimum detectable effect of ${experiment.parameters.minimum_detectable_effect}%.`}),hasHighRunningTime&&(0,jsx_runtime.jsx)("div",{className:"mt-2",children:"Given the current data, this experiment might take a while to reach statistical significance. Please make sure events are being tracked correctly and consider if this timeline works for you."})]}),children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-base"})}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"inline-flex items-center deprecated-space-x-2",children:[(0,jsx_runtime.jsx)("h2",{className:"font-semibold text-lg mb-0",children:"Data collection"}),(0,jsx_runtime.jsx)(src.u,{title:"Estimated target for the number of participants. Actual data may reveal significance earlier or later than predicted.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-base"})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsxs)("div",{className:"w-3/5 pr-4",children:[(0,jsx_runtime.jsx)("div",{className:"mt-2 mb-1 font-semibold",children:`${experimentProgressPercent>100?100:experimentProgressPercent.toFixed(2)}% complete`}),(0,jsx_runtime.jsx)(LemonProgress.b,{className:"w-full border",bgColor:"var(--bg-table)",size:"medium",percent:experimentProgressPercent}),insightType===types.dw.TRENDS&&(0,jsx_runtime.jsx)("div",{className:"flex justify-between mt-0",children:(0,jsx_runtime.jsxs)("span",{className:"flex items-center text-xs",children:["CompletedÂ ",(0,jsx_runtime.jsxs)("b",{children:[actualRunningTime," of"]}),hasHighRunningTime?(0,jsx_runtime.jsx)("b",{children:"Â  > 60 days"}):(0,jsx_runtime.jsxs)("span",{children:["Â ",(0,jsx_runtime.jsx)("b",{children:recommendedRunningTime})," ",(0,experiments_utils.Du)(recommendedRunningTime,"day")]}),(0,jsx_runtime.jsx)("span",{className:"ml-1 text-xs",children:(0,jsx_runtime.jsx)(GoalTooltip,{})})]})}),insightType===types.dw.FUNNELS&&(0,jsx_runtime.jsx)("div",{className:"flex justify-between mt-0",children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-x-1 flex items-center text-xs",children:[(0,jsx_runtime.jsxs)("span",{children:["SawÂ ",(0,jsx_runtime.jsxs)("b",{children:[(0,utils.Lc)(funnelResultsPersonsTotal(0))," of"," ",(0,utils.Lc)(recommendedSampleSize)," "]})," ",(0,experiments_utils.Du)(recommendedSampleSize,"participant")]}),(0,jsx_runtime.jsx)(GoalTooltip,{})]})})]}),(0,jsx_runtime.jsx)(src.p2,{className:"my-0",vertical:!0}),(0,jsx_runtime.jsxs)("div",{className:"w-2/5 pl-4",children:[(0,jsx_runtime.jsxs)("div",{className:`text-lg font-semibold ${experiment.end_date?"mt-4":""}`,children:[minimumDetectableEffect,"%"]}),(0,jsx_runtime.jsxs)("div",{className:"text-xs deprecated-space-x-1 text-sm flex",children:[(0,jsx_runtime.jsx)("span",{children:"Minimum detectable effect"}),(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"The Minimum detectable effect represents the smallest change that you want to be able to detect in your experiment."}),(0,jsx_runtime.jsx)("div",{children:"To make things easier, we initially set this value to a reasonable default. However, we encourage you to review and adjust it based on your specific goals."}),(0,jsx_runtime.jsxs)("div",{children:["Read more in the"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/experiments/sample-size-running-time#minimum-detectable-effect-mde",children:"documentation."})]})]}),closeDelayMs:200,children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-base"})})]}),!experiment.end_date&&(0,jsx_runtime.jsx)("div",{className:"w-24",children:(0,jsx_runtime.jsx)(src.Jp,{className:"mt-2",size:"xsmall",type:"secondary",onClick:openExperimentCollectionGoalModal,children:(0,jsx_runtime.jsx)("span",{className:"px-0",children:"Edit"})})}),(0,jsx_runtime.jsx)(DataCollectionGoalModal,{experimentId:experimentId})]})]})]})}function DataCollectionGoalModal(_ref){let{experimentId}=_ref,{getInsightType,firstPrimaryMetric,trendMetricInsightLoading,funnelMetricInsightLoading}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{updateExperimentCollectionGoal,restoreUnmodifiedExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closeExperimentCollectionGoalModal}=(0,index_esm.useActions)(modalsLogic.l),{isExperimentCollectionGoalModalOpen}=(0,index_esm.useValues)(modalsLogic.l),isInsightLoading=getInsightType(firstPrimaryMetric)===types.dw.TRENDS?trendMetricInsightLoading:funnelMetricInsightLoading;return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isExperimentCollectionGoalModalOpen,onClose:closeExperimentCollectionGoalModal,width:550,title:"Recalculate estimated sample size",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-exposure-form",type:"secondary",onClick:()=>{restoreUnmodifiedExperiment(),closeExperimentCollectionGoalModal()},children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-exposure-form",onClick:()=>{updateExperimentCollectionGoal(),closeExperimentCollectionGoalModal()},type:"primary","data-attr":"create-annotation-submit",children:"Save"})]}),children:isInsightLoading?(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1 justify-center items-center mb-6",children:[(0,jsx_runtime.jsx)(LoadingBar.F,{}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-secondary w-60",children:[(0,jsx_runtime.jsx)("span",{className:"mr-1",children:"Fetching past events for the estimation"}),(0,jsx_runtime.jsx)(components.QT,{})]})]}):(0,jsx_runtime.jsx)(DataCollectionCalculator,{experimentId:experimentId})})}function LegacyExperimentHeader(){return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("div",{className:"w-1/2 mt-8 xl:mt-0",children:(0,jsx_runtime.jsx)(DataCollection,{})})})}var FeatureFlagReleaseConditions=__webpack_require__("../../frontend/src/scenes/feature-flags/FeatureFlagReleaseConditions.tsx"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts");function ReleaseConditionsModal(_ref){var _experiment$feature_f,_featureFlag$filters;let{experimentId}=_ref,{experiment}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{closeReleaseConditionsModal}=(0,index_esm.useActions)(modalsLogic.l),{isReleaseConditionsModalOpen}=(0,index_esm.useValues)(modalsLogic.l),_featureFlagLogic=(0,featureFlagLogic.hk)({id:null!==(_experiment$feature_f=experiment.feature_flag?.id)&&void 0!==_experiment$feature_f?_experiment$feature_f:null}),{featureFlag,nonEmptyVariants}=(0,index_esm.useValues)(_featureFlagLogic),{setFeatureFlagFilters,saveSidebarExperimentFeatureFlag}=(0,index_esm.useActions)(_featureFlagLogic);return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isReleaseConditionsModalOpen,onClose:closeReleaseConditionsModal,width:600,title:"Change release conditions",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:closeReleaseConditionsModal,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{saveSidebarExperimentFeatureFlag(featureFlag),closeReleaseConditionsModal()},type:"primary",children:"Save"})]}),children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:"Adjusting user targeting may impact the validity of your results. Adjust only if you're aware of how changes will affect your experiment."}),(0,jsx_runtime.jsx)(FeatureFlagReleaseConditions.I,{id:`${experiment.feature_flag?.id}`,filters:null!==(_featureFlag$filters=featureFlag?.filters)&&void 0!==_featureFlag$filters?_featureFlag$filters:[],onChange:setFeatureFlagFilters,nonEmptyFeatureFlagVariants:nonEmptyVariants})]})})}function ReleaseConditionsTable(){let{experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{reportExperimentReleaseConditionsViewed}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{openReleaseConditionsModal}=(0,index_esm.useActions)(modalsLogic.l),{aggregationLabel}=(0,index_esm.useValues)(groupsModel.$),columns=[{key:"key",title:"",render:function Key(_,_item,index){return(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:`Set ${index+1}`})}},{key:"rollout_percentage",title:"Rollout",render:function Key(_,item){let aggregationTargetName=null!=experiment.filters.aggregation_group_type_index?aggregationLabel(experiment.filters.aggregation_group_type_index).plural:"users",releaseText=`${item.rollout_percentage}% of ${aggregationTargetName}`;return(0,jsx_runtime.jsx)("div",{children:releaseText.startsWith("100% of")?(0,jsx_runtime.jsx)(src.oe,{type:"highlight",children:releaseText}):releaseText})}},{key:"variant",title:"Override",render:function Key(_,item){return(0,jsx_runtime.jsx)("div",{children:item.variant||"--"})}}];return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/2",children:(0,jsx_runtime.jsx)("h2",{className:"font-semibold text-lg",children:"Release conditions"})}),(0,jsx_runtime.jsx)("div",{className:"w-1/2 flex flex-col justify-end",children:(0,jsx_runtime.jsx)("div",{className:"ml-auto mb-2",children:(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconFlag,{}),onClick:()=>{openReleaseConditionsModal(),reportExperimentReleaseConditionsViewed(experiment.id)},type:"secondary",size:"xsmall",className:"font-semibold",children:"Manage release conditions"})})})]}),(0,jsx_runtime.jsx)(src.g3,{loading:!1,columns:columns,dataSource:experiment.feature_flag?.filters.groups||[]})]})}let ResultsTab=()=>{let{experiment,legacyPrimaryMetricsResults,firstPrimaryMetric,primaryMetricsLengthWithSharedMetrics,primaryMetricsResultsLoading,hasMinimumExposureForResults}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),hasSomeResults=legacyPrimaryMetricsResults?.some(result=>result?.insight),hasSinglePrimaryMetric=1===primaryMetricsLengthWithSharedMetrics,firstPrimaryMetricResult=legacyPrimaryMetricsResults?.[0];return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!experiment.start_date&&!primaryMetricsResultsLoading&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"web"===experiment.type?(0,jsx_runtime.jsx)(WebExperimentImplementationDetails,{experiment:experiment}):(0,jsx_runtime.jsx)(ExperimentImplementationDetails.aK,{experiment:experiment})}),hasSinglePrimaryMetric&&hasMinimumExposureForResults&&(0,jsx_runtime.jsx)("div",{className:"mb-4 mt-2",children:(0,jsx_runtime.jsx)(Overview,{})}),legacyPrimaryMetricsResults.length>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(MetricsViewLegacy,{isSecondary:!1}),hasSomeResults&&hasMinimumExposureForResults&&hasSinglePrimaryMetric&&firstPrimaryMetric&&firstPrimaryMetricResult&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"pb-4",children:(0,jsx_runtime.jsx)(SummaryTable.H,{metric:firstPrimaryMetric,metricIndex:0,isSecondary:!1})}),(0,experiments_utils.C1)(firstPrimaryMetricResult)?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(components.bD,{result:firstPrimaryMetricResult,size:"xsmall"})}),(0,jsx_runtime.jsx)("div",{className:"pb-4",children:(0,jsx_runtime.jsx)(components.TX,{result:firstPrimaryMetricResult||null,showTable:!0})})]}):(0,jsx_runtime.jsx)(ResultsBreakdown,{result:firstPrimaryMetricResult,experiment:experiment,metricIndex:0,isPrimary:!0,children:_ref=>{let{query,breakdownResults,breakdownResultsLoading,exposureDifference}=_ref;return(0,jsx_runtime.jsxs)("div",{children:[breakdownResultsLoading&&(0,jsx_runtime.jsx)(ResultsBreakdownSkeleton,{}),query&&breakdownResults&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(ExploreAsInsightButton,{query:query})}),(0,jsx_runtime.jsx)(ResultsInsightInfoBanner,{exposureDifference:exposureDifference}),(0,jsx_runtime.jsx)("div",{className:"pb-4",children:(0,jsx_runtime.jsx)(ResultsQuery,{query:query,breakdownResults:breakdownResults})})]})]})}})]}),(0,jsx_runtime.jsx)(MetricsViewLegacy,{isSecondary:!0})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(Metrics,{isSecondary:!1}),(0,jsx_runtime.jsx)(Metrics,{isSecondary:!0})]})]})},VariantsTab=()=>(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-8 mt-2",children:[(0,jsx_runtime.jsx)(ReleaseConditionsTable,{}),(0,jsx_runtime.jsx)(DistributionTable,{})]});function ExperimentView(){let{experimentLoading,experimentId,tabKey,usesNewQueryRunner}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{setTabKey}=(0,index_esm.useActions)(experiments_experimentLogic.Wl);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(components.nt,{}),(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-8 experiment-view",children:experimentLoading?(0,jsx_runtime.jsx)(components.Gu,{}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(Info.k,{}),usesNewQueryRunner?(0,jsx_runtime.jsx)(ExperimentHeader,{}):(0,jsx_runtime.jsx)(LegacyExperimentHeader,{}),(0,jsx_runtime.jsx)(src.TP,{activeKey:tabKey,onChange:key=>setTabKey(key),tabs:[{key:"results",label:"Results",content:(0,jsx_runtime.jsx)(ResultsTab,{})},{key:"variants",label:"Variants",content:(0,jsx_runtime.jsx)(VariantsTab,{})}]}),(0,jsx_runtime.jsx)(MetricSourceModal,{experimentId:experimentId,isSecondary:!0}),(0,jsx_runtime.jsx)(MetricSourceModal,{experimentId:experimentId,isSecondary:!1}),usesNewQueryRunner?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ExperimentMetricModal,{experimentId:experimentId,isSecondary:!0}),(0,jsx_runtime.jsx)(ExperimentMetricModal,{experimentId:experimentId,isSecondary:!1}),(0,jsx_runtime.jsx)(ExposureCriteriaModal,{}),(0,jsx_runtime.jsx)(RunningTimeCalculatorModal,{})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LegacyMetricModal,{experimentId:experimentId,isSecondary:!0}),(0,jsx_runtime.jsx)(LegacyMetricModal,{experimentId:experimentId,isSecondary:!1})]}),(0,jsx_runtime.jsx)(SharedMetricModal,{experimentId:experimentId,isSecondary:!0}),(0,jsx_runtime.jsx)(SharedMetricModal,{experimentId:experimentId,isSecondary:!1}),(0,jsx_runtime.jsx)(DistributionModal,{experimentId:experimentId}),(0,jsx_runtime.jsx)(ReleaseConditionsModal,{experimentId:experimentId}),(0,jsx_runtime.jsx)(components.WV,{experimentId:experimentId}),(0,jsx_runtime.jsx)(components.jQ,{experimentId:experimentId}),(0,jsx_runtime.jsx)(VariantDeltaTimeseries,{})]})})]})}let scene={component:Experiment,logic:experiments_experimentLogic.Wl,paramsToProps:_ref=>{let{params:{id,formMode}}=_ref;return{experimentId:"new"===id?"new":parseInt(id,10),formMode:formMode||("new"===id?experiments_experimentLogic.SI.create:experiments_experimentLogic.SI.update)}}};function Experiment(){let{formMode,experimentMissing}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);return experimentMissing?(0,jsx_runtime.jsx)(NotFound.T,{object:"experiment"}):[experiments_experimentLogic.SI.create,experiments_experimentLogic.SI.duplicate].includes(formMode)?(0,jsx_runtime.jsx)(ExperimentForm,{}):(0,jsx_runtime.jsx)(ExperimentView,{})}},"../../frontend/src/scenes/experiments/ExperimentImplementationDetails.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{aK:()=>ExperimentImplementationDetails,JY:()=>OPTIONS});var src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),types=__webpack_require__("../../frontend/src/types.ts"),CodeSnippet=__webpack_require__("../../frontend/src/lib/components/CodeSnippet/index.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function ServerSideWarning(){return(0,jsx_runtime.jsx)("div",{className:"warning",children:(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("b",{children:"Warning:"})," Server side experiment metrics require you to manually send the feature flag information."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/experiments/adding-experiment-code",target:"_blank",children:"See this tutorial for more information."})]})})}function AndroidSnippet(_ref){let{flagKey,variant}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Kotlin,wrap:!0,children:`if (PostHog.getFeatureFlag("${flagKey}") == "${variant}") {
    // do something
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`})})}function IOSSnippet(_ref2){let{flagKey,variant}=_ref2;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Swift,wrap:!0,children:`if (PostHogSDK.shared.getFeatureFlag("${flagKey}") as? String == "${variant}") {
    // do something
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`})})}function NodeJSSnippet(_ref3){let{flagKey,variant}=_ref3;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.JavaScript,wrap:!0,children:`const experimentFlagValue = await client.getFeatureFlag('${flagKey}', 'user distinct id')

if (experimentFlagValue === '${variant}' ) {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}function JSSnippet(_ref4){let{flagKey,variant}=_ref4;return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.JavaScript,wrap:!0,children:`if (posthog.getFeatureFlag('${flagKey}') === '${variant}') {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`}),(0,jsx_runtime.jsx)("div",{className:"mt-4 mb-1",children:(0,jsx_runtime.jsx)("b",{children:"Test that it works"})}),(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.JavaScript,wrap:!0,children:`posthog.featureFlags.overrideFeatureFlags({ flags: {'${flagKey}': '${variant}'} })`})]})}function ReactSnippet(_ref5){let{flagKey,variant}=_ref5;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.JavaScript,wrap:!0,children:`// You can either use the useFeatureFlagVariantKey hook,
// or you can use the feature flags component - https://posthog.com/docs/libraries/react#feature-flags-react-component

// Method one: using the useFeatureFlagVariantKey hook
import { useFeatureFlagVariantKey } from 'posthog-js/react'

function App() {
    const variant = useFeatureFlagVariantKey('${flagKey}')
    if (variant === '${variant}') {
        // do something
    }
}

// Method two: using the feature flags component
import { PostHogFeature } from 'posthog-js/react'

function App() {
    return (
        <PostHogFeature flag='${flagKey}' match='${variant}'>
            <div>
                {/* the component to show */}
            </div>
        </PostHogFeature>
    )
}

// You can also test your code by overriding the feature flag:
posthog.featureFlags.overrideFeatureFlags({ flags: {'${flagKey}': '${variant}'} })`})})}function RNSnippet(_ref6){let{flagKey,variant}=_ref6;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.JavaScript,wrap:!0,children:`if (posthog.getFeatureFlag('${flagKey}') === '${variant}') {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`})})}function PHPSnippet(_ref7){let{flagKey,variant}=_ref7;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.PHP,wrap:!0,children:`if (PostHog::getFeatureFlag('${flagKey}', 'user distinct id') == '${variant}') {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}function GolangSnippet(_ref8){let{flagKey,variant}=_ref8;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Go,wrap:!0,children:`experimentFlagValue, err := client.GetFeatureFlag(
                    FeatureFlagPayload{
                        Key:        '${flagKey}',
                        DistinctId: "distinct-id",
                    })

if (experimentFlagValue == '${variant}' ) {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}function FlutterSnippet(_ref9){let{flagKey,variant}=_ref9,variantSuffix=` == '${variant}'`;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Dart,wrap:!0,children:`if (await Posthog().getFeatureFlag('${flagKey}')${variantSuffix}) {
  // Do something differently for this user
} else {
  // It's a good idea to let control variant always be the default behaviour,
  // so if something goes wrong with flag evaluation, you don't break your app.
}
            `})})}function RubySnippet(_ref10){let{flagKey,variant}=_ref10;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Ruby,wrap:!0,children:`experimentFlagValue = posthog.get_feature_flag('${flagKey}', 'user distinct id')


if experimentFlagValue == '${variant}'
    # Do something differently for this user
else
    # It's a good idea to let control variant always be the default behaviour,
    # so if something goes wrong with flag evaluation, you don't break your app.
end
`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}function PythonSnippet(_ref11){let{flagKey,variant}=_ref11;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Python,wrap:!0,children:`experiment_flag_value = posthog.get_feature_flag("${flagKey}", "user_distinct_id"):

if experiment_flag_value == '${variant}':
    # Do something differently for this user
else:
    # It's a good idea to let control variant always be the default behaviour,
    # so if something goes wrong with flag evaluation, you don't break your app.
`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}let UTM_TAGS="?utm_medium=in-product&utm_campaign=experiment",DOC_BASE_URL="https://posthog.com/docs/",FF_ANCHOR="#feature-flags",LibraryType=function(LibraryType){return LibraryType.Client="Client",LibraryType.Server="Server",LibraryType}({}),OPTIONS=[{value:"JavaScript",key:types.lh.JS_WEB,documentationLink:`${DOC_BASE_URL}libraries/js${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.RQ,Snippet:JSSnippet,type:LibraryType.Client},{value:"Android",key:types.lh.ANDROID,documentationLink:`${DOC_BASE_URL}libraries/android${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.Kp,Snippet:AndroidSnippet,type:LibraryType.Client},{value:"Go",key:types.lh.GO,documentationLink:`${DOC_BASE_URL}libraries/go${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.GH,Snippet:GolangSnippet,type:LibraryType.Server},{value:"Flutter",key:types.lh.FLUTTER,documentationLink:`${DOC_BASE_URL}libraries/flutter${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.D_,Snippet:FlutterSnippet,type:LibraryType.Client},{value:"iOS",key:types.lh.IOS,documentationLink:`${DOC_BASE_URL}libraries/ios${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.in,Snippet:IOSSnippet,type:LibraryType.Client},{value:"Node.js",key:types.lh.NODE_JS,documentationLink:`${DOC_BASE_URL}libraries/node${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.fS,Snippet:NodeJSSnippet,type:LibraryType.Server},{value:"PHP",key:types.lh.PHP,documentationLink:`${DOC_BASE_URL}libraries/php${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.W7,Snippet:PHPSnippet,type:LibraryType.Server},{value:"Python",key:types.lh.PYTHON,documentationLink:`${DOC_BASE_URL}libraries/python${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.Bm,Snippet:PythonSnippet,type:LibraryType.Server},{value:"React",key:types.lh.REACT,documentationLink:`${DOC_BASE_URL}libraries/react${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.RQ,Snippet:ReactSnippet,type:LibraryType.Client},{value:"ReactNative",key:types.lh.REACT_NATIVE,documentationLink:`${DOC_BASE_URL}libraries/react-native${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.RQ,Snippet:RNSnippet,type:LibraryType.Client},{value:"Ruby",key:types.lh.RUBY,documentationLink:`${DOC_BASE_URL}libraries/ruby${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.gz,Snippet:RubySnippet,type:LibraryType.Server}];function CodeLanguageSelect(_ref){let{selectedOptionValue,selectOption}=_ref;return(0,jsx_runtime.jsx)(src.Yv,{size:"small",className:"min-w-[7.5rem]",onSelect:selectOption,value:selectedOptionValue,options:[{title:"Client libraries",options:OPTIONS.filter(option=>option.type==LibraryType.Client).map(_ref2=>{let{Icon,value}=_ref2;return{value,label:value,labelInMenu:(0,jsx_runtime.jsxs)("div",{className:"flex items-center deprecated-space-x-2",children:[(0,jsx_runtime.jsx)(Icon,{}),(0,jsx_runtime.jsx)("span",{children:value})]})}})},{title:"Server libraries",options:OPTIONS.filter(option=>option.type==LibraryType.Server).map(_ref3=>{let{Icon,value}=_ref3;return{value,label:value,labelInMenu:(0,jsx_runtime.jsxs)("div",{className:"flex items-center deprecated-space-x-2",children:[(0,jsx_runtime.jsx)(Icon,{}),(0,jsx_runtime.jsx)("span",{children:value})]})}})}]})}function ExperimentImplementationDetails(_ref4){var _experiment$parameter,_experiment$feature_f;let{experiment}=_ref4,defaultVariant=null!==(_experiment$parameter=experiment?.parameters?.feature_flag_variants?.[1]?.key)&&void 0!==_experiment$parameter?_experiment$parameter:"test",[currentVariant,setCurrentVariant]=(0,react.useState)(defaultVariant),[defaultSelectedOption]=OPTIONS,[selectedOption,setSelectedOption]=(0,react.useState)(defaultSelectedOption);return(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)("h2",{className:"font-semibold text-lg mb-2",children:"Implementation"}),(0,jsx_runtime.jsx)("div",{className:"border rounded bg-surface-primary",children:(0,jsx_runtime.jsxs)("div",{className:"p-6 deprecated-space-y-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)("span",{className:"mr-2",children:"Variant group"}),(0,jsx_runtime.jsx)(src.Yv,{size:"small",className:"min-w-[5rem]",onSelect:setCurrentVariant,value:currentVariant,options:(experiment?.parameters?.feature_flag_variants||[]).map(variant=>({value:variant.key,label:variant.key}))})]}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(CodeLanguageSelect,{selectOption:selectedValue=>{let option=OPTIONS.find(option=>option.value===selectedValue);option&&setSelectedOption(option)},selectedOptionValue:selectedOption.value})})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"mb-1",children:(0,jsx_runtime.jsx)("b",{children:"Implement your experiment in code"})}),(0,jsx_runtime.jsx)("div",{className:"mb-1",children:(0,jsx_runtime.jsx)(selectedOption.Snippet,{variant:currentVariant,flagKey:null!==(_experiment$feature_f=experiment?.feature_flag?.key)&&void 0!==_experiment$feature_f?_experiment$feature_f:""})}),(0,jsx_runtime.jsx)(src.rU,{subtle:!0,to:selectedOption.documentationLink,target:"_blank",children:"See the docs for more implementation information."})]})]})})]})}},"../../node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!../../node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.5.6_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!../../node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!../../frontend/src/scenes/experiments/Metrics/TrendsMetricForm.scss":(module,exports,__webpack_require__)=>{(exports=__webpack_require__("../../node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/runtime/api.js")(!1)).push([module.id,".trends-metric-form__exposure-button.LemonButton .LemonButton__chrome,.trends-metric-form__exposure-button.LemonButton .LemonButton__content{display:block}",""]),module.exports=exports}}]);
//# sourceMappingURL=43655.da90b05d.iframe.bundle.js.map