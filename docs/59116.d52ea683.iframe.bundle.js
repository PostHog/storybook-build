"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[59116],{"../../products/llm_observability/frontend/LLMObservabilityScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{LLMObservabilityScene:()=>LLMObservabilityScene,scene:()=>scene});var clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.27.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),QueryCard=__webpack_require__("../../frontend/src/lib/components/Cards/InsightCard/QueryCard.tsx"),DateFilter=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),preflightLogic=__webpack_require__("../../frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),supportLogic=__webpack_require__("../../frontend/src/lib/components/Support/supportLogic.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let FeedbackNotice=_ref=>{let{text}=_ref,{openSupportForm}=(0,index_esm.useActions)(supportLogic.Pw),{preflight}=(0,index_esm.useValues)(preflightLogic.preflightLogic),showSupportOptions=preflight?.cloud;return(0,jsx_runtime.jsx)(src.Vp,{type:"info",className:"my-4",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center flex-wrap gap-2 justify-between",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1 min-w-full sm:min-w-0",children:text}),showSupportOptions?(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconBug,{}),onClick:()=>openSupportForm({kind:"bug",isEmailFormOpen:!0}),children:"Report a bug"}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",icon:(0,jsx_runtime.jsx)(icons.Rz,{}),onClick:()=>openSupportForm({kind:"feedback",isEmailFormOpen:!0}),children:"Give feedback"})]}):null]})})};var PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),PropertyFilters=__webpack_require__("../../frontend/src/lib/components/PropertyFilters/PropertyFilters.tsx"),TestAccountFiltersSwitch=__webpack_require__("../../frontend/src/lib/components/TestAccountFiltersSwitch.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),Tooltip=__webpack_require__("../../frontend/src/lib/lemon-ui/Tooltip/index.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),dataNodeCollectionLogic=__webpack_require__("../../frontend/src/queries/nodes/DataNode/dataNodeCollectionLogic.ts"),DataTable=__webpack_require__("../../frontend/src/queries/nodes/DataTable/DataTable.tsx"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),utils=__webpack_require__("../../frontend/src/queries/utils.ts"),ConversationMessagesDisplay=__webpack_require__("../../products/llm_observability/frontend/ConversationDisplay/ConversationMessagesDisplay.tsx"),LLMObservabilityPlaygroundScene=__webpack_require__("../../products/llm_observability/frontend/LLMObservabilityPlaygroundScene.tsx"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/index.ts"),llmObservabilityLogic=__webpack_require__("../../products/llm_observability/frontend/llmObservabilityLogic.tsx");let LastRefreshText=()=>{let{newestRefreshed}=(0,index_esm.useValues)(llmObservabilityLogic.K);return newestRefreshed?(0,jsx_runtime.jsxs)("span",{children:["Last updated ",(0,dayjs.Bv)(newestRefreshed).fromNow()]}):(0,jsx_runtime.jsx)("span",{children:"Refresh"})};function LLMObservabilityReloadAction(){let{isRefreshing}=(0,index_esm.useValues)(llmObservabilityLogic.K),{refreshAllDashboardItems}=(0,index_esm.useActions)(llmObservabilityLogic.K);return(0,jsx_runtime.jsx)("div",{className:"relative",children:(0,jsx_runtime.jsx)(src.Jp,{onClick:refreshAllDashboardItems,type:"secondary",icon:isRefreshing?(0,jsx_runtime.jsx)(Spinner.$,{textColored:!0}):(0,jsx_runtime.jsx)(icons.tr,{}),size:"small",disabledReason:isRefreshing?"Refreshing...":void 0,children:(0,jsx_runtime.jsx)("span",{className:"dashboard-items-action-refresh-text",children:isRefreshing?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Refreshing..."}):(0,jsx_runtime.jsx)(LastRefreshText,{})})})})}var TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),Link=__webpack_require__("../../frontend/src/lib/lemon-ui/Link/index.ts"),frontend_utils=__webpack_require__("../../products/llm_observability/frontend/utils.ts");function LLMObservabilityTraces(){let{setDates,setShouldFilterTestAccounts,setPropertyFilters,setTracesQuery}=(0,index_esm.useActions)(llmObservabilityLogic.K),{tracesQuery}=(0,index_esm.useValues)(llmObservabilityLogic.K);return(0,jsx_runtime.jsx)(DataTable.w,{query:tracesQuery,setQuery:query=>{if(!(0,utils.zO)(query.source))throw Error("Invalid query");setDates(query.source.dateRange?.date_from||null,query.source.dateRange?.date_to||null),setShouldFilterTestAccounts(query.source.filterTestAccounts||!1),setPropertyFilters(query.source.properties||[]),setTracesQuery(query)},context:{emptyStateHeading:"There were no traces in this period",emptyStateDetail:"Try changing the date range or filters.",columns:{id:{title:"ID",render:IDColumn},inputState:{title:"Input message",render:InputMessageColumn},outputState:{title:"Output message",render:OutputMessageColumn},timestamp:{title:"Time",render:TimestampColumn},traceName:{title:"Trace Name",render:TraceNameColumn},person:{title:"Person"},totalLatency:{title:"Latency",render:LatencyColumn},usage:{title:"Token Usage",render:UsageColumn},totalCost:{title:"Total Cost",render:CostColumn}}},uniqueKey:"llm-observability-traces"})}let IDColumn=_ref=>{let{record}=_ref;return(0,jsx_runtime.jsx)("strong",{children:(0,jsx_runtime.jsx)(Tooltip.u,{title:record.id,children:(0,jsx_runtime.jsxs)(Link.r,{className:"ph-no-capture",to:urls.j.llmObservabilityTrace(record.id,{timestamp:(0,frontend_utils.sl)(record.createdAt)}),children:[record.id.slice(0,4),"...",record.id.slice(-4)]})})})},TraceNameColumn=_ref2=>{let{record}=_ref2;return(0,jsx_runtime.jsx)("strong",{children:(0,jsx_runtime.jsx)(Link.r,{className:"ph-no-capture",to:urls.j.llmObservabilityTrace(record.id,{timestamp:(0,frontend_utils.sl)(record.createdAt)}),children:record.traceName||"–"})})},TimestampColumn=_ref3=>{let{record}=_ref3;return(0,jsx_runtime.jsx)(TZLabel.w,{time:record.createdAt})};TimestampColumn.displayName="TimestampColumn";let LatencyColumn=_ref4=>{let{record}=_ref4;return"number"==typeof record.totalLatency?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,frontend_utils.DB)(record.totalLatency,!0)}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"–"})};LatencyColumn.displayName="LatencyColumn";let UsageColumn=_ref5=>{let{record}=_ref5,usage=(0,frontend_utils.Pz)(record);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:usage||"–"})};UsageColumn.displayName="UsageColumn";let CostColumn=_ref6=>{let{record}=_ref6;return"number"==typeof record.totalCost?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,frontend_utils.K7)(record.totalCost)}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"–"})};CostColumn.displayName="CostColumn";let InputMessageColumn=_ref7=>{let{record}=_ref7,inputNormalized=(0,frontend_utils.VL)(record.inputState?.messages,"user");return inputNormalized.length?(0,jsx_runtime.jsx)(ConversationMessagesDisplay.qb,{message:inputNormalized.at(-1),isOutput:!1,minimal:!0}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"–"})};InputMessageColumn.displayName="InputMessageColumn";let OutputMessageColumn=_ref8=>{let{record}=_ref8,errorEventFound=!!Array.isArray(record.events)&&record.events.find(e=>e.properties?.$ai_error||e.properties?.$ai_is_error);if(errorEventFound)return(0,jsx_runtime.jsx)(src.oe,{type:"danger",className:"font-mono max-w-50 truncate",children:errorEventFound.properties?.$ai_error||"Unknown error"});let outputNormalized=(0,frontend_utils.VL)(record.outputState?.messages,"assistant");return outputNormalized.length?(0,jsx_runtime.jsx)(ConversationMessagesDisplay.qb,{message:outputNormalized.at(-1),isOutput:!0,minimal:!0}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"–"})};OutputMessageColumn.displayName="OutputMessageColumn";var LLMObservabilityUsers=__webpack_require__("../../products/llm_observability/frontend/LLMObservabilityUsers.tsx");let scene={component:LLMObservabilityScene},Filters=()=>{let{dashboardDateFilter,dateFilter,shouldFilterTestAccounts,generationsQuery,propertyFilters,activeTab}=(0,index_esm.useValues)(llmObservabilityLogic.K),{setDates,setShouldFilterTestAccounts,setPropertyFilters}=(0,index_esm.useActions)(llmObservabilityLogic.K),dateFrom="dashboard"===activeTab?dashboardDateFilter.dateFrom:dateFilter.dateFrom,dateTo="dashboard"===activeTab?dashboardDateFilter.dateTo:dateFilter.dateTo;return(0,jsx_runtime.jsxs)("div",{className:"flex gap-x-4 gap-y-2 items-center flex-wrap py-4 -mt-4 mb-4 border-b",children:[(0,jsx_runtime.jsx)(DateFilter.f,{dateFrom:dateFrom,dateTo:dateTo,onChange:setDates}),(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:propertyFilters,taxonomicGroupTypes:generationsQuery.showPropertyFilter,onChange:setPropertyFilters,pageKey:"llm-observability"}),(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:shouldFilterTestAccounts,onChange:setShouldFilterTestAccounts}),(0,jsx_runtime.jsx)(LLMObservabilityReloadAction,{})]})},Tiles=()=>{let{tiles}=(0,index_esm.useValues)(llmObservabilityLogic.K);return(0,jsx_runtime.jsx)("div",{className:"mt-2 grid grid-cols-1 @xl/dashboard:grid-cols-2 @4xl/dashboard:grid-cols-6 gap-4",children:tiles.map((_ref,i)=>{let{title,description,query,context}=_ref;return(0,jsx_runtime.jsx)(QueryCard.w,{title:title,description:description,query:{kind:schema_general.OH.InsightVizNode,source:query},context:context,className:(0,clsx_m.default)("h-96",i<3||i>=5?"@4xl/dashboard:col-span-2":"@4xl/dashboard:col-span-3")},i)})})},IngestionStatusCheck=()=>(0,jsx_runtime.jsxs)(src.Vp,{type:"warning",className:"mt-2",children:[(0,jsx_runtime.jsx)("p",{children:(0,jsx_runtime.jsx)("strong",{children:"No LLM generation events have been detected!"})}),(0,jsx_runtime.jsxs)("p",{children:["To use the LLM Observability product, please"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/ai-engineering/observability",children:"instrument your LLM calls with the PostHog SDK"})," ","(otherwise it'll be a little empty!)"]})]});function LLMObservabilityDashboard(){return(0,jsx_runtime.jsxs)("div",{className:"@container/dashboard",children:[(0,jsx_runtime.jsx)(Filters,{}),(0,jsx_runtime.jsx)(Tiles,{})]})}function LLMObservabilityGenerations(){let{setDates,setShouldFilterTestAccounts,setPropertyFilters,setGenerationsQuery,setGenerationsColumns}=(0,index_esm.useActions)(llmObservabilityLogic.K),{generationsQuery}=(0,index_esm.useValues)(llmObservabilityLogic.K);return(0,jsx_runtime.jsx)(DataTable.w,{query:generationsQuery,setQuery:query=>{if(!(0,utils.rz)(query.source))throw Error("Invalid query");setDates(query.source.after||null,query.source.before||null),setShouldFilterTestAccounts(query.source.filterTestAccounts||!1),setPropertyFilters(query.source.properties||[]),query.source.select&&setGenerationsColumns(query.source.select),setGenerationsQuery(query)},context:{emptyStateHeading:"There were no generations in this period",emptyStateDetail:"Try changing the date range or filters.",columns:{uuid:{title:"ID",render:_ref2=>{let{record,value}=_ref2,traceId=record[1];if(!value)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let visualValue=value.slice(0,4)+"..."+value.slice(-4);return traceId?(0,jsx_runtime.jsx)("strong",{children:(0,jsx_runtime.jsx)(Tooltip.u,{title:value,children:(0,jsx_runtime.jsx)(src.rU,{to:`/llm-observability/traces/${traceId}?event=${value}`,children:visualValue})})}):(0,jsx_runtime.jsx)("strong",{children:visualValue})}},"properties.$ai_input[-1]":{title:"Input",render:_ref3=>{let inputNormalized,{value}=_ref3;if("string"==typeof value)try{inputNormalized=(0,frontend_utils.VL)(JSON.parse(value),"user")}catch(e){console.warn("Error parsing properties.$ai_input[-1] as JSON",e)}return inputNormalized?.length?(0,jsx_runtime.jsx)(ConversationMessagesDisplay.qb,{message:inputNormalized.at(-1),isOutput:!1,minimal:!0}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"–"})}},"properties.$ai_output_choices":{title:"Output",render:_ref4=>{let outputNormalized,{value}=_ref4;if("string"==typeof value)try{outputNormalized=(0,frontend_utils.VL)(JSON.parse(value),"assistant")}catch(e){console.warn("Error parsing properties.$ai_output_choices as JSON",e)}return outputNormalized?.length?(0,jsx_runtime.jsx)("div",{children:outputNormalized.map((message,index)=>(0,jsx_runtime.jsx)(ConversationMessagesDisplay.qb,{message:message,isOutput:!0,minimal:!0},index))}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"–"})}},"properties.$ai_trace_id":{title:"Trace ID",render:_ref5=>{let{value}=_ref5;if(!value)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let visualValue=value.slice(0,4)+"..."+value.slice(-4);return(0,jsx_runtime.jsx)(Tooltip.u,{title:value,children:(0,jsx_runtime.jsx)(src.rU,{to:`/llm-observability/traces/${value}`,children:visualValue})})}}}},uniqueKey:"llm-observability-generations"})}function LLMObservabilityNoEvents(){return(0,jsx_runtime.jsx)("div",{className:"w-full flex flex-col items-center justify-center",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col items-center justify-center max-w-md w-full",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconArchive,{className:"text-5xl mb-2 text-muted-alt"}),(0,jsx_runtime.jsx)("h2",{className:"text-xl leading-tight",children:"We haven't detected any LLM generations yet"}),(0,jsx_runtime.jsxs)("p",{className:"text-sm text-center text-balance",children:["To use the LLM Observability product, please"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/ai-engineering/observability",children:"instrument your LLM calls with the PostHog SDK"})," "]})]})})}function LLMObservabilityScene(){let{activeTab,hasSentAiGenerationEvent,hasSentAiGenerationEventLoading}=(0,index_esm.useValues)(llmObservabilityLogic.K),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.featureFlagLogic),{searchParams}=(0,index_esm.useValues)(lib.router),tabs=[{key:"dashboard",label:"Dashboard",content:(0,jsx_runtime.jsx)(LLMObservabilityDashboard,{}),link:(0,lib.combineUrl)(urls.j.llmObservabilityDashboard(),searchParams).url},{key:"traces",label:"Traces",content:hasSentAiGenerationEvent?(0,jsx_runtime.jsx)(LLMObservabilityTraces,{}):(0,jsx_runtime.jsx)(LLMObservabilityNoEvents,{}),link:(0,lib.combineUrl)(urls.j.llmObservabilityTraces(),searchParams).url},{key:"generations",label:"Generations",content:hasSentAiGenerationEvent?(0,jsx_runtime.jsx)(LLMObservabilityGenerations,{}):(0,jsx_runtime.jsx)(LLMObservabilityNoEvents,{}),link:(0,lib.combineUrl)(urls.j.llmObservabilityGenerations(),searchParams).url},{key:"users",label:"Users",content:hasSentAiGenerationEvent?(0,jsx_runtime.jsx)(LLMObservabilityUsers.LLMObservabilityUsers,{}):(0,jsx_runtime.jsx)(LLMObservabilityNoEvents,{}),link:(0,lib.combineUrl)(urls.j.llmObservabilityUsers(),searchParams).url}];return featureFlags[constants.y8.LLM_OBSERVABILITY_PLAYGROUND]&&tabs.push({key:"playground",label:"Playground",content:(0,jsx_runtime.jsx)(LLMObservabilityPlaygroundScene.LLMObservabilityPlaygroundScene,{}),link:(0,lib.combineUrl)(urls.j.llmObservabilityPlayground(),searchParams).url}),(0,jsx_runtime.jsxs)(index_esm.BindLogic,{logic:dataNodeCollectionLogic.y,props:{key:llmObservabilityLogic.E},children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)("div",{className:"flex gap-2",children:(0,jsx_runtime.jsx)(src.Jp,{to:"https://posthog.com/docs/ai-engineering/observability",type:"secondary",targetBlank:!0,children:"Documentation"})})}),hasSentAiGenerationEventLoading?null:hasSentAiGenerationEvent?(0,jsx_runtime.jsx)(FeedbackNotice,{text:"LLM observability is currently in beta. Thanks for taking part! We'd love to hear what you think."}):(0,jsx_runtime.jsx)(IngestionStatusCheck,{}),(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,"data-attr":"llm-observability-tabs",tabs:tabs})]})}}}]);