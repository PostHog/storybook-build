"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[94610],{"../../frontend/src/scenes/audit-logs/AdvancedActivityLogsList.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{d:()=>AdvancedActivityLogsList});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),ActivityLog=__webpack_require__("../../frontend/src/lib/components/ActivityLog/ActivityLog.tsx"),activityLogLogic=__webpack_require__("../../frontend/src/lib/components/ActivityLog/activityLogLogic.tsx"),humanizeActivity=__webpack_require__("../../frontend/src/lib/components/ActivityLog/humanizeActivity.tsx"),hedgehogs=__webpack_require__("../../frontend/src/lib/components/hedgehogs.tsx"),PaginationControl=__webpack_require__("../../frontend/src/lib/lemon-ui/PaginationControl/index.ts"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.30.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),MonacoDiffEditor=__webpack_require__("../../frontend/src/lib/components/MonacoDiffEditor.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),ProfilePicture=__webpack_require__("../../frontend/src/lib/lemon-ui/ProfilePicture/index.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function AuditLogTableHeader(){return(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-12 gap-4 py-3 px-4 bg-accent-3000 border-b border-border font-semibold text-sm text-muted-alt",children:[(0,jsx_runtime.jsx)("div",{className:"col-span-4",children:"Description"}),(0,jsx_runtime.jsx)("div",{className:"col-span-2",children:"User"}),(0,jsx_runtime.jsx)("div",{className:"col-span-2",children:"Action"}),(0,jsx_runtime.jsx)("div",{className:"col-span-2",children:"Scope"}),(0,jsx_runtime.jsx)("div",{className:"col-span-1",children:"Timestamp"}),(0,jsx_runtime.jsx)("div",{className:"col-span-1"})]})}function AuditLogTableRow(_ref){var _logItem$email;let{logItem}=_ref,[expanded,setExpanded]=(0,react.useState)(!1),unprocessed=logItem.unprocessed;return(0,jsx_runtime.jsxs)("div",{className:"border-b border-border last:border-b-0",children:[(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-12 gap-4 py-3 px-4 hover:bg-accent-3000 items-center text-sm cursor-pointer",onClick:()=>setExpanded(!expanded),"data-attr":"audit-log-row",children:[(0,jsx_runtime.jsx)("div",{className:"col-span-4",children:(0,jsx_runtime.jsx)("div",{className:"truncate [&_div]:inline [&_div]:mr-1",children:"string"==typeof logItem.description?logItem.description:logItem.description||"No description"})}),(0,jsx_runtime.jsx)("div",{className:"col-span-2",children:(0,jsx_runtime.jsx)(ProfilePicture.Y,{showName:!0,user:{first_name:logItem.isSystem?"PostHog":logItem.name,email:null!==(_logItem$email=logItem.email)&&void 0!==_logItem$email?_logItem$email:void 0},type:logItem.isSystem?"system":"person",size:"md"})}),(0,jsx_runtime.jsx)("div",{className:"col-span-2",children:(0,jsx_runtime.jsx)("span",{className:"capitalize",children:unprocessed?.activity||"Unknown"})}),(0,jsx_runtime.jsx)("div",{className:"col-span-2",children:(0,jsx_runtime.jsx)("span",{className:"inline-block px-2 py-1 bg-accent-3000 rounded",children:unprocessed?.scope?(0,humanizeActivity.VI)(unprocessed.scope,!0):"Unknown"})}),(0,jsx_runtime.jsx)("div",{className:"col-span-1 text-muted text-xs",children:(0,jsx_runtime.jsx)(TZLabel.w,{time:logItem.created_at})}),(0,jsx_runtime.jsx)("div",{className:"col-span-1 flex justify-end",children:(0,jsx_runtime.jsx)("button",{className:"text-muted-alt hover:text-default p-1 rounded hover:bg-accent-3000",onClick:e=>{e.stopPropagation(),setExpanded(!expanded)},"aria-label":expanded?"Collapse row":"Expand row","data-attr":"audit-log-expand-button",children:expanded?(0,jsx_runtime.jsx)(posthog_icons_es.IconCollapse,{}):(0,jsx_runtime.jsx)(posthog_icons_es.IconExpand,{})})})]}),expanded&&(0,jsx_runtime.jsx)("div",{className:"bg-surface-secondary border-t border-border",children:(0,jsx_runtime.jsx)("div",{className:"px-6 py-4",children:unprocessed&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"mb-6",children:(0,jsx_runtime.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:(0,jsx_runtime.jsxs)("div",{className:"space-y-3",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"text-xs font-medium text-muted-alt uppercase tracking-wider mb-1",children:"Description"}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-default [&_div]:inline [&_div]:mr-1",children:logItem.description})]}),logItem.extendedDescription&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"text-xs font-medium text-muted-alt uppercase tracking-wider mb-1",children:"Extended Description"}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-default [&_div]:inline [&_div]:mr-1",children:logItem.extendedDescription})]}),unprocessed.item_id&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"text-xs font-medium text-muted-alt uppercase tracking-wider mb-1",children:"Item ID"}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-default",children:unprocessed.item_id})]})]})})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(ActivityDetailsSection,{logItem:logItem})})]})})})]})}let ActivityDetailsSection=_ref2=>{let{logItem}=_ref2,[activeTab,setActiveTab]=(0,react.useState)("diff");return(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,onChange:key=>setActiveTab(key),"data-attr":"audit-log-details-tabs",tabs:[!!logItem.extendedDescription&&{key:"extended description",label:"Extended Description",tooltip:"Some activities have a more detailed description that is not shown when collapsed.",content:(0,jsx_runtime.jsx)("div",{className:"[&_div]:inline [&_div]:mr-1",children:logItem.extendedDescription})},{key:"diff",label:"Diff",tooltip:"Show the diff of the changes made to the item. Each activity item could have more than one change.",content:(0,jsx_runtime.jsx)(ActivityLogDiff,{logItem:logItem})},{key:"raw",label:"Raw",tooltip:"Show the raw data of the activity item.",content:(0,jsx_runtime.jsx)("div",{className:"bg-surface-primary p-2 rounded border border-border text-sm",children:(0,jsx_runtime.jsx)("pre",{children:JSON.stringify(logItem.unprocessed,null,2)})})}]})},ActivityLogDiff=_ref3=>{let{logItem}=_ref3,changes=logItem.unprocessed?.detail.changes;return(0,jsx_runtime.jsx)("div",{className:"flex flex-col space-y-2 px-2 py-1",children:(0,jsx_runtime.jsx)("div",{className:"flex flex-col space-y-2",children:changes?.length?changes.map((change,i)=>(0,jsx_runtime.jsx)(JsonDiffViewer,{field:change.field||"",before:change.before,after:change.after},i)):(0,jsx_runtime.jsx)("div",{className:"text-muted",children:"This item has no changes to compare"})})})},JsonDiffViewer=_ref4=>{let{field,before,after}=_ref4,beforeStr=JSON.stringify(before,null,2),afterStr=JSON.stringify(after,null,2);return beforeStr===afterStr?(0,jsx_runtime.jsxs)("div",{className:"border rounded p-2 bg-surface-primary",children:[(0,jsx_runtime.jsx)("div",{className:"font-medium text-sm mb-1",children:field}),(0,jsx_runtime.jsx)("div",{className:"text-muted text-xs",children:"No changes detected"})]}):(0,jsx_runtime.jsxs)("div",{className:"border rounded bg-surface-primary",children:[(0,jsx_runtime.jsx)("div",{className:"font-medium text-sm p-2",children:field}),(0,jsx_runtime.jsx)(MonacoDiffEditor.Z,{original:beforeStr,value:afterStr,modified:afterStr,language:"json",options:{readOnly:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,renderSideBySide:!0,hideUnchangedRegions:{enabled:!0,contextLineCount:3,minimumLineCount:3,revealLineCount:20},diffAlgorithm:"advanced"}})]})};var advancedActivityLogsLogic=__webpack_require__("../../frontend/src/scenes/audit-logs/advancedActivityLogsLogic.tsx");function AdvancedActivityLogsList(){let{advancedActivityLogs,advancedActivityLogsLoading,pagination}=(0,index_esm.useValues)(advancedActivityLogsLogic.advancedActivityLogsLogic),humanizedLogs=advancedActivityLogs?.results?(0,humanizeActivity.OI)(advancedActivityLogs.results,activityLogLogic.L_):[],paginationState=(0,PaginationControl.h)(humanizedLogs,pagination);return advancedActivityLogsLoading?(0,jsx_runtime.jsx)(AdvancedActivityLogsListSkeleton,{}):humanizedLogs.length?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"border border-border rounded-md bg-bg-light overflow-hidden",children:[(0,jsx_runtime.jsx)(AuditLogTableHeader,{}),(0,jsx_runtime.jsx)("div",{className:"divide-y divide-border",children:humanizedLogs.map((logItem,index)=>(0,jsx_runtime.jsx)(AuditLogTableRow,{logItem:logItem},index))})]}),(0,jsx_runtime.jsx)("div",{className:"flex justify-center mt-6",children:(0,jsx_runtime.jsx)(PaginationControl.R,{...paginationState,"data-attr":"audit-logs-pagination"})})]}):(0,jsx_runtime.jsx)(AdvancedActivityLogsEmptyState,{})}let AdvancedActivityLogsListSkeleton=()=>(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(ActivityLog.ay,{}),(0,jsx_runtime.jsx)(ActivityLog.ay,{}),(0,jsx_runtime.jsx)(ActivityLog.ay,{}),(0,jsx_runtime.jsx)(ActivityLog.ay,{}),(0,jsx_runtime.jsx)(ActivityLog.ay,{})]}),AdvancedActivityLogsEmptyState=()=>(0,jsx_runtime.jsxs)("div",{"data-attr":"billing-empty-state",className:"flex flex-col bg-white border rounded px-4 py-8 items-center text-center mx-auto",children:[(0,jsx_runtime.jsx)(hedgehogs.WarningHog,{width:"100",height:"100",className:"mb-4"}),(0,jsx_runtime.jsx)("h2",{className:"text-xl leading-tight",children:"We couldn't find any activity logs for your current query."}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-balance text-tertiary",children:"Try adjusting your filters or date range to see more results."})]})},"../../frontend/src/scenes/audit-logs/advancedActivityLogsLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{advancedActivityLogsLogic:()=>advancedActivityLogsLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_constants__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/constants.tsx"),lib_lemon_ui_LemonToast__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/index.ts"),lib_logic_featureFlagLogic__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/lib/utils.tsx");let DEFAULT_FILTERS={start_date:"-30d",users:[],scopes:[],activities:[],detail_filters:{}},DEFAULT_ACTIVE_FILTERS=[],advancedActivityLogsLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","audit-logs","advancedActivityLogsLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)(()=>({values:[lib_logic_featureFlagLogic__WEBPACK_IMPORTED_MODULE_5__.featureFlagLogic,["featureFlags"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setFilters:filters=>({filters}),clearAllFilters:!0,setPage:page=>({page}),exportLogs:format=>({format}),loadAvailableFilters:!0,loadExports:!0,setActiveTab:tab=>({tab}),addActiveFilter:(fieldPath,isCustom)=>({fieldPath,isCustom}),updateActiveFilter:(key,updates)=>({key,updates}),removeActiveFilter:key=>({key}),syncFiltersToAPI:!0}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({filters:[DEFAULT_FILTERS,{setFilters:(state,_ref)=>{let{filters}=_ref;return{...state,...filters}},clearAllFilters:()=>DEFAULT_FILTERS}],activeFilters:[DEFAULT_ACTIVE_FILTERS,{addActiveFilter:(state,_ref2)=>{let{fieldPath,isCustom}=_ref2;return[...state,{key:`filter_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fieldPath:isCustom?"":fieldPath,operation:"exact",value:"",isCustom}]},updateActiveFilter:(state,_ref3)=>{let{key,updates}=_ref3;return state.map(filter=>filter.key===key?{...filter,...updates}:filter)},removeActiveFilter:(state,_ref4)=>{let{key}=_ref4;return state.filter(filter=>filter.key!==key)},clearAllFilters:()=>DEFAULT_ACTIVE_FILTERS}],currentPage:[1,{setPage:(_,_ref5)=>{let{page}=_ref5;return page},setFilters:()=>1,addDetailFilter:()=>1,updateDetailFilter:()=>1,removeDetailFilter:()=>1}],activeTab:["logs",{setActiveTab:(_,_ref6)=>{let{tab}=_ref6;return tab}}]}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref7=>{let{values}=_ref7;return{advancedActivityLogs:[{results:[],count:0},{loadAdvancedActivityLogs:async()=>{let params=new URLSearchParams;if(values.filters.start_date){let startDate=(0,lib_utils__WEBPACK_IMPORTED_MODULE_6__.FZ)(values.filters.start_date);startDate&&params.append("start_date",startDate.toISOString())}if(values.filters.end_date){let endDate=(0,lib_utils__WEBPACK_IMPORTED_MODULE_6__.FZ)(values.filters.end_date);endDate&&params.append("end_date",endDate.toISOString())}return values.filters.users?.forEach(user=>params.append("users",user)),values.filters.scopes?.forEach(scope=>params.append("scopes",scope)),values.filters.activities?.forEach(activity=>params.append("activities",activity)),values.filters.detail_filters&&Object.keys(values.filters.detail_filters).length>0&&params.append("detail_filters",JSON.stringify(values.filters.detail_filters)),params.append("page",values.currentPage.toString()),params.append("page_size",lib_constants__WEBPACK_IMPORTED_MODULE_3__.Ls.toString()),await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.get(`api/projects/@current/advanced_activity_logs/?${params}`)}}],availableFilters:[null,{loadAvailableFilters:async()=>await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.get("api/projects/@current/advanced_activity_logs/available_filters/")}],exports:[[],{loadExports:async()=>{let params=new URLSearchParams;return params.append("context_path","/advanced_activity_logs/"),(await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.get(`api/environments/@current/exports/?${params}`)).results||[]}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(_ref8=>{let{actions}=_ref8;return{isFeatureFlagEnabled:[s=>[s.featureFlags],featureFlags=>!!featureFlags[lib_constants__WEBPACK_IMPORTED_MODULE_3__.y8.ADVANCED_ACTIVITY_LOGS]],hasActiveFilters:[s=>[s.filters],filters=>!!(filters.start_date||filters.end_date||filters.users?.length||filters.scopes?.length||filters.activities?.length||filters.detail_filters&&Object.keys(filters.detail_filters).length>0)],pagination:[s=>[s.currentPage,s.advancedActivityLogs],(currentPage,advancedActivityLogs)=>({controlled:!0,pageSize:lib_constants__WEBPACK_IMPORTED_MODULE_3__.Ls,currentPage,entryCount:advancedActivityLogs.count||0,onBackward:()=>actions.setPage(currentPage-1),onForward:()=>actions.setPage(currentPage+1)})]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref9=>{let{actions,values}=_ref9;return{setPage:()=>{actions.loadAdvancedActivityLogs()},setFilters:()=>{actions.loadAdvancedActivityLogs()},clearAllFilters:()=>{actions.loadAdvancedActivityLogs()},addActiveFilter:_ref10=>{let{fieldPath}=_ref10;if("__add_custom__"===fieldPath){actions.addActiveFilter("",!0);return}actions.syncFiltersToAPI()},updateActiveFilter:()=>{actions.syncFiltersToAPI()},removeActiveFilter:()=>{actions.syncFiltersToAPI()},syncFiltersToAPI:()=>{let detailFilters={};values.activeFilters.forEach(filter=>{filter.fieldPath&&filter.fieldPath.trim()&&(detailFilters[filter.fieldPath.includes("::")?filter.fieldPath.split("::")[1]:filter.fieldPath]={operation:filter.operation,value:filter.value})}),actions.setFilters({detail_filters:detailFilters})},exportLogs:async _ref11=>{let{format}=_ref11;try{let startDate=values.filters.start_date?lib_utils__WEBPACK_IMPORTED_MODULE_6__.FZ(values.filters.start_date)?.toISOString():void 0,endDate=values.filters.end_date?lib_utils__WEBPACK_IMPORTED_MODULE_6__.FZ(values.filters.end_date)?.toISOString():void 0,filtersToExport={start_date:startDate,end_date:endDate,users:values.filters.users,scopes:values.filters.scopes,activities:values.filters.activities,detail_filters:values.filters.detail_filters};await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.create("api/projects/@current/advanced_activity_logs/export/",{format,filters:filtersToExport}),lib_lemon_ui_LemonToast__WEBPACK_IMPORTED_MODULE_4__.U.success(`Export started! Your ${format.toUpperCase()} export is being prepared.`),actions.loadExports(),actions.setActiveTab("exports")}catch(error){console.error("Export failed:",error),lib_lemon_ui_LemonToast__WEBPACK_IMPORTED_MODULE_4__.U.error("Failed to start export. Please try again.")}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.events)(_ref12=>{let{actions,cache}=_ref12;return{afterMount:()=>{actions.loadAvailableFilters(),actions.loadAdvancedActivityLogs(),actions.loadExports(),cache.exportPollingInterval=setInterval(()=>{actions.loadExports()},5e3)},beforeUnmount:()=>{cache.exportPollingInterval&&clearInterval(cache.exportPollingInterval)}}})])}}]);