"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[65729],{"../../products/session_summaries/frontend/SessionGroupSummaryScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{SessionGroupSummary:()=>SessionGroupSummary,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.35.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),LemonMenu=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonMenu/index.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),copyToClipboard=__webpack_require__("../../frontend/src/lib/utils/copyToClipboard.tsx"),sceneTypes=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts"),scenes=__webpack_require__("../../frontend/src/scenes/scenes.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),SceneContent=__webpack_require__("../../frontend/src/layout/scenes/components/SceneContent.tsx"),SceneTitleSection=__webpack_require__("../../frontend/src/layout/scenes/components/SceneTitleSection.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function SessionGroupSummaryDetailsMetadata(_ref){let{event}=_ref,sessionId=event.target_event.session_id,duration=null!==event.session_duration?(0,utils.Dh)(event.session_duration):"N/A",email=event.person_email||"Anonymous";return(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted",children:[(0,jsx_runtime.jsx)("span",{children:sessionId}),(0,jsx_runtime.jsx)("span",{className:"hidden sm:inline",children:"·"}),(0,jsx_runtime.jsx)("span",{children:duration}),(0,jsx_runtime.jsx)("span",{className:"hidden sm:inline",children:"·"}),(0,jsx_runtime.jsx)(TZLabel.w,{time:event.target_event.timestamp,className:"text-xs"}),(0,jsx_runtime.jsx)("span",{className:"hidden sm:inline",children:"·"}),(0,jsx_runtime.jsx)("span",{children:email})]})}var SessionRecordingPlayer=__webpack_require__("../../frontend/src/scenes/session-recordings/player/SessionRecordingPlayer.tsx"),sessionRecordingPlayerLogic=__webpack_require__("../../frontend/src/scenes/session-recordings/player/sessionRecordingPlayerLogic.ts");function SessionGroupSummaryDetailsModal(_ref){let{isOpen,onClose,event}=_ref,playerKey="session-details-modal",sessionRecordingId=event?.target_event?.session_id,logicProps={sessionRecordingId:sessionRecordingId||"",playerKey,autoPlay:!1},{seekToTime}=(0,index_esm.useActions)((0,sessionRecordingPlayerLogic.d$)(logicProps)),{sessionPlayerData}=(0,index_esm.useValues)((0,sessionRecordingPlayerLogic.d$)(logicProps)),timeToSeekTo=ms=>Math.max(ms-4e3,0);if((0,react.useEffect)(()=>{isOpen&&event?.target_event&&sessionPlayerData&&seekToTime(timeToSeekTo(event.target_event.milliseconds_since_start))},[isOpen,event,sessionPlayerData,seekToTime]),!event||!event.target_event)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});if(!sessionRecordingId)throw Error("Session recording id not found");return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:onClose,simple:!0,title:"",width:1600,closable:!0,hideCloseButton:!0,children:(0,jsx_runtime.jsx)(src.fQ.Content,{embedded:!0,children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsxs)("header",{className:"flex items-center justify-between p-4 border-b",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h2",{className:"text-lg font-semibold mb-1",children:event.target_event.description}),(0,jsx_runtime.jsx)(SessionGroupSummaryDetailsMetadata,{event:event})]}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconShare,{}),onClick:()=>void(0,copyToClipboard.v)(window.location.href,"link")}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:onClose})]})]}),(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-3 gap-8 p-6",children:[(0,jsx_runtime.jsx)("div",{className:"space-y-4",children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{className:"text-sm font-medium text-muted mb-1",children:"What user was doing"}),(0,jsx_runtime.jsx)("p",{className:"text-sm mb-0",children:event.segment_name})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{className:"text-sm font-medium text-muted mb-1",children:"What's the outcome"}),(0,jsx_runtime.jsx)("div",{className:"space-y-2",children:(0,jsx_runtime.jsxs)("div",{className:"text-sm",children:[(0,jsx_runtime.jsxs)("b",{children:[event.segment_success?"Successful":"Failed","."]})," ",event.segment_outcome]})})]})]})}),(0,jsx_runtime.jsx)("div",{className:"space-y-4",children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{className:"text-sm font-medium text-muted mb-1",children:"What confirmed the pattern"}),(0,jsx_runtime.jsx)("p",{className:"text-sm mb-0",children:event.target_event.description})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{className:"text-sm font-medium text-muted mb-1",children:"Where it happened"}),(0,jsx_runtime.jsx)("p",{className:"text-sm mb-0 break-all truncate",title:event.target_event.current_url||void 0,children:event.target_event.current_url||"unknown"})]})]})}),(0,jsx_runtime.jsx)("div",{className:"space-y-4",children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{className:"text-sm font-medium text-muted mb-1",children:"What happened before"}),event.previous_events_in_segment.length>0?(0,jsx_runtime.jsx)("ul",{className:"text-sm mb-0 list-disc list-inside space-y-1",children:event.previous_events_in_segment.map((e,idx)=>(0,jsx_runtime.jsx)("li",{children:e.description},idx))}):(0,jsx_runtime.jsx)("p",{className:"text-sm mb-0",children:"Nothing happened"})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{className:"text-sm font-medium text-muted mb-1",children:"What happened after"}),event.next_events_in_segment.length>0?(0,jsx_runtime.jsx)("ul",{className:"text-sm mb-0 list-disc list-inside space-y-1",children:event.next_events_in_segment.map((e,idx)=>(0,jsx_runtime.jsx)("li",{children:e.description},idx))}):(0,jsx_runtime.jsx)("p",{className:"text-sm mb-0",children:"Nothing happened"})]})]})})]}),(0,jsx_runtime.jsx)("div",{className:"w-full",children:(0,jsx_runtime.jsx)(SessionRecordingPlayer.d,{sessionRecordingId:sessionRecordingId,playerKey:playerKey,autoPlay:!1,noBorder:!0})})]})})})}var lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts");let sessionGroupSummarySceneLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","session_summaries","frontend","sessionGroupSummarySceneLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(props=>props.id),(0,index_esm.actions)({loadSessionGroupSummary:!0,openSessionDetails:(patternId,targetEventUuid)=>({patternId,targetEventUuid}),closeSessionDetails:!0}),(0,index_esm.reducers)({accessDeniedToSessionGroupSummary:[!1,{loadSessionGroupSummaryFailure:(_,_ref)=>{let{error}=_ref;return error?.status===403||error?.statusCode===403}}],selectedPatternId:[null,{openSessionDetails:(_,_ref2)=>{let{patternId}=_ref2;return patternId},closeSessionDetails:()=>null}],selectedEventUuid:[null,{openSessionDetails:(_,_ref3)=>{let{targetEventUuid}=_ref3;return targetEventUuid},closeSessionDetails:()=>null}]}),(0,lib.loaders)(_ref4=>{let{props}=_ref4;return{sessionGroupSummary:[null,{loadSessionGroupSummary:async()=>{try{return await api.ZP.sessionGroupSummaries.get(props.id)}catch(error){if(404===error.status)return null;throw error}}}]}}),(0,index_esm.selectors)({sessionGroupSummaryMissing:[s=>[s.sessionGroupSummary,s.sessionGroupSummaryLoading],(sessionGroupSummary,sessionGroupSummaryLoading)=>!sessionGroupSummary&&!sessionGroupSummaryLoading],selectedEvent:[s=>[s.sessionGroupSummary,s.selectedPatternId,s.selectedEventUuid],(sessionGroupSummary,selectedPatternId,selectedEventUuid)=>{if(!sessionGroupSummary||null===selectedPatternId||!selectedEventUuid)return null;let summary=JSON.parse(sessionGroupSummary.summary||"{}"),pattern=summary.patterns?.find(p=>p.pattern_id===selectedPatternId);return pattern&&pattern.events.find(e=>e.target_event.event_uuid===selectedEventUuid)||null}],breadcrumbs:[s=>[s.sessionGroupSummary],sessionGroupSummary=>[{key:sceneTypes.x.SessionGroupSummariesTable,name:"Session summaries",path:urls.j.sessionSummaries()},{key:sceneTypes.x.SessionGroupSummary,name:sessionGroupSummary?.title||"Group summary"}]]}),(0,kea_router_lib.actionToUrl)(_ref5=>{let{values}=_ref5,buildURL=()=>{let hashParams={...kea_router_lib.router.values.hashParams};return null!==values.selectedPatternId&&values.selectedEventUuid?(hashParams.patternId=values.selectedPatternId,hashParams.targetEventId=values.selectedEventUuid):(delete hashParams.patternId,delete hashParams.targetEventId),[kea_router_lib.router.values.location.pathname,kea_router_lib.router.values.searchParams,hashParams,{replace:!0}]};return{openSessionDetails:()=>buildURL(),closeSessionDetails:()=>buildURL()}}),(0,kea_router_lib.urlToAction)(_ref6=>{let{actions,values}=_ref6;return{"*":(_,_searchParams,hashParams)=>{let patternId=hashParams.patternId?Number(hashParams.patternId):null,targetEventId=hashParams.targetEventId||null;null!==patternId&&targetEventId&&(values.selectedEventUuid!==targetEventId||values.selectedPatternId!==patternId)?actions.openSessionDetails(patternId,targetEventId):patternId||targetEventId||!values.selectedEventUuid||actions.closeSessionDetails()}}}),(0,index_esm.afterMount)(_ref7=>{let{actions}=_ref7;actions.loadSessionGroupSummary()})]),scene={component:SessionGroupSummary,logic:sessionGroupSummarySceneLogic,paramsToProps:_ref=>{let{params:{sessionGroupId}}=_ref;return{id:sessionGroupId}}};function getSeverityConfig(severity){return({critical:{type:"danger",color:"bg-danger"},high:{type:"warning",color:"bg-yellow-700"},medium:{type:"warning",color:"bg-warning"},low:{type:"default",color:"bg-muted"}})[severity]}function capitalizeFirst(str){return str.charAt(0).toUpperCase()+str.slice(1)}function SessionGroupSummaryLoadingSkeleton(){return(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(src.yW,{className:"h-20"}),(0,jsx_runtime.jsx)(src.yW,{className:"h-32"}),(0,jsx_runtime.jsx)(src.yW,{className:"h-32"})]})}function SessionExampleCard(_ref2){let{event,onViewDetails}=_ref2,{target_event,segment_outcome}=event;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 rounded border p-3 bg-bg-light",children:[(0,jsx_runtime.jsx)("div",{className:"flex items-center gap-2",children:(0,jsx_runtime.jsx)(src.u,{title:"View details",placement:"right",children:(0,jsx_runtime.jsxs)("h4",{className:"mb-0 text-link hover:underline cursor-pointer",onClick:onViewDetails,children:[target_event.description,(0,jsx_runtime.jsx)("span",{className:"text-link ml-1",children:(0,jsx_runtime.jsx)(icons.Ud,{})})]})})}),(0,jsx_runtime.jsx)("div",{className:"mb-2",children:(0,jsx_runtime.jsx)(SessionGroupSummaryDetailsMetadata,{event:event})}),(0,jsx_runtime.jsxs)("p",{className:"text-xs font-normal text-muted-alt mb-0",children:[(0,jsx_runtime.jsx)("b",{children:"Outcome:"})," ",segment_outcome]})]})}function FilterBar(_ref3){let{sortBy,onSortChange,searchValue,onSearchChange}=_ref3;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap justify-between gap-4 mb-4",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1 min-w-60",children:(0,jsx_runtime.jsx)(src.DF,{type:"search",placeholder:"Filter session issues by keyword...",value:searchValue,onChange:onSearchChange,prefix:(0,jsx_runtime.jsx)(posthog_icons_es.IconSearch,{}),fullWidth:!0})}),(0,jsx_runtime.jsx)(LemonMenu.d,{items:[{label:"Sort by severity",icon:"severity"===sortBy?(0,jsx_runtime.jsx)(posthog_icons_es.IconCheck,{}):void 0,onClick:()=>onSortChange("severity")},{label:"Sort by session count",icon:"session_count"===sortBy?(0,jsx_runtime.jsx)(posthog_icons_es.IconCheck,{}):void 0,onClick:()=>onSortChange("session_count")}],children:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconSort,{}),children:"severity"===sortBy?"Sort by severity":"Sort by session count"})})]})}function PatternCard(_ref4){let{pattern,onViewDetails}=_ref4,[visibleCount,setVisibleCount]=(0,react.useState)(3),severityConfig=getSeverityConfig(pattern.severity),header=(0,jsx_runtime.jsxs)("div",{className:"py-3 px-1",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h3",{className:"text-base font-medium mb-0",children:pattern.pattern_name}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-2 text-sm text-muted mb-2",children:[(0,jsx_runtime.jsxs)("span",{children:[pattern.stats.sessions_affected," session",pattern.stats.sessions_affected>1?"s":""]}),(0,jsx_runtime.jsx)("span",{className:"hidden sm:inline",children:"·"}),(0,jsx_runtime.jsxs)("span",{children:[(100*pattern.stats.sessions_affected_ratio).toFixed(0),"%"]}),(0,jsx_runtime.jsx)("span",{className:"hidden sm:inline",children:"·"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,jsx_runtime.jsx)("div",{className:`size-2 rounded-full ${severityConfig.color}`}),(0,jsx_runtime.jsx)("div",{className:"text-sm font-normal mb-0",children:capitalizeFirst(pattern.severity)})]})]})]}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-muted-alt mb-0",children:pattern.pattern_description})]}),content=(0,jsx_runtime.jsxs)("div",{className:"p-2 bg-bg-3000",children:[(0,jsx_runtime.jsx)("p",{className:"mb-3 text-sm font-medium",children:"Examples from sessions:"}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col gap-2",children:pattern.events.slice(0,visibleCount).map((event,index)=>(0,jsx_runtime.jsx)(SessionExampleCard,{event:event,onViewDetails:()=>onViewDetails(event)},`${pattern.pattern_id}-${index}`))}),pattern.events.length>3&&(0,jsx_runtime.jsxs)("div",{className:"mt-4 flex justify-center gap-2",children:[visibleCount>3&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>setVisibleCount(prev=>Math.max(prev-3,3)),children:"Show fewer examples"}),visibleCount<pattern.events.length&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>setVisibleCount(prev=>prev+3),children:"Show more examples"})]})]});return(0,jsx_runtime.jsx)(src.JL,{panels:[{key:pattern.pattern_id,header,content}],size:"small",onChange:activeKey=>{null===activeKey&&setVisibleCount(3)}})}let SEVERITY_ORDER={critical:4,high:3,medium:2,low:1};function SessionGroupSummary(){let{sessionGroupSummary,sessionGroupSummaryLoading,sessionGroupSummaryMissing,accessDeniedToSessionGroupSummary,selectedEvent}=(0,index_esm.useValues)(sessionGroupSummarySceneLogic),{openSessionDetails,closeSessionDetails}=(0,index_esm.useActions)(sessionGroupSummarySceneLogic),[sortBy,setSortBy]=(0,react.useState)("severity"),[searchValue,setSearchValue]=(0,react.useState)(""),[debouncedSearchValue,setDebouncedSearchValue]=(0,react.useState)(""),summary=(0,react.useMemo)(()=>JSON.parse(sessionGroupSummary?.summary||"{}"),[sessionGroupSummary?.summary]),debouncedSetSearch=(0,react.useRef)((0,utils.Ds)(value=>setDebouncedSearchValue(value),100)).current;(0,react.useEffect)(()=>{debouncedSetSearch(searchValue)},[searchValue,debouncedSetSearch]);let filteredPatterns=(0,react.useMemo)(()=>{if(!summary.patterns)return[];let trimmedSearch=debouncedSearchValue.trim().toLowerCase();return trimmedSearch?summary.patterns.map(pattern=>{let filteredEvents=pattern.events.filter(event=>event.target_event.description.toLowerCase().includes(trimmedSearch)||event.segment_outcome.toLowerCase().includes(trimmedSearch));return 0===filteredEvents.length?null:{...pattern,events:filteredEvents}}).filter(pattern=>null!==pattern):summary.patterns},[summary.patterns,debouncedSearchValue]),sortedPatterns=(0,react.useMemo)(()=>{let patterns=[...filteredPatterns];return"severity"===sortBy?patterns.sort((a,b)=>SEVERITY_ORDER[b.severity]-SEVERITY_ORDER[a.severity]):patterns.sort((a,b)=>b.stats.sessions_affected-a.stats.sessions_affected)},[filteredPatterns,sortBy]),handleViewDetails=(pattern,event)=>{openSessionDetails(pattern.pattern_id,event.target_event.event_uuid)};if(sessionGroupSummaryLoading)return(0,jsx_runtime.jsx)(SceneContent._,{children:(0,jsx_runtime.jsx)(SessionGroupSummaryLoadingSkeleton,{})});if(accessDeniedToSessionGroupSummary)return(0,jsx_runtime.jsx)(SceneContent._,{children:(0,jsx_runtime.jsx)(src.Vp,{type:"error",children:"You don't have permission to view this session group summary."})});if(sessionGroupSummaryMissing)return(0,jsx_runtime.jsx)(SceneContent._,{children:(0,jsx_runtime.jsx)(src.Vp,{type:"error",children:"Session group summary not found."})});if(!sessionGroupSummary)return(0,jsx_runtime.jsx)(SceneContent._,{children:(0,jsx_runtime.jsx)(src.Vp,{type:"error",children:"Failed to load session group summary."})});let totalSessions=sessionGroupSummary.session_ids.length;return(0,jsx_runtime.jsxs)(SceneContent._,{children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:sessionGroupSummary.title,resourceType:{type:scenes.lc[sceneTypes.x.SessionGroupSummary]?.iconType||"default_icon_type"},actions:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconShare,{}),onClick:()=>void(0,copyToClipboard.v)(window.location.href,"link"),children:"Share"}),forceBackTo:{key:sceneTypes.x.SessionGroupSummariesTable,name:"Session summaries",path:urls.j.sessionSummaries(),iconType:"notebook"}}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-3 text-sm text-muted mb-2",children:[(0,jsx_runtime.jsxs)("span",{children:[totalSessions," sessions analyzed"]}),(0,jsx_runtime.jsx)("span",{className:"hidden sm:inline",children:"·"}),(0,jsx_runtime.jsx)("span",{children:new Date(sessionGroupSummary.created_at).toLocaleString()})]}),(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(FilterBar,{sortBy:sortBy,onSortChange:setSortBy,searchValue:searchValue,onSearchChange:setSearchValue}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col gap-2",children:0===sortedPatterns.length&&summary.patterns&&summary.patterns.length>0?(0,jsx_runtime.jsx)("p",{className:"text-muted",children:"No patterns match your search"}):sortedPatterns.map(pattern=>(0,jsx_runtime.jsx)(PatternCard,{pattern:pattern,onViewDetails:event=>handleViewDetails(pattern,event)},pattern.pattern_id))})]}),(0,jsx_runtime.jsx)(SessionGroupSummaryDetailsModal,{isOpen:null!==selectedEvent,onClose:()=>{closeSessionDetails()},event:selectedEvent})]})}}}]);