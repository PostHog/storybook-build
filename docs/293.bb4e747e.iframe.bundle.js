(window.webpackJsonp=window.webpackJsonp||[]).push([[293],{"./frontend/src/scenes/apps/AppMetricsScene.tsx":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"scene",(function(){return scene})),__webpack_require__.d(__webpack_exports__,"AppMetrics",(function(){return AppMetrics}));var tabs=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/tabs/index.js"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.0_react@16.14.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.0/node_modules/kea-loaders/lib/index.js"),urls=__webpack_require__("./frontend/src/scenes/urls.ts"),types=__webpack_require__("./frontend/src/types.ts"),api=__webpack_require__("./frontend/src/lib/api.ts"),teamLogic=__webpack_require__("./frontend/src/scenes/teamLogic.tsx"),kea_router_lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.3_kea@3.1.0/node_modules/kea-router/lib/index.js"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),PluginJobConfiguration=__webpack_require__("./frontend/src/scenes/plugins/edit/interface-jobs/PluginJobConfiguration.tsx"),interfaceJobsLogic=__webpack_require__("./frontend/src/scenes/plugins/edit/interface-jobs/interfaceJobsLogic.ts"),dayjs=__webpack_require__("./frontend/src/lib/dayjs.ts"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts");let AppMetricsTab;!function(AppMetricsTab){AppMetricsTab.ProcessEvent="processEvent",AppMetricsTab.OnEvent="onEvent",AppMetricsTab.ExportEvents="exportEvents",AppMetricsTab.ScheduledTask="scheduledTask",AppMetricsTab.HistoricalExports="historical_exports",AppMetricsTab.History="history"}(AppMetricsTab||(AppMetricsTab={}));const INITIAL_TABS=[AppMetricsTab.ProcessEvent,AppMetricsTab.OnEvent,AppMetricsTab.ExportEvents,AppMetricsTab.ScheduledTask],appMetricsSceneLogic=Object(index_esm.kea)([Object(index_esm.path)((key=>["scenes","apps","appMetricsSceneLogic",key])),Object(index_esm.props)({}),Object(index_esm.key)((props=>props.pluginConfigId)),Object(index_esm.actions)({setActiveTab:tab=>({tab:tab}),setDateFrom:dateFrom=>({dateFrom:dateFrom}),openErrorDetailsModal:(errorType,category,jobId)=>({errorType:errorType,category:category,jobId:jobId}),closeErrorDetailsModal:!0,openHistoricalExportModal:!0}),Object(index_esm.reducers)({activeTab:[null,{setActiveTab:(_,_ref)=>{let{tab:tab}=_ref;return tab}}],selectedDateFrom:[null,{setDateFrom:(_,_ref2)=>{let{dateFrom:dateFrom}=_ref2;return dateFrom}}],errorDetailsModalError:[null,{openErrorDetailsModal:(_,_ref3)=>{let{errorType:errorType}=_ref3;return errorType},closeErrorDetailsModal:()=>null}]}),Object(lib.loaders)((_ref4=>{let{values:values,props:props}=_ref4;return{pluginConfig:[null,{loadPluginConfig:async()=>await api.b.get(`api/projects/${teamLogic.a.values.currentTeamId}/plugin_configs/${props.pluginConfigId}`)}],appMetricsResponse:[null,{loadMetrics:async()=>{if(values.activeTab&&values.dateFrom){const params=Object(utils.Hb)({category:values.activeTab,date_from:values.dateFrom});return await api.b.get(`api/projects/${teamLogic.a.values.currentTeamId}/app_metrics/${props.pluginConfigId}?${params}`)}}}],historicalExports:[[],{loadHistoricalExports:async()=>{const{results:results}=await api.b.get(`api/projects/${teamLogic.a.values.currentTeamId}/app_metrics/${props.pluginConfigId}/historical_exports`);return results}}],errorDetails:[[],{openErrorDetailsModal:async _ref5=>{let{category:category,jobId:jobId,errorType:errorType}=_ref5;const params=Object(utils.Hb)({category:category,job_id:jobId,error_type:errorType}),{result:result}=await api.b.get(`api/projects/${teamLogic.a.values.currentTeamId}/app_metrics/${props.pluginConfigId}/error_details?${params}`);return result}}]}})),Object(index_esm.selectors)((_ref6=>{let{values:values,actions:actions}=_ref6;return{breadcrumbs:[s=>[s.pluginConfig,(_,props)=>props.pluginConfigId],(pluginConfig,pluginConfigId)=>{var _pluginConfig$plugin_;return[{name:"Apps",path:urls.a.projectApps()},{name:null==pluginConfig||null===(_pluginConfig$plugin_=pluginConfig.plugin_info)||void 0===_pluginConfig$plugin_?void 0:_pluginConfig$plugin_.name,path:urls.a.appMetrics(pluginConfigId)}]}],shouldShowAppMetrics:[()=>[userLogic.a.selectors.hasAvailableFeature],hasAvailableFeature=>hasAvailableFeature(types.e.APP_METRICS)],defaultTab:[s=>[s.pluginConfig],()=>{var _INITIAL_TABS$filter$;return null!==(_INITIAL_TABS$filter$=INITIAL_TABS.filter((tab=>values.showTab(tab)))[0])&&void 0!==_INITIAL_TABS$filter$?_INITIAL_TABS$filter$:AppMetricsTab.History}],currentTime:[()=>[],()=>Date.now()],defaultDateFrom:[s=>[s.pluginConfig,s.currentTime],(pluginConfig,currentTime)=>{if(null==pluginConfig||!pluginConfig.created_at)return"-30d";const installedAt=dayjs.a.utc(pluginConfig.created_at),daysSinceInstall=Object(dayjs.a)(currentTime).diff(installedAt,"days",!0);return daysSinceInstall<=1?"-24h":daysSinceInstall<=7?"-7d":"-30d"}],dateFrom:[s=>[s.selectedDateFrom,s.defaultDateFrom],(selectedDateFrom,defaultDateFrom)=>{var _ref7;return null!==(_ref7=null!=selectedDateFrom?selectedDateFrom:defaultDateFrom)&&void 0!==_ref7?_ref7:"-30d"}],showTab:[s=>[s.shouldShowAppMetrics],shouldShowAppMetrics=>tab=>{if(values.pluginConfigLoading||!values.pluginConfig||!values.pluginConfig.plugin_info.capabilities)return!1;const capabilities=values.pluginConfig.plugin_info.capabilities,isExportEvents=capabilities.methods.includes("exportEvents");return tab===AppMetricsTab.History||!!shouldShowAppMetrics&&(tab===AppMetricsTab.HistoricalExports?isExportEvents:(tab!==AppMetricsTab.OnEvent||!isExportEvents)&&(tab===AppMetricsTab.ScheduledTask?!isExportEvents&&["runEveryMinute","runEveryHour","runEveryDay"].some((method=>capabilities.scheduled_tasks.includes(method))):capabilities.methods.includes(tab)))}],interfaceJobsProps:[s=>[s.pluginConfig],pluginConfig=>pluginConfig&&pluginConfig.plugin_info.public_jobs&&null!=pluginConfig&&pluginConfig.enabled?{jobName:PluginJobConfiguration.b,jobSpec:pluginConfig.plugin_info.public_jobs[PluginJobConfiguration.b],pluginConfigId:pluginConfig.id,pluginId:pluginConfig.plugin,onSubmit:actions.loadHistoricalExports}:null],hasRunningExports:[s=>[s.historicalExports],historicalExports=>historicalExports.some((e=>"not_finished"==e.status))]}})),Object(index_esm.listeners)((_ref8=>{let{values:values,actions:actions}=_ref8;return{loadPluginConfigSuccess:()=>{values.activeTab||actions.setActiveTab(values.defaultTab)},setActiveTab:_ref9=>{let{tab:tab}=_ref9;tab===AppMetricsTab.HistoricalExports?actions.loadHistoricalExports():tab!==AppMetricsTab.History&&actions.loadMetrics()},setDateFrom:()=>{actions.loadMetrics()},openHistoricalExportModal:()=>{values.interfaceJobsProps&&Object(interfaceJobsLogic.a)(values.interfaceJobsProps).actions.setIsJobModalOpen(!0)}}})),Object(kea_router_lib.actionToUrl)((_ref10=>{let{values:values,props:props}=_ref10;return{setActiveTab:()=>getUrl(values,props),setDateFrom:()=>getUrl(values,props),openErrorDetailsModal:()=>getUrl(values,props),closeErrorDetailsModal:()=>getUrl(values,props)}})),Object(kea_router_lib.urlToAction)((_ref11=>{let{values:values,actions:actions,props:props}=_ref11;return{"/app/:pluginConfigId/:page":(url,params)=>{if(props.pluginConfigId===Number(url.pluginConfigId))if(values.pluginConfig||actions.loadPluginConfig(),url.page===AppMetricsTab.HistoricalExports)actions.setActiveTab(AppMetricsTab.HistoricalExports);else if(url.page===AppMetricsTab.History)actions.setActiveTab(AppMetricsTab.History);else if(params.tab&&INITIAL_TABS.includes(params.tab)&&params.tab!==values.activeTab?actions.setActiveTab(params.tab):values.pluginConfigLoading||values.activeTab===values.defaultTab||actions.setActiveTab(values.defaultTab),params.from&&values.selectedDateFrom!==params.from&&actions.setDateFrom(params.from),params.error){const[error,category]=params.error;values.errorDetailsModalError!==error&&(actions.setActiveTab(category),actions.openErrorDetailsModal(error,category))}else actions.closeErrorDetailsModal()}}}))]);function getUrl(values,props){if(values.activeTab===AppMetricsTab.HistoricalExports)return urls.a.appHistoricalExports(props.pluginConfigId);if(values.activeTab===AppMetricsTab.History)return urls.a.appHistory(props.pluginConfigId,kea_router_lib.router.values.searchParams);const params={};return values.activeTab&&values.activeTab!==values.defaultTab&&(params.tab=values.activeTab),values.selectedDateFrom&&(params.from=values.selectedDateFrom),values.errorDetailsModalError&&values.activeTab&&(params.error=[values.errorDetailsModalError,values.activeTab]),urls.a.appMetrics(props.pluginConfigId,params)}var PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/jsx-runtime.js");const DescriptionColumns={[AppMetricsTab.ProcessEvent]:{successes:"Events processed",successes_tooltip:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["These events were successfully processed and transformed by the ",Object(jsx_runtime.jsx)("i",{children:"processEvent"})," app method."]}),failures:"Failed events",failures_tooltip:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["These events had errors when being processed by the ",Object(jsx_runtime.jsx)("i",{children:"processEvent"})," app method, but were still ingested."]})},[AppMetricsTab.OnEvent]:{successes:"Events processed",successes_tooltip:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["These events were successfully processed by the ",Object(jsx_runtime.jsx)("i",{children:"onEvent"})," app method on the first try."]}),successes_on_retry:"Events processed on retry",successes_on_retry_tooltip:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["These events were successfully processed by the ",Object(jsx_runtime.jsx)("i",{children:"onEvent"})," app method after being retried."]}),failures:"Failed events",failures_tooltip:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["These events had errors when being processed by the ",Object(jsx_runtime.jsx)("i",{children:"onEvent"})," app method."]})},[AppMetricsTab.ExportEvents]:{successes:"Events delivered",successes_tooltip:Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"These events were successfully delivered to the configured destination on the first try."}),successes_on_retry:"Events delivered on retry",successes_on_retry_tooltip:Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"These events were successfully delivered to the configured destination after being retried."}),failures:"Failed events",failures_tooltip:Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"These events failed to be delivered to the configured destination due to errors."})},[AppMetricsTab.HistoricalExports]:{successes:"Events delivered",successes_tooltip:Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"These events were successfully delivered to the configured destination on the first try."}),successes_on_retry:"Events delivered on retry",successes_on_retry_tooltip:Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"These events were successfully delivered to the configured destination after being retried."}),failures:"Failed events",failures_tooltip:Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"These events failed to be delivered to the configured destination due to errors."})},[AppMetricsTab.ScheduledTask]:{successes:"Successes",successes_tooltip:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["How many times ",Object(jsx_runtime.jsx)("i",{children:"runEveryMinute"}),", ",Object(jsx_runtime.jsx)("i",{children:"runEveryHour"})," or ",Object(jsx_runtime.jsx)("i",{children:"runEveryDay"})," was called successfully."]}),failures:"Failures",failures_tooltip:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["How many times ",Object(jsx_runtime.jsx)("i",{children:"runEveryMinute"}),", ",Object(jsx_runtime.jsx)("i",{children:"runEveryHour"})," or ",Object(jsx_runtime.jsx)("i",{children:"runEveryDay"})," failed due to errors."]})}};var LemonSkeleton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonSkeleton/index.tsx"),react=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/index.js"),colors=__webpack_require__("./frontend/src/lib/colors.ts"),dist_chart=__webpack_require__("./node_modules/.pnpm/chart.js@3.9.1/node_modules/chart.js/dist/chart.mjs"),injectStylesIntoStyleTag=__webpack_require__("./node_modules/.pnpm/style-loader@2.0.0_webpack@4.46.0/node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),AppMetricsGraph=__webpack_require__("./node_modules/.pnpm/css-loader@3.6.0_webpack@4.46.0/node_modules/css-loader/dist/cjs.js!./node_modules/.pnpm/postcss-loader@4.3.0_dhonik3q6ff6ozbzdscnovq2ka/node_modules/postcss-loader/dist/cjs.js!./node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0+webpack@4.46.0/node_modules/sass-loader/dist/cjs.js?!./frontend/src/scenes/apps/AppMetricsGraph.scss"),AppMetricsGraph_default=__webpack_require__.n(AppMetricsGraph),options={insert:"head",singleton:!1};injectStylesIntoStyleTag_default()(AppMetricsGraph_default.a,options),AppMetricsGraph_default.a.locals;function AppMetricsGraph_AppMetricsGraph(_ref){let{tab:tab,metrics:metrics,metricsLoading:metricsLoading}=_ref;const canvasRef=Object(react.useRef)(null),descriptions=DescriptionColumns[tab];return Object(react.useEffect)((()=>{let chart;var _canvasRef$current;canvasRef.current&&metrics&&(chart=new dist_chart.a(null===(_canvasRef$current=canvasRef.current)||void 0===_canvasRef$current?void 0:_canvasRef$current.getContext("2d"),{type:"line",data:{labels:metrics.dates,datasets:[{label:descriptions.successes,data:metrics.successes,borderColor:"",...colorConfig("data-brand-blue")},...descriptions.successes_on_retry?[{label:descriptions.successes_on_retry,data:metrics.successes_on_retry,...colorConfig("data-yellow")}]:[],{label:descriptions.failures,data:metrics.failures,...colorConfig("data-vermilion")}]},options:{scales:{x:{ticks:{maxRotation:0},grid:{display:!1}},y:{beginAtZero:!0}},plugins:{crosshair:!1,legend:{display:!1}},maintainAspectRatio:!1,interaction:{mode:"index",axis:"x",intersect:!1}}}));return()=>{var _chart;null===(_chart=chart)||void 0===_chart||_chart.destroy()}}),[metrics]),metricsLoading||!metrics?Object(jsx_runtime.jsx)(LemonSkeleton.a,{className:"AppMetricsGraph border rounded p-6"}):Object(jsx_runtime.jsx)("div",{className:"AppMetricsGraph border rounded p-6",children:Object(jsx_runtime.jsx)("canvas",{ref:canvasRef})})}function colorConfig(baseColorVar){const mainColor=Object(colors.b)(baseColorVar);return{borderColor:mainColor,hoverBorderColor:Object(utils.mb)(mainColor,-20),hoverBackgroundColor:Object(utils.mb)(mainColor,-20),backgroundColor:mainColor,fill:!1,borderWidth:2,pointRadius:0}}try{AppMetricsGraph_AppMetricsGraph.displayName="AppMetricsGraph",AppMetricsGraph_AppMetricsGraph.__docgenInfo={description:"",displayName:"AppMetricsGraph",props:{tab:{defaultValue:null,description:"",name:"tab",required:!0,type:{name:"enum",value:[{value:'"processEvent"'},{value:'"onEvent"'},{value:'"exportEvents"'},{value:'"scheduledTask"'},{value:'"historical_exports"'},{value:'"history"'}]}},metrics:{defaultValue:null,description:"",name:"metrics",required:!1,type:{name:"AppMetrics | null"}},metricsLoading:{defaultValue:null,description:"",name:"metricsLoading",required:!0,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/apps/AppMetricsGraph.tsx#AppMetricsGraph"]={docgenInfo:AppMetricsGraph_AppMetricsGraph.__docgenInfo,name:"AppMetricsGraph",path:"frontend/src/scenes/apps/AppMetricsGraph.tsx#AppMetricsGraph"})}catch(__react_docgen_typescript_loader_error){}var LemonSelect=__webpack_require__("./frontend/src/lib/lemon-ui/LemonSelect/index.ts"),LemonTable=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTable/index.ts"),TZLabel=__webpack_require__("./frontend/src/lib/components/TZLabel/index.tsx"),Link=__webpack_require__("./frontend/src/lib/lemon-ui/Link.tsx"),Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip.tsx"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts");function MetricsTab(_ref){let{tab:tab}=_ref;const{appMetricsResponse:appMetricsResponse,appMetricsResponseLoading:appMetricsResponseLoading,dateFrom:dateFrom}=Object(index_esm.useValues)(appMetricsSceneLogic),{setDateFrom:setDateFrom}=Object(index_esm.useActions)(appMetricsSceneLogic);return Object(jsx_runtime.jsxs)("div",{className:"space-y-8",children:[Object(jsx_runtime.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[Object(jsx_runtime.jsx)(MetricsOverview,{tab:tab,metrics:null==appMetricsResponse?void 0:appMetricsResponse.metrics,metricsLoading:appMetricsResponseLoading}),Object(jsx_runtime.jsx)(LemonSelect.a,{value:dateFrom,onChange:newValue=>setDateFrom(newValue),options:[{label:"Last 30 days",value:"-30d"},{label:"Last 7 days",value:"-7d"},{label:"Last 24 hours",value:"-24h"}]})]}),Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)("h2",{children:"Delivery trends"}),Object(jsx_runtime.jsx)(AppMetricsGraph_AppMetricsGraph,{tab:tab,metrics:null==appMetricsResponse?void 0:appMetricsResponse.metrics,metricsLoading:appMetricsResponseLoading})]}),Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)("h2",{children:"Errors"}),Object(jsx_runtime.jsx)(ErrorsOverview,{category:tab,errors:(null==appMetricsResponse?void 0:appMetricsResponse.errors)||[],loading:appMetricsResponseLoading,showExtendedEmptyState:!0})]})]})}function MetricsOverview(_ref2){var _metrics$totals,_metrics$totals2,_metrics$totals3;let{tab:tab,metrics:metrics,metricsLoading:metricsLoading,exportDuration:exportDuration,exportFailureReason:exportFailureReason}=_ref2;return metricsLoading?Object(jsx_runtime.jsx)(LemonSkeleton.a,{className:"w-20 mb-2",repeat:4}):Object(jsx_runtime.jsxs)("div",{className:"space-y-4",children:[Object(jsx_runtime.jsxs)("div",{className:"flex items-start gap-8 flex-wrap",children:[Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsxs)("div",{className:"text-muted font-semibold mb-2",children:[DescriptionColumns[tab].successes," ",DescriptionColumns[tab].successes_tooltip&&Object(jsx_runtime.jsx)(Tooltip.a,{title:DescriptionColumns[tab].successes_tooltip,children:Object(jsx_runtime.jsx)(icons.tb,{})})]}),Object(jsx_runtime.jsx)("div",{className:"text-4xl",children:renderNumber(null==metrics||null===(_metrics$totals=metrics.totals)||void 0===_metrics$totals?void 0:_metrics$totals.successes)})]}),DescriptionColumns[tab].successes_on_retry&&Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsxs)("div",{className:"text-muted font-semibold mb-2",children:[DescriptionColumns[tab].successes_on_retry," ",DescriptionColumns[tab].successes_on_retry_tooltip&&Object(jsx_runtime.jsx)(Tooltip.a,{title:DescriptionColumns[tab].successes_on_retry_tooltip,children:Object(jsx_runtime.jsx)(icons.tb,{})})]}),Object(jsx_runtime.jsx)("div",{className:"text-4xl",children:renderNumber(null==metrics||null===(_metrics$totals2=metrics.totals)||void 0===_metrics$totals2?void 0:_metrics$totals2.successes_on_retry)})]}),Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsxs)("div",{className:"text-muted font-semibold mb-2",children:[DescriptionColumns[tab].failures," ",DescriptionColumns[tab].failures_tooltip&&Object(jsx_runtime.jsx)(Tooltip.a,{title:DescriptionColumns[tab].failures_tooltip,children:Object(jsx_runtime.jsx)(icons.tb,{})})]}),Object(jsx_runtime.jsx)("div",{className:"text-4xl",children:renderNumber(null==metrics||null===(_metrics$totals3=metrics.totals)||void 0===_metrics$totals3?void 0:_metrics$totals3.failures)})]}),exportDuration&&Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)("div",{className:"text-muted font-semibold mb-2",children:"Export duration"}),Object(jsx_runtime.jsx)("div",{className:"text-4xl",children:Object(utils.O)(exportDuration)})]})]}),exportFailureReason&&Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)("div",{className:"text-muted font-semibold mb-2",children:"Export failure reason"}),Object(jsx_runtime.jsx)("div",{children:exportFailureReason})]})]})}function ErrorsOverview(_ref3){let{errors:errors,loading:loading,category:category,jobId:jobId,showExtendedEmptyState:showExtendedEmptyState}=_ref3;const{openErrorDetailsModal:openErrorDetailsModal}=Object(index_esm.useActions)(appMetricsSceneLogic);return Object(jsx_runtime.jsx)(LemonTable.a,{dataSource:errors,loading:loading,columns:[{title:"Error type",dataIndex:"error_type",render:function RenderErrorType(_,errorSummary){return Object(jsx_runtime.jsx)(Link.a,{title:"View details",className:"font-semibold",onClick:event=>{event.preventDefault(),openErrorDetailsModal(errorSummary.error_type,category,jobId)},children:errorSummary.error_type})},sorter:(a,b)=>a.error_type.localeCompare(b.error_type)},{title:"Count",dataIndex:"count",align:"right",sorter:(a,b)=>a.count-b.count},{title:"Last seen",dataIndex:"last_seen",render:function RenderCreatedAt(lastSeen){return Object(jsx_runtime.jsx)("div",{className:"whitespace-nowrap text-right",children:Object(jsx_runtime.jsx)(TZLabel.a,{time:lastSeen})})},align:"right",sorter:(a,b)=>new Date(a.last_seen||0)>new Date(b.last_seen||0)?1:-1}],defaultSorting:{columnKey:"last_seen",order:-1},useURLForSorting:!1,noSortingCancellation:!0,emptyState:Object(jsx_runtime.jsxs)("div",{className:"",children:[Object(jsx_runtime.jsx)("b",{children:"No errors! 🥳"}),showExtendedEmptyState&&Object(jsx_runtime.jsx)("p",{className:"m-0",children:"If this app has any errors in the future, this table will contain information to help solve the issue."})]})})}function renderNumber(value){return Object(jsx_runtime.jsx)(jsx_runtime.Fragment,{children:value?Object(utils.Q)(value):value})}try{MetricsTab.displayName="MetricsTab",MetricsTab.__docgenInfo={description:"",displayName:"MetricsTab",props:{tab:{defaultValue:null,description:"",name:"tab",required:!0,type:{name:"enum",value:[{value:'"processEvent"'},{value:'"onEvent"'},{value:'"exportEvents"'},{value:'"scheduledTask"'},{value:'"historical_exports"'},{value:'"history"'}]}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/apps/MetricsTab.tsx#MetricsTab"]={docgenInfo:MetricsTab.__docgenInfo,name:"MetricsTab",path:"frontend/src/scenes/apps/MetricsTab.tsx#MetricsTab"})}catch(__react_docgen_typescript_loader_error){}try{MetricsOverview.displayName="MetricsOverview",MetricsOverview.__docgenInfo={description:"",displayName:"MetricsOverview",props:{tab:{defaultValue:null,description:"",name:"tab",required:!0,type:{name:"enum",value:[{value:'"processEvent"'},{value:'"onEvent"'},{value:'"exportEvents"'},{value:'"scheduledTask"'},{value:'"historical_exports"'},{value:'"history"'}]}},metrics:{defaultValue:null,description:"",name:"metrics",required:!1,type:{name:"AppMetrics | null"}},metricsLoading:{defaultValue:null,description:"",name:"metricsLoading",required:!0,type:{name:"boolean"}},exportDuration:{defaultValue:null,description:"",name:"exportDuration",required:!1,type:{name:"number"}},exportFailureReason:{defaultValue:null,description:"",name:"exportFailureReason",required:!1,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/apps/MetricsTab.tsx#MetricsOverview"]={docgenInfo:MetricsOverview.__docgenInfo,name:"MetricsOverview",path:"frontend/src/scenes/apps/MetricsTab.tsx#MetricsOverview"})}catch(__react_docgen_typescript_loader_error){}try{ErrorsOverview.displayName="ErrorsOverview",ErrorsOverview.__docgenInfo={description:"",displayName:"ErrorsOverview",props:{errors:{defaultValue:null,description:"",name:"errors",required:!0,type:{name:"AppErrorSummary[]"}},loading:{defaultValue:null,description:"",name:"loading",required:!1,type:{name:"boolean"}},category:{defaultValue:null,description:"",name:"category",required:!0,type:{name:"string"}},jobId:{defaultValue:null,description:"",name:"jobId",required:!1,type:{name:"string"}},showExtendedEmptyState:{defaultValue:null,description:"",name:"showExtendedEmptyState",required:!1,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/apps/MetricsTab.tsx#ErrorsOverview"]={docgenInfo:ErrorsOverview.__docgenInfo,name:"ErrorsOverview",path:"frontend/src/scenes/apps/MetricsTab.tsx#ErrorsOverview"})}catch(__react_docgen_typescript_loader_error){}var card=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/card/index.js");const historicalExportLogic=Object(index_esm.kea)([Object(index_esm.path)(["scenes","apps","historicalExportLogic"]),Object(index_esm.props)({}),Object(index_esm.key)((_ref=>{let{pluginConfigId:pluginConfigId,jobId:jobId}=_ref;return`${pluginConfigId}_${jobId}`})),Object(lib.loaders)((_ref2=>{let{props:props}=_ref2;return{data:[null,{loadExportData:async()=>await api.b.get(`api/projects/${teamLogic.a.values.currentTeamId}/app_metrics/${props.pluginConfigId}/historical_exports/${props.jobId}`)}]}})),Object(index_esm.events)((_ref3=>{let{actions:actions}=_ref3;return{afterMount:actions.loadExportData}}))]);function HistoricalExport(props){var _data$metrics,_data$summary,_data$summary2,_data$metrics2,_data$summary3;const{data:data,dataLoading:dataLoading}=Object(index_esm.useValues)(historicalExportLogic(props));return Object(jsx_runtime.jsxs)("div",{className:"mt-4 mb-4 mr-8",children:[Object(jsx_runtime.jsx)(card.a,{title:"Overview",children:Object(jsx_runtime.jsx)(MetricsOverview,{tab:AppMetricsTab.HistoricalExports,metrics:null!==(_data$metrics=null==data?void 0:data.metrics)&&void 0!==_data$metrics?_data$metrics:null,metricsLoading:dataLoading,exportDuration:null==data||null===(_data$summary=data.summary)||void 0===_data$summary?void 0:_data$summary.duration,exportFailureReason:null==data||null===(_data$summary2=data.summary)||void 0===_data$summary2?void 0:_data$summary2.failure_reason})}),Object(jsx_runtime.jsx)(card.a,{title:"Delivery trends",className:"mt-4",children:Object(jsx_runtime.jsx)(AppMetricsGraph_AppMetricsGraph,{tab:AppMetricsTab.HistoricalExports,metrics:null!==(_data$metrics2=null==data?void 0:data.metrics)&&void 0!==_data$metrics2?_data$metrics2:null,metricsLoading:dataLoading})}),Object(jsx_runtime.jsx)(card.a,{title:"Errors",className:"mt-4",children:Object(jsx_runtime.jsx)(ErrorsOverview,{errors:(null==data?void 0:data.errors)||[],loading:dataLoading,category:"exportEvents",jobId:null==data||null===(_data$summary3=data.summary)||void 0===_data$summary3?void 0:_data$summary3.job_id})})]})}try{HistoricalExport.displayName="HistoricalExport",HistoricalExport.__docgenInfo={description:"",displayName:"HistoricalExport",props:{pluginConfigId:{defaultValue:null,description:"",name:"pluginConfigId",required:!0,type:{name:"number"}},jobId:{defaultValue:null,description:"",name:"jobId",required:!0,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/apps/HistoricalExport.tsx#HistoricalExport"]={docgenInfo:HistoricalExport.__docgenInfo,name:"HistoricalExport",path:"frontend/src/scenes/apps/HistoricalExport.tsx#HistoricalExport"})}catch(__react_docgen_typescript_loader_error){}var columnUtils=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTable/columnUtils.tsx"),LemonTag=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTag/LemonTag.tsx"),progress=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_wcqkhtmu7mswc6yz4uyexck3ty/node_modules/antd/es/progress/index.js"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts");function HistoricalExportsTab(){const{historicalExports:historicalExports,historicalExportsLoading:historicalExportsLoading,pluginConfig:pluginConfig,interfaceJobsProps:interfaceJobsProps,hasRunningExports:hasRunningExports}=Object(index_esm.useValues)(appMetricsSceneLogic),{openHistoricalExportModal:openHistoricalExportModal,loadHistoricalExports:loadHistoricalExports}=Object(index_esm.useActions)(appMetricsSceneLogic);return Object(react.useEffect)((()=>{let timer;return function updateTimer(){hasRunningExports&&(timer=setTimeout((()=>{loadHistoricalExports(),updateTimer()}),2e4))}(),()=>timer&&clearTimeout(timer)}),[hasRunningExports]),Object(jsx_runtime.jsxs)("div",{className:"space-y-2",children:[Object(jsx_runtime.jsx)("div",{className:"flex items-center justify-end",children:Object(jsx_runtime.jsx)(LemonButton.a,{type:"primary",onClick:openHistoricalExportModal,disabled:!interfaceJobsProps,children:"Start new export"})}),Object(jsx_runtime.jsx)(LemonTable.a,{dataSource:historicalExports,loading:historicalExportsLoading,columns:[{title:"Dates exported",render:function Render(_,historicalExport){const[dateFrom,dateTo]=historicalExport.payload.dateRange;return dateFrom===dateTo?dateFrom:`${dateFrom} - ${dateTo}`}},{title:"Progress",width:130,render:function RenderProgress(_,historicalExport){switch(historicalExport.status){case"success":return Object(jsx_runtime.jsx)(LemonTag.a,{type:"success",className:"uppercase",children:"Success"});case"fail":return Object(jsx_runtime.jsx)(LemonTag.a,{type:"danger",className:"uppercase",children:"Failed"});case"not_finished":return Object(jsx_runtime.jsx)(progress.a,{percent:Math.floor(100*(historicalExport.progress||0))})}},align:"right"},Object(columnUtils.b)(),Object(columnUtils.a)()],expandable:{expandedRowRender:function Render(historicalExport){if(pluginConfig)return Object(jsx_runtime.jsx)(HistoricalExport,{pluginConfigId:pluginConfig.id,jobId:historicalExport.job_id})}},useURLForSorting:!1,noSortingCancellation:!0,emptyState:Object(jsx_runtime.jsxs)("div",{className:"",children:[Object(jsx_runtime.jsx)("b",{children:"Nothing has been exported yet!"}),interfaceJobsProps&&Object(jsx_runtime.jsx)("p",{className:"m-0",children:'Use "Start new export" button above to export historical data in a given time range.'})]})}),interfaceJobsProps&&Object(jsx_runtime.jsx)(PluginJobConfiguration.d,{...interfaceJobsProps})]})}var LemonLabel=__webpack_require__("./frontend/src/lib/lemon-ui/LemonLabel/LemonLabel.tsx"),LemonModal=__webpack_require__("./frontend/src/lib/lemon-ui/LemonModal/index.ts"),CodeSnippet=__webpack_require__("./frontend/src/lib/components/CodeSnippet/index.tsx");function ErrorDetailsModal(){var _activeErrorDetails$e,_activeErrorDetails$e2;const{errorDetails:errorDetails,errorDetailsModalError:errorDetailsModalError,errorDetailsLoading:errorDetailsLoading}=Object(index_esm.useValues)(appMetricsSceneLogic),{closeErrorDetailsModal:closeErrorDetailsModal}=Object(index_esm.useActions)(appMetricsSceneLogic),[page,setPage]=Object(react.useState)(0),activeErrorDetails=errorDetails[page];return Object(jsx_runtime.jsx)(LemonModal.a,{isOpen:!!errorDetailsModalError,onClose:closeErrorDetailsModal,title:errorDetailsModalError,width:"min(50vw, 80rem)",description:Object(jsx_runtime.jsx)("span",{children:null==activeErrorDetails||null===(_activeErrorDetails$e=activeErrorDetails.error_details)||void 0===_activeErrorDetails$e||null===(_activeErrorDetails$e2=_activeErrorDetails$e.error.message)||void 0===_activeErrorDetails$e2?void 0:_activeErrorDetails$e2.substring(0,200)}),footer:Object(jsx_runtime.jsx)("div",{className:"flex items-center justify-end gap-1 h-",children:errorDetailsLoading?Object(jsx_runtime.jsx)(LemonSkeleton.a,{className:"1-10"}):Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Object(jsx_runtime.jsxs)("span",{children:[page+1," of ",errorDetails.length," sample",errorDetails.length>1?"s":""]}),Object(jsx_runtime.jsx)(LemonButton.a,{icon:Object(jsx_runtime.jsx)(icons.z,{}),onClick:()=>setPage(page-1),disabled:0==page}),Object(jsx_runtime.jsx)(LemonButton.a,{icon:Object(jsx_runtime.jsx)(icons.A,{}),onClick:()=>setPage(page+1),disabled:page==errorDetails.length-1})]})}),children:!errorDetailsModalError||errorDetailsLoading?Object(jsx_runtime.jsx)(LemonSkeleton.a,{className:"h-10"}):Object(jsx_runtime.jsxs)("div",{className:"flex flex-col space-y-2",style:{height:"80vh"},children:[Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)(LemonLabel.a,{children:"When:"})," ",Object(jsx_runtime.jsx)(TZLabel.a,{time:activeErrorDetails.timestamp,showSeconds:!0})]}),activeErrorDetails.error_details.eventCount&&Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)(LemonLabel.a,{children:"Event Count"}),Object(jsx_runtime.jsx)("div",{children:activeErrorDetails.error_details.eventCount})]}),activeErrorDetails.error_details.error.message&&Object(jsx_runtime.jsx)(CollapsibleSection,{title:"Error message",defaultIsExpanded:!0,children:Object(jsx_runtime.jsx)(CodeSnippet.a,{wrap:!0,language:CodeSnippet.b.JavaScript,children:activeErrorDetails.error_details.error.message})}),activeErrorDetails.error_details.event&&Object(jsx_runtime.jsx)(CollapsibleSection,{title:"Event payload",defaultIsExpanded:!1,children:Object(jsx_runtime.jsx)(CodeSnippet.a,{wrap:!0,language:CodeSnippet.b.JSON,children:JSON.stringify(activeErrorDetails.error_details.event,null,2)})}),activeErrorDetails.error_details.error.stack&&Object(jsx_runtime.jsx)(CollapsibleSection,{title:"Stack trace",defaultIsExpanded:!1,children:Object(jsx_runtime.jsx)(CodeSnippet.a,{wrap:!0,language:CodeSnippet.b.JavaScript,children:activeErrorDetails.error_details.error.stack})})]})})}function CollapsibleSection(props){const[isExpanded,setIsExpanded]=Object(react.useState)(props.defaultIsExpanded);return Object(jsx_runtime.jsxs)("div",{className:"bg-mid border rounded",children:[Object(jsx_runtime.jsx)(LemonButton.a,{status:"stealth",fullWidth:!0,onClick:()=>setIsExpanded(!isExpanded),sideIcon:isExpanded?Object(jsx_runtime.jsx)(icons.ad,{}):Object(jsx_runtime.jsx)(icons.bd,{}),title:isExpanded?"Show less":"Show more",className:"bg-mid",children:props.title}),isExpanded&&Object(jsx_runtime.jsx)("div",{className:"bg-light p-2",children:props.children})]})}var ActivityLog=__webpack_require__("./frontend/src/lib/components/ActivityLog/ActivityLog.tsx"),humanizeActivity=__webpack_require__("./frontend/src/lib/components/ActivityLog/humanizeActivity.tsx");const scene={component:AppMetrics,logic:appMetricsSceneLogic,paramsToProps:_ref=>{var _parseInt;let{params:{pluginConfigId:pluginConfigId}}=_ref;return{pluginConfigId:null!==(_parseInt=parseInt(pluginConfigId))&&void 0!==_parseInt?_parseInt:0}}};function AppMetrics(){const{activeTab:activeTab,pluginConfig:pluginConfig,pluginConfigLoading:pluginConfigLoading,showTab:showTab,shouldShowAppMetrics:shouldShowAppMetrics}=Object(index_esm.useValues)(appMetricsSceneLogic),{setActiveTab:setActiveTab}=Object(index_esm.useActions)(appMetricsSceneLogic);return Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)(PageHeader.a,{title:pluginConfig?pluginConfig.plugin_info.name:Object(jsx_runtime.jsx)(LemonSkeleton.a,{}),caption:shouldShowAppMetrics&&pluginConfig?"An overview of metrics and exports for this app.":void 0}),pluginConfigLoading||!activeTab?Object(jsx_runtime.jsx)(LemonSkeleton.a,{}):Object(jsx_runtime.jsxs)(tabs.a,{tabPosition:"top",animated:!1,activeKey:activeTab,onTabClick:key=>setActiveTab(key),children:[showTab(AppMetricsTab.ProcessEvent)&&Object(jsx_runtime.jsx)(tabs.a.TabPane,{tab:"processEvent metrics",children:Object(jsx_runtime.jsx)(MetricsTab,{tab:AppMetricsTab.ProcessEvent})},AppMetricsTab.ProcessEvent),showTab(AppMetricsTab.OnEvent)&&Object(jsx_runtime.jsx)(tabs.a.TabPane,{tab:"onEvent metrics",children:Object(jsx_runtime.jsx)(MetricsTab,{tab:AppMetricsTab.OnEvent})},AppMetricsTab.OnEvent),showTab(AppMetricsTab.ExportEvents)&&Object(jsx_runtime.jsx)(tabs.a.TabPane,{tab:"exportEvents metrics",children:Object(jsx_runtime.jsx)(MetricsTab,{tab:AppMetricsTab.ExportEvents})},AppMetricsTab.ExportEvents),showTab(AppMetricsTab.ScheduledTask)&&Object(jsx_runtime.jsx)(tabs.a.TabPane,{tab:Object(jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Scheduled tasks"," ",Object(jsx_runtime.jsx)(Tooltip.a,{title:"Shows metrics for app methods `runEveryMinute`, `runEveryHour` and `runEveryDay`",children:Object(jsx_runtime.jsx)(icons.tb,{})})]}),children:Object(jsx_runtime.jsx)(MetricsTab,{tab:AppMetricsTab.ScheduledTask})},AppMetricsTab.ScheduledTask),showTab(AppMetricsTab.HistoricalExports)&&Object(jsx_runtime.jsx)(tabs.a.TabPane,{tab:"Historical exports",children:Object(jsx_runtime.jsx)(HistoricalExportsTab,{})},AppMetricsTab.HistoricalExports),Object(jsx_runtime.jsx)(tabs.a.TabPane,{tab:"History",children:Object(jsx_runtime.jsx)(ActivityLog.a,{scope:humanizeActivity.a.PLUGIN,id:null==pluginConfig?void 0:pluginConfig.id})},AppMetricsTab.History)]}),Object(jsx_runtime.jsx)(ErrorDetailsModal,{})]})}},"./node_modules/.pnpm/css-loader@3.6.0_webpack@4.46.0/node_modules/css-loader/dist/cjs.js!./node_modules/.pnpm/postcss-loader@4.3.0_dhonik3q6ff6ozbzdscnovq2ka/node_modules/postcss-loader/dist/cjs.js!./node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0+webpack@4.46.0/node_modules/sass-loader/dist/cjs.js?!./frontend/src/scenes/apps/AppMetricsGraph.scss":function(module,exports,__webpack_require__){(exports=__webpack_require__("./node_modules/.pnpm/css-loader@3.6.0_webpack@4.46.0/node_modules/css-loader/dist/runtime/api.js")(!1)).push([module.i,".AppMetricsGraph{height:300px}",""]),module.exports=exports}}]);