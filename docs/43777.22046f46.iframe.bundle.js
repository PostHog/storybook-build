"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[43777],{"./frontend/src/scenes/data-warehouse/editor/EditorScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{EditorScene:()=>EditorScene});var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),resizerLogic=__webpack_require__("./frontend/src/lib/components/Resizer/resizerLogic.ts");let editorSizingLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-warehouse","editor","editorSizingLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(props=>({values:[(0,resizerLogic.Z)(props.sourceNavigatorResizerProps),["desiredSize as sourceNavigatorDesiredSize"],(0,resizerLogic.Z)(props.queryPaneResizerProps),["desiredSize as queryPaneDesiredSize"]]})),(0,index_esm.selectors)({editorSceneRef:[()=>[(_,props)=>props.editorSceneRef],editorSceneRef=>editorSceneRef],sourceNavigatorWidth:[s=>[s.sourceNavigatorDesiredSize],desiredSize=>Math.max(desiredSize||350,100)],queryPaneHeight:[s=>[s.queryPaneDesiredSize],queryPaneDesiredSize=>Math.max(queryPaneDesiredSize||600,100)],queryTabsWidth:[s=>[s.queryPaneDesiredSize],desiredSize=>desiredSize||350],sourceNavigatorResizerProps:[()=>[(_,props)=>props.sourceNavigatorResizerProps],sourceNavigatorResizerProps=>sourceNavigatorResizerProps],queryPaneResizerProps:[()=>[(_,props)=>props.queryPaneResizerProps],queryPaneResizerProps=>queryPaneResizerProps]})]);var lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.2.0_kea@3.1.5/node_modules/kea-router/lib/index.js"),codeEditorLogic=__webpack_require__("./frontend/src/lib/monaco/codeEditorLogic.tsx"),dataNodeLogic=__webpack_require__("./frontend/src/queries/nodes/DataNode/dataNodeLogic.ts"),hogQLQueryEditorLogic=__webpack_require__("./frontend/src/queries/nodes/HogQLQuery/hogQLQueryEditorLogic.tsx"),schema=__webpack_require__("./frontend/src/queries/schema.ts"),Resizer=__webpack_require__("./frontend/src/lib/components/Resizer/Resizer.tsx"),LemonBanner=__webpack_require__("./frontend/src/lib/lemon-ui/LemonBanner/index.ts"),CodeEditor=__webpack_require__("./frontend/src/lib/monaco/CodeEditor.tsx"),AutoSizer=__webpack_require__("./node_modules/.pnpm/react-virtualized@9.22.5_react-dom@18.2.0_react@18.2.0/node_modules/react-virtualized/dist/es/AutoSizer/index.js"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function QueryPane(props){let{queryPaneHeight,queryPaneResizerProps}=(0,index_esm.useValues)(editorSizingLogic);return(0,jsx_runtime.jsxs)("div",{className:"relative flex flex-col w-full bg-bg-3000",style:{height:`${queryPaneHeight}px`},ref:queryPaneResizerProps.containerRef,children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[props.promptError?(0,jsx_runtime.jsx)(LemonBanner.V,{type:"warning",children:props.promptError}):null,(0,jsx_runtime.jsx)(AutoSizer.q,{children:_ref=>{let{height,width}=_ref;return(0,jsx_runtime.jsx)(CodeEditor.p,{className:"border",language:"hogQL",value:props.queryInput,height:height,width:width,...props.codeEditorProps,options:{minimap:{enabled:!1},wordWrap:"on",scrollBeyondLastLine:!1,automaticLayout:!0,fixedOverflowWidgets:!0,suggest:{showInlineDetails:!0},quickSuggestionsDelay:300}})}})]}),(0,jsx_runtime.jsx)(Resizer.w,{...queryPaneResizerProps})]})}var posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.8.5_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js");function QueryTabs(_ref){let{models,onClear,onClick,onAdd,activeModelUri}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-row overflow-scroll hide-scrollbar",children:[models.map(model=>(0,jsx_runtime.jsx)(QueryTab,{model:model,onClear:models.length>1?onClear:void 0,onClick:onClick,active:activeModelUri?.path===model.path},model.path)),(0,jsx_runtime.jsx)(src.Jp,{onClick:onAdd,icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{fontSize:14})})]})}function QueryTab(_ref2){let{model,active,onClear,onClick}=_ref2;return(0,jsx_runtime.jsxs)("button",{onClick:()=>onClick?.(model),className:(0,clsx_m.default)("space-y-px rounded-t p-1 flex flex-row items-center gap-1 hover:bg-[var(--bg-light)] cursor-pointer",active?"bg-[var(--bg-light)] border":"bg-bg-3000",onClear?"pl-3 pr-2":"px-3"),children:["Untitled",onClear&&(0,jsx_runtime.jsx)(src.Jp,{onClick:e=>{e.stopPropagation(),onClear(model)},size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{})})]})}__webpack_require__("./node_modules/.pnpm/react-data-grid@7.0.0-beta.47_react-dom@18.2.0_react@18.2.0/node_modules/react-data-grid/lib/styles.css");var bundle=__webpack_require__("./node_modules/.pnpm/react-data-grid@7.0.0-beta.47_react-dom@18.2.0_react@18.2.0/node_modules/react-data-grid/lib/bundle.js"),themeLogic=__webpack_require__("./frontend/src/layout/navigation-3000/themeLogic.ts"),ResultsTab=function(ResultsTab){return ResultsTab.Results="results",ResultsTab.Visualization="visualization",ResultsTab}(ResultsTab||{});function ResultPane(_ref){let{onQueryInputChange,onSave,saveDisabledReason}=_ref,{isDarkModeOn}=(0,index_esm.useValues)(themeLogic.b),{response,responseLoading}=(0,index_esm.useValues)(dataNodeLogic.M),columns=(0,react.useMemo)(()=>{var _response$columns$map;return null!==(_response$columns$map=response?.columns?.map(column=>({key:column,name:column,resizable:!0})))&&void 0!==_response$columns$map?_response$columns$map:[]},[response]),rows=(0,react.useMemo)(()=>response?.results?response?.results?.map(row=>{let rowObject={};return response.columns.forEach((column,i)=>{rowObject[column]=row[i]}),rowObject}):[],[response]);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col w-full flex-1 bg-bg-3000",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row justify-between align-center py-2 px-4 w-full h-[55px]",children:[(0,jsx_runtime.jsx)(src.TP,{activeKey:ResultsTab.Results,onChange:()=>{},tabs:[{key:ResultsTab.Results,label:"Results"}]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-1",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>onSave(),disabledReason:saveDisabledReason,children:"Save"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>onQueryInputChange(),children:"Run"})]})]}),(0,jsx_runtime.jsx)("div",{className:"flex flex-1 relative bg-dark justify-center items-center",children:responseLoading?(0,jsx_runtime.jsx)(src.$j,{className:"text-3xl"}):response?(0,jsx_runtime.jsx)("div",{className:"flex-1 absolute top-0 left-0 right-0 bottom-0",children:(0,jsx_runtime.jsx)(bundle.ZP,{className:isDarkModeOn?"rdg-dark h-full":"rdg-light h-full",columns:columns,rows:rows})}):(0,jsx_runtime.jsx)("span",{className:"text-muted mt-3",children:"Query results will appear here"})})]})}function QueryWindow(){let[monacoAndEditor,setMonacoAndEditor]=(0,react.useState)(null),[monaco,editor]=null!=monacoAndEditor?monacoAndEditor:[],key=lib.router.values.location.pathname,[query,setActiveQueryInput]=(0,react.useState)({kind:schema.OH.HogQLQuery,query:""}),logic=(0,hogQLQueryEditorLogic.y)({query,setQuery:query=>{setActiveQueryInput(query)},onChange:()=>{},key}),{queryInput,promptError}=(0,index_esm.useValues)(logic),{setQueryInput,saveQuery,saveAsView}=(0,index_esm.useActions)(logic),codeEditorKey=`hogQLQueryEditor/${lib.router.values.location.pathname}`,codeEditorLogicProps={key:codeEditorKey,sourceQuery:query,query:queryInput,language:"hogQL",metadataFilters:query.filters,monaco,editor,multitab:!0},{activeModelUri,allModels,hasErrors,error,isValidView}=(0,index_esm.useValues)((0,codeEditorLogic.Pc)(codeEditorLogicProps)),{createModel,setModel,deleteModel,setModels,addModel,updateState}=(0,index_esm.useActions)((0,codeEditorLogic.Pc)(codeEditorLogicProps)),modelKey=`hogQLQueryEditor/${activeModelUri?.path}`;(0,react.useEffect)(()=>{if(monaco&&activeModelUri){let _model=monaco.editor.getModel(activeModelUri),val=_model?.getValue();setQueryInput(null!=val?val:""),saveQuery()}},[activeModelUri]);let onAdd=(0,react.useCallback)(()=>{createModel()},[createModel]);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 flex-col h-full",children:[(0,jsx_runtime.jsx)(QueryTabs,{models:allModels,onClick:setModel,onClear:deleteModel,onAdd:onAdd,activeModelUri:activeModelUri}),(0,jsx_runtime.jsx)(QueryPane,{queryInput:queryInput,promptError:promptError,codeEditorProps:{onChange:v=>{setQueryInput(null!=v?v:""),updateState()},onMount:(editor,monaco)=>{setMonacoAndEditor([monaco,editor]);let allModelQueries=localStorage.getItem((0,codeEditorLogic.nz)(codeEditorKey)),activeModelUri=localStorage.getItem((0,codeEditorLogic.uj)(codeEditorKey));if(allModelQueries){monaco.editor.getModels().forEach(model=>{model.dispose()});let models=JSON.parse(allModelQueries||"[]"),newModels=[];if(models.forEach(model=>{if(monaco){let uri=monaco.Uri.parse(model.path),newModel=monaco.editor.createModel(model.query,"hogQL",uri);editor?.setModel(newModel),newModels.push(uri)}}),setModels(newModels),activeModelUri){let uri=monaco.Uri.parse(activeModelUri),activeModel=monaco.editor.getModels().find(model=>model.uri.path===uri.path);activeModel&&editor?.setModel(activeModel);let val=activeModel?.getValue();val&&(setQueryInput(val),saveQuery()),setModel(uri)}else newModels.length&&setModel(newModels[0])}else{let model=editor.getModel();model&&(addModel(model.uri),setModel(model.uri))}},onPressCmdEnter:(value,selectionType)=>{value&&"selection"===selectionType?saveQuery(value):saveQuery()}}}),(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:dataNodeLogic.M,props:{key:modelKey,query:query,doNotLoad:!query.query},children:(0,jsx_runtime.jsx)(ResultPane,{onQueryInputChange:saveQuery,onSave:saveAsView,saveDisabledReason:hasErrors?null!=error?error:"Query has errors":isValidView?"":"All fields must have an alias"})})]})}var DataWarehouseTables=__webpack_require__("./frontend/src/scenes/data-warehouse/external/DataWarehouseTables.tsx");let SchemaSearch=()=>(0,jsx_runtime.jsx)("div",{className:"flex items-center",children:(0,jsx_runtime.jsx)(src.DF,{className:"rounded-none",type:"search",placeholder:"Search for schema","data-attr":"schema-search",fullWidth:!0})});function SourceNavigator(){let{sourceNavigatorWidth,sourceNavigatorResizerProps}=(0,index_esm.useValues)(editorSizingLogic);return(0,jsx_runtime.jsxs)("div",{ref:sourceNavigatorResizerProps.containerRef,className:"relative flex flex-col bg-bg-3000 h-full overflow-hidden",style:{width:`${sourceNavigatorWidth}px`},children:[(0,jsx_runtime.jsx)(SchemaSearch,{}),(0,jsx_runtime.jsx)(DataWarehouseTables.f,{inline:!0,collapsible:!1}),(0,jsx_runtime.jsx)(Resizer.w,{...sourceNavigatorResizerProps})]})}function EditorScene(){let ref=(0,react.useRef)(null),navigatorRef=(0,react.useRef)(null),queryPaneRef=(0,react.useRef)(null);return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:editorSizingLogic,props:{editorSceneRef:ref,navigatorRef,sourceNavigatorResizerProps:{containerRef:navigatorRef,logicKey:"source-navigator",placement:"right"},queryPaneResizerProps:{containerRef:queryPaneRef,logicKey:"query-pane",placement:"bottom"}},children:(0,jsx_runtime.jsxs)("div",{className:"w-full h-full flex flex-row overflow-hidden",ref:ref,children:[(0,jsx_runtime.jsx)(SourceNavigator,{}),(0,jsx_runtime.jsx)(QueryWindow,{})]})})}}}]);