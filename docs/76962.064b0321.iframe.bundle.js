"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[76962],{"../../frontend/src/scenes/hog-functions/metrics/HogFunctionMetrics.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{k:()=>HogFunctionMetrics});var _posthog_icons__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.14.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib_Chart__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/Chart.ts"),lib_colors__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/colors.ts"),lib_components_DateFilter_DateFilter__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),lib_utils__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/lib/utils.tsx"),react__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),scenes_hog_functions_configuration_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx"),scenes_insights_InsightTooltip_InsightTooltip__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../frontend/src/scenes/insights/InsightTooltip/InsightTooltip.tsx"),_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("../../frontend/src/scenes/hog-functions/metrics/hogFunctionMetricsLogic.tsx"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let METRICS_INFO={succeeded:"Total number of events processed successfully",failed:"Total number of events that had errors during processing",filtered:"Total number of events that were filtered out",disabled_temporarily:"Total number of events that were skipped due to the destination being temporarily disabled (due to issues such as the destination being down or rate-limited)",disabled_permanently:"Total number of events that were skipped due to the destination being permanently disabled (due to prolonged issues with the destination)"};function HogFunctionMetrics(_ref){let{id}=_ref,logic=(0,_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_10__.O)({id}),{filters}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(logic),{type}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)((0,scenes_hog_functions_configuration_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_8__.nM)({id})),{setFilters,loadMetrics,loadMetricsTotals}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useActions)(logic);return(0,react__WEBPACK_IMPORTED_MODULE_7__.useEffect)(()=>{loadMetrics(),loadMetricsTotals()},[]),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(kea__WEBPACK_IMPORTED_MODULE_2__.BindLogic,{logic:_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_10__.O,props:{id},children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(AppMetricsTotals,{}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)("h2",{className:"mb-0",children:"Delivery trends"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)("div",{className:"flex-1"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Qw,{closeOnClickInside:!1,matchWidth:!1,placement:"right-end",overlay:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)("div",{className:"overflow-hidden deprecated-space-y-2 max-w-100",children:_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_10__._.filter(_ref2=>{let{value}=_ref2;return"fetch"!==value||"transformation"!==type}).map(_ref3=>{let{label,value}=_ref3;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{fullWidth:!0,icon:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Hw,{checked:filters?.name?.split(",").includes(value),className:"pointer-events-none"}),onClick:()=>{setFilters({name:filters?.name?.split(",").includes(value)?filters.name.split(",").filter(t=>t!=value).join(","):filters.name+","+value})},children:label},value)})}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{size:"small",type:"secondary",tooltip:"Filtering for any log groups containing any of the selected levels",children:"Filters"})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Yv,{options:[{label:"Hourly",value:"hour"},{label:"Daily",value:"day"},{label:"Weekly",value:"week"}],size:"small",value:filters.interval,onChange:value=>setFilters({interval:value})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(lib_components_DateFilter_DateFilter__WEBPACK_IMPORTED_MODULE_5__.f,{dateTo:filters.before,dateFrom:filters.after,onChange:(from,to)=>setFilters({after:from||void 0,before:to||void 0}),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconCalendar,{})," ",key]})})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(AppMetricsGraph,{})]})})}function AppMetricBigNumber(_ref4){let{label,value,tooltip}=_ref4;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.u,{title:tooltip,children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsxs)("div",{className:"flex flex-col flex-1 gap-2 items-center p-2 rounded border bg-surface-primary",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)("div",{className:"text-xs font-bold uppercase",children:label.replace(/_/g," ")}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)("div",{className:"flex flex-1 items-center mb-2 text-2xl",children:(0,lib_utils__WEBPACK_IMPORTED_MODULE_6__.Lc)(null!=value?value:0)})]})})}function AppMetricsTotals(){let{appMetricsTotals,appMetricsTotalsLoading}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_10__.O);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)("div",{className:"deprecated-space-y-4",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)("div",{className:"flex flex-wrap gap-2 items-center",children:Object.entries(METRICS_INFO).map(_ref5=>{let[key,value]=_ref5;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)("div",{className:"flex flex-col flex-1 h-30 min-w-30 max-w-100",children:appMetricsTotalsLoading?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.yW,{className:"w-full h-full"}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(AppMetricBigNumber,{label:key,value:appMetricsTotals?.totals?.[key],tooltip:value})},key)})})})}function AppMetricsGraph(){let{appMetrics,appMetricsLoading}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_10__.O),canvasRef=(0,react__WEBPACK_IMPORTED_MODULE_7__.useRef)(null),[popoverContent,setPopoverContent]=(0,react__WEBPACK_IMPORTED_MODULE_7__.useState)(null),[tooltipState,setTooltipState]=(0,react__WEBPACK_IMPORTED_MODULE_7__.useState)({x:0,y:0,visible:!1});return(0,react__WEBPACK_IMPORTED_MODULE_7__.useEffect)(()=>{let chart;if(canvasRef.current&&appMetrics&&!(0,lib_utils__WEBPACK_IMPORTED_MODULE_6__.es)())return chart=new lib_Chart__WEBPACK_IMPORTED_MODULE_3__.k(canvasRef.current?.getContext("2d"),{type:"line",data:{labels:appMetrics.labels,datasets:[...appMetrics.series.map(series=>({label:series.name,data:series.values,borderColor:"",...colorConfig(series.name)}))]},options:{scales:{x:{ticks:{maxRotation:0},grid:{display:!1}},y:{beginAtZero:!0}},plugins:{crosshair:!1,legend:{display:!1},tooltip:{enabled:!1,external(_ref6){let{tooltip,chart}=_ref6;setPopoverContent((0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(scenes_insights_InsightTooltip_InsightTooltip__WEBPACK_IMPORTED_MODULE_9__.Q,{embedded:!0,hideInspectActorsSection:!0,altTitle:tooltip.dataPoints[0].label,seriesData:tooltip.dataPoints.map((dp,i)=>({id:i,dataIndex:0,datasetIndex:0,label:dp.dataset.label,color:dp.dataset.borderColor,count:dp.dataset.data?.[dp.dataIndex]||0})),renderSeries:value=>value,renderCount:count=>(0,lib_utils__WEBPACK_IMPORTED_MODULE_6__.Lc)(count)}));let position=chart.canvas.getBoundingClientRect();setTooltipState({x:position.left+tooltip.caretX,y:position.top+tooltip.caretY,visible:tooltip.opacity>0})}}},maintainAspectRatio:!1,interaction:{mode:"index",axis:"x",intersect:!1}}}),()=>{chart?.destroy()}},[appMetrics]),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsxs)("div",{className:"relative border rounded p-6 bg-surface-primary h-[50vh]",children:[appMetricsLoading&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.t2,{}),!!appMetrics&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)("canvas",{ref:canvasRef}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.J2,{visible:tooltipState.visible,overlay:popoverContent,placement:"top",padded:!1,className:"pointer-events-none",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_11__.jsx)("div",{className:"fixed",style:{left:tooltipState.x,top:tooltipState.y}})})]})}function colorConfig(name){let color="";switch(name){case"succeeded":color=(0,lib_colors__WEBPACK_IMPORTED_MODULE_4__.cM)("success");break;case"failed":color=(0,lib_colors__WEBPACK_IMPORTED_MODULE_4__.cM)("danger");break;default:color=(0,lib_colors__WEBPACK_IMPORTED_MODULE_4__.cM)("data-color-1")}return{borderColor:color,hoverBorderColor:color,hoverBackgroundColor:color,backgroundColor:color,fill:!1,borderWidth:2,pointRadius:0}}},"../../frontend/src/scenes/hog-functions/testing/HogFunctionTesting.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{D:()=>HogFunctionTesting});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.14.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),DateFilter=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),PayGateMini=__webpack_require__("../../frontend/src/lib/components/PayGateMini/PayGateMini.tsx"),PropertyKeyInfo=__webpack_require__("../../frontend/src/lib/components/PropertyKeyInfo.tsx"),types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),EmptyStates=__webpack_require__("../../frontend/src/scenes/insights/EmptyStates/index.ts"),PersonDisplay=__webpack_require__("../../frontend/src/scenes/persons/PersonDisplay.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),src_types=__webpack_require__("../../frontend/src/types.ts"),hogFunctionConfigurationLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx"),hogFunctionTestLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionTestLogic.tsx"),HogFunctionFilters=__webpack_require__("../../frontend/src/scenes/hog-functions/filters/HogFunctionFilters.tsx"),LogsViewer=__webpack_require__("../../frontend/src/scenes/hog-functions/logs/LogsViewer.tsx"),fast_deep_equal=__webpack_require__("../../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"),fast_deep_equal_default=__webpack_require__.n(fast_deep_equal),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_subscriptions_lib=__webpack_require__("../../node_modules/.pnpm/kea-subscriptions@3.0.1_kea@3.1.5_react@18.2.0_/node_modules/kea-subscriptions/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts"),DataTable_utils=__webpack_require__("../../frontend/src/queries/nodes/DataTable/utils.ts"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),queries_utils=__webpack_require__("../../frontend/src/queries/utils.ts");let hogFunctionTestingLogic=(0,index_esm.kea)([(0,index_esm.path)(key=>["scenes","pipeline","hogFunctionTestingLogic",key]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.connect)(()=>({values:[hogFunctionConfigurationLogic.nM,["configuration","matchingFilters","templateId"],groupsModel.$,["groupTypes"]]})),(0,index_esm.actions)({changeDateRange:(after,before)=>({after,before}),addLoadingRetry:eventId=>({eventId}),removeLoadingRetry:eventId=>({eventId}),increaseCurrentPage:timestamp=>({timestamp}),decreaseCurrentPage:!0,resetCurrentPage:!0,expandRow:eventId=>({eventId}),collapseRow:eventId=>({eventId}),resetCollapsedRows:!0,selectForRetry:eventIds=>({eventIds}),deselectForRetry:eventIds=>({eventIds}),resetSelectedForRetry:!0,setSelectingMany:selectingMany=>({selectingMany})}),(0,index_esm.reducers)({dateRange:[{after:"-7d",before:null},{changeDateRange:(_,_ref2)=>{let{after,before}=_ref2;return{after,before}}}],loadingRetries:[[],{addLoadingRetry:(state,_ref3)=>{let{eventId}=_ref3;return[...state,eventId]},removeLoadingRetry:(state,_ref4)=>{let{eventId}=_ref4;return state.filter(id=>id!==eventId)}}],pageTimestamps:[[],{increaseCurrentPage:(state,_ref5)=>{let{timestamp}=_ref5;return[...state,timestamp]},decreaseCurrentPage:state=>[...state.filter((_,i)=>i!==state.length-1)],resetCurrentPage:()=>[]}],expandedRows:[[],{expandRow:(state,_ref6)=>{let{eventId}=_ref6;return[...state,eventId]},collapseRow:(state,_ref7)=>{let{eventId}=_ref7;return[...state.filter(id=>id!==eventId)]},resetCollapsedRows:()=>[]}],selectingMany:[!1,{setSelectingMany:(_,_ref8)=>{let{selectingMany}=_ref8;return selectingMany}}],selectedForRetry:[[],{selectForRetry:(state,_ref9)=>{let{eventIds}=_ref9;return[...new Set([...state,...eventIds])]},deselectForRetry:(state,_ref10)=>{let{eventIds}=_ref10;return[...state.filter(id=>!eventIds.includes(id))]},resetSelectedForRetry:()=>[]}]}),(0,kea_loaders_lib.loaders)(_ref11=>{let{values,props,actions}=_ref11;return{events:[{results:[],before:void 0},{loadEvents:async()=>{var _values$dateRange$bef;return values.baseEventsQuery?{...await api.ZP.query(values.baseEventsQuery),before:null!==(_values$dateRange$bef=values.dateRange.before)&&void 0!==_values$dateRange$bef?_values$dateRange$bef:void 0}:{results:[],before:void 0}},loadNextEventsPage:async()=>values.nextQuery?(actions.increaseCurrentPage(values.events.before),{...await api.ZP.query(values.nextQuery),before:values.nextQuery.before}):{...values.events,before:void 0},loadPreviousEventsPage:async()=>{if(!values.previousQuery)return{...values.events,before:void 0};let response=await api.ZP.query(values.previousQuery);return actions.decreaseCurrentPage(),{...response,before:values.previousQuery.before}}}],totalEvents:[0,{loadTotalEvents:async()=>{var _response$results$0$a;if(!values.totalEventsQuery)return 0;let response=await api.ZP.query(values.totalEventsQuery);return null!==(_response$results$0$a=response.results[0]?.aggregated_value)&&void 0!==_response$results$0$a?_response$results$0$a:0}}],retries:[[],{retryInvocation:async _ref12=>{let res,{eventId,globals}=_ref12;actions.addLoadingRetry(eventId);let configuration=(0,hogFunctionConfigurationLogic.r9)(values.configuration);configuration.template_id=values.templateId;try{var _props$id;res=await api.ZP.hogFunctions.createTestInvocation(null!==(_props$id=props.id)&&void 0!==_props$id?_props$id:"new",{globals,mock_async_functions:!1,configuration}),actions.removeLoadingRetry(eventId);let retry={eventId:eventId,...res};return[...values.retries,retry]}catch(e){src.UJ.error(`An unexpected server error occurred while testing the function. ${e}`)}return actions.removeLoadingRetry(eventId),[...values.retries]}}]}}),(0,index_esm.selectors)(_ref13=>{let{values}=_ref13;return{baseEventsQuery:[s=>[s.configuration,s.matchingFilters,s.groupTypes,s.dateRange],(configuration,matchingFilters,groupTypes,dateRange)=>{var _dateRange$after,_dateRange$before;let query={kind:schema_general.OH.EventsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,fixedProperties:[matchingFilters],limit:20,select:["*","person","timestamp"],after:null!==(_dateRange$after=dateRange?.after)&&void 0!==_dateRange$after?_dateRange$after:void 0,before:null!==(_dateRange$before=dateRange?.before)&&void 0!==_dateRange$before?_dateRange$before:void 0,orderBy:["timestamp DESC"],modifiers:{personsOnEventsMode:"person_id_no_override_properties_on_events"}};return groupTypes.forEach(groupType=>{let name=(0,queries_utils.AU)(groupType.group_type);query.select.push(`tuple(${name}.created_at, ${name}.index, ${name}.key, ${name}.properties, ${name}.updated_at)`)}),query},{resultEqualityCheck:fast_deep_equal_default()}],totalEventsQuery:[s=>[s.configuration,s.matchingFilters,s.dateRange],(configuration,matchingFilters,dateRange)=>({kind:schema_general.OH.TrendsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,series:[{kind:schema_general.OH.EventsNode,event:null,name:"All Events",math:src_types.vN.TotalCount}],properties:matchingFilters,dateRange:{date_from:dateRange.after,date_to:dateRange.before},trendsFilter:{display:src_types.Qb.BoldNumber},modifiers:{personsOnEventsMode:"person_id_no_override_properties_on_events"}}),{resultEqualityCheck:fast_deep_equal_default()}],eventsWithRetries:[s=>[s.events,s.retries],(events,retries)=>events.results.map(row=>[...row.slice(0,3),retries.filter(r=>r.eventId===row[0].uuid),...row.slice(3)])],nextQuery:[s=>[s.baseEventsQuery,s.events],(baseEventsQuery,events)=>{if(!baseEventsQuery||!events)return null;let typedResults=events?.results,sortColumnIndex=baseEventsQuery?.select.map(hql=>DataTable_utils.$p(hql)).indexOf("timestamp");if(-1!==sortColumnIndex){let lastTimestamp=typedResults?.[typedResults.length-1]?.[sortColumnIndex];if(lastTimestamp)return{...baseEventsQuery,before:lastTimestamp,limit:20}}return null}],previousQuery:[s=>[s.baseEventsQuery,s.events],(baseEventsQuery,events)=>{if(!baseEventsQuery||!events)return null;let lastTimestamp=values.pageTimestamps[values.pageTimestamps.length-1];return{...baseEventsQuery,before:lastTimestamp,limit:20}}]}}),(0,index_esm.listeners)(_ref14=>{let{actions}=_ref14;return{changeDateRange:()=>{actions.loadEvents()},loadEvents:()=>{actions.loadTotalEvents(),actions.resetCurrentPage(),actions.resetCollapsedRows(),actions.resetSelectedForRetry()},increaseCurrentPage:()=>{actions.resetSelectedForRetry()},decreaseCurrentPage:()=>{actions.resetSelectedForRetry()}}}),(0,kea_subscriptions_lib.Vt)(_ref15=>{let{actions,values}=_ref15;return{configuration:()=>{values.configuration?.name&&(actions.loadEvents(),actions.loadTotalEvents())}}}),(0,kea_router_lib.beforeUnload)(_ref16=>{let{values,cache}=_ref16;return{enabled:()=>!cache.disabledBeforeUnload&&values.loadingRetries.length>0,message:"You have running tests that will be discarded if you leave. Are you sure?",onConfirm:()=>{cache.disabledBeforeUnload=!0}}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let buildGlobals=(row,groupTypes,hogFunctionName)=>{let globals=(0,hogFunctionConfigurationLogic.Af)(row[0],row[1]);return globals.groups={},groupTypes.forEach((groupType,index)=>{let tuple=row?.[4+index];if(tuple&&Array.isArray(tuple)&&tuple[2]){let properties={};try{properties=JSON.parse(tuple[3])}catch(e){}globals.groups[groupType.group_type]={type:groupType.group_type,index:tuple[1],id:tuple[2],url:`${window.location.origin}/groups/${tuple[1]}/${encodeURIComponent(tuple[2])}`,properties}}}),globals.source={name:null!=hogFunctionName?hogFunctionName:"Unnamed",url:window.location.href.split("#")[0]},globals};function HogFunctionTesting(_ref){let{id}=_ref,{selectingMany,eventsWithRetries,loadingRetries,selectedForRetry}=(0,index_esm.useValues)(hogFunctionTestingLogic({id})),{setSelectingMany,retryInvocation,selectForRetry,deselectForRetry,resetSelectedForRetry}=(0,index_esm.useActions)(hogFunctionTestingLogic({id})),{loading,loaded,showPaygate,groupTypes,configuration,isConfigurationSubmitting,willReEnableOnSave,willChangeEnabledOnSave,configurationChanged}=(0,index_esm.useValues)((0,hogFunctionConfigurationLogic.nM)({id})),{submitConfiguration}=(0,index_esm.useActions)((0,hogFunctionConfigurationLogic.nM)({id}));return loading&&!loaded?(0,jsx_runtime.jsx)(src.t2,{}):loaded&&id?showPaygate?(0,jsx_runtime.jsx)(PayGateMini.E,{feature:src_types.P$.DATA_PIPELINES}):(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-3",children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[selectingMany?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>{setSelectingMany(!1),resetSelectedForRetry()},children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>selectedForRetry.length===eventsWithRetries.length?deselectForRetry(eventsWithRetries.map(row=>row[0].uuid)):selectForRetry(eventsWithRetries.map(row=>row[0].uuid)),children:(0,jsx_runtime.jsx)("span",{children:selectedForRetry.length===eventsWithRetries.length?"Deselect all":"Select all"})}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"primary",onClick:()=>{src.dn.open({title:"Test selected events",content:"Are you sure you want to test the selected events? Please don't close the window until the invocations have completed.",secondaryButton:{children:"Cancel"},primaryButton:{children:"Test selected events",onClick:()=>{eventsWithRetries.filter(row=>selectedForRetry.includes(row[0].uuid)).forEach(row=>{var _configuration$name;return retryInvocation({eventId:row[0].uuid,globals:buildGlobals(row,groupTypes,null!==(_configuration$name=configuration?.name)&&void 0!==_configuration$name?_configuration$name:"Unnamed")})})}}})},loading:loadingRetries.length>0,disabledReason:loadingRetries.length>0?"Please wait for the current tests to complete.":0===selectedForRetry.length?"No invocations selected":void 0,children:"Test selected"})]}):(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!0),children:"Select invocations"}),configurationChanged?(0,jsx_runtime.jsxs)(src.Jp,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,children:["Save",willReEnableOnSave?" & re-enable":willChangeEnabledOnSave?` & ${configuration.enabled?"enable":"disable"}`:""]}):null]})}),(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:(0,jsx_runtime.jsx)("span",{children:"This is a list of all events matching your filters. You can run the function using these historical events."})}),(0,jsx_runtime.jsx)(RunsFilters,{id:id}),(0,jsx_runtime.jsx)(TestingEventsList,{id:id})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"Hog function"})}function EmptyColumn(){return(0,jsx_runtime.jsx)(src.u,{title:"NULL",placement:"right",delayMs:0,children:(0,jsx_runtime.jsx)("span",{className:"cursor-default","aria-hidden":!0,children:"—"})})}function RunsFilters(_ref3){var _baseEventsQuery$afte,_baseEventsQuery$befo;let{id}=_ref3,logic=hogFunctionTestingLogic({id}),{eventsLoading,baseEventsQuery}=(0,index_esm.useValues)(logic),{loadEvents,changeDateRange,loadTotalEvents}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{loadEvents(),loadTotalEvents()},loading:eventsLoading,type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),size:"small",children:"Refresh"}),(0,jsx_runtime.jsx)(DateFilter.f,{dateFrom:null!==(_baseEventsQuery$afte=baseEventsQuery?.after)&&void 0!==_baseEventsQuery$afte?_baseEventsQuery$afte:void 0,dateTo:null!==(_baseEventsQuery$befo=baseEventsQuery?.before)&&void 0!==_baseEventsQuery$befo?_baseEventsQuery$befo:void 0,onChange:changeDateRange}),(0,jsx_runtime.jsx)(src.Qw,{closeOnClickInside:!1,matchWidth:!1,placement:"right-end",overlay:(0,jsx_runtime.jsx)(lib.Form,{logic:hogFunctionConfigurationLogic.nM,props:{id},formKey:"configuration",className:"deprecated-space-y-3",children:(0,jsx_runtime.jsx)(HogFunctionFilters.B,{embedded:!0})}),children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",children:"Filters"})})]})}function TestingEventsList(_ref4){let{id}=_ref4,logic=hogFunctionTestingLogic({id}),{eventsLoading,eventsWithRetries,totalEvents,pageTimestamps,expandedRows,loadingRetries,selectingMany,selectedForRetry}=(0,index_esm.useValues)(logic),{retryInvocation,loadNextEventsPage,loadPreviousEventsPage,expandRow,collapseRow,selectForRetry,deselectForRetry}=(0,index_esm.useActions)(logic),{groupTypes,configuration,logicProps}=(0,index_esm.useValues)((0,hogFunctionConfigurationLogic.nM)({id})),{setSampleGlobals,toggleExpanded}=(0,index_esm.useActions)((0,hogFunctionTestLogic.g)(logicProps));return(0,jsx_runtime.jsx)(src.g3,{dataSource:eventsWithRetries,loading:eventsLoading,loadingSkeletonRows:5,pagination:{controlled:!0,currentPage:pageTimestamps.length+1,onForward:loadNextEventsPage,onBackward:loadPreviousEventsPage,pageSize:eventsWithRetries.length,hideOnSinglePage:!1,entryCount:totalEvents},expandable:{isRowExpanded:_ref5=>{let[event]=_ref5;return expandedRows.includes(event.uuid)},onRowExpand:_ref6=>{let[event]=_ref6;return expandRow(event.uuid)},onRowCollapse:_ref7=>{let[event]=_ref7;return collapseRow(event.uuid)},noIndent:!0,expandedRowRender:_ref8=>{let[,,,retries]=_ref8;return(0,jsx_runtime.jsx)(src.g3,{dataSource:retries.reduce((acc,group)=>acc.concat(group.logs),[]),embedded:!0,columns:[{key:"spacer",width:0,render:()=>(0,jsx_runtime.jsx)("div",{className:"w-6"})},{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:(_,_ref9)=>{let{timestamp}=_ref9;return(0,jsx_runtime.jsx)(TZLabel.w,{time:timestamp})}},{title:"Level",key:"level",dataIndex:"level",render:(_,_ref10)=>{let{level}=_ref10;return(0,jsx_runtime.jsx)(src.oe,{type:(0,LogsViewer.n)(level),children:level.toUpperCase()})}},{title:"Message",key:"message",dataIndex:"message",render:(_,_ref11)=>{let{message}=_ref11;return(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}}]})}},columns:[{title:"Status",key:"status",width:0,render:(_,row)=>{let eventId=row[0].uuid,getStatus=()=>loadingRetries.includes(eventId)?{text:"Running",type:"warning"}:0===row[3].length?{text:"Not tested",type:"muted"}:"error"===row[3][row[3].length-1].status?{text:"Failure",type:"danger"}:"success"===row[3][row[3].length-1].status?{text:"Success",type:"success"}:{text:"Unknown",type:"muted"};return(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[selectingMany?(0,jsx_runtime.jsx)(src.Hw,{checked:selectedForRetry.includes(eventId),onChange:checked=>{checked?selectForRetry([eventId]):deselectForRetry([eventId])}}):null,(0,jsx_runtime.jsx)(src.oe,{type:getStatus().type,children:(0,utils.fm)(getStatus().text)}),(0,jsx_runtime.jsx)(src.d6,{items:[eventId?{label:"View event",to:urls.j.event(eventId,row[0].timestamp)}:null,{label:"Test event",onClick:()=>{var _configuration$name2;retryInvocation({eventId,globals:buildGlobals(row,groupTypes,null!==(_configuration$name2=configuration?.name)&&void 0!==_configuration$name2?_configuration$name2:"Unnamed")}),expandRow(eventId)}},{label:"Test with this event in configuration",onClick:()=>{var _configuration$name3;setSampleGlobals(buildGlobals(row,groupTypes,null!==(_configuration$name3=configuration?.name)&&void 0!==_configuration$name3?_configuration$name3:"Unnamed")),toggleExpanded(!0),kea_router_lib.router.actions.push(urls.j.hogFunction(id)+"?tab=configuration")}}],children:(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{className:"rotate-90"}),loading:!!loadingRetries.includes(eventId)||void 0})})]})}},{title:"Event",key:"event",className:"max-w-80",render:(_,_ref12)=>{let[event]=_ref12;return event.event?(0,jsx_runtime.jsx)(PropertyKeyInfo.T,{value:event.event,type:types.t.Events}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"Person",key:"person",render:(_,_ref13)=>{let[,person]=_ref13;return person?(0,jsx_runtime.jsx)(PersonDisplay.I,{person:person,withIcon:!0}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"URL / Screen",key:"url",className:"max-w-80",render:(_,_ref14)=>{let[event]=_ref14;return event.properties.$current_url||event.properties.$screen_name?(0,jsx_runtime.jsx)("span",{children:event.properties.$current_url||event.properties.$screen_name}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"Library",key:"library",className:"max-w-80",render:(_,_ref15)=>{let[event]=_ref15;return event.properties.$lib?(0,jsx_runtime.jsx)("span",{children:event.properties.$lib}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"Time",key:"time",className:"max-w-80",render:(_,_ref16)=>{let[event]=_ref16;return event.timestamp?(0,jsx_runtime.jsx)(TZLabel.w,{time:event.timestamp}):(0,jsx_runtime.jsx)(EmptyColumn,{})}}],emptyState:(0,jsx_runtime.jsx)(EmptyStates.dV,{})})}}}]);