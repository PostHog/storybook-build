"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[26746],{"../../frontend/src/scenes/heatmaps/components/heatmapsBrowserLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{p:()=>heatmapsBrowserLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),posthog_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/.pnpm/posthog-js@1.284.0/node_modules/posthog-js/dist/module.js"),lib_api__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_components_AuthorizedUrlList_authorizedUrlListLogic__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/components/AuthorizedUrlList/authorizedUrlListLogic.ts"),lib_components_IframedToolbarBrowser_utils__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/lib/components/IframedToolbarBrowser/utils.ts"),lib_components_heatmaps_heatmapDataLogic__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/lib/components/heatmaps/heatmapDataLogic.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../frontend/src/lib/utils.tsx"),scenes_session_recordings_player_sessionRecordingPlayerLogic__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../frontend/src/scenes/session-recordings/player/sessionRecordingPlayerLogic.ts"),_queries_utils__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("../../frontend/src/queries/utils.ts");let isUrlPattern=url=>/[*+?^${}()|[\]\\]/.test(url),normalizeUrlPath=urlObj=>(""===urlObj.pathname&&(urlObj.pathname="/"),urlObj.toString()),heatmapsBrowserLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","heatmaps","components","heatmapsBrowserLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)(()=>({values:[(0,lib_components_AuthorizedUrlList_authorizedUrlListLogic__WEBPACK_IMPORTED_MODULE_5__.zl)({...lib_components_AuthorizedUrlList_authorizedUrlListLogic__WEBPACK_IMPORTED_MODULE_5__.P1,type:lib_components_AuthorizedUrlList_authorizedUrlListLogic__WEBPACK_IMPORTED_MODULE_5__.uw.TOOLBAR_URLS}),["urlsKeyed","checkUrlIsAuthorized"],(0,lib_components_heatmaps_heatmapDataLogic__WEBPACK_IMPORTED_MODULE_7__.y)({context:"in-app"}),["heatmapEmpty","hrefMatchType"]],actions:[(0,lib_components_heatmaps_heatmapDataLogic__WEBPACK_IMPORTED_MODULE_7__.y)({context:"in-app"}),["loadHeatmap","setHref","setHrefMatchType"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setBrowserSearch:searchTerm=>({searchTerm}),setDataUrl:url=>({url}),setDisplayUrl:url=>({url}),onIframeLoad:!0,sendToolbarMessage:(type,payload)=>({type,payload}),loadTopUrls:!0,maybeLoadTopUrls:!0,loadBrowserSearchResults:!0,patchHeatmapFilters:filters=>({filters}),setHeatmapColorPalette:Palette=>({Palette}),setHeatmapFixedPositionMode:mode=>({mode}),setCommonFilters:filters=>({filters}),setIframeWidth:width=>({width}),toggleFilterPanelCollapsed:!0,setIframeBanner:banner=>({banner}),startTrackingLoading:!0,stopTrackingLoading:!0,setReplayIframeData:replayIframeData=>({replayIframeData}),setReplayIframeDataURL:url=>({url})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref=>{let{values}=_ref;return{browserSearchResults:[null,{loadBrowserSearchResults:async()=>{if(!values.browserSearchTerm)return[];let query=(0,_queries_utils__WEBPACK_IMPORTED_MODULE_10__.zP)`
                        SELECT distinct properties.$current_url AS urls
                        FROM events
                        WHERE timestamp >= now() - INTERVAL 7 DAY
                        AND timestamp <= now()
                        AND properties.$current_url like '%${_queries_utils__WEBPACK_IMPORTED_MODULE_10__.zP.identifier(values.browserSearchTerm)}%'
                        ORDER BY timestamp DESC
                        LIMIT 100`,res=await lib_api__WEBPACK_IMPORTED_MODULE_4__.ZP.queryHogQL(query);return res.results?.map(x=>x[0])}}],topUrls:[null,{loadTopUrls:async()=>{let query=(0,_queries_utils__WEBPACK_IMPORTED_MODULE_10__.zP)`
                        SELECT properties.$current_url AS url, count() as count
                        FROM events
                        WHERE timestamp >= now() - INTERVAL 7 DAY
                        AND event in ('$pageview', '$autocapture')
                        AND timestamp <= now()
                        GROUP BY properties.$current_url
                        ORDER BY count DESC
                        LIMIT 10`,res=await lib_api__WEBPACK_IMPORTED_MODULE_4__.ZP.queryHogQL(query);return res.results?.map(x=>({url:x[0],count:x[1]}))}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({hasValidReplayIframeData:[!1,{setReplayIframeData:(_,_ref2)=>{let{replayIframeData}=_ref2;return!!replayIframeData?.url?.trim().length&&!!replayIframeData?.html.trim().length}}],replayIframeData:[null,{setReplayIframeData:(_,_ref3)=>{let{replayIframeData}=_ref3;return replayIframeData},setReplayIframeDataURL:(state,_ref4)=>{let{url}=_ref4;return null===state?null:{...state,url}}}],filterPanelCollapsed:[!1,{persist:!0},{toggleFilterPanelCollapsed:state=>!state}],commonFilters:[{date_from:"-7d"},{setCommonFilters:(_,_ref5)=>{let{filters}=_ref5;return filters}}],heatmapColorPalette:["default",{setHeatmapColorPalette:(_,_ref6)=>{let{Palette}=_ref6;return Palette}}],heatmapFilters:[lib_components_IframedToolbarBrowser_utils__WEBPACK_IMPORTED_MODULE_6__._f,{patchHeatmapFilters:(state,_ref7)=>{let{filters}=_ref7;return{...state,...filters}}}],heatmapFixedPositionMode:["fixed",{setHeatmapFixedPositionMode:(_,_ref8)=>{let{mode}=_ref8;return mode}}],iframeWidth:[null,{setIframeWidth:(_,_ref9)=>{let{width}=_ref9;return width}}],browserSearchTerm:["",{setBrowserSearch:(_,_ref10)=>{let{searchTerm}=_ref10;return searchTerm}}],dataUrl:[null,{setDataUrl:(_,_ref11)=>{let{url}=_ref11;return url}}],loading:[!1,{setDataUrl:(state,_ref12)=>{let{url}=_ref12;return!!url?.trim().length||state},setDisplayUrl:(state,_ref13)=>{let{url}=_ref13;return!!url?.trim().length||state},setIframeBanner:(state,_ref14)=>{let{banner}=_ref14;return banner?.level!="error"&&state},startTrackingLoading:()=>!0,stopTrackingLoading:()=>!1}],iframeBanner:[null,{setIframeBanner:(_,_ref15)=>{let{banner}=_ref15;return banner}}],widthOverride:[1024,{setIframeWidth:(_,_ref16)=>{let{width}=_ref16;return width}}],displayUrl:[null,{setDisplayUrl:(_,_ref17)=>{let{url}=_ref17;return url}}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({browserUrlSearchOptions:[s=>[s.browserSearchResults,s.topUrls,s.browserSearchTerm],(browserSearchResults,topUrls,browserSearchTerm)=>{var _topUrls$map;return browserSearchTerm?browserSearchResults:null!==(_topUrls$map=topUrls?.map(x=>x.url))&&void 0!==_topUrls$map?_topUrls$map:[]}],isBrowserUrlAuthorized:[s=>[s.dataUrl,s.checkUrlIsAuthorized],(dataUrl,checkUrlIsAuthorized)=>!!dataUrl&&checkUrlIsAuthorized(dataUrl)],isBrowserUrlValid:[s=>[s.dataUrl],dataUrl=>{if(!dataUrl)return!0;try{return new URL(dataUrl),dataUrl.includes("://")}catch{return!1}}],viewportRange:[s=>[s.heatmapFilters,s.iframeWidth],(heatmapFilters,iframeWidth)=>iframeWidth?(0,lib_components_IframedToolbarBrowser_utils__WEBPACK_IMPORTED_MODULE_6__.f6)(heatmapFilters,iframeWidth):{min:0,max:1800}],noPageviews:[s=>[s.topUrlsLoading,s.topUrls],(topUrlsLoading,topUrls)=>!topUrlsLoading&&(!topUrls||0===topUrls.length)]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref18=>{let{actions,props,values,cache}=_ref18;return{setDisplayUrl:_ref19=>{var _url$trim;let{url}=_ref19;actions.setDataUrl(null!==(_url$trim=url?.trim())&&void 0!==_url$trim?_url$trim:null)},setReplayIframeData:_ref20=>{let{replayIframeData}=_ref20;if(replayIframeData&&replayIframeData.url){actions.setHref(replayIframeData.url);let isPattern=isUrlPattern(replayIframeData.url);actions.setHrefMatchType(isPattern?"pattern":"exact")}else(0,scenes_session_recordings_player_sessionRecordingPlayerLogic__WEBPACK_IMPORTED_MODULE_9__.x4)()},setBrowserSearch:async(_ref21,breakpoint)=>{let{searchTerm}=_ref21;await breakpoint(200),actions.loadBrowserSearchResults(),searchTerm&&isUrlPattern(searchTerm)&&(actions.setHrefMatchType("pattern"),actions.setHref(searchTerm))},sendToolbarMessage:_ref22=>{let{type,payload}=_ref22;props.iframeRef?.current?.contentWindow?.postMessage({type,payload},"*")},onIframeLoad:()=>{var _values$dataUrl;let url=null!==(_values$dataUrl=values.dataUrl)&&void 0!==_values$dataUrl?_values$dataUrl:"";actions.setHref(url);let isPattern=isUrlPattern(url);actions.setHrefMatchType(isPattern?"pattern":"exact"),actions.loadHeatmap(),posthog_js__WEBPACK_IMPORTED_MODULE_3__.ZP.capture("in-app heatmap iframe loaded",{inapp_heatmap_page_url_visited:values.dataUrl,inapp_heatmap_filters:values.heatmapFilters,inapp_heatmap_color_palette:values.heatmapColorPalette,inapp_heatmap_fixed_position_mode:values.heatmapFixedPositionMode})},maybeLoadTopUrls:()=>{values.topUrls||values.topUrlsLoading||actions.loadTopUrls()},setReplayIframeDataURL:async(_ref23,breakpoint)=>{let{url}=_ref23;if(await breakpoint(150),url?.trim().length){actions.setHref(url);let isPattern=isUrlPattern(url);actions.setHrefMatchType(isPattern?"pattern":"exact")}},setDataUrl:_ref24=>{let{url}=_ref24;if(actions.maybeLoadTopUrls(),url?.trim().length){actions.startTrackingLoading();let normalizedUrl=url.trim(),isPattern=isUrlPattern(normalizedUrl);isPattern||(normalizedUrl=normalizeUrlPath(new URL(normalizedUrl))),actions.setHref(normalizedUrl),actions.setHrefMatchType(isPattern?"pattern":"exact")}},startTrackingLoading:()=>{actions.setIframeBanner(null),cache.disposables.add(()=>{let timerId=setTimeout(()=>{actions.setIframeBanner({level:"error",message:"The heatmap failed to load (or is very slow)."})},7500);return()=>clearTimeout(timerId)},"errorTimeout")},stopTrackingLoading:()=>{actions.setIframeBanner(null),cache.disposables.dispose("errorTimeout"),cache.disposables.dispose("warnTimeout")}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref25=>{let{actions,values}=_ref25;values.dataUrl?.trim().length&&values.displayUrl?.trim().length?actions.startTrackingLoading():actions.maybeLoadTopUrls()}),(0,kea_router__WEBPACK_IMPORTED_MODULE_2__.urlToAction)(_ref26=>{let{actions,values}=_ref26;return{"/heatmaps":(_,searchParams)=>{searchParams.pageURL&&searchParams.pageURL!==values.displayUrl&&actions.setDisplayUrl(searchParams.pageURL),searchParams.dataUrl&&searchParams.dataUrl!==values.dataUrl&&actions.setDataUrl(searchParams.dataUrl),searchParams.heatmapFilters&&!(0,lib_utils__WEBPACK_IMPORTED_MODULE_8__.h0)(searchParams.heatmapFilters,values.heatmapFilters)&&actions.patchHeatmapFilters(searchParams.heatmapFilters),searchParams.heatmapPalette&&searchParams.heatmapPalette!==values.heatmapColorPalette&&actions.setHeatmapColorPalette(searchParams.heatmapPalette),searchParams.heatmapFixedPositionMode&&searchParams.heatmapFixedPositionMode!==values.heatmapFixedPositionMode&&actions.setHeatmapFixedPositionMode(searchParams.heatmapFixedPositionMode),searchParams.commonFilters&&!(0,lib_utils__WEBPACK_IMPORTED_MODULE_8__.h0)(searchParams.commonFilters,values.commonFilters)&&actions.setCommonFilters(searchParams.commonFilters)},"/heatmaps/recording":(_,searchParams)=>{if(searchParams.iframeStorage){let replayFrameData=JSON.parse(localStorage.getItem(searchParams.iframeStorage)||"{}");actions.setReplayIframeData(replayFrameData)}}}}),(0,kea_router__WEBPACK_IMPORTED_MODULE_2__.actionToUrl)(_ref27=>{let{values}=_ref27;return{setDisplayUrl:_ref28=>{let{url}=_ref28,searchParams={...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,pageURL:url};return url&&""!==url.trim()||delete searchParams.pageURL,[kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.location.pathname,searchParams,kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.hashParams,{replace:!0}]},setDataUrl:_ref29=>{let{url}=_ref29,searchParams={...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,dataUrl:url};return url&&""!==url.trim()||delete searchParams.dataUrl,[kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.location.pathname,searchParams,kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.hashParams,{replace:!0}]},patchHeatmapFilters:()=>{let searchParams={...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,heatmapFilters:values.heatmapFilters};return[kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.location.pathname,searchParams,kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.hashParams,{replace:!0}]},setHeatmapColorPalette:_ref30=>{let{Palette}=_ref30,searchParams={...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,heatmapPalette:Palette};return[kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.location.pathname,searchParams,kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.hashParams,{replace:!0}]},setHeatmapFixedPositionMode:_ref31=>{let{mode}=_ref31,searchParams={...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,heatmapFixedPositionMode:mode};return[kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.location.pathname,searchParams,kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.hashParams,{replace:!0}]},setCommonFilters:_ref32=>{let{filters}=_ref32,searchParams={...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,commonFilters:filters};return[kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.location.pathname,searchParams,kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.hashParams,{replace:!0}]}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.beforeUnmount)(()=>{})])},"../../frontend/src/scenes/heatmaps/scenes/heatmap/heatmapLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{X:()=>heatmapLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_router__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),kea_subscriptions__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea-subscriptions@3.0.1_kea@3.1.7_react@18.2.0_/node_modules/kea-subscriptions/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_components_heatmaps_heatmapDataLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/components/heatmaps/heatmapDataLogic.ts"),scenes_heatmaps_components_heatmapsBrowserLogic__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/scenes/heatmaps/components/heatmapsBrowserLogic.ts"),scenes_heatmaps_scenes_heatmaps_heatmapsSceneLogic__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/heatmaps/scenes/heatmaps/heatmapsSceneLogic.ts");let heatmapLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","heatmaps","scenes","heatmap","heatmapLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({id:"new"}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.key)(props=>props.id),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)(()=>({values:[scenes_heatmaps_components_heatmapsBrowserLogic__WEBPACK_IMPORTED_MODULE_5__.p,["dataUrl","displayUrl","isBrowserUrlAuthorized","widthOverride"]],actions:[scenes_heatmaps_components_heatmapsBrowserLogic__WEBPACK_IMPORTED_MODULE_5__.p,["setDataUrl","setDisplayUrl","onIframeLoad","setIframeWidth"],scenes_heatmaps_scenes_heatmaps_heatmapsSceneLogic__WEBPACK_IMPORTED_MODULE_6__.lF,["loadSavedHeatmaps"],(0,lib_components_heatmaps_heatmapDataLogic__WEBPACK_IMPORTED_MODULE_4__.y)({context:"in-app"}),["loadHeatmap","setWindowWidthOverride"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({load:!0,createHeatmap:!0,updateHeatmap:!0,setLoading:loading=>({loading}),setType:type=>({type}),setWidth:width=>({width}),setName:name=>({name}),setScreenshotUrl:url=>({url}),setScreenshotError:error=>({error}),setGeneratingScreenshot:generating=>({generating}),pollScreenshotStatus:(id,width)=>({id,width}),setHeatmapId:id=>({id}),setScreenshotLoaded:screenshotLoaded=>({screenshotLoaded})}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({type:["screenshot",{setType:(_,_ref)=>{let{type}=_ref;return type}}],width:[1024,{setWidth:(_,_ref2)=>{let{width}=_ref2;return width}}],name:["New heatmap",{setName:(_,_ref3)=>{let{name}=_ref3;return name}}],loading:[!1,{setLoading:(_,_ref4)=>{let{loading}=_ref4;return loading}}],status:["processing",{setStatus:(_,_ref5)=>{let{status}=_ref5;return status}}],screenshotUrl:[null,{setScreenshotUrl:(_,_ref6)=>{let{url}=_ref6;return url}}],screenshotError:[null,{setScreenshotError:(_,_ref7)=>{let{error}=_ref7;return error}}],generatingScreenshot:[!1,{setGeneratingScreenshot:(_,_ref8)=>{let{generating}=_ref8;return generating}}],screenshotLoading:[!1,{setScreenshotUrl:()=>!1}],heatmapId:[null,{setHeatmapId:(_,_ref9)=>{let{id}=_ref9;return id}}],screenshotLoaded:[!1,{setScreenshotLoaded:(_,_ref10)=>{let{screenshotLoaded}=_ref10;return screenshotLoaded}}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref11=>{let{actions,values,props}=_ref11;return{load:async()=>{if(props.id&&"new"!==String(props.id)){actions.setLoading(!0);try{let item=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.savedHeatmaps.get(props.id);if(actions.setHeatmapId(item.id),actions.setName(item.name),actions.setDisplayUrl(item.url),actions.setDataUrl(item.data_url),actions.setType(item.type),"screenshot"===item.type){var _values$widthOverride;let desiredWidth=null!==(_values$widthOverride=values.widthOverride)&&void 0!==_values$widthOverride?_values$widthOverride:1024;"completed"===item.status&&item.has_content?(actions.setScreenshotUrl(`/api/environments/${window.POSTHOG_APP_CONTEXT?.current_team?.id}/heatmap_screenshots/${item.id}/content/?width=${desiredWidth}`),actions.loadHeatmap()):"failed"===item.status?actions.setScreenshotError(item.exception||"Screenshot generation failed"):(actions.setScreenshotError(null),actions.pollScreenshotStatus(item.id,desiredWidth))}}finally{actions.setLoading(!1)}}},setIframeWidth:async _ref12=>{var _ref13;let{width}=_ref12;if("screenshot"!==values.type||!values.heatmapId)return;let w=null!==(_ref13=null!=width?width:values.widthOverride)&&void 0!==_ref13?_ref13:1024;actions.setScreenshotError(null),actions.setScreenshotUrl(`/api/environments/${window.POSTHOG_APP_CONTEXT?.current_team?.id}/heatmap_screenshots/${values.heatmapId}/content/?width=${w}`),actions.setWindowWidthOverride(w)},pollScreenshotStatus:async(_ref14,breakpoint)=>{let{id,width}=_ref14,attempts=0;for(actions.setGeneratingScreenshot(!0);attempts<60;){await breakpoint(2e3);try{let contentResponse=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.heatmapScreenshots.getContent(id);if(contentResponse.success){let w=null!=width?width:1024;actions.setScreenshotUrl(`/api/environments/${window.POSTHOG_APP_CONTEXT?.current_team?.id}/heatmap_screenshots/${id}/content/?width=${w}`),actions.loadHeatmap(),actions.setGeneratingScreenshot(!1);break}{let screenshot=contentResponse.data;if("completed"===screenshot.status&&screenshot.has_content){let w=null!=width?width:1024;actions.setScreenshotUrl(`/api/environments/${window.POSTHOG_APP_CONTEXT?.current_team?.id}/heatmap_screenshots/${screenshot.id}/content/?width=${w}`),actions.loadHeatmap(),actions.setGeneratingScreenshot(!1);break}if("failed"===screenshot.status){actions.setScreenshotError(screenshot.exception||screenshot.error||"Screenshot generation failed"),actions.setGeneratingScreenshot(!1);break}}attempts++}catch(e){actions.setScreenshotError("Failed to check screenshot status"),console.error(e);break}}attempts>=60&&actions.setScreenshotError("Screenshot generation timed out")},createHeatmap:async()=>{actions.setLoading(!0);try{let data={name:values.name,url:values.displayUrl||"",data_url:values.dataUrl,type:values.type},created=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.savedHeatmaps.create(data);actions.loadSavedHeatmaps(),kea_router__WEBPACK_IMPORTED_MODULE_1__.router.actions.push(`/heatmaps/${created.short_id}`)}finally{actions.setLoading(!1)}},updateHeatmap:async()=>{actions.setLoading(!0);try{let data={name:values.name,url:values.displayUrl||"",data_url:values.dataUrl,type:values.type};await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.savedHeatmaps.update(props.id,data)}finally{actions.setLoading(!1)}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({isDisplayUrlValid:[s=>[s.displayUrl],displayUrl=>{if(!displayUrl)return!0;try{return new URL(displayUrl),displayUrl.includes("://")}catch{return!1}}]}),(0,kea_subscriptions__WEBPACK_IMPORTED_MODULE_2__.Vt)(_ref15=>{let{actions}=_ref15;return{widthOverride:widthOverride=>{actions.setWindowWidthOverride(widthOverride)}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref16=>{let{actions}=_ref16;actions.load()})])},"../../frontend/src/scenes/heatmaps/scenes/heatmaps/heatmapsSceneLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{JY:()=>HEATMAPS_PER_PAGE,lF:()=>heatmapsSceneLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib_api__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/utils.tsx"),lib_utils_deleteWithUndo__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/utils/deleteWithUndo.tsx"),scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts"),scenes_scenes__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/scenes/scenes.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/urls.ts");let DEFAULT_HEATMAP_FILTERS={createdBy:"All users",search:"",page:1,order:"-created_at"},HEATMAPS_PER_PAGE=30,heatmapsSceneLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","heatmaps","scenes","heatmaps","heatmapsSceneLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({loadSavedHeatmaps:!0,setSavedHeatmaps:items=>({items}),setLoading:loading=>({loading}),deleteHeatmap:short_id=>({short_id}),setHeatmapsFilters:filters=>({filters}),setTotalCount:count=>({count})}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({savedHeatmaps:[[],{setSavedHeatmaps:(_,_ref)=>{let{items}=_ref;return items}}],savedHeatmapsLoading:[!1,{setLoading:(_,_ref2)=>{let{loading}=_ref2;return loading}}],filters:[DEFAULT_HEATMAP_FILTERS,{persist:!0},{setHeatmapsFilters:(_,_ref3)=>{let{filters}=_ref3;return filters}}],totalCount:[0,{setTotalCount:(_,_ref4)=>{let{count}=_ref4;return count}}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(()=>({breadcrumbs:[()=>[],()=>[{key:scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_4__.x.Heatmaps,name:scenes_scenes__WEBPACK_IMPORTED_MODULE_5__.lc[scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_4__.x.Heatmaps].name||"Heatmaps",path:scenes_urls__WEBPACK_IMPORTED_MODULE_6__.j.heatmaps(),iconType:scenes_scenes__WEBPACK_IMPORTED_MODULE_5__.lc[scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_4__.x.Heatmaps].iconType||"default_icon_type"}]]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref5=>{let{actions,values}=_ref5;return{loadSavedHeatmaps:async(_,breakpoint)=>{(0,lib_utils__WEBPACK_IMPORTED_MODULE_2__.h0)(values.filters,DEFAULT_HEATMAP_FILTERS)||await breakpoint(300),actions.setLoading(!0);try{let f=values.filters||{},createdBy="All users"===f.createdBy?void 0:f.createdBy,params={search:f.search||"",createdBy:createdBy||"All users",page:f.page||1,order:f.order||"-created_at",limit:HEATMAPS_PER_PAGE,offset:Math.max(0,(f.page-1||0)*HEATMAPS_PER_PAGE)},response=await lib_api__WEBPACK_IMPORTED_MODULE_1__.ZP.savedHeatmaps.list(params);actions.setSavedHeatmaps(response.results||[]),actions.setTotalCount(response.count||0)}finally{actions.setLoading(!1)}},deleteHeatmap:async _ref6=>{let{short_id}=_ref6,item=values.savedHeatmaps.find(h=>h.short_id===short_id),object={id:item?.id,short_id,name:item?.name||item?.url||"Heatmap"};await (0,lib_utils_deleteWithUndo__WEBPACK_IMPORTED_MODULE_3__.S)({object,idField:"short_id",endpoint:"environments/@current/saved",callback:()=>actions.loadSavedHeatmaps()})},setHeatmapsFilters:()=>{actions.loadSavedHeatmaps()}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref7=>{let{actions}=_ref7;actions.loadSavedHeatmaps()})])}}]);
//# sourceMappingURL=26746.1d4bed6a.iframe.bundle.js.map