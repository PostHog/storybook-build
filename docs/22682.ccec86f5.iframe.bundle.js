"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[22682],{"./frontend/src/scenes/instance/DeadLetterQueue/DeadLetterQueue.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{DeadLetterQueue:()=>DeadLetterQueue,scene:()=>scene});var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),LemonTabs=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTabs/index.ts"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts"),lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts");let DeadLetterQueueTab=function(DeadLetterQueueTab){return DeadLetterQueueTab.Metrics="metrics",DeadLetterQueueTab.Management="management",DeadLetterQueueTab.Settings="settings",DeadLetterQueueTab}({}),deadLetterQueueLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","instance","DeadLetterQueue","deadLetterQueueLogic"]),(0,index_esm.actions)({setActiveTab:tabKey=>({tabKey}),loadMoreRows:key=>({key}),addRowsToMetric:(key,rows)=>({key,rows})}),(0,index_esm.reducers)({activeTab:[DeadLetterQueueTab.Metrics,{setActiveTab:(_,_ref)=>{let{tabKey}=_ref;return tabKey}}],rowsPerMetric:[{},{addRowsToMetric:(state,_ref2)=>{let{key,rows}=_ref2;return{...state,[key]:[...state[key]||[],...rows]}},loadDeadLetterQueueMetricsSuccess:(_,_ref3)=>{let{deadLetterQueueMetrics}=_ref3,rowsPerMetric={};for(let metric of deadLetterQueueMetrics)metric.subrows&&(rowsPerMetric[metric.key]=metric.subrows.rows);return rowsPerMetric}}]}),(0,lib.loaders)({deadLetterQueueMetrics:[[],{loadDeadLetterQueueMetrics:async()=>userLogic.userLogic.values.user?.is_staff?(await api.ZP.get("api/dead_letter_queue")).results:[]}]}),(0,index_esm.listeners)(_ref4=>{let{values,actions}=_ref4;return{loadMoreRows:async _ref5=>{let{key}=_ref5,offset=values.rowsPerMetric[key]?.length+1;if(offset){let res=await api.ZP.get(`api/dead_letter_queue/${key}?offset=${offset}`);actions.addRowsToMetric(key,res.subrows.rows)}}}}),(0,index_esm.selectors)({singleValueMetrics:[s=>[s.deadLetterQueueMetrics],deadLetterQueueMetrics=>deadLetterQueueMetrics.filter(metric=>!metric.subrows)],tableMetrics:[s=>[s.deadLetterQueueMetrics],deadLetterQueueMetrics=>deadLetterQueueMetrics.filter(metric=>!!metric.subrows)]}),(0,index_esm.afterMount)(_ref6=>{let{actions}=_ref6;actions.loadDeadLetterQueueMetrics()})]);var src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonTable=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTable/index.ts"),Spinner=__webpack_require__("./frontend/src/lib/lemon-ui/Spinner/Spinner.tsx"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function MetricsTab(){let{user}=(0,index_esm.useValues)(userLogic.userLogic),{singleValueMetrics,tableMetrics,deadLetterQueueMetricsLoading,rowsPerMetric}=(0,index_esm.useValues)(deadLetterQueueLogic),{loadDeadLetterQueueMetrics,loadMoreRows}=(0,index_esm.useActions)(deadLetterQueueLogic);return user?.is_staff?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("div",{className:"mb-4 float-right",children:(0,jsx_runtime.jsx)(LemonButton.J,{icon:deadLetterQueueMetricsLoading?(0,jsx_runtime.jsx)(Spinner.$,{}):(0,jsx_runtime.jsx)(icons.tr8,{}),onClick:loadDeadLetterQueueMetrics,type:"secondary",size:"small",children:"Refresh"})}),(0,jsx_runtime.jsx)("div",{className:"flex space-x-8 mb-4",children:singleValueMetrics.map(row=>(0,jsx_runtime.jsxs)("div",{className:"space-y-1",children:[(0,jsx_runtime.jsx)("div",{children:row.metric}),(0,jsx_runtime.jsx)("div",{className:"text-2xl",children:(row.value||"0").toLocaleString("en-US")})]},row.key))}),tableMetrics.map(row=>(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h2",{children:row.metric}),(0,jsx_runtime.jsx)(LemonTable.g,{columns:[{title:row.subrows?.columns[0],dataIndex:"key"},{title:row.subrows?.columns[1],dataIndex:"value"}],dataSource:rowsPerMetric[row.key].map(_ref=>{let[key,value]=_ref;return{key,value}})||[],loading:deadLetterQueueMetricsLoading,defaultSorting:{columnKey:"value",order:-1},embedded:!0}),(0,jsx_runtime.jsx)("div",{className:"flex justify-center m-4 text-center",children:(0,jsx_runtime.jsx)(LemonButton.J,{disabledReason:rowsPerMetric[row.key].length%10!=0&&"No more values",onClick:()=>loadMoreRows(row.key),children:"Load more values"})}),(0,jsx_runtime.jsx)(src.LemonDivider,{})]},row.key))]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})}let scene={component:DeadLetterQueue,logic:deadLetterQueueLogic};function DeadLetterQueue(){let{user}=(0,index_esm.useValues)(userLogic.userLogic),{activeTab}=(0,index_esm.useValues)(deadLetterQueueLogic),{setActiveTab}=(0,index_esm.useActions)(deadLetterQueueLogic);return user?.is_staff?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(PageHeader.m,{caption:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("p",{children:"Manage your instance's dead letter queue."})})}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:activeTab,onChange:key=>setActiveTab(key),tabs:[{label:"Metrics",key:DeadLetterQueueTab.Metrics}]}),activeTab===DeadLetterQueueTab.Metrics?(0,jsx_runtime.jsx)(MetricsTab,{}):null]}):(0,jsx_runtime.jsx)(PageHeader.m,{caption:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"Only users with staff access can manage the dead letter queue. Please contact your instance admin."}),(0,jsx_runtime.jsxs)("p",{children:["If you're an admin and don't have access, set ",(0,jsx_runtime.jsx)("code",{children:"is_staff=true"})," for your user on the PostgreSQL ",(0,jsx_runtime.jsx)("code",{children:"posthog_user"})," table."]})]})})}}}]);