"use strict";(self.webpackChunk_posthog_frontend=self.webpackChunk_posthog_frontend||[]).push([[19555,75964],{"./src/scenes/pipeline/hogfunctions/HogFunctionConfiguration.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{g:()=>HogFunctionConfiguration});var posthog_icons_es=__webpack_require__("../node_modules/.pnpm/@posthog+icons@0.10.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("./@posthog/lemon-ui/src/index.ts"),clsx_m=__webpack_require__("../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),kea_router_lib=__webpack_require__("../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),NotFound=__webpack_require__("./src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("./src/lib/components/PageHeader.tsx"),PayGateButton=__webpack_require__("./src/lib/components/PayGateMini/PayGateButton.tsx"),PayGateMini=__webpack_require__("./src/lib/components/PayGateMini/PayGateMini.tsx"),useFeatureFlag=__webpack_require__("./src/lib/hooks/useFeatureFlag.ts"),More=__webpack_require__("./src/lib/lemon-ui/LemonButton/More.tsx"),LemonField=__webpack_require__("./src/lib/lemon-ui/LemonField/index.ts"),CodeEditorResizable=__webpack_require__("./src/lib/monaco/CodeEditorResizable.tsx"),urls=__webpack_require__("./src/scenes/urls.ts"),types=__webpack_require__("./src/types.ts"),DestinationTag=__webpack_require__("./src/scenes/pipeline/destinations/DestinationTag.tsx"),chartjs_plugin_trendline=__webpack_require__("../node_modules/.pnpm/chartjs-plugin-trendline@2.1.2/node_modules/chartjs-plugin-trendline/src/chartjs-plugin-trendline.js"),PropertyFilters=__webpack_require__("./src/lib/components/PropertyFilters/PropertyFilters.tsx"),TaxonomicFilter_types=__webpack_require__("./src/lib/components/TaxonomicFilter/types.ts"),TestAccountFiltersSwitch=__webpack_require__("./src/lib/components/TestAccountFiltersSwitch.tsx"),ActionFilter=__webpack_require__("./src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("./src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),groupsModel=__webpack_require__("./src/models/groupsModel.ts"),schema_general=__webpack_require__("./src/queries/schema/schema-general.ts"),fast_deep_equal=__webpack_require__("../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"),fast_deep_equal_default=__webpack_require__.n(fast_deep_equal),kea_loaders_lib=__webpack_require__("../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_subscriptions_lib=__webpack_require__("../node_modules/.pnpm/kea-subscriptions@3.0.1_kea@3.1.5_react@18.2.0_/node_modules/kea-subscriptions/lib/index.js"),api=__webpack_require__("./src/lib/api.ts"),dayjs=__webpack_require__("./src/lib/dayjs.ts"),utils=__webpack_require__("./src/lib/utils.tsx"),deleteWithUndo=__webpack_require__("./src/lib/utils/deleteWithUndo.tsx"),dist_module=__webpack_require__("../node_modules/.pnpm/posthog-js@1.220.0/node_modules/posthog-js/dist/module.js"),person_utils=__webpack_require__("./src/scenes/persons/person-utils.ts"),hogfunctions_urls=__webpack_require__("./src/scenes/pipeline/hogfunctions/urls.ts"),pipelineNodeLogic=__webpack_require__("./src/scenes/pipeline/pipelineNodeLogic.tsx"),projectLogic=__webpack_require__("./src/scenes/projectLogic.ts"),teamLogic=__webpack_require__("./src/scenes/teamLogic.tsx"),userLogic=__webpack_require__("./src/scenes/userLogic.ts"),DataTable_utils=__webpack_require__("./src/queries/nodes/DataTable/utils.ts"),query=__webpack_require__("./src/queries/query.ts"),queries_utils=__webpack_require__("./src/queries/utils.ts");let NEW_FUNCTION_TEMPLATE={id:"new",free:!1,type:"destination",name:"",description:"",inputs_schema:[],hog:"print('Hello, world!');",status:"stable"},TYPES_WITH_GLOBALS=["transformation","destination"];function sanitizeConfiguration(data){function sanitizeInputs(data){let sanitizedInputs={};return data.inputs_schema?.forEach(input=>{let secret=data.inputs?.[input.key]?.secret,value=data.inputs?.[input.key]?.value;if(secret){sanitizedInputs[input.key]={value:"********",secret:!0};return}if("json"===input.type&&"string"==typeof value)try{value=JSON.parse(value)}catch(e){}sanitizedInputs[input.key]={value:value}}),sanitizedInputs}return{...data,filters:data.filters,mappings:data.mappings?.map(mapping=>({...mapping,inputs:sanitizeInputs(mapping)})),inputs:sanitizeInputs(data),masking:data.masking?.hash?data.masking:null,icon_url:data.icon_url}}let templateToConfiguration=template=>{var _template$type;function getInputs(inputs_schema){let inputs={};return inputs_schema?.forEach(schema=>{void 0!==schema.default&&(inputs[schema.key]={value:schema.default})}),inputs}function getMappingInputs(inputs_schema){let inputs={};return inputs_schema?.forEach(schema=>{void 0!==schema.default&&(inputs[schema.key]={value:schema.default})}),inputs}return{type:null!==(_template$type=template.type)&&void 0!==_template$type?_template$type:"destination",name:template.name,description:template.description,inputs_schema:template.inputs_schema,filters:template.filters,mappings:template.mappings?.map(mapping=>({...mapping,inputs:getMappingInputs(mapping.inputs_schema)})),hog:template.hog,icon_url:template.icon_url,inputs:getInputs(template.inputs_schema),enabled:"broadcast"!==template.type}};function convertToHogFunctionInvocationGlobals(event,person){var _team$id,_team$name,_event$uuid,_event$elements_chain,_event$uuid2,_person$id;let team=teamLogic.H.findMounted()?.values?.currentTeam,projectUrl=`${window.location.origin}/project/${team?.id}`;return{project:{id:null!==(_team$id=team?.id)&&void 0!==_team$id?_team$id:0,name:null!==(_team$name=team?.name)&&void 0!==_team$name?_team$name:"Default project",url:projectUrl},event:{uuid:null!==(_event$uuid=event.uuid)&&void 0!==_event$uuid?_event$uuid:"",event:event.event,distinct_id:event.distinct_id,elements_chain:null!==(_event$elements_chain=event.elements_chain)&&void 0!==_event$elements_chain?_event$elements_chain:"",properties:event.properties,timestamp:event.timestamp,url:`${projectUrl}/events/${encodeURIComponent(null!==(_event$uuid2=event.uuid)&&void 0!==_event$uuid2?_event$uuid2:"")}/${encodeURIComponent(event.timestamp)}`},person:{id:null!==(_person$id=person.id)&&void 0!==_person$id?_person$id:"",properties:person.properties,name:(0,person_utils.y)(person),url:`${projectUrl}/person/${encodeURIComponent(event.distinct_id)}`},groups:{}}}let hogFunctionConfigurationLogic=(0,index_esm.kea)([(0,index_esm.path)(id=>["scenes","pipeline","hogFunctionConfigurationLogic",id]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{var _ref2;let{id,templateId}=_ref;return null!==(_ref2=null!=id?id:templateId)&&void 0!==_ref2?_ref2:"new"}),(0,index_esm.connect)(_ref3=>{let{id}=_ref3;return{values:[projectLogic.K,["currentProjectId","currentProject"],groupsModel.$,["groupTypes"],userLogic.userLogic,["hasAvailableFeature"]],actions:[(0,pipelineNodeLogic.y)({id:`hog-${id}`,stage:types.We.Destination}),["setBreadcrumbTitle"]]}}),(0,index_esm.actions)({setShowSource:showSource=>({showSource}),resetForm:!0,upsertHogFunction:configuration=>({configuration}),duplicate:!0,duplicateFromTemplate:!0,resetToTemplate:!0,deleteHogFunction:!0,sparklineQueryChanged:sparklineQuery=>({sparklineQuery}),personsCountQueryChanged:personsCountQuery=>({personsCountQuery}),loadSampleGlobals:!0,setUnsavedConfiguration:configuration=>({configuration}),persistForUnload:!0,setSampleGlobalsError:error=>({error}),setSampleGlobals:sampleGlobals=>({sampleGlobals}),setShowEventsList:showEventsList=>({showEventsList})}),(0,index_esm.reducers)(_ref4=>{let{props}=_ref4;return{sampleGlobals:[null,{setSampleGlobals:(_,_ref5)=>{let{sampleGlobals}=_ref5;return sampleGlobals}}],showSource:[!!(!props.id&&props.templateId?.startsWith("template-blank-")),{setShowSource:(_,_ref6)=>{let{showSource}=_ref6;return showSource}}],hasHadSubmissionErrors:[!1,{upsertHogFunctionFailure:()=>!0}],unsavedConfiguration:[null,{persist:!0},{setUnsavedConfiguration:(_,_ref7)=>{let{configuration}=_ref7;return configuration?{timestamp:Date.now(),configuration}:null}}],sampleGlobalsError:[null,{loadSampleGlobals:()=>null,setSampleGlobalsError:(_,_ref8)=>{let{error}=_ref8;return error}}],showEventsList:[!1,{setShowEventsList:(_,_ref9)=>{let{showEventsList}=_ref9;return showEventsList}}]}}),(0,kea_loaders_lib.loaders)(_ref10=>{let{actions,props,values}=_ref10;return{template:[null,{loadTemplate:async()=>{if(!props.templateId)return null;if("new"===props.templateId)return{...NEW_FUNCTION_TEMPLATE};let res=await api.ZP.hogFunctions.getTemplate(props.templateId);if(!res)throw Error("Template not found");return res}}],hogFunction:[null,{loadHogFunction:async()=>props.id&&"new"!==props.id?await api.ZP.hogFunctions.get(props.id):null,upsertHogFunction:async _ref11=>{let{configuration}=_ref11,res=props.id&&"new"!==props.id?await api.ZP.hogFunctions.update(props.id,configuration):await api.ZP.hogFunctions.create(configuration);return dist_module.ZP.capture("hog function saved",{id:res.id,template_id:res.template?.id,template_name:res.template?.name}),src.UJ.success("Configuration saved"),res}}],sparkline:[null,{sparklineQueryChanged:async(_ref12,breakpoint)=>{var _result$results$0$dat;let{sparklineQuery}=_ref12;if("destination"!==values.type&&"site_destination"!==values.type)return null;null===values.sparkline?await breakpoint(100):await breakpoint(1e3);let result=await (0,query.jr)(sparklineQuery);breakpoint();let[underThreshold,overThreshold]=(null!==(_result$results$0$dat=result?.results?.[0]?.data)&&void 0!==_result$results$0$dat?_result$results$0$dat:[]).reduce((acc,val)=>(acc[0].push(Math.min(val,1e3)),acc[1].push(Math.max(0,val-1e3)),acc),[[],[]]);return{data:[{name:"Low volume",values:underThreshold,color:"success"},{name:"High volume",values:overThreshold,color:"warning"}],count:result?.results?.[0]?.count,labels:result?.results?.[0]?.labels}}}],personsCount:[null,{personsCountQueryChanged:async(_ref13,breakpoint)=>{var _result$results$0$;let{personsCountQuery}=_ref13;if("broadcast"!==values.type)return null;null===values.personsCount?await breakpoint(100):await breakpoint(1e3);let result=await (0,query.jr)(personsCountQuery);return breakpoint(),null!==(_result$results$0$=result?.results?.[0]?.[0])&&void 0!==_result$results$0$?_result$results$0$:null}}],sampleGlobals:[null,{loadSampleGlobals:async(_,breakpoint)=>{var _values$configuration,_e$message;if(!values.lastEventQuery)return values.sampleGlobals;let errorMessage="No events match these filters in the last 30 days. Showing an example $pageview event instead.";try{await breakpoint(null===values.sampleGlobals?10:1e3);let response=await (0,query.jr)(values.lastEventQuery);if(!response?.results?.[0]&&values.lastEventSecondQuery&&(response=await (0,query.jr)(values.lastEventSecondQuery)),!response?.results?.[0])throw Error(errorMessage);let event=response?.results?.[0]?.[0],person=response?.results?.[0]?.[1],globals=convertToHogFunctionInvocationGlobals(event,person);return globals.groups={},values.groupTypes.forEach((groupType,index)=>{let tuple=response?.results?.[0]?.[2+index];if(tuple&&Array.isArray(tuple)&&tuple[2]){let properties={};try{properties=JSON.parse(tuple[3])}catch(e){}globals.groups[groupType.group_type]={type:groupType.group_type,index:tuple[1],id:tuple[2],url:`${window.location.origin}/groups/${tuple[1]}/${encodeURIComponent(tuple[2])}`,properties}}}),globals.source={name:null!==(_values$configuration=values.configuration?.name)&&void 0!==_values$configuration?_values$configuration:"Unnamed",url:window.location.href.split("#")[0]},globals}catch(e){return(0,index_esm.isBreakpoint)(e)||actions.setSampleGlobalsError(null!==(_e$message=e.message)&&void 0!==_e$message?_e$message:errorMessage),values.exampleInvocationGlobals}}}]}}),(0,lib.forms)(_ref14=>{let{values,props,asyncActions}=_ref14;return{configuration:{defaults:{},alwaysShowErrors:!0,errors:data=>({name:data.name?void 0:"Name is required",mappings:"site_destination"!==data.type||data.mappings&&0!==data.mappings.length?void 0:"You must add at least one mapping",filters:"internal_destination"===data.type&&data.filters?.events?.length===0?"You must choose a filter":void 0,...values.inputFormErrors}),submit:async data=>{let payload=sanitizeConfiguration(data);payload.template_id=props.templateId||values.hogFunction?.template?.id,values.hasAddon||(delete payload.hog,delete payload.inputs_schema),await asyncActions.upsertHogFunction(payload)}}}}),(0,index_esm.selectors)(()=>({logicProps:[()=>[(_,props)=>props],props=>props],type:[s=>[s.configuration,s.hogFunction],(configuration,hogFunction)=>{var _ref15,_configuration$type;return null!==(_ref15=null!==(_configuration$type=configuration?.type)&&void 0!==_configuration$type?_configuration$type:hogFunction?.type)&&void 0!==_ref15?_ref15:"loading"}],hasAddon:[s=>[s.hasAvailableFeature],hasAvailableFeature=>hasAvailableFeature(types.P$.DATA_PIPELINES)],hasGroupsAddon:[s=>[s.hasAvailableFeature],hasAvailableFeature=>hasAvailableFeature(types.P$.GROUP_ANALYTICS)],showPaygate:[s=>[s.template,s.hasAddon],(template,hasAddon)=>template&&!template.free&&!hasAddon],useMapping:[s=>[s.hogFunction,s.template],(hogFunction,template)=>Array.isArray(hogFunction?.mappings)||template?.mapping_templates?.length],defaultFormState:[s=>[s.template,s.hogFunction],(template,hogFunction)=>template?templateToConfiguration(template):null!=hogFunction?hogFunction:null],templateId:[s=>[s.template,s.hogFunction],(template,hogFunction)=>template?.id||hogFunction?.template?.id],loading:[s=>[s.hogFunctionLoading,s.templateLoading],(hogFunctionLoading,templateLoading)=>hogFunctionLoading||templateLoading],loaded:[s=>[s.hogFunction,s.template],(hogFunction,template)=>!!hogFunction||!!template],inputFormErrors:[s=>[s.configuration],configuration=>{var _configuration$inputs;let inputs=null!==(_configuration$inputs=configuration.inputs)&&void 0!==_configuration$inputs?_configuration$inputs:{},inputErrors={};return configuration.inputs_schema?.forEach(input=>{let key=input.key,value=inputs[key]?.value;if(inputs[key]?.secret)return;let missing=null==value||""===value;if(input.required&&missing&&(inputErrors[key]="This field is required"),"json"===input.type&&"string"==typeof value)try{JSON.parse(value)}catch(e){inputErrors[key]="Invalid JSON"}if("email"===input.type&&value){let emailTemplateErrors={html:value.html?void 0:"HTML is required",subject:value.subject?void 0:"Subject is required",from:value.from?void 0:"From is required",to:value.to?void 0:"To is required"};Object.values(emailTemplateErrors).some(v=>!!v)&&(inputErrors[key]={value:emailTemplateErrors})}}),Object.keys(inputErrors).length>0?{inputs:inputErrors}:null}],willReEnableOnSave:[s=>[s.configuration,s.hogFunction],(configuration,hogFunction)=>{var _hogFunction$status$s;return configuration?.enabled&&(null!==(_hogFunction$status$s=hogFunction?.status?.state)&&void 0!==_hogFunction$status$s?_hogFunction$status$s:0)>=3}],willChangeEnabledOnSave:[s=>[s.configuration,s.hogFunction],(configuration,hogFunction)=>{var _hogFunction$enabled;return configuration?.enabled!==(null!==(_hogFunction$enabled=hogFunction?.enabled)&&void 0!==_hogFunction$enabled&&_hogFunction$enabled)}],exampleInvocationGlobals:[s=>[s.configuration,s.currentProject,s.groupTypes],(configuration,currentProject,groupTypes)=>{var _configuration$name;let currentUrl=window.location.href.split("#")[0],eventId=(0,utils.Vj)(),personId=(0,utils.Vj)(),globals={event:{uuid:eventId,distinct_id:(0,utils.Vj)(),event:"$pageview",timestamp:(0,dayjs.Bv)().toISOString(),elements_chain:"",properties:{$current_url:currentUrl,$browser:"Chrome"},url:`${window.location.origin}/project/${currentProject?.id}/events/`},person:{id:personId,properties:{email:"example@posthog.com"},name:"Example person",url:`${window.location.origin}/person/${personId}`},groups:{},project:{id:currentProject?.id||0,name:currentProject?.name||"",url:`${window.location.origin}/project/${currentProject?.id}`},source:{name:null!==(_configuration$name=configuration?.name)&&void 0!==_configuration$name?_configuration$name:"Unnamed",url:currentUrl}};return groupTypes.forEach(groupType=>{let id=(0,utils.Vj)();globals.groups[groupType.group_type]={id:id,type:groupType.group_type,index:groupType.group_type_index,url:`${window.location.origin}/groups/${groupType.group_type_index}/${encodeURIComponent(id)}`,properties:{}}}),globals}],globalsWithInputs:[s=>[s.sampleGlobals,s.exampleInvocationGlobals,s.configuration],(sampleGlobals,exampleInvocationGlobals,configuration)=>{let inputs={};for(let input of configuration?.inputs_schema||[])inputs[input.key]=input.type;return{...null!=sampleGlobals?sampleGlobals:exampleInvocationGlobals,inputs}}],matchingFilters:[s=>[s.configuration,s.useMapping],(configuration,useMapping)=>{var _configuration$filter,_configuration$filter2,_configuration$filter3,_event$properties,_action$properties,_configuration$filter4;if(useMapping&&!configuration.mappings?.length)return{type:types.J2.And,values:[{type:types.J2.And,values:[{type:types.FT.HogQL,key:"false"}]}]};let seriesProperties={type:types.J2.Or,values:[]},properties={type:types.J2.And,values:[seriesProperties]},allPossibleEventFilters=null!==(_configuration$filter=configuration.filters?.events)&&void 0!==_configuration$filter?_configuration$filter:[],allPossibleActionFilters=null!==(_configuration$filter2=configuration.filters?.actions)&&void 0!==_configuration$filter2?_configuration$filter2:[];if(Array.isArray(configuration.mappings))for(let mapping of configuration.mappings)mapping.filters?.events&&allPossibleEventFilters.push(...mapping.filters.events),mapping.filters?.actions&&allPossibleActionFilters.push(...mapping.filters.actions);for(let event of allPossibleEventFilters){let eventProperties=[...null!==(_event$properties=event.properties)&&void 0!==_event$properties?_event$properties:[]];event.id&&eventProperties.push({type:types.FT.HogQL,key:(0,queries_utils.zP)`event = ${event.id}`}),0===eventProperties.length&&eventProperties.push({type:types.FT.HogQL,key:"true"}),seriesProperties.values.push({type:types.J2.And,values:eventProperties})}for(let action of allPossibleActionFilters){let actionProperties=[...null!==(_action$properties=action.properties)&&void 0!==_action$properties?_action$properties:[]];action.id&&actionProperties.push({type:types.FT.HogQL,key:(0,queries_utils.zP)`matchesAction(${parseInt(action.id)})`}),seriesProperties.values.push({type:types.J2.And,values:actionProperties})}if((null!==(_configuration$filter3=configuration.filters?.properties?.length)&&void 0!==_configuration$filter3?_configuration$filter3:0)>0){let globalProperties={type:types.J2.And,values:[]};for(let property of null!==(_configuration$filter4=configuration.filters?.properties)&&void 0!==_configuration$filter4?_configuration$filter4:[])globalProperties.values.push(property);properties.values.push(globalProperties)}return properties},{resultEqualityCheck:fast_deep_equal_default()}],sparklineQuery:[s=>[s.configuration,s.matchingFilters,s.type],(configuration,matchingFilters,type)=>"destination"!==type&&"site_destination"!==type?null:{kind:schema_general.OH.TrendsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,series:[{kind:schema_general.OH.EventsNode,event:null,name:"All Events",math:types.vN.TotalCount}],properties:matchingFilters,interval:"day",dateRange:{date_from:"-7d"},trendsFilter:{display:types.Qb.ActionsBar}},{resultEqualityCheck:fast_deep_equal_default()}],personsCountQuery:[s=>[s.configuration,s.type],(configuration,type)=>"broadcast"!==type?null:{kind:schema_general.OH.ActorsQuery,properties:configuration.filters?.properties,select:["count()"]},{resultEqualityCheck:fast_deep_equal_default()}],personsListQuery:[s=>[s.configuration,s.type],(configuration,type)=>"broadcast"!==type?null:{kind:schema_general.OH.DataTableNode,source:{kind:schema_general.OH.ActorsQuery,properties:configuration.filters?.properties,select:["person","properties.email","created_at"]},full:!0},{resultEqualityCheck:fast_deep_equal_default()}],baseEventsQuery:[s=>[s.configuration,s.matchingFilters,s.groupTypes,s.type],(configuration,matchingFilters,groupTypes,type)=>{if(!TYPES_WITH_GLOBALS.includes(type))return null;let query={kind:schema_general.OH.EventsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,fixedProperties:[matchingFilters],select:["*","person"],after:"-7d",orderBy:["timestamp DESC"]};return groupTypes.forEach(groupType=>{let name=(0,queries_utils.AU)(groupType.group_type);query.select.push(`tuple(${name}.created_at, ${name}.index, ${name}.key, ${name}.properties, ${name}.updated_at)`)}),query},{resultEqualityCheck:fast_deep_equal_default()}],eventsDataTableNode:[s=>[s.baseEventsQuery],baseEventsQuery=>baseEventsQuery?{kind:schema_general.OH.DataTableNode,source:{...baseEventsQuery,select:(0,DataTable_utils.Qi)(schema_general.OH.EventsQuery)}}:null],lastEventQuery:[s=>[s.baseEventsQuery],baseEventsQuery=>baseEventsQuery?{...baseEventsQuery,limit:1}:null,{resultEqualityCheck:fast_deep_equal_default()}],lastEventSecondQuery:[s=>[s.lastEventQuery],lastEventQuery=>lastEventQuery?{...lastEventQuery,after:"-30d"}:null],templateHasChanged:[s=>[s.hogFunction,s.configuration],(hogFunction,configuration)=>hogFunction?.template?.hog&&hogFunction.template.hog!==configuration.hog],mappingTemplates:[s=>[s.hogFunction,s.template],(hogFunction,template)=>{var _ref16,_template$mapping_tem;return null!==(_ref16=null!==(_template$mapping_tem=template?.mapping_templates)&&void 0!==_template$mapping_tem?_template$mapping_tem:hogFunction?.template?.mapping_templates)&&void 0!==_ref16?_ref16:[]}],usesGroups:[s=>[s.configuration],configuration=>{let configStr=JSON.stringify(configuration);return configStr.includes("groups.")||configStr.includes("{groups}")}]})),(0,index_esm.listeners)(_ref17=>{let{actions,values,cache}=_ref17;return{loadTemplateSuccess:()=>actions.resetForm(),loadHogFunctionSuccess:()=>{var _values$hogFunction$n;actions.resetForm(),actions.setBreadcrumbTitle(null!==(_values$hogFunction$n=values.hogFunction?.name)&&void 0!==_values$hogFunction$n?_values$hogFunction$n:"Unnamed")},upsertHogFunctionSuccess:()=>{var _values$hogFunction$n2;actions.resetForm(),actions.setBreadcrumbTitle(null!==(_values$hogFunction$n2=values.hogFunction?.name)&&void 0!==_values$hogFunction$n2?_values$hogFunction$n2:"Unnamed")},upsertHogFunctionFailure:_ref18=>{let{errorObject}=_ref18,maybeValidationError=errorObject.data;maybeValidationError?.type==="validation_error"?setTimeout(()=>{maybeValidationError.attr.includes("inputs__")?actions.setConfigurationManualErrors({inputs:{[maybeValidationError.attr.split("__")[1]]:maybeValidationError.detail}}):actions.setConfigurationManualErrors({[maybeValidationError.attr]:maybeValidationError.detail})},1):(console.error(errorObject),src.UJ.error("Error submitting configuration"))},resetForm:()=>{var _cache$configFromUrl,_cache$paramsFromUrl,_values$unsavedConfig,_config$mappings,_values$configuration2;let baseConfig=values.defaultFormState;if(!baseConfig)return;let config={...baseConfig,...null!==(_cache$configFromUrl=cache.configFromUrl)&&void 0!==_cache$configFromUrl?_cache$configFromUrl:{}};values.template?.mapping_templates&&(config.mappings=[...null!==(_config$mappings=config.mappings)&&void 0!==_config$mappings?_config$mappings:[],...values.template.mapping_templates.filter(t=>t.include_by_default).map(template=>({...template,inputs:template.inputs_schema?.reduce((acc,input)=>(acc[input.key]={value:input.default},acc),{})}))]);let paramsFromUrl=null!==(_cache$paramsFromUrl=cache.paramsFromUrl)&&void 0!==_cache$paramsFromUrl?_cache$paramsFromUrl:{},unsavedConfigurationToApply=(null!==(_values$unsavedConfig=values.unsavedConfiguration?.timestamp)&&void 0!==_values$unsavedConfig?_values$unsavedConfig:0)>Date.now()-3e5?values.unsavedConfiguration?.configuration:null;if(actions.resetConfiguration(config),unsavedConfigurationToApply&&actions.setConfigurationValues(unsavedConfigurationToApply),actions.setUnsavedConfiguration(null),paramsFromUrl.integration_target&&paramsFromUrl.integration_id){let inputs=null!==(_values$configuration2=values.configuration?.inputs)&&void 0!==_values$configuration2?_values$configuration2:{};inputs[paramsFromUrl.integration_target]={value:paramsFromUrl.integration_id},actions.setConfigurationValues({inputs})}},duplicate:async()=>{if(values.hogFunction){var _values$hogFunction$t;let newConfig={...values.configuration,name:`${values.configuration.name} (copy)`},originalTemplate=null!==(_values$hogFunction$t=values.hogFunction.template?.id)&&void 0!==_values$hogFunction$t?_values$hogFunction$t:"new";kea_router_lib.router.actions.push((0,hogfunctions_urls.x$)(newConfig.type,originalTemplate),void 0,{configuration:newConfig})}},duplicateFromTemplate:async()=>{if(values.hogFunction?.template){let newConfig={...values.hogFunction.template};kea_router_lib.router.actions.push((0,hogfunctions_urls.x$)(newConfig.type,newConfig.id),void 0,{configuration:newConfig})}},resetToTemplate:async()=>{var _values$hogFunction$t2,_config$inputs,_values$configuration3,_config$filters;let template=null!==(_values$hogFunction$t2=values.hogFunction?.template)&&void 0!==_values$hogFunction$t2?_values$hogFunction$t2:values.template;if(template){let config=templateToConfiguration(template),inputs=null!==(_config$inputs=config.inputs)&&void 0!==_config$inputs?_config$inputs:{};Object.entries(null!==(_values$configuration3=values.configuration.inputs)&&void 0!==_values$configuration3?_values$configuration3:{}).forEach(_ref19=>{var _inputs$key;let[key,value]=_ref19;inputs[key]=null!==(_inputs$key=inputs[key])&&void 0!==_inputs$key?_inputs$key:value}),actions.setConfigurationValues({...config,filters:null!==(_config$filters=config.filters)&&void 0!==_config$filters?_config$filters:values.configuration.filters,name:values.configuration.name,description:values.configuration.description}),src.UJ.success("Template updates applied but not saved.")}},setConfigurationValue:()=>{values.hasHadSubmissionErrors&&actions.setConfigurationManualErrors({})},deleteHogFunction:async()=>{if(!values.hogFunction)return;let{id,name,type,template}=values.hogFunction;await (0,deleteWithUndo.S)({endpoint:`projects/${values.currentProjectId}/hog_functions`,object:{id,name},callback(undo){undo&&kea_router_lib.router.actions.replace((0,hogfunctions_urls.PS)(type,id,template?.id))}}),kea_router_lib.router.actions.replace((0,hogfunctions_urls.PS)(type,void 0,template?.id))},persistForUnload:()=>{actions.setUnsavedConfiguration(values.configuration)}}}),(0,index_esm.afterMount)(_ref20=>{let{props,actions,cache}=_ref20;if(cache.paramsFromUrl={integration_id:kea_router_lib.router.values.searchParams.integration_id,integration_target:kea_router_lib.router.values.searchParams.integration_target},props.templateId?(cache.configFromUrl=kea_router_lib.router.values.hashParams.configuration,actions.loadTemplate()):props.id&&"new"!==props.id&&actions.loadHogFunction(),kea_router_lib.router.values.searchParams.integration_target){let searchParams=kea_router_lib.router.values.searchParams;delete searchParams.integration_id,delete searchParams.integration_target,kea_router_lib.router.actions.replace(kea_router_lib.router.values.location.pathname,searchParams,kea_router_lib.router.values.hashParams)}}),(0,kea_subscriptions_lib.Vt)(_ref21=>{let{props,actions,cache}=_ref21;return{hogFunction:hogFunction=>{hogFunction&&props.templateId&&(cache.disabledBeforeUnload=!0,kea_router_lib.router.actions.replace((0,hogfunctions_urls.PS)(hogFunction.type,hogFunction.id)))},sparklineQuery:async sparklineQuery=>{sparklineQuery&&actions.sparklineQueryChanged(sparklineQuery)},personsCountQuery:async personsCountQuery=>{personsCountQuery&&actions.personsCountQueryChanged(personsCountQuery)}}}),(0,kea_router_lib.beforeUnload)(_ref22=>{let{values,cache}=_ref22;return{enabled:()=>!cache.disabledBeforeUnload&&!values.unsavedConfiguration&&values.configurationChanged,message:"Changes you made will be discarded.",onConfirm:()=>{cache.disabledBeforeUnload=!0}}})]);var jsx_runtime=__webpack_require__("../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let FILTER_OPTIONS=[{label:"Team activity",value:"$activity_log_entry_created"},{label:"Error tracking issue created",value:"$error_tracking_issue_created"}],getSimpleFilterValue=value=>value?.events?.[0]?.id,setSimpleFilterValue=value=>({events:[{name:FILTER_OPTIONS.find(option=>option.value===value)?.label,id:value,type:"events"}]});function HogFunctionFiltersInternal(_ref){let{templateId}=_ref,options=templateId?.includes("error-tracking")?FILTER_OPTIONS.filter(o=>o.value.includes("$error_tracking")):FILTER_OPTIONS;return(0,jsx_runtime.jsx)("div",{className:"p-3 space-y-2 border rounded bg-surface-primary",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:"Trigger",help:"Choose what event should trigger this destination",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.Yv,{options:options,value:getSimpleFilterValue(value),onChange:value=>onChange(setSimpleFilterValue(value)),placeholder:"Select a filter"})})}})})}function sanitizeActionFilters(filters){if(!filters)return{};let sanitized={};return filters.events&&(sanitized.events=filters.events.map(f=>({id:f.id,type:"events",name:f.name,order:f.order,properties:f.properties}))),filters.actions&&(sanitized.actions=filters.actions.map(f=>({id:f.id,type:"actions",name:f.name,order:f.order,properties:f.properties}))),sanitized}function HogFunctionFilters(){let{groupsTaxonomicTypes}=(0,index_esm.useValues)(groupsModel.$),{configuration,type,useMapping}=(0,index_esm.useValues)(hogFunctionConfigurationLogic);if("broadcast"===type)return(0,jsx_runtime.jsx)("div",{className:"p-3 space-y-2 border rounded bg-surface-primary",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:"Filters",children:_ref=>{var _value$properties;let{value,onChange}=_ref;return(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:null!==(_value$properties=value?.properties)&&void 0!==_value$properties?_value$properties:[],taxonomicGroupTypes:[TaxonomicFilter_types.t.PersonProperties,TaxonomicFilter_types.t.Cohorts,TaxonomicFilter_types.t.HogQLExpression],onChange:properties=>{onChange({...value,properties})},pageKey:`HogFunctionPropertyFilters.${chartjs_plugin_trendline.id}`,metadataSource:{kind:schema_general.OH.ActorsQuery}})}})});if("internal_destination"===type)return(0,jsx_runtime.jsx)(HogFunctionFiltersInternal,{templateId:configuration?.template?.id});let isLegacyPlugin=configuration?.template?.id?.startsWith("plugin-"),showDropEvents="transformation"===type;return(0,jsx_runtime.jsxs)("div",{className:"p-3 space-y-2 border rounded bg-surface-primary",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:useMapping?"Global filters":"Filters",info:useMapping?"Filters applied to all events before they reach a mapping":null,children:_ref2=>{var _filters$filter_test_,_filters$properties,_value$drop_events;let{value,onChange}=_ref2,filters=null!=value?value:{};return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[useMapping&&(0,jsx_runtime.jsx)("p",{className:"mb-0 text-sm text-secondary",children:"Filters here apply for all events that could trigger this function, regardless of mappings."}),(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:null!==(_filters$filter_test_=filters?.filter_test_accounts)&&void 0!==_filters$filter_test_&&_filters$filter_test_,onChange:filter_test_accounts=>onChange({...filters,filter_test_accounts}),fullWidth:!0}),(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:null!==(_filters$properties=filters?.properties)&&void 0!==_filters$properties?_filters$properties:[],taxonomicGroupTypes:[TaxonomicFilter_types.t.EventProperties,TaxonomicFilter_types.t.PersonProperties,TaxonomicFilter_types.t.EventFeatureFlags,TaxonomicFilter_types.t.Elements,TaxonomicFilter_types.t.HogQLExpression],onChange:properties=>{onChange({...filters,properties})},pageKey:`HogFunctionPropertyFilters.${chartjs_plugin_trendline.id}`}),useMapping?null:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-between w-full gap-2",children:(0,jsx_runtime.jsx)(src.HQ,{children:"Match events and actions"})}),(0,jsx_runtime.jsxs)("p",{className:"mb-0 text-xs text-secondary",children:["If set, the destination will only run if the ",(0,jsx_runtime.jsx)("b",{children:"event matches any"})," of the below."]}),(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:null!=value?value:{},setFilters:payload=>{onChange({...value,...sanitizeActionFilters(payload)})},typeKey:"plugin-filters",mathAvailability:ActionFilterRow.Qq.None,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:[TaxonomicFilter_types.t.Events,TaxonomicFilter_types.t.Actions],propertiesTaxonomicGroupTypes:[TaxonomicFilter_types.t.EventProperties,TaxonomicFilter_types.t.EventFeatureFlags,TaxonomicFilter_types.t.Elements,TaxonomicFilter_types.t.PersonProperties,TaxonomicFilter_types.t.HogQLExpression,...groupsTaxonomicTypes],propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:types.DC.EVENTS},buttonCopy:"Add event matcher"}),showDropEvents&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.HQ,{children:(0,jsx_runtime.jsxs)("span",{className:"flex items-center justify-between flex-1 gap-2",children:["Drop events that don't match",(0,jsx_runtime.jsx)(src.f4,{checked:null!==(_value$drop_events=value?.drop_events)&&void 0!==_value$drop_events&&_value$drop_events,onChange:drop_events=>onChange({...value,drop_events})})]})}),value?.drop_events?(0,jsx_runtime.jsx)(src.Vp,{type:"error",children:"This will drop all events that don't match the above conditions. Please ensure this is definitely intended."}):(0,jsx_runtime.jsx)("p",{children:"Currently, this will run for all events that match the above conditions. Any that do not match will be unmodified and ingested as they are."})]})]})]})}}),"destination"!==type||isLegacyPlugin?null:(0,jsx_runtime.jsx)(LemonField.D,{name:"masking",label:"Trigger options",children:_ref3=>{var _value$hash;let{value,onChange}=_ref3;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[(0,jsx_runtime.jsx)(src.Yv,{options:[{value:null,label:"Run every time"},{value:"all",label:"Run once per interval"},{value:"{person.id}",label:"Run once per person per interval"},{value:"{concat(person.id, event.event)}",label:"Run once per person per event name per interval"}],value:null!==(_value$hash=value?.hash)&&void 0!==_value$hash?_value$hash:null,onChange:val=>{var _value$ttl;return onChange({hash:val,ttl:null!==(_value$ttl=value?.ttl)&&void 0!==_value$ttl?_value$ttl:1800})}}),configuration.masking?.hash?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[(0,jsx_runtime.jsx)("span",{children:"of"}),(0,jsx_runtime.jsx)(src.Yv,{value:value?.ttl,onChange:val=>onChange({...value,ttl:val}),options:[{value:300,label:"5 minutes"},{value:900,label:"15 minutes"},{value:1800,label:"30 minutes"},{value:3600,label:"1 hour"},{value:7200,label:"2 hours"},{value:14400,label:"4 hours"},{value:28800,label:"8 hours"},{value:43200,label:"12 hours"},{value:86400,label:"24 hours"}]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[(0,jsx_runtime.jsx)("span",{children:"or until"}),(0,jsx_runtime.jsx)(src.Yv,{value:value?.threshold,onChange:val=>onChange({...value,threshold:val}),options:[{value:null,label:"Not set"},{value:1e3,label:"1000 events"},{value:1e4,label:"10,000 events"},{value:1e5,label:"100,000 events"},{value:1e6,label:"1,000,000 events"}]})]})]}):null]})}})]})}var HogFunctionIcon=__webpack_require__("./src/scenes/pipeline/hogfunctions/HogFunctionIcon.tsx"),core_esm=__webpack_require__("../node_modules/.pnpm/@dnd-kit+core@6.0.8_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@dnd-kit/core/dist/core.esm.js"),sortable_esm=__webpack_require__("../node_modules/.pnpm/@dnd-kit+sortable@7.0.2_@dnd-kit+core@6.0.8_react-dom@18.2.0_react@18.2.0__react@18.2.0__react@18.2.0/node_modules/@dnd-kit/sortable/dist/sortable.esm.js"),utilities_esm=__webpack_require__("../node_modules/.pnpm/@dnd-kit+utilities@3.2.1_react@18.2.0/node_modules/@dnd-kit/utilities/dist/utilities.esm.js"),CodeEditorInline=__webpack_require__("./src/lib/monaco/CodeEditorInline.tsx"),react=__webpack_require__("../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),dist=__webpack_require__("../node_modules/.pnpm/react-email-editor@1.7.11_react@18.2.0/node_modules/react-email-editor/dist/index.js");let emailTemplaterLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.connect)({}),(0,index_esm.path)(()=>["scenes","pipeline","hogfunctions","emailTemplaterLogic"]),(0,index_esm.actions)({onSave:!0,setEmailEditorRef:emailEditorRef=>({emailEditorRef}),emailEditorReady:!0,setIsModalOpen:isModalOpen=>({isModalOpen})}),(0,index_esm.reducers)({emailEditorRef:[null,{setEmailEditorRef:(_,_ref)=>{let{emailEditorRef}=_ref;return emailEditorRef}}],isModalOpen:[!1,{setIsModalOpen:(_,_ref2)=>{let{isModalOpen}=_ref2;return isModalOpen}}]}),(0,index_esm.listeners)(_ref3=>{let{props,values,actions}=_ref3;return{onSave:async()=>{let editor=values.emailEditorRef?.editor;if(!editor)return;let data=await new Promise(res=>editor.exportHtml(res)),setFormValue=props.formLogic.findMounted(props.formLogicProps)?.actions?.[`set${utils.fm(props.formKey)}Value`],pathParts=props.formFieldsPrefix?props.formFieldsPrefix.split("."):[];setFormValue(pathParts.concat("design"),data.design),setFormValue(pathParts.concat("html"),escapeHTMLStringCurlies(data.html)),actions.setIsModalOpen(!1)},emailEditorReady:()=>{let pathParts=(props.formFieldsPrefix?props.formFieldsPrefix.split("."):[]).concat("design"),value=props.formLogic.findMounted(props.formLogicProps)?.values?.[props.formKey];for(;pathParts.length&&value;)value=value[pathParts.shift()];value&&values.emailEditorRef?.editor?.loadDesign(value)}}})]);function escapeHTMLStringCurlies(htmlString){let doc=new DOMParser().parseFromString(htmlString,"text/html");function escapeCurlyBraces(text){return text.replace(/{/g,"\\{")}function processNode(node){if(node.nodeType===Node.ELEMENT_NODE)"STYLE"===node.tagName||"SCRIPT"===node.tagName?node.textContent=escapeCurlyBraces(node.textContent||""):Array.from(node.childNodes).forEach(processNode);else if(node.nodeType===Node.COMMENT_NODE){let commentContent=node.nodeValue||"";node.nodeValue=escapeCurlyBraces(commentContent)}}return processNode(doc.head),processNode(doc.body),new XMLSerializer().serializeToString(doc)}function EmailTemplaterForm(_ref){let{mode,...props}=_ref,{setEmailEditorRef,emailEditorReady,setIsModalOpen}=(0,index_esm.useActions)(emailTemplaterLogic(props));return(0,jsx_runtime.jsxs)(lib.Form,{className:"flex flex-col border rounded overflow-hidden flex-1",logic:props.formLogic,props:props.formLogicProps,formKey:props.formKey,children:[["from","to","subject"].map(field=>(0,jsx_runtime.jsx)(LemonField.D,{name:`${props.formFieldsPrefix?props.formFieldsPrefix+".":""}${field}`,className:"border-b shrink-0 gap-1 pl-2",renderError:()=>null,children:_ref2=>{let{value,onChange,error}=_ref2;return(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)(src.HQ,{className:error?"text-danger":"",children:(0,utils.fm)(field)}),(0,jsx_runtime.jsx)(CodeEditorInline.s,{embedded:!0,className:"flex-1",globals:props.globals,value:value,onChange:onChange})]})}},field)),"full"===mode?(0,jsx_runtime.jsx)(dist.default,{ref:r=>setEmailEditorRef(r),onReady:()=>emailEditorReady()}):(0,jsx_runtime.jsx)(LemonField.D,{name:`${props.formFieldsPrefix?props.formFieldsPrefix+".":""}html`,className:"relative flex flex-col",children:_ref3=>{let{value}=_ref3;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"absolute inset-0 p-2 flex items-end justify-center transition-opacity opacity-0 hover:opacity-100",children:[(0,jsx_runtime.jsx)("div",{className:"opacity-50 bg-surface-primary absolute inset-0"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",size:"small",onClick:()=>setIsModalOpen(!0),children:"Click to modify content"})]}),(0,jsx_runtime.jsx)("iframe",{srcDoc:value,className:"flex-1"})]})}})]})}function EmailTemplaterModal(_ref4){let{...props}=_ref4,{isModalOpen}=(0,index_esm.useValues)(emailTemplaterLogic(props)),{setIsModalOpen,onSave}=(0,index_esm.useActions)(emailTemplaterLogic(props));return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isModalOpen,width:"90vw",onClose:()=>setIsModalOpen(!1),children:(0,jsx_runtime.jsx)("div",{className:"h-[80vh] flex",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,jsx_runtime.jsx)("div",{className:"shrink-0",children:(0,jsx_runtime.jsx)("h2",{children:"Editing email template"})}),(0,jsx_runtime.jsx)(EmailTemplaterForm,{...props,mode:"full"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center mt-2 gap-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>setIsModalOpen(!1),children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>onSave(),children:"Save"})]})]})})})}function EmailTemplater(props){return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,jsx_runtime.jsx)(EmailTemplaterForm,{...props,mode:"preview"}),(0,jsx_runtime.jsx)(EmailTemplaterModal,{...props})]})}var IntegrationChoice=__webpack_require__("./src/scenes/pipeline/hogfunctions/integrations/IntegrationChoice.tsx");function HogFunctionInputIntegration(_ref){let{schema,...props}=_ref,{persistForUnload}=(0,index_esm.useActions)(hogFunctionConfigurationLogic);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(IntegrationChoice.a,{...props,schema:schema,integration:schema.integration,redirectUrl:`${window.location.pathname}?integration_target=${schema.key}`,beforeRedirect:()=>persistForUnload()})})}let googleAdsIntegrationLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>props.id),(0,index_esm.path)(key=>["lib","integrations","googleAdsIntegrationLogic",key]),(0,index_esm.actions)({loadGoogleAdsConversionActions:customerId=>customerId,loadGoogleAdsAccessibleAccounts:!0}),(0,kea_loaders_lib.loaders)(_ref=>{let{props}=_ref;return{googleAdsConversionActions:[null,{loadGoogleAdsConversionActions:async customerId=>(await api.ZP.integrations.googleAdsConversionActions(props.id,customerId)).conversionActions}],googleAdsAccessibleAccounts:[null,{loadGoogleAdsAccessibleAccounts:async()=>(await api.ZP.integrations.googleAdsAccounts(props.id)).accessibleAccounts}]}})]),getGoogleAdsAccountOptions=googleAdsAccounts=>googleAdsAccounts?googleAdsAccounts.map(customer=>({key:customer.id,labelComponent:(0,jsx_runtime.jsxs)("span",{className:"flex items-center",children:[customer.name," (",customer.id.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3"),")"]}),label:`${customer.name} (${customer.id.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3")})`})):null,getGoogleAdsConversionActionOptions=googleAdsConversionActions=>googleAdsConversionActions?googleAdsConversionActions.map(_ref=>{let{id,name}=_ref;return{key:id,labelComponent:(0,jsx_runtime.jsxs)("span",{className:"flex items-center",children:[name," (",id,")"]}),label:`${name} (${id})`}}):null;function GoogleAdsConversionActionPicker(_ref2){let{onChange,value,requiresFieldValue,integration,disabled}=_ref2,{googleAdsConversionActions,googleAdsConversionActionsLoading}=(0,index_esm.useValues)(googleAdsIntegrationLogic({id:integration.id})),{loadGoogleAdsConversionActions}=(0,index_esm.useActions)(googleAdsIntegrationLogic({id:integration.id})),googleAdsConversionActionOptions=(0,react.useMemo)(()=>getGoogleAdsConversionActionOptions(googleAdsConversionActions),[googleAdsConversionActions]);return(0,react.useEffect)(()=>{requiresFieldValue&&loadGoogleAdsConversionActions(requiresFieldValue)},[loadGoogleAdsConversionActions,requiresFieldValue]),(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.nt,{onChange:val=>{var _val$;return onChange?.(null!==(_val$=val[0])&&void 0!==_val$?_val$:null)},value:value?[value]:[],onFocus:()=>!googleAdsConversionActions&&!googleAdsConversionActionsLoading&&requiresFieldValue&&loadGoogleAdsConversionActions(requiresFieldValue),disabled:disabled,mode:"single","data-attr":"select-google-ads-conversion-action",placeholder:"Select a Conversion Action...",options:null!=googleAdsConversionActionOptions?googleAdsConversionActionOptions:value?[{key:value,label:value}]:[],loading:googleAdsConversionActionsLoading})})}function GoogleAdsCustomerIdPicker(_ref3){let{onChange,value,integration,disabled}=_ref3,{googleAdsAccessibleAccounts,googleAdsAccessibleAccountsLoading}=(0,index_esm.useValues)(googleAdsIntegrationLogic({id:integration.id})),{loadGoogleAdsAccessibleAccounts}=(0,index_esm.useActions)(googleAdsIntegrationLogic({id:integration.id})),googleAdsAccountOptions=(0,react.useMemo)(()=>getGoogleAdsAccountOptions(googleAdsAccessibleAccounts),[googleAdsAccessibleAccounts]);return(0,react.useEffect)(()=>{disabled||loadGoogleAdsAccessibleAccounts()},[loadGoogleAdsAccessibleAccounts,disabled]),(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.nt,{onChange:val=>{var _val$2;return onChange?.(null!==(_val$2=val[0])&&void 0!==_val$2?_val$2:null)},value:value?[value]:[],onFocus:()=>!googleAdsAccessibleAccounts&&!googleAdsAccessibleAccountsLoading&&loadGoogleAdsAccessibleAccounts(),disabled:disabled,mode:"single","data-attr":"select-google-ads-customer-id-channel",placeholder:"Select a Customer ID...",options:null!=googleAdsAccountOptions?googleAdsAccountOptions:value?[{key:value,label:value.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3")}]:[],loading:googleAdsAccessibleAccountsLoading})})}var integrationsLogic=__webpack_require__("./src/lib/integrations/integrationsLogic.ts");let linkedInAdsIntegrationLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>props.id),(0,index_esm.path)(key=>["lib","integrations","linkedInAdsIntegrationLogic",key]),(0,index_esm.actions)({loadLinkedInAdsConversionRules:accountId=>accountId,loadLinkedInAdsAccounts:!0}),(0,kea_loaders_lib.loaders)(_ref=>{let{props}=_ref;return{linkedInAdsConversionRules:[null,{loadLinkedInAdsConversionRules:async customerId=>(await api.ZP.integrations.linkedInAdsConversionRules(props.id,customerId)).conversionRules}],linkedInAdsAccounts:[null,{loadLinkedInAdsAccounts:async()=>(await api.ZP.integrations.linkedInAdsAccounts(props.id)).adAccounts}]}})]),getLinkedInAdsAccountOptions=linkedInAdsAccounts=>linkedInAdsAccounts?linkedInAdsAccounts.map(account=>({key:account.id.toString(),labelComponent:(0,jsx_runtime.jsxs)("span",{className:"flex items-center",children:[account.name," (",account.id.toString(),")"]}),label:`${account.name}`})):null,getLinkedInAdsConversionRuleOptions=linkedInAdsConversionRules=>linkedInAdsConversionRules?linkedInAdsConversionRules.map(_ref=>{let{id,name}=_ref;return{key:id.toString(),labelComponent:(0,jsx_runtime.jsxs)("span",{className:"flex items-center",children:[name," (",id,")"]}),label:`${name} (${id})`}}):null;function LinkedInAdsConversionRulePicker(_ref2){let{onChange,value,requiresFieldValue,integration,disabled}=_ref2,{linkedInAdsConversionRules,linkedInAdsConversionRulesLoading}=(0,index_esm.useValues)(linkedInAdsIntegrationLogic({id:integration.id})),{loadLinkedInAdsConversionRules}=(0,index_esm.useActions)(linkedInAdsIntegrationLogic({id:integration.id})),linkedInAdsConversionRuleOptions=(0,react.useMemo)(()=>getLinkedInAdsConversionRuleOptions(linkedInAdsConversionRules),[linkedInAdsConversionRules]);return(0,react.useEffect)(()=>{requiresFieldValue&&loadLinkedInAdsConversionRules(requiresFieldValue)},[loadLinkedInAdsConversionRules,requiresFieldValue]),(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.nt,{onChange:val=>{var _val$;return onChange?.(null!==(_val$=val[0])&&void 0!==_val$?_val$:null)},value:value?[value]:[],onFocus:()=>!linkedInAdsConversionRules&&!linkedInAdsConversionRulesLoading&&requiresFieldValue&&loadLinkedInAdsConversionRules(requiresFieldValue),disabled:disabled,mode:"single","data-attr":"select-linkedin-ads-conversion-action",placeholder:"Select a Conversion Action...",options:null!=linkedInAdsConversionRuleOptions?linkedInAdsConversionRuleOptions:value?[{key:value,label:value}]:[],loading:linkedInAdsConversionRulesLoading})})}function LinkedInAdsAccountIdPicker(_ref3){let{onChange,value,integration,disabled}=_ref3,{linkedInAdsAccounts,linkedInAdsAccountsLoading}=(0,index_esm.useValues)(linkedInAdsIntegrationLogic({id:integration.id})),{loadLinkedInAdsAccounts}=(0,index_esm.useActions)(linkedInAdsIntegrationLogic({id:integration.id})),linkedInAdsAccountOptions=(0,react.useMemo)(()=>getLinkedInAdsAccountOptions(linkedInAdsAccounts),[linkedInAdsAccounts]);return(0,react.useEffect)(()=>{disabled||loadLinkedInAdsAccounts()},[loadLinkedInAdsAccounts]),(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.nt,{onChange:val=>{var _val$2;return onChange?.(null!==(_val$2=val[0])&&void 0!==_val$2?_val$2:null)},value:value?[value]:[],onFocus:()=>!linkedInAdsAccounts&&!linkedInAdsAccountsLoading&&loadLinkedInAdsAccounts(),disabled:disabled,mode:"single","data-attr":"select-linkedin-ads-customer-id-channel",placeholder:"Select a Account ID...",options:null!=linkedInAdsAccountOptions?linkedInAdsAccountOptions:value?[{key:value,label:value.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3")}]:[],loading:linkedInAdsAccountsLoading})})}var SlackIntegrationHelpers=__webpack_require__("./src/lib/integrations/SlackIntegrationHelpers.tsx");function HogFunctionInputIntegrationField(_ref){let requiresFieldValue,{schema,value,onChange}=_ref,{configuration}=(0,index_esm.useValues)(hogFunctionConfigurationLogic),{integrationsLoading,integrations}=(0,index_esm.useValues)(integrationsLogic.a);if(integrationsLoading)return(0,jsx_runtime.jsx)(src.yW,{className:"h-10"});let relatedSchemaIntegration=configuration.inputs_schema?.find(input=>input.key===schema.integration_key);if(!relatedSchemaIntegration)return(0,jsx_runtime.jsxs)("div",{className:"text-danger",children:["Bad configuration: integration key ",schema.integration_key," not found in schema"]});let integrationId=configuration.inputs?.[relatedSchemaIntegration.key]?.value,integration=integrations?.find(integration=>integration.id===integrationId);if(schema.requires_field){let requiresFieldSchema=configuration.inputs_schema?.find(input=>input.key===schema.requires_field);if(!requiresFieldSchema)return(0,jsx_runtime.jsxs)("div",{className:"text-danger",children:["Bad configuration: required key ",schema.requires_field," not found in schema"]});let requiresField=configuration.inputs?.[requiresFieldSchema.key];if(!(requiresFieldValue=requiresField?.value))return(0,jsx_runtime.jsxs)("div",{className:"border border-dashed h-10 rounded p-2 text-secondary italic",children:["Configure ",requiresFieldSchema.label," to continue"]})}return integration?"slack_channel"===schema.integration_field?(0,jsx_runtime.jsx)(SlackIntegrationHelpers.a,{value:value,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):"google_ads_conversion_action"===schema.integration_field&&requiresFieldValue?(0,jsx_runtime.jsx)(GoogleAdsConversionActionPicker,{value:value,requiresFieldValue:requiresFieldValue,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):"google_ads_customer_id"===schema.integration_field?(0,jsx_runtime.jsx)(GoogleAdsCustomerIdPicker,{value:value,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):"linkedin_ads_conversion_rule_id"===schema.integration_field&&requiresFieldValue?(0,jsx_runtime.jsx)(LinkedInAdsConversionRulePicker,{value:value,requiresFieldValue:requiresFieldValue,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):"linkedin_ads_account_id"===schema.integration_field?(0,jsx_runtime.jsx)(LinkedInAdsAccountIdPicker,{value:value,onChange:x=>onChange?.(x?.split("|")[0]),integration:integration}):(0,jsx_runtime.jsx)("div",{className:"text-danger",children:(0,jsx_runtime.jsxs)("p",{children:["Unsupported integration type: ",schema.integration]})}):(0,jsx_runtime.jsxs)("div",{className:"border border-dashed h-10 rounded p-2 text-secondary italic",children:["Configure ",relatedSchemaIntegration.label," to continue"]})}let typeList=["string","boolean","dictionary","choice","json","integration","email"];function JsonConfigField(props){let{globalsWithInputs}=(0,index_esm.useValues)(hogFunctionConfigurationLogic);return(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:props.templating?"hogJson":"json",value:"string"!=typeof props.value?JSON.stringify(props.value,null,2):props.value,onChange:v=>props.onChange?.(null!=v?v:""),options:{lineNumbers:"off",minimap:{enabled:!1},scrollbar:{vertical:"hidden",verticalScrollbarSize:0}},globals:props.templating?globalsWithInputs:void 0})}function EmailTemplateField(_ref){let{schema}=_ref,{globalsWithInputs,logicProps}=(0,index_esm.useValues)(hogFunctionConfigurationLogic);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(EmailTemplater,{formLogic:hogFunctionConfigurationLogic,formLogicProps:logicProps,formKey:"configuration",formFieldsPrefix:`inputs.${schema.key}.value`,globals:globalsWithInputs})})}function HogFunctionTemplateInput(props){let{globalsWithInputs}=(0,index_esm.useValues)(hogFunctionConfigurationLogic);return props.templating?(0,jsx_runtime.jsx)(CodeEditorInline.s,{...props,globals:globalsWithInputs}):(0,jsx_runtime.jsx)(src.DF,{type:"text",value:props.value,onChange:props.onChange})}function DictionaryField(_ref2){let{onChange,value,templating}=_ref2,[entries,setEntries]=(0,react.useState)(Object.entries(null!=value?value:{}));return(0,react.useEffect)(()=>{let val=Object.fromEntries(entries.filter(_ref3=>{let[key,val]=_ref3;return""!==key.trim()||""!==val.trim()}));onChange?.(val)},[entries]),(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[entries.map((_ref4,index)=>{let[key,val]=_ref4;return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.DF,{value:key,className:"flex-1 min-w-60",onChange:key=>{let newEntries=[...entries];newEntries[index]=[key,newEntries[index][1]],setEntries(newEntries)},placeholder:"Key"}),(0,jsx_runtime.jsx)(HogFunctionTemplateInput,{className:"overflow-hidden flex-2",value:val,language:"hogTemplate",onChange:val=>{let newEntries=[...entries];newEntries[index]=[newEntries[index][0],null!=val?val:""],setEntries(newEntries)},templating:templating}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),size:"small",onClick:()=>{let newEntries=[...entries];newEntries.splice(index,1),setEntries(newEntries)}})]},index)}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),size:"small",type:"secondary",onClick:()=>{setEntries([...entries,["",""]])},children:"Add entry"})]})}function HogFunctionInputRenderer(_ref5){var _schema$templating,_schema$choices;let{value,onChange,schema,disabled}=_ref5,templating=null===(_schema$templating=schema.templating)||void 0===_schema$templating||_schema$templating;switch(schema.type){case"string":return(0,jsx_runtime.jsx)(HogFunctionTemplateInput,{language:"hogTemplate",value:value,onChange:disabled?()=>{}:onChange,className:"ph-no-capture",templating:templating});case"json":return(0,jsx_runtime.jsx)(JsonConfigField,{value:value,onChange:onChange,className:"ph-no-capture",templating:templating});case"choice":return(0,jsx_runtime.jsx)(src.Yv,{fullWidth:!0,value:value,className:"ph-no-capture",onChange:onChange,options:null!==(_schema$choices=schema.choices)&&void 0!==_schema$choices?_schema$choices:[],disabled:disabled});case"dictionary":return(0,jsx_runtime.jsx)(DictionaryField,{value:value,onChange:onChange,templating:templating});case"boolean":return(0,jsx_runtime.jsx)(src.f4,{checked:value,onChange:checked=>onChange?.(checked),disabled:disabled});case"integration":return(0,jsx_runtime.jsx)(HogFunctionInputIntegration,{schema:schema,value:value,onChange:onChange});case"integration_field":return(0,jsx_runtime.jsx)(HogFunctionInputIntegrationField,{schema:schema,value:value,onChange:onChange});case"email":return(0,jsx_runtime.jsx)(EmailTemplateField,{schema:schema});default:return(0,jsx_runtime.jsxs)("strong",{className:"text-danger",children:['Unknown field type "',(0,jsx_runtime.jsx)("code",{children:schema.type}),'".']})}}function HogFunctionInputSchemaControls(_ref6){let{value,onChange,onDone,supportsSecrets}=_ref6,_onChange=data=>{if(data?.key?.length===0){setLocalVariableError("Input variable name cannot be empty");return}onChange(data?{...value,...data}:null)},[localVariableValue,setLocalVariableValue]=(0,react.useState)(value.key),[localVariableError,setLocalVariableError]=(0,react.useState)(null);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center flex-1 gap-2",children:[(0,jsx_runtime.jsx)(src.Yv,{size:"small",options:typeList.map(type=>({label:(0,utils.fm)(type),value:type})),value:value.type,className:"w-30",onChange:type=>_onChange({type})}),(0,jsx_runtime.jsx)(src.Hw,{size:"small",checked:value.required,onChange:required=>_onChange({required}),label:"Required",bordered:!0}),supportsSecrets?(0,jsx_runtime.jsx)(src.Hw,{size:"small",checked:value.secret,onChange:secret=>_onChange({secret}),label:"Secret",bordered:!0}):null,(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconTrash,{}),size:"small",onClick:()=>onChange(null)}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>onDone(),children:"Done"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap flex-1 gap-2",children:[(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Display label",children:(0,jsx_runtime.jsx)(src.DF,{className:"min-w-60",size:"small",value:value.label,onChange:label=>_onChange({label}),placeholder:"Display label"})}),(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Input variable name",error:localVariableError,children:(0,jsx_runtime.jsx)(src.DF,{size:"small",value:localVariableValue,onChange:key=>setLocalVariableValue(key),onBlur:()=>_onChange({key:localVariableValue}),placeholder:"Variable name"})})]}),(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Description",children:(0,jsx_runtime.jsx)(src._V,{minRows:1,value:value.description,onChange:description=>_onChange({description}),placeholder:"Description"})}),"choice"===value.type&&(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Choices",children:(0,jsx_runtime.jsx)(src.nt,{mode:"multiple",allowCustomValues:!0,value:value.choices?.map(choice=>choice.value),onChange:choices=>_onChange({choices:choices.map(value=>({label:value,value}))}),placeholder:"Choices"})}),"integration"===value.type&&(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Integration kind",children:(0,jsx_runtime.jsx)(src.Yv,{value:value.integration,onChange:integration=>_onChange({integration}),options:[{label:"Slack",value:"slack"},{label:"Salesforce",value:"salesforce"},{label:"Hubspot",value:"hubspot"}],placeholder:"Choose kind"})}),(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Default value",children:(0,jsx_runtime.jsx)(HogFunctionInputRenderer,{schema:value,value:value.default,onChange:val=>_onChange({default:val})})})]})}function HogFunctionInputWithSchema(_ref7){let{schema,configuration,setConfigurationValue}=_ref7,{attributes,listeners,setNodeRef,transform,transition}=(0,sortable_esm.nB)({id:schema.key}),{showSource}=(0,index_esm.useValues)(hogFunctionConfigurationLogic),[editing,setEditing]=(0,react.useState)(!1),value=configuration.inputs?.[schema.key];(0,react.useEffect)(()=>{showSource||setEditing(!1)},[showSource]);let supportsTemplating=["string","json","dictionary","email"].includes(schema.type)&&!1!==schema.templating,supportsSecrets="type"in configuration;return(0,jsx_runtime.jsx)("div",{className:"group",ref:setNodeRef,style:{transform:utilities_esm.ux.Transform.toString(transform),transition},children:editing?(0,jsx_runtime.jsx)("div",{className:"p-2 space-y-4 border border-dashed rounded",children:(0,jsx_runtime.jsx)(HogFunctionInputSchemaControls,{value:schema,onChange:newSchema=>{let inputsSchema=configuration.inputs_schema||[];if(newSchema){let modifiedSchema={...schema,...newSchema};inputsSchema=inputsSchema.map(s=>s.key===schema.key?modifiedSchema:s)}else inputsSchema=inputsSchema.filter(s=>s.key!==schema.key);newSchema?.key&&setConfigurationValue(`inputs.${newSchema.key}`,value),newSchema?.type&&newSchema.type!==schema.type&&setConfigurationValue(`inputs.${schema.key}`,null),setConfigurationValue("inputs_schema",inputsSchema)},onDone:()=>setEditing(!1),supportsSecrets:supportsSecrets})}):(0,jsx_runtime.jsx)(LemonField.D,{name:`inputs.${schema.key}`,help:schema.description,children:_ref8=>{let{value,onChange}=_ref8;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsxs)(src.HQ,{className:showSource?"cursor-grab":"",showOptional:!schema.required,...attributes,...listeners,children:[schema.label||schema.key,schema.secret?(0,jsx_runtime.jsx)(src.u,{title:"This input is marked as secret. It will be encrypted and not visible after saving.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconLock,{})}):void 0]}),showSource&&(0,jsx_runtime.jsxs)(src.oe,{type:"muted",className:"font-mono",children:["inputs.",schema.key]}),(0,jsx_runtime.jsx)("div",{className:"flex-1"}),supportsTemplating&&(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",to:"https://posthog.com/docs/cdp/destinations/customizing-destinations#customizing-payload",sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{}),noPadding:!0,className:"p-1 transition-opacity opacity-0 group-hover:opacity-100",children:"Supports templating"}),showSource&&(0,jsx_runtime.jsx)(src.Jp,{size:"small",noPadding:!0,icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGear,{}),onClick:()=>setEditing(!0)})]}),value?.secret?(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 p-1 border border-dashed rounded",children:[(0,jsx_runtime.jsx)("span",{className:"flex-1 p-1 italic text-secondary",children:"This value is secret and is not displayed here."}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{onChange({value:void 0})},size:"small",type:"secondary",children:"Edit"})]}):(0,jsx_runtime.jsx)(HogFunctionInputRenderer,{schema:schema,value:value?.value,onChange:val=>onChange({value:val})})]})}})})}function HogFunctionInputs(_ref9){let{configuration,setConfigurationValue}=_ref9,{showSource}=(0,index_esm.useValues)(hogFunctionConfigurationLogic);if(!configuration?.inputs_schema?.length)return"type"in configuration?(0,jsx_runtime.jsx)("span",{className:"italic text-secondary",children:"This function does not require any input variables."}):null;let inputSchemas=configuration.inputs_schema,inputSchemaIds=inputSchemas.map(schema=>schema.key);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(core_esm.LB,{collisionDetection:core_esm.pE,onDragEnd:_ref10=>{let{active,over}=_ref10;if(over&&active.id!==over.id){let oldIndex=inputSchemaIds.indexOf(active.id),newIndex=inputSchemaIds.indexOf(over.id);setConfigurationValue("inputs_schema",(0,sortable_esm.Rp)(inputSchemas,oldIndex,newIndex))}},children:(0,jsx_runtime.jsx)(sortable_esm.Fo,{disabled:!showSource,items:inputSchemaIds,strategy:sortable_esm.qw,children:configuration.inputs_schema?.filter(i=>!i.hidden).map(schema=>jsx_runtime.jsx(HogFunctionInputWithSchema,{schema:schema,configuration:configuration,setConfigurationValue:setConfigurationValue},schema.key))})})})}var HogFunctionStatusIndicator=__webpack_require__("./src/scenes/pipeline/hogfunctions/HogFunctionStatusIndicator.tsx"),TZLabel=__webpack_require__("./src/lib/components/TZLabel/index.tsx"),editor_main=__webpack_require__("../node_modules/.pnpm/monaco-editor@0.49.0/node_modules/monaco-editor/esm/vs/editor/editor.main.js"),getAppContext=__webpack_require__("./src/lib/utils/getAppContext.ts");let convertToTransformationEvent=result=>{var _result$properties,_properties$$ip;let properties=null!==(_result$properties=result.properties)&&void 0!==_result$properties?_result$properties:{};return properties.$ip=null!==(_properties$$ip=properties.$ip)&&void 0!==_properties$$ip?_properties$$ip:"89.160.20.129",delete properties.$transformations_failed,delete properties.$transformations_succeeded,{event:result.event,uuid:result.uuid,distinct_id:result.distinct_id,timestamp:result.timestamp,properties}},convertFromTransformationEvent=result=>(delete result.properties.$transformations_failed,delete result.properties.$transformations_succeeded,{event:result.event,uuid:result.uuid,distinct_id:result.distinct_id,timestamp:result.timestamp,properties:result.properties}),hogFunctionTestLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{var _ref2;let{id,templateId}=_ref;return null!==(_ref2=null!=id?id:templateId)&&void 0!==_ref2?_ref2:"new"}),(0,index_esm.path)(id=>["scenes","pipeline","hogfunctions","hogFunctionTestLogic",id]),(0,index_esm.connect)(props=>({values:[hogFunctionConfigurationLogic(props),["configuration","templateId","configurationHasErrors","sampleGlobals","sampleGlobalsLoading","exampleInvocationGlobals","sampleGlobalsError","type"],groupsModel.$,["groupTypes"]],actions:[hogFunctionConfigurationLogic(props),["touchConfigurationField","loadSampleGlobalsSuccess","loadSampleGlobals","setSampleGlobals"]]})),(0,index_esm.actions)({setTestResult:result=>({result}),toggleExpanded:expanded=>({expanded}),saveGlobals:(name,globals)=>({name,globals}),deleteSavedGlobals:index=>({index}),setTestResultMode:mode=>({mode}),receiveExampleGlobals:globals=>({globals}),setJsonError:error=>({error}),validateJson:(value,editor,decorations)=>({value,editor,decorations}),setDecorationIds:decorationIds=>({decorationIds}),cancelSampleGlobalsLoading:!0}),(0,index_esm.reducers)({expanded:[!1,{toggleExpanded:(state,_ref3)=>{let{expanded}=_ref3;return void 0===expanded?!state:expanded}}],testResult:[null,{setTestResult:(_,_ref4)=>{let{result}=_ref4;return result}}],testResultMode:["diff",{setTestResultMode:(_,_ref5)=>{let{mode}=_ref5;return mode}}],savedGlobals:[[],{persist:!0,prefix:`${(0,getAppContext.ev)()}__`},{saveGlobals:(state,_ref6)=>{let{name,globals}=_ref6;return[...state,{name,globals}]},deleteSavedGlobals:(state,_ref7)=>{let{index}=_ref7;return state.filter((_,i)=>i!==index)}}],jsonError:[null,{setJsonError:(_,_ref8)=>{let{error}=_ref8;return error}}],currentDecorationIds:[[],{setDecorationIds:(_,_ref9)=>{let{decorationIds}=_ref9;return decorationIds},setJsonError:()=>[]}],fetchCancelled:[!1,{loadSampleGlobals:()=>!1,cancelSampleGlobalsLoading:()=>!0,toggleExpanded:()=>!1}]}),(0,index_esm.listeners)(_ref10=>{let{values,actions}=_ref10;return{loadSampleGlobalsSuccess:()=>{values.expanded&&!values.fetchCancelled&&values.sampleGlobals&&actions.receiveExampleGlobals(values.sampleGlobals)},setSampleGlobals:_ref11=>{let{sampleGlobals}=_ref11;actions.receiveExampleGlobals(sampleGlobals)},receiveExampleGlobals:_ref12=>{let{globals}=_ref12;if(globals){if("transformation"===values.type){let event=convertToTransformationEvent(globals.event);actions.setTestInvocationValue("globals",JSON.stringify(event,null,2))}else actions.setTestInvocationValue("globals",JSON.stringify(globals,null,2))}},validateJson:_ref13=>{let{value,editor,decorations}=_ref13;if(!editor?.getModel())return;let model=editor.getModel();try{JSON.parse(value),actions.setJsonError(null),editor.removeDecorations(decorations)}catch(err){actions.setJsonError(err.message);let match=err.message.match(/position (\d+)/);if(!match)return;let position=parseInt(match[1],10),pos=model.getPositionAt(position);editor.createDecorationsCollection([{range:{startLineNumber:pos.lineNumber,startColumn:pos.column,endLineNumber:pos.lineNumber,endColumn:pos.column+1},options:{isWholeLine:!0,className:"bg-danger-highlight",glyphMarginClassName:"text-danger flex items-center justify-center",glyphMarginHoverMessage:{value:err.message}}}]),editor.revealLineInCenter(pos.lineNumber)}},setTestResult:_ref14=>{let{result}=_ref14;result&&setTimeout(()=>{let testResults=document.querySelector('[data-attr="test-results"]');testResults&&testResults.scrollIntoView({behavior:"smooth",block:"start"});let editors=document.querySelectorAll('[data-attr="test-results"] .monaco-editor');if(editors.length>0&&values.sortedTestsResult?.hasDiff){let monacoEditor=editors[editors.length-1].querySelector(".monaco-scrollable-element");if(monacoEditor){let inputLines=values.sortedTestsResult.input.split("\n"),outputLines=values.sortedTestsResult.output.split("\n"),diffLineIndex=0;for(let i=0;i<Math.max(inputLines.length,outputLines.length);i++)if(inputLines[i]!==outputLines[i]){diffLineIndex=i;break}monacoEditor.scrollTop=Math.max(0,(diffLineIndex-2)*19)}}},100)},cancelSampleGlobalsLoading:()=>{}}}),(0,lib.forms)(_ref15=>{let{props,actions,values}=_ref15;return{testInvocation:{defaults:{mock_async_functions:!1},alwaysShowErrors:!0,errors:_ref16=>{let{globals}=_ref16;return{globals:globals?(0,utils.Cy)(globals)?void 0:"Invalid JSON":"Required"}},submit:async data=>{if(values.configurationHasErrors){src.UJ.error("Please fix the configuration errors before testing.");return}let parsedData=(0,utils.Cy)(data.globals),configuration=sanitizeConfiguration(values.configuration);configuration.template_id=values.templateId;let globals="transformation"===values.type?{event:parsedData}:parsedData;try{var _props$id;let res=await api.ZP.hogFunctions.createTestInvocation(null!==(_props$id=props.id)&&void 0!==_props$id?_props$id:"new",{globals,mock_async_functions:data.mock_async_functions,configuration});"transformation"===values.type&&res.result&&(res.result=convertFromTransformationEvent(res.result)),actions.setTestResult(res)}catch(e){src.UJ.error(`An unexpected server error occurred while testing the function. ${e}`)}}}}}),(0,index_esm.selectors)(()=>({sortedTestsResult:[s=>[s.configuration,s.testResult,s.testInvocation],(configuration,testResult,testInvocation)=>{if(!testResult||"transformation"!==configuration.type)return null;let input=JSON.stringify(JSON.parse(testInvocation.globals),null,2),output=JSON.stringify(testResult.result,null,2);return{input,output,hasDiff:input!==output}}]})),(0,index_esm.afterMount)(_ref17=>{let{actions,values}=_ref17;actions.receiveExampleGlobals(values.exampleInvocationGlobals)})]),HogFunctionTestEditor=_ref=>{let{value,onChange,readOnly=!1}=_ref,editorRef=(0,react.useRef)(null),decorationsRef=(0,react.useRef)([]),handleValidation=newValue=>{if(!editorRef.current?.getModel())return;let model=editorRef.current.getModel();editor_main.editor.setModelMarkers(model,"owner",[]),decorationsRef.current=editorRef.current.deltaDecorations(decorationsRef.current,[]);try{JSON.parse(newValue)}catch(err){let match=err.message.match(/position (\d+)/);if(match){let position=parseInt(match[1],10),pos=model.getPositionAt(position);editor_main.editor.setModelMarkers(model,"owner",[{startLineNumber:pos.lineNumber,startColumn:pos.column,endLineNumber:pos.lineNumber,endColumn:pos.column+1,message:err.message,severity:editor_main.MarkerSeverity.Error}]),decorationsRef.current=editorRef.current.deltaDecorations(decorationsRef.current,[{range:{startLineNumber:pos.lineNumber,startColumn:1,endLineNumber:pos.lineNumber,endColumn:model.getLineLength(pos.lineNumber)+1},options:{isWholeLine:!0,className:"bg-danger-highlight",glyphMarginClassName:"text-danger flex items-center justify-center",glyphMarginHoverMessage:{value:err.message}}}]),editorRef.current.revealLineInCenter(pos.lineNumber)}}};return(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",value:value,height:400,onChange:newValue=>{readOnly||(onChange?.(newValue),handleValidation(null!=newValue?newValue:""))},onMount:editor=>{editorRef.current=editor,handleValidation(value)},options:{lineNumbers:"on",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"auto",verticalScrollbarSize:14},folding:!0,glyphMargin:!0,readOnly:readOnly}})};function HogFunctionTest(){var _testResult$logs;let{logicProps}=(0,index_esm.useValues)(hogFunctionConfigurationLogic),{isTestInvocationSubmitting,testResult,expanded,sampleGlobalsLoading,sampleGlobalsError,type,savedGlobals,testInvocation,testResultMode,sortedTestsResult,jsonError,fetchCancelled}=(0,index_esm.useValues)(hogFunctionTestLogic(logicProps)),{submitTestInvocation,setTestResult,toggleExpanded,loadSampleGlobals,deleteSavedGlobals,setSampleGlobals,saveGlobals,setTestResultMode,cancelSampleGlobalsLoading}=(0,index_esm.useActions)(hogFunctionTestLogic(logicProps)),testResultsRef=(0,react.useRef)(null);return(0,jsx_runtime.jsxs)(lib.Form,{logic:hogFunctionTestLogic,props:logicProps,formKey:"testInvocation",enableFormOnSubmit:!0,children:[(0,jsx_runtime.jsxs)("div",{ref:testResultsRef,className:(0,clsx_m.default)("border rounded p-3 space-y-2",expanded?"bg-surface-secondary min-h-120":"bg-surface-primary"),children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,jsx_runtime.jsxs)("h2",{className:"flex items-center gap-2 mb-0",children:[(0,jsx_runtime.jsx)("span",{children:"Testing"}),sampleGlobalsLoading&&!fetchCancelled?(0,jsx_runtime.jsx)(src.$j,{}):null]}),!expanded&&(0,jsx_runtime.jsx)("p",{children:"Click here to test your function with an example event"})]}),expanded?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[testResult?(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>setTestResult(null),loading:isTestInvocationSubmitting,"data-attr":"clear-hog-test-result",children:"Clear test result"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(More.T,{dropdown:{closeOnClickInside:!1},overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"mock_async_functions",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.f4,{onChange:v=>onChange(!v),checked:!value,"data-attr":"toggle-hog-test-mocking",className:"px-2 py-1",label:(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"When disabled, async functions such as `fetch` will not be called. Instead they will be mocked out and logged."}),children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2",children:["Make real HTTP requests",(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-lg"})]})})})}}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,onClick:loadSampleGlobals,loading:sampleGlobalsLoading&&!fetchCancelled,tooltip:"Find the last event matching filters, and use it to populate the globals below.",children:"Fetch new event"}),(0,jsx_runtime.jsx)(src.p2,{}),savedGlobals.map((_ref3,index)=>{let{name,globals}=_ref3;return(0,jsx_runtime.jsxs)("div",{className:"flex justify-between w-full",children:[(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"open-hog-test-data",onClick:()=>setSampleGlobals(globals),fullWidth:!0,className:"flex-1",children:name},index),(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"delete-hog-test-data",size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>deleteSavedGlobals(index),tooltip:"Delete saved test data"})]},index)}),testInvocation.globals&&(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,"data-attr":"save-hog-test-data",onClick:()=>{let name=prompt("Name this test data");name&&saveGlobals(name,JSON.parse(testInvocation.globals))},disabledReason:(()=>{try{JSON.parse(testInvocation.globals)}catch(e){return"Invalid globals JSON"}})(),children:"Save test data"})]})}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary","data-attr":"test-hog-function",onClick:submitTestInvocation,loading:isTestInvocationSubmitting,children:"Test function"})]}),(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"hide-hog-testing",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>toggleExpanded(),tooltip:"Hide testing"})]}):(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"expand-hog-testing",type:"secondary",onClick:()=>{toggleExpanded(),setTimeout(()=>{testResultsRef.current?.scrollIntoView({behavior:"smooth",block:"start"})},100)},children:"Start testing"})]}),expanded&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:testResult?(0,jsx_runtime.jsxs)("div",{className:"space-y-2","data-attr":"test-results",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"success"===testResult.status?"success":"error",children:"success"===testResult.status?"Success":"Error"}),"transformation"===type&&"success"===testResult.status?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Transformation result"}),sortedTestsResult?.hasDiff&&(0,jsx_runtime.jsx)(src.P4,{size:"xsmall",options:[{value:"raw",label:"Output"},{value:"diff",label:"Diff"}],onChange:value=>setTestResultMode(value),value:testResultMode})]}),(0,jsx_runtime.jsx)("p",{children:"Below you can see the event after the transformation has been applied."}),testResult.result?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!sortedTestsResult?.hasDiff&&(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:"The event was unmodified by the transformation."}),(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",originalValue:sortedTestsResult?.hasDiff&&"diff"===testResultMode?sortedTestsResult?.input:void 0,value:sortedTestsResult?.output,height:400,options:{readOnly:!0,lineNumbers:"off",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"hidden",verticalScrollbarSize:0},folding:!0}})]}):(0,jsx_runtime.jsx)(src.Vp,{type:"warning",children:"The event was dropped by the transformation. If this is expected then great news! If not, you should double check the configuration."})]}):null,(0,jsx_runtime.jsx)(src.HQ,{children:"Test invocation logs"}),(0,jsx_runtime.jsx)(src.g3,{dataSource:null!==(_testResult$logs=testResult.logs)&&void 0!==_testResult$logs?_testResult$logs:[],columns:[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:timestamp=>(0,jsx_runtime.jsx)(TZLabel.w,{time:timestamp}),width:0},{width:100,title:"Level",key:"level",dataIndex:"level"},{title:"Message",key:"message",dataIndex:"message",render:message=>(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}],className:"ph-no-capture",rowKey:"timestamp",pagination:{pageSize:200,hideOnSinglePage:!0}})]}):(0,jsx_runtime.jsx)("div",{className:"space-y-2",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"globals",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"broadcast"===type?"The test broadcast will be sent with this sample data:":"email"===type?"The provider will be tested with this sample data:":"Here are all the global variables you can use in your code:"}),sampleGlobalsLoading&&!fetchCancelled&&(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 text-muted",children:[(0,jsx_runtime.jsx)(src.$j,{}),(0,jsx_runtime.jsx)("span",{children:"Fetching new event..."}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>cancelSampleGlobalsLoading(),children:"Cancel"})]}),sampleGlobalsError?(0,jsx_runtime.jsx)("div",{className:"text-warning",children:sampleGlobalsError}):null]}),(0,jsx_runtime.jsx)(HogFunctionTestEditor,{value:value,onChange:onChange,readOnly:sampleGlobalsLoading})]})}})})})]}),jsonError&&(0,jsx_runtime.jsxs)(src.Vp,{type:"error",children:["JSON Error: ",jsonError]})]})}let humanize=value=>value.toLowerCase().replace(/_/g," ").replace(/-/g," ").replace(/\b\w/g,char=>char.toUpperCase()),MappingSummary=(0,react.memo)(function MappingSummary(_ref){var _mapping$filters$even,_mapping$filters$acti,_mapping$filters$even2,_mapping$filters$acti2,_ref2;let{mapping}=_ref,events=null!==(_mapping$filters$even=mapping.filters?.events?.map(event=>{var _event$name;return null!==(_event$name=event.name)&&void 0!==_event$name?_event$name:event.id}))&&void 0!==_mapping$filters$even?_mapping$filters$even:[],actions=null!==(_mapping$filters$acti=mapping.filters?.actions?.map(action=>{var _action$name;return null!==(_action$name=action.name)&&void 0!==_action$name?_action$name:action.id}))&&void 0!==_mapping$filters$acti?_mapping$filters$acti:[],propertyFiltersCount=(null!==(_mapping$filters$even2=mapping.filters?.events?.filter(event=>{var _event$properties$len;return null!==(_event$properties$len=event.properties?.length)&&void 0!==_event$properties$len?_event$properties$len:0}))&&void 0!==_mapping$filters$even2?_mapping$filters$even2:[]).length+(null!==(_mapping$filters$acti2=mapping.filters?.actions?.filter(action=>{var _action$properties$le;return null!==(_action$properties$le=action.properties?.length)&&void 0!==_action$properties$le?_action$properties$le:0}))&&void 0!==_mapping$filters$acti2?_mapping$filters$acti2:[]).length,eventSummary=[...events,...actions].join(", "),firstInput=mapping.inputs_schema?.[0],firstInputValue=null!==(_ref2=firstInput?.key?mapping.inputs?.[firstInput.key]?.value:null)&&void 0!==_ref2?_ref2:"(custom value)";return(0,jsx_runtime.jsxs)("span",{className:"flex items-center flex-1 gap-4",children:[(0,jsx_runtime.jsxs)("span",{children:[eventSummary?humanize(eventSummary):(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:"All events"})," ",propertyFiltersCount?(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:(0,jsx_runtime.jsx)(src.u,{title:`Events have ${propertyFiltersCount} additional filters`,children:(0,jsx_runtime.jsx)(posthog_icons_es.IconFilter,{})})}):null]}),(0,jsx_runtime.jsx)(posthog_icons_es.IconArrowRight,{className:"text-secondary"}),(0,jsx_runtime.jsx)("span",{children:"object"==typeof firstInputValue?JSON.stringify(firstInputValue):humanize(firstInputValue)}),(0,jsx_runtime.jsx)("span",{className:"flex-1"}),mapping.disabled?(0,jsx_runtime.jsx)(src.oe,{type:"danger",children:"Disabled"}):null]})});function HogFunctionMapping(_ref3){var _mapping$filters;let{index,mapping,onChange}=_ref3,{groupsTaxonomicTypes}=(0,index_esm.useValues)(groupsModel.$),{showSource}=(0,index_esm.useValues)(hogFunctionConfigurationLogic);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"p-3 pl-10 space-y-2",children:[mapping.disabled?(0,jsx_runtime.jsx)(src.Vp,{type:"warning",className:"p-2",action:{children:"Enable",onClick:()=>onChange({...mapping,disabled:!1})},children:"This mapping is disabled. It will not trigger the function."}):null,(0,jsx_runtime.jsx)(src.HQ,{children:"Match events and actions"}),(0,jsx_runtime.jsx)(ActionFilter.T,{filters:null!==(_mapping$filters=mapping.filters)&&void 0!==_mapping$filters?_mapping$filters:{},setFilters:f=>onChange({...mapping,filters:f}),typeKey:"match-group",mathAvailability:ActionFilterRow.Qq.None,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:[TaxonomicFilter_types.t.Events,TaxonomicFilter_types.t.Actions],propertiesTaxonomicGroupTypes:[TaxonomicFilter_types.t.EventProperties,TaxonomicFilter_types.t.EventFeatureFlags,TaxonomicFilter_types.t.Elements,TaxonomicFilter_types.t.PersonProperties,TaxonomicFilter_types.t.HogQLExpression,...groupsTaxonomicTypes],propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:types.DC.EVENTS},buttonProps:{type:"secondary"},buttonCopy:"Add event matcher"}),(0,jsx_runtime.jsx)(lib.Group,{name:["mappings",index],children:(0,jsx_runtime.jsx)(HogFunctionInputs,{configuration:mapping,setConfigurationValue:(key,value)=>{onChange({...mapping,[key]:value})}})}),showSource?(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),size:"small",type:"secondary",className:"my-4",onClick:()=>{var _mapping$inputs_schem,_mapping$inputs_schem2;onChange({...mapping,inputs_schema:[...null!==(_mapping$inputs_schem=mapping.inputs_schema)&&void 0!==_mapping$inputs_schem?_mapping$inputs_schem:[],{type:"string",key:`var_${(null!==(_mapping$inputs_schem2=mapping.inputs_schema?.length)&&void 0!==_mapping$inputs_schem2?_mapping$inputs_schem2:0)+1}`,label:"",required:!1}]})},children:"Add input variable"}):null]})})}function HogFunctionMappings(){let{useMapping,mappingTemplates,configuration}=(0,index_esm.useValues)(hogFunctionConfigurationLogic),[activeKeys,setActiveKeys]=(0,react.useState)([]);return((0,react.useEffect)(()=>{configuration.mappings?.length===1&&setActiveKeys([0])},[configuration.mappings?.length]),useMapping)?(0,jsx_runtime.jsx)(LemonField.D,{name:"mappings",children:_ref4=>{let{value,onChange}=_ref4,addMapping=template=>{let mappingTemplate=mappingTemplates.find(t=>t.name===template);if(mappingTemplate){let{name,...mapping}=mappingTemplate,inputs=mapping.inputs_schema?Object.fromEntries(mapping.inputs_schema.filter(m=>void 0!==m.default).map(m=>[m.key,{value:structuredClone(m.default)}])):{};onChange([...value,{...mapping,name,inputs}]),setActiveKeys([...activeKeys,value.length])}},duplicateMapping=mapping=>{let index=value.findIndex(m=>m===mapping);if(-1!==index){let newMappings=[...value];newMappings.splice(index+1,0,mapping),onChange(newMappings),setActiveKeys([index+1])}},removeMapping=mapping=>{let index=value.findIndex(m=>m===mapping);-1!==index&&(onChange(value.filter((_,i)=>i!==index)),setActiveKeys(activeKeys.filter(i=>i!==index)))},toggleDisabled=mapping=>{let index=value.findIndex(m=>m===mapping);-1!==index&&onChange(value.map((m,i)=>i===index?{...m,disabled:!m.disabled}:m))},addMappingButton=mappingTemplates.length?(0,jsx_runtime.jsx)(src.Yv,{placeholder:"Add mapping",onChange:template=>{addMapping(template)},options:mappingTemplates.map(t=>({label:t.name,value:t.name}))}):null;return(0,jsx_runtime.jsxs)("div",{className:"p-3 border rounded bg-surface-primary",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-start justify-between",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Mappings"}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-secondary",children:"Configure which events should act as triggers including filters and custom transformations"})]}),addMappingButton]}),(0,jsx_runtime.jsx)("div",{className:"space-y-2",children:value.length?(0,jsx_runtime.jsx)("div",{className:"-mx-3 border-t border-b",children:(0,jsx_runtime.jsx)(src.JL,{multiple:!0,embedded:!0,activeKeys:activeKeys,onChange:activeKeys=>setActiveKeys(activeKeys),panels:value.map((mapping,index)=>({key:index,header:{children:(0,jsx_runtime.jsx)(MappingSummary,{mapping:mapping}),sideAction:{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{}),dropdown:{overlay:(0,jsx_runtime.jsxs)("div",{className:"space-y-px",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>toggleDisabled(mapping),children:mapping.disabled?"Enable":"Disable"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>duplicateMapping(mapping),children:"Duplicate"}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",onClick:()=>removeMapping(mapping),children:"Remove"})]})}}},className:"p-0 bg-accent-light",content:(0,jsx_runtime.jsx)(HogFunctionMapping,{index:index,mapping:mapping,onChange:mapping=>{mapping?onChange(value.map((m,i)=>i===index?mapping:m)):onChange(value.filter((_,i)=>i!==index))}},index)}))})}):(0,jsx_runtime.jsx)(src.Vp,{type:"warning",className:"p-2",children:"You have no mappings configured which effectively means the function is disabled as there is nothing to trigger it."})})]})}}):null}var Sparkline=__webpack_require__("./src/lib/components/Sparkline.tsx"),LemonBanner=__webpack_require__("./src/lib/lemon-ui/LemonBanner/index.ts"),LemonButton=__webpack_require__("./src/lib/lemon-ui/LemonButton/index.ts"),Query=__webpack_require__("./src/queries/Query/Query.tsx");function HogFunctionEventEstimates(){var _sparkline$count,_sparkline$count2;let{sparkline,sparklineLoading,eventsDataTableNode,showEventsList}=(0,index_esm.useValues)(hogFunctionConfigurationLogic),{setShowEventsList}=(0,index_esm.useActions)(hogFunctionConfigurationLogic);if(!eventsDataTableNode)return null;let dataTableNode={...eventsDataTableNode,full:!0},insightUrl=urls.j.insightNew({type:types.dw.SQL,query:dataTableNode}),canvasUrl=urls.j.canvas()+"#="+btoa(JSON.stringify({type:"doc",content:[{type:"ph-query",attrs:{query:dataTableNode}}]}));return(0,jsx_runtime.jsxs)("div",{className:"relative p-3 space-y-2 border rounded bg-surface-primary",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Matching events"}),sparkline&&!sparklineLoading?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[sparkline.count>8e3?(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"warning",children:[(0,jsx_runtime.jsx)("b",{children:"Warning:"})," This destination would have triggered"," ",(0,jsx_runtime.jsxs)("strong",{children:[null!==(_sparkline$count=sparkline.count)&&void 0!==_sparkline$count?_sparkline$count:0," time",1!==sparkline.count?"s":""]})," ","in the last 7 days. Consider the impact of this function on your destination."]}):(0,jsx_runtime.jsxs)("p",{children:["This destination would have triggered"," ",(0,jsx_runtime.jsxs)("strong",{children:[null!==(_sparkline$count2=sparkline.count)&&void 0!==_sparkline$count2?_sparkline$count2:0," time",1!==sparkline.count?"s":""]})," ","in the last 7 days."]}),(0,jsx_runtime.jsx)(Sparkline.b,{type:"bar",className:"w-full h-20",data:sparkline.data,labels:sparkline.labels})]}):sparklineLoading?(0,jsx_runtime.jsx)("div",{className:"min-h-20",children:(0,jsx_runtime.jsx)(src.t2,{})}):(0,jsx_runtime.jsx)("p",{children:"The expected volume could not be calculated"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 pt-2 border-t border-dashed",children:[(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>setShowEventsList(!showEventsList),fullWidth:!0,center:!0,children:showEventsList?"Hide matching events":"Show matching events"}),showEventsList?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex items-start justify-end",children:(0,jsx_runtime.jsx)(src.Yv,{placeholder:"Open in...",onChange:target=>{"insight"===target?window.open(insightUrl,"_blank"):"canvas"===target&&window.open(canvasUrl,"_blank")},options:[{label:"New insight",value:"insight"},{label:"New canvas",value:"canvas"}]})}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col flex-1 overflow-y-auto border rounded max-h-200",children:eventsDataTableNode&&(0,jsx_runtime.jsx)(Query.A,{query:{...eventsDataTableNode,full:!1,showEventFilter:!1,showPropertyFilter:!1,embedded:!0,showOpenEditorButton:!1,showHogQLEditor:!1,showTimings:!1}})})]}):null]})]})}function HogFunctionConfiguration(_ref){var _displayOptions$embed,_displayOptions$hideP,_displayOptions$hideO,_displayOptions$showF,_displayOptions$showE,_displayOptions$showS,_displayOptions$showE2,_displayOptions$canEd,_displayOptions$showP,_displayOptions$showT;let{templateId,id,displayOptions={}}=_ref,logicProps={templateId,id},logic=hogFunctionConfigurationLogic(logicProps),{isConfigurationSubmitting,configurationChanged,showSource,configuration,loading,loaded,hogFunction,willReEnableOnSave,willChangeEnabledOnSave,globalsWithInputs,showPaygate,hasAddon,personsCount,personsCountLoading,personsListQuery,template,templateHasChanged,type,usesGroups,hasGroupsAddon}=(0,index_esm.useValues)(logic),{submitConfiguration,resetForm,setShowSource,duplicate,resetToTemplate,duplicateFromTemplate,setConfigurationValue,deleteHogFunction}=(0,index_esm.useActions)(logic),canEditTransformationHogCode=(0,useFeatureFlag.y)("HOG_TRANSFORMATIONS_CUSTOM_HOG_ENABLED");if(loading&&!loaded)return(0,jsx_runtime.jsx)(src.t2,{});if(!loaded)return(0,jsx_runtime.jsx)(NotFound.T,{object:"Hog function"});let isLegacyPlugin=(template?.id||hogFunction?.template?.id)?.startsWith("plugin-"),headerButtons=(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:!templateId&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!isLegacyPlugin&&(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,onClick:()=>duplicate(),children:"Duplicate"}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",fullWidth:!0,onClick:()=>deleteHogFunction(),children:"Delete"})]})}),(0,jsx_runtime.jsx)(src.p2,{vertical:!0})]})}),saveButtons=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[configurationChanged?(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",htmlType:"reset",onClick:()=>resetForm(),disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress":void 0:"No changes",children:"Clear changes"}):null,(0,jsx_runtime.jsxs)(src.Jp,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,children:[templateId?"Create":"Save",willReEnableOnSave?" & re-enable":willChangeEnabledOnSave?` & ${configuration.enabled?"enable":"disable"}`:""]})]});if(showPaygate)return(0,jsx_runtime.jsx)(PayGateMini.E,{feature:types.P$.DATA_PIPELINES});let embedded=null!==(_displayOptions$embed=displayOptions.embedded)&&void 0!==_displayOptions$embed&&_displayOptions$embed,includeHeaderButtons=!(null!==(_displayOptions$hideP=displayOptions.hidePageHeader)&&void 0!==_displayOptions$hideP&&_displayOptions$hideP),showOverview=!(null!==(_displayOptions$hideO=displayOptions.hideOverview)&&void 0!==_displayOptions$hideO&&_displayOptions$hideO),showFilters=null!==(_displayOptions$showF=displayOptions.showFilters)&&void 0!==_displayOptions$showF?_displayOptions$showF:["destination","internal_destination","site_destination","broadcast"].includes(type),showExpectedVolume=null!==(_displayOptions$showE=displayOptions.showExpectedVolume)&&void 0!==_displayOptions$showE?_displayOptions$showE:["destination","site_destination"].includes(type),showStatus=null!==(_displayOptions$showS=displayOptions.showStatus)&&void 0!==_displayOptions$showS?_displayOptions$showS:["destination","internal_destination","email","transformation"].includes(type),showEnabled=null!==(_displayOptions$showE2=displayOptions.showEnabled)&&void 0!==_displayOptions$showE2?_displayOptions$showE2:["destination","internal_destination","email","site_destination","site_app","transformation"].includes(type),canEditSource=null!==(_displayOptions$canEd=displayOptions.canEditSource)&&void 0!==_displayOptions$canEd?_displayOptions$canEd:!isLegacyPlugin&&(["destination","email","site_destination","site_app"].includes(type)||"transformation"===type&&canEditTransformationHogCode),showPersonsCount=null!==(_displayOptions$showP=displayOptions.showPersonsCount)&&void 0!==_displayOptions$showP?_displayOptions$showP:["broadcast"].includes(type),showTesting=null!==(_displayOptions$showT=displayOptions.showTesting)&&void 0!==_displayOptions$showT?_displayOptions$showT:["destination","internal_destination","transformation","broadcast","email"].includes(type),showLeftPanel=showOverview||showExpectedVolume||showPersonsCount||showFilters;return(0,jsx_runtime.jsx)("div",{className:"space-y-3",children:(0,jsx_runtime.jsxs)(index_esm.BindLogic,{logic:hogFunctionConfigurationLogic,props:logicProps,children:[includeHeaderButtons&&(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[headerButtons,saveButtons]})}),hogFunction?.filters?.bytecode_error?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)(src.Vp,{type:"error",children:[(0,jsx_runtime.jsx)("b",{children:"Error saving filters:"})," ",hogFunction.filters.bytecode_error]})}):null,(0,jsx_runtime.jsx)(lib.Form,{logic:hogFunctionConfigurationLogic,props:logicProps,formKey:"configuration",className:"space-y-3",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-start gap-4",children:[showLeftPanel&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1 gap-4 min-w-100",children:[(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("p-3 space-y-2 bg-surface-primary",!embedded&&"border rounded"),children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row items-center gap-2 min-h-16",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"icon_url",children:_ref2=>{var _ref3;let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(HogFunctionIcon.g,{logicKey:null!==(_ref3=null!=id?id:templateId)&&void 0!==_ref3?_ref3:"new",src:value,onChange:val=>onChange(val)})}}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col items-start justify-start flex-1 py-1",children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:configuration.name}),template&&(0,jsx_runtime.jsx)(DestinationTag.F,{status:template.status})]}),showStatus&&(0,jsx_runtime.jsx)(HogFunctionStatusIndicator.F,{hogFunction:hogFunction}),showEnabled&&(0,jsx_runtime.jsx)(LemonField.D,{name:"enabled",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsx)(src.f4,{label:"Enabled",onChange:()=>onChange(!value),checked:value,disabled:loading,bordered:!0})}})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{type:"text",disabled:loading})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"description",label:"Description",info:"Add a description to share context with other team members",children:(0,jsx_runtime.jsx)(src._V,{disabled:loading})}),isLegacyPlugin?null:hogFunction?.template&&!hogFunction.template.id.startsWith("template-blank-")?(0,jsx_runtime.jsx)(src.Qw,{showArrow:!0,overlay:(0,jsx_runtime.jsxs)("div",{className:"p-1 max-w-120",children:[(0,jsx_runtime.jsxs)("p",{children:["This function was built from the template"," ",(0,jsx_runtime.jsx)("b",{children:hogFunction.template.name}),". If the template is updated, this function is not affected unless you choose to update it."]}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center flex-1 gap-2 pt-2 border-t",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(src.Jp,{children:"Close"})}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>duplicateFromTemplate(),children:"New function from template"}),templateHasChanged?(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>resetToTemplate(),children:"Update"}):null]})]}),children:(0,jsx_runtime.jsx)("div",{className:"text-xs border border-dashed rounded text-secondary",children:(0,jsx_runtime.jsxs)(src.rU,{subtle:!0,className:"flex flex-wrap items-center gap-1 p-2",children:["Built from template:",(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:hogFunction?.template.name}),(0,jsx_runtime.jsx)(DestinationTag.F,{status:hogFunction.template.status}),templateHasChanged?(0,jsx_runtime.jsx)(src.oe,{type:"success",children:"Update available!"}):null]})})}):null]}),showFilters&&(0,jsx_runtime.jsx)(HogFunctionFilters,{}),showPersonsCount&&(0,jsx_runtime.jsxs)("div",{className:"relative p-3 space-y-2 border rounded bg-surface-primary",children:[(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(src.HQ,{children:"Matching persons"})}),personsCount&&!personsCountLoading?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Found"," ",(0,jsx_runtime.jsx)(src.rU,{to:(0,kea_router_lib.combineUrl)(urls.j.activity(),{},{q:personsListQuery}).url,children:(0,jsx_runtime.jsxs)("strong",{children:[null!=personsCount?personsCount:0," ",1!==personsCount?"people":"person"]})})," ","to send to."]}):personsCountLoading?(0,jsx_runtime.jsx)("div",{className:"min-h-20",children:(0,jsx_runtime.jsx)(src.t2,{})}):(0,jsx_runtime.jsx)("p",{children:"The expected volume could not be calculated"})]}),showExpectedVolume?(0,jsx_runtime.jsx)(HogFunctionEventEstimates,{}):null]}),(0,jsx_runtime.jsxs)("div",{className:"space-y-4 flex-2 min-w-100",children:[(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("p-3 space-y-2 bg-surface-primary",!embedded&&"border rounded"),children:(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[usesGroups&&!hasGroupsAddon?(0,jsx_runtime.jsx)(src.Vp,{type:"warning",children:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["This function appears to use Groups but you do not have the Groups Analytics addon. Without it, you may see empty values where you use templates like ",'"{groups.kind.properties}"',(0,jsx_runtime.jsx)(PayGateButton.R,{feature:types.P$.GROUP_ANALYTICS,type:"secondary"})]})}):null,(0,jsx_runtime.jsx)(HogFunctionInputs,{configuration:configuration,setConfigurationValue:setConfigurationValue}),showSource&&canEditSource?(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),size:"small",type:"secondary",className:"my-4",onClick:()=>{var _configuration$inputs,_configuration$inputs2;setConfigurationValue("inputs_schema",[...null!==(_configuration$inputs=configuration.inputs_schema)&&void 0!==_configuration$inputs?_configuration$inputs:[],{type:"string",key:`input_${(null!==(_configuration$inputs2=configuration.inputs_schema?.length)&&void 0!==_configuration$inputs2?_configuration$inputs2:0)+1}`,label:"",required:!1}])},children:"Add input variable"}):null]})}),(0,jsx_runtime.jsx)(HogFunctionMappings,{}),canEditSource&&(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("border rounded p-3 space-y-2",showSource?"bg-surface-primary":"bg-surface-secondary"),children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0",children:"Edit source"}),showSource?null:(0,jsx_runtime.jsx)("p",{children:"Click here to edit the function's source code"})]}),showSource?(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"secondary",onClick:()=>setShowSource(!1),children:"Hide source code"}):(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>setShowSource(!0),disabledReason:hasAddon?void 0:"Editing the source code requires the Data Pipelines addon",children:"Edit source code"})]}),showSource?(0,jsx_runtime.jsx)(LemonField.D,{name:"hog",children:_ref5=>{let{value,onChange}=_ref5;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[type.startsWith("site_")?null:(0,jsx_runtime.jsxs)("span",{className:"text-xs text-secondary",children:["This is the underlying Hog code that will run whenever the filters match."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/hog",children:"See the docs"})," ","for more info"]}),(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:type.startsWith("site_")?"typescript":"hog",value:null!=value?value:"",onChange:v=>onChange(null!=v?v:""),globals:globalsWithInputs,options:{minimap:{enabled:!1},wordWrap:"on",scrollBeyondLastLine:!1,automaticLayout:!0,fixedOverflowWidgets:!0,suggest:{showInlineDetails:!0},quickSuggestionsDelay:300}})]})}}):null]}),showTesting?(0,jsx_runtime.jsx)(HogFunctionTest,{}):null,(0,jsx_runtime.jsx)("div",{className:"flex justify-end gap-2",children:saveButtons})]})]})})]})})}},"./src/scenes/pipeline/hogfunctions/HogFunctionStatusIndicator.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{F:()=>HogFunctionStatusIndicator});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./@posthog/lemon-ui/src/index.ts"),_types__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/types.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let displayMap={[_types__WEBPACK_IMPORTED_MODULE_1__.si.healthy]:{tagType:"success",display:"Active",description:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.Fragment,{children:"The function is running as expected."})},[_types__WEBPACK_IMPORTED_MODULE_1__.si.overflowed]:{tagType:"caution",display:"Degraded",description:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.Fragment,{children:"The function is running slow or has issues performing async requests. It has been moved to the slow lane and may be processing slower than usual."})},[_types__WEBPACK_IMPORTED_MODULE_1__.si.disabledForPeriod]:{tagType:"danger",display:"Disabled temporarily",description:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.Fragment,{children:"The function has been disabled temporarily due to enough slow or failed requests. It will be re-enabled soon."})},[_types__WEBPACK_IMPORTED_MODULE_1__.si.disabledIndefinitely]:{tagType:"danger",display:"Disabled",description:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.Fragment,{children:'The function has been disabled indefinitely due to too many slow or failed requests. Please check your config. Updating your function will move it back to the "degraded" state for testing. If it performs well, it will then be moved to the healthy.'})}},DEFAULT_DISPLAY={tagType:"default",display:"Unknown",description:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.Fragment,{children:"The function status is unknown. The status will be derived once enough invocations have been performed."})},DISABLED_MANUALLY_DISPLAY={tagType:"default",display:"Paused",description:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.Fragment,{children:"This function is paused"})};function HogFunctionStatusIndicator(_ref){let{hogFunction}=_ref;if(!hogFunction)return null;let{tagType,display,description}="site_app"===hogFunction.type||"site_destination"===hogFunction.type?hogFunction.enabled?displayMap[_types__WEBPACK_IMPORTED_MODULE_1__.si.healthy]:DISABLED_MANUALLY_DISPLAY:hogFunction.status?.state?displayMap[hogFunction.status.state]:hogFunction.enabled?DEFAULT_DISPLAY:DISABLED_MANUALLY_DISPLAY;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.Qw,{overlay:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.Fragment,{children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsxs)("div",{className:"p-2 space-y-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsxs)("h2",{className:"flex items-center m-0 gap-2",children:["Function status - ",(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.oe,{type:tagType,children:display})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)("p",{children:description})]})}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.oe,{type:tagType,children:display})})}},"./src/scenes/pipeline/hogfunctions/integrations/IntegrationChoice.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{a:()=>IntegrationChoice});var _posthog_icons__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../node_modules/.pnpm/@posthog+icons@0.10.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib_api__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/lib/api.ts"),lib_integrations_integrationsLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./src/lib/integrations/integrationsLogic.ts"),lib_integrations_IntegrationView__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./src/lib/integrations/IntegrationView.tsx"),lib_utils__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./src/lib/utils.tsx"),scenes_urls__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./src/scenes/urls.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function IntegrationChoice(_ref){let{onChange,value,schema,integration,redirectUrl,beforeRedirect}=_ref,{integrationsLoading,integrations}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useValues)(lib_integrations_integrationsLogic__WEBPACK_IMPORTED_MODULE_4__.a),{newGoogleCloudKey}=(0,kea__WEBPACK_IMPORTED_MODULE_2__.useActions)(lib_integrations_integrationsLogic__WEBPACK_IMPORTED_MODULE_4__.a),integrationsOfKind=integrations?.filter(x=>x.kind===integration),integrationKind=integrationsOfKind?.find(integration=>integration.id===value);if(!integration)return null;if(integrationsLoading)return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.yW,{className:"h-10"});let kindName="google-pubsub"==integration?"Google Cloud Pub/Sub":"google-cloud-storage"==integration?"Google Cloud Storage":"google-ads"==integration?"Google Ads":(0,lib_utils__WEBPACK_IMPORTED_MODULE_6__.fm)(integration);function uploadKey(kind){let input=document.createElement("input");input.type="file",input.accept=".json",input.onchange=async e=>{let file=e.target.files?.[0];file&&newGoogleCloudKey(kind,file,integration=>onChange?.(integration.id))},input.click()}let button=(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.d6,{items:[integrationsOfKind?.length?{items:[...integrationsOfKind?.map(integration=>({icon:react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx("img",{src:integration.icon_url,className:"w-6 h-6 rounded"}),onClick:()=>onChange?.(integration.id),active:integration.id===value,label:integration.display_name}))||[]]}:null,["google-pubsub","google-cloud-storage"].includes(integration)?{items:[{onClick:()=>uploadKey(integration),label:"Upload Google Cloud .json key file"}]}:{items:[{to:lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.integrations.authorizeUrl({kind:integration,next:redirectUrl}),disableClientSideRouting:!0,onClick:beforeRedirect,label:integrationsOfKind?.length?`Connect to a different ${integration} integration`:`Connect to ${integration}`}]},{items:[{to:scenes_urls__WEBPACK_IMPORTED_MODULE_7__.j.settings("project-integrations"),label:"Manage integrations",sideIcon:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconExternal,{})},value?{onClick:()=>onChange?.(null),label:"Clear",sideIcon:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_0__.IconX,{})}:null]}],children:integrationKind?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{type:"secondary",children:"Change"}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsxs)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.Jp,{type:"secondary",children:["Choose ",kindName," connection"]})});return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.Fragment,{children:integrationKind?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(lib_integrations_IntegrationView__WEBPACK_IMPORTED_MODULE_5__.K,{schema:schema,integration:integrationKind,suffix:button}):button})}},"./src/scenes/pipeline/pipelineNodeLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{y:()=>pipelineNodeLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_router__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),lib_utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/lib/utils.tsx"),scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/scenes/sceneTypes.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./src/scenes/urls.ts"),_layout_navigation_3000_sidepanel_types__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./src/layout/navigation-3000/sidepanel/types.ts"),_types__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./src/types.ts"),_pipelineNodeNewLogic__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./src/scenes/pipeline/pipelineNodeNewLogic.tsx"),_types__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./src/scenes/pipeline/types.ts");let pipelineNodeLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.key)(_ref=>{let{id}=_ref;return id}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(id=>["scenes","pipeline","pipelineNodeLogic",id]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setCurrentTab:function(){let tab=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_types__WEBPACK_IMPORTED_MODULE_5__.il.Configuration;return{tab}},setBreadcrumbTitle:title=>({title})}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)(()=>({currentTab:[_types__WEBPACK_IMPORTED_MODULE_5__.il.Configuration,{setCurrentTab:(_,_ref2)=>{let{tab}=_ref2;return tab}}],breadcrumbTitle:["",{setBreadcrumbTitle:(_,_ref3)=>{let{title}=_ref3;return title}}]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(()=>({breadcrumbs:[(s,p)=>[p.id,p.stage,s.breadcrumbTitle],(id,stage,breadcrumbTitle)=>[{key:scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__.x.Pipeline,name:"Data pipeline",path:scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipeline()},{key:stage||"unknown",name:stage?(0,lib_utils__WEBPACK_IMPORTED_MODULE_2__.fm)(_pipelineNodeNewLogic__WEBPACK_IMPORTED_MODULE_6__.U[stage]||""):"Unknown",path:scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipeline(stage?_pipelineNodeNewLogic__WEBPACK_IMPORTED_MODULE_6__.U[stage]:void 0)},{key:[scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__.x.PipelineNode,id],name:breadcrumbTitle}]],[_layout_navigation_3000_sidepanel_types__WEBPACK_IMPORTED_MODULE_8__.f]:[s=>[s.node],node=>node.backend===_types__WEBPACK_IMPORTED_MODULE_7__.b.Plugin?{activity_scope:_types__WEBPACK_IMPORTED_MODULE_5__.jc.PLUGIN,activity_item_id:`${node.id}`}:null],nodeBackend:[s=>[s.node],node=>node.backend],node:[(_,p)=>[p.id],id=>"string"==typeof id?0===id.indexOf("hog-")?{backend:_types__WEBPACK_IMPORTED_MODULE_7__.b.HogFunction,id:`${id}`.replace("hog-","")}:0===id.indexOf("managed")?{backend:_types__WEBPACK_IMPORTED_MODULE_7__.b.ManagedSource,id:`${id}`.replace("managed-","")}:0===id.indexOf("self-managed")?{backend:_types__WEBPACK_IMPORTED_MODULE_7__.b.SelfManagedSource,id:`${id}`.replace("self-managed-","")}:{backend:_types__WEBPACK_IMPORTED_MODULE_7__.b.BatchExport,id}:{backend:_types__WEBPACK_IMPORTED_MODULE_7__.b.Plugin,id}],tabs:[s=>[s.nodeBackend],nodeBackend=>{let tabs=Object.values(_types__WEBPACK_IMPORTED_MODULE_5__.il);return nodeBackend===_types__WEBPACK_IMPORTED_MODULE_7__.b.BatchExport?tabs.filter(t=>t!==_types__WEBPACK_IMPORTED_MODULE_5__.il.History):tabs}],id:[(_,p)=>[p.id],id=>id],stage:[(_,p)=>[p.stage],stage=>stage]})),(0,kea_router__WEBPACK_IMPORTED_MODULE_1__.actionToUrl)(_ref4=>{let{values,props}=_ref4;return{setCurrentTab:()=>[scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipelineNode(props.stage,props.id,values.currentTab)]}}),(0,kea_router__WEBPACK_IMPORTED_MODULE_1__.urlToAction)(_ref5=>{let{props,actions,values}=_ref5;return{[scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipelineNode(props.stage,props.id,":nodeTab")]:_ref6=>{let{nodeTab}=_ref6;nodeTab!==values.currentTab&&Object.values(_types__WEBPACK_IMPORTED_MODULE_5__.il).includes(nodeTab)&&actions.setCurrentTab(nodeTab)}}})])},"./src/scenes/pipeline/pipelineNodeNewLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Q:()=>pipelineNodeNewLogic,U:()=>NODE_STAGE_TO_PIPELINE_TAB});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),lib_utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/lib/utils.tsx"),scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/scenes/sceneTypes.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./src/scenes/urls.ts"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./src/types.ts"),_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./src/scenes/pipeline/utils.tsx");let NODE_STAGE_TO_PIPELINE_TAB={[_types__WEBPACK_IMPORTED_MODULE_6__.We.Transformation]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.Transformations,[_types__WEBPACK_IMPORTED_MODULE_6__.We.Destination]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.Destinations,[_types__WEBPACK_IMPORTED_MODULE_6__.We.SiteApp]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.SiteApps,[_types__WEBPACK_IMPORTED_MODULE_6__.We.Source]:_types__WEBPACK_IMPORTED_MODULE_6__.J9.Sources},pipelineNodeNewLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)({values:[scenes_userLogic__WEBPACK_IMPORTED_MODULE_5__.userLogic,["user"]]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(id=>["scenes","pipeline","pipelineNodeNewLogic",id]),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)({plugins:[{},{loadPlugins:async()=>(0,_utils__WEBPACK_IMPORTED_MODULE_7__.c$)("api/organizations/@current/pipeline_destinations")}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(()=>({loading:[s=>[s.pluginsLoading],pluginsLoading=>pluginsLoading],breadcrumbs:[(_,p)=>[p.stage,p.pluginId,p.batchExportDestination],(stage,pluginId,batchDestination)=>[{key:scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_3__.x.Pipeline,name:"Data pipeline",path:scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipeline()},{key:stage||"unknown",name:stage?(0,lib_utils__WEBPACK_IMPORTED_MODULE_2__.fm)(NODE_STAGE_TO_PIPELINE_TAB[stage]||""):"Unknown",path:scenes_urls__WEBPACK_IMPORTED_MODULE_4__.j.pipeline(stage?NODE_STAGE_TO_PIPELINE_TAB[stage]:void 0)},{key:pluginId||batchDestination||"Unknown",name:pluginId?"New":batchDestination?`New ${batchDestination} destination`:"New"}]]}))])},"../node_modules/.pnpm/react-email-editor@1.7.11_react@18.2.0/node_modules/react-email-editor/dist/index.js":(module,__unused_webpack_exports,__webpack_require__)=>{module.exports=__webpack_require__("../node_modules/.pnpm/react-email-editor@1.7.11_react@18.2.0/node_modules/react-email-editor/dist/react-email-editor.cjs.production.min.js")},"../node_modules/.pnpm/react-email-editor@1.7.11_react@18.2.0/node_modules/react-email-editor/dist/react-email-editor.cjs.production.min.js":(__unused_webpack_module,exports,__webpack_require__)=>{var t=__webpack_require__("../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),n=t&&"object"==typeof t&&"default"in t?t.default:t;function o(){return(o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}var r=[],i=!1,l=function(){if(i)for(var e;e=r.shift();)e()},d="undefined"==typeof window?{__unlayer_lastEditorId:0}:window;d.__unlayer_lastEditorId=d.__unlayer_lastEditorId||0;var a=n.forwardRef(function(e,a){var u,s,c,f,p,y,v,E,m,_=e.onLoad,h=e.onReady,j=e.scriptUrl,b=e.minHeight,O=e.style,w=t.useState(null),x=w[0],M=w[1],L=t.useState(!1),S=L[0],H=L[1],R=t.useMemo(function(){return e.editorId||"editor-"+ ++d.__unlayer_lastEditorId},[e.editorId]),k=o({},e.options||{},{appearance:null!=(u=e.appearance)?u:null==(s=e.options)?void 0:s.appearance,displayMode:(null==e?void 0:e.displayMode)||(null==(c=e.options)?void 0:c.displayMode)||"email",locale:null!=(f=e.locale)?f:null==(p=e.options)?void 0:p.locale,projectId:null!=(y=e.projectId)?y:null==(v=e.options)?void 0:v.projectId,tools:null!=(E=e.tools)?E:null==(m=e.options)?void 0:m.tools,id:R,source:{name:"react-email-editor",version:"1.7.11"}});t.useImperativeHandle(a,function(){return{editor:x}},[x]),t.useEffect(function(){return function(){null==x||x.destroy()}},[]),t.useEffect(function(){H(!1),function(e,t){if(void 0===t&&(t="https://editor.unlayer.com/embed.js?2"),r.push(function(){return H(!0)}),e1=t,t1=document.querySelectorAll("script"),n=!1,t1.forEach(function(t){t.src.includes(e1)&&(n=!0)}),n)l();else{var e1,t1,n,n1=document.createElement("script");n1.setAttribute("src",t),n1.onload=function(){i=!0,l()},document.head.appendChild(n1)}}(0,j)},[j]),t.useEffect(function(){S&&(null==x||x.destroy(),M(unlayer.createEditor(k)))},[JSON.stringify(k),S]);var q=Object.keys(e).filter(function(e){return/^on/.test(e)});return t.useEffect(function(){x&&(null==_||_(x),q.forEach(function(t){/^on/.test(t)&&"onLoad"!==t&&"onReady"!==t&&"function"==typeof e[t]&&x.addEventListener(t,e[t])}),h&&x.addEventListener("editor:ready",function(){h(x)}))},[x,Object.keys(q).join(",")]),n.createElement("div",{style:{flex:1,display:"flex",minHeight:void 0===b?500:b}},n.createElement("div",{id:R,style:o({},void 0===O?{}:O,{flex:1})}))});exports.default=a}}]);