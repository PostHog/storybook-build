(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[70222],{"../../products/logs/frontend/LogsScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{LogsScene:()=>LogsScene,scene:()=>scene});var injectStylesIntoStyleTag=__webpack_require__("../../node_modules/.pnpm/style-loader@2.0.0_webpack@5.88.2/node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),sparkline_loading=__webpack_require__("../../node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!../../node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.5.3_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!../../node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!../../products/logs/frontend/sparkline-loading.scss"),sparkline_loading_default=__webpack_require__.n(sparkline_loading),options={};options.insert="head",options.singleton=!1,injectStylesIntoStyleTag_default()(sparkline_loading_default(),options),sparkline_loading_default().locals;var src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),Sparkline=__webpack_require__("../../frontend/src/lib/components/Sparkline.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),css_classes=__webpack_require__("../../frontend/src/lib/utils/css-classes.ts"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),UniversalFilters=__webpack_require__("../../frontend/src/lib/components/UniversalFilters/UniversalFilters.tsx"),universalFiltersLogic=__webpack_require__("../../frontend/src/lib/components/UniversalFilters/universalFiltersLogic.ts"),UniversalFilters_utils=__webpack_require__("../../frontend/src/lib/components/UniversalFilters/utils.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts");let logsLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","logs","frontend","logsLogic"]),(0,index_esm.actions)({runQuery:debounce=>({debounce}),cancelInProgressLogs:logsAbortController=>({logsAbortController}),cancelInProgressSparkline:sparklineAbortController=>({sparklineAbortController}),setLogsAbortController:logsAbortController=>({logsAbortController}),setSparklineAbortController:sparklineAbortController=>({sparklineAbortController}),setDateRange:dateRange=>({dateRange}),setOrderBy:orderBy=>({orderBy}),setSearchTerm:searchTerm=>({searchTerm}),setResource:resource=>({resource}),setSeverityLevels:severityLevels=>({severityLevels}),setWrapBody:wrapBody=>({wrapBody}),setFilterGroup:filterGroup=>({filterGroup})}),(0,index_esm.reducers)({dateRange:[{date_from:"-1h",date_to:null},{setDateRange:(_,_ref)=>{let{dateRange}=_ref;return dateRange}}],orderBy:["latest",{setOrderBy:(_,_ref2)=>{let{orderBy}=_ref2;return orderBy}}],searchTerm:["",{setSearchTerm:(_,_ref3)=>{let{searchTerm}=_ref3;return searchTerm}}],resource:["",{setResource:(_,_ref4)=>{let{resource}=_ref4;return resource}}],severityLevels:[[],{setSeverityLevels:(_,_ref5)=>{let{severityLevels}=_ref5;return severityLevels}}],filterGroup:[universalFiltersLogic.Y,{persist:!1},{setFilterGroup:(_,_ref6)=>{let{filterGroup}=_ref6;return filterGroup}}],wrapBody:[!0,{setWrapBody:(_,_ref7)=>{let{wrapBody}=_ref7;return wrapBody}}],logsAbortController:[null,{setLogsAbortController:(_,_ref8)=>{let{logsAbortController}=_ref8;return logsAbortController}}],sparklineAbortController:[null,{setSparklineAbortController:(_,_ref9)=>{let{sparklineAbortController}=_ref9;return sparklineAbortController}}],hasRunQuery:[!1,{fetchLogsSuccess:()=>!0,fetchLogsFailure:()=>!0}],logsLoading:[!1,{fetchLogs:()=>!0,fetchLogsSuccess:()=>!1,fetchLogsFailure:()=>!0}],sparklineLoading:[!1,{fetchSparkline:()=>!0,fetchSparklineSuccess:()=>!1,fetchSparklineFailure:()=>!0}]}),(0,lib.loaders)(_ref10=>{let{values,actions}=_ref10;return{logs:[[],{fetchLogs:async()=>{let logsController=new AbortController,signal=logsController.signal;actions.cancelInProgressLogs(logsController);let response=await api.ZP.logs.query({query:{limit:100,offset:values.logs.length,orderBy:values.orderBy,dateRange:values.dateRange,searchTerm:values.searchTerm,resource:values.resource,filterGroup:values.filterGroup,severityLevels:values.severityLevels},signal});return actions.setLogsAbortController(null),response.results}}],sparkline:[[],{fetchSparkline:async()=>{let sparklineController=new AbortController,signal=sparklineController.signal;actions.cancelInProgressSparkline(sparklineController);let response=await api.ZP.logs.sparkline({query:{orderBy:values.orderBy,dateRange:values.dateRange,searchTerm:values.searchTerm,resource:values.resource,filterGroup:values.filterGroup,severityLevels:values.severityLevels},signal});return actions.setSparklineAbortController(null),response}}]}}),(0,index_esm.listeners)(_ref11=>{let{values,actions}=_ref11,maybeRefreshLogs=()=>{values.hasRunQuery&&actions.runQuery(300)};return{runQuery:async(_ref12,breakpoint)=>{let{debounce}=_ref12;debounce&&await breakpoint(debounce),actions.fetchLogs(),actions.fetchSparkline()},cancelInProgressLogs:_ref13=>{let{logsAbortController}=_ref13;null!==values.logsAbortController&&values.logsAbortController.abort("new query started"),actions.setLogsAbortController(logsAbortController)},cancelInProgressSparkline:_ref14=>{let{sparklineAbortController}=_ref14;null!==values.sparklineAbortController&&values.sparklineAbortController.abort("new query started"),actions.setSparklineAbortController(sparklineAbortController)},setDateRange:maybeRefreshLogs,setOrderBy:maybeRefreshLogs,setSearchTerm:maybeRefreshLogs,setResource:maybeRefreshLogs,setSeverityLevels:maybeRefreshLogs,setFilterGroup:maybeRefreshLogs}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let AttributesFilter=()=>{let{filterGroup}=(0,index_esm.useValues)(logsLogic),{setFilterGroup}=(0,index_esm.useActions)(logsLogic);return(0,jsx_runtime.jsx)(UniversalFilters.Z,{rootKey:"logs",group:filterGroup,taxonomicGroupTypes:[types.t.Logs],onChange:filterGroup=>{setFilterGroup(filterGroup)},children:(0,jsx_runtime.jsx)(NestedFilterGroup,{})})},NestedFilterGroup=()=>{let{filterGroup}=(0,index_esm.useValues)(universalFiltersLogic.d),{replaceGroupValue,removeGroupValue}=(0,index_esm.useActions)(universalFiltersLogic.d);return(0,jsx_runtime.jsxs)("div",{className:"border",children:[filterGroup.values.map((filterOrGroup,index)=>(0,UniversalFilters_utils.pU)(filterOrGroup)?(0,jsx_runtime.jsx)(UniversalFilters.Z.Group,{index:index,group:filterOrGroup,children:(0,jsx_runtime.jsx)(NestedFilterGroup,{})},index):(0,jsx_runtime.jsx)(UniversalFilters.Z.Value,{index:index,filter:filterOrGroup,onRemove:()=>removeGroupValue(index),onChange:value=>replaceGroupValue(index,value)},index)),(0,jsx_runtime.jsx)(UniversalFilters.Z.AddFilterButton,{})]})};var DateFilter=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx");let dateMapping=[{key:__webpack_require__("../../frontend/src/lib/components/DateFilter/types.ts").Q2,values:[]},{key:"Last 30 minutes",values:["-30M"],getFormattedDate:date=>date.subtract(30,"minute").format(utils.a1),defaultInterval:"minute"},{key:"Last 1 hours",values:["-1h"],getFormattedDate:date=>(0,utils._Q)(date.subtract(1,"h"),date.endOf("d")),defaultInterval:"hour"},{key:"Last 4 hours",values:["-4h"],getFormattedDate:date=>(0,utils._Q)(date.subtract(4,"h"),date.endOf("d")),defaultInterval:"hour"},{key:"Last 24 hours",values:["-24h"],getFormattedDate:date=>(0,utils._Q)(date.subtract(24,"h"),date.endOf("d")),defaultInterval:"hour"},{key:"Last 7 days",values:["-7d"],getFormattedDate:date=>(0,utils._Q)(date.subtract(7,"d"),date.endOf("d")),defaultInterval:"day"},{key:"Last 30 days",values:["-30d"],getFormattedDate:date=>(0,utils._Q)(date.subtract(30,"d"),date.endOf("d")),defaultInterval:"day"}],DateRangeFilter=()=>{let{dateRange}=(0,index_esm.useValues)(logsLogic),{setDateRange}=(0,index_esm.useActions)(logsLogic);return(0,jsx_runtime.jsx)("span",{className:"rounded bg-surface-primary",children:(0,jsx_runtime.jsx)(DateFilter.f,{size:"small",dateFrom:dateRange.date_from,dateTo:dateRange.date_to,dateOptions:dateMapping,onChange:(changedDateFrom,changedDateTo)=>{setDateRange({date_from:changedDateFrom,date_to:changedDateTo})},allowTimePrecision:!0,allowedRollingDateOptions:["minutes","hours","days","weeks","months"]})})},SearchTermFilter=()=>{let{searchTerm}=(0,index_esm.useValues)(logsLogic),{setSearchTerm}=(0,index_esm.useActions)(logsLogic);return(0,jsx_runtime.jsx)("span",{className:"rounded bg-surface-primary",children:(0,jsx_runtime.jsx)(src.DF,{size:"small",value:searchTerm,onChange:value=>setSearchTerm(value),placeholder:"Search logs..."})})};var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.20.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js");let SeverityLevelsFilter_options={trace:"Trace",info:"Info",debug:"Debug",warn:"Warn",error:"Error",fatal:"Fatal"},SeverityLevelsFilter=()=>{let{severityLevels}=(0,index_esm.useValues)(logsLogic),{setSeverityLevels}=(0,index_esm.useActions)(logsLogic),onClick=level=>{let levels=[...severityLevels],index=levels.indexOf(level);index>-1?levels.splice(index,1):levels.push(level),setSeverityLevels(levels)},displayLevels=severityLevels.length>0?severityLevels.map(l=>(0,utils.fm)(l)).join(", "):"All levels";return(0,jsx_runtime.jsx)("span",{className:"rounded bg-surface-primary",children:(0,jsx_runtime.jsx)(src.d6,{closeOnClickInside:!1,items:Object.entries(SeverityLevelsFilter_options).map(_ref=>{let[key,label]=_ref;return{label,onClick:()=>onClick(key),active:severityLevels.includes(key)}}),children:(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconFilter,{}),size:"small",type:"secondary",children:displayLevels})})})},scene={component:LogsScene};function LogsScene(){let{wrapBody,logs,sparkline,logsLoading,sparklineLoading}=(0,index_esm.useValues)(logsLogic),{runQuery}=(0,index_esm.useActions)(logsLogic);(0,react.useEffect)(()=>{runQuery()},[runQuery]);let labels=[],lastTime="",i=-1,timeseries=Object.entries(sparkline.reduce((accumulator,currentItem)=>{currentItem.time!==lastTime&&(labels.push((0,utils.bo)(currentItem.time)),lastTime=currentItem.time,i++);let key=currentItem.level;return accumulator[key]||(accumulator[key]=Array(sparkline.length)),accumulator[key][i]=currentItem.count,accumulator},{})).map(_ref=>{let[level,data]=_ref;return{name:level,values:data,color:({fatal:"danger-dark",error:"danger",warn:"warning",info:"brand-blue",debug:"muted",trace:"muted-alt"})[level]}}).filter(series=>series.values.reduce((a,b)=>a+b)>0);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-y-2 h-screen",children:[(0,jsx_runtime.jsx)(Filters,{}),(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:sparklineLoading?"sparkline-loading":"",children:[(0,jsx_runtime.jsx)(Sparkline.b,{labels:labels,data:timeseries,className:"w-full"}),sparklineLoading&&(0,jsx_runtime.jsx)("div",{className:"sparkline-loading-overlay"})]}),(0,jsx_runtime.jsx)(DisplayOptions,{}),(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(src.g3,{hideScrollbar:!0,dataSource:logs,loading:logsLoading,size:"small",columns:[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",width:0,render:timestamp=>(0,jsx_runtime.jsx)(TZLabel.w,{time:timestamp+"Z"})},{title:"Level",key:"severity_text",dataIndex:"severity_text",width:0,render:(_,record)=>(0,jsx_runtime.jsx)(LogTag,{level:record.severity_text})},{title:"Message",key:"body",dataIndex:"body",render:body=>(0,jsx_runtime.jsx)("div",{className:(0,css_classes.cn)(wrapBody?"":"whitespace-nowrap"),children:body})}],expandable:{noIndent:!0,expandedRowRender:log=>(0,jsx_runtime.jsx)(ExpandedLog,{log:log})}})})]})]})}let ExpandedLog=_ref2=>{let{log}=_ref2,rows=Object.entries(log.attributes).map(_ref3=>{let[key,value]=_ref3;return{key,value}});return(0,jsx_runtime.jsx)(src.g3,{embedded:!0,showHeader:!1,columns:[{title:"Key",key:"key",dataIndex:"key",width:0},{title:"Value",key:"value",dataIndex:"value"}],dataSource:rows})},LogTag=_ref4=>{let{level}=_ref4;return(0,jsx_runtime.jsx)(src.oe,{type:{debug:"completion",info:"caution",warn:"warning",error:"danger"}[level],children:level})},Filters=()=>{let{logsLoading}=(0,index_esm.useValues)(logsLogic),{runQuery}=(0,index_esm.useActions)(logsLogic);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-y-1.5",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between gap-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-x-1",children:[(0,jsx_runtime.jsx)(AttributesFilter,{}),(0,jsx_runtime.jsx)(SeverityLevelsFilter,{})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-x-1",children:[(0,jsx_runtime.jsx)(DateRangeFilter,{}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",icon:(0,jsx_runtime.jsx)(icons.tr,{}),type:"secondary",onClick:()=>runQuery(),loading:logsLoading,children:logsLoading?"Loading...":"Search"})]})]}),(0,jsx_runtime.jsx)(SearchTermFilter,{})]})},DisplayOptions=()=>{let{orderBy,wrapBody}=(0,index_esm.useValues)(logsLogic),{setOrderBy,setWrapBody}=(0,index_esm.useActions)(logsLogic);return(0,jsx_runtime.jsxs)("div",{className:"flex gap-x-2",children:[(0,jsx_runtime.jsx)(src.P4,{value:orderBy,onChange:setOrderBy,options:[{value:"earliest",label:"Earliest"},{value:"latest",label:"Latest"}],size:"small"}),(0,jsx_runtime.jsx)(src.Hw,{checked:wrapBody,bordered:!0,onChange:setWrapBody,label:"Wrap message",size:"small"})]})}},"../../node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!../../node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.5.3_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!../../node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!../../products/logs/frontend/sparkline-loading.scss":(module,exports,__webpack_require__)=>{(exports=__webpack_require__("../../node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/runtime/api.js")(!1)).push([module.id,'.sparkline-loading{opacity:.25;position:relative}.sparkline-loading-overlay{height:100%;left:0;overflow:hidden;position:absolute;top:0;width:100%}.sparkline-loading-overlay:after{animation:Sparkline__loading-shine-skewed 1.5s linear infinite;background:linear-gradient(90deg,transparent 0,hsla(0,0%,100%,.6) 50%,transparent);content:"";height:200%;left:-75%;opacity:.8;position:absolute;top:-50%;transform:skewX(-25deg);width:50%}@keyframes Sparkline__loading-shine-skewed{0%{left:-75%}to{left:125%}}',""]),module.exports=exports}}]);