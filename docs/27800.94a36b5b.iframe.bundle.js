"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[27800],{"../../frontend/src/scenes/persons/PersonScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{PersonScene:()=>PersonScene,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.33.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),ActivityLog=__webpack_require__("../../frontend/src/lib/components/ActivityLog/ActivityLog.tsx"),CopyToClipboard=__webpack_require__("../../frontend/src/lib/components/CopyToClipboard.tsx"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),PropertiesTable=__webpack_require__("../../frontend/src/lib/components/PropertiesTable/index.ts"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),groupsAccessLogic=__webpack_require__("../../frontend/src/lib/introductions/groupsAccessLogic.ts"),LemonBanner=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonBanner/index.ts"),LemonTabs=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTabs/index.ts"),Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/Spinner.tsx"),Tooltip=__webpack_require__("../../frontend/src/lib/lemon-ui/Tooltip/index.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),copyToClipboard=__webpack_require__("../../frontend/src/lib/utils/copyToClipboard.tsx"),api=__webpack_require__("../../frontend/src/lib/api.ts");let openInAdminPanel=async email=>{try{let response=await api.ZP.users.list(email);if(!response.results||0===response.results.length)throw Error("User not found");let userId=response.results[0].id;window.open(`/admin/posthog/user/${userId}/change/`,"_blank")}catch(error){let message=error instanceof Error?error.message:String(error);src.UJ.error(`Failed to open admin panel: ${message}`)}};var product_intents=__webpack_require__("../../frontend/src/lib/utils/product-intents.ts"),RelatedGroups=__webpack_require__("../../frontend/src/scenes/groups/RelatedGroups.tsx"),NotebookSelectButton=__webpack_require__("../../frontend/src/scenes/notebooks/NotebookSelectButton/NotebookSelectButton.tsx"),types=__webpack_require__("../../frontend/src/scenes/notebooks/types.ts"),PersonDeleteModal=__webpack_require__("../../frontend/src/scenes/persons/PersonDeleteModal.tsx"),personDeleteModalLogic=__webpack_require__("../../frontend/src/scenes/persons/personDeleteModalLogic.tsx"),sceneTypes=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts"),scenes=__webpack_require__("../../frontend/src/scenes/scenes.ts"),SessionRecordingsPlaylist=__webpack_require__("../../frontend/src/scenes/session-recordings/playlist/SessionRecordingsPlaylist.tsx"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),SceneContent=__webpack_require__("../../frontend/src/layout/scenes/components/SceneContent.tsx"),SceneDivider=__webpack_require__("../../frontend/src/layout/scenes/components/SceneDivider.tsx"),SceneTitleSection=__webpack_require__("../../frontend/src/layout/scenes/components/SceneTitleSection.tsx"),Query=__webpack_require__("../../frontend/src/queries/Query/Query.tsx"),src_types=__webpack_require__("../../frontend/src/types.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/LemonToast.tsx"),eventUsageLogic=__webpack_require__("../../frontend/src/lib/utils/eventUsageLogic.ts"),personsLogic=__webpack_require__("../../frontend/src/scenes/persons/personsLogic.tsx");let mergeSplitPersonLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>{var _props$person$id;return null!==(_props$person$id=props.person.id)&&void 0!==_props$person$id?_props$person$id:"new"}),(0,index_esm.path)(key=>["scenes","persons","mergeSplitPersonLogic",key]),(0,index_esm.connect)(()=>({actions:[(0,personsLogic.T)({syncWithUrl:!0}),["setListFilters","loadPersons","setPerson","setSplitMergeModalShown"]],values:[(0,personsLogic.T)({syncWithUrl:!0}),["persons"]]})),(0,index_esm.actions)({setSelectedPersonToAssignSplit:id=>({id}),cancel:!0}),(0,lib.loaders)(_ref=>{let{values,actions}=_ref;return{executed:[!1,{execute:async()=>!!(await api.ZP.create("api/person/"+values.person.id+"/split/",values.selectedPersonToAssignSplit?{main_distinct_id:values.selectedPersonToAssignSplit}:{})).success&&(LemonToast.UJ.success("Person succesfully split. This may take up to a couple of minutes to complete."),eventUsageLogic.vx.actions.reportPersonSplit(values.person.distinct_ids.length),actions.setSplitMergeModalShown(!1),kea_router_lib.router.actions.push("/persons"),!0)}]}}),(0,index_esm.reducers)(_ref2=>{let{props}=_ref2;return{person:[props.person,{}],selectedPersonToAssignSplit:[null,{setSelectedPersonToAssignSplit:(_,_ref3)=>{let{id}=_ref3;return id}}]}}),(0,index_esm.listeners)(_ref4=>{let{actions,values}=_ref4;return{setListFilters:()=>{actions.loadPersons()},cancel:()=>{values.executedLoading||actions.setSplitMergeModalShown(!1)}}}),(0,index_esm.events)(_ref5=>{let{actions}=_ref5;return{afterMount:[actions.loadPersons]}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function MergeSplitPerson(_ref){let{person}=_ref,logicProps={person},{executedLoading}=(0,index_esm.useValues)(mergeSplitPersonLogic(logicProps)),{execute,cancel}=(0,index_esm.useActions)(mergeSplitPersonLogic(logicProps));return(0,jsx_runtime.jsx)(src.fQ,{isOpen:!0,width:"40rem",title:"Split persons",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:cancel,disabledReason:executedLoading&&"Splitting the user",children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:execute,loading:executedLoading,children:"Split persons"})]}),onClose:cancel,children:person.distinct_ids.length<2?"Only persons with more than two distinct IDs can be split.":(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:mergeSplitPersonLogic,props:logicProps,children:(0,jsx_runtime.jsx)(SplitPerson,{})})})}function SplitPerson(){let{person,selectedPersonToAssignSplit,executedLoading}=(0,index_esm.useValues)(mergeSplitPersonLogic),{setSelectedPersonToAssignSplit}=(0,index_esm.useActions)(mergeSplitPersonLogic);if(!person)return null;let options=person.distinct_ids.map(distinctId=>({label:distinctId,value:distinctId}));return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"This will split all Distinct IDs for this person into unique persons."}),(0,jsx_runtime.jsxs)("p",{children:["You can select a distinct ID for which all the current properties will be assigned (",(0,jsx_runtime.jsx)("i",{children:"optional"}),"). All other new users will start without any properties."]}),(0,jsx_runtime.jsx)(src.Yv,{fullWidth:!0,options:options,placeholder:"Select a distinct ID to which to assign all properties (optional)",disabledReason:executedLoading&&"Splitting user",value:selectedPersonToAssignSplit,onChange:value=>setSelectedPersonToAssignSplit(value)}),(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"warning",className:"mt-4",children:["This will create ",(0,jsx_runtime.jsx)("strong",{children:person.distinct_ids.length-1})," ",(0,utils.Zi)(person.distinct_ids.length-1,"newÂ person",void 0,!1),". This might change the numbers in your charts, even historically. Please be certain."]})]})}var react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),LemonTable=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/index.ts"),Link=__webpack_require__("../../frontend/src/lib/lemon-ui/Link/index.ts");function PersonCohorts(){let{cohorts,cohortsLoading,person}=(0,index_esm.useValues)(personsLogic.T),{loadCohorts}=(0,index_esm.useActions)(personsLogic.T);(0,react.useEffect)(()=>{loadCohorts()},[person,loadCohorts]);let columns=[{title:"Name",dataIndex:"name",key:"name",className:"ph-no-capture",render:function RenderName(_,cohort){return(0,jsx_runtime.jsx)(Link.r,{to:urls.j.cohort(cohort.id),children:(0,jsx_runtime.jsx)("strong",{children:cohort.name})})},sorter:(a,b)=>(a.name||"").localeCompare(b.name||"")},{title:"Users in cohort",render:function RenderCount(count){return count?.toLocaleString()},dataIndex:"count",sorter:(a,b)=>(a.count||0)-(b.count||0)}];return(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:cohorts||[],loading:cohortsLoading,columns:columns,rowKey:"id",pagination:{pageSize:30,hideOnSinglePage:!0},emptyState:"This person doesn't belong to any cohort"})}var preflightLogic=__webpack_require__("../../frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),Notebook=__webpack_require__("../../frontend/src/scenes/notebooks/Notebook/Notebook.tsx");let persons_PersonFeedCanvas=_ref=>{let{person}=_ref,{isCloudOrDev}=(0,index_esm.useValues)(preflightLogic.preflightLogic),id=person.id,distinctId=person.distinct_ids[0];return(0,jsx_runtime.jsx)(Notebook.a,{editable:!1,shortId:`canvas-${id}`,mode:"canvas",initialContent:{type:"doc",content:[{type:"ph-person-feed",attrs:{height:null,title:null,nodeId:(0,utils.Vj)(),id,distinctId,__init:null,children:[{type:"ph-person",attrs:{id,distinctId,nodeId:(0,utils.Vj)(),title:"Info"}},...isCloudOrDev?[{type:"ph-map",attrs:{id,distinctId,nodeId:(0,utils.Vj)()}}]:[],{type:"ph-properties",attrs:{id,distinctId,nodeId:(0,utils.Vj)()}}]}},{type:"ph-llm-trace",attrs:{personId:id,nodeId:(0,utils.Vj)()}},{type:"ph-issues",attrs:{personId:id,nodeId:(0,utils.Vj)()}}]}})};var RelatedFeatureFlags=__webpack_require__("../../frontend/src/scenes/persons/RelatedFeatureFlags.tsx");let scene={component:PersonScene,logic:personsLogic.T,paramsToProps:_ref=>{let{params:{_:rawUrlId}}=_ref;return{syncWithUrl:!0,urlId:decodeURIComponent(rawUrlId)}}};function PersonCaption(_ref2){let{person}=_ref2;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex deprecated-space-x-1",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:"IDs:"})," ",(0,jsx_runtime.jsx)(CopyToClipboard.D,{tooltipMessage:null,description:"person distinct ID",style:{justifyContent:"flex-end"},children:person.distinct_ids[0]})]}),person.distinct_ids.length>1&&(0,jsx_runtime.jsx)(src.d6,{items:person.distinct_ids.slice(1).map(distinct_id=>({label:distinct_id,sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconCopy,{className:"text-primary-3000"}),onClick:()=>(0,copyToClipboard.v)(distinct_id,"distinct id")})),children:(0,jsx_runtime.jsxs)(src.oe,{type:"primary",className:"inline-flex",children:[(0,jsx_runtime.jsxs)("span",{children:["+",person.distinct_ids.length-1]}),(0,jsx_runtime.jsx)(posthog_icons_es.IconChevronDown,{className:"w-4 h-4"})]})})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:"First seen:"})," ",person.created_at?(0,jsx_runtime.jsx)(TZLabel.w,{time:person.created_at}):"unknown"]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:"Merge restrictions:"})," ",person.is_identified?"applied":"none",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/data/identify#alias-assigning-multiple-distinct-ids-to-the-same-user",children:(0,jsx_runtime.jsx)(Tooltip.u,{title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[person.is_identified?(0,jsx_runtime.jsx)("strong",{children:"Cannot"}):"Can"," be used as `alias_id` - click for more info."]}),children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"ml-1 text-base shrink-0"})})})]})]})}function PersonScene(){let{feedEnabled,person,personLoading,personError,currentTab,splitMergeModalShown,urlId,distinctId,primaryDistinctId,eventsQuery,exceptionsQuery}=(0,index_esm.useValues)(personsLogic.T),{loadPersons,editProperty,deleteProperty,navigateToTab,setSplitMergeModalShown,setDistinctId}=(0,index_esm.useActions)(personsLogic.T),{showPersonDeleteModal}=(0,index_esm.useActions)(personDeleteModalLogic.C),{deletedPersonLoading}=(0,index_esm.useValues)(personDeleteModalLogic.C),{groupsEnabled}=(0,index_esm.useValues)(groupsAccessLogic.e),{currentTeam}=(0,index_esm.useValues)(teamLogic.teamLogic),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.featureFlagLogic),{addProductIntentForCrossSell}=(0,index_esm.useActions)(teamLogic.teamLogic),{user}=(0,index_esm.useValues)(userLogic.userLogic);if(personError)throw Error(personError);if(!person)return personLoading?(0,jsx_runtime.jsx)(Spinner.t,{sceneLevel:!0}):(0,jsx_runtime.jsx)(NotFound.T,{object:"person",meta:{urlId}});let settingLevel=featureFlags[constants.y8.ENVIRONMENTS]?"environment":"project";return(0,jsx_runtime.jsxs)(SceneContent._,{children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:"Person",resourceType:{type:scenes.lc[sceneTypes.x.Person].iconType||"default_icon_type"},forceBackTo:{name:scenes.lc[sceneTypes.x.Persons].name,path:urls.j.persons(),key:"people"},actions:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(NotebookSelectButton.R,{resource:{type:types.C.Person,attrs:{distinctId:person?.distinct_ids[0]}},type:"secondary",size:"small"}),user?.is_staff&&(0,jsx_runtime.jsx)(OpenInAdminPanelButton,{}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>showPersonDeleteModal(person,()=>loadPersons()),disabled:deletedPersonLoading,loading:deletedPersonLoading,type:"secondary",status:"danger","data-attr":"delete-person",size:"small",children:"Delete person"}),person.distinct_ids.length>1&&(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>setSplitMergeModalShown(!0),"data-attr":"merge-person-button",type:"secondary",size:"small",children:"Split IDs"})]})}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsx)(PersonCaption,{person:person}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsx)(PersonDeleteModal.S,{}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:currentTab,onChange:tab=>{navigateToTab(tab)},"data-attr":"persons-tabs",tabs:[!!feedEnabled&&{key:src_types.j3.FEED,label:(0,jsx_runtime.jsx)("span",{"data-attr":"persons-feed-tab",children:"Feed"}),content:(0,jsx_runtime.jsx)(persons_PersonFeedCanvas,{person:person})},{key:src_types.j3.PROPERTIES,label:(0,jsx_runtime.jsx)("span",{"data-attr":"persons-properties-tab",children:"Properties"}),content:(0,jsx_runtime.jsx)(PropertiesTable.V,{type:src_types.ll.Person,properties:person.properties||{},searchable:!0,onEdit:editProperty,sortProperties:!0,embedded:!1,onDelete:key=>deleteProperty(key),filterable:!0})},{key:src_types.j3.EVENTS,label:(0,jsx_runtime.jsx)("span",{"data-attr":"persons-events-tab",children:"Events"}),content:(0,jsx_runtime.jsx)(Query.A,{query:eventsQuery})},{key:src_types.j3.SESSION_RECORDINGS,label:(0,jsx_runtime.jsx)("span",{"data-attr":"person-session-recordings-tab",children:"Recordings"}),content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[currentTeam?.session_recording_opt_in?null:(0,jsx_runtime.jsx)("div",{className:"mb-4",children:(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"info",children:["Session recordings are currently disabled for this ",settingLevel,". To use this feature, please go to your"," ",(0,jsx_runtime.jsx)(src.rU,{to:`${urls.j.settings("project")}#recordings`,onClick:()=>{addProductIntentForCrossSell({from:src_types.Md.PERSONS,to:src_types.Md.SESSION_REPLAY,intent_context:product_intents.kp.PERSON_VIEW_RECORDINGS})},children:"project settings"})," ","and enable it."]})}),(0,jsx_runtime.jsx)("div",{className:"SessionRecordingPlaylistHeightWrapper",children:(0,jsx_runtime.jsx)(SessionRecordingsPlaylist.m,{logicKey:`person-scene-${person.uuid}`,personUUID:person.uuid,distinctIds:person.distinct_ids,updateSearchParams:!0})})]})},{key:src_types.j3.EXCEPTIONS,label:(0,jsx_runtime.jsx)("span",{"data-attr":"persons-exceptions-tab",children:"Exceptions"}),content:(0,jsx_runtime.jsx)(Query.A,{query:exceptionsQuery})},{key:src_types.j3.COHORTS,label:(0,jsx_runtime.jsx)("span",{"data-attr":"persons-cohorts-tab",children:"Cohorts"}),content:(0,jsx_runtime.jsx)(PersonCohorts,{})},!!groupsEnabled&&!!person.uuid&&{key:src_types.j3.RELATED,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center","data-attr":"persons-related-tab",children:["Related groups",(0,jsx_runtime.jsx)(Tooltip.u,{title:"People and groups that have shared events with this person in the last 90 days.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"ml-1 text-base shrink-0"})})]}),content:(0,jsx_runtime.jsx)(RelatedGroups.S,{id:person.uuid,groupTypeIndex:null})},!!person.uuid&&{key:src_types.j3.FEATURE_FLAGS,tooltip:"Only shows feature flags with targeting conditions based on person properties.",label:(0,jsx_runtime.jsx)("span",{"data-attr":"persons-related-flags-tab",children:"Feature flags"}),content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex deprecated-space-x-2 items-center mb-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:["Choose ID:",(0,jsx_runtime.jsx)(Tooltip.u,{title:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"Feature flags values can depend on a person's distinct ID."}),(0,jsx_runtime.jsx)("div",{children:"If you want your flag values to stay consistent for each user, you can enable flag persistence in the feature flag settings."}),(0,jsx_runtime.jsxs)("div",{children:["This option may depend on your specific setup and isn't always suitable. Read more in the"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/feature-flags/creating-feature-flags#persisting-feature-flags-across-authentication-steps",children:"documentation."})]})]}),children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"ml-1 text-base"})})]}),(0,jsx_runtime.jsx)(src.Yv,{value:distinctId||primaryDistinctId,onChange:value=>value&&setDistinctId(value),options:person.distinct_ids.map(distinct_id=>({label:distinct_id,value:distinct_id})),"data-attr":"person-feature-flags-select"})]}),(0,jsx_runtime.jsx)(src.p2,{className:"mb-4"}),(0,jsx_runtime.jsx)(RelatedFeatureFlags.c,{distinctId:distinctId||primaryDistinctId})]})},{key:src_types.j3.HISTORY,label:"History",content:(0,jsx_runtime.jsx)(ActivityLog.DA,{scope:src_types.jc.PERSON,id:person.id,caption:(0,jsx_runtime.jsx)(LemonBanner.V,{type:"info",children:"This page only shows changes made by users in the PostHog site. Automatic changes from the API aren't shown here."})})}]}),splitMergeModalShown&&person&&(0,jsx_runtime.jsx)(MergeSplitPerson,{person:person})]})}function OpenInAdminPanelButton(){let{person}=(0,index_esm.useValues)(personsLogic.T),disabledReason=person?.properties.email?void 0:"Person has no email";return(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>openInAdminPanel(person?.properties.email),disabledReason:disabledReason,children:"Open in Admin Panel"})}}}]);