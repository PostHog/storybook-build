"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[891],{"./node_modules/.pnpm/@ant-design+icons@4.7.0_react-dom@16.14.0_react@16.14.0/node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{Z:function(){return icons_PlayCircleOutlined}});var objectSpread2=__webpack_require__("./node_modules/.pnpm/@babel+runtime@7.22.10/node_modules/@babel/runtime/helpers/esm/objectSpread2.js"),react=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/index.js"),asn_PlayCircleOutlined={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}},{tag:"path",attrs:{d:"M719.4 499.1l-296.1-215A15.9 15.9 0 00398 297v430c0 13.1 14.8 20.5 25.3 12.9l296.1-215a15.9 15.9 0 000-25.8zm-257.6 134V390.9L628.5 512 461.8 633.1z"}}]},name:"play-circle",theme:"outlined"},AntdIcon=__webpack_require__("./node_modules/.pnpm/@ant-design+icons@4.7.0_react-dom@16.14.0_react@16.14.0/node_modules/@ant-design/icons/es/components/AntdIcon.js"),PlayCircleOutlined_PlayCircleOutlined=function PlayCircleOutlined(props,ref){return react.createElement(AntdIcon.Z,(0,objectSpread2.Z)((0,objectSpread2.Z)({},props),{},{ref:ref,icon:asn_PlayCircleOutlined}))};PlayCircleOutlined_PlayCircleOutlined.displayName="PlayCircleOutlined";var icons_PlayCircleOutlined=react.forwardRef(PlayCircleOutlined_PlayCircleOutlined)},"./frontend/src/lib/components/AnimatedCollapsible.tsx":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{r:function(){return AnimatedCollapsible}});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/index.js"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/jsx-runtime.js");function AnimatedCollapsible(_ref){let{collapsed:collapsed,children:children}=_ref;const collapsibleSectionRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),[height,setHeight]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)();return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{collapsed?setHeight(0):collapsibleSectionRef.current&&setHeight(collapsibleSectionRef.current?.getBoundingClientRect().height)}),[collapsed,children]),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__.jsx)("div",{className:"collapsible overflow-hidden",style:{height:height,transition:"height 0.3s ease-in-out"},children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__.jsx)("div",{ref:collapsibleSectionRef,children:children})})}try{AnimatedCollapsible.displayName="AnimatedCollapsible",AnimatedCollapsible.__docgenInfo={description:"",displayName:"AnimatedCollapsible",props:{collapsed:{defaultValue:null,description:"",name:"collapsed",required:!0,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/lib/components/AnimatedCollapsible.tsx#AnimatedCollapsible"]={docgenInfo:AnimatedCollapsible.__docgenInfo,name:"AnimatedCollapsible",path:"frontend/src/lib/components/AnimatedCollapsible.tsx#AnimatedCollapsible"})}catch(__react_docgen_typescript_loader_error){}},"./frontend/src/scenes/instance/AsyncMigrations/AsyncMigrations.tsx":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{AsyncMigrations:function(){return AsyncMigrations},scene:function(){return scene}});var react=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/index.js"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),es_progress=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/progress/index.js"),es_button=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/button/index.js"),space=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/space/index.js"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@16.14.0/node_modules/kea/lib/index.esm.js"),PlayCircleOutlined=__webpack_require__("./node_modules/.pnpm/@ant-design+icons@4.7.0_react-dom@16.14.0_react@16.14.0/node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts"),systemStatusLogic=__webpack_require__("./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts"),lemonToast=__webpack_require__("./frontend/src/lib/lemon-ui/lemonToast.tsx"),preflightLogic=__webpack_require__("./frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.3_kea@3.1.5/node_modules/kea-router/lib/index.js");let AsyncMigrationStatus=function(AsyncMigrationStatus){return AsyncMigrationStatus[AsyncMigrationStatus.NotStarted=0]="NotStarted",AsyncMigrationStatus[AsyncMigrationStatus.Running=1]="Running",AsyncMigrationStatus[AsyncMigrationStatus.CompletedSuccessfully=2]="CompletedSuccessfully",AsyncMigrationStatus[AsyncMigrationStatus.Errored=3]="Errored",AsyncMigrationStatus[AsyncMigrationStatus.RolledBack=4]="RolledBack",AsyncMigrationStatus[AsyncMigrationStatus.Starting=5]="Starting",AsyncMigrationStatus[AsyncMigrationStatus.FailedAtStartup=6]="FailedAtStartup",AsyncMigrationStatus}({}),AsyncMigrationsTab=function(AsyncMigrationsTab){return AsyncMigrationsTab.Management="management",AsyncMigrationsTab.FutureMigrations="future",AsyncMigrationsTab.Settings="settings",AsyncMigrationsTab}({});const migrationStatusNumberToMessage={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},asyncMigrationsLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","instance","AsyncMigrations","asyncMigrationsLogic"]),(0,index_esm.connect)({values:[preflightLogic.preflightLogic,["preflight"]]}),(0,index_esm.actions)({triggerMigration:migration=>({migration:migration}),resumeMigration:migration=>({migration:migration}),rollbackMigration:migration=>({migration:migration}),forceStopMigration:migration=>({migration:migration}),forceStopMigrationWithoutRollback:migration=>({migration:migration}),updateMigrationStatus:(migration,endpoint,message)=>({migration:migration,endpoint:endpoint,message:message}),setActiveTab:tab=>({tab:tab}),updateSetting:(settingKey,newValue)=>({settingKey:settingKey,newValue:newValue}),loadAsyncMigrationErrors:migrationId=>({migrationId:migrationId}),loadAsyncMigrationErrorsSuccess:(migrationId,errors)=>({migrationId:migrationId,errors:errors}),loadAsyncMigrationErrorsFailure:(migrationId,error)=>({migrationId:migrationId,error:error}),openAsyncMigrationsModal:(migration,endpoint,message)=>({migration:migration,endpoint:endpoint,message:message}),closeAsyncMigrationsModal:!0}),(0,index_esm.reducers)({activeTab:[AsyncMigrationsTab.Management,{setActiveTab:(_,_ref)=>{let{tab:tab}=_ref;return tab}}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:(state,_ref2)=>{let{migrationId:migrationId,errors:errors}=_ref2;return{...state,[migrationId]:errors}}}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:(state,_ref3)=>{let{migrationId:migrationId}=_ref3;return{...state,[migrationId]:!0}},loadAsyncMigrationErrorsSuccess:(state,_ref4)=>{let{migrationId:migrationId}=_ref4;return{...state,[migrationId]:!1}},loadAsyncMigrationErrorsFailure:(state,_ref5)=>{let{migrationId:migrationId}=_ref5;return{...state,[migrationId]:!1}}}],activeAsyncMigrationModal:[null,{openAsyncMigrationsModal:(_,payload)=>payload,closeAsyncMigrationsModal:()=>null,updateMigrationStatus:()=>null}]}),(0,lib.loaders)((()=>({asyncMigrations:[[],{loadAsyncMigrations:async()=>userLogic.userLogic.values.user?.is_staff?(await api.ZP.get("api/async_migrations")).results:[]}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:async()=>{if(!userLogic.userLogic.values.user?.is_staff)return[];return(await api.ZP.get("api/instance_settings")).results.filter((setting=>setting.key.includes("ASYNC_MIGRATIONS")))}}]}))),(0,index_esm.selectors)({isAnyMigrationRunning:[s=>[s.asyncMigrations],asyncMigrations=>asyncMigrations.some((migration=>[AsyncMigrationStatus.Running,AsyncMigrationStatus.Starting].includes(migration.status)))],actionableMigrations:[s=>[s.asyncMigrations],asyncMigrations=>asyncMigrations.filter((migration=>migration.is_available))],futureMigrations:[s=>[s.asyncMigrations],asyncMigrations=>asyncMigrations.filter((migration=>!migration.is_available))]}),(0,index_esm.listeners)((_ref6=>{let{actions:actions}=_ref6;return{triggerMigration:async _ref7=>{let{migration:migration}=_ref7;Object.keys(migration.parameter_definitions).length>0?actions.openAsyncMigrationsModal(migration,"trigger","Migration triggered successfully"):actions.updateMigrationStatus(migration,"trigger","Migration triggered successfully")},resumeMigration:async _ref8=>{let{migration:migration}=_ref8;Object.keys(migration.parameter_definitions).length>0?actions.openAsyncMigrationsModal(migration,"resume","Migration resume triggered successfully"):actions.updateMigrationStatus(migration,"resume","Migration resume triggered successfully")},rollbackMigration:async _ref9=>{let{migration:migration}=_ref9;actions.updateMigrationStatus(migration,"rollback","Migration rollback triggered successfully")},forceStopMigration:async _ref10=>{let{migration:migration}=_ref10;actions.updateMigrationStatus(migration,"force_stop","Force stop triggered successfully")},forceStopMigrationWithoutRollback:async _ref11=>{let{migration:migration}=_ref11;actions.updateMigrationStatus(migration,"force_stop_without_rollback","Force stop without rollback triggered successfully")},updateMigrationStatus:async _ref12=>{let{migration:migration,endpoint:endpoint,message:message}=_ref12;const res=await api.ZP.create(`/api/async_migrations/${migration.id}/${endpoint}`,{parameters:migration.parameters});res.success?(lemonToast.UJ.success(message),actions.loadAsyncMigrations()):lemonToast.UJ.error(res.error)},updateSetting:async _ref13=>{let{settingKey:settingKey,newValue:newValue}=_ref13;try{await api.ZP.update(`/api/instance_settings/${settingKey}`,{value:newValue}),lemonToast.UJ.success(`Instance setting ${settingKey} updated`),actions.loadAsyncMigrationSettings(),actions.loadAsyncMigrations(),systemStatusLogic.Q.actions.loadSystemStatus()}catch{lemonToast.UJ.error("Failed to trigger migration")}},loadAsyncMigrationErrors:async _ref14=>{let{migrationId:migrationId}=_ref14;try{const errorsForMigration=await api.ZP.get(`api/async_migrations/${migrationId}/errors`);actions.loadAsyncMigrationErrorsSuccess(migrationId,errorsForMigration)}catch(error){actions.loadAsyncMigrationErrorsFailure(migrationId,error)}}}})),(0,index_esm.events)((_ref15=>{let{actions:actions}=_ref15;return{afterMount:()=>{actions.loadAsyncMigrations(),actions.loadAsyncMigrationSettings()}}})),(0,kea_router_lib.actionToUrl)((_ref16=>{let{values:values}=_ref16;return{setActiveTab:()=>"/instance/async_migrations"+(values.activeTab===AsyncMigrationsTab.Management?"":"/"+values.activeTab)}})),(0,kea_router_lib.urlToAction)((_ref17=>{let{actions:actions,values:values}=_ref17;return{"/instance/async_migrations(/:tab)":_ref18=>{let{tab:tab}=_ref18;tab&&tab!==values.activeTab&&tab!==AsyncMigrationsTab.Management&&actions.setActiveTab(tab)}}}))]);var Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip.tsx"),Spinner=__webpack_require__("./frontend/src/lib/lemon-ui/Spinner/Spinner.tsx"),row=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/row/index.js"),col=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/col/index.js"),input=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/input/index.js"),divider=__webpack_require__("./node_modules/.pnpm/antd@4.17.1_react-dom@16.14.0_react@16.14.0/node_modules/antd/es/divider/index.js"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@16.14.0/node_modules/react/jsx-runtime.js");function SettingUpdateField(_ref){let{setting:setting}=_ref;const{updateSetting:updateSetting}=(0,index_esm.useActions)(asyncMigrationsLogic),[inputValue,setInputValue]=(0,react.useState)(String(setting.value));return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{children:setting.key}),(0,jsx_runtime.jsx)("p",{children:setting.description}),(0,jsx_runtime.jsxs)(row.Z,{gutter:[8,8],children:[(0,jsx_runtime.jsx)(col.Z,{span:8,children:(0,jsx_runtime.jsx)(input.Z,{value:inputValue,onChange:e=>setInputValue(e.target.value)})}),(0,jsx_runtime.jsx)(col.Z,{span:16,children:(0,jsx_runtime.jsx)(es_button.Z,{disabled:String(setting.value)===inputValue,type:"primary",onClick:()=>updateSetting(setting.key,inputValue),children:"Update"})})]}),(0,jsx_runtime.jsx)(divider.Z,{})]},setting.key)}try{SettingUpdateField.displayName="SettingUpdateField",SettingUpdateField.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"InstanceSetting"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:SettingUpdateField.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(__react_docgen_typescript_loader_error){}var LemonTable=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTable/index.ts"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts");function AsyncMigrationDetails(_ref){let{asyncMigration:asyncMigration}=_ref;const{asyncMigrationErrorsLoading:asyncMigrationErrorsLoading,asyncMigrationErrors:asyncMigrationErrors}=(0,index_esm.useValues)(asyncMigrationsLogic),{loadAsyncMigrationErrors:loadAsyncMigrationErrors}=(0,index_esm.useActions)(asyncMigrationsLogic),columns=[{title:"Error",dataIndex:"description"},{title:(0,jsx_runtime.jsx)(LemonButton.Jp,{icon:asyncMigrationErrorsLoading[asyncMigration.id]?(0,jsx_runtime.jsx)(Spinner.$,{}):(0,jsx_runtime.jsx)(icons.tr8,{}),onClick:()=>loadAsyncMigrationErrors(asyncMigration.id),type:"secondary",size:"small",children:"Refresh errors"}),render:function Render(_,asyncMigrationError){return(0,jsx_runtime.jsx)("div",{children:(0,utils.bo)(asyncMigrationError.created_at)})}}];return(0,jsx_runtime.jsx)(LemonTable.g,{columns:columns,dataSource:asyncMigrationErrors[asyncMigration.id],loading:asyncMigrationErrorsLoading[asyncMigration.id],embedded:!0})}try{AsyncMigrationDetails.displayName="AsyncMigrationDetails",AsyncMigrationDetails.__docgenInfo={description:"",displayName:"AsyncMigrationDetails",props:{asyncMigration:{defaultValue:null,description:"",name:"asyncMigration",required:!0,type:{name:"AsyncMigration"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"]={docgenInfo:AsyncMigrationDetails.__docgenInfo,name:"AsyncMigrationDetails",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"})}catch(__react_docgen_typescript_loader_error){}var More=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/More.tsx"),LemonTag=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTag/LemonTag.tsx"),kea_forms_lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.0.3_kea@3.1.5/node_modules/kea-forms/lib/index.js");const asyncMigrationParameterFormLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","instance","AsyncMigrations","asyncMigrationParameterFormLogic"]),(0,index_esm.props)({}),(0,index_esm.key)((props=>props.migration.id)),(0,kea_forms_lib.forms)((_ref=>{let{props:props}=_ref;return{parameters:{defaults:defaultParameters(props),submit:async parameters=>{asyncMigrationsLogic.actions.updateMigrationStatus({...props.migration,parameters:parameters},props.endpoint,props.message)}}}}))]);function defaultParameters(props){const result={};return Object.keys(props.migration.parameter_definitions).forEach((key=>{props.migration.parameters[key]?result[key]=props.migration.parameters[key]:result[key]=props.migration.parameter_definitions[key][0]})),result}var LemonInput=__webpack_require__("./frontend/src/lib/lemon-ui/LemonInput/LemonInput.tsx"),AnimatedCollapsible=__webpack_require__("./frontend/src/lib/components/AnimatedCollapsible.tsx"),LemonModal=__webpack_require__("./frontend/src/lib/lemon-ui/LemonModal/index.ts");function AsyncMigrationParametersModal(props){const{closeAsyncMigrationsModal:closeAsyncMigrationsModal}=(0,index_esm.useActions)(asyncMigrationsLogic),[collapsed,setCollapsed]=(0,react.useState)(!0);return(0,jsx_runtime.jsx)(LemonModal.f,{title:"",onClose:closeAsyncMigrationsModal,isOpen:!0,simple:!0,children:(0,jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:asyncMigrationParameterFormLogic,props:props,formKey:"parameters",enableFormOnSubmit:!0,id:"async-migration-parameters-form",className:"LemonModal__layout",children:[(0,jsx_runtime.jsx)(LemonModal.f.Header,{children:(0,jsx_runtime.jsx)("h3",{children:"Advanced migration configuration"})}),(0,jsx_runtime.jsxs)(LemonModal.f.Content,{children:[(0,jsx_runtime.jsxs)("p",{children:["This async migration allows tuning parameters used in the async migration.",collapsed&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("a",{onClick:()=>{setCollapsed(!collapsed)},children:"Click here to show advanced configuration."})]})]}),(0,jsx_runtime.jsx)(AnimatedCollapsible.r,{collapsed:collapsed,children:Object.entries(props.migration.parameter_definitions).map((_ref=>{let[parameterName,[defaultValue,parameterDescription]]=_ref;return(0,jsx_runtime.jsx)(kea_forms_lib.Field,{name:parameterName,label:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:parameterDescription}),children:(0,jsx_runtime.jsx)(LemonInput.D,{type:"number"==typeof defaultValue?"number":"text"})},parameterName)}))})]}),(0,jsx_runtime.jsxs)(LemonModal.f.Footer,{children:[(0,jsx_runtime.jsx)(LemonButton.Jp,{form:"async-migration-parameters-form",type:"secondary","data-attr":"async-migration-parameters-cancel",className:"mr-2",onClick:closeAsyncMigrationsModal,children:"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.Jp,{form:"async-migration-parameters-form",htmlType:"submit",type:"primary","data-attr":"async-migration-parameters-submit",children:"Run migration"})]})]})})}try{AsyncMigrationParametersModal.displayName="AsyncMigrationParametersModal",AsyncMigrationParametersModal.__docgenInfo={description:"",displayName:"AsyncMigrationParametersModal",props:{migration:{defaultValue:null,description:"",name:"migration",required:!0,type:{name:"AsyncMigration"}},endpoint:{defaultValue:null,description:"",name:"endpoint",required:!0,type:{name:"string"}},message:{defaultValue:null,description:"",name:"message",required:!0,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationParametersModal.tsx#AsyncMigrationParametersModal"]={docgenInfo:AsyncMigrationParametersModal.__docgenInfo,name:"AsyncMigrationParametersModal",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationParametersModal.tsx#AsyncMigrationParametersModal"})}catch(__react_docgen_typescript_loader_error){}var LemonTabs=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTabs/index.ts");const scene={component:AsyncMigrations,logic:asyncMigrationsLogic},STATUS_RELOAD_INTERVAL_MS=3e3;function AsyncMigrations(){const{user:user}=(0,index_esm.useValues)(userLogic.userLogic),{asyncMigrationsLoading:asyncMigrationsLoading,activeTab:activeTab,asyncMigrationSettings:asyncMigrationSettings,isAnyMigrationRunning:isAnyMigrationRunning,activeAsyncMigrationModal:activeAsyncMigrationModal,actionableMigrations:actionableMigrations,futureMigrations:futureMigrations}=(0,index_esm.useValues)(asyncMigrationsLogic),{triggerMigration:triggerMigration,resumeMigration:resumeMigration,rollbackMigration:rollbackMigration,forceStopMigration:forceStopMigration,forceStopMigrationWithoutRollback:forceStopMigrationWithoutRollback,loadAsyncMigrations:loadAsyncMigrations,loadAsyncMigrationErrors:loadAsyncMigrationErrors,setActiveTab:setActiveTab}=(0,index_esm.useActions)(asyncMigrationsLogic);(0,react.useEffect)((()=>{if(isAnyMigrationRunning){const interval=setInterval((()=>loadAsyncMigrations()),STATUS_RELOAD_INTERVAL_MS);return()=>clearInterval(interval)}}),[isAnyMigrationRunning]);const nameColumn={title:"Migration",render:function Render(_,asyncMigration){const link="https://github.com/PostHog/posthog/blob/master/posthog/async_migrations/migrations/"+asyncMigration.name+".py";return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"row-name",children:(0,jsx_runtime.jsx)("a",{href:link,children:asyncMigration.name})}),(0,jsx_runtime.jsx)("div",{className:"row-description",children:asyncMigration.description})]})}},progressColumn={title:"Progress",render:function Render(_,asyncMigration){const progress=asyncMigration.progress;return(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(es_progress.Z,{percent:progress})})}},statusColumn={title:"Status",render:function Render(_,asyncMigration){const status=asyncMigration.status,type=status===AsyncMigrationStatus.Running?"success":status===AsyncMigrationStatus.Errored||status===AsyncMigrationStatus.FailedAtStartup?"danger":status===AsyncMigrationStatus.Starting||status===AsyncMigrationStatus.RolledBack?"warning":"default";return(0,jsx_runtime.jsx)(LemonTag.o,{type:type,className:"uppercase",children:migrationStatusNumberToMessage[status]})}},lastOpColumn={title:"Last operation index",render:function Render(_,asyncMigration){return(0,jsx_runtime.jsx)("div",{children:asyncMigration.current_operation_index})}},queryIdColumn={title:"Last query ID",render:function Render(_,asyncMigration){return(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("small",{children:asyncMigration.current_query_id})})}},startedAtColumn={title:"Started at",render:function Render(_,asyncMigration){const startedAt=asyncMigration.started_at;return(0,jsx_runtime.jsx)("div",{children:(0,utils.bo)(startedAt)})}},finishedAtColumn={title:"Finished at",render:function Render(_,asyncMigration){const finishedAt=asyncMigration.finished_at;return(0,jsx_runtime.jsx)("div",{children:(0,utils.bo)(finishedAt)})}},ActionsColumn={title:"",render:function Render(_,asyncMigration){const status=asyncMigration.status;return(0,jsx_runtime.jsx)("div",{children:status===AsyncMigrationStatus.NotStarted||status===AsyncMigrationStatus.FailedAtStartup?(0,jsx_runtime.jsx)(Tooltip.u,{title:"Start",children:(0,jsx_runtime.jsx)(es_button.Z,{type:"link",icon:(0,jsx_runtime.jsx)(PlayCircleOutlined.Z,{}),onClick:()=>triggerMigration(asyncMigration),children:"Run"})}):status===AsyncMigrationStatus.Starting||status===AsyncMigrationStatus.Running?(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.Jp,{status:"stealth",onClick:()=>forceStopMigration(asyncMigration),fullWidth:!0,children:"Stop and rollback"}),(0,jsx_runtime.jsx)(LemonButton.Jp,{status:"stealth",onClick:()=>forceStopMigrationWithoutRollback(asyncMigration),fullWidth:!0,children:"Stop"})]})}):status===AsyncMigrationStatus.CompletedSuccessfully?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{}):status===AsyncMigrationStatus.Errored?(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.Jp,{status:"stealth",onClick:()=>resumeMigration(asyncMigration),fullWidth:!0,children:"Resume"}),(0,jsx_runtime.jsx)(LemonButton.Jp,{status:"stealth",onClick:()=>rollbackMigration(asyncMigration),fullWidth:!0,children:"Rollback"})]})}):status===AsyncMigrationStatus.RolledBack?(0,jsx_runtime.jsx)(Tooltip.u,{title:"Restart",children:(0,jsx_runtime.jsx)(LemonButton.Jp,{status:"stealth",icon:(0,jsx_runtime.jsx)(icons.ysb,{}),onClick:()=>triggerMigration(asyncMigration),fullWidth:!0})}):null})}},minVersionColumn={title:"Minimum PostHog version",render:function Render(_,asyncMigration){return(0,jsx_runtime.jsx)("div",{children:asyncMigration.posthog_min_version})}},maxVersionColumn={title:"Maximum PostHog version",render:function Render(_,asyncMigration){return(0,jsx_runtime.jsx)("div",{children:asyncMigration.posthog_max_version})}},columns={};columns[AsyncMigrationsTab.FutureMigrations]=[nameColumn,statusColumn,minVersionColumn,maxVersionColumn],columns[AsyncMigrationsTab.Management]=[nameColumn,progressColumn,statusColumn,lastOpColumn,queryIdColumn,startedAtColumn,finishedAtColumn,ActionsColumn];const migrations={};migrations[AsyncMigrationsTab.FutureMigrations]=futureMigrations,migrations[AsyncMigrationsTab.Management]=actionableMigrations;const rowExpansion={expandedRowRender:function renderExpand(asyncMigration){return asyncMigration&&(0,jsx_runtime.jsx)(AsyncMigrationDetails,{asyncMigration:asyncMigration})},rowExpandable:asyncMigration=>asyncMigration.error_count>0,onRowExpand:function getErrors(asyncMigration){loadAsyncMigrationErrors(asyncMigration.id)}},tabs=[{key:AsyncMigrationsTab.Management,label:`Management (${actionableMigrations.length})`},{key:AsyncMigrationsTab.Settings,label:"Settings"}];return futureMigrations.length>0&&tabs.splice(1,0,{key:AsyncMigrationsTab.FutureMigrations,label:`Future Migrations (${futureMigrations.length})`}),(0,jsx_runtime.jsx)("div",{children:user?.is_staff?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{title:"Async Migrations",caption:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"Manage async migrations in your instance."}),(0,jsx_runtime.jsxs)("p",{children:["Read about async migrations on our"," ",(0,jsx_runtime.jsx)("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations/overview",children:"dedicated docs page"}),"."]})]})}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:activeTab,onChange:setActiveTab,tabs:tabs}),[AsyncMigrationsTab.Management,AsyncMigrationsTab.FutureMigrations].includes(activeTab)?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"mb-4 float-right",children:(0,jsx_runtime.jsx)(LemonButton.Jp,{icon:asyncMigrationsLoading?(0,jsx_runtime.jsx)(Spinner.$,{}):(0,jsx_runtime.jsx)(icons.tr8,{}),onClick:loadAsyncMigrations,type:"secondary",size:"small",children:"Refresh"})}),(0,jsx_runtime.jsx)(space.Z,{}),(0,jsx_runtime.jsx)(LemonTable.g,{pagination:{pageSize:10},loading:asyncMigrationsLoading,columns:columns[activeTab],dataSource:migrations[activeTab],expandable:rowExpansion}),activeAsyncMigrationModal?(0,jsx_runtime.jsx)(AsyncMigrationParametersModal,{...activeAsyncMigrationModal}):null]}):activeTab===AsyncMigrationsTab.Settings?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),asyncMigrationSettings.map((setting=>(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(SettingUpdateField,{setting:setting})},setting.key)))]}):null]}):(0,jsx_runtime.jsx)(PageHeader.m,{title:"Async Migrations",caption:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"Only users with staff access can manage async migrations. Please contact your instance admin."}),(0,jsx_runtime.jsxs)("p",{children:["If you're an admin and don't have access, set ",(0,jsx_runtime.jsx)("code",{children:"is_staff=true"})," for your user on the PostgreSQL ",(0,jsx_runtime.jsx)("code",{children:"posthog_user"})," table."]})]})})})}},"./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{D:function(){return ConfigMode},Q:function(){return systemStatusLogic}});var lib_api__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./frontend/src/lib/api.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@16.14.0/node_modules/kea/lib/index.esm.js"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./frontend/src/scenes/userLogic.ts"),scenes_PreflightCheck_preflightLogic__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),lib_utils__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./frontend/src/lib/utils.tsx"),lib_lemon_ui_lemonToast__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/lemon-ui/lemonToast.tsx"),lib_utils_eventUsageLogic__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/lib/utils/eventUsageLogic.ts");let ConfigMode=function(ConfigMode){return ConfigMode.View="view",ConfigMode.Edit="edit",ConfigMode.Saving="saving",ConfigMode}({});const EDITABLE_INSTANCE_SETTINGS=["RECORDINGS_TTL_WEEKS","RECORDINGS_PERFORMANCE_EVENTS_TTL_WEEKS","EMAIL_ENABLED","EMAIL_HOST","EMAIL_PORT","EMAIL_HOST_USER","EMAIL_HOST_PASSWORD","EMAIL_USE_TLS","EMAIL_USE_SSL","EMAIL_DEFAULT_FROM","EMAIL_REPLY_TO","AGGREGATE_BY_DISTINCT_IDS_TEAMS","PERSON_ON_EVENTS_ENABLED","GROUPS_ON_EVENTS_ENABLED","STRICT_CACHING_TEAMS","SLACK_APP_CLIENT_ID","SLACK_APP_CLIENT_SECRET","SLACK_APP_SIGNING_SECRET","PARALLEL_DASHBOARD_ITEM_CACHE","RATE_LIMIT_ENABLED","RATE_LIMITING_ALLOW_LIST_TEAMS","SENTRY_AUTH_TOKEN","SENTRY_ORGANIZATION","HEATMAP_SAMPLE_N"],systemStatusLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)({path:["scenes","instance","SystemStatus","systemStatusLogic"],actions:{setTab:tab=>({tab:tab}),setOpenSections:sections=>({sections:sections}),setInstanceConfigMode:mode=>({mode:mode}),updateInstanceConfigValue:(key,value)=>({key:key,value:value}),clearInstanceConfigEditing:!0,saveInstanceConfig:!0,setUpdatedInstanceConfigCount:count=>({count:count}),increaseUpdatedInstanceConfigCount:!0},loaders:()=>({systemStatus:[null,{loadSystemStatus:async()=>{var _await$api$get$result;return(0,lib_utils__WEBPACK_IMPORTED_MODULE_4__.Pc)()?scenes_PreflightCheck_preflightLogic__WEBPACK_IMPORTED_MODULE_3__.preflightLogic.values.preflight?.cloud&&!scenes_userLogic__WEBPACK_IMPORTED_MODULE_2__.userLogic.values.user?.is_staff?null:null!==(_await$api$get$result=(await lib_api__WEBPACK_IMPORTED_MODULE_0__.ZP.get("api/instance_status")).results)&&void 0!==_await$api$get$result?_await$api$get$result:null:null}}],instanceSettings:[[],{loadInstanceSettings:async()=>{var _await$api$get$result2;return null!==(_await$api$get$result2=(await lib_api__WEBPACK_IMPORTED_MODULE_0__.ZP.get("api/instance_settings")).results)&&void 0!==_await$api$get$result2?_await$api$get$result2:[]}}],queries:[null,{loadQueries:async()=>(await lib_api__WEBPACK_IMPORTED_MODULE_0__.ZP.get("api/instance_status/queries")).results}]}),reducers:{tab:["overview",{setTab:(_,_ref)=>{let{tab:tab}=_ref;return tab}}],error:[null,{loadSystemStatusFailure:(_,_ref2)=>{let{error:error}=_ref2;return error}}],openSections:[["0"],{persist:!0},{setOpenSections:(_,_ref3)=>{let{sections:sections}=_ref3;return sections}}],instanceConfigMode:[ConfigMode.View,{setInstanceConfigMode:(_,_ref4)=>{let{mode:mode}=_ref4;return mode}}],instanceConfigEditingState:[{},{updateInstanceConfigValue:(s,_ref5)=>{let{key:key,value:value}=_ref5;if(void 0!==value)return{...s,[key]:value};const newState={...s};return delete newState[key],newState},clearInstanceConfigEditing:()=>({})}],updatedInstanceConfigCount:[null,{setUpdatedInstanceConfigCount:(_,_ref6)=>{let{count:count}=_ref6;return count},loadInstanceSettings:()=>null,increaseUpdatedInstanceConfigCount:state=>(null!=state?state:0)+1}]},selectors:()=>({overview:[s=>[s.systemStatus],status=>status?status.overview:[]],editableInstanceSettings:[s=>[s.instanceSettings],instanceSettings=>instanceSettings.filter((item=>item.editable&&EDITABLE_INSTANCE_SETTINGS.includes(item.key)))]}),listeners:_ref7=>{let{actions:actions,values:values}=_ref7;return{setTab:_ref8=>{let{tab:tab}=_ref8;"metrics"===tab&&actions.loadQueries(),actions.setInstanceConfigMode(ConfigMode.View)},updateInstanceConfigValue:_ref9=>{let{key:key,value:value}=_ref9;const previousValue=values.editableInstanceSettings.find((item=>item.key===key))?.value;value&&previousValue==value&&actions.updateInstanceConfigValue(key,void 0)},saveInstanceConfig:async(_,breakpoint)=>{actions.setUpdatedInstanceConfigCount(0),Object.entries(values.instanceConfigEditingState).map((async _ref10=>{let[key,value]=_ref10;try{await lib_api__WEBPACK_IMPORTED_MODULE_0__.ZP.update(`api/instance_settings/${key}`,{value:value}),lib_utils_eventUsageLogic__WEBPACK_IMPORTED_MODULE_6__.vx.actions.reportInstanceSettingChange(key,value),actions.increaseUpdatedInstanceConfigCount()}catch{lib_lemon_ui_lemonToast__WEBPACK_IMPORTED_MODULE_5__.UJ.error("There was an error updating instance settings â€“ please try again"),await breakpoint(1e3),actions.loadInstanceSettings()}})),await breakpoint(1e3),values.updatedInstanceConfigCount===Object.keys(values.instanceConfigEditingState).length&&(actions.loadInstanceSettings(),actions.clearInstanceConfigEditing(),actions.setInstanceConfigMode(ConfigMode.View),lib_lemon_ui_lemonToast__WEBPACK_IMPORTED_MODULE_5__.UJ.success("Instance settings updated"))}}},events:_ref11=>{let{actions:actions}=_ref11;return{afterMount:()=>{actions.loadSystemStatus()}}},actionToUrl:_ref12=>{let{values:values}=_ref12;return{setTab:()=>"/instance/"+("overview"===values.tab?"status":values.tab)}},urlToAction:_ref13=>{let{actions:actions,values:values}=_ref13;return{"/instance(/:tab)":_ref14=>{let{tab:tab}=_ref14;const currentTab=tab&&["metrics","settings","staff_users","kafka_inspector"].includes(tab)?tab:"overview";currentTab!==values.tab&&actions.setTab(currentTab)}}}})}}]);