"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[59116,21172],{"../../products/llm_observability/frontend/LLMObservabilityScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{LLMObservabilityScene:()=>LLMObservabilityScene,scene:()=>scene});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.11.6_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),QueryCard=__webpack_require__("../../frontend/src/lib/components/Cards/InsightCard/QueryCard.tsx"),DateFilter=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),dist_posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.12.1_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),preflightLogic=__webpack_require__("../../frontend/src/scenes/PreflightCheck/preflightLogic.tsx"),supportLogic=__webpack_require__("../../frontend/src/lib/components/Support/supportLogic.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let FeedbackNotice=_ref=>{let{text}=_ref,{openSupportForm}=(0,index_esm.useActions)(supportLogic.Pw),{preflight}=(0,index_esm.useValues)(preflightLogic.preflightLogic),showSupportOptions=preflight?.cloud;return(0,jsx_runtime.jsx)(src.Vp,{type:"info",className:"my-4",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center flex-wrap gap-2 justify-between",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1 min-w-full sm:min-w-0",children:text}),showSupportOptions?(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",icon:(0,jsx_runtime.jsx)(dist_posthog_icons_es.IconBug,{}),onClick:()=>openSupportForm({kind:"bug",isEmailFormOpen:!0}),children:"Report a bug"}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",icon:(0,jsx_runtime.jsx)(icons.Rz,{}),onClick:()=>openSupportForm({kind:"feedback",isEmailFormOpen:!0}),children:"Give feedback"})]}):null]})})};var PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),PropertyFilters=__webpack_require__("../../frontend/src/lib/components/PropertyFilters/PropertyFilters.tsx"),TestAccountFiltersSwitch=__webpack_require__("../../frontend/src/lib/components/TestAccountFiltersSwitch.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),dataNodeCollectionLogic=__webpack_require__("../../frontend/src/queries/nodes/DataNode/dataNodeCollectionLogic.ts"),DataTable=__webpack_require__("../../frontend/src/queries/nodes/DataTable/DataTable.tsx"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),utils=__webpack_require__("../../frontend/src/queries/utils.ts"),llmObservabilityLogic=__webpack_require__("../../products/llm_observability/frontend/llmObservabilityLogic.tsx"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/index.ts");let LastRefreshText=()=>{let{newestRefreshed}=(0,index_esm.useValues)(llmObservabilityLogic.K);return newestRefreshed?(0,jsx_runtime.jsxs)("span",{children:["Last updated ",(0,dayjs.Bv)(newestRefreshed).fromNow()]}):(0,jsx_runtime.jsx)("span",{children:"Refresh"})};function LLMObservabilityReloadAction(){let{isRefreshing}=(0,index_esm.useValues)(llmObservabilityLogic.K),{refreshAllDashboardItems}=(0,index_esm.useActions)(llmObservabilityLogic.K);return(0,jsx_runtime.jsx)("div",{className:"relative",children:(0,jsx_runtime.jsx)(src.Jp,{onClick:refreshAllDashboardItems,type:"secondary",icon:isRefreshing?(0,jsx_runtime.jsx)(Spinner.$,{textColored:!0}):(0,jsx_runtime.jsx)(icons.tr,{}),size:"small",disabledReason:isRefreshing?"Refreshing...":void 0,children:(0,jsx_runtime.jsx)("span",{className:"dashboard-items-action-refresh-text",children:isRefreshing?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Refreshing..."}):(0,jsx_runtime.jsx)(LastRefreshText,{})})})})}var TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),Link=__webpack_require__("../../frontend/src/lib/lemon-ui/Link/index.ts"),frontend_utils=__webpack_require__("../../products/llm_observability/frontend/utils.ts");function LLMObservabilityTraces(){let{setDates,setShouldFilterTestAccounts,setPropertyFilters,setTracesQuery}=(0,index_esm.useActions)(llmObservabilityLogic.K),{tracesQuery}=(0,index_esm.useValues)(llmObservabilityLogic.K);return(0,jsx_runtime.jsx)(DataTable.w,{query:tracesQuery,setQuery:query=>{if(!(0,utils.zO)(query.source))throw Error("Invalid query");setDates(query.source.dateRange?.date_from||null,query.source.dateRange?.date_to||null),setShouldFilterTestAccounts(query.source.filterTestAccounts||!1),setPropertyFilters(query.source.properties||[]),setTracesQuery(query)},context:{emptyStateHeading:"There were no traces in this period",emptyStateDetail:"Try changing the date range or filters.",columns:{id:{title:"ID",render:IDColumn},timestamp:{title:"Time",render:TimestampColumn},traceName:{title:"Trace Name",render:TraceNameColumn},person:{title:"Person"},totalLatency:{title:"Latency",render:LatencyColumn},usage:{title:"Token Usage",render:UsageColumn},totalCost:{title:"Total Cost",render:CostColumn}}},uniqueKey:"llm-observability-traces"})}let IDColumn=_ref=>{let{record}=_ref;return(0,jsx_runtime.jsx)("strong",{children:(0,jsx_runtime.jsxs)(Link.r,{className:"ph-no-capture",to:urls.j.llmObservabilityTrace(record.id,{timestamp:(0,frontend_utils.sl)(record.createdAt)}),children:[record.id.slice(0,4),"...",record.id.slice(-4)]})})},TraceNameColumn=_ref2=>{let{record}=_ref2;return(0,jsx_runtime.jsx)("strong",{children:(0,jsx_runtime.jsx)(Link.r,{className:"ph-no-capture",to:urls.j.llmObservabilityTrace(record.id,{timestamp:(0,frontend_utils.sl)(record.createdAt)}),children:record.traceName||"–"})})},TimestampColumn=_ref3=>{let{record}=_ref3;return(0,jsx_runtime.jsx)(TZLabel.w,{time:record.createdAt})};TimestampColumn.displayName="TimestampColumn";let LatencyColumn=_ref4=>{let{record}=_ref4;return"number"==typeof record.totalLatency?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[record.totalLatency,"s"]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"–"})};LatencyColumn.displayName="LatencyColumn";let UsageColumn=_ref5=>{let{record}=_ref5,usage=(0,frontend_utils.Pz)(record);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:usage||"–"})};UsageColumn.displayName="UsageColumn";let CostColumn=_ref6=>{let{record}=_ref6;return"number"==typeof record.totalCost?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,frontend_utils.K7)(record.totalCost)}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"–"})};CostColumn.displayName="CostColumn";var LLMObservabilityUsers=__webpack_require__("../../products/llm_observability/frontend/LLMObservabilityUsers.tsx");let scene={component:LLMObservabilityScene},Filters=()=>{let{dashboardDateFilter,dateFilter,shouldFilterTestAccounts,generationsQuery,propertyFilters,activeTab}=(0,index_esm.useValues)(llmObservabilityLogic.K),{setDates,setShouldFilterTestAccounts,setPropertyFilters}=(0,index_esm.useActions)(llmObservabilityLogic.K),dateFrom="dashboard"===activeTab?dashboardDateFilter.dateFrom:dateFilter.dateFrom,dateTo="dashboard"===activeTab?dashboardDateFilter.dateTo:dateFilter.dateTo;return(0,jsx_runtime.jsxs)("div",{className:"flex gap-x-4 gap-y-2 items-center flex-wrap py-4 -mt-4 mb-4 border-b",children:[(0,jsx_runtime.jsx)(DateFilter.f,{dateFrom:dateFrom,dateTo:dateTo,onChange:setDates}),(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:propertyFilters,taxonomicGroupTypes:generationsQuery.showPropertyFilter,onChange:setPropertyFilters,pageKey:"llm-observability"}),(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:shouldFilterTestAccounts,onChange:setShouldFilterTestAccounts}),(0,jsx_runtime.jsx)(LLMObservabilityReloadAction,{})]})},Tiles=()=>{let{tiles}=(0,index_esm.useValues)(llmObservabilityLogic.K);return(0,jsx_runtime.jsx)("div",{className:"mt-2 grid grid-cols-1 @xl/dashboard:grid-cols-2 @4xl/dashboard:grid-cols-6 gap-4",children:tiles.map((_ref,i)=>{let{title,description,query,context}=_ref;return(0,jsx_runtime.jsx)(QueryCard.w,{title:title,description:description,query:{kind:schema_general.OH.InsightVizNode,source:query},context:context,className:(0,clsx_m.default)("h-96",i<3||i>=5?"@4xl/dashboard:col-span-2":"@4xl/dashboard:col-span-3")},i)})})},IngestionStatusCheck=()=>(0,jsx_runtime.jsxs)(src.Vp,{type:"warning",className:"mt-2",children:[(0,jsx_runtime.jsx)("p",{children:(0,jsx_runtime.jsx)("strong",{children:"No LLM generation events have been detected!"})}),(0,jsx_runtime.jsxs)("p",{children:["To use the LLM Observability product, please"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/ai-engineering/observability",children:"instrument your LLM calls with the PostHog SDK"})," ","(otherwise it'll be a little empty!)"]})]});function LLMObservabilityDashboard(){return(0,jsx_runtime.jsxs)("div",{className:"@container/dashboard",children:[(0,jsx_runtime.jsx)(Filters,{}),(0,jsx_runtime.jsx)(Tiles,{})]})}function LLMObservabilityGenerations(){let{setDates,setShouldFilterTestAccounts,setPropertyFilters,setGenerationsQuery}=(0,index_esm.useActions)(llmObservabilityLogic.K),{generationsQuery}=(0,index_esm.useValues)(llmObservabilityLogic.K);return(0,jsx_runtime.jsx)(DataTable.w,{query:generationsQuery,setQuery:query=>{if(!(0,utils.rz)(query.source))throw Error("Invalid query");setDates(query.source.after||null,query.source.before||null),setShouldFilterTestAccounts(query.source.filterTestAccounts||!1),setPropertyFilters(query.source.properties||[]),setGenerationsQuery(query)},context:{emptyStateHeading:"There were no generations in this period",emptyStateDetail:"Try changing the date range or filters.",columns:{uuid:{title:"ID",render:_ref2=>{let{record,value}=_ref2,traceId=record[2];if(!value)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let visualValue=value.slice(0,4)+"..."+value.slice(-4);return traceId?(0,jsx_runtime.jsx)("strong",{children:(0,jsx_runtime.jsx)(src.rU,{to:`/llm-observability/traces/${traceId}?event=${value}`,children:visualValue})}):(0,jsx_runtime.jsx)("strong",{children:visualValue})}},"properties.$ai_trace_id":{title:"Trace ID",render:_ref3=>{let{value}=_ref3;if(!value)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let visualValue=value.slice(0,4)+"..."+value.slice(-4);return(0,jsx_runtime.jsx)(src.rU,{to:`/llm-observability/traces/${value}`,children:visualValue})}}}},uniqueKey:"llm-observability-generations"})}function LLMObservabilityNoEvents(){return(0,jsx_runtime.jsx)("div",{className:"w-full flex flex-col items-center justify-center",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col items-center justify-center max-w-md w-full",children:[(0,jsx_runtime.jsx)(posthog_icons_es.fO3,{className:"text-5xl mb-2 text-muted-alt"}),(0,jsx_runtime.jsx)("h2",{className:"text-xl leading-tight",children:"We haven't detected any LLM generations yet"}),(0,jsx_runtime.jsxs)("p",{className:"text-sm text-center text-balance",children:["To use the LLM Observability product, please"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/ai-engineering/observability",children:"instrument your LLM calls with the PostHog SDK"})," "]})]})})}function LLMObservabilityScene(){let{activeTab,hasSentAiGenerationEvent,hasSentAiGenerationEventLoading}=(0,index_esm.useValues)(llmObservabilityLogic.K),{searchParams}=(0,index_esm.useValues)(lib.router);return(0,jsx_runtime.jsxs)(index_esm.BindLogic,{logic:dataNodeCollectionLogic.y,props:{key:llmObservabilityLogic.E},children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)("div",{className:"flex gap-2",children:(0,jsx_runtime.jsx)(src.Jp,{to:"https://posthog.com/docs/ai-engineering/observability",type:"secondary",targetBlank:!0,children:"Documentation"})})}),hasSentAiGenerationEventLoading?null:hasSentAiGenerationEvent?(0,jsx_runtime.jsx)(FeedbackNotice,{text:"LLM observability is currently in beta. Thanks for taking part! We'd love to hear what you think."}):(0,jsx_runtime.jsx)(IngestionStatusCheck,{}),(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,tabs:[{key:"dashboard",label:"Dashboard",content:(0,jsx_runtime.jsx)(LLMObservabilityDashboard,{}),link:(0,lib.combineUrl)(urls.j.llmObservabilityDashboard(),searchParams).url},{key:"traces",label:"Traces",content:hasSentAiGenerationEvent?(0,jsx_runtime.jsx)(LLMObservabilityTraces,{}):(0,jsx_runtime.jsx)(LLMObservabilityNoEvents,{}),link:(0,lib.combineUrl)(urls.j.llmObservabilityTraces(),searchParams).url},{key:"generations",label:"Generations",content:hasSentAiGenerationEvent?(0,jsx_runtime.jsx)(LLMObservabilityGenerations,{}):(0,jsx_runtime.jsx)(LLMObservabilityNoEvents,{}),link:(0,lib.combineUrl)(urls.j.llmObservabilityGenerations(),searchParams).url},{key:"users",label:"Users",content:hasSentAiGenerationEvent?(0,jsx_runtime.jsx)(LLMObservabilityUsers.LLMObservabilityUsers,{}):(0,jsx_runtime.jsx)(LLMObservabilityNoEvents,{}),link:(0,lib.combineUrl)(urls.j.llmObservabilityUsers(),searchParams).url}]})]})}},"../../products/llm_observability/frontend/LLMObservabilityUsers.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{LLMObservabilityUsers:()=>LLMObservabilityUsers});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_router__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),scenes_persons_PersonDisplay__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/scenes/persons/PersonDisplay.tsx"),scenes_urls__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/scenes/urls.ts"),_queries_nodes_DataTable_DataTable__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/queries/nodes/DataTable/DataTable.tsx"),_queries_utils__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/queries/utils.ts"),_types__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/types.ts"),_llmObservabilityLogic__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../products/llm_observability/frontend/llmObservabilityLogic.tsx"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let mapPerson=person=>{if(!Array.isArray(person)||0===person.length)return{distinct_id:"",created_at:"",properties:{}};let[distinctId,createdAt,propertiesJson]=person,properties={};try{properties=JSON.parse(propertiesJson)}catch(e){console.error("Error parsing person properties_json:",e)}return{distinct_id:distinctId,created_at:createdAt,properties}};function LLMObservabilityUsers(){let{setDates,setShouldFilterTestAccounts,setPropertyFilters}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useActions)(_llmObservabilityLogic__WEBPACK_IMPORTED_MODULE_7__.K),{usersQuery}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)(_llmObservabilityLogic__WEBPACK_IMPORTED_MODULE_7__.K);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(_queries_nodes_DataTable_DataTable__WEBPACK_IMPORTED_MODULE_4__.w,{query:usersQuery,setQuery:query=>{if(!(0,_queries_utils__WEBPACK_IMPORTED_MODULE_5__.tE)(query.source)){console.warn("LLMObservabilityUsers received a non-events query:",query.source);return}let{filters={}}=query.source,{dateRange={}}=filters;setDates(dateRange.date_from||null,dateRange.date_to||null),setShouldFilterTestAccounts(filters.filterTestAccounts||!1),setPropertyFilters(filters.properties||[])},context:{columns:{user:{title:"Person",render:function RenderPerson(x){let person=mapPerson(x.value);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(scenes_persons_PersonDisplay__WEBPACK_IMPORTED_MODULE_2__.I,{person:person,withIcon:!0,noPopover:!0,href:(0,kea_router__WEBPACK_IMPORTED_MODULE_1__.combineUrl)(scenes_urls__WEBPACK_IMPORTED_MODULE_3__.j.llmObservabilityTraces(),{filters:[{type:_types__WEBPACK_IMPORTED_MODULE_6__.FT.HogQL,key:`distinct_id == '${person.distinct_id}'`,value:null}]}).url})}},first_seen:{title:"First Seen"},last_seen:{title:"Last Seen"},traces:{title:"Traces (count)"},generations:{title:"Generations (count)"},total_cost:{title:"Total Cost (USD)",render:function RenderCost(_ref){let{value}=_ref;return value&&Number(value)?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsxs)("span",{children:["$",Number(value).toFixed(4)]}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)("span",{children:"N/A"})}}}},uniqueKey:"llm-observability-users"})}},"../../products/llm_observability/frontend/llmObservabilityLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{E:()=>LLM_OBSERVABILITY_DATA_COLLECTION_NODE_ID,K:()=>llmObservabilityLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),lib_dayjs__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/dayjs.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/lib/utils.tsx"),lib_utils_definitions__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/lib/utils/definitions.ts"),scenes_insights_insightDataLogic__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../frontend/src/scenes/insights/insightDataLogic.tsx"),scenes_sceneLogic__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../frontend/src/scenes/sceneLogic.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("../../frontend/src/scenes/urls.ts"),_models_groupsModel__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("../../frontend/src/models/groupsModel.ts"),_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),_queries_schema_guards__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__("../../frontend/src/queries/schema-guards.ts"),_types__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__("../../frontend/src/types.ts");let LLM_OBSERVABILITY_DATA_COLLECTION_NODE_ID="llm-observability-data",llmObservabilityLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["products","llm_observability","frontend","llmObservabilityLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)(()=>({values:[scenes_sceneLogic__WEBPACK_IMPORTED_MODULE_9__.k,["sceneKey"],_models_groupsModel__WEBPACK_IMPORTED_MODULE_11__.$,["groupsEnabled"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setDates:(dateFrom,dateTo)=>({dateFrom,dateTo}),setDashboardDateFilter:(dateFrom,dateTo)=>({dateFrom,dateTo}),setShouldFilterTestAccounts:shouldFilterTestAccounts=>({shouldFilterTestAccounts}),setPropertyFilters:propertyFilters=>({propertyFilters}),setGenerationsQuery:query=>({query}),setTracesQuery:query=>({query}),refreshAllDashboardItems:!0,setRefreshStatus:(tileId,loading)=>({tileId,loading})}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({dateFilter:[{dateFrom:"-1d",dateTo:null},{setDates:(_,_ref)=>{let{dateFrom,dateTo}=_ref;return{dateFrom,dateTo}}}],dashboardDateFilter:[{dateFrom:"-7d",dateTo:null},{setDates:(_,_ref2)=>{let{dateFrom,dateTo}=_ref2;return{dateFrom,dateTo}}}],shouldFilterTestAccounts:[!1,{setShouldFilterTestAccounts:(_,_ref3)=>{let{shouldFilterTestAccounts}=_ref3;return shouldFilterTestAccounts}}],propertyFilters:[[],{setPropertyFilters:(_,_ref4)=>{let{propertyFilters}=_ref4;return propertyFilters}}],generationsQueryOverride:[null,{setGenerationsQuery:(_,_ref5)=>{let{query}=_ref5;return query}}],tracesQueryOverride:[null,{setTracesQuery:(_,_ref6)=>{let{query}=_ref6;return query}}],refreshStatus:[{},{setRefreshStatus:(state,_ref7)=>{let{tileId,loading}=_ref7;return{...state,[tileId]:loading?{loading:!0,timer:new Date}:state[tileId]}},refreshAllDashboardItems:()=>({})}],newestRefreshed:[null,{setRefreshStatus:(state,_ref8)=>{let{loading}=_ref8;return loading?state:new Date}}]}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)({hasSentAiGenerationEvent:{__default:void 0,loadAIEventDefinition:async()=>{let definition=(await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.eventDefinitions.list({event_type:_types__WEBPACK_IMPORTED_MODULE_14__.uW.Event,search:"$ai_generation"})).results.find(r=>"$ai_generation"===r.name);return!!definition&&!(0,lib_utils_definitions__WEBPACK_IMPORTED_MODULE_7__.U)(definition)}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({activeTab:[s=>[s.sceneKey],sceneKey=>"llmObservabilityGenerations"===sceneKey?"generations":"llmObservabilityTraces"===sceneKey?"traces":"llmObservabilityUsers"===sceneKey?"users":"dashboard"],tiles:[s=>[s.dashboardDateFilter,s.shouldFilterTestAccounts,s.propertyFilters],(dashboardDateFilter,shouldFilterTestAccounts,propertyFilters)=>[{title:"Traces",query:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.TrendsQuery,series:[{event:"$ai_generation",name:"$ai_generation",kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.EventsNode,math:_types__WEBPACK_IMPORTED_MODULE_14__.mY.HogQL,math_hogql:"COUNT(DISTINCT properties.$ai_trace_id)"}],dateRange:{date_from:dashboardDateFilter.dateFrom,date_to:dashboardDateFilter.dateTo},properties:propertyFilters,filterTestAccounts:shouldFilterTestAccounts},context:{insightProps:{dashboardItemId:"new-traces-query"},onDataPointClick:series=>{if("string"==typeof series.day){let dayStart=(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_5__.Bv)(series.day).startOf("day");kea_router__WEBPACK_IMPORTED_MODULE_2__.router.actions.push(scenes_urls__WEBPACK_IMPORTED_MODULE_10__.j.llmObservabilityTraces(),{...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,date_from:dayStart.format("YYYY-MM-DD[T]HH:mm:ss"),date_to:dayStart.add(1,"day").subtract(1,"second").format("YYYY-MM-DD[T]HH:mm:ss")})}}}},{title:"Generative AI users",description:"To count users, set `distinct_id` in LLM tracking.",query:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.TrendsQuery,series:[{event:"$ai_generation",name:"$ai_generation",kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.EventsNode,math:_types__WEBPACK_IMPORTED_MODULE_14__.vN.UniqueUsers}],dateRange:{date_from:dashboardDateFilter.dateFrom,date_to:dashboardDateFilter.dateTo},properties:propertyFilters.concat({type:_types__WEBPACK_IMPORTED_MODULE_14__.FT.HogQL,key:"distinct_id != properties.$ai_trace_id"}),filterTestAccounts:shouldFilterTestAccounts},context:{insightProps:{dashboardItemId:"new-generations-query"}}},{title:"Total cost (USD)",query:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.TrendsQuery,series:[{event:"$ai_generation",name:"$ai_generation",math:_types__WEBPACK_IMPORTED_MODULE_14__.O4.Sum,kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.EventsNode,math_property:"$ai_total_cost_usd"}],trendsFilter:{aggregationAxisPrefix:"$",decimalPlaces:4,display:_types__WEBPACK_IMPORTED_MODULE_14__.Qb.BoldNumber},dateRange:{date_from:dashboardDateFilter.dateFrom,date_to:dashboardDateFilter.dateTo},properties:propertyFilters,filterTestAccounts:shouldFilterTestAccounts},context:{groupTypeLabel:"traces",onDataPointClick:()=>{kea_router__WEBPACK_IMPORTED_MODULE_2__.router.actions.push(scenes_urls__WEBPACK_IMPORTED_MODULE_10__.j.llmObservabilityTraces(),kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams)}}},{title:"Cost per user (USD)",description:"Average cost for each generative AI user active in the data point's period.",query:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.TrendsQuery,series:[{event:"$ai_generation",name:"$ai_generation",math:_types__WEBPACK_IMPORTED_MODULE_14__.O4.Sum,kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.EventsNode,math_property:"$ai_total_cost_usd"},{event:"$ai_generation",name:"$ai_generation",kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.EventsNode,math:_types__WEBPACK_IMPORTED_MODULE_14__.vN.UniqueUsers}],trendsFilter:{formula:"A / B",aggregationAxisPrefix:"$",decimalPlaces:2},dateRange:{date_from:dashboardDateFilter.dateFrom,date_to:dashboardDateFilter.dateTo},properties:propertyFilters.concat({type:_types__WEBPACK_IMPORTED_MODULE_14__.FT.HogQL,key:"distinct_id != properties.$ai_trace_id"}),filterTestAccounts:shouldFilterTestAccounts},context:{insightProps:{dashboardItemId:"new-cost-per-user-query"}}},{title:"Cost by model (USD)",query:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.TrendsQuery,series:[{event:"$ai_generation",name:"$ai_generation",math:_types__WEBPACK_IMPORTED_MODULE_14__.O4.Sum,kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.EventsNode,math_property:"$ai_total_cost_usd"}],breakdownFilter:{breakdown_type:"event",breakdown:"$ai_model"},trendsFilter:{aggregationAxisPrefix:"$",decimalPlaces:2,display:_types__WEBPACK_IMPORTED_MODULE_14__.Qb.ActionsBarValue,showValuesOnSeries:!0},dateRange:{date_from:dashboardDateFilter.dateFrom,date_to:dashboardDateFilter.dateTo},properties:propertyFilters,filterTestAccounts:shouldFilterTestAccounts},context:{groupTypeLabel:"traces",onDataPointClick:_ref9=>{let{breakdown}=_ref9;kea_router__WEBPACK_IMPORTED_MODULE_2__.router.actions.push(scenes_urls__WEBPACK_IMPORTED_MODULE_10__.j.llmObservabilityTraces(),{...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,filters:[...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams.filters||[],{type:_types__WEBPACK_IMPORTED_MODULE_14__.FT.Event,key:"$ai_model",operator:_types__WEBPACK_IMPORTED_MODULE_14__.WV.Exact,value:breakdown}]})}}},{title:"Generation calls",query:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.TrendsQuery,series:[{event:"$ai_generation",name:"$ai_generation",kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.EventsNode}],dateRange:{date_from:dashboardDateFilter.dateFrom,date_to:dashboardDateFilter.dateTo},properties:propertyFilters,filterTestAccounts:shouldFilterTestAccounts},context:{groupTypeLabel:"generations",insightProps:{dashboardItemId:"new-generation-calls-query"},onDataPointClick:series=>{if("string"==typeof series.day){let dayStart=(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_5__.Bv)(series.day).startOf("day");kea_router__WEBPACK_IMPORTED_MODULE_2__.router.actions.push(scenes_urls__WEBPACK_IMPORTED_MODULE_10__.j.llmObservabilityGenerations(),{...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,date_from:dayStart.format("YYYY-MM-DD[T]HH:mm:ss"),date_to:dayStart.add(1,"day").subtract(1,"second").format("YYYY-MM-DD[T]HH:mm:ss")})}}}},{title:"Generation latency by model (median)",query:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.TrendsQuery,series:[{event:"$ai_generation",name:"$ai_generation",math:_types__WEBPACK_IMPORTED_MODULE_14__.O4.Median,kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.EventsNode,math_property:"$ai_latency"}],breakdownFilter:{breakdown:"$ai_model"},trendsFilter:{aggregationAxisPostfix:" s",decimalPlaces:2},dateRange:{date_from:dashboardDateFilter.dateFrom,date_to:dashboardDateFilter.dateTo},properties:propertyFilters,filterTestAccounts:shouldFilterTestAccounts},context:{groupTypeLabel:"generations",insightProps:{dashboardItemId:"new-generation-latency-by-model-query"},onDataPointClick:series=>{if("string"==typeof series.day){let dayStart=(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_5__.Bv)(series.day).startOf("day");kea_router__WEBPACK_IMPORTED_MODULE_2__.router.actions.push(scenes_urls__WEBPACK_IMPORTED_MODULE_10__.j.llmObservabilityGenerations(),{...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,date_from:dayStart.format("YYYY-MM-DD[T]HH:mm:ss"),date_to:dayStart.add(1,"day").subtract(1,"second").format("YYYY-MM-DD[T]HH:mm:ss"),filters:[...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams.filters||[],{type:_types__WEBPACK_IMPORTED_MODULE_14__.FT.Event,key:"$ai_model",operator:_types__WEBPACK_IMPORTED_MODULE_14__.WV.Exact,value:series.breakdown}]})}}}},{title:"Generations by HTTP status",query:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.TrendsQuery,series:[{event:"$ai_generation",name:"$ai_generation",kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.EventsNode}],breakdownFilter:{breakdown:"$ai_http_status"},trendsFilter:{display:_types__WEBPACK_IMPORTED_MODULE_14__.Qb.ActionsBarValue},dateRange:{date_from:dashboardDateFilter.dateFrom,date_to:dashboardDateFilter.dateTo},properties:propertyFilters,filterTestAccounts:shouldFilterTestAccounts},context:{groupTypeLabel:"generations",onDataPointClick:series=>{kea_router__WEBPACK_IMPORTED_MODULE_2__.router.actions.push(scenes_urls__WEBPACK_IMPORTED_MODULE_10__.j.llmObservabilityGenerations(),{...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,filters:[...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams.filters||[],{type:_types__WEBPACK_IMPORTED_MODULE_14__.FT.Event,key:"$ai_http_status",operator:_types__WEBPACK_IMPORTED_MODULE_14__.WV.Exact,value:series.breakdown}]})}}}]],tracesQuery:[s=>[s.tracesQueryOverride,s.defaultTracesQuery],(override,defQuery)=>override||defQuery],defaultTracesQuery:[s=>[s.dateFilter,s.shouldFilterTestAccounts,s.propertyFilters,_models_groupsModel__WEBPACK_IMPORTED_MODULE_11__.$.selectors.groupsTaxonomicTypes],(dateFilter,shouldFilterTestAccounts,propertyFilters,groupsTaxonomicTypes)=>({kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.DataTableNode,source:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.TracesQuery,dateRange:{date_from:dateFilter.dateFrom||void 0,date_to:dateFilter.dateTo||void 0},filterTestAccounts:null!=shouldFilterTestAccounts&&shouldFilterTestAccounts,properties:propertyFilters},columns:["id","traceName","person","totalLatency","usage","totalCost","timestamp"],showDateRange:!0,showReload:!0,showSearch:!0,showTestAccountFilters:!0,showExport:!0,showOpenEditorButton:!1,showColumnConfigurator:!1,showPropertyFilter:[lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.EventProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.PersonProperties,...groupsTaxonomicTypes,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Cohorts,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.HogQLExpression]})],generationsQuery:[s=>[s.generationsQueryOverride,s.defaultGenerationsQuery],(override,defQuery)=>override||defQuery],defaultGenerationsQuery:[s=>[s.dateFilter,s.shouldFilterTestAccounts,s.propertyFilters,_models_groupsModel__WEBPACK_IMPORTED_MODULE_11__.$.selectors.groupsTaxonomicTypes],(dateFilter,shouldFilterTestAccounts,propertyFilters,groupsTaxonomicTypes)=>({kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.DataTableNode,source:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.EventsQuery,select:["*","uuid","properties.$ai_trace_id","person","f'{properties.$ai_model}' -- Model","f'{round(toFloat(properties.$ai_latency), 2)} s' -- Latency","f'{properties.$ai_input_tokens} → {properties.$ai_output_tokens} (∑ {toInt(properties.$ai_input_tokens) + toInt(properties.$ai_output_tokens)})' -- Token usage","f'${round(toFloat(properties.$ai_total_cost_usd), 6)}' -- Total cost","timestamp"],orderBy:["timestamp DESC"],after:dateFilter.dateFrom||void 0,before:dateFilter.dateTo||void 0,filterTestAccounts:shouldFilterTestAccounts,event:"$ai_generation",properties:propertyFilters},showDateRange:!0,showReload:!0,showSearch:!0,showTestAccountFilters:!0,showColumnConfigurator:!0,showPropertyFilter:[lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.EventProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.PersonProperties,...groupsTaxonomicTypes,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Cohorts,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.HogQLExpression],showExport:!0,showActions:!1})],usersQuery:[s=>[s.dateFilter,s.shouldFilterTestAccounts,s.propertyFilters,_models_groupsModel__WEBPACK_IMPORTED_MODULE_11__.$.selectors.groupsTaxonomicTypes],(dateFilter,shouldFilterTestAccounts,propertyFilters,groupsTaxonomicTypes)=>({kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.DataTableNode,source:{kind:_queries_schema_schema_general__WEBPACK_IMPORTED_MODULE_12__.OH.HogQLQuery,query:`
                SELECT
                    argMax(user_tuple, timestamp) as user,
                    countDistinctIf(ai_trace_id, notEmpty(ai_trace_id)) as traces,
                    count() as generations,
                    round(sum(toFloat(ai_total_cost_usd)), 4) as total_cost,
                    min(timestamp) as first_seen,
                    max(timestamp) as last_seen
                FROM (
                    SELECT 
                        distinct_id,
                        timestamp,
                        JSONExtractRaw(properties, '$ai_trace_id') as ai_trace_id,
                        JSONExtractRaw(properties, '$ai_total_cost_usd') as ai_total_cost_usd,
                        tuple(
                            distinct_id,
                            person.created_at,
                            person.properties
                        ) as user_tuple
                    FROM events
                    WHERE event = '$ai_generation' AND {filters}
                )
                GROUP BY distinct_id
                ORDER BY total_cost DESC
                LIMIT 50
                    `,filters:{dateRange:{date_from:dateFilter.dateFrom||null,date_to:dateFilter.dateTo||null},filterTestAccounts:shouldFilterTestAccounts,properties:propertyFilters}},columns:["user","traces","generations","total_cost","first_seen","last_seen"],showDateRange:!0,showReload:!0,showSearch:!0,showPropertyFilter:[lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.EventProperties,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.PersonProperties,...groupsTaxonomicTypes,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.Cohorts,lib_components_TaxonomicFilter_types__WEBPACK_IMPORTED_MODULE_4__.t.HogQLExpression],showTestAccountFilters:!0,showExport:!0,showColumnConfigurator:!0})],isRefreshing:[s=>[s.refreshStatus],refreshStatus=>Object.values(refreshStatus).some(status=>status.loading)]}),(0,kea_router__WEBPACK_IMPORTED_MODULE_2__.urlToAction)(_ref10=>{let{actions,values}=_ref10;function applySearchParams(_ref11){let{filters,date_from,date_to,filter_test_accounts}=_ref11,parsedFilters=(0,_queries_schema_guards__WEBPACK_IMPORTED_MODULE_13__.kC)(filters)?filters:[];(0,lib_utils__WEBPACK_IMPORTED_MODULE_6__.h0)(parsedFilters,values.propertyFilters)||actions.setPropertyFilters(parsedFilters),((date_from||"-1d")!==values.dateFilter.dateFrom||(date_to||null)!==values.dateFilter.dateTo)&&actions.setDates(date_from||"-1d",date_to||null);let filterTestAccountsValue=[!0,"true",1,"1"].includes(filter_test_accounts);filterTestAccountsValue!==values.shouldFilterTestAccounts&&actions.setShouldFilterTestAccounts(filterTestAccountsValue)}return{[scenes_urls__WEBPACK_IMPORTED_MODULE_10__.j.llmObservabilityDashboard()]:(_,searchParams)=>applySearchParams(searchParams),[scenes_urls__WEBPACK_IMPORTED_MODULE_10__.j.llmObservabilityGenerations()]:(_,searchParams)=>applySearchParams(searchParams),[scenes_urls__WEBPACK_IMPORTED_MODULE_10__.j.llmObservabilityTraces()]:(_,searchParams)=>applySearchParams(searchParams),[scenes_urls__WEBPACK_IMPORTED_MODULE_10__.j.llmObservabilityUsers()]:(_,searchParams)=>applySearchParams(searchParams)}}),(0,kea_router__WEBPACK_IMPORTED_MODULE_2__.actionToUrl)(()=>({setPropertyFilters:_ref12=>{let{propertyFilters}=_ref12;return[kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.location.pathname,{...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,filters:propertyFilters.length>0?propertyFilters:void 0}]},setDates:_ref13=>{let{dateFrom,dateTo}=_ref13;return[kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.location.pathname,{...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,date_from:"-1d"===dateFrom?void 0:dateFrom||void 0,date_to:dateTo||void 0}]},setShouldFilterTestAccounts:_ref14=>{let{shouldFilterTestAccounts}=_ref14;return[kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.location.pathname,{...kea_router__WEBPACK_IMPORTED_MODULE_2__.router.values.searchParams,filter_test_accounts:shouldFilterTestAccounts?"true":void 0}]}})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref15=>{let{actions}=_ref15;actions.loadAIEventDefinition()}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref16=>{let{actions,values}=_ref16;return{refreshAllDashboardItems:async()=>{values.tiles.forEach((_,index)=>{actions.setRefreshStatus(`tile-${index}`,!0)});try{values.tiles.map((tile,index)=>{let insightProps={dashboardItemId:tile.context?.insightProps?.dashboardItemId},mountedInsightDataLogic=scenes_insights_insightDataLogic__WEBPACK_IMPORTED_MODULE_8__.S.findMounted(insightProps);mountedInsightDataLogic&&mountedInsightDataLogic.actions.loadData("force_blocking"),actions.setRefreshStatus(`tile-${index}`,!1)})}catch(error){console.error("Error refreshing dashboard items:",error),values.tiles.forEach((_,index)=>{actions.setRefreshStatus(`tile-${index}`,!1)})}}}})])}}]);
//# sourceMappingURL=59116.989fdc90.iframe.bundle.js.map