(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{"./frontend/src/scenes/apps/appMetricsSceneLogic.ts":function(Q,j,n){"use strict";n.r(j),n.d(j,"AppMetricsTab",function(){return u}),n.d(j,"appMetricsSceneLogic",function(){return z});var R=n("./node_modules/@babel/runtime/helpers/slicedToArray.js"),U=n.n(R),h=n("./node_modules/@babel/runtime/helpers/asyncToGenerator.js"),p=n.n(h),B=n("./node_modules/@babel/runtime/regenerator/index.js"),d=n.n(B),K=n("./node_modules/core-js/modules/es.array.iterator.js"),V=n.n(K),W=n("./node_modules/core-js/modules/es.object.to-string.js"),X=n.n(W),F=n("./node_modules/core-js/modules/web.dom-collections.iterator.js"),Y=n.n(F),x=n("./node_modules/core-js/modules/es.array.concat.js"),Z=n.n(x),H=n("./node_modules/core-js/modules/es.function.name.js"),w=n.n(H),S=n("./node_modules/core-js/modules/es.array.filter.js"),k=n.n(S),J=n("./node_modules/core-js/modules/es.array.includes.js"),q=n.n(J),$=n("./node_modules/core-js/modules/es.string.includes.js"),ee=n.n($),G=n("./node_modules/core-js/modules/es.number.constructor.js"),re=n.n(G),E=n("./node_modules/kea/lib/index.esm.js"),O=n("./node_modules/kea-loaders/lib/index.js"),te=n.n(O),v=n("./frontend/src/scenes/urls.ts"),m=n("./frontend/src/lib/api.ts"),D=n("./frontend/src/scenes/teamLogic.tsx"),b=n("./node_modules/kea-router/lib/index.js"),ne=n.n(b),g=n("./frontend/src/lib/utils.tsx"),P=n("./frontend/src/scenes/plugins/edit/interface-jobs/PluginJobConfiguration.tsx"),N=n("./frontend/src/scenes/plugins/edit/interface-jobs/interfaceJobsLogic.ts"),I=n("./frontend/src/lib/dayjs.ts"),u;(function(r){r.ProcessEvent="processEvent",r.OnEvent="onEvent",r.ExportEvents="exportEvents",r.ScheduledTask="scheduledTask",r.HistoricalExports="historical_exports"})(u||(u={}));var T="-30d",A=[u.ProcessEvent,u.OnEvent,u.ExportEvents,u.ScheduledTask],z=Object(E.kea)([Object(E.path)(function(r){return["scenes","apps","appMetricsSceneLogic",r]}),Object(E.props)({}),Object(E.key)(function(r){return r.pluginConfigId}),Object(E.actions)({setActiveTab:function(t){return{tab:t}},setDateFrom:function(t){return{dateFrom:t}},openErrorDetailsModal:function(t,o,e){return{errorType:t,category:o,jobId:e}},closeErrorDetailsModal:!0,openHistoricalExportModal:!0}),Object(E.reducers)({activeTab:[null,{setActiveTab:function(t,o){var e=o.tab;return e}}],selectedDateFrom:[null,{setDateFrom:function(t,o){var e=o.dateFrom;return e}}],errorDetailsModalError:[null,{openErrorDetailsModal:function(t,o){var e=o.errorType;return e},closeErrorDetailsModal:function(){return null}}]}),Object(O.loaders)(function(r){var t=r.values,o=r.props;return{pluginConfig:[null,{loadPluginConfig:function(){var e=p()(d.a.mark(function s(){return d.a.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,m.b.get("api/projects/".concat(D.a.values.currentTeamId,"/plugin_configs/").concat(o.pluginConfigId));case 2:return l.abrupt("return",l.sent);case 3:case"end":return l.stop()}},s)}));function i(){return e.apply(this,arguments)}return i}()}],appMetricsResponse:[null,{loadMetrics:function(){var e=p()(d.a.mark(function s(){var a;return d.a.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(!(t.activeTab&&t.dateFrom)){c.next=5;break}return a=Object(g.Eb)({category:t.activeTab,date_from:t.dateFrom}),c.next=4,m.b.get("api/projects/".concat(D.a.values.currentTeamId,"/app_metrics/").concat(o.pluginConfigId,"?").concat(a));case 4:return c.abrupt("return",c.sent);case 5:case"end":return c.stop()}},s)}));function i(){return e.apply(this,arguments)}return i}()}],historicalExports:[[],{loadHistoricalExports:function(){var e=p()(d.a.mark(function s(){var a,l;return d.a.wrap(function(_){for(;;)switch(_.prev=_.next){case 0:return _.next=2,m.b.get("api/projects/".concat(D.a.values.currentTeamId,"/app_metrics/").concat(o.pluginConfigId,"/historical_exports"));case 2:return a=_.sent,l=a.results,_.abrupt("return",l);case 5:case"end":return _.stop()}},s)}));function i(){return e.apply(this,arguments)}return i}()}],errorDetails:[[],{openErrorDetailsModal:function(){var e=p()(d.a.mark(function s(a){var l,c,_,C,L,y;return d.a.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return l=a.category,c=a.jobId,_=a.errorType,C=Object(g.Eb)({category:l,job_id:c,error_type:_}),f.next=4,m.b.get("api/projects/".concat(D.a.values.currentTeamId,"/app_metrics/").concat(o.pluginConfigId,"/error_details?").concat(C));case 4:return L=f.sent,y=L.result,f.abrupt("return",y);case 7:case"end":return f.stop()}},s)}));function i(s){return e.apply(this,arguments)}return i}()}]}}),Object(E.selectors)(function(r){var t=r.values,o=r.actions;return{breadcrumbs:[function(e){return[e.pluginConfig,function(i,s){return s.pluginConfigId}]},function(e,i){var s;return[{name:"Apps",path:v.a.projectApps()},{name:e==null||(s=e.plugin_info)===null||s===void 0?void 0:s.name,path:v.a.appMetrics(i)}]}],defaultTab:[function(e){return[e.pluginConfig]},function(){return A.filter(function(e){return t.showTab(e)})[0]}],currentTime:[function(){return[]},function(){return Date.now()}],defaultDateFrom:[function(e){return[e.pluginConfig,e.currentTime]},function(e,i){if(!(e!=null&&e.created_at))return T;var s=I.a.utc(e.created_at),a=Object(I.a)(i).diff(s,"days",!0);return a<=1?"-24h":a<=7?"-7d":T}],dateFrom:[function(e){return[e.selectedDateFrom,e.defaultDateFrom]},function(e,i){var s;return(s=e!=null?e:i)!==null&&s!==void 0?s:T}],showTab:[function(){return[]},function(){return function(e){if(t.pluginConfigLoading||!t.pluginConfig||!t.pluginConfig.plugin_info.capabilities)return!1;var i=t.pluginConfig.plugin_info.capabilities,s=i.methods.includes("exportEvents");return e===u.HistoricalExports?s:e===u.OnEvent&&s?!1:e===u.ScheduledTask?!s&&["runEveryMinute","runEveryHour","runEveryDay"].some(function(a){return i.scheduled_tasks.includes(a)}):i.methods.includes(e)}}],interfaceJobsProps:[function(e){return[e.pluginConfig]},function(e){return!e||!e.plugin_info.public_jobs||!(e!=null&&e.enabled)?null:{jobName:P.b,jobSpec:e.plugin_info.public_jobs[P.b],pluginConfigId:e.id,pluginId:e.plugin,onSubmit:o.loadHistoricalExports}}],hasRunningExports:[function(e){return[e.historicalExports]},function(e){return e.some(function(i){return i.status=="not_finished"})}]}}),Object(E.listeners)(function(r){var t=r.values,o=r.actions;return{loadPluginConfigSuccess:function(){t.activeTab||o.setActiveTab(t.defaultTab)},setActiveTab:function(i){var s=i.tab;s===u.HistoricalExports?o.loadHistoricalExports():o.loadMetrics()},setDateFrom:function(){o.loadMetrics()},openHistoricalExportModal:function(){t.interfaceJobsProps&&Object(N.a)(t.interfaceJobsProps).actions.setIsJobModalOpen(!0)}}}),Object(b.actionToUrl)(function(r){var t=r.values,o=r.props;return{setActiveTab:function(){return M(t,o)},setDateFrom:function(){return M(t,o)},openErrorDetailsModal:function(){return M(t,o)},closeErrorDetailsModal:function(){return M(t,o)}}}),Object(b.urlToAction)(function(r){var t=r.values,o=r.actions,e=r.props;return{"/app/:pluginConfigId/:page":function(s,a){if(e.pluginConfigId===Number(s.pluginConfigId))if(t.pluginConfig||o.loadPluginConfig(),s.page===u.HistoricalExports)o.setActiveTab(u.HistoricalExports);else if(a.tab&&A.includes(a.tab)&&a.tab!==t.activeTab?o.setActiveTab(a.tab):t.defaultTab&&t.activeTab!==t.defaultTab&&o.setActiveTab(t.defaultTab),a.from&&t.selectedDateFrom!==a.from&&o.setDateFrom(a.from),a.error){var l=U()(a.error,2),c=l[0],_=l[1];t.errorDetailsModalError!==c&&(o.setActiveTab(_),o.openErrorDetailsModal(c,_))}else o.closeErrorDetailsModal()}}})]);function M(r,t){if(r.activeTab===u.HistoricalExports)return v.a.appHistoricalExports(t.pluginConfigId);var o={};return r.activeTab&&r.activeTab!==r.defaultTab&&(o.tab=r.activeTab),r.selectedDateFrom&&(o.from=r.selectedDateFrom),r.errorDetailsModalError&&r.activeTab&&(o.error=[r.errorDetailsModalError,r.activeTab]),v.a.appMetrics(t.pluginConfigId,o)}}}]);
