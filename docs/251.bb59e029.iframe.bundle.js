(window.webpackJsonp=window.webpackJsonp||[]).push([[251],{"./frontend/src/scenes/instance/AsyncMigrations/AsyncMigrations.tsx":function(me,L,i){"use strict";i.r(L),i.d(L,"scene",function(){return ie}),i.d(L,"AsyncMigrations",function(){return Y});var fe=i("./node_modules/core-js/modules/es.symbol.js"),pe=i("./node_modules/core-js/modules/es.symbol.description.js"),ye=i("./node_modules/core-js/modules/es.array.join.js"),ve=i("./node_modules/core-js/modules/es.array.map.js"),Ee=i("./node_modules/core-js/modules/es.function.name.js"),Me=i("./node_modules/core-js/modules/es.regexp.exec.js"),Se=i("./node_modules/core-js/modules/es.string.split.js"),N=i("./node_modules/react/index.js"),e=i.n(N),D=i("./frontend/src/lib/components/PageHeader.tsx"),V=i("./node_modules/antd/es/tabs/index.js"),G=i("./node_modules/antd/es/progress/index.js"),$=i("./node_modules/antd/es/button/index.js"),H=i("./node_modules/antd/es/space/index.js"),j=i("./node_modules/kea/lib/index.esm.js"),J=i("./node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js"),he=i("./node_modules/core-js/modules/es.array.filter.js"),be=i("./node_modules/core-js/modules/es.array.includes.js"),je=i("./node_modules/core-js/modules/es.array.iterator.js"),Ae=i("./node_modules/core-js/modules/es.object.to-string.js"),Oe=i("./node_modules/core-js/modules/es.string.includes.js"),Re=i("./node_modules/core-js/modules/web.dom-collections.iterator.js"),Q=i("./node_modules/@babel/runtime/regenerator/index.js"),f=i.n(Q),Ie=i("./node_modules/regenerator-runtime/runtime.js"),X=i("./node_modules/@babel/runtime/helpers/asyncToGenerator.js"),S=i.n(X),Z=i("./node_modules/@babel/runtime/helpers/defineProperty.js"),F=i.n(Z),p=i("./frontend/src/lib/utils.tsx"),h=i("./frontend/src/lib/api.ts"),k=i("./frontend/src/scenes/userLogic.tsx");function K(r,n){var a=Object.keys(r);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(r);n&&(s=s.filter(function(u){return Object.getOwnPropertyDescriptor(r,u).enumerable})),a.push.apply(a,s)}return a}function b(r){for(var n=1;n<arguments.length;n++){var a=arguments[n]!=null?arguments[n]:{};n%2?K(Object(a),!0).forEach(function(s){F()(r,s,a[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(a)):K(Object(a)).forEach(function(s){Object.defineProperty(r,s,Object.getOwnPropertyDescriptor(a,s))})}return r}var v;(function(r){r[r.NotStarted=0]="NotStarted",r[r.Running=1]="Running",r[r.CompletedSuccessfully=2]="CompletedSuccessfully",r[r.Errored=3]="Errored",r[r.RolledBack=4]="RolledBack",r[r.Starting=5]="Starting",r[r.FailedAtStartup=6]="FailedAtStartup"})(v||(v={}));var A;(function(r){r.Management="management",r.Settings="settings"})(A||(A={}));var q={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},I=Object(j.kea)({path:["scenes","instance","AsyncMigrations","asyncMigrationsLogic"],actions:{triggerMigration:function(n){return{migrationId:n}},resumeMigration:function(n){return{migrationId:n}},rollbackMigration:function(n){return{migrationId:n}},forceStopMigration:function(n){return{migrationId:n}},forceStopMigrationWithoutRollback:function(n){return{migrationId:n}},setActiveTab:function(n){return{tab:n}},updateSetting:function(n,a){return{settingKey:n,newValue:a}},loadAsyncMigrationErrors:function(n){return{migrationId:n}},loadAsyncMigrationErrorsSuccess:function(n,a){return{migrationId:n,errors:a}},loadAsyncMigrationErrorsFailure:function(n,a){return{migrationId:n,error:a}}},reducers:{activeTab:[A.Management,{setActiveTab:function(n,a){var s=a.tab;return s}}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:function(n,a){var s=a.migrationId,u=a.errors;return b(b({},n),{},F()({},s,u))}}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:function(n,a){var s=a.migrationId;return b(b({},n),{},F()({},s,!0))},loadAsyncMigrationErrorsSuccess:function(n,a){var s=a.migrationId;return b(b({},n),{},F()({},s,!1))},loadAsyncMigrationErrorsFailure:function(n,a){var s=a.migrationId;return b(b({},n),{},F()({},s,!1))}}]},loaders:function(){return{asyncMigrations:[[],{loadAsyncMigrations:function(){var n=S()(f.a.mark(function s(){var u;return f.a.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(!((u=k.a.values.user)===null||u===void 0)&&u.is_staff){d.next=2;break}return d.abrupt("return",[]);case 2:return d.next=4,h.a.get("api/async_migrations");case 4:return d.abrupt("return",d.sent.results);case 5:case"end":return d.stop()}},s)}));function a(){return n.apply(this,arguments)}return a}()}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:function(){var n=S()(f.a.mark(function s(){var u,c;return f.a.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!((u=k.a.values.user)===null||u===void 0)&&u.is_staff){o.next=2;break}return o.abrupt("return",[]);case 2:return o.next=4,h.a.get("api/instance_settings");case 4:return c=o.sent.results,o.abrupt("return",c.filter(function(l){return l.key.includes("ASYNC_MIGRATIONS")}));case 6:case"end":return o.stop()}},s)}));function a(){return n.apply(this,arguments)}return a}()}]}},listeners:function(n){var a=n.actions;return{triggerMigration:function(){var s=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.next=3,h.a.create("/api/async_migrations/".concat(o,"/trigger"));case 3:l=t.sent,l.success?(Object(p.xb)("Migration triggered successfully"),a.loadAsyncMigrations()):Object(p.z)("Failed to trigger migration",l.error);case 5:case"end":return t.stop()}},c)}));function u(c){return s.apply(this,arguments)}return u}(),resumeMigration:function(){var s=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.next=3,h.a.create("/api/async_migrations/".concat(o,"/resume"));case 3:l=t.sent,l.success?(Object(p.xb)("Migration resume triggered successfully"),a.loadAsyncMigrations()):Object(p.z)("Failed to resume migration",l.error);case 5:case"end":return t.stop()}},c)}));function u(c){return s.apply(this,arguments)}return u}(),rollbackMigration:function(){var s=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.next=3,h.a.create("/api/async_migrations/".concat(o,"/rollback"));case 3:l=t.sent,l.success?(Object(p.xb)("Migration rolledback triggered successfully"),a.loadAsyncMigrations()):Object(p.z)("Failed to rollback migration",l.error);case 5:case"end":return t.stop()}},c)}));function u(c){return s.apply(this,arguments)}return u}(),forceStopMigration:function(){var s=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.next=3,h.a.create("/api/async_migrations/".concat(o,"/force_stop"));case 3:l=t.sent,l.success?(Object(p.xb)("Force stop triggered successfully"),a.loadAsyncMigrations()):Object(p.z)("Failed to trigger force stop",l.error);case 5:case"end":return t.stop()}},c)}));function u(c){return s.apply(this,arguments)}return u}(),forceStopMigrationWithoutRollback:function(){var s=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.next=3,h.a.create("/api/async_migrations/".concat(o,"/force_stop_without_rollback"));case 3:l=t.sent,l.success?(Object(p.xb)("Force stop without rollback triggered successfully"),a.loadAsyncMigrations()):Object(p.z)("Failed to trigger force stop without rollback",l.error);case 5:case"end":return t.stop()}},c)}));function u(c){return s.apply(this,arguments)}return u}(),updateSetting:function(){var s=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.settingKey,l=d.newValue,t.prev=1,t.next=4,h.a.update("/api/instance_settings/".concat(o),{value:l});case 4:Object(p.xb)("Setting updated successfully!","Instance setting ".concat(o," has been updated.")),a.loadAsyncMigrationSettings(),t.next=11;break;case 8:t.prev=8,t.t0=t.catch(1),Object(p.z)("Failed to trigger migration.","Please try again or contact support.");case 11:case"end":return t.stop()}},c,null,[[1,8]])}));function u(c){return s.apply(this,arguments)}return u}(),loadAsyncMigrationErrors:function(){var s=S()(f.a.mark(function c(d){var o,l;return f.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=d.migrationId,t.prev=1,t.next=4,h.a.get("api/async_migrations/".concat(o,"/errors"));case 4:l=t.sent,a.loadAsyncMigrationErrorsSuccess(o,l),t.next=11;break;case 8:t.prev=8,t.t0=t.catch(1),a.loadAsyncMigrationErrorsFailure(o,t.t0);case 11:case"end":return t.stop()}},c,null,[[1,8]])}));function u(c){return s.apply(this,arguments)}return u}()}},events:function(n){var a=n.actions;return{afterMount:function(){a.loadAsyncMigrations(),a.loadAsyncMigrationSettings()}}}}),W=i("./frontend/src/lib/components/Tooltip.tsx"),x=i("./frontend/src/lib/components/Spinner/Spinner.tsx"),_=i("./node_modules/@babel/runtime/helpers/slicedToArray.js"),ee=i.n(_),ne=i("./node_modules/antd/es/row/index.js"),w=i("./node_modules/antd/es/col/index.js"),te=i("./node_modules/antd/es/input/index.js"),re=i("./node_modules/antd/es/divider/index.js");function C(r){var n=r.setting,a=Object(j.useActions)(I),s=a.updateSetting,u=Object(N.useState)(String(n.value)),c=ee()(u,2),d=c[0],o=c[1];return e.a.createElement("div",{key:n.key},e.a.createElement("h4",null,n.key),e.a.createElement("p",null,n.description),e.a.createElement(ne.a,{gutter:[8,8]},e.a.createElement(w.a,{span:8},e.a.createElement(te.a,{value:d,onChange:function(M){return o(M.target.value)}})),e.a.createElement(w.a,{span:16},e.a.createElement($.a,{disabled:String(n.value)===d,type:"primary",onClick:function(){return s(n.key,d)}},"Update"))),e.a.createElement(re.a,null))}try{C.displayName="SettingUpdateField",C.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"InstanceSetting"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:C.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(r){}var B=i("./frontend/src/lib/components/LemonTable/index.ts"),O=i("./frontend/src/lib/components/LemonButton/index.ts"),P=i("./frontend/src/lib/components/icons.tsx");function T(r){var n=r.asyncMigration,a=Object(j.useValues)(I),s=a.asyncMigrationErrorsLoading,u=a.asyncMigrationErrors,c=Object(j.useActions)(I),d=c.loadAsyncMigrationErrors,o=[{title:"Error",dataIndex:"description"},{title:"Timestamp",render:function(M,t){return e.a.createElement("div",null,Object(p.K)(t.created_at))}}];return e.a.createElement(e.a.Fragment,null,e.a.createElement(B.a,{columns:o,dataSource:u[n.id],loading:s[n.id],embedded:!0}),e.a.createElement(O.a,{icon:s[n.id]?e.a.createElement(x.a,{size:"sm"}):e.a.createElement(P.IconRefresh,null),onClick:function(){return d(n.id)},type:"secondary",compact:!0,style:{position:"absolute",top:"0.5rem",right:"1.5rem"}},"Refresh errors"))}try{T.displayName="AsyncMigrationDetails",T.__docgenInfo={description:"",displayName:"AsyncMigrationDetails",props:{asyncMigration:{defaultValue:null,description:"",name:"asyncMigration",required:!0,type:{name:"AsyncMigration"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"]={docgenInfo:T.__docgenInfo,name:"AsyncMigrationDetails",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"})}catch(r){}var z=i("./frontend/src/lib/components/LemonButton/More.tsx"),ae=i("./frontend/src/lib/components/LemonTag/LemonTag.tsx"),ie={component:Y,logic:I},U=V.a.TabPane;function Y(){var r=Object(j.useValues)(k.a),n=r.user,a=Object(j.useValues)(I),s=a.asyncMigrations,u=a.asyncMigrationsLoading,c=a.activeTab,d=a.asyncMigrationSettings,o=Object(j.useActions)(I),l=o.triggerMigration,M=o.resumeMigration,t=o.rollbackMigration,se=o.forceStopMigration,oe=o.forceStopMigrationWithoutRollback,le=o.loadAsyncMigrations,ce=o.loadAsyncMigrationErrors,ue=o.setActiveTab,de=[{title:"Migration",render:function(y,m){var g="https://posthog.com/docs/self-host/configure/async-migrations/"+m.name.split("_").join("-");return e.a.createElement(e.a.Fragment,null,e.a.createElement("div",{className:"row-name"},e.a.createElement("a",{href:g},m.name)),e.a.createElement("div",{className:"row-description"},m.description))}},{title:"Progress",render:function(y,m){var g=m.progress;return e.a.createElement("div",null,e.a.createElement(G.a,{percent:g}))}},{title:"Status",render:function(y,m){var g=m.status,R=g===v.Running?"success":g===v.Errored||g===v.FailedAtStartup?"danger":g===v.Starting||g===v.RolledBack?"warning":"default";return e.a.createElement(ae.a,{type:R},q[g])}},{title:"Last operation index",dataIndex:"current_operation_index"},{title:"Last query ID",render:function(y,m){return e.a.createElement("div",null,e.a.createElement("small",null,m.current_query_id))}},{title:"Started at",render:function(y,m){var g=m.started_at;return e.a.createElement("div",null,Object(p.K)(g))}},{title:"Finished at",render:function(y,m){var g=m.finished_at;return e.a.createElement("div",null,Object(p.K)(g))}},{title:"",render:function(y,m){var g=m.status;return e.a.createElement("div",null,g===v.NotStarted||g===v.FailedAtStartup?e.a.createElement(W.a,{title:"Start"},e.a.createElement($.a,{type:"link",icon:e.a.createElement(J.a,null),onClick:function(){return l(m.id)}},"Run")):g===v.Running?e.a.createElement(z.a,{overlay:e.a.createElement(e.a.Fragment,null,e.a.createElement(O.a,{type:"stealth",onClick:function(){return se(m.id)},fullWidth:!0},"Stop and rollback"),e.a.createElement(O.a,{type:"stealth",onClick:function(){return oe(m.id)},fullWidth:!0},"Stop"))}):g===v.CompletedSuccessfully?e.a.createElement(e.a.Fragment,null):g===v.Errored?e.a.createElement(z.a,{overlay:e.a.createElement(e.a.Fragment,null,e.a.createElement(O.a,{type:"stealth",onClick:function(){return M(m.id)},fullWidth:!0},"Resume"),e.a.createElement(O.a,{type:"stealth",onClick:function(){return t(m.id)},fullWidth:!0},"Rollback"))}):g===v.RolledBack?e.a.createElement(W.a,{title:"Restart"},e.a.createElement(O.a,{type:"stealth",icon:e.a.createElement(P.IconReplay,null),onClick:function(){return l(m.id)},fullWidth:!0})):g===v.Starting?e.a.createElement(x.a,{size:"sm"}):null)}}],ge={expandedRowRender:function(y){return y&&e.a.createElement(T,{asyncMigration:y})},rowExpandable:function(y){return y.error_count>0},onRowExpand:function(y){ce(y.id)}};return e.a.createElement("div",null,n!=null&&n.is_staff?e.a.createElement(e.a.Fragment,null,e.a.createElement(D.a,{title:"Async Migrations",caption:e.a.createElement(e.a.Fragment,null,e.a.createElement("p",null,"Manage async migrations in your instance."),e.a.createElement("p",null,"Read about async migrations on our"," ",e.a.createElement("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations"},"dedicated docs page"),"."))}),e.a.createElement(V.a,{activeKey:c,onChange:function(y){return ue(y)}},e.a.createElement(U,{tab:"Management",key:A.Management}),e.a.createElement(U,{tab:"Settings",key:A.Settings})),c===A.Management?e.a.createElement(e.a.Fragment,null,e.a.createElement("div",{className:"mb float-right"},e.a.createElement(O.a,{icon:u?e.a.createElement(x.a,{size:"sm"}):e.a.createElement(P.IconRefresh,null),onClick:le,type:"secondary",compact:!0},"Refresh")),e.a.createElement(H.b,null),e.a.createElement(B.a,{pagination:{pageSize:10},loading:u,columns:de,dataSource:s,expandable:ge})):c===A.Settings?e.a.createElement(e.a.Fragment,null,e.a.createElement("br",null),d.map(function(E){return e.a.createElement("div",{key:E.key},e.a.createElement(C,{setting:E}))})):null):e.a.createElement(D.a,{title:"Async Migrations",caption:e.a.createElement(e.a.Fragment,null,e.a.createElement("p",null,"Only users with staff access can manage async migrations. Please contact your instance admin."),e.a.createElement("p",null,"If you're an admin and don't have access, set ",e.a.createElement("code",null,"is_staff=true")," for your user on the PostgreSQL ",e.a.createElement("code",null,"posthog_user")," table."))}))}}}]);
