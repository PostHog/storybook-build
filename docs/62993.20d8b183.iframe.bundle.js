"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[62993],{"../../frontend/src/lib/components/AppMetrics/AppMetricSummary.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{p:()=>AppMetricSummary});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/utils.tsx"),_queries_nodes_DataVisualization_Components_Charts_LineGraph__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/queries/nodes/DataVisualization/Components/Charts/LineGraph.tsx"),_types__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/types.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function AppMetricSummary(_ref){let{name,timeSeries,previousPeriodTimeSeries,description,color,colorIfZero,loading}=_ref,total=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)(()=>timeSeries?timeSeries.series.reduce((acc,curr)=>acc+curr.values.reduce((acc,curr)=>acc+curr,0),0):0,[timeSeries]),totalPreviousPeriod=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)(()=>previousPeriodTimeSeries?previousPeriodTimeSeries.series.reduce((acc,curr)=>acc+curr.values.reduce((acc,curr)=>acc+curr,0),0):0,[previousPeriodTimeSeries]),diff=(total-totalPreviousPeriod)/totalPreviousPeriod;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsxs)("div",{className:"flex flex-1 flex-col relative border rounded p-3 bg-surface-primary min-w-[16rem]",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsxs)("div",{className:"flex flex-row justify-between items-start",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.HQ,{info:description,children:name}),loading?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.yW,{className:"w-20 h-6 mb-2"}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"text-right text-2xl text-muted-foreground",children:(0,lib_utils__WEBPACK_IMPORTED_MODULE_2__.Lc)(total)})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"flex flex-row justify-end items-center gap-2 text-xs text-muted",children:loading?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.yW,{className:"w-10 h-4"}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.Fragment,{children:diff>0?` (+${(100*diff).toFixed(1)}%)`:` (-${(-(100*diff)).toFixed(1)}%)`})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"flex-1 mt-2",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"h-[10rem]",children:loading?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.t2,{}):timeSeries?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_queries_nodes_DataVisualization_Components_Charts_LineGraph__WEBPACK_IMPORTED_MODULE_3__.x,{xData:{column:{name:"date",type:{name:"DATE",isNumerical:!1},label:"Date",dataIndex:0},data:timeSeries.labels},yData:timeSeries.series.map(x=>({column:{name:x.name,type:{name:"INTEGER",isNumerical:!0},label:x.name,dataIndex:0},data:x.values,settings:{display:{color:0===total?colorIfZero:color}}})),visualizationType:_types__WEBPACK_IMPORTED_MODULE_4__.Qb.ActionsLineGraph,chartSettings:{showLegend:!1,showTotalRow:!1,showXAxisBorder:!1,showYAxisBorder:!1,showXAxisTicks:!1,leftYAxisSettings:{showTicks:!1,showGridLines:!1}}}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_1__.HQ,{children:"No data"})})})})]})}},"../../frontend/src/lib/components/AppMetrics/AppMetricsFilters.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{f:()=>AppMetricsFilters});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),_posthog_icons__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.34.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),_DateFilter_DateFilter__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),_appMetricsLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/components/AppMetrics/appMetricsLogic.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function AppMetricsFilters(_ref){let{logicKey}=_ref,logic=(0,_appMetricsLogic__WEBPACK_IMPORTED_MODULE_4__.t)({logicKey}),{params,availableIntervals}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)(logic),{setParams}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useActions)(logic);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsxs)("div",{className:"flex flex-row gap-2 flex-wrap",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_2__.Yv,{options:[{label:"Hourly",value:"hour",disabledReason:availableIntervals.includes("hour")?void 0:"Please select a smaller date range"},{label:"Daily",value:"day",disabledReason:availableIntervals.includes("day")?void 0:"Please select a smaller date range"}],size:"small",value:params.interval,onChange:value=>setParams({interval:value})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_DateFilter_DateFilter__WEBPACK_IMPORTED_MODULE_3__.f,{dateTo:params.dateTo,dateFrom:params.dateFrom,onChange:(from,to)=>setParams({dateFrom:from||void 0,dateTo:to||void 0}),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_1__.IconCalendar,{})," ",key]})})]})}},"../../frontend/src/lib/components/AppMetrics/AppMetricsTrends.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{f:()=>AppMetricsTrends});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),_queries_nodes_DataVisualization_Components_Charts_LineGraph__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../frontend/src/queries/nodes/DataVisualization/Components/Charts/LineGraph.tsx"),_types__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/types.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function AppMetricsTrends(_ref){let{appMetricsTrends,loading}=_ref;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("div",{className:"relative border rounded min-h-[20rem] h-[70vh] bg-white",children:loading?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.t2,{}):appMetricsTrends?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)(_queries_nodes_DataVisualization_Components_Charts_LineGraph__WEBPACK_IMPORTED_MODULE_1__.x,{className:"p-2",xData:{column:{name:"date",type:{name:"DATE",isNumerical:!1},label:"Date",dataIndex:0},data:appMetricsTrends.labels},yData:appMetricsTrends.series.map(x=>({column:{name:x.name,type:{name:"INTEGER",isNumerical:!0},label:x.name,dataIndex:0},data:x.values})),visualizationType:_types__WEBPACK_IMPORTED_MODULE_2__.Qb.ActionsLineGraph,chartSettings:{showLegend:!0,showTotalRow:!1}}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("div",{className:"flex-1 flex items-center justify-center",children:"Missing"})})}},"../../frontend/src/scenes/hog-functions/configuration/HogFunctionTest.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{P1:()=>HogFunctionTest,Wc:()=>HogFunctionTestEditor});var clsx__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),monaco_editor__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/monaco-editor@0.49.0/node_modules/monaco-editor/esm/vs/editor/editor.main.js"),react__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),_posthog_icons__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.34.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),lib_components_TZLabel__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),lib_lemon_ui_LemonButton_More__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/More.tsx"),lib_lemon_ui_LemonField__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),lib_monaco_CodeEditorResizable__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../frontend/src/lib/monaco/CodeEditorResizable.tsx"),_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx"),_hogFunctionTestLogic__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionTestLogic.tsx"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let HogFunctionTestEditor=_ref2=>{let{value,onChange,readOnly=!1}=_ref2,editorRef=(0,react__WEBPACK_IMPORTED_MODULE_3__.useRef)(null),decorationsRef=(0,react__WEBPACK_IMPORTED_MODULE_3__.useRef)([]),handleValidation=newValue=>{if(!editorRef.current?.getModel())return;let model=editorRef.current.getModel();monaco_editor__WEBPACK_IMPORTED_MODULE_2__.editor.setModelMarkers(model,"owner",[]),decorationsRef.current=editorRef.current.deltaDecorations(decorationsRef.current,[]);try{JSON.parse(newValue)}catch(err){let match=err.message.match(/position (\d+)/);if(match){let position=parseInt(match[1],10),pos=model.getPositionAt(position);monaco_editor__WEBPACK_IMPORTED_MODULE_2__.editor.setModelMarkers(model,"owner",[{startLineNumber:pos.lineNumber,startColumn:pos.column,endLineNumber:pos.lineNumber,endColumn:pos.column+1,message:err.message,severity:monaco_editor__WEBPACK_IMPORTED_MODULE_2__.MarkerSeverity.Error}]),decorationsRef.current=editorRef.current.deltaDecorations(decorationsRef.current,[{range:{startLineNumber:pos.lineNumber,startColumn:1,endLineNumber:pos.lineNumber,endColumn:model.getLineLength(pos.lineNumber)+1},options:{isWholeLine:!0,className:"bg-danger-highlight",glyphMarginClassName:"text-danger flex items-center justify-center",glyphMarginHoverMessage:{value:err.message}}}]),editorRef.current.revealLineInCenter(pos.lineNumber)}}};return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(lib_monaco_CodeEditorResizable__WEBPACK_IMPORTED_MODULE_9__.Y,{language:"json",value:value,height:400,onChange:newValue=>{readOnly||(onChange?.(newValue),handleValidation(null!=newValue?newValue:""))},onMount:editor=>{editorRef.current=editor,handleValidation(value)},options:{lineNumbers:"on",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"auto",verticalScrollbarSize:14},folding:!0,glyphMargin:!0,readOnly:readOnly}})};function HogFunctionTest(){var _testResult$logs;let{logicProps,canLoadSampleGlobals,hogFunction,template}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)(_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_10__.nM),{isTestInvocationSubmitting,testResult,expanded,sampleGlobalsLoadingAndNotCancelled,sampleGlobalsError,type,savedGlobals,testInvocation,testResultMode,sortedTestsResult,jsonError}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)((0,_hogFunctionTestLogic__WEBPACK_IMPORTED_MODULE_11__.g)(logicProps)),{submitTestInvocation,setTestResult,toggleExpanded,loadSampleGlobals,deleteSavedGlobals,setSampleGlobals,saveGlobals,setTestResultMode,cancelSampleGlobalsLoading}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useActions)((0,_hogFunctionTestLogic__WEBPACK_IMPORTED_MODULE_11__.g)(logicProps)),testResultsRef=(0,react__WEBPACK_IMPORTED_MODULE_3__.useRef)(null),inactive=!expanded,canMockFetchRequests=template?.id?.startsWith("template-")||hogFunction?.template?.id?.startsWith("template-");return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(kea_forms__WEBPACK_IMPORTED_MODULE_1__.Form,{logic:_hogFunctionTestLogic__WEBPACK_IMPORTED_MODULE_11__.g,props:logicProps,formKey:"testInvocation",enableFormOnSubmit:!0,children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{ref:testResultsRef,className:(0,clsx__WEBPACK_IMPORTED_MODULE_13__.default)("p-3 rounded border deprecated-space-y-2",expanded?"bg-surface-primary":"bg-surface-secondary",expanded?"min-h-120":""),children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"flex gap-2 justify-end items-center",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"flex-1 deprecated-space-y-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("h2",{className:"flex gap-2 items-center mb-0",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("span",{children:"Testing"})}),inactive?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("p",{children:"Click here to test your function with an example event"}):null]}),inactive?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Jp,{"data-attr":"expand-hog-testing",type:"secondary",onClick:()=>{toggleExpanded(),setTimeout(()=>{testResultsRef.current?.scrollIntoView({behavior:"smooth",block:"start"})},100)},children:"Start testing"}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:[testResult?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Jp,{type:"primary",onClick:()=>setTestResult(null),loading:isTestInvocationSubmitting,"data-attr":"clear-hog-test-result",children:"Clear test result"}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(lib_lemon_ui_LemonButton_More__WEBPACK_IMPORTED_MODULE_7__.T,{dropdown:{closeOnClickInside:!1},overlay:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:[canMockFetchRequests&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(lib_lemon_ui_LemonField__WEBPACK_IMPORTED_MODULE_8__.D,{name:"mock_async_functions",children:_ref3=>{let{value,onChange}=_ref3;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.f4,{onChange:v=>onChange(!v),checked:!value,"data-attr":"toggle-hog-test-mocking",className:"px-2 py-1",label:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.u,{title:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:"When disabled, async functions such as `fetch` will not be called. Instead they will be mocked out and logged."}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("span",{className:"flex gap-2",children:["Make real HTTP requests",(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_4__.IconInfo,{className:"text-lg"})]})})})}}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.p2,{})]}),savedGlobals.map((_ref4,index)=>{let{name,globals}=_ref4;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"flex justify-between w-full",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Jp,{"data-attr":"open-hog-test-data",onClick:()=>setSampleGlobals(globals),fullWidth:!0,className:"flex-1",children:name},index),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Jp,{"data-attr":"delete-hog-test-data",size:"small",icon:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_4__.IconX,{}),onClick:()=>deleteSavedGlobals(index),tooltip:"Delete saved test data"})]},index)}),testInvocation.globals&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Jp,{fullWidth:!0,"data-attr":"save-hog-test-data",onClick:()=>{let name=prompt("Name this test data");name&&saveGlobals(name,JSON.parse(testInvocation.globals))},disabledReason:(()=>{try{JSON.parse(testInvocation.globals)}catch{return"Invalid globals JSON"}})(),children:"Save test data"})]})}),canLoadSampleGlobals?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Jp,{type:"secondary",onClick:()=>{sampleGlobalsLoadingAndNotCancelled?cancelSampleGlobalsLoading():loadSampleGlobals()},tooltip:"Find the last event matching filters, and use it to populate the globals below.",icon:sampleGlobalsLoadingAndNotCancelled?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.$j,{}):void 0,children:sampleGlobalsLoadingAndNotCancelled?"Cancel loading":"Load new event"}):null,(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Jp,{type:"primary","data-attr":"test-hog-function",onClick:submitTestInvocation,loading:isTestInvocationSubmitting,children:"Test function"})]}),expanded&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Jp,{"data-attr":"hide-hog-testing",icon:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_4__.IconX,{}),onClick:()=>toggleExpanded(),tooltip:"Hide testing"})]})]}),expanded?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:testResult?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"deprecated-space-y-2","data-attr":"test-results",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Vp,{type:"success"===testResult.status?"success":"skipped"===testResult.status?"warning":"error",children:"success"===testResult.status?"Success":"skipped"===testResult.status?`${type.charAt(0).toUpperCase()+type.slice(1)} was skipped because the event did not match the filter criteria`:"Error"}),"transformation"===type&&"error"!==testResult.status?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"flex gap-2 justify-between items-center",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.HQ,{children:"Transformation result"}),sortedTestsResult?.hasDiff&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.P4,{size:"xsmall",options:[{value:"raw",label:"Output"},{value:"diff",label:"Diff"}],onChange:value=>setTestResultMode(value),value:testResultMode})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("p",{children:"Below you can see the event after the transformation has been applied."}),testResult.result?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:[!sortedTestsResult?.hasDiff&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Vp,{type:"info",children:"skipped"===testResult.status?"The event was not modified as it did not match the filter criteria.":"The event was unmodified by the transformation."}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(lib_monaco_CodeEditorResizable__WEBPACK_IMPORTED_MODULE_9__.Y,{language:"json",originalValue:sortedTestsResult?.hasDiff&&"diff"===testResultMode?sortedTestsResult?.input:void 0,value:sortedTestsResult?.output,height:400,options:{readOnly:!0,lineNumbers:"off",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"hidden",verticalScrollbarSize:0},folding:!0}})]}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Vp,{type:"warning",children:"The event was dropped by the transformation. If this is expected then great news! If not, you should double check the configuration."})]}):null,(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.HQ,{children:"Test invocation logs"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.g3,{dataSource:null!==(_testResult$logs=testResult.logs)&&void 0!==_testResult$logs?_testResult$logs:[],columns:[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:timestamp=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(lib_components_TZLabel__WEBPACK_IMPORTED_MODULE_6__.w,{time:timestamp}),width:0},{width:100,title:"Level",key:"level",dataIndex:"level"},{title:"Message",key:"message",dataIndex:"message",render:message=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("code",{className:"whitespace-pre-wrap",children:message})}],className:"ph-no-capture",rowKey:"timestamp",pagination:{pageSize:200,hideOnSinglePage:!0}})]}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"deprecated-space-y-2",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(lib_lemon_ui_LemonField__WEBPACK_IMPORTED_MODULE_8__.D,{name:"globals",children:_ref5=>{let{value,onChange}=_ref5;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{children:"Here are all the global variables you can use in your code:"}),sampleGlobalsError?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"text-warning",children:sampleGlobalsError}):null]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(HogFunctionTestEditor,{value:value,onChange:onChange,readOnly:sampleGlobalsLoadingAndNotCancelled})]})}})})}):null]}),jsonError&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_5__.Vp,{type:"error",children:["JSON Error: ",jsonError]})]})}},"../../frontend/src/scenes/hog-functions/configuration/hogFunctionTestLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{g:()=>hogFunctionTestLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),lib_api__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/utils.tsx"),lib_utils_getAppContext__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/utils/getAppContext.ts"),_models_groupsModel__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/models/groupsModel.ts"),_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx");let convertToTransformationEvent=result=>{var _result$properties;let properties=null!==(_result$properties=result.properties)&&void 0!==_result$properties?_result$properties:{};return delete properties.$transformations_failed,delete properties.$transformations_succeeded,delete properties.$transformations_skipped,{event:result.event,uuid:result.uuid,distinct_id:result.distinct_id,timestamp:result.timestamp,properties}},convertFromTransformationEvent=result=>(delete result.properties.$transformations_failed,delete result.properties.$transformations_succeeded,delete result.properties.$transformations_skipped,{event:result.event,uuid:result.uuid,distinct_id:result.distinct_id,timestamp:result.timestamp,properties:result.properties}),hogFunctionTestLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.key)(_ref=>{var _ref2;let{id,templateId}=_ref;return null!==(_ref2=null!=id?id:templateId)&&void 0!==_ref2?_ref2:"new"}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(id=>["scenes","pipeline","hogfunctions","hogFunctionTestLogic",id]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)(props=>({values:[(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.nM)(props),["configuration","templateId","configurationHasErrors","sampleGlobals","sampleGlobalsLoading","exampleInvocationGlobals","sampleGlobalsError","type","currentHogCode"],_models_groupsModel__WEBPACK_IMPORTED_MODULE_6__.$,["groupTypes"]],actions:[(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.nM)(props),["touchConfigurationField","loadSampleGlobalsSuccess","loadSampleGlobals","setSampleGlobals"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setTestResult:result=>({result}),toggleExpanded:expanded=>({expanded}),saveGlobals:(name,globals)=>({name,globals}),deleteSavedGlobals:index=>({index}),setTestResultMode:mode=>({mode}),receiveExampleGlobals:globals=>({globals}),setJsonError:error=>({error}),validateJson:(value,editor,decorations)=>({value,editor,decorations}),setDecorationIds:decorationIds=>({decorationIds}),cancelSampleGlobalsLoading:!0}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({expanded:[!1,{toggleExpanded:(state,_ref3)=>{let{expanded}=_ref3;return void 0===expanded?!state:expanded}}],testResult:[null,{setTestResult:(_,_ref4)=>{let{result}=_ref4;return result}}],testResultMode:["diff",{setTestResultMode:(_,_ref5)=>{let{mode}=_ref5;return mode}}],savedGlobals:[[],{persist:!0,prefix:`${(0,lib_utils_getAppContext__WEBPACK_IMPORTED_MODULE_5__.ev)()}__`},{saveGlobals:(state,_ref6)=>{let{name,globals}=_ref6;return[...state,{name,globals}]},deleteSavedGlobals:(state,_ref7)=>{let{index}=_ref7;return state.filter((_,i)=>i!==index)}}],jsonError:[null,{setJsonError:(_,_ref8)=>{let{error}=_ref8;return error}}],currentDecorationIds:[[],{setDecorationIds:(_,_ref9)=>{let{decorationIds}=_ref9;return decorationIds},setJsonError:()=>[]}],fetchCancelled:[!1,{loadSampleGlobals:()=>!1,cancelSampleGlobalsLoading:()=>!0,toggleExpanded:()=>!1}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref10=>{let{values,actions}=_ref10;return{loadSampleGlobalsSuccess:()=>{values.expanded&&!values.fetchCancelled&&values.sampleGlobals&&actions.receiveExampleGlobals(values.sampleGlobals)},setSampleGlobals:_ref11=>{let{sampleGlobals}=_ref11;actions.receiveExampleGlobals(sampleGlobals)},receiveExampleGlobals:_ref12=>{let{globals}=_ref12;if(globals){if("transformation"===values.type){let event=convertToTransformationEvent(globals.event);actions.setTestInvocationValue("globals",JSON.stringify(event,null,2))}else actions.setTestInvocationValue("globals",JSON.stringify(globals,null,2))}},validateJson:_ref13=>{let{value,editor,decorations}=_ref13;if(!editor?.getModel())return;let model=editor.getModel();try{JSON.parse(value),actions.setJsonError(null),editor.removeDecorations(decorations)}catch(err){actions.setJsonError(err.message);let match=err.message.match(/position (\d+)/);if(!match)return;let position=parseInt(match[1],10),pos=model.getPositionAt(position);editor.createDecorationsCollection([{range:{startLineNumber:pos.lineNumber,startColumn:pos.column,endLineNumber:pos.lineNumber,endColumn:pos.column+1},options:{isWholeLine:!0,className:"bg-danger-highlight",glyphMarginClassName:"text-danger flex items-center justify-center",glyphMarginHoverMessage:{value:err.message}}}]),editor.revealLineInCenter(pos.lineNumber)}},setTestResult:_ref14=>{let{result}=_ref14;result&&setTimeout(()=>{let testResults=document.querySelector('[data-attr="test-results"]');testResults&&testResults.scrollIntoView({behavior:"smooth",block:"start"});let editors=document.querySelectorAll('[data-attr="test-results"] .monaco-editor');if(editors.length>0&&values.sortedTestsResult?.hasDiff){let monacoEditor=editors[editors.length-1].querySelector(".monaco-scrollable-element");if(monacoEditor){let inputLines=values.sortedTestsResult.input.split("\n"),outputLines=values.sortedTestsResult.output.split("\n"),diffLineIndex=0;for(let i=0;i<Math.max(inputLines.length,outputLines.length);i++)if(inputLines[i]!==outputLines[i]){diffLineIndex=i;break}monacoEditor.scrollTop=Math.max(0,(diffLineIndex-2)*19)}}},100)},cancelSampleGlobalsLoading:()=>{}}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_1__.forms)(_ref15=>{let{props,actions,values}=_ref15;return{testInvocation:{defaults:{mock_async_functions:!1},alwaysShowErrors:!0,errors:_ref16=>{let{globals}=_ref16;return{globals:globals?(0,lib_utils__WEBPACK_IMPORTED_MODULE_4__.Cy)(globals)?void 0:"Invalid JSON":"Required"}},submit:async data=>{if(values.configurationHasErrors){let configLogic=(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.nM)(props),errorMessages=Object.entries(configLogic.values.inputFormErrors||{}).map(_ref17=>{let[key,error]=_ref17;return`${key}: ${"string"==typeof error?error:"Invalid format"}`}),message=errorMessages.length>0?`Please fix the following errors:
${errorMessages.join("\n")}`:"Please fix the configuration errors before testing.";_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_2__.UJ.error(message,{toastId:"hogfunction-validation-error"}),configLogic.actions.touchConfigurationField&&configLogic.actions.touchConfigurationField("inputs");return}let parsedData=(0,lib_utils__WEBPACK_IMPORTED_MODULE_4__.Cy)(data.globals),configuration=(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.r9)(values.configuration);configuration.template_id=values.templateId,configuration.hog=values.currentHogCode;let globals="transformation"===values.type?{event:parsedData}:parsedData;try{var _props$id;let res=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.hogFunctions.createTestInvocation(null!==(_props$id=props.id)&&void 0!==_props$id?_props$id:"new",{globals,mock_async_functions:data.mock_async_functions,configuration});"transformation"===values.type&&res.result&&(res.result=convertFromTransformationEvent(res.result)),actions.setTestResult(res)}catch(e){if(e?.data?.configuration?.filters?.non_field_errors){_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_2__.UJ.error(`Testing failed: ${e.data.configuration.filters.non_field_errors}`);return}_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_2__.UJ.error(`An unexpected server error occurred while testing the function: ${e}`)}}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(()=>({sortedTestsResult:[s=>[s.configuration,s.testResult,s.testInvocation],(configuration,testResult,testInvocation)=>{if(!testResult||"transformation"!==configuration.type)return null;let input=JSON.stringify(convertFromTransformationEvent(convertToTransformationEvent(JSON.parse(testInvocation.globals))),null,2),output=JSON.stringify(testResult.result,null,2);return{input,output,hasDiff:input!==output}}],sampleGlobalsLoadingAndNotCancelled:[s=>[s.sampleGlobalsLoading,s.fetchCancelled],(sampleGlobalsLoading,fetchCancelled)=>sampleGlobalsLoading&&!fetchCancelled]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref18=>{let{actions,values}=_ref18;actions.receiveExampleGlobals(values.exampleInvocationGlobals)})])}}]);
//# sourceMappingURL=62993.20d8b183.iframe.bundle.js.map