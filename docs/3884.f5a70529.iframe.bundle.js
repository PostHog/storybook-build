"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[3884],{"../../frontend/src/lib/components/CyclotronJob/integrations/IntegrationChoice.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{a:()=>IntegrationChoice});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.34.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),api=__webpack_require__("../../frontend/src/lib/api.ts"),IntegrationView=__webpack_require__("../../frontend/src/lib/integrations/IntegrationView.tsx"),integrationsLogic=__webpack_require__("../../frontend/src/lib/integrations/integrationsLogic.ts"),utils=__webpack_require__("../../frontend/src/lib/integrations/utils.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/index.ts");let databricksSetupModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["integrations","databricks","databricksSetupModalLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(()=>({actions:[integrationsLogic.a,["loadIntegrations"]]})),(0,lib.forms)(_ref=>{let{props,actions,values}=_ref;return{databricksIntegration:{defaults:{serverHostname:"",clientId:"",clientSecret:""},errors:_ref2=>{let{serverHostname,clientId,clientSecret}=_ref2;return{serverHostname:serverHostname.trim()?void 0:"Server Hostname is required",clientId:clientId.trim()?void 0:"Client ID is required",clientSecret:clientSecret.trim()?void 0:"Client Secret is required"}},submit:async()=>{try{let integration=await api.ZP.integrations.create({kind:"databricks",config:{server_hostname:values.databricksIntegration.serverHostname,client_id:values.databricksIntegration.clientId,client_secret:values.databricksIntegration.clientSecret}});actions.loadIntegrations(),LemonToast.U.success("Databricks integration created successfully!"),props.onComplete(integration.id)}catch(error){throw LemonToast.U.error(error.detail||"Failed to create Databricks integration"),error}}}}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let DatabricksSetupModal=props=>{let{isDatabricksIntegrationSubmitting}=(0,index_esm.useValues)(databricksSetupModalLogic(props)),{submitDatabricksIntegration}=(0,index_esm.useActions)(databricksSetupModalLogic(props));return(0,jsx_runtime.jsx)(src.fQ,{isOpen:props.isOpen,title:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(icons.zX,{}),(0,jsx_runtime.jsx)("span",{children:"Configure Databricks integration"})]}),onClose:props.onComplete,children:(0,jsx_runtime.jsx)(lib.Form,{logic:databricksSetupModalLogic,formKey:"databricksIntegration",children:(0,jsx_runtime.jsxs)("div",{className:"gap-4 flex flex-col",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"serverHostname",label:"Server Hostname",children:(0,jsx_runtime.jsx)(src.DF,{type:"text",placeholder:"dbc-xxxxxxxxx-xxxx.cloud.databricks.com"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"clientId",label:"Client ID",children:(0,jsx_runtime.jsx)(src.DF,{type:"text",placeholder:"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"clientSecret",label:"Client Secret",children:(0,jsx_runtime.jsx)(src.DF,{type:"password"})}),(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(src.Jp,{type:"primary",htmlType:"submit",loading:isDatabricksIntegrationSubmitting,onClick:submitDatabricksIntegration,children:"Connect"})})]})})})};var GitLabSetupModal=__webpack_require__("../../frontend/src/scenes/integrations/gitlab/GitLabSetupModal.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),ChannelSetupModal=__webpack_require__("../../products/workflows/frontend/Channels/ChannelSetupModal.tsx");function IntegrationChoice(_ref){let{onChange,value,schema,integration,redirectUrl,beforeRedirect}=_ref,{integrationsLoading,integrations,newIntegrationModalKind}=(0,index_esm.useValues)(integrationsLogic.a),{newGoogleCloudKey,openNewIntegrationModal,closeNewIntegrationModal}=(0,index_esm.useActions)(integrationsLogic.a),integrationsOfKind=integrations?.filter(x=>x.kind===integration),integrationKind=integrationsOfKind?.find(integration=>integration.id===value);if(!integration)return null;if(integrationsLoading)return(0,jsx_runtime.jsx)(src.yW,{className:"h-10"});let kindName=(0,utils.C)(integration);function uploadKey(kind){let input=document.createElement("input");input.type="file",input.accept=".json",input.onchange=async e=>{let file=e.target.files?.[0];file&&newGoogleCloudKey(kind,file,integration=>onChange?.(integration.id))},input.click()}let button=(0,jsx_runtime.jsx)(src.d6,{items:[integrationsOfKind?.length?{items:[...integrationsOfKind?.map(integration=>({icon:jsx_runtime.jsx("img",{src:integration.icon_url,className:"w-6 h-6 rounded"}),onClick:()=>onChange?.(integration.id),active:integration.id===value,label:integration.display_name}))||[]]}:null,["google-pubsub","google-cloud-storage"].includes(integration)?{items:[{onClick:()=>uploadKey(integration),label:"Upload Google Cloud .json key file"}]}:["email"].includes(integration)?{items:[{to:urls.j.workflows("channels"),label:"Configure new email sender domain"}]}:["twilio"].includes(integration)?{items:[{label:"Configure new Twilio account",onClick:()=>openNewIntegrationModal("twilio")}]}:["databricks"].includes(integration)?{items:[{label:"Configure new Databricks account",onClick:()=>openNewIntegrationModal("databricks")}]}:["gitlab"].includes(integration)?{items:[{label:"Configure new GitLab account",onClick:()=>openNewIntegrationModal("gitlab")}]}:{items:[{to:api.ZP.integrations.authorizeUrl({kind:integration,next:redirectUrl}),disableClientSideRouting:!0,onClick:beforeRedirect,label:integrationsOfKind?.length?`Connect to a different integration for ${kindName}`:`Connect to ${kindName}`}]},{items:[{to:urls.j.settings("project-integrations"),label:"Manage integrations",sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconExternal,{})},value?{onClick:()=>onChange?.(null),label:"Clear",sideIcon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{})}:null]}],children:integrationKind?(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",children:"Change"}):(0,jsx_runtime.jsxs)(src.Jp,{type:"secondary",children:["Choose ",kindName," connection"]})});return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[integrationKind?(0,jsx_runtime.jsx)(IntegrationView.K,{schema:schema,integration:integrationKind,suffix:button}):button,(0,jsx_runtime.jsx)(ChannelSetupModal.A,{isOpen:"twilio"===newIntegrationModalKind,channelType:"twilio",integration:integrationKind||void 0,onComplete:closeNewIntegrationModal}),(0,jsx_runtime.jsx)(DatabricksSetupModal,{isOpen:"databricks"===newIntegrationModalKind,integration:integrationKind||void 0,onComplete:integrationId=>{integrationId&&onChange?.(integrationId),closeNewIntegrationModal()}}),(0,jsx_runtime.jsx)(GitLabSetupModal.B,{isOpen:"gitlab"===newIntegrationModalKind,onComplete:closeNewIntegrationModal})]})}},"../../products/workflows/frontend/Channels/ChannelSetupModal.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>ChannelSetupModal});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.34.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),FlaggedFeature=__webpack_require__("../../frontend/src/lib/components/FlaggedFeature.tsx"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),integrationsLogic=__webpack_require__("../../frontend/src/lib/integrations/integrationsLogic.ts"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/index.ts");let EMAIL_REGEX=/^[^\s@]+@[^\s@]+\.[^\s@]+$/i,emailSetupModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","workflows","frontend","EmailSetup","emailSetupModalLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{integration}=_ref;return integration?`workflows-sender-setup-${integration.id}`:"workflows-sender-setup-new"}),(0,index_esm.connect)(()=>({values:[integrationsLogic.a,["integrations","integrationsLoading"]],actions:[integrationsLogic.a,["loadIntegrations"]]})),(0,lib.forms)(_ref2=>{let{actions}=_ref2;return{emailSender:{defaults:{provider:"ses",email:"",name:""},errors:_ref3=>{let emailError,{email,name,provider}=_ref3;return email||(emailError="Email is required"),EMAIL_REGEX.test(email)||(emailError="Invalid email format"),{email:emailError,name:name?void 0:"Name is required",provider:provider?void 0:"Provider is required"}},submit:async config=>{try{let integration=await api.ZP.integrations.create({kind:"email",config:config});return actions.loadIntegrations(),actions.setIntegration(integration),actions.verifyDomain(),config}catch(error){throw(error instanceof api.MS||error&&"object"==typeof error&&"detail"in error)&&LemonToast.U.error(`Failed to create email sender: ${error.detail||"Please try again."}`),error}}}}}),(0,kea_loaders_lib.loaders)(_ref4=>{let{values}=_ref4;return{integration:{setIntegration:integration=>integration},verification:{verifyDomain:async()=>api.ZP.integrations.verifyEmail(values.integration.id)}}}),(0,index_esm.selectors)({dnsRecords:[s=>[s.verification],verification=>verification?.status||null]}),(0,index_esm.listeners)(_ref5=>{let{props,values,actions}=_ref5;return{submitEmailSenderSuccess:()=>{actions.verifyDomain()},verifyDomainSuccess:_ref6=>{let{verification}=_ref6;"success"===verification.status&&(LemonToast.U.success("Domain verified successfully!"),actions.loadIntegrations(),props.onComplete(values.integration.id))}}}),(0,index_esm.afterMount)(_ref7=>{let{props,actions}=_ref7;props.integration&&(actions.setIntegration(props.integration),actions.verifyDomain())})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let EmailSetupModal=props=>{let{integration,integrationLoading,verification,verificationLoading}=(0,index_esm.useValues)(emailSetupModalLogic(props)),{verifyDomain,submitEmailSender}=(0,index_esm.useActions)(emailSetupModalLogic(props)),modalContent=(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});return modalContent=integration?(0,jsx_runtime.jsxs)("div",{className:"space-y-2 max-w-[60rem]",children:[(0,jsx_runtime.jsx)("p",{className:"text-sm text-muted",children:"These DNS records are required to verify ownership of your domain. They also ensure your emails are delivered to inboxes and not marked as spam."}),(0,jsx_runtime.jsx)("p",{className:"mb-2 font-semibold",children:"Note: It can take up to 48 hours for DNS changes to propagate."}),(0,jsx_runtime.jsx)("div",{className:"overflow-x-auto",children:(0,jsx_runtime.jsxs)("table",{className:"w-full border-collapse",children:[(0,jsx_runtime.jsx)("thead",{children:(0,jsx_runtime.jsxs)("tr",{className:"border-b",children:[(0,jsx_runtime.jsx)("th",{className:"py-2 text-left",children:"Type"}),(0,jsx_runtime.jsx)("th",{className:"py-2 text-left",children:"Hostname"}),(0,jsx_runtime.jsx)("th",{className:"py-2 text-left",children:"Value"}),(0,jsx_runtime.jsx)("th",{className:"py-2 text-left",children:"Status"})]})}),(0,jsx_runtime.jsx)("tbody",{children:verification?.dnsRecords?.map((record,index)=>jsx_runtime.jsxs("tr",{className:"border-b",children:[jsx_runtime.jsx("td",{className:"py-2",children:record.recordType}),jsx_runtime.jsx("td",{className:"py-2 max-w-[8rem]",children:jsx_runtime.jsxs("div",{className:"flex gap-1 justify-between items-center break-all text-wrap",children:[jsx_runtime.jsx("span",{children:record.recordHostname}),jsx_runtime.jsx(src.Jp,{size:"small",icon:jsx_runtime.jsx(posthog_icons_es.IconCopy,{}),onClick:()=>{navigator.clipboard.writeText(record.recordHostname),src.UJ.success("Hostname copied to clipboard")},tooltip:"Copy hostname"})]})}),jsx_runtime.jsx("td",{className:"py-2 max-w-[8rem]",children:jsx_runtime.jsxs("div",{className:"flex gap-1 justify-between items-center break-all text-wrap",children:[jsx_runtime.jsx("span",{children:record.recordValue}),jsx_runtime.jsx(src.Jp,{size:"small",icon:jsx_runtime.jsx(posthog_icons_es.IconCopy,{}),onClick:()=>{navigator.clipboard.writeText(record.recordValue),src.UJ.success("Value copied to clipboard")},tooltip:"Copy value"})]})}),jsx_runtime.jsx("td",{className:"py-2 w-[10rem]",children:verificationLoading?jsx_runtime.jsx(src.$j,{className:"text-lg"}):"pending"===record.status?jsx_runtime.jsxs("div",{className:"flex gap-1 items-center",children:[jsx_runtime.jsx(posthog_icons_es.IconWarning,{className:"size-6 text-warning"})," Not present"]}):"success"===record.status?jsx_runtime.jsxs("div",{className:"flex gap-1 items-center",children:[jsx_runtime.jsx(posthog_icons_es.IconCheckCircle,{className:"size-6 text-success"})," Verified"]}):jsx_runtime.jsx(src.u,{title:"We are unable to verify this record at the moment",children:jsx_runtime.jsxs("div",{className:"flex gap-1 items-center",children:[jsx_runtime.jsx(posthog_icons_es.IconQuestion,{className:"size-6 text-muted"})," Unknown"]})})})]},index))})]})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:verifyDomain,disabledReason:verificationLoading?"Verifying...":void 0,loading:verificationLoading,children:"Verify DNS records"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>props.onComplete(integration.id),tooltip:"You will not be able to send emails until you verify the DNS records",children:"Finish later"})]})]}):(0,jsx_runtime.jsx)(lib.Form,{logic:emailSetupModalLogic,formKey:"emailSender",children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(FlaggedFeature.P,{flag:"messaging-ses",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"provider",label:"Provider",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"ses",label:"AWS SES"},{value:"mailjet",label:"Mailjet"},{value:"maildev",label:"Maildev"}]})})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{type:"text",placeholder:"John Doe",disabled:integrationLoading})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"email",label:"Email",children:(0,jsx_runtime.jsx)(src.DF,{type:"text",placeholder:"example@example.com",disabled:integrationLoading})}),(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(src.Jp,{type:"primary",htmlType:"submit",disabledReason:integrationLoading?"Creating sender...":void 0,loading:integrationLoading,onClick:submitEmailSender,children:"Continue"})})]})}),(0,jsx_runtime.jsx)(src.fQ,{title:"Configure email sender",width:"auto",onClose:props.onComplete,children:modalContent})};var icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts");let slackSetupModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","workflows","frontend","SlackSetup","slackSetupModalLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(()=>({values:[integrationsLogic.a,["integrations","integrationsLoading","slackAvailable"],userLogic.userLogic,["user"]],actions:[integrationsLogic.a,["loadIntegrations"]]})),(0,lib.forms)(_ref=>{let{props,actions,values}=_ref;return{slackIntegration:{defaults:{botToken:"",channelId:""},errors:_ref2=>{let{botToken,channelId}=_ref2;return{botToken:botToken?void 0:"Bot Token is required",channelId:channelId?void 0:"Channel ID is required"}},submit:async()=>{try{let integration=await api.ZP.integrations.create({kind:"slack",config:{bot_token:values.slackIntegration.botToken,channel_id:values.slackIntegration.channelId}});actions.loadIntegrations(),LemonToast.U.success("Slack integration created successfully!"),props.onComplete(integration.id)}catch(error){throw LemonToast.U.error("Failed to create Slack integration"),error}}}}})]),SlackSetupModal=props=>{let logic=slackSetupModalLogic(props),{slackAvailable}=(0,index_esm.useValues)(logic);return(0,jsx_runtime.jsx)(src.fQ,{title:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(icons.gx,{}),(0,jsx_runtime.jsx)("span",{children:"Configure Slack integration"})]}),onClose:()=>props.onComplete(),footer:(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>props.onComplete(),children:"Close"})}),children:(0,jsx_runtime.jsx)("div",{className:"max-w-[400px]",children:slackAvailable?(0,jsx_runtime.jsx)(src.rU,{to:api.ZP.integrations.authorizeUrl({kind:"slack"}),disableClientSideRouting:!0,children:(0,jsx_runtime.jsx)("img",{alt:"Connect to Slack workspace",height:"40",width:"139",src:"https://platform.slack-edge.com/img/add_to_slack.png",srcSet:"https://platform.slack-edge.com/img/add_to_slack.png 1x, https://platform.slack-edge.com/img/add_to_slack@2x.png 2x"})}):(0,jsx_runtime.jsx)("p",{className:"text-secondary",children:"This PostHog instance is not configured for Slack. Please contact the instance owner to configure it."})})})},twilioSetupModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","workflows","frontend","TwilioSetup","twilioSetupModalLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(()=>({actions:[integrationsLogic.a,["loadIntegrations"]]})),(0,lib.forms)(_ref=>{let{props,actions,values}=_ref;return{twilioIntegration:{defaults:{accountSid:"",authToken:""},errors:_ref2=>{let{accountSid,authToken}=_ref2;return{accountSid:accountSid.trim()?void 0:"Account SID is required",authToken:authToken.trim()?void 0:"Auth Token is required"}},submit:async()=>{try{let integration=await api.ZP.integrations.create({kind:"twilio",config:{account_sid:values.twilioIntegration.accountSid,auth_token:values.twilioIntegration.authToken}});actions.loadIntegrations(),LemonToast.U.success("Twilio channel created successfully!"),props.onComplete(integration.id)}catch(error){throw LemonToast.U.error(error.detail||"Failed to create Twilio channel"),error}}}}})]),TwilioSetupModal=props=>{let{isTwilioIntegrationSubmitting}=(0,index_esm.useValues)(twilioSetupModalLogic(props)),{submitTwilioIntegration}=(0,index_esm.useActions)(twilioSetupModalLogic(props));return(0,jsx_runtime.jsx)(src.fQ,{title:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(icons.i5,{}),(0,jsx_runtime.jsx)("span",{children:"Configure Twilio SMS channel"})]}),onClose:props.onComplete,children:(0,jsx_runtime.jsx)(lib.Form,{logic:twilioSetupModalLogic,formKey:"twilioIntegration",children:(0,jsx_runtime.jsxs)("div",{className:"gap-4 flex flex-col",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"accountSid",label:"Account SID",children:(0,jsx_runtime.jsx)(src.DF,{type:"text",placeholder:"ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"authToken",label:"Auth token",children:(0,jsx_runtime.jsx)(src.DF,{type:"password"})}),(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(src.Jp,{type:"primary",htmlType:"submit",loading:isTwilioIntegrationSubmitting,onClick:submitTwilioIntegration,children:"Connect"})})]})})})};function ChannelSetupModal(_ref){let{isOpen,channelType,integration,onComplete}=_ref;if(!isOpen||!channelType)return null;let modalProps={integration,onComplete};switch(channelType){case"email":return(0,jsx_runtime.jsx)(EmailSetupModal,{...modalProps});case"slack":return(0,jsx_runtime.jsx)(SlackSetupModal,{...modalProps});case"twilio":return(0,jsx_runtime.jsx)(TwilioSetupModal,{...modalProps});default:return null}}}}]);