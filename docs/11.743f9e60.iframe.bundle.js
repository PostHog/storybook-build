(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{"./frontend/src/scenes/apps/appMetricsSceneLogic.ts":function(X,T,n){"use strict";n.r(T),n.d(T,"AppMetricsTab",function(){return l}),n.d(T,"appMetricsSceneLogic",function(){return V});var h=n("./node_modules/@babel/runtime/helpers/slicedToArray.js"),R=n.n(h),U=n("./node_modules/@babel/runtime/helpers/asyncToGenerator.js"),v=n.n(U),B=n("./node_modules/@babel/runtime/regenerator/index.js"),d=n.n(B),K=n("./node_modules/core-js/modules/es.array.iterator.js"),Y=n.n(K),W=n("./node_modules/core-js/modules/es.object.to-string.js"),Z=n.n(W),H=n("./node_modules/core-js/modules/web.dom-collections.iterator.js"),w=n.n(H),F=n("./node_modules/core-js/modules/es.array.concat.js"),k=n.n(F),x=n("./node_modules/core-js/modules/es.function.name.js"),q=n.n(x),S=n("./node_modules/core-js/modules/es.array.filter.js"),ee=n.n(S),J=n("./node_modules/core-js/modules/es.array.includes.js"),re=n.n(J),$=n("./node_modules/core-js/modules/es.string.includes.js"),te=n.n($),G=n("./node_modules/core-js/modules/es.number.constructor.js"),ne=n.n(G),f=n("./node_modules/kea/lib/index.esm.js"),O=n("./node_modules/kea-loaders/lib/index.js"),oe=n.n(O),p=n("./frontend/src/scenes/urls.ts"),N=n("./frontend/src/types.ts"),D=n("./frontend/src/lib/api.ts"),M=n("./frontend/src/scenes/teamLogic.tsx"),m=n("./node_modules/kea-router/lib/index.js"),se=n.n(m),P=n("./frontend/src/lib/utils.tsx"),b=n("./frontend/src/scenes/plugins/edit/interface-jobs/PluginJobConfiguration.tsx"),z=n("./frontend/src/scenes/plugins/edit/interface-jobs/interfaceJobsLogic.ts"),I=n("./frontend/src/lib/dayjs.ts"),Q=n("./frontend/src/scenes/userLogic.ts"),l;(function(r){r.ProcessEvent="processEvent",r.OnEvent="onEvent",r.ExportEvents="exportEvents",r.ScheduledTask="scheduledTask",r.HistoricalExports="historical_exports",r.History="history"})(l||(l={}));var j="-30d",A=[l.ProcessEvent,l.OnEvent,l.ExportEvents,l.ScheduledTask],V=Object(f.kea)([Object(f.path)(function(r){return["scenes","apps","appMetricsSceneLogic",r]}),Object(f.props)({}),Object(f.key)(function(r){return r.pluginConfigId}),Object(f.actions)({setActiveTab:function(t){return{tab:t}},setDateFrom:function(t){return{dateFrom:t}},openErrorDetailsModal:function(t,o,e){return{errorType:t,category:o,jobId:e}},closeErrorDetailsModal:!0,openHistoricalExportModal:!0}),Object(f.reducers)({activeTab:[null,{setActiveTab:function(t,o){var e=o.tab;return e}}],selectedDateFrom:[null,{setDateFrom:function(t,o){var e=o.dateFrom;return e}}],errorDetailsModalError:[null,{openErrorDetailsModal:function(t,o){var e=o.errorType;return e},closeErrorDetailsModal:function(){return null}}]}),Object(O.loaders)(function(r){var t=r.values,o=r.props;return{pluginConfig:[null,{loadPluginConfig:function(){var e=v()(d.a.mark(function s(){return d.a.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return u.next=2,D.b.get("api/projects/".concat(M.a.values.currentTeamId,"/plugin_configs/").concat(o.pluginConfigId));case 2:return u.abrupt("return",u.sent);case 3:case"end":return u.stop()}},s)}));function a(){return e.apply(this,arguments)}return a}()}],appMetricsResponse:[null,{loadMetrics:function(){var e=v()(d.a.mark(function s(){var i;return d.a.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(!(t.activeTab&&t.dateFrom)){c.next=5;break}return i=Object(P.Gb)({category:t.activeTab,date_from:t.dateFrom}),c.next=4,D.b.get("api/projects/".concat(M.a.values.currentTeamId,"/app_metrics/").concat(o.pluginConfigId,"?").concat(i));case 4:return c.abrupt("return",c.sent);case 5:case"end":return c.stop()}},s)}));function a(){return e.apply(this,arguments)}return a}()}],historicalExports:[[],{loadHistoricalExports:function(){var e=v()(d.a.mark(function s(){var i,u;return d.a.wrap(function(_){for(;;)switch(_.prev=_.next){case 0:return _.next=2,D.b.get("api/projects/".concat(M.a.values.currentTeamId,"/app_metrics/").concat(o.pluginConfigId,"/historical_exports"));case 2:return i=_.sent,u=i.results,_.abrupt("return",u);case 5:case"end":return _.stop()}},s)}));function a(){return e.apply(this,arguments)}return a}()}],errorDetails:[[],{openErrorDetailsModal:function(){var e=v()(d.a.mark(function s(i){var u,c,_,C,y,L;return d.a.wrap(function(E){for(;;)switch(E.prev=E.next){case 0:return u=i.category,c=i.jobId,_=i.errorType,C=Object(P.Gb)({category:u,job_id:c,error_type:_}),E.next=4,D.b.get("api/projects/".concat(M.a.values.currentTeamId,"/app_metrics/").concat(o.pluginConfigId,"/error_details?").concat(C));case 4:return y=E.sent,L=y.result,E.abrupt("return",L);case 7:case"end":return E.stop()}},s)}));function a(s){return e.apply(this,arguments)}return a}()}]}}),Object(f.selectors)(function(r){var t=r.values,o=r.actions;return{breadcrumbs:[function(e){return[e.pluginConfig,function(a,s){return s.pluginConfigId}]},function(e,a){var s;return[{name:"Apps",path:p.a.projectApps()},{name:e==null||(s=e.plugin_info)===null||s===void 0?void 0:s.name,path:p.a.appMetrics(a)}]}],shouldShowAppMetrics:[function(){return[Q.a.selectors.hasAvailableFeature]},function(e){return e(N.d.APP_METRICS)}],defaultTab:[function(e){return[e.pluginConfig]},function(){var e;return(e=A.filter(function(a){return t.showTab(a)})[0])!==null&&e!==void 0?e:l.History}],currentTime:[function(){return[]},function(){return Date.now()}],defaultDateFrom:[function(e){return[e.pluginConfig,e.currentTime]},function(e,a){if(!(e!=null&&e.created_at))return j;var s=I.a.utc(e.created_at),i=Object(I.a)(a).diff(s,"days",!0);return i<=1?"-24h":i<=7?"-7d":j}],dateFrom:[function(e){return[e.selectedDateFrom,e.defaultDateFrom]},function(e,a){var s;return(s=e!=null?e:a)!==null&&s!==void 0?s:j}],showTab:[function(e){return[e.shouldShowAppMetrics]},function(e){return function(a){if(t.pluginConfigLoading||!t.pluginConfig||!t.pluginConfig.plugin_info.capabilities)return!1;var s=t.pluginConfig.plugin_info.capabilities,i=s.methods.includes("exportEvents");return a===l.History?!0:e?a===l.HistoricalExports?i:a===l.OnEvent&&i?!1:a===l.ScheduledTask?!i&&["runEveryMinute","runEveryHour","runEveryDay"].some(function(u){return s.scheduled_tasks.includes(u)}):s.methods.includes(a):!1}}],interfaceJobsProps:[function(e){return[e.pluginConfig]},function(e){return!e||!e.plugin_info.public_jobs||!(e!=null&&e.enabled)?null:{jobName:b.b,jobSpec:e.plugin_info.public_jobs[b.b],pluginConfigId:e.id,pluginId:e.plugin,onSubmit:o.loadHistoricalExports}}],hasRunningExports:[function(e){return[e.historicalExports]},function(e){return e.some(function(a){return a.status=="not_finished"})}]}}),Object(f.listeners)(function(r){var t=r.values,o=r.actions;return{loadPluginConfigSuccess:function(){t.activeTab||o.setActiveTab(t.defaultTab)},setActiveTab:function(a){var s=a.tab;s===l.HistoricalExports?o.loadHistoricalExports():s!==l.History&&o.loadMetrics()},setDateFrom:function(){o.loadMetrics()},openHistoricalExportModal:function(){t.interfaceJobsProps&&Object(z.a)(t.interfaceJobsProps).actions.setIsJobModalOpen(!0)}}}),Object(m.actionToUrl)(function(r){var t=r.values,o=r.props;return{setActiveTab:function(){return g(t,o)},setDateFrom:function(){return g(t,o)},openErrorDetailsModal:function(){return g(t,o)},closeErrorDetailsModal:function(){return g(t,o)}}}),Object(m.urlToAction)(function(r){var t=r.values,o=r.actions,e=r.props;return{"/app/:pluginConfigId/:page":function(s,i){if(e.pluginConfigId===Number(s.pluginConfigId))if(t.pluginConfig||o.loadPluginConfig(),s.page===l.HistoricalExports)o.setActiveTab(l.HistoricalExports);else if(s.page===l.History)o.setActiveTab(l.History);else if(i.tab&&A.includes(i.tab)&&i.tab!==t.activeTab?o.setActiveTab(i.tab):!t.pluginConfigLoading&&t.activeTab!==t.defaultTab&&o.setActiveTab(t.defaultTab),i.from&&t.selectedDateFrom!==i.from&&o.setDateFrom(i.from),i.error){var u=R()(i.error,2),c=u[0],_=u[1];t.errorDetailsModalError!==c&&(o.setActiveTab(_),o.openErrorDetailsModal(c,_))}else o.closeErrorDetailsModal()}}})]);function g(r,t){if(r.activeTab===l.HistoricalExports)return p.a.appHistoricalExports(t.pluginConfigId);if(r.activeTab===l.History)return p.a.appHistory(t.pluginConfigId,m.router.values.searchParams);var o={};return r.activeTab&&r.activeTab!==r.defaultTab&&(o.tab=r.activeTab),r.selectedDateFrom&&(o.from=r.selectedDateFrom),r.errorDetailsModalError&&r.activeTab&&(o.error=[r.errorDetailsModalError,r.activeTab]),p.a.appMetrics(t.pluginConfigId,o)}}}]);
