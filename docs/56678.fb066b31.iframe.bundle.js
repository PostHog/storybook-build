"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[56678],{"../../products/workflows/frontend/WorkflowsScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{WorkflowsScene:()=>WorkflowsScene,scene:()=>scene,workflowSceneLogic:()=>workflowSceneLogic});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.35.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),api=__webpack_require__("../../frontend/src/lib/api.ts"),useFeatureFlag=__webpack_require__("../../frontend/src/lib/hooks/useFeatureFlag.ts"),integrationsLogic=__webpack_require__("../../frontend/src/lib/integrations/integrationsLogic.ts"),LemonTabs=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTabs/index.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),sceneTypes=__webpack_require__("../../frontend/src/scenes/sceneTypes.ts"),scenes=__webpack_require__("../../frontend/src/scenes/scenes.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),SceneContent=__webpack_require__("../../frontend/src/layout/scenes/components/SceneContent.tsx"),SceneTitleSection=__webpack_require__("../../frontend/src/layout/scenes/components/SceneTitleSection.tsx"),ProductIntroduction=__webpack_require__("../../frontend/src/lib/components/ProductIntroduction/ProductIntroduction.tsx"),hedgehogs=__webpack_require__("../../frontend/src/lib/components/hedgehogs.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let isVerificationRequired=integration=>["email"].includes(integration.kind),isVerified=integration=>"email"!==integration.kind||!0===integration.config.verified;function IntegrationEmailDomainView(_ref){let{integration}=_ref,{openSetupModal,deleteIntegration}=(0,index_esm.useActions)(integrationsLogic.a),{domain,integrations}=integration,verified=integrations.every(isVerified),verificationRequired=integrations.some(isVerificationRequired);return(0,jsx_runtime.jsxs)("div",{className:"rounded border bg-surface-primary",children:[(0,jsx_runtime.jsx)("div",{className:"flex flex-1 justify-between items-center p-2",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 gap-4 items-center ml-2",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconLetter,{className:"w-8 h-8"}),(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)("span",{children:(0,jsx_runtime.jsx)("strong",{children:domain})}),verificationRequired&&(0,jsx_runtime.jsx)(src.u,{title:verified?"This channel is ready to use":"You cannot send messages from this channel until it has been verified",children:(0,jsx_runtime.jsx)(src.oe,{type:verified?"success":"warning",children:verified?"Verified":"Unverified"})})]})}),verificationRequired&&!verified&&(0,jsx_runtime.jsx)(src.Jp,{type:"primary",size:"small",onClick:()=>{openSetupModal(integrations[0],integrations[0].kind)},icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconWarning,{}),children:"Verify"})]})}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col",children:integrations.map(integration=>(0,jsx_runtime.jsxs)("div",{className:"flex items-center px-4 py-2 border-t",children:[(0,jsx_runtime.jsxs)("span",{className:"flex-1",children:[integration.config.name," <",integration.config.email,">"]}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",status:"danger",onClick:()=>{deleteIntegration(integration.id)},children:"Remove"})]},integration.id))})]})}function EmailIntegrationsList(){let{integrationsLoading,domainGroupedEmailIntegrations}=(0,index_esm.useValues)(integrationsLogic.a);return(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:integrationsLoading?(0,jsx_runtime.jsx)(src.yW,{className:"h-10"}):domainGroupedEmailIntegrations.map(integration=>(0,jsx_runtime.jsx)(IntegrationEmailDomainView,{integration:integration},integration.domain))})}var IntegrationsList=__webpack_require__("../../frontend/src/lib/integrations/IntegrationsList.tsx"),ChannelSetupModal=__webpack_require__("../../products/workflows/frontend/Channels/ChannelSetupModal.tsx");let MESSAGING_CHANNEL_TYPES=["email","slack","twilio"];function MessageChannels(){var _integrations$filter;let{setupModalOpen,integrations,integrationsLoading,setupModalType,selectedIntegration}=(0,index_esm.useValues)(integrationsLogic.a),{openSetupModal,closeSetupModal}=(0,index_esm.useActions)(integrationsLogic.a),allWorkflowIntegrations=null!==(_integrations$filter=integrations?.filter(integration=>MESSAGING_CHANNEL_TYPES.includes(integration.kind)))&&void 0!==_integrations$filter?_integrations$filter:[],showProductIntroduction=!integrationsLoading&&!allWorkflowIntegrations.length;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ChannelSetupModal.A,{isOpen:setupModalOpen,channelType:setupModalType,integration:selectedIntegration||void 0,onComplete:()=>closeSetupModal()}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-4",children:[integrationsLoading&&!integrations?.length&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.yW,{className:"h-20"}),(0,jsx_runtime.jsx)(src.yW,{className:"h-20"}),(0,jsx_runtime.jsx)(src.yW,{className:"h-20"})]}),showProductIntroduction&&(0,jsx_runtime.jsx)(ProductIntroduction.C,{productName:"Workflows channel",thingName:"channel integration",description:"Configure channels to send messages from.",docsURL:"https://posthog.com/docs/workflows/configure-channels",action:()=>openSetupModal(void 0,"email"),customHog:hedgehogs.MicrophoneHog,isEmpty:!0}),(0,jsx_runtime.jsx)(EmailIntegrationsList,{}),(0,jsx_runtime.jsx)(IntegrationsList.B,{titleText:"",onlyKinds:MESSAGING_CHANNEL_TYPES.filter(type=>"email"!==type)})]})]})}var userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),kea_forms_lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonFileInput=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonFileInput/index.ts"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/index.ts"),optOutCategoriesLogic=__webpack_require__("../../products/workflows/frontend/OptOuts/optOutCategoriesLogic.ts");let customerIOImportLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","workflows","customerIOImportLogic"]),(0,index_esm.actions)({openImportModal:!0,closeImportModal:!0,resetImport:!0,setImportProgress:importProgress=>({importProgress}),setImportError:error=>({error}),setCSVFile:file=>({file}),uploadCSV:!0,setCSVProgress:csvProgress=>({csvProgress}),setShowCSVPhase:show=>({show}),setIsUploadingCSV:isUploading=>({isUploading})}),(0,index_esm.reducers)({isImportModalOpen:[!1,{openImportModal:()=>!0,closeImportModal:()=>!1}],importProgress:[null,{setImportProgress:(_,_ref)=>{let{importProgress}=_ref;return importProgress},resetImport:()=>null,closeImportModal:()=>null}],importError:[null,{setImportError:(_,_ref2)=>{let{error}=_ref2;return error},submitImportFormFailure:(_,_ref3)=>{let{error}=_ref3;return error&&"object"==typeof error&&"detail"in error?error.detail:"Import failed. Please check your API key and try again."},submitImportFormSuccess:()=>null,resetImport:()=>null,closeImportModal:()=>null}],csvFile:[null,{setCSVFile:(_,_ref4)=>{let{file}=_ref4;return file},resetImport:()=>null,closeImportModal:()=>null}],csvProgress:[null,{setCSVProgress:(_,_ref5)=>{let{csvProgress}=_ref5;return csvProgress},resetImport:()=>null,closeImportModal:()=>null}],showCSVPhase:[!1,{setShowCSVPhase:(_,_ref6)=>{let{show}=_ref6;return show},resetImport:()=>!1,closeImportModal:()=>!1}],isUploadingCSV:[!1,{setIsUploadingCSV:(_,_ref7)=>{let{isUploading}=_ref7;return isUploading},resetImport:()=>!1,closeImportModal:()=>!1}]}),(0,kea_forms_lib.forms)(_ref8=>{let{actions}=_ref8;return{importForm:{defaults:{app_api_key:""},submit:async _ref9=>{let{app_api_key}=_ref9;try{let response=await new api.xm().messagingCategoriesImportFromCustomerIO().create({data:{app_api_key}});return actions.setImportProgress(response),response}catch(error){throw error}}}}}),(0,index_esm.selectors)({isImporting:[s=>[s.isImportFormSubmitting],isImportFormSubmitting=>isImportFormSubmitting],isImportComplete:[s=>[s.importProgress],importProgress=>importProgress?.status==="completed"],isImportFailed:[s=>[s.importProgress],importProgress=>importProgress?.status==="failed"]}),(0,index_esm.listeners)(_ref10=>{let{actions}=_ref10;return{setImportProgress:_ref11=>{let{importProgress}=_ref11;if("completed"===importProgress.status){let categoriesCreated=importProgress.categories_created||0,globallyUnsubscribed=importProgress.globally_unsubscribed_count||0;LemonToast.U.success(`API import completed! Created ${categoriesCreated} categories and imported ${globallyUnsubscribed} globally unsubscribed users.`),actions.setShowCSVPhase(!0),window.location.pathname.includes("workflows")&&optOutCategoriesLogic.O.actions.loadCategories()}else if("failed"===importProgress.status){let errorMessage=importProgress.errors?.join(", ")||"Import failed";LemonToast.U.error(errorMessage)}},uploadCSV:async()=>{let file=customerIOImportLogic.values.csvFile;if(!file){LemonToast.U.error("Please select a CSV file");return}actions.setIsUploadingCSV(!0),actions.setCSVProgress(null);let formData=new FormData;formData.append("csv_file",file);try{let response=await fetch("/api/environments/@current/messaging_categories/import_preferences_csv/",{method:"POST",body:formData,credentials:"include",headers:{"X-CSRFToken":(0,api.ej)("posthog_csrftoken")||""}});if(!response.ok){let errorText=await response.text();throw console.error("CSV upload failed:",response.status,errorText),Error(errorText||`Upload failed with status ${response.status}`)}let data=await response.json();actions.setCSVProgress(data),"completed"===data.status?(LemonToast.U.success(`CSV import completed! Processed ${data.rows_processed} rows with ${data.users_with_optouts} users having opt-outs.`),window.location.pathname.includes("workflows")&&optOutCategoriesLogic.O.actions.loadCategories()):"failed"===data.status&&LemonToast.U.error(data.details||"CSV import failed")}catch(error){console.error("CSV upload error:",error),LemonToast.U.error(error.message||error.detail||"Failed to upload CSV")}finally{actions.setIsUploadingCSV(!1)}},submitImportFormFailure:_ref12=>{let{error}=_ref12;console.error("Import failed:",error)},closeImportModal:()=>{actions.resetImportForm(),actions.resetImport()}}})]);function CustomerIOImportModal(){let{isImportModalOpen,isImporting,importProgress,importError,importForm,csvFile,csvProgress,showCSVPhase,isUploadingCSV}=(0,index_esm.useValues)(customerIOImportLogic),{closeImportModal,submitImportForm,setCSVFile,uploadCSV}=(0,index_esm.useActions)(customerIOImportLogic),renderAPIImportPhase=()=>isImporting?(0,jsx_runtime.jsx)("div",{className:"space-y-4",children:(0,jsx_runtime.jsxs)("div",{className:"text-center py-8",children:[(0,jsx_runtime.jsx)(src.$j,{className:"text-3xl mb-4"}),(0,jsx_runtime.jsx)("div",{className:"text-lg font-semibold mb-2",children:"Importing from Customer.io..."}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted-alt",children:"This may take a moment. Processing categories and unsubscribed users."})]})}):importProgress?.status==="failed"?(0,jsx_runtime.jsx)(src.Vp,{type:"error",children:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold mb-2",children:"Import Failed"}),(0,jsx_runtime.jsx)("div",{className:"text-sm",children:importProgress.errors?.join(", ")||"An unknown error occurred"})]})}):importProgress?.status==="completed"?(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"success",children:(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"API Import Complete!"})}),(0,jsx_runtime.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsx)("span",{children:"Categories imported:"}),(0,jsx_runtime.jsx)(src.oe,{children:importProgress.categories_created||0})]}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsx)("span",{children:"Globally unsubscribed users:"}),(0,jsx_runtime.jsx)(src.oe,{children:(importProgress.globally_unsubscribed_count||0).toLocaleString()})]})]})]}):(0,jsx_runtime.jsx)(kea_forms_lib.Form,{logic:customerIOImportLogic,formKey:"importForm",enableFormOnSubmit:!0,children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:(0,jsx_runtime.jsxs)("span",{children:["Check our"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/workflows/import-customerio-optouts",target:"_blank",children:"Customer.io import guide"})," ","for detailed instructions."]})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("p",{className:"text-sm text-muted mb-4",children:"Step 1: Import categories and globally unsubscribed users from Customer.io API."})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"app_api_key",label:"Customer.io App API Key",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"Enter your App API key",type:"password","data-attr":"customerio-api-key",autoComplete:"off"})}),importError&&(0,jsx_runtime.jsx)(src.Vp,{type:"error",className:"text-sm",children:importError}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted-alt",children:"You can generate an App API key in Customer.io under Settings → Account Settings → API Credentials."})]})});return(0,jsx_runtime.jsx)(src.fQ,{title:"Import from Customer.io",isOpen:isImportModalOpen,onClose:closeImportModal,footer:isImporting||isUploadingCSV&&!csvProgress?null:importProgress?.status==="failed"?(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:closeImportModal,children:"Close"}):showCSVPhase?csvProgress?.status==="completed"||csvProgress?.status==="failed"?(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:closeImportModal,children:"Close"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:closeImportModal,children:"Skip CSV Import"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:uploadCSV,loading:isUploadingCSV,disabledReason:csvFile?void 0:"Please select a CSV file",children:"Upload & Process CSV"})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:closeImportModal,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:submitImportForm,loading:isImporting,disabledReason:importForm.app_api_key?void 0:"Please enter your API key",children:"Start Import"})]}),width:"medium",children:showCSVPhase?(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[renderAPIImportPhase(),(()=>{if(isUploadingCSV&&!csvProgress)return(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsxs)("div",{className:"text-center py-8",children:[(0,jsx_runtime.jsx)(src.$j,{className:"text-3xl mb-4"}),(0,jsx_runtime.jsx)("div",{className:"text-lg font-semibold mb-2",children:"Processing CSV..."}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted-alt",children:"This may take a moment for large files. Please don't close this window."}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted-alt mt-2",children:"Processing thousands of rows and updating the database..."})]})]});if(csvProgress){if("completed"===csvProgress.status){var failed;return(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(src.Vp,{type:"success",children:(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"CSV Import Complete!"})}),(0,jsx_runtime.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsx)("span",{children:"Total rows processed:"}),(0,jsx_runtime.jsx)(src.oe,{children:csvProgress.total_rows.toLocaleString()})]}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsx)("span",{children:"Users with opt-outs:"}),(0,jsx_runtime.jsx)(src.oe,{children:csvProgress.users_with_optouts.toLocaleString()})]}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsx)("span",{children:"Users skipped (no opt-outs):"}),(0,jsx_runtime.jsx)(src.oe,{children:csvProgress.users_skipped.toLocaleString()})]}),csvProgress.parse_errors>0&&(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between text-warning",children:[(0,jsx_runtime.jsx)("span",{children:"Parse errors:"}),(0,jsx_runtime.jsx)(src.oe,{type:"warning",children:csvProgress.parse_errors})]})]}),(failed=csvProgress.failed_imports)&&0!==failed.length?(0,jsx_runtime.jsx)(src.JL,{className:"mt-4",panels:[{key:"failed-imports",header:(0,jsx_runtime.jsxs)("div",{className:"font-semibold text-sm",children:["Failed imports (",failed.length,")"]}),content:(0,jsx_runtime.jsxs)("div",{className:"max-h-32 overflow-y-auto bg-bg-light rounded p-2 text-xs font-mono",children:[failed.slice(0,100).map((item,idx)=>(0,jsx_runtime.jsxs)("div",{className:"py-0.5",children:[item.email,": ",item.error]},idx)),failed.length>100&&(0,jsx_runtime.jsxs)("div",{className:"text-muted-alt mt-2",children:["... and ",failed.length-100," more"]})]})}],defaultActiveKeys:[]}):null]})}if("failed"===csvProgress.status)return(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(src.Vp,{type:"error",children:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold mb-2",children:"CSV Import Failed"}),(0,jsx_runtime.jsx)("div",{className:"text-sm",children:csvProgress.details})]})})]})}return(0,jsx_runtime.jsxs)("div",{className:"space-y-3",children:[(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold mb-2",children:"Step 2: Import User Preferences (Optional)"}),(0,jsx_runtime.jsxs)("p",{className:"text-sm text-muted mb-3",children:["Export a CSV from Customer.io with users who have subscription preferences set."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/workflows/import-customerio-optouts",target:"_blank",className:"text-primary",children:"View instructions"})]}),(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:csvFile?(0,jsx_runtime.jsx)("div",{className:"border-2 border-dashed border-border rounded-lg p-3 w-full",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"font-medium text-sm",children:csvFile.name}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-muted mt-1",children:["Size: ",(csvFile.size/1048576).toFixed(2),"MB"]})]}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setCSVFile(null),children:"Remove"})]})}):(0,jsx_runtime.jsx)(LemonFileInput.m,{accept:".csv",multiple:!1,value:[],onChange:files=>setCSVFile(files[0]||null),showUploadedFiles:!1,callToAction:(0,jsx_runtime.jsxs)("div",{className:"border-2 border-dashed border-border rounded-lg p-4 text-center hover:border-primary-light transition-colors cursor-pointer w-full",children:[(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:"Drop your CSV file here or click to browse"}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted-alt mt-1",children:"Accepts .csv files only"})]})})})]})]})})()]}):renderAPIImportPhase()})}var react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),More=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/More.tsx"),LemonDivider=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonDivider/index.ts"),LemonToast_LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/LemonToast.tsx");let NEW_CATEGORY={name:"",key:"",description:"",public_description:"",category_type:"marketing"},newCategoryLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","workflows","frontend","OptOuts","newCategoryLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(props=>props.category?.id||"new"),(0,index_esm.actions)({submitForm:!0,resetForm:!0}),(0,kea_forms_lib.forms)(_ref=>{let{actions,props}=_ref;return{categoryForm:{defaults:props.category?{name:props.category.name,key:props.category.key,description:props.category.description,public_description:props.category.public_description,category_type:props.category.category_type}:NEW_CATEGORY,errors:_ref2=>{let{name,key}=_ref2;return{name:name.trim()?void 0:"Name is required",key:key.trim()?/^[a-zA-Z0-9_-]+$/.test(key)?void 0:"Only letters, numbers, hyphens (-) & underscores (_) are allowed":"Key is required"}},submit:async formValues=>{props.category?(await api.ZP.messaging.updateCategory(props.category.id,formValues),LemonToast_LemonToast.UJ.success("Category updated successfully")):(await api.ZP.messaging.createCategory(formValues),LemonToast_LemonToast.UJ.success("Category created successfully")),optOutCategoriesLogic.O.actions.loadCategories(),actions.resetForm(),props.onSuccess&&props.onSuccess()}}}}),(0,index_esm.listeners)(_ref3=>{let{actions}=_ref3;return{resetForm:()=>{actions.resetCategoryForm()}}})]);function NewCategoryModal(_ref){let{isOpen,onClose,category}=_ref,logic=newCategoryLogic({category,onSuccess:onClose}),{isCategoryFormSubmitting}=(0,index_esm.useValues)(logic),{submitCategoryForm,resetCategoryForm}=(0,index_esm.useActions)(logic),handleClose=()=>{resetCategoryForm(),onClose()};return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:handleClose,title:category?"Edit message category":"New message category",footer:(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:handleClose,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",loading:isCategoryFormSubmitting,onClick:submitCategoryForm,children:category?"Update":"Create"})]}),children:(0,jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:newCategoryLogic,formKey:"categoryForm",props:{category,onSuccess:onClose},className:"space-y-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g., Product updates"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"key",label:"Key",info:"This is the unique identifier for the category",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g., product_updates",disabledReason:category?"Key cannot be changed after creation":void 0})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"category_type",label:"Message type",info:"Marketing messages can be opted out of by users. Transactional messages are not affected by recipient preferences",help:(0,jsx_runtime.jsxs)("p",{children:["Be sure to comply with local regulations regarding marketing communications (",(0,jsx_runtime.jsx)(src.rU,{to:"https://www.ftc.gov/business-guidance/resources/can-spam-act-compliance-guide-business",target:"_blank",children:"CAN-SPAM"}),","," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://gdpr.eu/email-encryption/",target:"_blank",children:"GDPR"}),")"]}),children:(0,jsx_runtime.jsx)(src.Yv,{options:[{label:"Marketing",value:"marketing"},{label:"Transactional",value:"transactional"}],placeholder:"Select message type"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"description",label:"Description",children:(0,jsx_runtime.jsx)(src._V,{placeholder:"Internal description for your team",rows:3})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"public_description",label:"Public description",help:"This description will be shown to users in the email preferences page.",children:(0,jsx_runtime.jsx)(src._V,{placeholder:"e.g., Latest updates on feature launches, product improvements, and more.",rows:3})})]})})}var TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),DataTable=__webpack_require__("../../frontend/src/queries/nodes/DataTable/DataTable.tsx"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js");let optOutSceneLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","workflows","frontend","OptOuts","optOutSceneLogic"]),(0,index_esm.connect)(()=>({values:[userLogic.userLogic,["user"]]})),(0,index_esm.actions)({loadUnsubscribeLink:!0}),(0,kea_loaders_lib.loaders)(_ref=>{let{values}=_ref;return{preferencesUrl:{__default:null,openPreferencesPage:async recipient=>{if(!values.user?.email)return src.UJ.error("User email not found"),null;try{let newPreferencesUrl=await api.ZP.messaging.generateMessagingPreferencesLink(recipient);if(!newPreferencesUrl)return src.UJ.error("Failed to generate workflows preferences link"),null;return window.open(newPreferencesUrl,"_blank"),newPreferencesUrl}catch{return src.UJ.error("Failed to generate workflows preferences link"),null}}}}})]),optOutListLogic=(0,index_esm.kea)([(0,index_esm.key)(props=>props.category?.id||"$all"),(0,index_esm.path)(["products","workflows","frontend","OptOuts","optOutListLogic"]),(0,index_esm.props)({}),(0,index_esm.connect)(()=>({values:[optOutSceneLogic,["preferencesUrlLoading"]],actions:[optOutSceneLogic,["openPreferencesPage"]]})),(0,index_esm.actions)({loadUnsubscribeLink:!0,setPersonsModalOpen:open=>({open}),setManagePreferencesModalOpen:open=>({open}),setSelectedIdentifier:identifier=>({identifier}),setCurrentPage:page=>({page}),loadNextPage:!0,loadPreviousPage:!0}),(0,index_esm.reducers)({personsModalOpen:[!1,{setPersonsModalOpen:(_,_ref)=>{let{open}=_ref;return open},setSelectedIdentifier:(open,_ref2)=>{let{identifier}=_ref2;return!!identifier&&open}}],managePreferencesModalOpen:[!1,{setManagePreferencesModalOpen:(_,_ref3)=>{let{open}=_ref3;return open},setSelectedIdentifier:(open,_ref4)=>{let{identifier}=_ref4;return!!identifier&&open}}],selectedIdentifier:[null,{setSelectedIdentifier:(_,_ref5)=>{let{identifier}=_ref5;return identifier}}],currentPage:[1,{setCurrentPage:(_,_ref6)=>{let{page}=_ref6;return page},loadOptOutPersonsSuccess:()=>1,loadNextPageSuccess:state=>state+1,loadPreviousPageSuccess:state=>Math.max(1,state-1)}]}),(0,kea_loaders_lib.loaders)(_ref7=>{let{props,values}=_ref7;return{optOutPersons:{__default:{count:0,next:null,previous:null,results:[]},loadOptOutPersons:async()=>{try{return await api.ZP.messaging.getMessageOptOuts(props.category?.key,1)}catch{return src.UJ.error("Failed to load opt-out persons"),{count:0,next:null,previous:null,results:[]}}},loadNextPage:async()=>{let nextPage=values.currentPage+1;try{return await api.ZP.messaging.getMessageOptOuts(props.category?.key,nextPage)}catch{return src.UJ.error("Failed to load next page"),values.optOutPersons}},loadPreviousPage:async()=>{let prevPage=Math.max(1,values.currentPage-1);try{return await api.ZP.messaging.getMessageOptOuts(props.category?.key,prevPage)}catch{return src.UJ.error("Failed to load previous page"),values.optOutPersons}}}}}),(0,index_esm.afterMount)(_ref8=>{let{props,actions}=_ref8;props.category?.id&&props.category?.category_type!=="marketing"||actions.loadOptOutPersons()})]);function OptOutList(_ref){let{category}=_ref,logic=optOutListLogic({category}),{setSelectedIdentifier,openPreferencesPage,loadNextPage,loadPreviousPage}=(0,index_esm.useActions)(logic),{selectedIdentifier,optOutPersons,optOutPersonsLoading,preferencesUrlLoading,currentPage}=(0,index_esm.useValues)(logic),handleShowPersons=identifier=>{setSelectedIdentifier(identifier)},actorsQuery=selectedIdentifier?{kind:schema_general.OH.DataTableNode,source:{kind:schema_general.OH.ActorsQuery,select:["person_display_name -- Person","id","created_at"],search:selectedIdentifier,orderBy:["created_at"]}}:null,columns=[{title:"Recipient",dataIndex:"identifier",key:"recipient"},{title:"Opt-out date",dataIndex:"updated_at",key:"updated_at",render:updated_at=>(0,jsx_runtime.jsx)(TZLabel.w,{time:updated_at})},{width:0,render:function Render(_,optOutEntry){return(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>handleShowPersons(optOutEntry.identifier),fullWidth:!0,children:"Show person(s)"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>openPreferencesPage(optOutEntry.identifier),loading:preferencesUrlLoading,fullWidth:!0,icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconExternal,{}),children:"Manage"})]})})}}],totalPages=optOutPersons.count?Math.ceil(optOutPersons.count/20):0,showingEnd=Math.min(20*currentPage,optOutPersons.count);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"max-h-64 overflow-y-auto",children:(0,jsx_runtime.jsx)(src.g3,{columns:columns,dataSource:optOutPersons.results||[],loading:optOutPersonsLoading,loadingSkeletonRows:3,rowKey:"identifier",emptyState:`No opt-outs found${category?.name?` for ${category.name}`:""}`,size:"small"})}),optOutPersons.count>20&&(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between mt-4 px-2",children:[(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:optOutPersons.count>0&&(0,jsx_runtime.jsxs)("span",{children:["Showing ",(currentPage-1)*20+1," - ",showingEnd," of ",optOutPersons.count.toLocaleString()," opt-outs"]})}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconChevronLeft,{}),size:"small",disabled:1===currentPage||optOutPersonsLoading,onClick:loadPreviousPage}),(0,jsx_runtime.jsxs)("span",{className:"text-sm",children:["Page ",currentPage," of ",totalPages]}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconChevronRight,{}),size:"small",disabled:!optOutPersons.next||optOutPersonsLoading,onClick:loadNextPage})]})]}),(0,jsx_runtime.jsx)(src.fQ,{isOpen:!!selectedIdentifier,onClose:()=>{setSelectedIdentifier(null)},title:`Persons for ${selectedIdentifier}`,width:"50rem",footer:null,children:actorsQuery&&(0,jsx_runtime.jsx)("div",{className:"h-96",children:(0,jsx_runtime.jsx)(DataTable.w,{query:actorsQuery,setQuery:()=>{},uniqueKey:`opt-out-persons-${selectedIdentifier}`,readOnly:!0})})})]})}function OptOutCategories(){let{categories,categoriesLoading,isNewCategoryModalOpen}=(0,index_esm.useValues)(optOutCategoriesLogic.O),{loadCategories,deleteCategory,closeNewCategoryModal,openNewCategoryModal}=(0,index_esm.useActions)(optOutCategoriesLogic.O),{isImportModalOpen}=(0,index_esm.useValues)(customerIOImportLogic),{openImportModal}=(0,index_esm.useActions)(customerIOImportLogic),[editingCategory,setEditingCategory]=(0,react.useState)(null);(0,react.useEffect)(()=>{loadCategories()},[loadCategories]);let handleEditCategory=category=>{setEditingCategory(category)},handleCloseModal=()=>{setEditingCategory(null)},collapseItems=(0,react.useMemo)(()=>(categories||[]).map(category=>({key:category.id,header:(0,jsx_runtime.jsxs)("div",{className:"flex justify-between w-full gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"font-medium",children:category.name}),(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted",children:category.description})]}),(0,jsx_runtime.jsx)(src.oe,{type:"marketing"===category.category_type?"success":"completion",children:category.category_type.toUpperCase()})]}),(0,jsx_runtime.jsx)(More.T,{onClick:e=>e.stopPropagation(),overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>handleEditCategory(category),fullWidth:!0,children:"Edit"}),(0,jsx_runtime.jsx)(LemonDivider.p,{}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",onClick:()=>src.dn.open({title:"Delete category",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("p",{children:["Are you sure you want to delete the message category"," ",(0,jsx_runtime.jsx)("b",{children:category.name}),"?"]}),(0,jsx_runtime.jsx)("p",{children:"All messages associated with this category must be updated manually."})]}),primaryButton:{children:"Delete",status:"danger",onClick:()=>deleteCategory(category.id)},secondaryButton:{children:"Cancel"}}),fullWidth:!0,children:"Delete"})]})})]}),content:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-3",children:[(0,jsx_runtime.jsxs)("div",{className:"text-sm text-muted mb-1",children:["Key: ",category.key]}),category.public_description&&(0,jsx_runtime.jsxs)("div",{className:"text-sm text-muted",children:["Public description: ",category.public_description]})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h4",{className:"font-medium mb-2",children:"Opt-out list"}),"marketing"===category.category_type?(0,jsx_runtime.jsx)(OptOutList,{category:category}):(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted mb-1",children:"Transactional messages are not eligible for opt-outs"})]})]})})),[categories,deleteCategory]);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[categoriesLoading?(0,jsx_runtime.jsx)(src.yW,{className:"h-10"}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:collapseItems.length>0?(0,jsx_runtime.jsx)(src.JL,{panels:collapseItems}):(0,jsx_runtime.jsx)(ProductIntroduction.C,{productName:"Message Categories",thingName:"category",description:"Configure message categories to manage user opt-out preferences for different types of communications.",docsURL:"https://posthog.com/docs/workflows/customerio-import",actionElementOverride:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{type:"primary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconDownload,{}),onClick:openImportModal,children:"Import from Customer.io"}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),onClick:openNewCategoryModal,children:"Create category"})]}),customHog:hedgehogs.BuilderHog3,isEmpty:!0})}),(0,jsx_runtime.jsx)(NewCategoryModal,{isOpen:isNewCategoryModalOpen||null!==editingCategory,onClose:()=>{closeNewCategoryModal(),handleCloseModal()},category:editingCategory}),isImportModalOpen&&(0,jsx_runtime.jsx)(CustomerIOImportModal,{})]})}function OptOutScene(){let{user}=(0,index_esm.useValues)(userLogic.userLogic),{preferencesUrlLoading}=(0,index_esm.useValues)(optOutSceneLogic),{openPreferencesPage}=(0,index_esm.useActions)(optOutSceneLogic),{openImportModal}=(0,index_esm.useActions)(customerIOImportLogic);return(0,jsx_runtime.jsxs)("div",{className:"space-y-8",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,jsx_runtime.jsx)("h2",{className:"text-xl font-semibold",children:"Message categories"}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>openImportModal(),icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconDownload,{}),tooltip:"Import subscription topics and preferences from Customer.io",children:"Import from Customer.io"}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>openPreferencesPage(),loading:preferencesUrlLoading,disabled:!user?.email,tooltip:user?.email?"Generate an unsubscribe link for your email and open it in a new tab":"User email not available",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconExternal,{}),children:"Preview opt-out page"})]})]}),(0,jsx_runtime.jsx)(OptOutCategories,{})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h2",{className:"text-xl font-semibold",children:"Marketing opt-out list"}),(0,jsx_runtime.jsx)("p",{className:"mt-6",children:"Message recipients who have opted out of all marketing messages"}),(0,jsx_runtime.jsx)(OptOutList,{})]}),(0,jsx_runtime.jsx)(CustomerIOImportModal,{})]})}var LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonTable=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/index.ts"),LemonTableLink=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/LemonTableLink.tsx"),columnUtils=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/columnUtils.tsx"),MaxTool=__webpack_require__("../../frontend/src/scenes/max/MaxTool.tsx"),deleteWithUndo=__webpack_require__("../../frontend/src/lib/utils/deleteWithUndo.tsx");let messageTemplatesLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","workflows","frontend","library","messageTemplatesLogic"]),(0,kea_loaders_lib.loaders)(_ref=>{let{values,actions}=_ref;return{templates:[[],{loadTemplates:async()=>(await api.ZP.messaging.getTemplates()).results,deleteTemplate:async template=>(await (0,deleteWithUndo.S)({endpoint:"environments/@current/messaging_templates",object:{id:template.id,name:template.name},callback:undo=>{undo&&actions.loadTemplates()}}),values.templates.filter(t=>t.id!==template.id)),createTemplate:async _ref2=>{let{template}=_ref2;try{let newTemplate=await api.ZP.messaging.createTemplate(template);return LemonToast.U.success("Template created successfully"),[...values.templates,newTemplate]}catch{return LemonToast.U.error("Failed to create template"),values.templates}},updateTemplate:async _ref3=>{let{templateId,template}=_ref3;try{let updatedTemplate=await api.ZP.messaging.updateTemplate(templateId,template);return LemonToast.U.success("Template updated successfully"),values.templates.map(t=>t.id===templateId?updatedTemplate:t)}catch{return LemonToast.U.error("Failed to update template"),values.templates}},duplicateTemplate:async template=>{try{let duplicatedTemplate=await api.ZP.messaging.createTemplate({name:`${template.name} (copy)`,description:template.description,content:template.content});return LemonToast.U.success("Template duplicated successfully"),[...values.templates,duplicatedTemplate]}catch{return LemonToast.U.error("Failed to duplicate template"),values.templates}}}]}}),(0,index_esm.afterMount)(_ref4=>{let{actions}=_ref4;actions.loadTemplates()})]);function MessageTemplatesTable(){(0,index_esm.useMountedLogic)(messageTemplatesLogic);let{templates,templatesLoading}=(0,index_esm.useValues)(messageTemplatesLogic),{deleteTemplate,createTemplate,duplicateTemplate}=(0,index_esm.useActions)(messageTemplatesLogic),columns=[{title:"Name",render:(_,item)=>(0,jsx_runtime.jsx)(LemonTableLink.i,{to:urls.j.workflowsLibraryTemplate(item.id),title:item.name,description:item.description})},(0,columnUtils.JB)(),(0,columnUtils.rw)(),{width:0,render:function Render(_,message){return(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"message-template-duplicate",fullWidth:!0,onClick:()=>duplicateTemplate(message),children:"Duplicate"}),(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"message-template-delete",fullWidth:!0,status:"danger",onClick:()=>deleteTemplate(message),children:"Delete"})]})})}}],showProductIntroduction=!templatesLoading&&0===templates.length;return(0,jsx_runtime.jsxs)("div",{className:"templates-section",children:[showProductIntroduction&&(0,jsx_runtime.jsx)(ProductIntroduction.C,{productName:"Message template",thingName:"message template",description:"Create and manage reusable message templates for your workflows.",docsURL:"https://posthog.com/docs/workflows",action:()=>{lib.router.actions.push(urls.j.workflowsLibraryTemplateNew())},customHog:hedgehogs.ReadingHog,isEmpty:!0}),(0,jsx_runtime.jsx)(MaxTool.Z,{identifier:"create_message_template",context:{},callback:toolOutput=>{createTemplate({template:JSON.parse(toolOutput)})},children:(0,jsx_runtime.jsx)("div",{className:"relative"})}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:templates,loading:templatesLoading,columns:columns})]})}var AppMetricsSparkline=__webpack_require__("../../frontend/src/lib/components/AppMetrics/AppMetricsSparkline.tsx"),HogFlowSteps=__webpack_require__("../../products/workflows/frontend/Workflows/hogflows/steps/HogFlowSteps.tsx");let workflowsLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","workflows","frontend","workflowsLogic"]),(0,index_esm.actions)({toggleWorkflowStatus:workflow=>({workflow}),duplicateWorkflow:workflow=>({workflow}),deleteWorkflow:workflow=>({workflow}),loadWorkflows:()=>({})}),(0,kea_loaders_lib.loaders)(_ref=>{let{values}=_ref;return{workflows:[[],{loadWorkflows:async()=>(await api.ZP.hogFlows.getHogFlows()).results,toggleWorkflowStatus:async _ref2=>{let{workflow}=_ref2,updatedWorkflow=await api.ZP.hogFlows.updateHogFlow(workflow.id,{status:"active"===workflow.status?"draft":"active"});return values.workflows.map(c=>c.id===updatedWorkflow.id?updatedWorkflow:c)},duplicateWorkflow:async _ref3=>{let{workflow}=_ref3;return[await api.ZP.hogFlows.createHogFlow({...workflow,status:"draft",name:`${workflow.name} (copy)`}),...values.workflows]},deleteWorkflow:async _ref4=>{let{workflow}=_ref4;return await api.ZP.hogFlows.deleteHogFlow(workflow.id),values.workflows.filter(c=>c.id!==workflow.id)}}]}}),(0,index_esm.afterMount)(_ref5=>{let{actions}=_ref5;actions.loadWorkflows()})]);function WorkflowTypeTag(_ref){let{workflow}=_ref;return(0,react.useMemo)(()=>workflow.actions.some(action=>["function_email","function_sms","function_slack"].includes(action.type)),[workflow.actions])?(0,jsx_runtime.jsx)(src.oe,{type:"completion",children:"Messaging"}):(0,jsx_runtime.jsx)(src.oe,{type:"default",children:"Automation"})}function WorkflowActionsSummary(_ref2){let{workflow}=_ref2,actionsByType=(0,react.useMemo)(()=>workflow.actions.reduce((acc,action)=>{let step=(0,HogFlowSteps.d)(action,{});if(!step||!step.type.startsWith("function"))return acc;let key="template_id"in action.config?action.config.template_id:action.type;return acc[key]={count:(acc[key]?.count||0)+1,icon:step.icon,color:step.color},acc},{}),[workflow.actions]);return(0,jsx_runtime.jsx)(src.rU,{to:urls.j.workflow(workflow.id,"workflow"),children:(0,jsx_runtime.jsx)("div",{className:"flex flex-row gap-2 items-center",children:Object.entries(actionsByType).map(_ref3=>{let[type,{count,icon,color}]=_ref3;return(0,jsx_runtime.jsxs)("div",{className:"rounded px-1 flex items-center justify-center gap-1",style:{backgroundColor:`${color}20`,color},children:[icon," ",count]},type)})})})}function WorkflowsTable(){(0,index_esm.useMountedLogic)(workflowsLogic);let{workflows,workflowsLoading}=(0,index_esm.useValues)(workflowsLogic),{toggleWorkflowStatus,duplicateWorkflow,deleteWorkflow}=(0,index_esm.useActions)(workflowsLogic),columns=[{title:"Name",key:"name",sorter:(a,b)=>(a.name||"").localeCompare(b.name||""),render:(_,item)=>(0,jsx_runtime.jsx)(LemonTableLink.i,{to:urls.j.workflow(item.id,"workflow"),title:item.name,description:item.description})},{title:"Type",width:0,render:(_,item)=>(0,jsx_runtime.jsx)(WorkflowTypeTag,{workflow:item})},{title:"Trigger",width:0,render:(_,item)=>{var _item$trigger$type;return(0,jsx_runtime.jsx)(src.rU,{to:urls.j.workflow(item.id,"workflow")+"?node=trigger_node",children:(0,jsx_runtime.jsx)(src.oe,{type:"default",children:(0,utils.fm)(null!==(_item$trigger$type=item.trigger?.type)&&void 0!==_item$trigger$type?_item$trigger$type:"unknown")})})}},{title:"Dispatches",width:0,render:(_,item)=>(0,jsx_runtime.jsx)(WorkflowActionsSummary,{workflow:item})},{...(0,columnUtils.yI)(),width:0},{title:"Last 7 days",width:0,render:(_,_ref4)=>{let{id}=_ref4;return(0,jsx_runtime.jsx)(src.rU,{to:urls.j.workflow(id,"metrics"),children:(0,jsx_runtime.jsx)(AppMetricsSparkline.e,{logicKey:id,forceParams:{appSource:"hog_flow",appSourceId:id,metricKind:["success","failure"],breakdownBy:"metric_kind",interval:"day",dateFrom:"-7d"}})})}},{title:"Status",width:0,key:"status",sorter:(a,b)=>a.status.localeCompare(b.status),render:(_,item)=>(0,jsx_runtime.jsx)(src.oe,{type:"active"===item.status?"success":"default",children:(0,utils.fm)(item.status)})},{width:0,render:function Render(_,workflow){return(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"workflow-edit",fullWidth:!0,status:"draft"===workflow.status?"default":"danger",onClick:()=>toggleWorkflowStatus(workflow),tooltip:"draft"===workflow.status?"Enables the workflow to start sending messages":"Disables the workflow from sending any new messages. In-progress workflows will end immediately.",children:"draft"===workflow.status?"Enable":"Disable"}),(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"workflow-duplicate",fullWidth:!0,onClick:()=>duplicateWorkflow(workflow),children:"Duplicate"}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"workflow-delete",fullWidth:!0,status:"danger",onClick:()=>{src.dn.open({title:"Delete workflow",description:(0,jsx_runtime.jsxs)("p",{children:['Are you sure you want to delete the workflow "',(0,jsx_runtime.jsx)("strong",{children:workflow.name}),'"? This action cannot be undone. In-progress workflows will end immediately.']}),primaryButton:{children:"Delete",status:"danger",onClick:()=>{deleteWorkflow(workflow)}},secondaryButton:{children:"Cancel"}})},children:"Delete"})]})})}}],showProductIntroduction=!workflowsLoading&&0===workflows.length;return(0,jsx_runtime.jsxs)("div",{className:"workflows-section",children:[showProductIntroduction&&(0,jsx_runtime.jsx)(ProductIntroduction.C,{productName:"Workflow",thingName:"workflow",description:"Create workflows that automate actions or send messages to your users.",docsURL:"https://posthog.com/docs/workflows/start-here",action:()=>{lib.router.actions.push(urls.j.workflowNew())},customHog:hedgehogs.MailHog,isEmpty:!0}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:workflows,loading:workflowsLoading,columns:columns,defaultSorting:{columnKey:"status",order:1}})]})}let WORKFLOW_SCENE_TABS=["workflows","library","channels","opt-outs"],workflowSceneLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.path)(()=>["scenes","workflows","workflowSceneLogic"]),(0,index_esm.actions)({setCurrentTab:tab=>({tab})}),(0,index_esm.reducers)(()=>({currentTab:["workflows",{setCurrentTab:(_,_ref)=>{let{tab}=_ref;return tab}}]})),(0,index_esm.selectors)({logicProps:[()=>[(_,props)=>props],props=>props],breadcrumbs:[(_,p)=>[p.tab],tab=>[{key:[sceneTypes.x.Workflows,tab],name:(0,utils.fm)(tab.replaceAll("_"," ")),iconType:"workflows"}]]}),(0,lib.urlToAction)(_ref2=>{let{actions,values}=_ref2;return{[urls.j.workflows()]:()=>{"workflows"!==values.currentTab&&actions.setCurrentTab("workflows")},[urls.j.workflows(":tab")]:_ref3=>{let{tab}=_ref3,possibleTab=null!=tab?tab:"workflows";(possibleTab=WORKFLOW_SCENE_TABS.includes(possibleTab)?possibleTab:"workflows")!==values.currentTab&&actions.setCurrentTab(possibleTab)}}})]),scene={component:WorkflowsScene,logic:workflowSceneLogic,paramsToProps:_ref5=>{let{params:{tab}}=_ref5;return{tab}}};function WorkflowsScene(){let{currentTab}=(0,index_esm.useValues)(workflowSceneLogic),{openSetupModal}=(0,index_esm.useActions)(integrationsLogic.a),{openNewCategoryModal}=(0,index_esm.useActions)(optOutCategoriesLogic.O);if(!(0,useFeatureFlag.y)("WORKFLOWS"))return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col justify-center items-center h-full",children:[(0,jsx_runtime.jsx)("h1",{className:"text-2xl font-bold",children:"Coming soon!"}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-muted-foreground",children:"We're working on bringing workflows to PostHog. Stay tuned for updates!"})]});let newChannelMenuItems=[{label:(0,jsx_runtime.jsxs)("div",{className:"flex gap-1 items-center",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconLetter,{})," Email"]}),onClick:()=>openSetupModal(void 0,"email")},{label:(0,jsx_runtime.jsxs)("div",{className:"flex gap-1 items-center",children:[(0,jsx_runtime.jsx)(icons.gx,{})," Slack"]}),disableClientSideRouting:!0,to:api.ZP.integrations.authorizeUrl({kind:"slack",next:urls.j.workflows("channels")})},{label:(0,jsx_runtime.jsxs)("div",{className:"flex gap-1 items-center",children:[(0,jsx_runtime.jsx)(icons.i5,{})," Twilio"]}),onClick:()=>openSetupModal(void 0,"twilio")}],tabs=[{label:"Workflows",key:"workflows",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"Create and manage your workflows"}),(0,jsx_runtime.jsx)(WorkflowsTable,{})]}),link:urls.j.workflows()},{label:"Library",key:"library",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"Create and manage messages"}),(0,jsx_runtime.jsx)(MessageTemplatesTable,{})]}),link:urls.j.workflows("library")},{label:"Channels",key:"channels",content:(0,jsx_runtime.jsx)(MessageChannels,{}),link:urls.j.workflows("channels")},{label:"Opt-outs",key:"opt-outs",content:(0,jsx_runtime.jsx)(OptOutScene,{}),link:urls.j.workflows("opt-outs")}];return(0,jsx_runtime.jsxs)(SceneContent._,{className:"workflows",children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:scenes.lc[sceneTypes.x.Workflows].name,description:scenes.lc[sceneTypes.x.Workflows].description,resourceType:{type:scenes.lc[sceneTypes.x.Workflows].iconType||"default_icon_type"},actions:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["workflows"===currentTab&&(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"new-workflow",to:urls.j.workflowNew(),type:"primary",size:"small",children:"New workflow"}),"library"===currentTab&&(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"new-message-button",to:urls.j.workflowsLibraryTemplateNew(),type:"primary",size:"small",children:"New template"}),"channels"===currentTab&&(0,jsx_runtime.jsx)(src.d6,{items:newChannelMenuItems,matchWidth:!0,children:(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"new-channel-button",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),size:"small",type:"primary",children:"New channel"})}),"opt-outs"===currentTab&&(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"new-optout-category",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),size:"small",type:"primary",onClick:()=>openNewCategoryModal(),children:"New category"})]})}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:currentTab,tabs:tabs,sceneInset:!0})]})}}}]);