(window.webpackJsonp=window.webpackJsonp||[]).push([[245],{"./frontend/src/scenes/instance/SystemStatus/index.tsx":function(N,h,a){"use strict";a.r(h),a.d(h,"scene",function(){return xe}),a.d(h,"SystemStatus",function(){return ne});var w=a("./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),se=a.n(w),le=a("./node_modules/css-loader/dist/cjs.js!./node_modules/postcss-loader/src/index.js!./node_modules/sass-loader/dist/cjs.js?!./frontend/src/scenes/instance/SystemStatus/index.scss"),H=a.n(le),P={};P.insert="head",P.singleton=!1;var Ve=se()(H.a,P),Te=H.a.locals||{},V=a("./node_modules/react/index.js"),e=a.n(V),F=a("./node_modules/antd/es/alert/index.js"),T=a("./node_modules/antd/es/tabs/index.js"),u=a("./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts"),y=a("./node_modules/kea/lib/index.esm.js"),re=a("./frontend/src/lib/components/PageHeader.tsx"),U=a("./frontend/src/scenes/PreflightCheck/logic.tsx"),C=a("./frontend/src/lib/components/icons.tsx"),Ae=a("./node_modules/core-js/modules/es.array.map.js"),W=a("./node_modules/antd/es/card/index.js"),z=a("./node_modules/antd/es/table/index.js"),G=a("./frontend/src/lib/components/Link.tsx"),Le=a("./node_modules/core-js/modules/es.array.iterator.js"),Me=a("./node_modules/core-js/modules/es.object.to-string.js"),Re=a("./node_modules/core-js/modules/es.regexp.to-string.js"),ke=a("./node_modules/core-js/modules/es.set.js"),Ne=a("./node_modules/core-js/modules/es.string.iterator.js"),we=a("./node_modules/core-js/modules/web.dom-collections.iterator.js"),A=a("./frontend/src/lib/components/LemonTag/LemonTag.tsx"),Q=a("./frontend/src/lib/utils.tsx"),oe=new Set(["last_event_ingested_timestamp"]);function b(t){var l=t.key,s=t.value,n=t.value_type,o=t.emptyNullLabel;return oe.has(l)&&typeof s=="string"?new Date(s).getTime()===new Date("1970-01-01T00:00:00").getTime()?"Never":Object(Q.K)(s):n==="bool"||typeof s=="boolean"?e.a.createElement(A.a,{type:s?"success":"danger"},s?"Yes":"No"):s==null||s===""?e.a.createElement(A.a,{style:{color:"var(--text-muted)"}},o!=null?o:"Unknown"):n==="int"||typeof s=="number"?s.toLocaleString("en-US"):s.toString()}try{b.displayName="RenderMetricValue",b.__docgenInfo={description:"",displayName:"RenderMetricValue",props:{emptyNullLabel:{defaultValue:null,description:"",name:"emptyNullLabel",required:!1,type:{name:"string"}},value:{defaultValue:null,description:"",name:"value",required:!1,type:{name:"string | number | boolean | null"}},key:{defaultValue:null,description:"",name:"key",required:!0,type:{name:"string"}},value_type:{defaultValue:null,description:"",name:"value_type",required:!1,type:{name:"enum",value:[{value:'"bool"'},{value:'"str"'},{value:'"int"'}]}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/SystemStatus/RenderMetricValue.tsx#RenderMetricValue"]={docgenInfo:b.__docgenInfo,name:"RenderMetricValue",path:"frontend/src/scenes/instance/SystemStatus/RenderMetricValue.tsx#RenderMetricValue"})}catch(t){}var J={async_migrations_ok:"/instance/async_migrations"};function ie(t){return e.a.createElement("span",null,t.metric," ",J[t.key]?e.a.createElement(G.a,{to:J[t.key]},e.a.createElement(C.IconOpenInNew,{style:{verticalAlign:"middle"}})):null)}function ue(){var t=Object(y.useValues)(u.b),l=t.overview,s=t.systemStatusLoading,n=[{title:"Metric",className:"metric-column",render:ie},{title:"Value",render:b}];return e.a.createElement(e.a.Fragment,null,e.a.createElement(W.a,null,e.a.createElement("h3",{className:"l3"},"Key metrics"),e.a.createElement(z.a,{className:"system-status-table",size:"small",rowKey:"metric",pagination:!1,dataSource:l,columns:n,loading:s,expandable:{expandedRowRender:function(r){return r.subrows?e.a.createElement(ce,r.subrows):null},rowExpandable:function(r){return!!r.subrows&&r.subrows.rows.length>0},expandRowByClick:!0}})))}function ce(t){return e.a.createElement(z.a,{rowKey:"metric",pagination:!1,dataSource:t.rows,columns:t.columns.map(function(l,s){return{title:l,dataIndex:s}})})}var Pe=a("./node_modules/core-js/modules/es.array.filter.js"),ze=a("./node_modules/core-js/modules/es.array.for-each.js"),Qe=a("./node_modules/core-js/modules/es.object.keys.js"),Ke=a("./node_modules/core-js/modules/web.dom-collections.for-each.js"),de=a("./node_modules/@babel/runtime/helpers/objectDestructuringEmpty.js"),me=a.n(de),ge=a("./node_modules/@babel/runtime/helpers/slicedToArray.js"),K=a.n(ge),O=a("./node_modules/antd/es/collapse/index.js"),X=a("./node_modules/antd/es/checkbox/index.js"),S=a("./node_modules/antd/es/button/index.js"),B=a("./node_modules/@ant-design/icons/es/icons/ReloadOutlined.js"),ye=a("./frontend/src/scenes/dashboard/Dashboard.tsx"),fe=a("./frontend/src/types.ts"),Be=a("./node_modules/core-js/modules/es.object.entries.js"),$=a("./node_modules/antd/es/modal/index.js"),Z=a("./node_modules/antd/es/input/index.js");function ve(){var t=Object(y.useValues)(u.b),l=t.analyzeModalOpen,s=t.analyzeQuery,n=t.analyzeQueryResult,o=t.analyzeQueryResultLoading,r=Object(y.useActions)(u.b),i=r.setAnalyzeModalOpen,m=r.setAnalyzeQuery,f=r.runAnalyzeQuery;return e.a.createElement($.a,{visible:l,title:"Analyze ClickHouse query performance",footer:e.a.createElement(e.a.Fragment,null,e.a.createElement(S.a,{onClick:function(){return i(!1)}},"Cancel"),e.a.createElement(S.a,{type:"primary",onClick:function(){return void f()},disabled:o},"Analyze")),onCancel:function(){return i(!1)},width:"80%"},e.a.createElement(Z.a.TextArea,{placeholder:"SQL query to analyze",onChange:function(c){return m(c.target.value)},value:s,rows:10}),n&&e.a.createElement("div",{style:{marginTop:30}},e.a.createElement("h2",null,"Analysis results"),e.a.createElement("ul",null,Object.entries(n.timing).map(function(d){var c=K()(d,2),v=c[0],p=c[1];return e.a.createElement("li",{key:v},v,": ",p)})),Object.entries(n.flamegraphs).map(function(d){var c=K()(d,2),v=c[0],p=c[1];return e.a.createElement("div",{key:v},e.a.createElement("h3",null,"Flamegraph: ",v),e.a.createElement("a",{className:"embedded-svg-wrapper",href:"data:image/svg+xml;utf8,".concat(encodeURIComponent(p)),dangerouslySetInnerHTML:{__html:p}}))})))}function pe(){var t=Object(y.useValues)(u.b),l=t.openSections,s=t.systemStatus,n=t.queries,o=t.queriesLoading,r=t.showAnalyzeQueryButton,i=Object(y.useActions)(u.b),m=i.setOpenSections,f=i.loadQueries,d=Object(V.useState)(!1),c=K()(d,2),v=c[0],p=c[1],R=Object(V.useMemo)(function(){var E;return n==null||(E=n.postgres_running)===null||E===void 0?void 0:E.filter(function(g){var k=g.state;return v||k!=="idle"})},[v,n]),j=s==null?void 0:s.internal_metrics.clickhouse,I=function(g){g.stopPropagation(),f()};return e.a.createElement(W.a,null,e.a.createElement(O.a,{activeKey:l,onChange:function(g){return m(g)}},j?e.a.createElement(O.a.Panel,{header:"Dashboards",key:"0"},e.a.createElement(ye.Dashboard,{id:j.id.toString(),shareToken:j.share_token,placement:fe.f.InternalMetrics})):null,e.a.createElement(O.a.Panel,{header:"PostgreSQL - currently running queries",key:"1"},e.a.createElement("div",{className:"mb float-right"},e.a.createElement(X.a,{checked:v,onChange:function(g){p(g.target.checked)}},"Show idle queries"),e.a.createElement(S.a,{style:{marginLeft:8},onClick:I},e.a.createElement(B.a,null)," Reload Queries")),e.a.createElement(D,{queries:R,loading:o})),(n==null?void 0:n.clickhouse_running)!=null?e.a.createElement(O.a.Panel,{header:"Clickhouse - currently running queries",key:"2"},e.a.createElement("div",{className:"mb float-right"},e.a.createElement(S.a,{style:{marginLeft:8},onClick:I},e.a.createElement(B.a,null)," Reload Queries")),e.a.createElement(D,{queries:n==null?void 0:n.clickhouse_running,loading:o,showAnalyze:r})):null,(n==null?void 0:n.clickhouse_slow_log)!=null?e.a.createElement(O.a.Panel,{header:"Clickhouse - slow query log (past 6 hours)",key:"3"},e.a.createElement("div",{className:"mb float-right"},e.a.createElement(S.a,{style:{marginLeft:8},onClick:I},e.a.createElement(B.a,null)," Reload Queries")),e.a.createElement(D,{queries:n==null?void 0:n.clickhouse_slow_log,loading:o,showAnalyze:r})):null),e.a.createElement(ve,null))}function D(t){var l=Object(y.useActions)(u.b),s=l.openAnalyzeModalWithQuery,n=[{title:"duration",dataIndex:"duration",key:"duration",sorter:function(r,i){return+r.duration-+i.duration}},{title:"query",dataIndex:"query",render:function(r,i){return me()(r),t.showAnalyze?e.a.createElement(G.a,{to:"#",onClick:function(){return s(i.query)}},i.query):i.query},key:"query"}];return t.queries&&t.queries.length>0&&Object.keys(t.queries[0]).forEach(function(o){o!=="duration"&&o!=="query"&&n.push({title:o,dataIndex:o,key:o})}),e.a.createElement(z.a,{dataSource:t.queries||[],columns:n,loading:t.loading,pagination:{pageSize:30,hideOnSinglePage:!0},size:"small",bordered:!0,style:{overflowX:"auto",overflowY:"auto"},locale:{emptyText:"No queries found"}})}var Ee=a("./node_modules/@babel/runtime/helpers/defineProperty.js"),he=a.n(Ee),be=a("./frontend/src/lib/components/HotkeyButton/HotkeyButton.tsx"),q=a("./frontend/src/lib/components/LemonTable/index.ts"),Se=a("./frontend/src/lib/hooks/useKeyboardHotkeys.tsx");function L(t){var l=t.key,s=t.value,n=t.value_type,o=t.onValueChanged;return n==="bool"?e.a.createElement(e.a.Fragment,null,e.a.createElement(X.a,{defaultChecked:!!s,onChange:function(i){return o(l,i.target.checked)}}),e.a.createElement(A.a,{style:{marginLeft:4},type:s?"success":"danger"},s?"Yes":"No")):e.a.createElement(Z.a,{defaultValue:s,type:n==="int"?"number":"text",onBlur:function(i){return o(l,i.target.value)}})}try{L.displayName="RenderMetricValueEdit",L.__docgenInfo={description:"",displayName:"RenderMetricValueEdit",props:{onValueChanged:{defaultValue:null,description:"",name:"onValueChanged",required:!0,type:{name:"(key: string, value: any) => void"}},emptyNullLabel:{defaultValue:null,description:"",name:"emptyNullLabel",required:!1,type:{name:"string"}},value:{defaultValue:null,description:"",name:"value",required:!1,type:{name:"string | number | boolean | null"}},key:{defaultValue:null,description:"",name:"key",required:!0,type:{name:"string"}},value_type:{defaultValue:null,description:"",name:"value_type",required:!1,type:{name:"enum",value:[{value:'"bool"'},{value:'"str"'},{value:'"int"'}]}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/SystemStatus/RenderMetricValueEdit.tsx#RenderMetricValueEdit"]={docgenInfo:L.__docgenInfo,name:"RenderMetricValueEdit",path:"frontend/src/scenes/instance/SystemStatus/RenderMetricValueEdit.tsx#RenderMetricValueEdit"})}catch(t){}var je=a("./node_modules/@ant-design/icons/es/icons/WarningOutlined.js"),De=a("./node_modules/core-js/modules/es.array.find.js"),Ye=a("./node_modules/core-js/modules/es.array.includes.js"),He=a("./node_modules/core-js/modules/es.string.includes.js"),Fe=a("./node_modules/core-js/modules/es.string.starts-with.js"),_=a("./frontend/src/lib/components/InfoMessage/AlertMessage.tsx");function Ce(t){var l=t.metricKey,s=t.oldValue,n=t.value;return(n==null?void 0:n.toString())===(s==null?void 0:s.toString())?null:e.a.createElement("div",{style:{backgroundColor:"var(--border-light)",borderRadius:"var(--radius)",padding:8,marginTop:16}},e.a.createElement("div",null,e.a.createElement("code",null,l)),e.a.createElement("div",{style:{color:"var(--text-muted)"}},"Value will be changed from"," ",e.a.createElement("span",{style:{color:"var(--text-default)",fontWeight:"bold"}},b({key:l,value:s,emptyNullLabel:"Unset"}))," ","to"," ",e.a.createElement("span",{style:{color:"var(--text-default)",fontWeight:"bold"}},b({key:l,value:n}))))}function M(t){var l=t.onClose,s=Object(y.useValues)(u.b),n=s.instanceConfigEditingState,o=s.editableInstanceSettings,r=s.updatedInstanceConfigCount,i=Object(y.useActions)(u.b),m=i.saveInstanceConfig,f=r!==null;return e.a.createElement($.a,{title:"Confirm new changes",visible:!0,okText:"Apply changes",okType:"danger",onCancel:l,maskClosable:!1,onOk:m,okButtonProps:{loading:f},cancelButtonProps:{loading:f},closable:!f},Object.keys(n).find(function(d){return d.startsWith("EMAIL")})&&e.a.createElement(_.a,{style:{marginBottom:16}},e.a.createElement(e.a.Fragment,null,"As you are changing email settings, we'll attempt to send a ",e.a.createElement("b",null,"test email")," so you can verify everything works (unless you are turning email off).")),Object.keys(n).includes("RECORDINGS_TTL_WEEKS")&&e.a.createElement(_.a,{style:{marginBottom:16},type:"warning"},e.a.createElement(e.a.Fragment,null,"Changing your recordings TTL requires ClickHouse to have enough free space to perform the operation (even when reducing this value). In addition, please mind that removing old recordings will be removed asynchronously, not immediately.")),e.a.createElement("div",null,"The following changes will be immediately applied to your instance."),Object.keys(n).map(function(d){var c;return e.a.createElement(Ce,{key:d,metricKey:d,value:n[d],oldValue:(c=o.find(function(v){return v.key===d}))===null||c===void 0?void 0:c.value})}),f&&e.a.createElement("div",{className:"mt text-success"},e.a.createElement("b",null,Object(Q.nb)(r||0,"change")," updated successfully.")))}try{M.displayName="InstanceConfigSaveModal",M.__docgenInfo={description:"",displayName:"InstanceConfigSaveModal",props:{onClose:{defaultValue:null,description:"",name:"onClose",required:!0,type:{name:"() => void"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/SystemStatus/InstanceConfigSaveModal.tsx#InstanceConfigSaveModal"]={docgenInfo:M.__docgenInfo,name:"InstanceConfigSaveModal",path:"frontend/src/scenes/instance/SystemStatus/InstanceConfigSaveModal.tsx#InstanceConfigSaveModal"})}catch(t){}function ee(t,l){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);l&&(n=n.filter(function(o){return Object.getOwnPropertyDescriptor(t,o).enumerable})),s.push.apply(s,n)}return s}function te(t){for(var l=1;l<arguments.length;l++){var s=arguments[l]!=null?arguments[l]:{};l%2?ee(Object(s),!0).forEach(function(n){he()(t,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):ee(Object(s)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(s,n))})}return t}function Oe(){var t=Object(y.useValues)(U.a),l=t.configOptions,s=t.preflightLoading,n=Object(y.useValues)(u.b),o=n.editableInstanceSettings,r=n.instanceSettingsLoading,i=n.instanceConfigMode,m=n.instanceConfigEditingState,f=Object(y.useActions)(u.b),d=f.loadInstanceSettings,c=f.setInstanceConfigMode,v=f.updateInstanceConfigValue,p=f.clearInstanceConfigEditing;Object(Se.a)({e:{action:function(){return c(u.a.Edit)},disabled:i!==u.a.View||r},escape:{action:function(){return j()},disabled:i!==u.a.Edit||r},enter:{action:function(){return R()},disabled:i!==u.a.Edit||r}});var R=function(){Object.keys(m).length?c(u.a.Saving):c(u.a.View)},j=function(){c(u.a.View),p()};Object(V.useEffect)(function(){d()},[]);var I=[{title:"Key",dataIndex:"key",render:function(k){return e.a.createElement("code",null,k)}},{title:"Description",dataIndex:"description"},{title:"Value",render:function(k,x){var Y,ae={value:x.value,key:x.key,emptyNullLabel:"Unset",value_type:x.value_type};return i===u.a.View?b(ae):L(te(te({},ae),{},{value:(Y=m[x.key])!==null&&Y!==void 0?Y:x.value,onValueChanged:v}))},width:300}],E=[{key:"metric",title:"Metric",dataIndex:"metric"},{title:"Value",dataIndex:"value"}];return e.a.createElement("div",null,e.a.createElement("div",{className:"flex-center"},e.a.createElement("div",{style:{flexGrow:1}},e.a.createElement("h3",{className:"l3",style:{marginTop:16}},"Instance configuration"),e.a.createElement("div",{className:"mb"},"Changing these settings will take effect on your entire instance."," ",e.a.createElement("a",{href:"https://posthog.com/docs/self-host/configure/instance-settings",target:"_blank"},"Learn more ",e.a.createElement(C.IconOpenInNew,{style:{verticalAlign:"middle"}})),".")),i===u.a.View?e.a.createElement(e.a.Fragment,null,e.a.createElement(be.a,{type:"primary",onClick:function(){return c(u.a.Edit)},"data-attr":"instance-config-edit-button",hotkey:"e",disabled:r},"Edit")):e.a.createElement(e.a.Fragment,null,Object.keys(m).length>0&&e.a.createElement("span",{style:{color:"var(--warning)"}},e.a.createElement(je.a,null)," You have ",e.a.createElement("b",null,Object.keys(m).length)," ","unapplied"," ",Object(Q.nb)(Object.keys(m).length,"change",void 0,!1)),e.a.createElement(S.a,{type:"link",disabled:r,onClick:j},"Discard changes"),e.a.createElement(S.a,{type:"primary",disabled:r,onClick:R},"Save"))),e.a.createElement(q.a,{dataSource:o,columns:I,loading:r,rowKey:"key"}),e.a.createElement("h3",{className:"l3",style:{marginTop:32}},"Environment configuration"),e.a.createElement("div",{className:"mb"},"These settings can only be modified by environment variables."," ",e.a.createElement("a",{href:"https://posthog.com/docs/self-host/configure/environment-variables",target:"_blank"},"Learn more ",e.a.createElement(C.IconOpenInNew,{style:{verticalAlign:"middle"}})),"."),e.a.createElement(q.a,{dataSource:l,columns:E,loading:s,rowKey:"key"}),i===u.a.Saving&&e.a.createElement(M,{onClose:function(){return c(u.a.Edit)}}))}var Ie=a("./frontend/src/scenes/userLogic.tsx"),xe={component:ne,logic:u.b};function ne(){var t=Object(y.useValues)(u.b),l=t.tab,s=t.error,n=t.systemStatus,o=Object(y.useActions)(u.b),r=o.setTab,i=Object(y.useValues)(U.a),m=i.preflight,f=i.siteUrlMisconfigured,d=Object(y.useValues)(Ie.a),c=d.user;return e.a.createElement("div",{className:"system-status-scene"},e.a.createElement(re.a,{title:"Instance status & settings",caption:e.a.createElement(e.a.Fragment,null,"Here you can find all the critical runtime details and settings of your PostHog instance. You have access to this because you're a ",e.a.createElement("b",null,"staff user"),"."," ",e.a.createElement("a",{target:"_blank",style:{display:"inline-flex",alignItems:"center"},href:"https://posthog.com/docs/self-host/configure/instance-settings?utm_medium=in-product&utm_campaign=instance_status"},"Learn more ",e.a.createElement(C.IconOpenInNew,{style:{marginLeft:4}})),".")}),s&&e.a.createElement(F.a,{message:"Something went wrong",description:s||e.a.createElement("span",null,"An unknown error occurred. Please try again or contact us."),type:"error",showIcon:!0}),f&&e.a.createElement(F.a,{message:"Misconfiguration detected",description:e.a.createElement(e.a.Fragment,null,"Your ",e.a.createElement("code",null,"SITE_URL")," environment variable seems misconfigured. Your"," ",e.a.createElement("code",null,"SITE_URL")," is set to"," ",e.a.createElement("b",null,e.a.createElement("code",null,m==null?void 0:m.site_url))," ","but you're currently browsing this page from"," ",e.a.createElement("b",null,e.a.createElement("code",null,window.location.origin)),". In order for PostHog to work properly, please set this to the origin where your instance is hosted."," ",e.a.createElement("a",{target:"_blank",rel:"noopener",href:"https://posthog.com/docs/configuring-posthog/environment-variables?utm_medium=in-product&utm_campaign=system-status-site-url-misconfig"},"Learn more ",e.a.createElement(C.IconOpenInNew,null))),showIcon:!0,type:"warning",style:{marginBottom:32}}),e.a.createElement(T.a,{tabPosition:"top",animated:!1,activeKey:l,onTabClick:function(p){return r(p)}},e.a.createElement(T.a.TabPane,{tab:"System overview",key:"overview"},e.a.createElement(ue,null)),(n==null?void 0:n.internal_metrics.clickhouse)&&e.a.createElement(T.a.TabPane,{tab:"Internal metrics",key:"metrics"},e.a.createElement(pe,null)),(c==null?void 0:c.is_staff)&&e.a.createElement(T.a.TabPane,{tab:e.a.createElement(e.a.Fragment,null,"Settings ",e.a.createElement(A.a,{type:"warning"},"Beta")),key:"settings"},e.a.createElement(Oe,null))))}},"./node_modules/css-loader/dist/cjs.js!./node_modules/postcss-loader/src/index.js!./node_modules/sass-loader/dist/cjs.js?!./frontend/src/scenes/instance/SystemStatus/index.scss":function(N,h,a){var w=a("./node_modules/css-loader/dist/runtime/api.js");h=w(!1),h.push([N.i,".system-status-scene{margin-bottom:64px}@media(min-width:750px){.system-status-scene .metric-column{width:33%}}.embedded-svg-wrapper{cursor:text}.embedded-svg-wrapper svg{width:100%;height:100%}",""]),N.exports=h}}]);
