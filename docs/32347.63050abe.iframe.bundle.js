"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[32347],{"../../frontend/src/scenes/hog-functions/configuration/HogFunctionConfiguration.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{g:()=>HogFunctionConfiguration});var clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),PayGateMini=__webpack_require__("../../frontend/src/lib/components/PayGateMini/PayGateMini.tsx"),More=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/More.tsx"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),hogFunctionConfigurationLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx"),HogFunctionFilters=__webpack_require__("../../frontend/src/scenes/hog-functions/filters/HogFunctionFilters.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.27.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),CyclotronJobInputs=__webpack_require__("../../frontend/src/lib/components/CyclotronJob/CyclotronJobInputs.tsx"),types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),ActionFilter=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts"),src_types=__webpack_require__("../../frontend/src/types.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let humanize=value=>("string"==typeof value&&null!=value?value:"").toLowerCase().replace(/_/g," ").replace(/-/g," ").replace(/\b\w/g,char=>char.toUpperCase()),MappingSummary=(0,react.memo)(function MappingSummary(_ref){var _mapping$filters$even,_mapping$filters$acti,_mapping$filters$even2,_mapping$filters$acti2,_ref2;let{mapping}=_ref,events=null!==(_mapping$filters$even=mapping.filters?.events?.map(event=>{var _event$name;return null!==(_event$name=event.name)&&void 0!==_event$name?_event$name:event.id}))&&void 0!==_mapping$filters$even?_mapping$filters$even:[],actions=null!==(_mapping$filters$acti=mapping.filters?.actions?.map(action=>{var _action$name;return null!==(_action$name=action.name)&&void 0!==_action$name?_action$name:action.id}))&&void 0!==_mapping$filters$acti?_mapping$filters$acti:[],propertyFiltersCount=(null!==(_mapping$filters$even2=mapping.filters?.events?.filter(event=>{var _event$properties$len;return null!==(_event$properties$len=event.properties?.length)&&void 0!==_event$properties$len?_event$properties$len:0}))&&void 0!==_mapping$filters$even2?_mapping$filters$even2:[]).length+(null!==(_mapping$filters$acti2=mapping.filters?.actions?.filter(action=>{var _action$properties$le;return null!==(_action$properties$le=action.properties?.length)&&void 0!==_action$properties$le?_action$properties$le:0}))&&void 0!==_mapping$filters$acti2?_mapping$filters$acti2:[]).length,eventSummary=[...events,...actions].join(", "),firstInput=mapping.inputs_schema?.[0],firstInputValue=null!==(_ref2=firstInput?.key?mapping.inputs?.[firstInput.key]?.value:null)&&void 0!==_ref2?_ref2:"(custom value)";return(0,jsx_runtime.jsxs)("span",{className:"flex flex-1 gap-4 items-center",children:[(0,jsx_runtime.jsxs)("span",{children:[eventSummary?humanize(eventSummary):(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:"All events"})," ",propertyFiltersCount?(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:(0,jsx_runtime.jsx)(src.u,{title:`Events have ${propertyFiltersCount} additional filters`,children:(0,jsx_runtime.jsx)(posthog_icons_es.IconFilter,{})})}):null]}),(0,jsx_runtime.jsx)(posthog_icons_es.IconArrowRight,{className:"text-secondary"}),(0,jsx_runtime.jsx)("span",{children:mapping.name?humanize(mapping.name):"object"==typeof firstInputValue?JSON.stringify(firstInputValue):humanize(firstInputValue)}),(0,jsx_runtime.jsx)("span",{className:"flex-1"}),mapping.disabled?(0,jsx_runtime.jsx)(src.oe,{type:"danger",children:"Disabled"}):null]})});function HogFunctionMapping(_ref3){var _mapping$filters,_mapping$inputs_schem,_mapping$inputs,_parentConfiguration$,_parentConfiguration$2;let{index,mapping,onChange,parentConfiguration}=_ref3,{groupsTaxonomicTypes}=(0,index_esm.useValues)(groupsModel.$),{showSource,sampleGlobalsWithInputs}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"p-3 pl-10 deprecated-space-y-2",children:[mapping.disabled?(0,jsx_runtime.jsx)(src.Vp,{type:"warning",className:"p-2",action:{children:"Enable",onClick:()=>onChange({...mapping,disabled:!1})},children:"This mapping is disabled. It will not trigger the function."}):null,(0,jsx_runtime.jsx)(src.HQ,{children:"Match events and actions"}),(0,jsx_runtime.jsx)(ActionFilter.T,{filters:null!==(_mapping$filters=mapping.filters)&&void 0!==_mapping$filters?_mapping$filters:{},setFilters:f=>onChange({...mapping,filters:f}),typeKey:"match-group",mathAvailability:ActionFilterRow.Qq.None,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:[types.t.Events,types.t.Actions],propertiesTaxonomicGroupTypes:[types.t.EventProperties,types.t.EventFeatureFlags,types.t.Elements,types.t.PersonProperties,types.t.HogQLExpression,...groupsTaxonomicTypes],propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:src_types.DC.EVENTS},buttonProps:{type:"secondary"},buttonCopy:"Add event matcher"}),(0,jsx_runtime.jsx)(lib.Group,{name:["mappings",index],children:(0,jsx_runtime.jsx)(CyclotronJobInputs.c,{configuration:{inputs_schema:null!==(_mapping$inputs_schem=mapping.inputs_schema)&&void 0!==_mapping$inputs_schem?_mapping$inputs_schem:[],inputs:null!==(_mapping$inputs=mapping.inputs)&&void 0!==_mapping$inputs?_mapping$inputs:{}},parentConfiguration:{inputs_schema:null!==(_parentConfiguration$=parentConfiguration.inputs_schema)&&void 0!==_parentConfiguration$?_parentConfiguration$:[],inputs:null!==(_parentConfiguration$2=parentConfiguration.inputs)&&void 0!==_parentConfiguration$2?_parentConfiguration$2:{}},onInputSchemaChange:schema=>{onChange({...mapping,inputs_schema:schema})},onInputChange:(key,value)=>{onChange({...mapping,inputs:{...mapping.inputs,[key]:value}})},showSource:showSource,sampleGlobalsWithInputs:sampleGlobalsWithInputs})}),showSource?(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),size:"small",type:"secondary",className:"my-4",onClick:()=>{var _mapping$inputs_schem2,_mapping$inputs_schem3;onChange({...mapping,inputs_schema:[...null!==(_mapping$inputs_schem2=mapping.inputs_schema)&&void 0!==_mapping$inputs_schem2?_mapping$inputs_schem2:[],{type:"string",key:`var_${(null!==(_mapping$inputs_schem3=mapping.inputs_schema?.length)&&void 0!==_mapping$inputs_schem3?_mapping$inputs_schem3:0)+1}`,label:"",required:!1}]})},children:"Add input variable"}):null]})})}function HogFunctionMappings(){let{useMapping,mappingTemplates,configuration}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),[activeKeys,setActiveKeys]=(0,react.useState)([]);return((0,react.useEffect)(()=>{configuration.mappings?.length===1&&setActiveKeys([0])},[configuration.mappings?.length]),useMapping)?(0,jsx_runtime.jsx)(LemonField.D,{name:"mappings",children:_ref4=>{let{value,onChange}=_ref4;if(!value)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let addMapping=template=>{let mappingTemplate=mappingTemplates.find(t=>t.name===template);if(mappingTemplate){let{name,...mapping}=mappingTemplate,inputs=mapping.inputs_schema?Object.fromEntries(mapping.inputs_schema.filter(m=>void 0!==m.default).map(m=>[m.key,{value:structuredClone(m.default)}])):{};onChange([...value,{...mapping,name,inputs}]),setActiveKeys([...activeKeys,value.length])}},duplicateMapping=mapping=>{let index=value.findIndex(m=>m===mapping);if(-1!==index){let newMappings=[...value];newMappings.splice(index+1,0,mapping),onChange(newMappings),setActiveKeys([index+1])}},removeMapping=mapping=>{let index=value.findIndex(m=>m===mapping);-1!==index&&(onChange(value.filter((_,i)=>i!==index)),setActiveKeys(activeKeys.filter(i=>i!==index)))},toggleDisabled=mapping=>{let index=value.findIndex(m=>m===mapping);-1!==index&&onChange(value.map((m,i)=>i===index?{...m,disabled:!m.disabled}:m))},renameMapping=mapping=>{src.dn.openForm({title:"Rename mapping",initialValues:{mappingName:mapping.name},content:(0,jsx_runtime.jsx)(LemonField.D,{name:"mappingName",children:(0,jsx_runtime.jsx)(src.DF,{"data-attr":"mapping-name",placeholder:"Please enter the new name",autoFocus:!0})}),errors:{mappingName:name=>name?void 0:"You must enter a name"},onSubmit:async _ref5=>{let{mappingName}=_ref5,index=value.findIndex(m=>m===mapping);-1!==index&&onChange(value.map((m,i)=>i===index?{...m,name:mappingName}:m))}})},addMappingButton=mappingTemplates.length?(0,jsx_runtime.jsx)(src.Yv,{placeholder:"Add mapping",onChange:template=>{addMapping(template)},options:mappingTemplates.map(t=>({label:t.name,value:t.name}))}):null;return(0,jsx_runtime.jsxs)("div",{className:"p-3 rounded border bg-surface-primary",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-start",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Mappings"}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-secondary",children:"Configure which events should act as triggers including filters and custom transformations"})]}),addMappingButton]}),(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:value.length?(0,jsx_runtime.jsx)("div",{className:"-mx-3 border-t border-b",children:(0,jsx_runtime.jsx)(src.JL,{multiple:!0,embedded:!0,activeKeys:activeKeys,onChange:activeKeys=>setActiveKeys(activeKeys),panels:value.map((mapping,index)=>({key:index,header:{children:(0,jsx_runtime.jsx)(MappingSummary,{mapping:mapping}),sideAction:{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{}),dropdown:{overlay:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-px",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>toggleDisabled(mapping),children:mapping.disabled?"Enable":"Disable"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>renameMapping(mapping),children:"Rename"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>duplicateMapping(mapping),children:"Duplicate"}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",onClick:()=>removeMapping(mapping),children:"Remove"})]})}}},className:"p-0 bg-accent-light",content:(0,jsx_runtime.jsx)(HogFunctionMapping,{parentConfiguration:configuration,index:index,mapping:mapping,onChange:mapping=>{mapping?onChange(value.map((m,i)=>i===index?mapping:m)):onChange(value.filter((_,i)=>i!==index))}},index)}))})}):(0,jsx_runtime.jsx)(src.Vp,{type:"warning",className:"p-2",children:"You have no mappings configured which effectively means the function is disabled as there is nothing to trigger it."})})]})}}):null}var Sparkline=__webpack_require__("../../frontend/src/lib/components/Sparkline.tsx"),LemonBanner=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonBanner/index.ts"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),Query=__webpack_require__("../../frontend/src/queries/Query/Query.tsx");function HogFunctionEventEstimates(){var _sparkline$count,_sparkline$count2;let{sparkline,sparklineLoading,eventsDataTableNode,showEventsList,type,configuration}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{setShowEventsList}=(0,index_esm.useActions)(hogFunctionConfigurationLogic.nM),hasMasking=!!configuration.masking;if(!eventsDataTableNode)return null;let dataTableNode={...eventsDataTableNode,full:!0},insightUrl=urls.j.insightNew({type:src_types.dw.SQL,query:dataTableNode}),canvasUrl=urls.j.canvas()+"#🦔="+btoa(JSON.stringify({type:"doc",content:[{type:"ph-query",attrs:{query:dataTableNode}}]}));return(0,jsx_runtime.jsxs)("div",{className:"relative p-3 rounded border deprecated-space-y-2 bg-surface-primary",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Matching events"}),sparkline&&!sparklineLoading?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[sparkline.count>8e3&&"transformation"!==type?(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"warning",children:[(0,jsx_runtime.jsx)("b",{children:"Warning:"})," This destination would have triggered"," ",(0,jsx_runtime.jsxs)("strong",{children:[null!==(_sparkline$count=sparkline.count)&&void 0!==_sparkline$count?_sparkline$count:0," time",1!==sparkline.count?"s":""]})," ","in the last 7 days. Consider the impact of this function on your destination."]}):(0,jsx_runtime.jsxs)("p",{children:["This ",type," would have triggered"," ",(0,jsx_runtime.jsxs)("strong",{children:[null!==(_sparkline$count2=sparkline.count)&&void 0!==_sparkline$count2?_sparkline$count2:0," time",1!==sparkline.count?"s":""]})," ","in the last 7 days."]}),hasMasking&&(0,jsx_runtime.jsx)("p",{children:"The estimate does not take into account trigger options."}),"warning"in sparkline&&sparkline.warning&&(0,jsx_runtime.jsx)(LemonBanner.V,{type:"info",children:sparkline.warning}),(0,jsx_runtime.jsx)(Sparkline.b,{type:"bar",className:"w-full h-20",data:sparkline.data,labels:sparkline.labels})]}):sparklineLoading?(0,jsx_runtime.jsx)("div",{className:"min-h-20",children:(0,jsx_runtime.jsx)(src.t2,{})}):(0,jsx_runtime.jsx)("p",{children:"The expected volume could not be calculated"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 pt-2 border-t border-dashed",children:[(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>setShowEventsList(!showEventsList),fullWidth:!0,center:!0,children:showEventsList?"Hide matching events":"Show matching events"}),showEventsList?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-end items-start",children:(0,jsx_runtime.jsx)(src.Yv,{placeholder:"Open in...",onChange:target=>{"insight"===target?window.open(insightUrl,"_blank"):"canvas"===target&&window.open(canvasUrl,"_blank")},options:[{label:"New insight",value:"insight"},{label:"New canvas",value:"canvas"}]})}),(0,jsx_runtime.jsx)("div",{className:"flex overflow-y-auto flex-col flex-1 rounded border max-h-200",children:eventsDataTableNode&&(0,jsx_runtime.jsx)(Query.A,{query:{...eventsDataTableNode,full:!1,showEventFilter:!1,showPropertyFilter:!1,embedded:!0,showOpenEditorButton:!1,showHogQLEditor:!1,showTimings:!1}})})]}):null]})]})}var hog_function_utils=__webpack_require__("../../frontend/src/scenes/hog-functions/hog-function-utils.ts"),HogFunctionStatusIndicator=__webpack_require__("../../frontend/src/scenes/hog-functions/misc/HogFunctionStatusIndicator.tsx"),HogFunctionStatusTag=__webpack_require__("../../frontend/src/scenes/hog-functions/misc/HogFunctionStatusTag.tsx"),HogFunctionIcon=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/HogFunctionIcon.tsx"),editor_main=__webpack_require__("../../node_modules/.pnpm/monaco-editor@0.49.0/node_modules/monaco-editor/esm/vs/editor/editor.main.js"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),CodeEditorResizable=__webpack_require__("../../frontend/src/lib/monaco/CodeEditorResizable.tsx"),hogFunctionTestLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionTestLogic.tsx");let HogFunctionTestEditor=_ref2=>{let{value,onChange,readOnly=!1}=_ref2,editorRef=(0,react.useRef)(null),decorationsRef=(0,react.useRef)([]),handleValidation=newValue=>{if(!editorRef.current?.getModel())return;let model=editorRef.current.getModel();editor_main.editor.setModelMarkers(model,"owner",[]),decorationsRef.current=editorRef.current.deltaDecorations(decorationsRef.current,[]);try{JSON.parse(newValue)}catch(err){let match=err.message.match(/position (\d+)/);if(match){let position=parseInt(match[1],10),pos=model.getPositionAt(position);editor_main.editor.setModelMarkers(model,"owner",[{startLineNumber:pos.lineNumber,startColumn:pos.column,endLineNumber:pos.lineNumber,endColumn:pos.column+1,message:err.message,severity:editor_main.MarkerSeverity.Error}]),decorationsRef.current=editorRef.current.deltaDecorations(decorationsRef.current,[{range:{startLineNumber:pos.lineNumber,startColumn:1,endLineNumber:pos.lineNumber,endColumn:model.getLineLength(pos.lineNumber)+1},options:{isWholeLine:!0,className:"bg-danger-highlight",glyphMarginClassName:"text-danger flex items-center justify-center",glyphMarginHoverMessage:{value:err.message}}}]),editorRef.current.revealLineInCenter(pos.lineNumber)}}};return(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",value:value,height:400,onChange:newValue=>{readOnly||(onChange?.(newValue),handleValidation(null!=newValue?newValue:""))},onMount:editor=>{editorRef.current=editor,handleValidation(value)},options:{lineNumbers:"on",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"auto",verticalScrollbarSize:14},folding:!0,glyphMargin:!0,readOnly:readOnly}})};function HogFunctionTest(){var _testResult$logs;let{logicProps,canLoadSampleGlobals,hogFunction,template}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{isTestInvocationSubmitting,testResult,expanded,sampleGlobalsLoadingAndNotCancelled,sampleGlobalsError,type,savedGlobals,testInvocation,testResultMode,sortedTestsResult,jsonError}=(0,index_esm.useValues)((0,hogFunctionTestLogic.g)(logicProps)),{submitTestInvocation,setTestResult,toggleExpanded,loadSampleGlobals,deleteSavedGlobals,setSampleGlobals,saveGlobals,setTestResultMode,cancelSampleGlobalsLoading}=(0,index_esm.useActions)((0,hogFunctionTestLogic.g)(logicProps)),testResultsRef=(0,react.useRef)(null),inactive=!expanded,canMockFetchRequests=template?.id?.startsWith("template-")||hogFunction?.template?.id?.startsWith("template-");return(0,jsx_runtime.jsxs)(lib.Form,{logic:hogFunctionTestLogic.g,props:logicProps,formKey:"testInvocation",enableFormOnSubmit:!0,children:[(0,jsx_runtime.jsxs)("div",{ref:testResultsRef,className:(0,clsx_m.default)("p-3 rounded border deprecated-space-y-2",expanded?"bg-surface-primary":"bg-surface-secondary",expanded?"min-h-120":""),children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-end items-center",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("h2",{className:"flex gap-2 items-center mb-0",children:(0,jsx_runtime.jsx)("span",{children:"Testing"})}),inactive?(0,jsx_runtime.jsx)("p",{children:"Click here to test your function with an example event"}):null]}),inactive?(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"expand-hog-testing",type:"secondary",onClick:()=>{toggleExpanded(),setTimeout(()=>{testResultsRef.current?.scrollIntoView({behavior:"smooth",block:"start"})},100)},children:"Start testing"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[testResult?(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>setTestResult(null),loading:isTestInvocationSubmitting,"data-attr":"clear-hog-test-result",children:"Clear test result"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(More.T,{dropdown:{closeOnClickInside:!1},overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[canMockFetchRequests&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"mock_async_functions",children:_ref3=>{let{value,onChange}=_ref3;return(0,jsx_runtime.jsx)(src.f4,{onChange:v=>onChange(!v),checked:!value,"data-attr":"toggle-hog-test-mocking",className:"px-2 py-1",label:(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"When disabled, async functions such as `fetch` will not be called. Instead they will be mocked out and logged."}),children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2",children:["Make real HTTP requests",(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-lg"})]})})})}}),(0,jsx_runtime.jsx)(src.p2,{})]}),savedGlobals.map((_ref4,index)=>{let{name,globals}=_ref4;return(0,jsx_runtime.jsxs)("div",{className:"flex justify-between w-full",children:[(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"open-hog-test-data",onClick:()=>setSampleGlobals(globals),fullWidth:!0,className:"flex-1",children:name},index),(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"delete-hog-test-data",size:"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>deleteSavedGlobals(index),tooltip:"Delete saved test data"})]},index)}),testInvocation.globals&&(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,"data-attr":"save-hog-test-data",onClick:()=>{let name=prompt("Name this test data");name&&saveGlobals(name,JSON.parse(testInvocation.globals))},disabledReason:(()=>{try{JSON.parse(testInvocation.globals)}catch{return"Invalid globals JSON"}})(),children:"Save test data"})]})}),canLoadSampleGlobals?(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>{sampleGlobalsLoadingAndNotCancelled?cancelSampleGlobalsLoading():loadSampleGlobals()},tooltip:"Find the last event matching filters, and use it to populate the globals below.",icon:sampleGlobalsLoadingAndNotCancelled?(0,jsx_runtime.jsx)(src.$j,{}):void 0,children:sampleGlobalsLoadingAndNotCancelled?"Cancel loading":"Load new event"}):null,(0,jsx_runtime.jsx)(src.Jp,{type:"primary","data-attr":"test-hog-function",onClick:submitTestInvocation,loading:isTestInvocationSubmitting,children:"Test function"})]}),expanded&&(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"hide-hog-testing",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>toggleExpanded(),tooltip:"Hide testing"})]})]}),expanded?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:testResult?(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2","data-attr":"test-results",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"success"===testResult.status?"success":"skipped"===testResult.status?"warning":"error",children:"success"===testResult.status?"Success":"skipped"===testResult.status?`${type.charAt(0).toUpperCase()+type.slice(1)} was skipped because the event did not match the filter criteria`:"Error"}),"transformation"===type&&"error"!==testResult.status?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-between items-center",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Transformation result"}),sortedTestsResult?.hasDiff&&(0,jsx_runtime.jsx)(src.P4,{size:"xsmall",options:[{value:"raw",label:"Output"},{value:"diff",label:"Diff"}],onChange:value=>setTestResultMode(value),value:testResultMode})]}),(0,jsx_runtime.jsx)("p",{children:"Below you can see the event after the transformation has been applied."}),testResult.result?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!sortedTestsResult?.hasDiff&&(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:"skipped"===testResult.status?"The event was not modified as it did not match the filter criteria.":"The event was unmodified by the transformation."}),(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",originalValue:sortedTestsResult?.hasDiff&&"diff"===testResultMode?sortedTestsResult?.input:void 0,value:sortedTestsResult?.output,height:400,options:{readOnly:!0,lineNumbers:"off",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"hidden",verticalScrollbarSize:0},folding:!0}})]}):(0,jsx_runtime.jsx)(src.Vp,{type:"warning",children:"The event was dropped by the transformation. If this is expected then great news! If not, you should double check the configuration."})]}):null,(0,jsx_runtime.jsx)(src.HQ,{children:"Test invocation logs"}),(0,jsx_runtime.jsx)(src.g3,{dataSource:null!==(_testResult$logs=testResult.logs)&&void 0!==_testResult$logs?_testResult$logs:[],columns:[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:timestamp=>(0,jsx_runtime.jsx)(TZLabel.w,{time:timestamp}),width:0},{width:100,title:"Level",key:"level",dataIndex:"level"},{title:"Message",key:"message",dataIndex:"message",render:message=>(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}],className:"ph-no-capture",rowKey:"timestamp",pagination:{pageSize:200,hideOnSinglePage:!0}})]}):(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"globals",children:_ref5=>{let{value,onChange}=_ref5;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"Here are all the global variables you can use in your code:"}),sampleGlobalsError?(0,jsx_runtime.jsx)("div",{className:"text-warning",children:sampleGlobalsError}):null]}),(0,jsx_runtime.jsx)(HogFunctionTestEditor,{value:value,onChange:onChange,readOnly:sampleGlobalsLoadingAndNotCancelled})]})}})})}):null]}),jsonError&&(0,jsx_runtime.jsxs)(src.Vp,{type:"error",children:["JSON Error: ",jsonError]})]})}var MaxTool=__webpack_require__("../../frontend/src/scenes/max/MaxTool.tsx");function HogFunctionTemplateOptions(){let{hogFunction,templateHasChanged}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{resetToTemplate,duplicateFromTemplate}=(0,index_esm.useActions)(hogFunctionConfigurationLogic.nM);return(0,jsx_runtime.jsxs)("div",{className:"p-1 max-w-120",children:[(0,jsx_runtime.jsxs)("p",{children:["This function was built from the template ",(0,jsx_runtime.jsx)("b",{children:hogFunction?.template?.name}),".",templateHasChanged?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),"It has different code to the latest version, either due to custom modifications or updates to the template."]}):null]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-1 gap-2 items-center pt-2 border-t",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(src.Jp,{children:"Close"})}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>duplicateFromTemplate(),children:"New function from template"}),templateHasChanged?(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>resetToTemplate(),children:"Reset to template"}):null]})]})}function HogFunctionCode(){var _configuration$hog;let{showSource,configuration,sampleGlobalsWithInputs,hasAddon,templateHasChanged,type,mightDropEvents,oldHogCode,newHogCode}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{setShowSource,setOldHogCode,setNewHogCode,clearHogCodeDiff,reportAIHogFunctionPrompted,reportAIHogFunctionAccepted,reportAIHogFunctionRejected,reportAIHogFunctionPromptOpen}=(0,index_esm.useActions)(hogFunctionConfigurationLogic.nM),sourceCodeRef=(0,react.useRef)(null),content=(0,jsx_runtime.jsxs)("div",{ref:sourceCodeRef,className:(0,clsx_m.default)("p-3 rounded border deprecated-space-y-2",showSource?"bg-surface-primary":"bg-surface-secondary"),children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-end items-center",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0",children:"Edit source"}),showSource?null:(0,jsx_runtime.jsx)("p",{children:"Click here to edit the function's source code"})]}),templateHasChanged?(0,jsx_runtime.jsx)(src.Qw,{showArrow:!0,overlay:(0,jsx_runtime.jsx)(HogFunctionTemplateOptions,{}),children:(0,jsx_runtime.jsx)(src.Jp,{type:"tertiary",size:showSource?"xsmall":"small",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{}),children:"Modified code"})}):null,showSource?(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"secondary",onClick:()=>setShowSource(!1),children:"Hide source code"}):(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>{setShowSource(!0),setTimeout(()=>{sourceCodeRef.current?.scrollIntoView({behavior:"smooth",block:"start"})},100)},disabledReason:hasAddon||"transformation"===type?void 0:"Editing the source code requires the Data Pipelines addon",children:"Edit source code"})]}),showSource?(0,jsx_runtime.jsx)(LemonField.D,{name:"hog",children:_ref=>{var _ref2;let{value,onChange}=_ref;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[type.startsWith("site_")?null:(0,jsx_runtime.jsxs)("span",{className:"text-xs text-secondary",children:["This is the underlying Hog code that will run whenever this triggers."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/hog",children:"See the docs"})," for more info"]}),mightDropEvents&&(0,jsx_runtime.jsxs)(src.Vp,{type:"warning",className:"mt-2",children:[(0,jsx_runtime.jsx)("b",{children:"Warning:"})," Returning null or undefined will drop the event. If this is unintentional, return the event object instead."]}),"source_webhook"===type&&(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"mt-2",children:[(0,jsx_runtime.jsx)("b",{children:"HTTP requests:"})," Webhook sources can call ",(0,jsx_runtime.jsx)("code",{children:"postHogCapture"})," to ingest events to PostHog. You can also do HTTP calls with ",(0,jsx_runtime.jsx)("code",{children:"fetch"}),". In this case however, the request will be queued to a background task, a ",(0,jsx_runtime.jsx)("code",{children:"201 Created"})," ","response will be returned and the event will be ingested asynchronously."]}),(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:type.startsWith("site_")?"typescript":"hog",value:null!==(_ref2=null!=newHogCode?newHogCode:value)&&void 0!==_ref2?_ref2:"",originalValue:oldHogCode&&newHogCode?oldHogCode:void 0,onChange:v=>{oldHogCode&&newHogCode&&clearHogCodeDiff(),onChange(null!=v?v:"")},globals:sampleGlobalsWithInputs,showDiffActions:!!(oldHogCode&&newHogCode),onAcceptChanges:()=>{newHogCode&&onChange(newHogCode),reportAIHogFunctionAccepted(),clearHogCodeDiff()},onRejectChanges:()=>{oldHogCode&&onChange(oldHogCode),reportAIHogFunctionRejected(),clearHogCodeDiff()},options:{minimap:{enabled:!1},wordWrap:"on",scrollBeyondLastLine:!1,automaticLayout:!0,fixedOverflowWidgets:!0,suggest:{showInlineDetails:!0},quickSuggestionsDelay:300,readOnly:!!(oldHogCode&&newHogCode)}})]})}}):null]});return(0,jsx_runtime.jsx)(MaxTool.Z,{identifier:"create_hog_transformation_function",context:{current_hog_code:null!==(_configuration$hog=configuration.hog)&&void 0!==_configuration$hog?_configuration$hog:""},callback:toolOutput=>{var _configuration$hog2;setOldHogCode(null!==(_configuration$hog2=configuration.hog)&&void 0!==_configuration$hog2?_configuration$hog2:""),setNewHogCode(toolOutput),reportAIHogFunctionPrompted()},onMaxOpen:()=>{reportAIHogFunctionPromptOpen()},suggestions:[],introOverride:{headline:"What transformation do you want to create?",description:"Let me help you quickly write the code for your transformation, and tweak it."},children:content})}var PayGateButton=__webpack_require__("../../frontend/src/lib/components/PayGateMini/PayGateButton.tsx");function HogFunctionInputs(){var _ref,_configuration$inputs,_configuration$inputs4,_configuration$hog;let{showSource,configuration,sampleGlobalsWithInputs,usesGroups,hasGroupsAddon,oldInputs,newInputs,canEditSource}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{setConfigurationValue,setOldInputs,setNewInputs,clearInputsDiff,reportAIHogFunctionInputsPrompted,reportAIHogFunctionInputsAccepted,reportAIHogFunctionInputsRejected,reportAIHogFunctionInputsPromptOpen}=(0,index_esm.useActions)(hogFunctionConfigurationLogic.nM),content=(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("p-3 rounded border deprecated-space-y-2 bg-surface-primary"),children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[usesGroups&&!hasGroupsAddon?(0,jsx_runtime.jsx)(src.Vp,{type:"warning",children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2 items-center",children:["This function appears to use Groups but you do not have the Groups Analytics addon. Without it, you may see empty values where you use templates like ",'"{groups.kind.properties}"',(0,jsx_runtime.jsx)(PayGateButton.R,{feature:src_types.P$.GROUP_ANALYTICS,type:"secondary"})]})}):null,(0,jsx_runtime.jsx)(CyclotronJobInputs.c,{configuration:{inputs_schema:null!==(_ref=null!=newInputs?newInputs:configuration.inputs_schema)&&void 0!==_ref?_ref:[],inputs:null!==(_configuration$inputs=configuration.inputs)&&void 0!==_configuration$inputs?_configuration$inputs:{}},onInputSchemaChange:schema=>{oldInputs&&newInputs&&clearInputsDiff(),setConfigurationValue("inputs_schema",schema)},onInputChange:(key,input)=>{setConfigurationValue(`inputs.${key}`,input)},showSource:showSource,sampleGlobalsWithInputs:sampleGlobalsWithInputs}),oldInputs&&newInputs&&(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center p-2 mt-4 rounded border border-dashed bg-surface-secondary",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1 text-center",children:(0,jsx_runtime.jsx)("span",{className:"text-sm font-medium",children:"Suggested by Max"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{status:"danger",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>{reportAIHogFunctionInputsRejected(),clearInputsDiff()},tooltipPlacement:"top",size:"small",children:"Reject"}),(0,jsx_runtime.jsx)(src.Jp,{type:"tertiary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconCheck,{color:"var(--success)"}),onClick:()=>{newInputs&&setConfigurationValue("inputs_schema",newInputs),reportAIHogFunctionInputsAccepted(),clearInputsDiff()},tooltipPlacement:"top",size:"small",children:"Accept"})]})]}),showSource&&canEditSource?(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),size:"small",type:"secondary",className:"my-4",onClick:()=>{var _configuration$inputs2,_configuration$inputs3;setConfigurationValue("inputs_schema",[...null!==(_configuration$inputs2=configuration.inputs_schema)&&void 0!==_configuration$inputs2?_configuration$inputs2:[],{type:"string",key:`input_${(null!==(_configuration$inputs3=configuration.inputs_schema?.length)&&void 0!==_configuration$inputs3?_configuration$inputs3:0)+1}`,label:"",required:!1}])},children:"Add input variable"}):null]})});return(0,jsx_runtime.jsx)(MaxTool.Z,{identifier:"create_hog_function_inputs",context:{current_inputs_schema:null!==(_configuration$inputs4=configuration.inputs_schema)&&void 0!==_configuration$inputs4?_configuration$inputs4:[],hog_code:null!==(_configuration$hog=configuration.hog)&&void 0!==_configuration$hog?_configuration$hog:""},callback:toolOutput=>{var _configuration$inputs5;setOldInputs(null!==(_configuration$inputs5=configuration.inputs_schema)&&void 0!==_configuration$inputs5?_configuration$inputs5:[]),setNewInputs(toolOutput),reportAIHogFunctionInputsPrompted()},onMaxOpen:()=>{reportAIHogFunctionInputsPromptOpen()},suggestions:[],introOverride:{headline:"What input variables do you need?",description:"Let me help you generate the input variables for your function based on your code and requirements."},children:content})}var CodeSnippet=__webpack_require__("../../frontend/src/lib/components/CodeSnippet/index.ts"),LemonLabel=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonLabel/index.ts"),apiHost=__webpack_require__("../../frontend/src/lib/utils/apiHost.ts");function HogFunctionSourceWebhookInfo(){let{logicProps}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{id}=logicProps;return(0,jsx_runtime.jsxs)("div",{className:"p-3 rounded border deprecated-space-y-2 bg-surface-primary",children:[(0,jsx_runtime.jsx)(LemonLabel.H,{children:"Webhook URL"}),(0,jsx_runtime.jsx)(CodeSnippet.O,{thing:"Webhook URL",children:id?(0,apiHost.ye)()+"/public/webhooks/"+id:"The webhook URL will be shown here once you save"}),(0,jsx_runtime.jsxs)("p",{className:"text-sm",children:["Use this URL in your external system to send events to PostHog. The webhook can be called with a POST request and any JSON payload. You can then use the configuration options to parse the"," ",(0,jsx_runtime.jsx)("code",{children:"request.body"})," or ",(0,jsx_runtime.jsx)("code",{children:"request.headers"})," to map to the required fields."]})]})}var utils=__webpack_require__("../../frontend/src/lib/utils.tsx");let hogFunctionSourceWebhookTestLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{var _ref2;let{id,templateId}=_ref;return null!==(_ref2=null!=id?id:templateId)&&void 0!==_ref2?_ref2:"new"}),(0,index_esm.path)(id=>["scenes","pipeline","hogfunctions","hogFunctionSourceWebhookTestLogic",id]),(0,index_esm.connect)(props=>({values:[(0,hogFunctionConfigurationLogic.nM)(props),["configuration","templateId"]]})),(0,index_esm.actions)({setTestResult:result=>({result}),toggleExpanded:expanded=>({expanded})}),(0,index_esm.reducers)({expanded:[!1,{toggleExpanded:(state,_ref3)=>{let{expanded}=_ref3;return void 0===expanded?!state:expanded}}],testResult:[null,{setTestResult:(_,_ref4)=>{let{result}=_ref4;return result}}]}),(0,lib.forms)(_ref5=>{let{props,actions}=_ref5;return{testInvocation:{defaults:{mock_request:!0,headers:`{
  "Content-Type": "application/json"
}`,body:`{
  "event": "my example event",
  "distinct_id": "webhook-test-123"
}`},alwaysShowErrors:!0,errors:_ref6=>{let{headers,body}=_ref6;return{headers:headers?(0,utils.Cy)(headers)?void 0:"Invalid JSON":"Required",body:body?(0,utils.Cy)(body)?void 0:"Invalid JSON":"Required"}},submit:async data=>{var _props$id;actions.setTestResult(null);let response=await fetch(`${(0,apiHost.ye)()}/public/webhooks/${null!==(_props$id=props.id)&&void 0!==_props$id?_props$id:"unknown"}`,{method:"POST",headers:(0,utils.Cy)(data.headers),body:data.body,credentials:"omit"});actions.setTestResult({status:response.status,body:await response.text()})}}}}),(0,index_esm.selectors)({exampleCurlRequest:[s=>[s.testInvocation,(_,props)=>props],(testInvocation,props)=>{var _props$id2;let headersJson=(0,utils.Cy)(testInvocation.headers),headers=headersJson?Object.entries(headersJson).map(_ref7=>{let[key,value]=_ref7;return`-H "${key}: ${value}"`}).join(" "):"";return`curl -X POST ${headers} \\
  -d '${testInvocation.body}' \\
  ${(0,apiHost.ye)()}/public/webhooks/${null!==(_props$id2=props.id)&&void 0!==_props$id2?_props$id2:"unknown"}`}]})]);function HogFunctionSourceWebhookTest(){let{logicProps,configurationChanged}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{isTestInvocationSubmitting,testResult,expanded,exampleCurlRequest}=(0,index_esm.useValues)(hogFunctionSourceWebhookTestLogic(logicProps)),{submitTestInvocation,setTestResult,toggleExpanded}=(0,index_esm.useActions)(hogFunctionSourceWebhookTestLogic(logicProps)),testResultsRef=(0,react.useRef)(null),unsaved=!logicProps.id;return(0,jsx_runtime.jsx)(lib.Form,{logic:hogFunctionSourceWebhookTestLogic,props:logicProps,formKey:"testInvocation",enableFormOnSubmit:!0,children:(0,jsx_runtime.jsxs)("div",{ref:testResultsRef,className:(0,clsx_m.default)("p-3 rounded border",expanded?"bg-surface-primary":"bg-surface-secondary",expanded?"min-h-120":""),children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-end items-center mb-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("h2",{className:"flex gap-2 items-center mb-0",children:(0,jsx_runtime.jsx)("span",{children:"Testing"})}),expanded?null:unsaved?(0,jsx_runtime.jsx)("p",{children:"Testing tools are only available after creating the webhook"}):(0,jsx_runtime.jsx)("p",{children:"Click here to test your webhook"})]}),expanded?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"mock_request",children:_ref=>{let{value,onChange}=_ref;return(0,jsx_runtime.jsx)(src.f4,{onChange:v=>onChange(!v),checked:!value,"data-attr":"toggle-hog-test-mocking",className:"px-2 py-1",label:(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"When disabled, the webhook request will be sent but only tested without creating events or performing HTTP requests."}),children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-2",children:["Debug webhook request only",(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-lg"})]})})})}}),expanded&&(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"hide-hog-testing",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>toggleExpanded(),tooltip:"Hide testing"})]}):(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"expand-hog-testing",type:"secondary",disabledReason:unsaved?"Testing tools are only available after creating the webhook":void 0,onClick:()=>{toggleExpanded(),setTimeout(()=>{testResultsRef.current?.scrollIntoView({behavior:"smooth",block:"start"})},100)},children:"Start testing"})]}),expanded?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)(src.Vp,{type:configurationChanged?"warning":"info",className:"mb-2",children:[configurationChanged?(0,jsx_runtime.jsx)("span",{children:"You have unsaved changes."}):null,(0,jsx_runtime.jsx)("span",{children:"Testing is performed against the latest saved configuration and will create real events."})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"headers",label:"HTTP Headers",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:(0,jsx_runtime.jsx)("div",{})}),(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",value:value,onChange:onChange,maxHeight:200})]})}}),(0,jsx_runtime.jsx)(LemonField.D,{name:"body",label:"HTTP Body",children:_ref3=>{let{value,onChange}=_ref3;return(0,jsx_runtime.jsx)(CodeEditorResizable.Y,{language:"json",value:value,onChange:onChange,maxHeight:200})}}),(0,jsx_runtime.jsx)(src.p2,{className:"my-4"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 justify-between items-center",children:[(0,jsx_runtime.jsxs)(src.HQ,{className:"flex-1",children:["Response",testResult&&(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.oe,{type:testResult.status>=200&&testResult.status<300?"success":"danger",children:testResult.status})})]}),testResult?(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>setTestResult(null),children:"Clear"}):null,(0,jsx_runtime.jsx)(src.Jp,{type:"primary","data-attr":"test-hog-webhook",onClick:submitTestInvocation,loading:isTestInvocationSubmitting,size:"small",children:"Test webhook"})]}),testResult?(0,jsx_runtime.jsx)("div",{className:"flex flex-col gap-2",children:(0,jsx_runtime.jsx)(CodeSnippet.O,{thing:"Response body",children:testResult.body})}):isTestInvocationSubmitting?(0,jsx_runtime.jsx)(src.yW,{className:"h-12"}):(0,jsx_runtime.jsx)("p",{children:"No response yet"})]})]}),(0,jsx_runtime.jsx)(src.p2,{className:"my-4"}),(0,jsx_runtime.jsx)(CodeSnippet.O,{thing:"Example request",children:exampleCurlRequest})]}):null]})})}var KeyboardShortcut=__webpack_require__("../../frontend/src/layout/navigation-3000/components/KeyboardShortcut.tsx");function InlineEditableField(_ref){let{value,onChange,className,multiline}=_ref,[editingValue,setEditingValue]=(0,react.useState)(value),[isEditing,setIsEditing]=(0,react.useState)(!1);(0,react.useEffect)(()=>{setEditingValue(value)},[value]),(0,react.useEffect)(()=>{isEditing&&setEditingValue(value)},[isEditing,value]);let save=()=>{onChange?.(null!=editingValue?editingValue:""),setIsEditing(!1)};return(0,jsx_runtime.jsx)(src.Qw,{closeOnClickInside:!1,visible:isEditing,onVisibilityChange:visible=>setIsEditing(visible),overlay:(0,jsx_runtime.jsxs)("div",{children:[multiline?(0,jsx_runtime.jsx)(src._V,{value:editingValue,onChange:val=>setEditingValue(val),autoFocus:!0,className:"border-none w-120",onPressEnter:save}):(0,jsx_runtime.jsx)(src.DF,{type:"text",value:editingValue,onChange:val=>setEditingValue(val),autoFocus:!0,className:"border-none w-120",onPressEnter:save,autoWidth:!0}),(0,jsx_runtime.jsx)(src.p2,{className:"my-1"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 justify-end",children:[(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"secondary",onClick:()=>{setEditingValue(value),setIsEditing(!1)},sideIcon:(0,jsx_runtime.jsx)(KeyboardShortcut.e,{escape:!0}),children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"primary",onClick:save,sideIcon:(0,jsx_runtime.jsx)(KeyboardShortcut.e,{enter:!0}),children:"Save"})]})]}),showArrow:!0,children:(0,jsx_runtime.jsx)("span",{className:(0,clsx_m.default)(className,"p-1 -m-1 rounded-sm transition-colors hover:bg-fill-button-tertiary-hover",multiline&&"whitespace-pre-wrap"),onClick:()=>setIsEditing(!0),children:value})})}function HogFunctionConfiguration(_ref){var _ref2,_ref3,_ref4,_template$type;let{templateId,id,logicKey}=_ref,logicProps={templateId,id,logicKey},logic=(0,hogFunctionConfigurationLogic.nM)(logicProps),{isConfigurationSubmitting,configurationChanged,configuration,loading,loaded,hogFunction,willReEnableOnSave,willChangeEnabledOnSave,showPaygate,template,templateHasChanged,type,mightDropEvents,showFilters,showExpectedVolume,canEditSource,showTesting}=(0,index_esm.useValues)(logic),{submitConfiguration,resetForm,duplicate,deleteHogFunction}=(0,index_esm.useActions)(logic);if(loading&&!loaded)return(0,jsx_runtime.jsx)(src.t2,{});if(!loaded)return(0,jsx_runtime.jsx)(NotFound.T,{object:"Hog function"});let isLegacyPlugin=(template?.id||hogFunction?.template?.id)?.startsWith("plugin-"),headerButtons=(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:!templateId&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!isLegacyPlugin&&(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,onClick:()=>duplicate(),children:"Duplicate"}),(0,jsx_runtime.jsx)(src.p2,{}),(0,jsx_runtime.jsx)(src.Jp,{status:"danger",fullWidth:!0,onClick:()=>deleteHogFunction(),children:"Delete"})]})}),(0,jsx_runtime.jsx)(src.p2,{vertical:!0})]})}),saveButtons=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[configurationChanged?(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",htmlType:"reset",onClick:()=>resetForm(),disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress…":void 0:"No changes",children:"Clear changes"}):null,(0,jsx_runtime.jsxs)(src.Jp,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,children:[templateId?"Create":"Save",willReEnableOnSave?" & re-enable":willChangeEnabledOnSave?` & ${configuration.enabled?"enable":"disable"}`:""]})]});return showPaygate?(0,jsx_runtime.jsx)(PayGateMini.E,{feature:src_types.P$.DATA_PIPELINES}):(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-3",children:(0,jsx_runtime.jsxs)(index_esm.BindLogic,{logic:hogFunctionConfigurationLogic.nM,props:logicProps,children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[headerButtons,saveButtons]})}),hogFunction?.filters?.bytecode_error?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)(src.Vp,{type:"error",children:[(0,jsx_runtime.jsx)("b",{children:"Error saving filters:"})," ",hogFunction.filters.bytecode_error]})}):["template-google-ads","template-meta-ads","template-tiktok-ads","template-snapchat-ads","template-linkedin-ads","template-reddit-pixel","template-tiktok-pixel","template-snapchat-pixel","template-reddit-conversions-api"].includes(null!==(_ref2=null!=templateId?templateId:hogFunction?.template?.id)&&void 0!==_ref2?_ref2:"")||template?.status==="alpha"||hogFunction?.template?.status==="alpha"?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)(src.Vp,{type:"warning",children:[(0,jsx_runtime.jsxs)("p",{children:["This ",(0,hog_function_utils.S)(type)," is currently in an experimental state. For many cases this will work just fine but for others there may be unexpected issues and we do not offer official customer support for it in these cases."]}),["template-reddit-conversions-api","template-snapchat-ads"].includes(null!==(_ref3=null!=templateId?templateId:hogFunction?.template?.id)&&void 0!==_ref3?_ref3:"")?(0,jsx_runtime.jsx)("span",{className:"mt-2",children:"The receiving destination imposes a rate limit of 10 events per second. Exceeding this limit may result in some events failing to be delivered."}):null,["site_destination"].includes(null!==(_ref4=null!==(_template$type=template?.type)&&void 0!==_template$type?_template$type:hogFunction?.template?.type)&&void 0!==_ref4?_ref4:"")?(0,jsx_runtime.jsx)("span",{className:"mt-2",children:"Make sure to enable the `opt_in_site_apps` flag in your `posthog.init` config."}):null]})}):null,(0,jsx_runtime.jsx)(lib.Form,{logic:hogFunctionConfigurationLogic.nM,props:logicProps,formKey:"configuration",className:"deprecated-space-y-3",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-4 items-start",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1 gap-4 min-w-100",children:[(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("p-3 rounded border deprecated-space-y-2 bg-surface-primary"),children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 items-start",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"icon_url",className:"h-10",children:_ref5=>{var _ref6;let{value,onChange}=_ref5;return(0,jsx_runtime.jsx)(HogFunctionIcon.g,{logicKey:null!==(_ref6=null!=id?id:templateId)&&void 0!==_ref6?_ref6:"new",src:value,onChange:val=>onChange(val)})}}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col flex-1 justify-center items-start min-h-10",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"name",children:(0,jsx_runtime.jsx)(InlineEditableField,{className:"font-semibold"})})}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 items-center h-10",children:[template&&(0,jsx_runtime.jsx)(HogFunctionStatusTag.B,{status:template.status}),hogFunction?(0,jsx_runtime.jsx)(HogFunctionStatusIndicator.F,{hogFunction:hogFunction}):(0,jsx_runtime.jsx)(src.oe,{type:configuration.enabled?"success":"default",children:configuration.enabled?"Start enabled":"Start paused"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"enabled",children:_ref7=>{let{value,onChange}=_ref7;return(0,jsx_runtime.jsx)(src.f4,{onChange:()=>onChange(!value),checked:value,disabled:loading,tooltip:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:value?"Enabled. Events will be processed.":"Disabled. Events will not be processed."})})}})]})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"description",children:(0,jsx_runtime.jsx)(InlineEditableField,{multiline:!0})}),hogFunction?.template?.code_language==="hog"&&hogFunction?.template&&!hogFunction.template.id.startsWith("template-blank-")?(0,jsx_runtime.jsx)(src.Qw,{showArrow:!0,overlay:(0,jsx_runtime.jsx)(HogFunctionTemplateOptions,{}),children:(0,jsx_runtime.jsx)(src.Jp,{type:"tertiary",size:"small",className:"mt-2 border border-dashed",fullWidth:!0,children:(0,jsx_runtime.jsxs)("span",{className:"flex flex-wrap flex-1 gap-1 items-center",children:["Built from template:",(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:hogFunction?.template.name}),(0,jsx_runtime.jsx)(HogFunctionStatusTag.B,{status:hogFunction.template.status}),(0,jsx_runtime.jsx)("div",{className:"flex-1"}),templateHasChanged?(0,jsx_runtime.jsx)(src.oe,{type:"success",children:"Modified"}):null]})})}):null]}),"source_webhook"===type&&(0,jsx_runtime.jsx)(HogFunctionSourceWebhookInfo,{}),showFilters&&(0,jsx_runtime.jsx)(HogFunctionFilters.B,{}),showExpectedVolume?(0,jsx_runtime.jsx)(HogFunctionEventEstimates,{}):null]}),(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4 flex-2 min-w-100",children:[mightDropEvents&&(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)(src.Vp,{type:"info",children:[(0,jsx_runtime.jsx)("b",{children:"Warning:"})," This transformation can filter out events, dropping them irreversibly. Make sure to double check your configuration, and use filters to limit the events that this transformation is applied to."]})}),(0,jsx_runtime.jsx)(HogFunctionInputs,{}),(0,jsx_runtime.jsx)(HogFunctionMappings,{}),canEditSource&&(0,jsx_runtime.jsx)(HogFunctionCode,{}),showTesting?(0,jsx_runtime.jsx)(HogFunctionTest,{}):null,"source_webhook"===type&&(0,jsx_runtime.jsx)(HogFunctionSourceWebhookTest,{}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-end",children:saveButtons})]})]})})]})})}},"../../frontend/src/scenes/hog-functions/configuration/hogFunctionTestLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{g:()=>hogFunctionTestLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),lib_api__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/utils.tsx"),lib_utils_getAppContext__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/utils/getAppContext.ts"),_models_groupsModel__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/models/groupsModel.ts"),_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx");let convertToTransformationEvent=result=>{var _result$properties;let properties=null!==(_result$properties=result.properties)&&void 0!==_result$properties?_result$properties:{};return delete properties.$transformations_failed,delete properties.$transformations_succeeded,delete properties.$transformations_skipped,{event:result.event,uuid:result.uuid,distinct_id:result.distinct_id,timestamp:result.timestamp,properties}},convertFromTransformationEvent=result=>(delete result.properties.$transformations_failed,delete result.properties.$transformations_succeeded,delete result.properties.$transformations_skipped,{event:result.event,uuid:result.uuid,distinct_id:result.distinct_id,timestamp:result.timestamp,properties:result.properties}),hogFunctionTestLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.key)(_ref=>{var _ref2;let{id,templateId}=_ref;return null!==(_ref2=null!=id?id:templateId)&&void 0!==_ref2?_ref2:"new"}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(id=>["scenes","pipeline","hogfunctions","hogFunctionTestLogic",id]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)(props=>({values:[(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.nM)(props),["configuration","templateId","configurationHasErrors","sampleGlobals","sampleGlobalsLoading","exampleInvocationGlobals","sampleGlobalsError","type","currentHogCode"],_models_groupsModel__WEBPACK_IMPORTED_MODULE_6__.$,["groupTypes"]],actions:[(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.nM)(props),["touchConfigurationField","loadSampleGlobalsSuccess","loadSampleGlobals","setSampleGlobals"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setTestResult:result=>({result}),toggleExpanded:expanded=>({expanded}),saveGlobals:(name,globals)=>({name,globals}),deleteSavedGlobals:index=>({index}),setTestResultMode:mode=>({mode}),receiveExampleGlobals:globals=>({globals}),setJsonError:error=>({error}),validateJson:(value,editor,decorations)=>({value,editor,decorations}),setDecorationIds:decorationIds=>({decorationIds}),cancelSampleGlobalsLoading:!0}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({expanded:[!1,{toggleExpanded:(state,_ref3)=>{let{expanded}=_ref3;return void 0===expanded?!state:expanded}}],testResult:[null,{setTestResult:(_,_ref4)=>{let{result}=_ref4;return result}}],testResultMode:["diff",{setTestResultMode:(_,_ref5)=>{let{mode}=_ref5;return mode}}],savedGlobals:[[],{persist:!0,prefix:`${(0,lib_utils_getAppContext__WEBPACK_IMPORTED_MODULE_5__.ev)()}__`},{saveGlobals:(state,_ref6)=>{let{name,globals}=_ref6;return[...state,{name,globals}]},deleteSavedGlobals:(state,_ref7)=>{let{index}=_ref7;return state.filter((_,i)=>i!==index)}}],jsonError:[null,{setJsonError:(_,_ref8)=>{let{error}=_ref8;return error}}],currentDecorationIds:[[],{setDecorationIds:(_,_ref9)=>{let{decorationIds}=_ref9;return decorationIds},setJsonError:()=>[]}],fetchCancelled:[!1,{loadSampleGlobals:()=>!1,cancelSampleGlobalsLoading:()=>!0,toggleExpanded:()=>!1}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref10=>{let{values,actions}=_ref10;return{loadSampleGlobalsSuccess:()=>{values.expanded&&!values.fetchCancelled&&values.sampleGlobals&&actions.receiveExampleGlobals(values.sampleGlobals)},setSampleGlobals:_ref11=>{let{sampleGlobals}=_ref11;actions.receiveExampleGlobals(sampleGlobals)},receiveExampleGlobals:_ref12=>{let{globals}=_ref12;if(globals){if("transformation"===values.type){let event=convertToTransformationEvent(globals.event);actions.setTestInvocationValue("globals",JSON.stringify(event,null,2))}else actions.setTestInvocationValue("globals",JSON.stringify(globals,null,2))}},validateJson:_ref13=>{let{value,editor,decorations}=_ref13;if(!editor?.getModel())return;let model=editor.getModel();try{JSON.parse(value),actions.setJsonError(null),editor.removeDecorations(decorations)}catch(err){actions.setJsonError(err.message);let match=err.message.match(/position (\d+)/);if(!match)return;let position=parseInt(match[1],10),pos=model.getPositionAt(position);editor.createDecorationsCollection([{range:{startLineNumber:pos.lineNumber,startColumn:pos.column,endLineNumber:pos.lineNumber,endColumn:pos.column+1},options:{isWholeLine:!0,className:"bg-danger-highlight",glyphMarginClassName:"text-danger flex items-center justify-center",glyphMarginHoverMessage:{value:err.message}}}]),editor.revealLineInCenter(pos.lineNumber)}},setTestResult:_ref14=>{let{result}=_ref14;result&&setTimeout(()=>{let testResults=document.querySelector('[data-attr="test-results"]');testResults&&testResults.scrollIntoView({behavior:"smooth",block:"start"});let editors=document.querySelectorAll('[data-attr="test-results"] .monaco-editor');if(editors.length>0&&values.sortedTestsResult?.hasDiff){let monacoEditor=editors[editors.length-1].querySelector(".monaco-scrollable-element");if(monacoEditor){let inputLines=values.sortedTestsResult.input.split("\n"),outputLines=values.sortedTestsResult.output.split("\n"),diffLineIndex=0;for(let i=0;i<Math.max(inputLines.length,outputLines.length);i++)if(inputLines[i]!==outputLines[i]){diffLineIndex=i;break}monacoEditor.scrollTop=Math.max(0,(diffLineIndex-2)*19)}}},100)},cancelSampleGlobalsLoading:()=>{}}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_1__.forms)(_ref15=>{let{props,actions,values}=_ref15;return{testInvocation:{defaults:{mock_async_functions:!1},alwaysShowErrors:!0,errors:_ref16=>{let{globals}=_ref16;return{globals:globals?(0,lib_utils__WEBPACK_IMPORTED_MODULE_4__.Cy)(globals)?void 0:"Invalid JSON":"Required"}},submit:async data=>{if(values.configurationHasErrors){let configLogic=(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.nM)(props),errorMessages=Object.entries(configLogic.values.inputFormErrors?.inputs||{}).map(_ref17=>{let[key,error]=_ref17;return`${key}: ${"string"==typeof error?error:"Invalid format"}`}),message=errorMessages.length>0?`Please fix the following errors:
${errorMessages.join("\n")}`:"Please fix the configuration errors before testing.";_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_2__.UJ.error(message,{toastId:"hogfunction-validation-error"}),configLogic.actions.touchConfigurationField&&configLogic.actions.touchConfigurationField("inputs");return}let parsedData=(0,lib_utils__WEBPACK_IMPORTED_MODULE_4__.Cy)(data.globals),configuration=(0,_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_7__.r9)(values.configuration);configuration.template_id=values.templateId,configuration.hog=values.currentHogCode;let globals="transformation"===values.type?{event:parsedData}:parsedData;try{var _props$id;let res=await lib_api__WEBPACK_IMPORTED_MODULE_3__.ZP.hogFunctions.createTestInvocation(null!==(_props$id=props.id)&&void 0!==_props$id?_props$id:"new",{globals,mock_async_functions:data.mock_async_functions,configuration});"transformation"===values.type&&res.result&&(res.result=convertFromTransformationEvent(res.result)),actions.setTestResult(res)}catch(e){_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_2__.UJ.error(`An unexpected server error occurred while testing the function. ${e}`)}}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)(()=>({sortedTestsResult:[s=>[s.configuration,s.testResult,s.testInvocation],(configuration,testResult,testInvocation)=>{if(!testResult||"transformation"!==configuration.type)return null;let input=JSON.stringify(convertFromTransformationEvent(convertToTransformationEvent(JSON.parse(testInvocation.globals))),null,2),output=JSON.stringify(testResult.result,null,2);return{input,output,hasDiff:input!==output}}],sampleGlobalsLoadingAndNotCancelled:[s=>[s.sampleGlobalsLoading,s.fetchCancelled],(sampleGlobalsLoading,fetchCancelled)=>sampleGlobalsLoading&&!fetchCancelled]})),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref18=>{let{actions,values}=_ref18;actions.receiveExampleGlobals(values.exampleInvocationGlobals)})])},"../../frontend/src/scenes/hog-functions/filters/HogFunctionFilters.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{B:()=>HogFunctionFilters});var chartjs_plugin_trendline=__webpack_require__("../../node_modules/.pnpm/chartjs-plugin-trendline@2.1.2/node_modules/chartjs-plugin-trendline/src/chartjs-plugin-trendline.js"),clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.27.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),PropertyFilters=__webpack_require__("../../frontend/src/lib/components/PropertyFilters/PropertyFilters.tsx"),TaxonomicFilter_types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),TestAccountFiltersSwitch=__webpack_require__("../../frontend/src/lib/components/TestAccountFiltersSwitch.tsx"),useFeatureFlag=__webpack_require__("../../frontend/src/lib/hooks/useFeatureFlag.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),ActionFilter=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),MaxTool=__webpack_require__("../../frontend/src/scenes/max/MaxTool.tsx"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts"),types=__webpack_require__("../../frontend/src/types.ts"),hogFunctionConfigurationLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let getFilterOptions=contextId=>{switch(contextId){case"error-tracking":return[{label:"Error tracking issue created",value:"$error_tracking_issue_created"},{label:"Error tracking issue reopened",value:"$error_tracking_issue_reopened"}];case"insight-alerts":return[{label:"Insight alert firing",value:"$insight_alert_firing"}];default:return[{label:"Team activity",value:"$activity_log_entry_created"},{label:"Early access feature updated",value:"$early_access_feature_updated"}]}},getSimpleFilterValue=value=>value?.events?.[0]?.id,setSimpleFilterValue=(options,value)=>({events:[{name:options.find(option=>option.value===value)?.label,id:value,type:"events"}]});function HogFunctionFiltersInternal(){let{contextId}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),options=(0,react.useMemo)(()=>getFilterOptions(contextId),[contextId]),taxonomicGroupTypes=(0,react.useMemo)(()=>"error-tracking"===contextId?[TaxonomicFilter_types.t.ErrorTrackingIssues,TaxonomicFilter_types.t.ErrorTrackingProperties,TaxonomicFilter_types.t.EventProperties]:"insight-alerts"===contextId?[TaxonomicFilter_types.t.Events]:[],[contextId]);return(0,jsx_runtime.jsx)("div",{className:"p-3 rounded border deprecated-space-y-2 bg-surface-primary",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:"Trigger",children:_ref=>{var _value$properties;let{value,onChange}=_ref;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary",children:"Choose what event should trigger this destination"}),(0,jsx_runtime.jsx)(src.Yv,{options:options,value:getSimpleFilterValue(value),onChange:value=>onChange(setSimpleFilterValue(options,value)),placeholder:"Select a filter"}),taxonomicGroupTypes.length>0?(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:null!==(_value$properties=value?.properties)&&void 0!==_value$properties?_value$properties:[],taxonomicGroupTypes:taxonomicGroupTypes,onChange:properties=>{onChange({...value,properties})},pageKey:`hog-function-internal-property-filters-${contextId}`,buttonSize:"small",disablePopover:!0},contextId):null]})}})})}function sanitizeActionFilters(filters){if(!filters)return{};let sanitized={};return filters.events&&(sanitized.events=filters.events.map(f=>({id:f.id,type:"events",name:f.name,order:f.order,properties:f.properties}))),filters.actions&&(sanitized.actions=filters.actions.map(f=>({id:f.id,type:"actions",name:f.name,order:f.order,properties:f.properties}))),sanitized}function HogFunctionFilters(_ref){var _configuration$filter,_configuration$filter2;let{embedded=!1,showTriggerOptions=!0}=_ref,{groupsTaxonomicTypes}=(0,index_esm.useValues)(groupsModel.$),{configuration,type,useMapping,filtersContainPersonProperties,oldFilters,newFilters}=(0,index_esm.useValues)(hogFunctionConfigurationLogic.nM),{setOldFilters,setNewFilters,clearFiltersDiff,reportAIFiltersPrompted,reportAIFiltersAccepted,reportAIFiltersRejected,reportAIFiltersPromptOpen}=(0,index_esm.useActions)(hogFunctionConfigurationLogic.nM),isLegacyPlugin=configuration?.template?.id?.startsWith("plugin-"),isTransformation="transformation"===type,cdpPersonUpdatesEnabled=(0,useFeatureFlag.y)("CDP_PERSON_UPDATES"),excludedProperties={[TaxonomicFilter_types.t.EventProperties]:["$exception_types","$exception_functions","$exception_values","$exception_sources","$exception_list","$exception_type","$exception_level","$exception_message"]};"transformation"===type&&(excludedProperties[TaxonomicFilter_types.t.Events]=["$exception"]);let taxonomicGroupTypes=(0,react.useMemo)(()=>{let types=[TaxonomicFilter_types.t.EventProperties,TaxonomicFilter_types.t.EventMetadata,TaxonomicFilter_types.t.HogQLExpression];return isTransformation||types.push(TaxonomicFilter_types.t.PersonProperties,TaxonomicFilter_types.t.EventFeatureFlags,TaxonomicFilter_types.t.Elements,...groupsTaxonomicTypes),types},[isTransformation,groupsTaxonomicTypes]),showMasking="destination"===type&&!isLegacyPlugin&&showTriggerOptions;if("internal_destination"===type)return(0,jsx_runtime.jsx)(HogFunctionFiltersInternal,{});let showSourcePicker=cdpPersonUpdatesEnabled&&"destination"===type&&!useMapping,showEventMatchers=!useMapping&&(null!==(_configuration$filter=configuration?.filters?.source)&&void 0!==_configuration$filter?_configuration$filter:"events")==="events",mainContent=(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("deprecated-space-y-2 rounded bg-surface-primary",!embedded&&"border p-3",embedded&&"p-2"),children:[showSourcePicker&&(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:"Source",info:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Select the source of events for the destination.",(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("b",{children:"Events"})," will trigger from the real-time stream of ingested events.",(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("b",{children:"Person updates"})," will trigger whenever a Person is created, updated or deleted."]}),children:_ref2=>{var _value$source;let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"events",label:"Events"},{value:"person-updates",label:"Person updates"}],value:null!==(_value$source=value?.source)&&void 0!==_value$source?_value$source:"events",onChange:val=>{onChange({...value,source:val})}})}}),(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:useMapping?"Global filters":"Filters",info:useMapping?"Filters applied to all events before they reach a mapping":"Filters applied to all events",children:_ref3=>{var _currentFilters$filte,_currentFilters$prope;let{value,onChange:_onChange}=_ref3,currentFilters=null!=newFilters?newFilters:null!=value?value:{},onChange=newValue=>{oldFilters&&newFilters&&clearFiltersDiff(),_onChange(newValue)};return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[useMapping&&(0,jsx_runtime.jsx)("p",{className:"mb-0 text-sm text-secondary",children:"Filters here apply for all events that could trigger this function, regardless of mappings."}),!isTransformation&&(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:null!==(_currentFilters$filte=currentFilters?.filter_test_accounts)&&void 0!==_currentFilters$filte&&_currentFilters$filte,onChange:filter_test_accounts=>{onChange({...currentFilters,filter_test_accounts})},fullWidth:!0}),(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:null!==(_currentFilters$prope=currentFilters?.properties)&&void 0!==_currentFilters$prope?_currentFilters$prope:[],taxonomicGroupTypes:taxonomicGroupTypes,onChange:properties=>{onChange({...currentFilters,properties})},pageKey:`HogFunctionPropertyFilters.${chartjs_plugin_trendline.id}`,excludedProperties:excludedProperties}),showEventMatchers?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-between w-full",children:(0,jsx_runtime.jsx)(src.HQ,{children:isTransformation?"Match events":"Match events and actions"})}),(0,jsx_runtime.jsxs)("p",{className:"mb-0 text-xs text-secondary",children:["If set, the ",type," will only run if the ",(0,jsx_runtime.jsx)("b",{children:"event matches any"})," of the below."]}),(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:null!=currentFilters?currentFilters:{},setFilters:payload=>{onChange({...currentFilters,...sanitizeActionFilters(payload)})},typeKey:"plugin-filters",mathAvailability:ActionFilterRow.Qq.None,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:isTransformation?[TaxonomicFilter_types.t.Events]:[TaxonomicFilter_types.t.Events,TaxonomicFilter_types.t.Actions],propertiesTaxonomicGroupTypes:taxonomicGroupTypes,propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:types.DC.EVENTS},buttonCopy:"Add event matcher",excludedProperties:excludedProperties})]}):null,oldFilters&&newFilters&&(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center p-2 mt-4 rounded border border-dashed bg-surface-secondary",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1 text-center",children:(0,jsx_runtime.jsx)("span",{className:"text-sm font-medium",children:"Suggested by Max"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{status:"danger",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:()=>{onChange(oldFilters),reportAIFiltersRejected(),clearFiltersDiff()},tooltipPlacement:"top",size:"small",children:"Reject"}),(0,jsx_runtime.jsx)(src.Jp,{type:"tertiary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconCheck,{color:"var(--success)"}),onClick:()=>{onChange(newFilters),reportAIFiltersAccepted(),clearFiltersDiff()},tooltipPlacement:"top",size:"small",children:"Accept"})]})]})]})}}),filtersContainPersonProperties&&showEventMatchers?(0,jsx_runtime.jsx)(src.Vp,{type:"warning",children:"You are filtering on Person properties. Be aware that this filtering applies at the time the event is processed so if Person Profiles are not enabled or the person property has not been set by then then the filters may not work as expected."}):null,showMasking?(0,jsx_runtime.jsx)(LemonField.D,{name:"masking",label:"Trigger options",info:`
                        You can configure the destination to only run once within a given time interval or until a certain number of events have been processed.
                        This is useful for rate limiting the destination for example if you only want to receive one message per day.
                    `,children:_ref4=>{var _value$hash;let{value,onChange}=_ref4;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-1 items-center",children:[(0,jsx_runtime.jsx)(src.Yv,{options:[{value:null,label:"Run every time"},{value:"all",label:"Run once per interval"},{value:"{person.id}",label:"Run once per person per interval"},{value:"{concat(person.id, event.event)}",label:"Run once per person per event name per interval"}],value:null!==(_value$hash=value?.hash)&&void 0!==_value$hash?_value$hash:null,onChange:val=>{var _value$ttl;return onChange({hash:val,ttl:null!==(_value$ttl=value?.ttl)&&void 0!==_value$ttl?_value$ttl:1800})}}),configuration.masking?.hash?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-1 items-center",children:[(0,jsx_runtime.jsx)("span",{children:"of"}),(0,jsx_runtime.jsx)(src.Yv,{value:value?.ttl,onChange:val=>onChange({...value,ttl:val}),options:[{value:300,label:"5 minutes"},{value:900,label:"15 minutes"},{value:1800,label:"30 minutes"},{value:3600,label:"1 hour"},{value:7200,label:"2 hours"},{value:14400,label:"4 hours"},{value:28800,label:"8 hours"},{value:43200,label:"12 hours"},{value:86400,label:"24 hours"}]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-1 items-center",children:[(0,jsx_runtime.jsx)("span",{children:"or until"}),(0,jsx_runtime.jsx)(src.Yv,{value:value?.threshold,onChange:val=>onChange({...value,threshold:val}),options:[{value:null,label:"Not set"},{value:1e3,label:"1000 events"},{value:1e4,label:"10,000 events"},{value:1e5,label:"100,000 events"},{value:1e6,label:"1,000,000 events"}]})]})]}):null]})}}):null]});return(0,jsx_runtime.jsx)(MaxTool.Z,{identifier:"create_hog_function_filters",context:{current_filters:JSON.stringify(null!==(_configuration$filter2=configuration?.filters)&&void 0!==_configuration$filter2?_configuration$filter2:{}),function_type:type},callback:toolOutput=>{var _configuration$filter3;let parsedFilters=JSON.parse(toolOutput);setOldFilters(null!==(_configuration$filter3=configuration?.filters)&&void 0!==_configuration$filter3?_configuration$filter3:{}),setNewFilters(parsedFilters),reportAIFiltersPrompted()},onMaxOpen:()=>{reportAIFiltersPromptOpen()},introOverride:{headline:"What events and properties should trigger this function?",description:"Let me help you set up the right filters for your function."},children:mainContent})}},"../../frontend/src/scenes/hog-functions/logs/HogFunctionLogs.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{x:()=>HogFunctionLogs});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.27.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),hogFunctionConfigurationLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx"),hogFunctionTestLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionTestLogic.tsx"),LogsViewer=__webpack_require__("../../frontend/src/scenes/hog-functions/logs/LogsViewer.tsx"),api=__webpack_require__("../../frontend/src/lib/api.ts"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),queries_utils=__webpack_require__("../../frontend/src/queries/utils.ts"),logsViewerLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/logs/logsViewerLogic.tsx");let eventIdMatchers=[/Event: ([A-Za-z0-9-]+)/,/\/events\/([A-Za-z0-9-]+)\//,/event ([A-Za-z0-9-]+)/];async function runWithParallelism(items,maxParallel,asyncFn){let results=[],executing=new Set;for(let item of items){let promise=(async()=>{let result=await asyncFn(item);results.push(result)})();executing.add(promise),promise.finally(()=>executing.delete(promise)),executing.size>=maxParallel&&await Promise.race(executing)}return await Promise.all(executing),results}let loadClickhouseEvents=async(eventIds,_ref)=>{let{date_from,date_to}=_ref,query=(0,queries_utils.zP)`
        SELECT uuid, distinct_id, event, timestamp, properties, elements_chain, person.id, person.properties, person.created_at 
        FROM events
        WHERE uuid in (${queries_utils.zP.raw(eventIds.map(x=>`'${x}'`).join(","))})
        AND timestamp > {filters.dateRange.from}
        AND timestamp < {filters.dateRange.to}`;return(await api.ZP.queryHogQL(query,{refresh:"force_blocking",filtersOverride:{date_from:date_from,date_to:date_to}})).results.map(x=>{let[uuid,distinct_id,event,timestamp,properties,elements_chain,person_id,person_properties,person_created_at]=x;return{uuid,event,distinct_id,person_id,timestamp,properties,elements_chain,person_created_at,person_properties}})},hogFunctionLogsLogic=(0,index_esm.kea)([(0,index_esm.path)(key=>["scenes","pipeline","hogfunctions","logs","hogFunctionLogsLogic",key]),(0,index_esm.props)({}),(0,index_esm.key)(_ref2=>{let{sourceType,sourceId}=_ref2;return`${sourceType}:${sourceId}`}),(0,index_esm.connect)(props=>({values:[(0,logsViewerLogic.WC)(props),["logs"]],actions:[(0,logsViewerLogic.WC)(props),["addLogGroups","setRowExpanded"]]})),(0,index_esm.actions)({setSelectingMany:selectingMany=>({selectingMany}),setSelectedForRetry:selectedForRetry=>({selectedForRetry}),selectAllForRetry:!0,retryInvocation:(groupedLogEntry,eventId)=>({groupedLogEntry,eventId}),retryInvocations:groupedLogEntries=>({groupedLogEntries}),retryInvocationStarted:groupedLogEntry=>({groupedLogEntry}),retryInvocationSuccess:groupedLogEntry=>({groupedLogEntry}),retryInvocationFailure:groupedLogEntry=>({groupedLogEntry}),retrySelectedInvocations:!0}),(0,index_esm.reducers)({selectingMany:[!1,{setSelectingMany:(_,_ref3)=>{let{selectingMany}=_ref3;return selectingMany}}],selectedForRetry:[{},{setSelectedForRetry:(state,_ref4)=>{let{selectedForRetry}=_ref4,newState={...state};return Object.keys(selectedForRetry).forEach(key=>{newState[key]=selectedForRetry[key],selectedForRetry[key]||delete newState[key]}),newState},setSelectingMany:(state,_ref5)=>{let{selectingMany}=_ref5;return selectingMany?state:{}}}],retries:[{},{retryInvocationStarted:(state,_ref6)=>{let{groupedLogEntry}=_ref6;return{...state,[groupedLogEntry.instanceId]:"pending"}},retryInvocationSuccess:(state,_ref7)=>{let{groupedLogEntry}=_ref7;return{...state,[groupedLogEntry.instanceId]:"success"}},retryInvocationFailure:(state,_ref8)=>{let{groupedLogEntry}=_ref8;return{...state,[groupedLogEntry.instanceId]:"failure"}}}]}),(0,index_esm.selectors)({retryRunning:[s=>[s.retries],retries=>Object.values(retries).some(x=>"pending"===x)],eventIdByInvocationId:[s=>[s.logs],logs=>{let eventIdByInvocationId={};for(let record of logs){let entryContainingEventId=record.entries.find(entry=>entry.message.includes("Function completed")||entry.message.includes("Suspending function")||entry.message.includes("Error executing function on event"));if(!entryContainingEventId)return;for(let matcher of eventIdMatchers){let match=entryContainingEventId.message.match(matcher);if(match){eventIdByInvocationId[record.instanceId]=match[1];break}}}return eventIdByInvocationId}]}),(0,index_esm.listeners)(_ref9=>{let{actions,props,values}=_ref9;return{retryInvocations:async _ref10=>{let{groupedLogEntries}=_ref10;await src.UJ.promise((async _values$eventIdByInvo=>{for(let groupedLogEntry of groupedLogEntries)actions.retryInvocationStarted(groupedLogEntry);1===groupedLogEntries.length&&actions.setRowExpanded(groupedLogEntries[0].instanceId,!0);let[timestampRangeStart,timestampRangeEnd]=groupedLogEntries.reduce((_ref11,x)=>{let[accStart,accEnd]=_ref11;return accStart?[x.minTimestamp.isBefore(accStart)?x.minTimestamp:accStart,x.maxTimestamp.isAfter(accEnd)?x.maxTimestamp:accEnd]:[x.minTimestamp,x.minTimestamp]},[null,null]),events=await loadClickhouseEvents(Object.values(null!==(_values$eventIdByInvo=values.eventIdByInvocationId)&&void 0!==_values$eventIdByInvo?_values$eventIdByInvo:{}),{date_from:timestampRangeStart?.subtract(1,"day").toISOString(),date_to:timestampRangeEnd?.add(1,"day").toISOString()}),eventsById={};for(let event of events)eventsById[event.uuid]=event;await runWithParallelism(groupedLogEntries,10,async groupedLogEntry=>{try{let event=eventsById[values.eventIdByInvocationId[groupedLogEntry.instanceId]];if(!event){actions.retryInvocationFailure(groupedLogEntry);return}let res=await api.ZP.hogFunctions.createTestInvocation(props.sourceId,{clickhouse_event:event,mock_async_functions:!1,configuration:{filters:{}},invocation_id:groupedLogEntry.instanceId}),newLogGroup={...groupedLogEntry,entries:[...groupedLogEntry.entries,...res.logs.map(x=>({timestamp:(0,dayjs.Bv)(x.timestamp),level:x.level.toUpperCase(),message:x.message}))]};actions.addLogGroups([newLogGroup]),actions.retryInvocationSuccess(groupedLogEntry)}catch{actions.retryInvocationFailure(groupedLogEntry)}}),actions.setSelectingMany(!1)})(),{success:"Retries complete!",error:"Retry failed!",pending:"Retrying..."})},retrySelectedInvocations:async()=>{let groupsToRetry=values.logs.filter(x=>values.selectedForRetry[x.instanceId]);actions.retryInvocations(groupsToRetry)},selectAllForRetry:async()=>{for(let groupedLogEntry of(actions.setSelectingMany(!0),values.logs))actions.setSelectedForRetry({[groupedLogEntry.instanceId]:!0})}}}),(0,lib.beforeUnload)(_ref12=>{let{values,cache}=_ref12;return{enabled:()=>!cache.disabledBeforeUnload&&values.retryRunning,message:"You have running retries that will be discarded if you leave. Are you sure?",onConfirm:()=>{cache.disabledBeforeUnload=!0}}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function HogFunctionLogs(props){let logicProps={sourceType:"hog_function",sourceId:props.hogFunctionId},{selectingMany,selectedForRetry,retryRunning}=(0,index_esm.useValues)(hogFunctionLogsLogic(logicProps)),{setSelectingMany,retrySelectedInvocations,selectAllForRetry}=(0,index_esm.useActions)(hogFunctionLogsLogic(logicProps));return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:selectingMany?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!1),children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>selectAllForRetry(),children:"Select all"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"primary",onClick:()=>{src.dn.open({title:"Retry invocations",content:"Are you sure you want to retry the selected events? Please don't close the window until the invocations have completed.",secondaryButton:{children:"Cancel"},primaryButton:{children:"Retry selected events",onClick:()=>retrySelectedInvocations()}})},loading:retryRunning,disabledReason:retryRunning?"Please wait for the current retries to complete.":0===Object.values(selectedForRetry).length?"No invocations selected":void 0,children:"Retry selected"})]}):(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!0),children:"Select invocations"})})}),(0,jsx_runtime.jsx)(LogsViewer.F,{...logicProps,sourceId:props.hogFunctionId,renderColumns:columns=>[{title:"Status",key:"status",width:0,render:(_,record)=>(0,jsx_runtime.jsx)(HogFunctionLogsStatus,{record:record,hogFunctionId:props.hogFunctionId})},...columns.filter(column=>"logLevel"!==column.key)]})]})}function HogFunctionLogsStatus(_ref){var _selectedForRetry$rec;let{record,hogFunctionId}=_ref,logicProps={sourceType:"hog_function",sourceId:hogFunctionId},{loadSampleGlobals,toggleExpanded}=(0,index_esm.useActions)((0,hogFunctionTestLogic.g)({id:hogFunctionId})),{contextId}=(0,index_esm.useValues)((0,hogFunctionConfigurationLogic.nM)({id:hogFunctionId})),{retries,selectingMany,selectedForRetry,eventIdByInvocationId}=(0,index_esm.useValues)(hogFunctionLogsLogic(logicProps)),{retryInvocations,setSelectingMany,setSelectedForRetry}=(0,index_esm.useActions)(hogFunctionLogsLogic(logicProps)),thisRetry=retries[record.instanceId],status=(0,react.useMemo)(()=>{if("pending"===thisRetry)return"running";let lastEntry=record.entries[record.entries.length-1];return lastEntry.message.includes("Function completed")||lastEntry.message.includes("Execution successful")?"success":"ERROR"===lastEntry.level?"failure":"running"},[record,thisRetry]),eventId=eventIdByInvocationId?.[record.instanceId],internalEvent=["error-tracking","insight-alerts","activity-log"].includes(contextId);return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[selectingMany?(0,jsx_runtime.jsx)(src.Hw,{checked:null!==(_selectedForRetry$rec=selectedForRetry[record.instanceId])&&void 0!==_selectedForRetry$rec&&_selectedForRetry$rec,onChange:checked=>setSelectedForRetry({[record.instanceId]:checked})}):null,(0,jsx_runtime.jsx)(src.oe,{type:"success"===status?"success":"failure"===status?"danger":"warning",children:(0,utils.fm)(status)}),!internalEvent&&(0,jsx_runtime.jsx)(src.d6,{items:[eventId?{label:"View event",to:urls.j.event(eventId,"")}:null,{label:"Retry event",disabledReason:eventId?void 0:"Could not find the source event",onClick:()=>retryInvocations([record])},{label:"Select for retry",onClick:()=>{setSelectingMany(!0),setSelectedForRetry({[record.instanceId]:!0})}},{label:"Test with this event in configuration",onClick:()=>{loadSampleGlobals({eventId}),toggleExpanded(!0),lib.router.actions.push(urls.j.hogFunction(hogFunctionId)+"?tab=configuration")}}],children:(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{className:"rotate-90"}),loading:"pending"===thisRetry})})]})}},"../../frontend/src/scenes/hog-functions/metrics/HogFunctionMetrics.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{k:()=>HogFunctionMetrics});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),_posthog_icons__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.27.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),lib_Chart__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/lib/Chart.ts"),lib_colors__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/colors.ts"),lib_components_DateFilter_DateFilter__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),lib_hooks_useOnMountEffect__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/lib/hooks/useOnMountEffect.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../frontend/src/lib/utils.tsx"),scenes_hog_functions_configuration_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx"),scenes_insights_InsightTooltip_InsightTooltip__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("../../frontend/src/scenes/insights/InsightTooltip/InsightTooltip.tsx"),_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("../../frontend/src/scenes/hog-functions/metrics/hogFunctionMetricsLogic.tsx"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let METRICS_INFO={succeeded:"Total number of events processed successfully",failed:"Total number of events that had errors during processing",filtered:"Total number of events that were filtered out",dropped:"Total number of events that were dropped during processing",disabled_temporarily:"Total number of events that were skipped due to the destination being temporarily disabled (due to issues such as the destination being down or rate-limited)",disabled_permanently:"Total number of events that were skipped due to the destination being permanently disabled (due to prolonged issues with the destination)"};function HogFunctionMetrics(_ref){let{id}=_ref,logic=(0,_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_11__.O)({id}),{filters}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)(logic),{type}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)((0,scenes_hog_functions_configuration_hogFunctionConfigurationLogic__WEBPACK_IMPORTED_MODULE_9__.nM)({id})),{setFilters,loadMetrics,loadMetricsTotals}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useActions)(logic);return(0,lib_hooks_useOnMountEffect__WEBPACK_IMPORTED_MODULE_7__.x)(()=>{loadMetrics(),loadMetricsTotals()}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(kea__WEBPACK_IMPORTED_MODULE_0__.BindLogic,{logic:_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_11__.O,props:{id},children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(AppMetricsTotals,{}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("h2",{className:"mb-0",children:"Delivery trends"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"flex-1"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.Qw,{closeOnClickInside:!1,matchWidth:!1,placement:"right-end",overlay:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"overflow-hidden deprecated-space-y-2 max-w-100",children:_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_11__._.filter(_ref2=>{let{value}=_ref2;return("fetch"!==value||"transformation"!==type)&&("dropped"!==value||"transformation"===type)}).map(_ref3=>{let{label,value}=_ref3;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.Jp,{fullWidth:!0,icon:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.Hw,{checked:filters?.name?.split(",").includes(value),className:"pointer-events-none"}),onClick:()=>{setFilters({name:filters?.name?.split(",").includes(value)?filters.name.split(",").filter(t=>t!=value).join(","):filters.name+","+value})},children:label},value)})}),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.Jp,{size:"small",type:"secondary",children:"Filters"})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.Yv,{options:[{label:"Hourly",value:"hour"},{label:"Daily",value:"day"},{label:"Weekly",value:"week"}],size:"small",value:filters.interval,onChange:value=>setFilters({interval:value})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(lib_components_DateFilter_DateFilter__WEBPACK_IMPORTED_MODULE_6__.f,{dateTo:filters.before,dateFrom:filters.after,onChange:(from,to)=>setFilters({after:from||void 0,before:to||void 0}),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_icons__WEBPACK_IMPORTED_MODULE_2__.IconCalendar,{})," ",key]})})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(AppMetricsGraph,{})]})})}function AppMetricBigNumber(_ref4){let{label,value,tooltip}=_ref4;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.u,{title:tooltip,children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"flex flex-col flex-1 gap-2 items-center p-2 rounded border bg-surface-primary",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"text-xs font-bold uppercase",children:label.replace(/_/g," ")}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"flex flex-1 items-center mb-2 text-2xl",children:(0,lib_utils__WEBPACK_IMPORTED_MODULE_8__.Lc)(null!=value?value:0)})]})})}function AppMetricsTotals(){let{appMetricsTotals,appMetricsTotalsLoading}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)(_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_11__.O);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"deprecated-space-y-4",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"flex flex-wrap gap-2 items-center",children:Object.entries(METRICS_INFO).map(_ref5=>{let[key,value]=_ref5;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"flex flex-col flex-1 h-30 min-w-30 max-w-100",children:appMetricsTotalsLoading?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.yW,{className:"w-full h-full"}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(AppMetricBigNumber,{label:key,value:appMetricsTotals?.totals?.[key],tooltip:value})},key)})})})}function AppMetricsGraph(){let{appMetrics,appMetricsLoading}=(0,kea__WEBPACK_IMPORTED_MODULE_0__.useValues)(_hogFunctionMetricsLogic__WEBPACK_IMPORTED_MODULE_11__.O),canvasRef=(0,react__WEBPACK_IMPORTED_MODULE_1__.useRef)(null),[popoverContent,setPopoverContent]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)(null),[tooltipState,setTooltipState]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)({x:0,y:0,visible:!1});return(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{let chart;if(canvasRef.current&&appMetrics&&!(0,lib_utils__WEBPACK_IMPORTED_MODULE_8__.es)())return chart=new lib_Chart__WEBPACK_IMPORTED_MODULE_4__.kL(canvasRef.current?.getContext("2d"),{type:"line",data:{labels:appMetrics.labels,datasets:appMetrics.series.map(series=>({label:series.name,data:series.values,borderColor:"",...colorConfig(series.name)}))},options:{scales:{x:{ticks:{maxRotation:0},grid:{display:!1}},y:{beginAtZero:!0}},plugins:{crosshair:!1,legend:{display:!1},tooltip:{enabled:!1,external(_ref6){let{tooltip,chart}=_ref6;setPopoverContent((0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(scenes_insights_InsightTooltip_InsightTooltip__WEBPACK_IMPORTED_MODULE_10__.Q,{embedded:!0,hideInspectActorsSection:!0,altTitle:tooltip.dataPoints[0].label,seriesData:tooltip.dataPoints.map((dp,i)=>({id:i,dataIndex:0,datasetIndex:0,order:i,label:dp.dataset.label,color:dp.dataset.borderColor,count:dp.dataset.data?.[dp.dataIndex]||0})),renderSeries:value=>value,renderCount:count=>(0,lib_utils__WEBPACK_IMPORTED_MODULE_8__.Lc)(count)}));let position=chart.canvas.getBoundingClientRect();setTooltipState({x:position.left+tooltip.caretX,y:position.top+tooltip.caretY,visible:tooltip.opacity>0})}}},maintainAspectRatio:!1,interaction:{mode:"index",axis:"x",intersect:!1}}}),()=>{chart?.destroy()}},[appMetrics]),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"relative border rounded p-6 bg-surface-primary h-[50vh]",children:[appMetricsLoading&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.t2,{}),!!appMetrics&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("canvas",{ref:canvasRef}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_3__.J2,{visible:tooltipState.visible,overlay:popoverContent,placement:"top",padded:!1,className:"pointer-events-none",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"fixed",style:{left:tooltipState.x,top:tooltipState.y}})})]})}function colorConfig(name){let color="";switch(name){case"succeeded":color=(0,lib_colors__WEBPACK_IMPORTED_MODULE_5__.cM)("success");break;case"failed":color=(0,lib_colors__WEBPACK_IMPORTED_MODULE_5__.cM)("danger");break;case"dropped":color=(0,lib_colors__WEBPACK_IMPORTED_MODULE_5__.cM)("warning");break;default:color=(0,lib_colors__WEBPACK_IMPORTED_MODULE_5__.cM)("data-color-1")}return{borderColor:color,hoverBorderColor:color,hoverBackgroundColor:color,backgroundColor:color,fill:!1,borderWidth:2,pointRadius:0}}},"../../frontend/src/scenes/hog-functions/testing/HogFunctionTesting.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{D:()=>HogFunctionTesting});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.27.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),DateFilter=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),PayGateMini=__webpack_require__("../../frontend/src/lib/components/PayGateMini/PayGateMini.tsx"),PropertyKeyInfo=__webpack_require__("../../frontend/src/lib/components/PropertyKeyInfo.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),EmptyStates=__webpack_require__("../../frontend/src/scenes/insights/EmptyStates/index.ts"),PersonDisplay=__webpack_require__("../../frontend/src/scenes/persons/PersonDisplay.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),src_types=__webpack_require__("../../frontend/src/types.ts"),hogFunctionConfigurationLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionConfigurationLogic.tsx"),hogFunctionTestLogic=__webpack_require__("../../frontend/src/scenes/hog-functions/configuration/hogFunctionTestLogic.tsx"),HogFunctionFilters=__webpack_require__("../../frontend/src/scenes/hog-functions/filters/HogFunctionFilters.tsx"),LogsViewer=__webpack_require__("../../frontend/src/scenes/hog-functions/logs/LogsViewer.tsx"),fast_deep_equal=__webpack_require__("../../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"),fast_deep_equal_default=__webpack_require__.n(fast_deep_equal),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_subscriptions_lib=__webpack_require__("../../node_modules/.pnpm/kea-subscriptions@3.0.1_kea@3.1.7_react@18.2.0_/node_modules/kea-subscriptions/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts"),DataTable_utils=__webpack_require__("../../frontend/src/queries/nodes/DataTable/utils.ts"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),queries_utils=__webpack_require__("../../frontend/src/queries/utils.ts");let hogFunctionTestingLogic=(0,index_esm.kea)([(0,index_esm.path)(key=>["scenes","pipeline","hogFunctionTestingLogic",key]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.connect)(()=>({values:[hogFunctionConfigurationLogic.nM,["configuration","matchingFilters","templateId"],groupsModel.$,["groupTypes"]]})),(0,index_esm.actions)({changeDateRange:(after,before)=>({after,before}),addLoadingRetry:eventId=>({eventId}),removeLoadingRetry:eventId=>({eventId}),increaseCurrentPage:timestamp=>({timestamp}),decreaseCurrentPage:!0,resetCurrentPage:!0,expandRow:eventId=>({eventId}),collapseRow:eventId=>({eventId}),resetCollapsedRows:!0,selectForRetry:eventIds=>({eventIds}),deselectForRetry:eventIds=>({eventIds}),resetSelectedForRetry:!0,setSelectingMany:selectingMany=>({selectingMany})}),(0,index_esm.reducers)({dateRange:[{after:"-7d",before:null},{changeDateRange:(_,_ref2)=>{let{after,before}=_ref2;return{after,before}}}],loadingRetries:[[],{addLoadingRetry:(state,_ref3)=>{let{eventId}=_ref3;return[...state,eventId]},removeLoadingRetry:(state,_ref4)=>{let{eventId}=_ref4;return state.filter(id=>id!==eventId)}}],pageTimestamps:[[],{increaseCurrentPage:(state,_ref5)=>{let{timestamp}=_ref5;return[...state,timestamp]},decreaseCurrentPage:state=>state.filter((_,i)=>i!==state.length-1),resetCurrentPage:()=>[]}],expandedRows:[[],{expandRow:(state,_ref6)=>{let{eventId}=_ref6;return[...state,eventId]},collapseRow:(state,_ref7)=>{let{eventId}=_ref7;return state.filter(id=>id!==eventId)},resetCollapsedRows:()=>[]}],selectingMany:[!1,{setSelectingMany:(_,_ref8)=>{let{selectingMany}=_ref8;return selectingMany}}],selectedForRetry:[[],{selectForRetry:(state,_ref9)=>{let{eventIds}=_ref9;return[...new Set([...state,...eventIds])]},deselectForRetry:(state,_ref10)=>{let{eventIds}=_ref10;return state.filter(id=>!eventIds.includes(id))},resetSelectedForRetry:()=>[]}]}),(0,kea_loaders_lib.loaders)(_ref11=>{let{values,props,actions}=_ref11;return{events:[{results:[],before:void 0},{loadEvents:async()=>{var _values$dateRange$bef;return values.baseEventsQuery?{...await api.ZP.query(values.baseEventsQuery),before:null!==(_values$dateRange$bef=values.dateRange.before)&&void 0!==_values$dateRange$bef?_values$dateRange$bef:void 0}:{results:[],before:void 0}},loadNextEventsPage:async()=>values.nextQuery?(actions.increaseCurrentPage(values.events.before),{...await api.ZP.query(values.nextQuery),before:values.nextQuery.before}):{...values.events,before:void 0},loadPreviousEventsPage:async()=>{if(!values.previousQuery)return{...values.events,before:void 0};let response=await api.ZP.query(values.previousQuery);return actions.decreaseCurrentPage(),{...response,before:values.previousQuery.before}}}],totalEvents:[0,{loadTotalEvents:async()=>{var _response$results$0$a;if(!values.totalEventsQuery)return 0;let response=await api.ZP.query(values.totalEventsQuery);return null!==(_response$results$0$a=response.results[0]?.aggregated_value)&&void 0!==_response$results$0$a?_response$results$0$a:0}}],retries:[[],{retryInvocation:async _ref12=>{let res,{eventId,globals}=_ref12;actions.addLoadingRetry(eventId);let configuration=(0,hogFunctionConfigurationLogic.r9)(values.configuration);configuration.template_id=values.templateId;try{var _props$id;res=await api.ZP.hogFunctions.createTestInvocation(null!==(_props$id=props.id)&&void 0!==_props$id?_props$id:"new",{globals,mock_async_functions:!1,configuration}),actions.removeLoadingRetry(eventId);let retry={eventId:eventId,...res};return[...values.retries,retry]}catch(e){src.UJ.error(`An unexpected server error occurred while testing the function. ${e}`)}return actions.removeLoadingRetry(eventId),[...values.retries]}}]}}),(0,index_esm.selectors)(_ref13=>{let{values}=_ref13;return{baseEventsQuery:[s=>[s.configuration,s.matchingFilters,s.groupTypes,s.dateRange],(configuration,matchingFilters,groupTypes,dateRange)=>{var _dateRange$after,_dateRange$before;let query={kind:schema_general.OH.EventsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,fixedProperties:[matchingFilters],limit:20,select:["*","person","timestamp"],after:null!==(_dateRange$after=dateRange?.after)&&void 0!==_dateRange$after?_dateRange$after:void 0,before:null!==(_dateRange$before=dateRange?.before)&&void 0!==_dateRange$before?_dateRange$before:void 0,orderBy:["timestamp DESC"],modifiers:{personsOnEventsMode:"person_id_no_override_properties_on_events"}};return groupTypes.forEach(groupType=>{let name=(0,queries_utils.cM)(groupType.group_type);query.select.push(`tuple(${name}.created_at, ${name}.index, ${name}.key, ${name}.properties, ${name}.updated_at)`)}),(0,queries_utils.xg)(query)},{resultEqualityCheck:fast_deep_equal_default()}],totalEventsQuery:[s=>[s.configuration,s.matchingFilters,s.dateRange],(configuration,matchingFilters,dateRange)=>(0,queries_utils.xg)({kind:schema_general.OH.TrendsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,series:[{kind:schema_general.OH.EventsNode,event:null,name:"All Events",math:src_types.vN.TotalCount}],properties:matchingFilters,dateRange:{date_from:dateRange.after,date_to:dateRange.before},trendsFilter:{display:src_types.Qb.BoldNumber},modifiers:{personsOnEventsMode:"person_id_no_override_properties_on_events"}}),{resultEqualityCheck:fast_deep_equal_default()}],eventsWithRetries:[s=>[s.events,s.retries],(events,retries)=>events.results.map(row=>[...row.slice(0,3),retries.filter(r=>r.eventId===row[0].uuid),...row.slice(3)])],nextQuery:[s=>[s.baseEventsQuery,s.events],(baseEventsQuery,events)=>{if(!baseEventsQuery||!events)return null;let typedResults=events?.results,sortColumnIndex=baseEventsQuery?.select.map(hql=>DataTable_utils.$p(hql)).indexOf("timestamp");if(-1!==sortColumnIndex){let lastTimestamp=typedResults?.[typedResults.length-1]?.[sortColumnIndex];if(lastTimestamp)return{...baseEventsQuery,before:lastTimestamp,limit:20}}return null}],previousQuery:[s=>[s.baseEventsQuery,s.events],(baseEventsQuery,events)=>{if(!baseEventsQuery||!events)return null;let lastTimestamp=values.pageTimestamps[values.pageTimestamps.length-1];return{...baseEventsQuery,before:lastTimestamp,limit:20}}]}}),(0,index_esm.listeners)(_ref14=>{let{actions}=_ref14;return{changeDateRange:()=>{actions.loadEvents()},loadEvents:()=>{actions.loadTotalEvents(),actions.resetCurrentPage(),actions.resetCollapsedRows(),actions.resetSelectedForRetry()},increaseCurrentPage:()=>{actions.resetSelectedForRetry()},decreaseCurrentPage:()=>{actions.resetSelectedForRetry()}}}),(0,kea_subscriptions_lib.Vt)(_ref15=>{let{actions,values}=_ref15;return{configuration:()=>{values.configuration?.name&&(actions.loadEvents(),actions.loadTotalEvents())}}}),(0,kea_router_lib.beforeUnload)(_ref16=>{let{values,cache}=_ref16;return{enabled:()=>!cache.disabledBeforeUnload&&values.loadingRetries.length>0,message:"You have running tests that will be discarded if you leave. Are you sure?",onConfirm:()=>{cache.disabledBeforeUnload=!0}}})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let buildGlobals=(row,groupTypes,hogFunctionName)=>{let globals=(0,hogFunctionConfigurationLogic.Af)(row[0],row[1]);return globals.groups={},groupTypes.forEach((groupType,index)=>{let tuple=row?.[4+index];if(tuple&&Array.isArray(tuple)&&tuple[2]){let properties={};try{properties=JSON.parse(tuple[3])}catch{}globals.groups[groupType.group_type]={type:groupType.group_type,index:tuple[1],id:tuple[2],url:`${window.location.origin}/groups/${tuple[1]}/${encodeURIComponent(tuple[2])}`,properties}}}),globals.source={name:null!=hogFunctionName?hogFunctionName:"Unnamed",url:window.location.href.split("#")[0]},globals};function HogFunctionTesting(_ref){let{id}=_ref,{selectingMany,eventsWithRetries,loadingRetries,selectedForRetry}=(0,index_esm.useValues)(hogFunctionTestingLogic({id})),{setSelectingMany,retryInvocation,selectForRetry,deselectForRetry,resetSelectedForRetry}=(0,index_esm.useActions)(hogFunctionTestingLogic({id})),{loading,loaded,showPaygate,groupTypes,configuration,isConfigurationSubmitting,willReEnableOnSave,willChangeEnabledOnSave,configurationChanged}=(0,index_esm.useValues)((0,hogFunctionConfigurationLogic.nM)({id})),{submitConfiguration}=(0,index_esm.useActions)((0,hogFunctionConfigurationLogic.nM)({id}));return loading&&!loaded?(0,jsx_runtime.jsx)(src.t2,{}):loaded&&id?showPaygate?(0,jsx_runtime.jsx)(PayGateMini.E,{feature:src_types.P$.DATA_PIPELINES}):(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:hogFunctionConfigurationLogic.nM,props:{id},children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-3",children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[selectingMany?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>{setSelectingMany(!1),resetSelectedForRetry()},children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>selectedForRetry.length===eventsWithRetries.length?deselectForRetry(eventsWithRetries.map(row=>row[0].uuid)):selectForRetry(eventsWithRetries.map(row=>row[0].uuid)),children:(0,jsx_runtime.jsx)("span",{children:selectedForRetry.length===eventsWithRetries.length?"Deselect all":"Select all"})}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"primary",onClick:()=>{src.dn.open({title:"Test selected events",content:"Are you sure you want to test the selected events? Please don't close the window until the invocations have completed.",secondaryButton:{children:"Cancel"},primaryButton:{children:"Test selected events",onClick:()=>{eventsWithRetries.filter(row=>selectedForRetry.includes(row[0].uuid)).forEach(row=>{var _configuration$name;return retryInvocation({eventId:row[0].uuid,globals:buildGlobals(row,groupTypes,null!==(_configuration$name=configuration?.name)&&void 0!==_configuration$name?_configuration$name:"Unnamed")})})}}})},loading:loadingRetries.length>0,disabledReason:loadingRetries.length>0?"Please wait for the current tests to complete.":0===selectedForRetry.length?"No invocations selected":void 0,children:"Test selected"})]}):(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!0),children:"Select invocations"}),configurationChanged?(0,jsx_runtime.jsxs)(src.Jp,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,children:["Save",willReEnableOnSave?" & re-enable":willChangeEnabledOnSave?` & ${configuration.enabled?"enable":"disable"}`:""]}):null]})}),(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:(0,jsx_runtime.jsx)("span",{children:"This is a list of all events matching your filters. You can run the function using these historical events."})}),(0,jsx_runtime.jsx)(RunsFilters,{id:id}),(0,jsx_runtime.jsx)(TestingEventsList,{id:id})]})}):(0,jsx_runtime.jsx)(NotFound.T,{object:"Hog function"})}function EmptyColumn(){return(0,jsx_runtime.jsx)(src.u,{title:"NULL",placement:"right",delayMs:0,children:(0,jsx_runtime.jsx)("span",{className:"cursor-default","aria-hidden":!0,children:"—"})})}function RunsFilters(_ref3){var _baseEventsQuery$afte,_baseEventsQuery$befo;let{id}=_ref3,logic=hogFunctionTestingLogic({id}),{eventsLoading,baseEventsQuery}=(0,index_esm.useValues)(logic),{loadEvents,changeDateRange,loadTotalEvents}=(0,index_esm.useActions)(logic),[dropdownOpen,setDropdownOpen]=(0,react.useState)(!1);return(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{loadEvents(),loadTotalEvents()},loading:eventsLoading,type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),size:"small",children:"Refresh"}),(0,jsx_runtime.jsx)(DateFilter.f,{dateFrom:null!==(_baseEventsQuery$afte=baseEventsQuery?.after)&&void 0!==_baseEventsQuery$afte?_baseEventsQuery$afte:void 0,dateTo:null!==(_baseEventsQuery$befo=baseEventsQuery?.before)&&void 0!==_baseEventsQuery$befo?_baseEventsQuery$befo:void 0,onChange:changeDateRange}),(0,jsx_runtime.jsx)(src.Qw,{visible:dropdownOpen,closeOnClickInside:!1,matchWidth:!1,placement:"right-end",overlay:(0,jsx_runtime.jsxs)(lib.Form,{logic:hogFunctionConfigurationLogic.nM,props:{id},formKey:"configuration",className:"deprecated-space-y-3",children:[(0,jsx_runtime.jsx)(HogFunctionFilters.B,{embedded:!0,showTriggerOptions:!1}),(0,jsx_runtime.jsx)("div",{className:"flex justify-end mt-2",children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"primary",onClick:()=>setDropdownOpen(!1),children:"Done"})})]}),children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setDropdownOpen(v=>!v),children:"Filters"})})]})}function TestingEventsList(_ref4){let{id}=_ref4,logic=hogFunctionTestingLogic({id}),{eventsLoading,eventsWithRetries,totalEvents,pageTimestamps,expandedRows,loadingRetries,selectingMany,selectedForRetry}=(0,index_esm.useValues)(logic),{retryInvocation,loadNextEventsPage,loadPreviousEventsPage,expandRow,collapseRow,selectForRetry,deselectForRetry}=(0,index_esm.useActions)(logic),{groupTypes,configuration,logicProps}=(0,index_esm.useValues)((0,hogFunctionConfigurationLogic.nM)({id})),{setSampleGlobals,toggleExpanded}=(0,index_esm.useActions)((0,hogFunctionTestLogic.g)(logicProps));return(0,jsx_runtime.jsx)(src.g3,{dataSource:eventsWithRetries,loading:eventsLoading,loadingSkeletonRows:5,pagination:{controlled:!0,currentPage:pageTimestamps.length+1,onForward:loadNextEventsPage,onBackward:loadPreviousEventsPage,pageSize:eventsWithRetries.length,hideOnSinglePage:!1,entryCount:totalEvents},expandable:{isRowExpanded:_ref5=>{let[event]=_ref5;return expandedRows.includes(event.uuid)},onRowExpand:_ref6=>{let[event]=_ref6;return expandRow(event.uuid)},onRowCollapse:_ref7=>{let[event]=_ref7;return collapseRow(event.uuid)},noIndent:!0,expandedRowRender:_ref8=>{let[,,,retries]=_ref8;return(0,jsx_runtime.jsx)(src.g3,{dataSource:retries.reduce((acc,group)=>acc.concat(group.logs),[]),embedded:!0,columns:[{key:"spacer",width:0,render:()=>(0,jsx_runtime.jsx)("div",{className:"w-6"})},{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:(_,_ref9)=>{let{timestamp}=_ref9;return(0,jsx_runtime.jsx)(TZLabel.w,{time:timestamp})}},{title:"Level",key:"level",dataIndex:"level",render:(_,_ref10)=>{let{level}=_ref10;return(0,jsx_runtime.jsx)(src.oe,{type:(0,LogsViewer.n)(level),children:level.toUpperCase()})}},{title:"Message",key:"message",dataIndex:"message",render:(_,_ref11)=>{let{message}=_ref11;return(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}}]})}},columns:[{title:"Status",key:"status",width:0,render:(_,row)=>{let eventId=row[0].uuid,getStatus=()=>loadingRetries.includes(eventId)?{text:"Running",type:"warning"}:0===row[3].length?{text:"Not tested",type:"muted"}:"error"===row[3][row[3].length-1].status?{text:"Failure",type:"danger"}:"success"===row[3][row[3].length-1].status?{text:"Success",type:"success"}:{text:"Unknown",type:"muted"};return(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-center",children:[selectingMany?(0,jsx_runtime.jsx)(src.Hw,{checked:selectedForRetry.includes(eventId),onChange:checked=>{checked?selectForRetry([eventId]):deselectForRetry([eventId])}}):null,(0,jsx_runtime.jsx)(src.oe,{type:getStatus().type,children:(0,utils.fm)(getStatus().text)}),(0,jsx_runtime.jsx)(src.d6,{items:[eventId?{label:"View event",to:urls.j.event(eventId,row[0].timestamp)}:null,{label:"Test event",onClick:()=>{var _configuration$name2;retryInvocation({eventId,globals:buildGlobals(row,groupTypes,null!==(_configuration$name2=configuration?.name)&&void 0!==_configuration$name2?_configuration$name2:"Unnamed")}),expandRow(eventId)}},{label:"Test with this event in configuration",onClick:()=>{var _configuration$name3;setSampleGlobals(buildGlobals(row,groupTypes,null!==(_configuration$name3=configuration?.name)&&void 0!==_configuration$name3?_configuration$name3:"Unnamed")),toggleExpanded(!0),kea_router_lib.router.actions.push(urls.j.hogFunction(id)+"?tab=configuration")}}],children:(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{className:"rotate-90"}),loading:!!loadingRetries.includes(eventId)||void 0})})]})}},{title:"Event",key:"event",className:"max-w-80",render:(_,_ref12)=>{let[event]=_ref12;return event.event?(0,jsx_runtime.jsx)(PropertyKeyInfo.T,{value:event.event,type:types.t.Events}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"Person",key:"person",render:(_,_ref13)=>{let[,person]=_ref13;return person?(0,jsx_runtime.jsx)(PersonDisplay.I,{person:person,withIcon:!0}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"URL / Screen",key:"url",className:"max-w-80",render:(_,_ref14)=>{let[event]=_ref14;return event.properties.$current_url||event.properties.$screen_name?(0,jsx_runtime.jsx)("span",{children:event.properties.$current_url||event.properties.$screen_name}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"Library",key:"library",className:"max-w-80",render:(_,_ref15)=>{let[event]=_ref15;return event.properties.$lib?(0,jsx_runtime.jsx)("span",{children:event.properties.$lib}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"Time",key:"time",className:"max-w-80",render:(_,_ref16)=>{let[event]=_ref16;return event.timestamp?(0,jsx_runtime.jsx)(TZLabel.w,{time:event.timestamp}):(0,jsx_runtime.jsx)(EmptyColumn,{})}}],emptyState:(0,jsx_runtime.jsx)(EmptyStates.dV,{})})}}}]);
//# sourceMappingURL=32347.63050abe.iframe.bundle.js.map