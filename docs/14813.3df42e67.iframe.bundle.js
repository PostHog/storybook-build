"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[14813],{"../../products/managed_migrations/frontend/ManagedMigration.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{ManagedMigration:()=>ManagedMigration,ManagedMigrations:()=>ManagedMigrations,scene:()=>scene});var src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonInput=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonInput/index.ts"),LemonProgress=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonProgress/index.tsx"),LemonSelect=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSelect/index.ts"),ProfilePicture=__webpack_require__("../../frontend/src/lib/lemon-ui/ProfilePicture/index.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts");let managedMigrationLogic=(0,index_esm.kea)([(0,index_esm.path)(["products","managed_migrations","frontend","managedMigrationLogic"]),(0,index_esm.props)({managedMigrationId:null}),(0,index_esm.actions)({editManagedMigration:id=>({id}),startPolling:!0,stopPolling:!0}),(0,index_esm.reducers)({managedMigrationId:[null,{editManagedMigration:(_,_ref)=>{let{id}=_ref;return id}}],isPolling:[!1,{startPolling:()=>!0,stopPolling:()=>!1}]}),(0,kea_loaders_lib.loaders)(()=>({migrations:[[],{loadMigrations:async()=>{let projectId=api.x7.getCurrentProjectId();return(await api.ZP.get(`api/projects/${projectId}/managed_migrations`)).results}}]})),(0,lib.forms)({managedMigration:{defaults:{source_type:"s3",access_key:"",secret_key:"",s3_region:"",s3_bucket:"",s3_prefix:"",content_type:"captured"},errors:_ref2=>{let{source_type,access_key,secret_key,s3_region,s3_bucket}=_ref2;return{source_type:source_type?null:"Source is required",access_key:access_key?null:"Access key is required",secret_key:secret_key?null:"Secret key is required",s3_region:s3_region?null:"S3 region is required",s3_bucket:s3_bucket?null:"S3 bucket is required"}},submit:async values=>{let projectId=api.x7.getCurrentProjectId(),response=await api.ZP.create(`api/projects/${projectId}/managed_migrations`,values);return kea_router_lib.router.actions.push(urls.j.managedMigration()),response}}}),(0,index_esm.sharedListeners)(_ref3=>{let{actions}=_ref3;return{afterSubmit:async()=>{await actions.loadMigrations()}}}),(0,index_esm.listeners)(_ref4=>{let{actions,values,cache}=_ref4;return{loadMigrationsSuccess:()=>{let hasRunningMigrations=values.migrations.some(migration=>"running"===migration.status);hasRunningMigrations&&!values.isPolling?actions.startPolling():!hasRunningMigrations&&values.isPolling&&actions.stopPolling()},startPolling:()=>{let pollInterval=setInterval(()=>{if(!values.isPolling){clearInterval(pollInterval);return}actions.loadMigrations()},5e3);cache.pollInterval=pollInterval},stopPolling:()=>{cache.pollInterval&&(clearInterval(cache.pollInterval),cache.pollInterval=null)}}}),(0,index_esm.selectors)({breadcrumbs:[(_,p)=>[p.managedMigrationId],managedMigrationId=>[{key:"managed-migrations",name:"Managed Migrations",path:urls.j.managedMigration()},...managedMigrationId?[{key:"edit-migration",name:"Manage migration",path:urls.j.managedMigration()}]:[]]],projectTreeRef:[(_,p)=>[p.managedMigrationId],managedMigrationId=>({type:"managed-migration",ref:managedMigrationId})]}),(0,kea_router_lib.urlToAction)(_ref5=>{let{actions}=_ref5;return{[urls.j.managedMigrationNew()]:()=>{actions.editManagedMigration("new")},[`${urls.j.managedMigration()}/:id`]:_ref6=>{let{id}=_ref6;actions.editManagedMigration(null!=id?id:null)},[urls.j.managedMigration()]:()=>{actions.editManagedMigration(null)}}}),(0,index_esm.afterMount)(_ref7=>{let{actions}=_ref7;actions.loadMigrations()}),(0,index_esm.beforeUnmount)(_ref8=>{let{actions}=_ref8;actions.stopPolling()})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let STATUS_COLORS={running:"primary",completed:"success",paused:"danger"};function StatusTag(_ref){let{status}=_ref;return(0,jsx_runtime.jsx)(src.oe,{type:STATUS_COLORS[status]||"default",children:status.charAt(0).toUpperCase()+status.slice(1)})}function ManagedMigration(){let{managedMigration}=(0,index_esm.useValues)(managedMigrationLogic),{setManagedMigrationValue}=(0,index_esm.useActions)(managedMigrationLogic);return(0,jsx_runtime.jsxs)(lib.Form,{logic:managedMigrationLogic,formKey:"managedMigration",enableFormOnSubmit:!0,className:"space-y-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"source_type",label:"Source",children:(0,jsx_runtime.jsx)(LemonSelect.Yv,{value:managedMigration.source_type,onChange:value=>setManagedMigrationValue("source_type",value),options:[{value:"s3",label:"S3",icon:(0,jsx_runtime.jsx)("img",{src:"https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico"})}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"content_type",label:"Content Type",children:(0,jsx_runtime.jsx)(LemonSelect.Yv,{value:managedMigration.content_type,onChange:value=>setManagedMigrationValue("content_type",value),options:[{value:"captured",label:"PostHog Events"},{value:"mixpanel",label:"Mixpanel Events"},{value:"amplitude",label:"Amplitude Events"}]})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"s3_region",label:"S3 Region",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInput.D,{placeholder:"us-east-1"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"s3_bucket",label:"S3 Bucket",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInput.D,{placeholder:"my-bucket"})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"s3_prefix",label:"S3 Prefix (optional)",children:(0,jsx_runtime.jsx)(LemonInput.D,{placeholder:"path/to/files/"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"access_key",label:"Access Key ID",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInput.D,{type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"secret_key",label:"Secret Access Key",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInput.D,{type:"password"})})]}),(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(src.Jp,{type:"primary",htmlType:"submit",children:"Import Data"})})]})}function ManagedMigrations(){let{managedMigrationId,migrations,migrationsLoading}=(0,index_esm.useValues)(managedMigrationLogic),calculateProgress=migration=>{if(migration.state?.parts&&Array.isArray(migration.state.parts)){let parts=migration.state.parts,totalParts=parts.length,completedParts=parts.filter(part=>null!==part.total_size&&part.total_size===part.current_offset).length;return{progress:totalParts>0?completedParts/totalParts*100:0,completed:completedParts,total:totalParts}}return{progress:0,completed:0,total:0}};return managedMigrationId?(0,jsx_runtime.jsx)(ManagedMigration,{}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{caption:"Import data from S3",buttons:(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"new-managed-migration",to:urls.j.managedMigrationNew(),type:"primary",children:"New migration"})}),(0,jsx_runtime.jsx)(src.g3,{dataSource:migrations,loading:migrationsLoading,defaultSorting:{columnKey:"created_at",order:-1},columns:[{title:"Source",dataIndex:"source_type",render:()=>(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("img",{src:"https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico",alt:"S3",className:"w-4 h-4"}),"AWS S3"]})},{title:"Content Type",dataIndex:"content_type",render:(_,migration)=>{let config={captured:{icon:"/static/icons/favicon.ico?v=2023-07-07",alt:"PostHog"},mixpanel:{icon:"https://mixpanel.com/favicon.ico",alt:"Mixpanel"},amplitude:{icon:"https://amplitude.com/favicon.ico",alt:"Amplitude"}}[migration.content_type];return config?(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center gap-2",children:(0,jsx_runtime.jsx)("img",{src:config.icon,alt:config.alt,className:"w-4 h-4"})}):migration.content_type}},{title:"Status",dataIndex:"status",render:(_,migration)=>(0,jsx_runtime.jsx)(StatusTag,{status:migration.status})},{title:"Progress",key:"progress",render:(_,migration)=>{let{progress,completed,total}=calculateProgress(migration);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)(LemonProgress.b,{percent:progress,strokeColor:"paused"===migration.status?"var(--danger)":void 0}),(0,jsx_runtime.jsx)("span",{className:"text-xs text-muted",children:"completed"===migration.status?"Complete":"paused"===migration.status?"Paused":`${completed}/${total}`})]})}},{title:"Created by",dataIndex:"created_by",render:function Render(_,migration){return(0,jsx_runtime.jsx)("div",{className:"flex flex-row items-center flex-nowrap",children:migration.created_by&&(0,jsx_runtime.jsx)(ProfilePicture.Y,{user:migration.created_by,size:"md",showName:!0})})}},{title:"Created",dataIndex:"created_at",render:function Render(dataValue){return"string"==typeof dataValue?(0,jsx_runtime.jsx)("div",{className:"whitespace-nowrap text-right",children:(0,jsx_runtime.jsx)(TZLabel.w,{time:(0,dayjs.Bv)(dataValue)})}):(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:"—"})},align:"right"},{title:"Error",dataIndex:"error",render:(_,migration)=>migration.error||"-"}],emptyState:"No migrations found. Create a new migration to get started."})]})}let scene={component:ManagedMigrations,logic:managedMigrationLogic}}}]);