"use strict";(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[81045],{"../../frontend/src/scenes/pipeline/PipelineBatchExportConfiguration.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{B:()=>PipelineBatchExportConfiguration});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.11.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),EventSelect=__webpack_require__("../../frontend/src/lib/components/EventSelect/EventSelect.tsx"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),PropertyFilters=__webpack_require__("../../frontend/src/lib/components/PropertyFilters/PropertyFilters.tsx"),types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonCollapse=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonCollapse/index.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonInput=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonInput/index.ts"),LemonLabel=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonLabel/index.ts"),Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/index.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),DatabaseTable=__webpack_require__("../../frontend/src/scenes/data-management/database/DatabaseTable.tsx"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),src_types=__webpack_require__("../../frontend/src/types.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function BatchExportGeneralEditFields(_ref){let{isNew,isPipeline=!1,batchExportConfigForm}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[!isPipeline&&(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"Name your workflow for future reference"})}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 items-start flex-wrap",children:(!isPipeline||batchExportConfigForm.end_at)&&(0,jsx_runtime.jsx)(LemonField.D,{name:"end_at",label:"End date",className:"flex-1",info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The date up to which data is to be exported. Leaving it unset implies that data exports will continue forever until this export is paused or deleted."}),children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.he,{value:value,onChange:onChange,placeholder:"Select end date (optional)",clearable:!0})}})}),isNew&&!isPipeline?(0,jsx_runtime.jsx)(LemonField.D,{name:"paused",children:(0,jsx_runtime.jsx)(src.Hw,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Create in paused state",(0,jsx_runtime.jsx)(src.u,{title:"If selected, the Batch Exporter will be created but will be 'paused' allowing you to resumed it at a later date.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:" text-lg text-secondary"})})]})})}):null]})})}function BatchExportsEditFields(_ref3){let{isNew,batchExportConfigForm}=_ref3;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-4 max-w-200 mt-4",children:"S3"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"bucket_name",label:"Bucket",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. my-bucket"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"region",label:"Region",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"us-east-1",label:"US East (N. Virginia)"},{value:"us-east-2",label:"US East (Ohio)"},{value:"us-west-1",label:"US West (N. California)"},{value:"us-west-2",label:"US West (Oregon)"},{value:"af-south-1",label:"Africa (Cape Town)"},{value:"ap-east-1",label:"Asia Pacific (Hong Kong)"},{value:"ap-south-1",label:"Asia Pacific (Mumbai)"},{value:"ap-northeast-3",label:"Asia Pacific (Osaka-Local)"},{value:"ap-northeast-2",label:"Asia Pacific (Seoul)"},{value:"ap-southeast-1",label:"Asia Pacific (Singapore)"},{value:"ap-southeast-2",label:"Asia Pacific (Sydney)"},{value:"ap-northeast-1",label:"Asia Pacific (Tokyo)"},{value:"ca-central-1",label:"Canada (Central)"},{value:"cn-north-1",label:"China (Beijing)"},{value:"cn-northwest-1",label:"China (Ningxia)"},{value:"eu-central-1",label:"Europe (Frankfurt)"},{value:"eu-west-1",label:"Europe (Ireland)"},{value:"eu-west-2",label:"Europe (London)"},{value:"eu-south-1",label:"Europe (Milan)"},{value:"eu-west-3",label:"Europe (Paris)"},{value:"eu-north-1",label:"Europe (Stockholm)"},{value:"me-south-1",label:"Middle East (Bahrain)"},{value:"sa-east-1",label:"South America (São Paulo)"},{value:"auto",label:"Automatic (AUTO)"},{value:"apac",label:"Asia Pacific (APAC)"},{value:"eeur",label:"Eastern Europe (EEUR)"},{value:"enam",label:"Eastern North America (ENAM)"},{value:"weur",label:"Western Europe (WEUR)"},{value:"wnam",label:"Western North America (WNAM)"}]})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"prefix",label:"Key prefix",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. posthog-events/"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"file_format",label:"Format",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"JSONLines",label:"JSON lines"},{value:"Parquet",label:"Apache Parquet"}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"max_file_size_mb",label:"Max file size (MiB)",showOptional:!0,className:"flex-1",info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Files over this max file size will be split into multiple files. Leave empty or set to 0 for no splitting regardless of file size"}),children:(0,jsx_runtime.jsx)(src.DF,{type:"number",min:0})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"compression",label:"Compression",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"gzip",label:"gzip"},{value:"brotli",label:"brotli"},{value:null,label:"No compression"}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"encryption",label:"Encryption",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"AES256",label:"AES256"},{value:"aws:kms",label:"aws:kms"},{value:null,label:"No encryption"}]})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"aws_access_key_id",label:"AWS Access Key ID",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. AKIAIOSFODNN7EXAMPLE":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"aws_secret_access_key",label:"AWS Secret Access Key",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. secret-key":"Leave unchanged",type:"password"})}),"aws:kms"==batchExportConfigForm.encryption&&(0,jsx_runtime.jsx)(LemonField.D,{name:"kms_key_id",label:"AWS KMS Key ID",className:"flex-1",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. 1234abcd-12ab-34cd-56ef-1234567890ab":"leave unchanged"})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"endpoint_url",label:"Endpoint URL",showOptional:!0,info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Only required if exporting to an S3-compatible blob storage (like MinIO)"}),children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"e.g. https://your-minio-host:9000":"Leave unchanged"})})]}):"Snowflake"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"account",label:"Account",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-account"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-user":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"authentication_type",label:"Authentication type",className:"flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"password",label:"Password"},{value:"keypair",label:"Key pair"}]})}),"keypair"!=batchExportConfigForm.authentication_type&&(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-password":"Leave unchanged",type:"password"})}),"keypair"==batchExportConfigForm.authentication_type&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"private_key",label:"Private key",children:(0,jsx_runtime.jsx)(src._V,{className:"ph-ignore-input",placeholder:isNew?"my-private-key":"Leave unchanged",minRows:4})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"private_key_passphrase",label:"Private key passphrase",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-passphrase":"Leave unchanged"})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"warehouse",label:"Warehouse",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-warehouse"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-schema"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"role",label:"Role",showOptional:!0,children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-role"})})]}):"Postgres"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-user":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-password":"Leave unchanged",type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"host",label:"Host",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-host"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"port",label:"Port",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"5432",type:"number",min:"0",max:"65535"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"public"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"has_self_signed_cert",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsx)(src.Hw,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Does your Postgres instance have a self-signed SSL certificate?",(0,jsx_runtime.jsx)(src.u,{title:"In most cases, Heroku and RDS users should check this.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:" text-lg text-secondary"})})]}),checked:!!value,onChange:onChange})}})]}):"Redshift"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-user":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:isNew?"my-password":"Leave unchanged",type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"host",label:"Host",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-host"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"port",label:"Port",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"5439",type:"number",min:"0",max:"65535"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"public"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"properties_data_type",label:"Properties data type",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"varchar",label:"VARCHAR(65535)"},{value:"super",label:"SUPER"}]})})]}):"BigQuery"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"json_config_file",label:"Google Cloud JSON key file",children:(0,jsx_runtime.jsx)(src.mH,{accept:".json",multiple:!1})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_id",label:"Table ID",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"dataset_id",label:"Dataset ID",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"dataset"})}),isNew?(0,jsx_runtime.jsx)(LemonField.D,{name:"use_json_type",label:"Structured fields data type",children:(0,jsx_runtime.jsx)(src.Hw,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Export 'properties', 'set', and 'set_once' fields as BigQuery JSON type",(0,jsx_runtime.jsx)(src.u,{title:"If left unchecked, these fields will be sent as STRING type. This setting cannot be changed after batch export is created.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:" text-lg text-secondary"})})]})})}):null]}):"HTTP"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"url",label:"PostHog region",children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"https://us.i.posthog.com/batch/",label:"US"},{value:"https://eu.i.posthog.com/batch/",label:"EU"}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"token",label:"Destination project API Key",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. phc_12345..."})})]}):null})})}var utils=__webpack_require__("../../frontend/src/scenes/pipeline/batch-exports/utils.ts"),pipelineBatchExportConfigurationLogic=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineBatchExportConfigurationLogic.tsx"),pipeline_utils=__webpack_require__("../../frontend/src/scenes/pipeline/utils.tsx");function PipelineBatchExportConfiguration(_ref){let{service,id}=_ref,logicProps={service:service||null,id:id||null},logic=(0,pipelineBatchExportConfigurationLogic.t)(logicProps),{isNew,configuration,tables,savedConfiguration,isConfigurationSubmitting,batchExportConfigLoading,configurationChanged,batchExportConfig,selectedModel}=(0,index_esm.useValues)(logic),{resetConfiguration,submitConfiguration,setSelectedModel,setConfigurationValue}=(0,index_esm.useActions)(logic),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.h),highFrequencyBatchExports=featureFlags[constants.y8.HIGH_FREQUENCY_BATCH_EXPORTS],sessionsBatchExports=featureFlags[constants.y8.SESSIONS_BATCH_EXPORTS];if(service&&!src_types.e2.includes(service))return(0,jsx_runtime.jsx)(NotFound.T,{object:`batch export service ${service}`});if(!batchExportConfig&&batchExportConfigLoading)return(0,jsx_runtime.jsx)(Spinner.t,{});let buttons=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",htmlType:"reset",onClick:()=>isNew&&service?resetConfiguration((0,pipelineBatchExportConfigurationLogic.z)(service)):resetConfiguration(savedConfiguration),disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress…":void 0:"No changes",children:isNew?"Reset":"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress…":void 0:"No changes to save",children:isNew?"Create":"Save"})]});return(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-3",children:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:buttons}),(0,jsx_runtime.jsxs)(lib.Form,{logic:pipelineBatchExportConfigurationLogic.t,props:logicProps,formKey:"configuration",className:"deprecated-space-y-3",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-start gap-4 flex-wrap",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1 min-w-100 deprecated-space-y-3",children:[(0,jsx_runtime.jsxs)("div",{className:"border bg-surface-primary p-3 rounded deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 min-h-16 items-center",children:[configuration.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(pipeline_utils.oe,{size:"medium",type:configuration.destination}),(0,jsx_runtime.jsx)("div",{className:"flex-1 font-semibold text-sm",children:(0,utils.x)(configuration.destination)})]}):(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"paused",info:"Start in a paused state or continuously exporting from now",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.f4,{label:"Enabled",onChange:()=>onChange(!value),checked:!value,bordered:!0})}})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",info:"Customizing the name can be useful if multiple instances of the same type are used.",children:(0,jsx_runtime.jsx)(LemonInput.D,{type:"text"})}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 min-h-16",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"interval",label:"Interval",className:"flex-1",info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Dictates the frequency of batch export runs. For example, if you select hourly, a new batch export run will start every hour."}),children:(0,jsx_runtime.jsx)(src.Yv,{options:[{value:"hour",label:"Hourly"},{value:"day",label:"Daily"},{value:"every 5 minutes",label:"Every 5 minutes",hidden:!highFrequencyBatchExports}]})})})]}),(0,jsx_runtime.jsxs)("div",{className:"border bg-surface-primary p-3 rounded deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex gap-2 min-h-16",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"model",label:"Model",info:"A model defines the data that will be exported.",className:"flex flex-1",children:(0,jsx_runtime.jsx)(src.Yv,{options:tables.map(table=>({value:table.name,label:table.id,hidden:!sessionsBatchExports&&"sessions"===table.name})),value:selectedModel,onSelect:newValue=>{setSelectedModel(newValue)},fullWidth:!0})})}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2",children:(0,jsx_runtime.jsx)(LemonCollapse.J,{className:"flex flex-1",panels:[{key:"schema",header:"View model schema",content:(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(DatabaseTable.B,{table:selectedModel||"events",tables:tables,inEditSchemaMode:!1})})}]})}),"events"===selectedModel?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 min-h-16",children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-between w-full gap-2",children:(0,jsx_runtime.jsx)(LemonLabel.H,{children:"Include events"})}),(0,jsx_runtime.jsxs)("p",{className:"mb-0 text-xs text-secondary",children:["If set, the batch export will ",(0,jsx_runtime.jsx)("b",{children:"only"})," export events matching any of the below. If left unset, all events will be exported."]}),(0,jsx_runtime.jsx)(EventSelect._,{onChange:includedEvents=>{setConfigurationValue("include_events",includedEvents.filter(event=>null!=event))},selectedEvents:configuration.include_events?configuration.include_events:[],addElement:(0,jsx_runtime.jsx)(LemonButton.J,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),sideIcon:null,children:"Include event"})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-2 min-h-16",children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-between w-full gap-2",children:(0,jsx_runtime.jsx)(LemonLabel.H,{children:"Exclude events"})}),(0,jsx_runtime.jsxs)("p",{className:"mb-0 text-xs text-secondary",children:["If set, the batch export will ",(0,jsx_runtime.jsx)("b",{children:"exclude"})," events matching any of the below. If left unset, no events will be excluded from the export."]}),(0,jsx_runtime.jsx)(EventSelect._,{onChange:excludedEvents=>{setConfigurationValue("exclude_events",excludedEvents.filter(event=>null!=event))},selectedEvents:configuration.exclude_events?configuration.exclude_events:[],addElement:(0,jsx_runtime.jsx)(LemonButton.J,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),sideIcon:null,children:"Exclude event"})})]}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 min-h-16",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"filters",label:"Filters",className:"flex flex-1",children:(0,jsx_runtime.jsx)(PropertyFilters.t,{propertyFilters:configuration.filters?configuration.filters:[],taxonomicGroupTypes:"events"===selectedModel?[types.t.EventProperties]:[types.t.PersonProperties],onChange:filters=>{setConfigurationValue("filters",filters)},pageKey:`BatchExportsPropertyFilters.${batchExportConfig?batchExportConfig.id:"New"}`,metadataSource:{kind:schema_general.OH.ActorsQuery}})})})]}):null]})]}),(0,jsx_runtime.jsx)("div",{className:"flex-2 gap-4 deprecated-space-y-4 min-w-100",children:(0,jsx_runtime.jsx)("div",{className:"border bg-surface-primary p-3 rounded",children:(0,jsx_runtime.jsx)(BatchExportConfigurationFields,{isNew:isNew,formValues:configuration})})})]}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-end",children:buttons})]})]})})}function BatchExportConfigurationFields(_ref3){let{isNew,formValues}=_ref3;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(BatchExportGeneralEditFields,{isNew:isNew,isPipeline:!0,batchExportConfigForm:formValues}),(0,jsx_runtime.jsx)(BatchExportsEditFields,{isNew:isNew,batchExportConfigForm:formValues})]})}},"../../frontend/src/scenes/pipeline/PipelineNode.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{PIPELINE_TAB_TO_NODE_STAGE:()=>PIPELINE_TAB_TO_NODE_STAGE,PipelineNode:()=>PipelineNode,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),ActivityLog=__webpack_require__("../../frontend/src/lib/components/ActivityLog/ActivityLog.tsx"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),LemonTabs=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTabs/LemonTabs.tsx"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx"),More=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/More.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),data_warehouse_utils=__webpack_require__("../../frontend/src/scenes/data-warehouse/utils.ts"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),SyncMethodForm=__webpack_require__("../../frontend/src/scenes/data-warehouse/external/forms/SyncMethodForm.tsx"),dataWarehouseSettingsLogic=__webpack_require__("../../frontend/src/scenes/data-warehouse/settings/dataWarehouseSettingsLogic.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts");let dataWarehouseSourcesTableSyncMethodModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-warehouse","settings","DataWarehouseSourcesTableSyncMethodModalLogic"]),(0,index_esm.props)({schema:{}}),(0,index_esm.key)(props=>props.schema.id),(0,index_esm.connect)(()=>({actions:[dataWarehouseSettingsLogic.T,["updateSchema","updateSchemaSuccess","updateSchemaFailure","loadSources"]]})),(0,index_esm.actions)({openSyncMethodModal:schema=>({schema}),closeSyncMethodModal:!0}),(0,lib.loaders)({schemaIncrementalFields:[null,{loadSchemaIncrementalFields:async schemaId=>await api.ZP.externalDataSchemas.incremental_fields(schemaId),resetSchemaIncrementalFields:()=>null}]}),(0,index_esm.reducers)({syncMethodModalIsOpen:[!1,{openSyncMethodModal:()=>!0,closeSyncMethodModal:()=>!1}],currentSyncMethodModalSchema:[null,{openSyncMethodModal:(_,_ref)=>{let{schema}=_ref;return schema},closeSyncMethodModal:()=>null}],saveButtonIsLoading:[!1,{updateSchema:()=>!0,updateSchemaFailure:()=>!1,updateSchemaSuccess:()=>!1}]}),(0,index_esm.listeners)(_ref2=>{let{actions}=_ref2;return{updateSchemaSuccess:()=>{actions.loadSources(null),actions.resetSchemaIncrementalFields(),actions.closeSyncMethodModal()}}})]);var kea_forms_lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),dist_module=__webpack_require__("../../node_modules/.pnpm/posthog-js@1.230.1_@rrweb+types@2.0.0-alpha.17/node_modules/posthog-js/dist/module.js"),sourceWizardLogic=__webpack_require__("../../frontend/src/scenes/data-warehouse/new/sourceWizardLogic.tsx");let dataWarehouseSourceSettingsLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-warehouse","settings","source","dataWarehouseSourceSettingsLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.actions)({setSourceId:id=>({id}),reloadSchema:schema=>({schema}),resyncSchema:schema=>({schema}),setCanLoadMoreJobs:canLoadMoreJobs=>({canLoadMoreJobs})}),(0,lib.loaders)(_ref2=>{let{actions,values}=_ref2;return{source:[null,{loadSource:async()=>await api.ZP.externalDataSources.get(values.sourceId),updateSchema:async schema=>{let clonedSource=JSON.parse(JSON.stringify(values.source)),schemaIndex=clonedSource.schemas.findIndex(n=>n.id===schema.id);clonedSource.schemas[schemaIndex]=schema,actions.loadSourceSuccess(clonedSource);let updatedSchema=await api.ZP.externalDataSchemas.update(schema.id,schema),source=values.source;return void 0!==schemaIndex&&(source.schemas[schemaIndex]=updatedSchema),source},updateSource:async source=>{let updatedSource=await api.ZP.externalDataSources.update(values.sourceId,source);return actions.loadSourceSuccess(updatedSource),updatedSource}}],jobs:[[],{loadJobs:async()=>0===values.jobs.length?await api.ZP.externalDataSources.jobs(values.sourceId,null,null):[...await api.ZP.externalDataSources.jobs(values.sourceId,null,values.jobs[0].created_at),...values.jobs],loadMoreJobs:async()=>{if(values.jobs.length>=0){let lastJobCreatedAt=values.jobs[values.jobs.length-1].created_at,oldJobs=await api.ZP.externalDataSources.jobs(values.sourceId,lastJobCreatedAt,null);return 0===oldJobs.length?(actions.setCanLoadMoreJobs(!1),values.jobs):[...values.jobs,...oldJobs]}return values.jobs}}]}}),(0,index_esm.reducers)(_ref3=>{let{props}=_ref3;return{sourceId:[props.id,{setSourceId:(_,_ref4)=>{let{id}=_ref4;return id}}],canLoadMoreJobs:[!0,{setCanLoadMoreJobs:(_,_ref5)=>{let{canLoadMoreJobs}=_ref5;return canLoadMoreJobs},setSourceId:()=>!0}]}}),(0,index_esm.selectors)({sourceFieldConfig:[s=>[s.source],source=>source?sourceWizardLogic.l2[source.source_type]:null]}),(0,kea_forms_lib.forms)(_ref6=>{let{values,actions}=_ref6;return{sourceConfig:{defaults:{},errors:sourceValues=>{var _values$sourceFieldCo;return(0,sourceWizardLogic.HM)(null!==(_values$sourceFieldCo=values.sourceFieldConfig?.fields)&&void 0!==_values$sourceFieldCo?_values$sourceFieldCo:[],sourceValues)},submit:async _ref7=>{let{payload={}}=_ref7,newJobInputs={...values.source?.job_inputs,...payload};try{let updatedSource=await api.ZP.externalDataSources.update(values.sourceId,{job_inputs:newJobInputs});actions.loadSourceSuccess(updatedSource),src.UJ.success("Source updated")}catch(e){e.message?src.UJ.error(e.message):src.UJ.error("Cant update source at this time")}}}}}),(0,index_esm.listeners)(_ref8=>{let{values,actions,cache}=_ref8;return{loadSourceSuccess:()=>{clearTimeout(cache.sourceRefreshTimeout),cache.sourceRefreshTimeout=setTimeout(()=>{actions.loadSource()},5e3)},loadSourceFailure:()=>{clearTimeout(cache.sourceRefreshTimeout),cache.sourceRefreshTimeout=setTimeout(()=>{actions.loadSource()},5e3)},loadJobsSuccess:()=>{clearTimeout(cache.jobsRefreshTimeout),cache.jobsRefreshTimeout=setTimeout(()=>{actions.loadJobs()},5e3)},loadJobsFailure:()=>{clearTimeout(cache.jobsRefreshTimeout),cache.jobsRefreshTimeout=setTimeout(()=>{actions.loadJobs()},5e3)},reloadSchema:async _ref9=>{let{schema}=_ref9,clonedSource=JSON.parse(JSON.stringify(values.source)),schemaIndex=clonedSource.schemas.findIndex(n=>n.id===schema.id);clonedSource.status="Running",clonedSource.schemas[schemaIndex].status="Running",actions.loadSourceSuccess(clonedSource);try{await api.ZP.externalDataSchemas.reload(schema.id),dist_module.ZP.capture("schema reloaded",{sourceType:clonedSource.source_type})}catch(e){e.message?src.UJ.error(e.message):src.UJ.error("Cant reload schema at this time")}},resyncSchema:async _ref10=>{let{schema}=_ref10,clonedSource=JSON.parse(JSON.stringify(values.source)),schemaIndex=clonedSource.schemas.findIndex(n=>n.id===schema.id);clonedSource.status="Running",clonedSource.schemas[schemaIndex].status="Running",actions.loadSourceSuccess(clonedSource);try{await api.ZP.externalDataSchemas.resync(schema.id),dist_module.ZP.capture("schema resynced",{sourceType:clonedSource.source_type})}catch(e){e.message?src.UJ.error(e.message):src.UJ.error("Cant refresh schema at this time")}}}}),(0,index_esm.afterMount)(_ref11=>{let{actions}=_ref11;actions.loadSource(),actions.loadJobs()})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let Schemas=_ref=>{var _source$schemas;let{id}=_ref,{source,sourceLoading}=(0,index_esm.useValues)(dataWarehouseSourceSettingsLogic({id}));return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:dataWarehouseSourceSettingsLogic,props:{id},children:(0,jsx_runtime.jsx)(SchemaTable,{schemas:null!==(_source$schemas=source?.schemas)&&void 0!==_source$schemas?_source$schemas:[],isLoading:sourceLoading})})},StatusTagSetting={Running:"primary",Completed:"success",Error:"danger",Failed:"danger",Suspended:"warning","Billing limits":"danger"},SchemaTable=_ref2=>{let{schemas,isLoading}=_ref2,{updateSchema,reloadSchema,resyncSchema}=(0,index_esm.useActions)(dataWarehouseSourceSettingsLogic),{schemaReloadingById}=(0,index_esm.useValues)(dataWarehouseSettingsLogic.T);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.g3,{dataSource:schemas,loading:isLoading,disableTableWhileLoading:!1,columns:[{title:"Schema Name",key:"name",render:function RenderName(_,schema){return(0,jsx_runtime.jsx)("span",{children:schema.name})}},{title:"Sync Frequency",key:"frequency",render:function RenderFrequency(_,schema){return(0,jsx_runtime.jsx)(src.Yv,{className:"my-1",disabled:!schema.should_sync,value:schema.sync_frequency||"6hour",onChange:value=>updateSchema({...schema,sync_frequency:value}),options:[{value:"5min",label:"5 mins"},{value:"30min",label:"30 mins"},{value:"1hour",label:"1 hour"},{value:"6hour",label:"6 hours"},{value:"12hour",label:"12 hours"},{value:"24hour",label:"Daily"},{value:"7day",label:"Weekly"},{value:"30day",label:"Monthly"}]})}},{title:"Sync method",key:"incremental",render:function RenderIncremental(_,schema){let{openSyncMethodModal}=(0,index_esm.useActions)(dataWarehouseSourcesTableSyncMethodModalLogic({schema}));return schema.sync_type?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{className:"my-1",size:"small",type:"secondary",onClick:()=>openSyncMethodModal(schema),children:"incremental"==schema.sync_type?"Incremental":"Full refresh"}),(0,jsx_runtime.jsx)(SyncMethodModal,{schema:schema})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{className:"my-1",type:"primary",onClick:()=>openSyncMethodModal(schema),children:"Set up"}),(0,jsx_runtime.jsx)(SyncMethodModal,{schema:schema})]})}},{title:"Enabled",key:"should_sync",render:function RenderShouldSync(_,schema){return(0,jsx_runtime.jsx)(src.f4,{disabledReason:null===schema.sync_type?"You must set up the sync method first":void 0,checked:schema.should_sync,onChange:active=>{updateSchema({...schema,should_sync:active})}})}},{title:"Synced Table",key:"table",render:function RenderTable(_,schema){if(schema.table){let query=(0,data_warehouse_utils.w)(schema.table.name,schema.table.columns);return(0,jsx_runtime.jsx)(src.rU,{to:urls.j.dataWarehouse(JSON.stringify(query)),children:(0,jsx_runtime.jsx)("code",{children:schema.table.name})})}return"Completed"===schema.status?(0,jsx_runtime.jsx)("div",{children:"No rows to query"}):(0,jsx_runtime.jsx)("div",{children:"Not yet synced"})}},{title:"Last Synced At",key:"last_synced_at",render:function Render(_,schema){return schema.last_synced_at?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(TZLabel.w,{time:schema.last_synced_at,formatDate:"MMM DD, YYYY",formatTime:"HH:mm"})}):null}},{title:"Rows Synced",key:"rows_synced",render:function Render(_,schema){return schema.table?schema.table.row_count.toLocaleString():"Completed"===schema.status?0:""}},{title:"Status",key:"status",render:(_,schema)=>{if(!schema.status)return null;let isSuspended="Error"===schema.status&&!schema.should_sync,tagContent=(0,jsx_runtime.jsx)(src.oe,{type:StatusTagSetting[isSuspended?"Suspended":schema.status]||"default",children:isSuspended?"Suspended":schema.status});return schema.latest_error&&"Error"===schema.status?(0,jsx_runtime.jsx)(src.u,{title:schema.latest_error,children:tagContent}):tagContent}},{key:"actions",width:0,render:function RenderActions(_,schema){return schemaReloadingById[schema.id]?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(src.$j,{})}):(0,jsx_runtime.jsx)("div",{className:"flex flex-row justify-end",children:(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{type:"tertiary",onClick:()=>{reloadSchema(schema)},children:"Reload"},`reload-data-warehouse-schema-${schema.id}`),schema.incremental&&(0,jsx_runtime.jsx)(src.u,{title:"Completely resync incrementally loaded data. Only recommended if there is an issue with data quality in previously imported data",children:(0,jsx_runtime.jsx)(src.Jp,{type:"tertiary",onClick:()=>{resyncSchema(schema)},status:"danger",children:"Resync"},`resync-data-warehouse-schema-${schema.id}`)})]})})})})}}]})})},SyncMethodModal=_ref3=>{var _currentSyncMethodMod,_currentSyncMethodMod2;let{schema}=_ref3,{syncMethodModalIsOpen,currentSyncMethodModalSchema,schemaIncrementalFields,schemaIncrementalFieldsLoading,saveButtonIsLoading}=(0,index_esm.useValues)(dataWarehouseSourcesTableSyncMethodModalLogic({schema})),{closeSyncMethodModal,loadSchemaIncrementalFields,resetSchemaIncrementalFields,updateSchema}=(0,index_esm.useActions)(dataWarehouseSourcesTableSyncMethodModalLogic({schema}));(0,react.useEffect)(()=>{currentSyncMethodModalSchema?.id&&(resetSchemaIncrementalFields(),loadSchemaIncrementalFields(currentSyncMethodModalSchema.id))},[currentSyncMethodModalSchema?.id]);let schemaLoading=schemaIncrementalFieldsLoading||!schemaIncrementalFields,showForm=!schemaLoading&&schemaIncrementalFields;return currentSyncMethodModalSchema?(0,jsx_runtime.jsxs)(src.fQ,{title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Sync method for ",(0,jsx_runtime.jsx)("span",{className:"font-mono",children:currentSyncMethodModalSchema.name})]}),isOpen:syncMethodModalIsOpen,onClose:closeSyncMethodModal,footer:schemaLoading&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.yW.Button,{}),(0,jsx_runtime.jsx)(src.yW.Button,{})]}),children:[schemaLoading&&(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)(src.yW,{className:"w-1/2 h-4"}),(0,jsx_runtime.jsx)(src.yW.Row,{repeat:3})]}),showForm&&(0,jsx_runtime.jsx)(SyncMethodForm.m,{showRefreshMessageOnChange:null!==currentSyncMethodModalSchema.sync_type,saveButtonIsLoading:saveButtonIsLoading,schema:{table:currentSyncMethodModalSchema.name,should_sync:currentSyncMethodModalSchema.should_sync,sync_type:currentSyncMethodModalSchema.sync_type,incremental_field:null!==(_currentSyncMethodMod=currentSyncMethodModalSchema.incremental_field)&&void 0!==_currentSyncMethodMod?_currentSyncMethodMod:null,incremental_field_type:null!==(_currentSyncMethodMod2=currentSyncMethodModalSchema.incremental_field_type)&&void 0!==_currentSyncMethodMod2?_currentSyncMethodMod2:null,incremental_available:!!schemaIncrementalFields.length,incremental_fields:schemaIncrementalFields},onClose:()=>{resetSchemaIncrementalFields(),closeSyncMethodModal()},onSave:(syncType,incrementalField,incrementalFieldType)=>{"full_refresh"===syncType?updateSchema({...currentSyncMethodModalSchema,should_sync:!0,sync_type:syncType,incremental_field:null,incremental_field_type:null}):updateSchema({...currentSyncMethodModalSchema,should_sync:!0,sync_type:syncType,incremental_field:incrementalField,incremental_field_type:incrementalFieldType})}})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})};var SourceForm=__webpack_require__("../../frontend/src/scenes/data-warehouse/external/forms/SourceForm.tsx");let SourceConfiguration=_ref=>{let{id}=_ref,{sourceFieldConfig}=(0,index_esm.useValues)(dataWarehouseSourceSettingsLogic({id}));return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:dataWarehouseSourceSettingsLogic,props:{id},children:sourceFieldConfig?(0,jsx_runtime.jsx)(UpdateSourceConnectionFormContainer,{id:id,sourceConfig:sourceFieldConfig,showPrefix:!1}):(0,jsx_runtime.jsx)(src.yW,{})})};function UpdateSourceConnectionFormContainer(props){let{source,sourceLoading}=(0,index_esm.useValues)(dataWarehouseSourceSettingsLogic({id:props.id})),{setSourceConfigValue}=(0,index_esm.useActions)(dataWarehouseSourceSettingsLogic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("span",{className:"block mb-2",children:"Overwrite your existing configuration here"}),(0,jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:dataWarehouseSourceSettingsLogic,formKey:"sourceConfig",enableFormOnSubmit:!0,children:[(0,jsx_runtime.jsx)(SourceForm.S,{...props,jobInputs:source?.job_inputs,setSourceConfigValue:setSourceConfigValue}),(0,jsx_runtime.jsx)("div",{className:"mt-4 flex flex-row justify-end gap-2",children:(0,jsx_runtime.jsx)(src.Jp,{loading:sourceLoading&&!source,type:"primary",center:!0,htmlType:"submit","data-attr":"source-update",children:"Save"})})]})]})}var types=__webpack_require__("../../frontend/src/types.ts"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),pipeline_utils=__webpack_require__("../../frontend/src/scenes/pipeline/utils.tsx"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts");let LOG_LEVELS=["LOG","INFO","WARNING","ERROR"],STAFF_LOG_LEVELS=["DEBUG","LOG","INFO","WARNING","ERROR"],schemaLogLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","data-warehouse","settings","source","schemaLogLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{job}=_ref;return job.id}),(0,index_esm.connect)({values:[userLogic.userLogic,["user"]]}),(0,index_esm.actions)({clearBackgroundLogs:!0,setSearchTerm:searchTerm=>({searchTerm}),setSchema:schemaId=>({schemaId}),markLogsEnd:!0}),(0,lib.loaders)(_ref2=>{let{values,actions,cache,props}=_ref2;return{logs:{__default:[],loadSchemaLogs:async()=>{let response=await api.ZP.externalDataSchemas.logs(props.job.schema.id,{level:values.levelFilters.join(","),search:values.searchTerm,instance_id:props.job.workflow_run_id});return cache.pollingInterval||(cache.pollingInterval=setInterval(actions.loadSchemaLogsBackgroundPoll,2e3)),response.results},loadSchemaLogsMore:async()=>{if(!values.selectedSchemaId)return[];let response=await api.ZP.externalDataSchemas.logs(values.selectedSchemaId,{level:values.levelFilters.join(","),search:values.searchTerm,instance_id:props.job.workflow_run_id,before:values.leadingEntry?.timestamp});return response.results.length<constants.F2&&actions.markLogsEnd(),[...values.logs,...response.results]},revealBackground:()=>{let newArray=[...values.logsBackground,...values.logs];return actions.clearBackgroundLogs(),newArray}},logsBackground:{__default:[],loadSchemaLogsBackgroundPoll:async()=>[...(await api.ZP.externalDataSchemas.logs(props.job.schema.id,{level:values.levelFilters.join(","),search:values.searchTerm,instance_id:props.job.workflow_run_id,after:values.leadingEntry?.timestamp})).results,...values.logsBackground]}}}),(0,index_esm.reducers)({searchTerm:["",{setSearchTerm:(_,_ref3)=>{let{searchTerm}=_ref3;return searchTerm}}],selectedSchemaId:[null,{setSchema:(_,_ref4)=>{let{schemaId}=_ref4;return schemaId}}],isThereMoreToLoad:[!0,{loadSchemaLogsSuccess:(_,_ref5)=>{let{logs}=_ref5;return logs.length>=constants.F2},markLogsEnd:()=>!1}]}),(0,index_esm.selectors)({leadingEntry:[s=>[s.logs,s.logsBackground],(logs,logsBackground)=>logsBackground.length?logsBackground[0]:logs.length?logs[0]:null],levelFilters:[s=>[s.user],user=>user&&user.is_staff?STAFF_LOG_LEVELS:LOG_LEVELS]}),(0,index_esm.listeners)(_ref6=>{let{actions}=_ref6;return{setSearchTerm:async(_ref7,breakpoint)=>{let{searchTerm}=_ref7;searchTerm&&await breakpoint(1e3),actions.loadSchemaLogs()},setSchema:()=>{actions.loadSchemaLogs()}}}),(0,index_esm.events)(_ref8=>{let{actions,cache}=_ref8;return{afterMount:()=>{actions.loadSchemaLogs()},beforeUnmount:()=>{clearInterval(cache.pollingInterval)}}})]),columns=[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",width:1,render:(_,entry)=>(0,dayjs.Bv)(entry.timestamp).format("YYYY-MM-DD HH:mm:ss.SSS UTC")},{title:"Level",key:"level",dataIndex:"level",width:1,render:(_,entry)=>(0,pipeline_utils.bH)(entry.level)},{title:"Run ID",key:"run_id",dataIndex:"instance_id",width:1,render:(_,entry)=>entry.instance_id},{title:"Message",key:"message",dataIndex:"message",width:6}],LogsView=_ref=>{let{job}=_ref,logic=schemaLogLogic({job}),{logs,logsLoading,logsBackground,isThereMoreToLoad}=(0,index_esm.useValues)(logic),{revealBackground,loadSchemaLogsMore}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"ph-no-capture deprecated-space-y-2 flex-1",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:revealBackground,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:logsBackground.length?void 0:"There's nothing to load",children:logsBackground.length?`Load ${(0,utils.Zi)(logsBackground.length,"newer entry","newer entries")}`:"No new entries"}),(0,jsx_runtime.jsx)(src.g3,{dataSource:logs,columns:columns,loading:logsLoading,className:"ph-no-capture",pagination:{pageSize:200,hideOnSinglePage:!0}}),!!logs.length&&(0,jsx_runtime.jsx)(src.Jp,{onClick:loadSchemaLogsMore,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:isThereMoreToLoad?void 0:"There's nothing more to load",children:isThereMoreToLoad?`Load up to ${constants.F2} older entries`:"No older entries"})]})},Syncs_StatusTagSetting={Running:"primary",Completed:"success",Failed:"danger","Billing limits":"danger"},Syncs=_ref=>{let{id}=_ref,{jobs,jobsLoading,canLoadMoreJobs}=(0,index_esm.useValues)(dataWarehouseSourceSettingsLogic({id})),{loadMoreJobs}=(0,index_esm.useActions)(dataWarehouseSourceSettingsLogic({id}));return(0,jsx_runtime.jsx)(src.g3,{hideScrollbar:!0,dataSource:jobs,loading:jobsLoading,disableTableWhileLoading:!1,columns:[{title:"Schema",render:(_,job)=>job.schema.name},{title:"Status",render:(_,job)=>{let tagContent=(0,jsx_runtime.jsx)(src.oe,{type:Syncs_StatusTagSetting[job.status]||"default",children:job.status});return job.latest_error&&job.status===types.mZ.Failed?(0,jsx_runtime.jsx)(src.u,{title:job.latest_error,children:tagContent}):tagContent}},{title:"Rows synced",render:(_,job)=>job.rows_synced.toLocaleString()},{title:"Synced at",render:(_,job)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:job.created_at,formatDate:"MMM DD, YYYY",formatTime:"HH:mm"})}],expandable:jobs.length>0?{expandedRowRender:job=>(0,jsx_runtime.jsx)("div",{className:"p-4",children:(0,jsx_runtime.jsx)(LogsView,{job:job})}),rowExpandable:()=>!0,noIndent:!0}:void 0,footer:(0,jsx_runtime.jsx)(src.Jp,{onClick:loadMoreJobs,type:"tertiary",fullWidth:!0,center:!0,disabledReason:canLoadMoreJobs?void 0:"There's nothing more to load",children:canLoadMoreJobs?"Load older jobs":"No older jobs"})})};var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.11.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),pipelineNodeLogic=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineNodeLogic.tsx"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),pipeline_types=__webpack_require__("../../frontend/src/scenes/pipeline/types.ts");let ALL_LOG_LEVELS=["DEBUG","LOG","INFO","WARNING","ERROR"],pipelineNodeLogsLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(key=>["scenes","pipeline","pipelineNodeLogsLogic",key]),(0,index_esm.connect)(props=>({values:[(0,teamLogic.teamLogic)(),["currentTeamId"],(0,pipelineNodeLogic.y)(props),["node"]]})),(0,index_esm.actions)({setSelectedLogLevels:levels=>({levels}),setSearchTerm:searchTerm=>({searchTerm}),setInstanceId:instanceId=>({instanceId}),clearBackgroundLogs:!0,markLogsEnd:!0}),(0,lib.loaders)(_ref2=>{let{values,actions,cache}=_ref2;return{logs:[[],{loadLogs:async()=>{var _values$instanceId;let results=[],logParams={search:values.searchTerm,level:values.selectedLogLevelsForAPI.join(","),limit:constants.F2,instance_id:null!==(_values$instanceId=values.instanceId)&&void 0!==_values$instanceId?_values$instanceId:void 0};if(values.node.backend===pipeline_types.b.BatchExport)results=(await api.ZP.batchExports.logs(values.node.id,logParams)).results;else if(values.node.backend===pipeline_types.b.HogFunction)results=(await api.ZP.hogFunctions.logs(values.node.id,logParams)).results;else{if(values.node.backend===pipeline_types.b.ManagedSource)return[];results=await api.ZP.pluginConfigs.logs(Number(values.node.id),logParams)}return cache.pollingInterval||(cache.pollingInterval=setInterval(actions.pollBackgroundLogs,5e3)),actions.clearBackgroundLogs(),results},loadMoreLogs:async()=>{var _values$instanceId2;let results;let logParams={search:values.searchTerm,level:values.selectedLogLevels.join(","),limit:constants.F2,before:values.trailingEntry?.timestamp,instance_id:null!==(_values$instanceId2=values.instanceId)&&void 0!==_values$instanceId2?_values$instanceId2:void 0};if(values.node.backend===pipeline_types.b.BatchExport)results=(await api.ZP.batchExports.logs(values.node.id,logParams)).results;else if(values.node.backend===pipeline_types.b.HogFunction)results=(await api.ZP.hogFunctions.logs(values.node.id,logParams)).results;else{if(values.node.backend===pipeline_types.b.ManagedSource)return[];results=await api.ZP.pluginConfigs.logs(Number(values.node.id),logParams)}return results.length<constants.F2&&actions.markLogsEnd(),[...values.logs,...results]},revealBackground:()=>{let newArray=[...values.backgroundLogs,...values.logs];return actions.clearBackgroundLogs(),newArray}}],backgroundLogs:[[],{pollBackgroundLogs:async()=>{var _values$instanceId3;let results;if(values.logsLoading)return values.backgroundLogs;let logParams={search:values.searchTerm,level:values.selectedLogLevels.join(","),limit:constants.F2,after:values.leadingEntry?.timestamp,instance_id:null!==(_values$instanceId3=values.instanceId)&&void 0!==_values$instanceId3?_values$instanceId3:void 0};if(values.node.backend===pipeline_types.b.BatchExport)results=(await api.ZP.batchExports.logs(values.node.id,logParams)).results;else if(values.node.backend===pipeline_types.b.HogFunction)results=(await api.ZP.hogFunctions.logs(values.node.id,logParams)).results;else{if(values.node.backend===pipeline_types.b.ManagedSource)return[];results=await api.ZP.pluginConfigs.logs(Number(values.node.id),logParams)}return[...results,...values.backgroundLogs]}}]}}),(0,index_esm.reducers)({selectedLogLevels:[["LOG","INFO","WARNING","ERROR"],{setSelectedLogLevels:(_,_ref3)=>{let{levels}=_ref3;return levels}}],backgroundLogs:[[],{clearBackgroundLogs:()=>[]}],searchTerm:["",{setSearchTerm:(_,_ref4)=>{let{searchTerm}=_ref4;return searchTerm}}],instanceId:[null,{setInstanceId:(_,_ref5)=>{let{instanceId}=_ref5;return instanceId}}],isThereMoreToLoad:[!0,{loadLogsSuccess:(_,_ref6)=>{let{logs}=_ref6;return logs.length>=constants.F2},markLogsEnd:()=>!1}]}),(0,index_esm.selectors)(_ref7=>{let{actions,values}=_ref7;return{leadingEntry:[s=>[s.logs,s.backgroundLogs],(logs,backgroundLogs)=>backgroundLogs.length?backgroundLogs[0]:logs.length?logs[0]:null],trailingEntry:[s=>[s.logs,s.backgroundLogs],(logs,backgroundLogs)=>logs.length?logs[logs.length-1]:backgroundLogs.length?backgroundLogs[backgroundLogs.length-1]:null],columns:[s=>[s.node],node=>[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",sorter:(a,b)=>(0,dayjs.Bv)(a.timestamp).unix()-(0,dayjs.Bv)(b.timestamp).unix(),render:timestamp=>(0,jsx_runtime.jsx)(TZLabel.w,{time:timestamp}),width:0},{width:0,title:node.backend==pipeline_types.b.HogFunction?"Invocation":node.backend==pipeline_types.b.BatchExport?"Run Id":"Source",dataIndex:"instance_id",key:"instance_id",render:instanceId=>(0,jsx_runtime.jsx)("code",{className:"whitespace-nowrap",children:node.backend!==pipeline_types.b.Plugin?(0,jsx_runtime.jsx)(src.rU,{subtle:!0,onClick:()=>{values.instanceId===instanceId?actions.setInstanceId(null):actions.setInstanceId(instanceId)},children:instanceId}):instanceId})},{width:100,title:"Level",key:"level",dataIndex:"level",render:pipeline_utils.bH},{title:"Message",key:"message",dataIndex:"message",render:message=>(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}]],selectedLogLevelsForAPI:[s=>[s.selectedLogLevels],logLevels=>{let uniqueLevels=new Set(logLevels);return uniqueLevels.has("WARN")&&uniqueLevels.add("WARNING"),uniqueLevels.has("WARNING")&&uniqueLevels.add("WARN"),Array.from(uniqueLevels)}]}}),(0,index_esm.listeners)(_ref8=>{let{actions}=_ref8;return{setSelectedLogLevels:()=>{actions.loadLogs()},setSearchTerm:async(_ref9,breakpoint)=>{let{searchTerm}=_ref9;searchTerm&&await breakpoint(1e3),actions.loadLogs()},setInstanceId:async()=>{actions.loadLogs()}}}),(0,index_esm.events)(_ref10=>{let{actions,cache}=_ref10;return{afterMount:()=>{actions.loadLogs()},beforeUnmount:()=>{clearInterval(cache.pollingInterval)}}})]);function PipelineNodeLogs(_ref){let{id,stage}=_ref,logic=pipelineNodeLogsLogic({id,stage}),{logs,logsLoading,backgroundLogs,columns,isThereMoreToLoad,selectedLogLevels,instanceId}=(0,index_esm.useValues)(logic),{revealBackground,loadMoreLogs,setSelectedLogLevels,setSearchTerm,setInstanceId}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"ph-no-capture deprecated-space-y-2 flex-1",children:[(0,jsx_runtime.jsx)(src.DF,{type:"search",placeholder:"Search for messages containing…",fullWidth:!0,onChange:setSearchTerm,allowClear:!0,prefix:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconSearch,{}),instanceId&&(0,jsx_runtime.jsx)(src.LV,{onClose:()=>setInstanceId(null),children:instanceId})]})}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-4",children:[(0,jsx_runtime.jsx)("span",{className:"mr-1",children:"Show logs of level:"}),ALL_LOG_LEVELS.map(level=>(0,jsx_runtime.jsx)(src.Hw,{label:level,checked:selectedLogLevels.includes(level),onChange:checked=>{setSelectedLogLevels(checked?[...selectedLogLevels,level]:selectedLogLevels.filter(t=>t!=level))}},level))]}),(0,jsx_runtime.jsx)(src.Jp,{onClick:revealBackground,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:backgroundLogs.length?void 0:"There's nothing to load",children:backgroundLogs.length?`Load ${(0,utils.Zi)(backgroundLogs.length,"newer entry","newer entries")}`:"No new entries"}),(0,jsx_runtime.jsx)(src.g3,{dataSource:logs,columns:columns,loading:logsLoading,className:"ph-no-capture",rowKey:record=>`${record.log_source_id}:${record.instance_id}:${record.timestamp}`,pagination:{pageSize:200,hideOnSinglePage:!0}}),!!logs.length&&(0,jsx_runtime.jsx)(src.Jp,{onClick:loadMoreLogs,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:isThereMoreToLoad?void 0:"There's nothing more to load",children:isThereMoreToLoad?`Load up to ${constants.F2} older entries`:"No older entries"})]})}var kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),DataWarehouseTableForm=__webpack_require__("../../frontend/src/scenes/data-warehouse/new/DataWarehouseTableForm.tsx"),dataWarehouseTableLogic=__webpack_require__("../../frontend/src/scenes/data-warehouse/new/dataWarehouseTableLogic.tsx");let SelfManaged=_ref=>{let{id}=_ref,{table}=(0,index_esm.useValues)((0,dataWarehouseTableLogic.U)({id})),{updateTable,editingTable}=(0,index_esm.useActions)((0,dataWarehouseTableLogic.U)({id}));return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:dataWarehouseTableLogic.U,props:{id},children:(0,jsx_runtime.jsx)(SelfManagedTable,{table:table,updateTable:updateTable,editingTable:editingTable})})};function SelfManagedTable(_ref2){let{table,updateTable,editingTable}=_ref2;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:()=>{editingTable(!1),kea_router_lib.router.actions.push(urls.j.pipeline())},children:"Cancel"})}),(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-4",children:(0,jsx_runtime.jsx)(DataWarehouseTableForm.V,{onUpdate:()=>updateTable({name:table.name,url_pattern:table.url_pattern,format:table.format,...table.credential?.access_key||table.credential?.access_secret?{credential:{...table.credential.access_key?{access_key:table.credential.access_key}:{},...table.credential.access_secret?{access_secret:table.credential.access_secret}:{}}}:{}})})})]})}var clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),LemonProgress=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonProgress/index.tsx"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonCalendarSelect=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonCalendar/LemonCalendarSelect.tsx"),LemonCheckbox=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonCheckbox/index.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonInput=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonInput/index.ts"),LemonModal=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonModal/index.ts"),pipelineBatchExportConfigurationLogic=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineBatchExportConfigurationLogic.tsx");let batchExportBackfillModalLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(key=>["scenes","pipeline","batchExportBackfillModalLogic",key]),(0,index_esm.connect)(props=>({values:[(0,pipelineBatchExportConfigurationLogic.t)({id:props.id,service:null}),["batchExportConfig"]]})),(0,index_esm.actions)({openBackfillModal:!0,closeBackfillModal:!0,setEarliestBackfill:!0,unsetEarliestBackfill:!0}),(0,index_esm.reducers)({isBackfillModalOpen:[!1,{openBackfillModal:()=>!0,closeBackfillModal:()=>!1}],isEarliestBackfill:[!1,{setEarliestBackfill:()=>!0,unsetEarliestBackfill:()=>!1}]}),(0,kea_forms_lib.forms)(_ref2=>{let{props,actions,values}=_ref2;return{backfillForm:{defaults:{start_at:void 0,end_at:(0,dayjs.Bv)().tz(teamLogic.teamLogic.values.timezone).hour(0).minute(0).second(0).millisecond(0),earliest_backfill:!1},errors:_ref3=>{let{start_at,end_at,earliest_backfill}=_ref3;return{start_at:start_at?void 0:earliest_backfill?void 0:"Start date is required",end_at:end_at?void 0:"End date is required",earliest_backfill:void 0}},submit:async _ref4=>{var _start_at$toISOString,_end_at$toISOString;let{start_at,end_at,earliest_backfill}=_ref4;if(values.batchExportConfig&&values.batchExportConfig.interval.endsWith("minutes")&&(start_at?.minute()!==void 0&&start_at?.minute()%5!=0||end_at?.minute()!==void 0&&end_at?.minute()%5!=0)){src.UJ.error("Backfilling a 5 minute batch export requires bounds be multiple of five minutes");return}let upperBound=(0,dayjs.Bv)().tz(teamLogic.teamLogic.values.timezone),period="1 hour";if(values.batchExportConfig&&end_at&&("hour"==values.batchExportConfig.interval?upperBound=upperBound.add(1,"hour"):"day"==values.batchExportConfig.interval?(upperBound=(upperBound=upperBound.hour(0).minute(0).second(0)).add(1,"day"),period="1 day"):values.batchExportConfig.interval.endsWith("minutes")?(upperBound=upperBound.add(5,"minute"),period="5 minutes"):upperBound=upperBound.add(1,"hour"),end_at>upperBound)){src.UJ.error(`Requested backfill end date lies too far into the future. Use an end date that is no more than ${period} from now (in your project's timezone)`);return}await new Promise(resolve=>setTimeout(resolve,1e3)),await api.ZP.batchExports.createBackfill(props.id,{start_at:earliest_backfill?null:null!==(_start_at$toISOString=start_at?.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=end_at?.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null}).catch(e=>{if(e.detail){var _e$attr;actions.setBackfillFormManualErrors({[null!==(_e$attr=e.attr)&&void 0!==_e$attr?_e$attr:"start_at"]:e.detail})}else src.UJ.error("Unknown error occurred");throw e}),actions.closeBackfillModal()}}}})]);function BatchExportBackfillModal(_ref){let{id}=_ref,{timezone}=(0,index_esm.useValues)(teamLogic.teamLogic),logic=batchExportBackfillModalLogic({id}),{batchExportConfig,isBackfillModalOpen,isBackfillFormSubmitting,isEarliestBackfill}=(0,index_esm.useValues)(logic),{closeBackfillModal,setEarliestBackfill,unsetEarliestBackfill,setBackfillFormManualErrors}=(0,index_esm.useActions)(logic);return batchExportConfig?(0,jsx_runtime.jsxs)(LemonModal.f,{title:"Start backfill",onClose:closeBackfillModal,isOpen:isBackfillModalOpen,width:"30rem",footer:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary","data-attr":"batch-export-backfill-cancel",disabledReason:isBackfillFormSubmitting?"Please wait...":void 0,onClick:closeBackfillModal,children:"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{form:"batch-export-backfill-form",htmlType:"submit",type:"primary","data-attr":"batch-export-backfill-submit",loading:isBackfillFormSubmitting,onClick:()=>setBackfillFormManualErrors({}),children:"Schedule runs"})]}),children:[(0,jsx_runtime.jsxs)("p",{children:["Backfilling a batch export will sequentially run all batch periods that fall within the range specified below. The runs will export data in ",(0,jsx_runtime.jsx)("b",{children:batchExportConfig?.interval})," intervals, from the start date until the end date is reached."]}),(0,jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:batchExportBackfillModalLogic,props:{id:id},formKey:"backfillForm",id:"batch-export-backfill-form",enableFormOnSubmit:!0,className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"start_at",label:`Start Date (${timezone})`,className:"flex-1",children:_ref2=>{let{value,onChange}=_ref2;return isEarliestBackfill?(0,jsx_runtime.jsx)(LemonInput.D,{value:"Beginning of time",disabled:!0}):(0,jsx_runtime.jsx)(LemonCalendarSelect.he,{value:value&&batchExportConfig?"day"===batchExportConfig.interval?value.hour(0).minute(0).second(0):value.tz(timezone):value,onChange:date=>{if(date){let projectDate=date.tz(timezone,!0);batchExportConfig&&"day"===batchExportConfig.interval&&(projectDate=projectDate.hour(0).minute(0).second(0)),onChange(projectDate)}else onChange(date)},placeholder:"Select start date",granularity:batchExportConfig?"hour"===batchExportConfig.interval?"hour":batchExportConfig.interval.endsWith("minutes")?"minute":"day":"day"})}}),batchExportConfig?.model=="persons"||batchExportConfig?.model=="sessions"?(0,jsx_runtime.jsx)(LemonField.D,{name:"earliest_backfill",children:_ref3=>{let{onChange}=_ref3;return(0,jsx_runtime.jsx)(LemonCheckbox.H,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Backfill since beginning of time",(0,jsx_runtime.jsx)(src.u,{title:"If selected, we will backfill all data since the beginning of time until the end date set below. There is no need to set a start date for the backfill.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:" text-lg text-secondary"})})]}),onChange:checked=>{onChange(checked),checked?setEarliestBackfill():unsetEarliestBackfill()}})}}):null,(0,jsx_runtime.jsx)(LemonField.D,{name:"end_at",label:`End Date (${timezone})`,className:"flex-1",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsx)(LemonCalendarSelect.he,{value:value&&batchExportConfig?"day"===batchExportConfig.interval?value.hour(0).minute(0).second(0):value.tz(timezone):value,onChange:date=>{if(date){let projectDate=date.tz(timezone,!0);batchExportConfig&&"day"===batchExportConfig.interval&&(projectDate=projectDate.hour(0).minute(0).second(0)),onChange(projectDate)}else onChange(date)},placeholder:"Select end date",granularity:batchExportConfig?"hour"===batchExportConfig.interval?"hour":batchExportConfig.interval.endsWith("minutes")?"minute":"day":"day"})}})]})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}var LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/index.ts");let batchExportBackfillsLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(key=>["scenes","pipeline","batchExportBackfillsLogic",key]),(0,index_esm.connect)(props=>({values:[(0,teamLogic.teamLogic)(),["currentTeamId"],(0,pipelineBatchExportConfigurationLogic.t)({id:props.id,service:null}),["batchExportConfig"]],actions:[batchExportBackfillModalLogic(props),["submitBackfillFormSuccess","openBackfillModal"]]})),(0,index_esm.actions)({loadBackfills:!0,cancelBackfill:backfill=>({backfill})}),(0,lib.loaders)(_ref2=>{let{props,values}=_ref2;return{backfillsPaginatedResponse:[null,{loadBackfills:async()=>{try{return await api.ZP.batchExports.listBackfills(props.id,{ordering:"-created_at"})}catch(e){throw LemonToast.U.error("Unknown error occurred when fetching backfills"),e}},loadOlderBackfills:async()=>{let nextUrl=values.backfillsPaginatedResponse?.next;if(!nextUrl)return values.backfillsPaginatedResponse;try{var _values$backfillsPagi;let res=await api.ZP.get(nextUrl);return res.results=[...null!==(_values$backfillsPagi=values.backfillsPaginatedResponse?.results)&&void 0!==_values$backfillsPagi?_values$backfillsPagi:[],...res.results],res}catch(e){throw LemonToast.U.error("Unknown error occurred when fetching backfills"),e}}}]}}),(0,index_esm.selectors)({hasMoreBackfillsToLoad:[s=>[s.backfillsPaginatedResponse],backfillsPaginatedResponse=>!!backfillsPaginatedResponse?.next],loading:[s=>[s.backfillsPaginatedResponseLoading],backfillsPaginatedResponseLoading=>backfillsPaginatedResponseLoading],latestBackfills:[s=>[s.backfillsPaginatedResponse],backfillsPaginatedResponse=>{var _backfillsPaginatedRe;return(null!==(_backfillsPaginatedRe=backfillsPaginatedResponse?.results)&&void 0!==_backfillsPaginatedRe?_backfillsPaginatedRe:[]).map(backfill=>{let parseDateSafely=date=>{if(!date)return;let parsed=(0,dayjs.Bv)(date);return parsed.isValid()?parsed:void 0};return{...backfill,created_at:parseDateSafely(backfill.created_at),finished_at:parseDateSafely(backfill.finished_at),start_at:parseDateSafely(backfill.start_at),end_at:parseDateSafely(backfill.end_at),last_updated_at:parseDateSafely(backfill.last_updated_at)}})}]}),(0,index_esm.listeners)(_ref3=>{let{actions,props}=_ref3;return{cancelBackfill:async _ref4=>{let{backfill}=_ref4;try{await api.ZP.batchExports.cancelBackfill(props.id,backfill.id),LemonToast.U.success("Backfill has been cancelled."),actions.loadBackfills()}catch(error){LemonToast.U.error("Failed to cancel backfill. Please try again.")}}}}),(0,index_esm.afterMount)(_ref5=>{let{actions}=_ref5;actions.loadBackfills()})]);var pipelineAccessLogic=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineAccessLogic.tsx");function BatchExportBackfills(_ref){let{id}=_ref,logic=batchExportBackfillsLogic({id}),{openBackfillModal}=(0,index_esm.useActions)(logic),{batchExportConfig}=(0,index_esm.useValues)(logic);return batchExportConfig?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Start backfill"})}),(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)(BatchExportBackfillsControls,{id:id}),(0,jsx_runtime.jsx)(BatchExportLatestBackfills,{id:id})]}),(0,jsx_runtime.jsx)(BatchExportBackfillModal,{id:id})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BatchExportBackfillsControls(_ref2){let{id}=_ref2,logic=batchExportBackfillsLogic({id}),{loading}=(0,index_esm.useValues)(logic),{loadBackfills}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsx)("div",{className:"flex items-center gap-2",children:(0,jsx_runtime.jsx)(src.Jp,{onClick:loadBackfills,loading:loading,type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),size:"small",children:"Refresh"})})}function BatchExportLatestBackfills(_ref3){let{id}=_ref3,logic=batchExportBackfillsLogic({id}),{latestBackfills,loading,hasMoreBackfillsToLoad,batchExportConfig}=(0,index_esm.useValues)(logic),{cancelBackfill,loadOlderBackfills,openBackfillModal}=(0,index_esm.useActions)(logic),{canEnableNewDestinations}=(0,index_esm.useValues)(pipelineAccessLogic.g);return batchExportConfig?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.g3,{dataSource:latestBackfills,loading:loading,loadingSkeletonRows:5,footer:hasMoreBackfillsToLoad&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(src.Jp,{center:!0,fullWidth:!0,onClick:loadOlderBackfills,loading:loading,children:"Load more rows"})}),columns:[{title:"Status",key:"status",width:0,render:(_,backfill)=>{let status=backfill.status,color=colorForStatus(status);return(0,jsx_runtime.jsx)("span",{className:(0,clsx_m.default)("h-6 p-2 border-2 flex items-center justify-center rounded-full font-semibold text-xs select-none",{success:"border-success text-success-dark","accent-primary":"border-accent-primary text-primary-dark",warning:"border-warning text-warning-dark",danger:"border-danger text-danger-dark",default:"border-default text-default-dark"}[color]),children:(0,jsx_runtime.jsx)("span",{className:"text-center",children:status})})}},{title:"Progress",key:"progress",render:(_,backfill)=>{let color=colorForStatus(backfill.status),progress=backfill.progress;if(progress&&null!==progress.progress&&void 0!==progress.progress){let label="";if(null!==progress.finished_runs&&void 0!==progress.finished_runs&&progress.total_runs){let runsLabel=1===progress.total_runs?"run":"runs";label=`(${progress.finished_runs}/${progress.total_runs} ${runsLabel})`}return(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(LemonProgress.b,{percent:100*progress.progress,strokeColor:`var(--${color})`,className:"min-w-[80px]"}),(0,jsx_runtime.jsx)("span",{className:"whitespace-nowrap flex-shrink-0",children:label})]})}return""}},{title:"ID",key:"runId",render:(_,backfill)=>backfill.id},{title:"Interval start",key:"intervalStart",tooltip:"Start of the time range to backfill",render:(_,backfill)=>backfill.start_at?(0,jsx_runtime.jsx)(TZLabel.w,{time:backfill.start_at,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"}):"Beginning of time"},{title:"Interval end",key:"intervalEnd",tooltip:"End of the time range to backfill",render:(_,backfill)=>backfill.end_at?(0,jsx_runtime.jsx)(TZLabel.w,{time:backfill.end_at,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"}):"Until present"},{title:"Started",key:"started",tooltip:"Date and time when this BatchExport backfill started",render:(_,backfill)=>backfill.created_at?(0,jsx_runtime.jsx)(TZLabel.w,{time:backfill.created_at}):""},{title:"Finished",key:"finished",tooltip:"Date and time when this BatchExport backfill finished",render:(_,backfill)=>backfill.finished_at?(0,jsx_runtime.jsx)(TZLabel.w,{time:backfill.finished_at}):""},{key:"actions",width:0,render:function RenderActions(_,backfill){if(canEnableNewDestinations&&backfillIsCancelable(backfill.status))return(0,jsx_runtime.jsx)("div",{className:"flex gap-1",children:(0,jsx_runtime.jsx)(BackfillCancelButton,{backfill:backfill,cancelBackfill:cancelBackfill})})}}],emptyState:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"No backfills in this time range."}),canEnableNewDestinations&&(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Start backfill"})]})})}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BackfillCancelButton(_ref4){let{backfill,cancelBackfill}=_ref4;return(0,jsx_runtime.jsx)("span",{className:"flex items-center gap-1",children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(icons.uR,{}),tooltip:"Cancel backfill",onClick:()=>src.dn.open({title:"Cancel backfill?",description:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("p",{children:"This will cancel the selected backfill."})}),width:"20rem",primaryButton:{children:"Cancel backfill",onClick:()=>cancelBackfill(backfill)},secondaryButton:{children:"Go back"}})})})}let colorForStatus=status=>{switch(status){case"Completed":return"success";case"ContinuedAsNew":case"Running":case"Starting":return"accent-primary";case"Cancelled":case"Terminated":case"TimedOut":return"warning";case"Failed":case"FailedRetryable":return"danger";default:return"default"}},backfillIsCancelable=status=>"Running"===status||"Starting"===status;var DateFilter=__webpack_require__("../../frontend/src/lib/components/DateFilter/DateFilter.tsx");let batchExportRunsLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.path)(key=>["scenes","pipeline","batchExportRunsLogic",key]),(0,index_esm.connect)(props=>({values:[(0,pipelineBatchExportConfigurationLogic.t)({id:props.id,service:null}),["batchExportConfig"]],actions:[batchExportBackfillModalLogic(props),["submitBackfillFormSuccess","openBackfillModal"]]})),(0,index_esm.actions)({setDateRange:(from,to)=>({from,to}),switchLatestRuns:enabled=>({enabled}),loadRuns:!0,retryRun:run=>({run}),cancelRun:run=>({run})}),(0,lib.loaders)(_ref2=>{let{props,values}=_ref2;return{runsPaginatedResponse:[null,{loadRuns:async()=>values.usingLatestRuns?await api.ZP.batchExports.listRuns(props.id,{}):await api.ZP.batchExports.listRuns(props.id,{start:values.dateRange.from,end:values.dateRange.to,ordering:"-data_interval_start"}),loadOlderRuns:async()=>{var _values$runsPaginated;let nextUrl=values.runsPaginatedResponse?.next;if(!nextUrl)return values.runsPaginatedResponse;let res=await api.ZP.get(nextUrl);return res.results=[...null!==(_values$runsPaginated=values.runsPaginatedResponse?.results)&&void 0!==_values$runsPaginated?_values$runsPaginated:[],...res.results],res}}]}}),(0,index_esm.reducers)({dateRange:[{from:"-2d",to:null},{setDateRange:(_,_ref3)=>{let{from,to}=_ref3;return{from:null!=from?from:"-2d",to:to}}}],usingLatestRuns:[!0,{switchLatestRuns:(_,_ref4)=>{let{enabled}=_ref4;return enabled}}]}),(0,index_esm.selectors)({hasMoreRunsToLoad:[s=>[s.runsPaginatedResponse],runsPaginatedResponse=>!!runsPaginatedResponse?.next],loading:[s=>[s.runsPaginatedResponseLoading],runsPaginatedResponseLoading=>runsPaginatedResponseLoading],latestRuns:[s=>[s.runsPaginatedResponse],runsPaginatedResponse=>{var _runsPaginatedRespons;return(null!==(_runsPaginatedRespons=runsPaginatedResponse?.results)&&void 0!==_runsPaginatedRespons?_runsPaginatedRespons:[]).map(run=>({...run,created_at:(0,dayjs.Bv)(run.created_at),data_interval_start:run.data_interval_start?(0,dayjs.Bv)(run.data_interval_start):void 0,data_interval_end:(0,dayjs.Bv)(run.data_interval_end),last_updated_at:run.last_updated_at?(0,dayjs.Bv)(run.last_updated_at):void 0}))}],groupedRuns:[s=>[s.runsPaginatedResponse,s.usingLatestRuns],(runsPaginatedResponse,usingLatestRuns)=>{var _runsPaginatedRespons2;if(usingLatestRuns)return[];let runs=null!==(_runsPaginatedRespons2=runsPaginatedResponse?.results)&&void 0!==_runsPaginatedRespons2?_runsPaginatedRespons2:[],groupedRuns={};return runs.forEach(run=>{if(!run.data_interval_start)return;let key=`${run.data_interval_start}-${run.data_interval_end}`;groupedRuns[key]||(groupedRuns[key]={data_interval_start:(0,dayjs.Bv)(run.data_interval_start),data_interval_end:(0,dayjs.Bv)(run.data_interval_end),runs:[],last_run_at:(0,dayjs.Bv)(run.created_at)}),groupedRuns[key].runs.push({...run,created_at:(0,dayjs.Bv)(run.created_at),data_interval_start:run.data_interval_start?(0,dayjs.Bv)(run.data_interval_start):void 0,data_interval_end:(0,dayjs.Bv)(run.data_interval_end),last_updated_at:run.last_updated_at?(0,dayjs.Bv)(run.last_updated_at):void 0}),groupedRuns[key].runs.sort((a,b)=>b.created_at.diff(a.created_at)),groupedRuns[key].last_run_at=groupedRuns[key].runs[0].created_at}),Object.values(groupedRuns)}]}),(0,index_esm.listeners)(_ref5=>{let{actions,props}=_ref5;return{setDateRange:()=>{actions.loadRuns()},switchLatestRuns:()=>{actions.loadRuns()},retryRun:async _ref6=>{let{run}=_ref6;await api.ZP.batchExports.retryRun(props.id,run.id),src.UJ.success("Retry has been scheduled.")},cancelRun:async _ref7=>{let{run}=_ref7;await api.ZP.batchExports.cancelRun(props.id,run.id),src.UJ.success("Run has been cancelled.")},submitBackfillFormSuccess:()=>{actions.loadRuns()}}}),(0,index_esm.afterMount)(_ref8=>{let{actions}=_ref8;actions.loadRuns()})]);function BatchExportRuns(_ref){let{id}=_ref,logic=batchExportRunsLogic({id}),{batchExportConfig,groupedRuns,loading,hasMoreRunsToLoad,usingLatestRuns}=(0,index_esm.useValues)(logic),{loadOlderRuns,retryRun}=(0,index_esm.useActions)(logic);return batchExportConfig?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)(BatchExportRunsFilters,{id:id}),usingLatestRuns?(0,jsx_runtime.jsx)(BatchExportLatestRuns,{id:id}):(0,jsx_runtime.jsx)(BatchExportRunsGrouped,{id:id,groupedRuns:groupedRuns,loading:loading,retryRun:retryRun,hasMoreRunsToLoad:hasMoreRunsToLoad,loadOlderRuns:loadOlderRuns,interval:batchExportConfig.interval})]}),(0,jsx_runtime.jsx)(BatchExportBackfillModal,{id:id})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BatchExportRunsFilters(_ref2){let{id}=_ref2,logic=batchExportRunsLogic({id}),{dateRange,usingLatestRuns,loading}=(0,index_esm.useValues)(logic),{setDateRange,switchLatestRuns,loadRuns}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:loadRuns,loading:loading,type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),size:"small",children:"Refresh"}),(0,jsx_runtime.jsx)(src.f4,{bordered:!0,label:"Show latest runs",checked:usingLatestRuns,onChange:switchLatestRuns,size:"small"}),(0,jsx_runtime.jsx)(DateFilter.f,{dateTo:dateRange.to,dateFrom:dateRange.from,disabledReason:usingLatestRuns?'Turn off "Show latest runs" to filter by data interval':void 0,onChange:(from,to)=>setDateRange(from,to),allowedRollingDateOptions:["hours","days","weeks","months","years"],makeLabel:key=>(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalendar,{})," ",key]})})]})}function BatchExportLatestRuns(_ref3){let{id}=_ref3,logic=batchExportRunsLogic({id}),{batchExportConfig,latestRuns,loading,hasMoreRunsToLoad}=(0,index_esm.useValues)(logic),{openBackfillModal,loadOlderRuns,retryRun,cancelRun}=(0,index_esm.useActions)(logic),{canEnableNewDestinations}=(0,index_esm.useValues)(pipelineAccessLogic.g);return batchExportConfig?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.g3,{dataSource:latestRuns,loading:loading,loadingSkeletonRows:5,footer:hasMoreRunsToLoad&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(src.Jp,{center:!0,fullWidth:!0,onClick:loadOlderRuns,loading:loading,children:"Load more rows"})}),columns:[{title:"Status",key:"status",width:0,render:(_,run)=>(0,jsx_runtime.jsx)(BatchExportRunIcon,{runs:[run],showLabel:!0})},{title:"ID",key:"runId",render:(_,run)=>run.id},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(_,run)=>run.data_interval_start?(0,jsx_runtime.jsx)(TZLabel.w,{time:run.data_interval_start,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"}):"Beginning of time"},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:run.data_interval_end,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"})},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,run)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:run.created_at})},{key:"actions",width:0,render:function RenderActions(_,run){if(canEnableNewDestinations)return(0,jsx_runtime.jsxs)("div",{className:"flex gap-1",children:[(0,jsx_runtime.jsx)(RunRetryButton,{run:run,retryRun:retryRun}),(0,jsx_runtime.jsx)(RunCancelButton,{run:run,cancelRun:cancelRun})]})}}],emptyState:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{children:["No runs in this time range. Your exporter runs every ",(0,jsx_runtime.jsx)("b",{children:batchExportConfig.interval}),"."]}),canEnableNewDestinations&&(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Start backfill"})]})})}):(0,jsx_runtime.jsx)(NotFound.T,{object:"batch export"})}function BatchExportRunsGrouped(_ref4){let{id,groupedRuns,loading,retryRun,hasMoreRunsToLoad,loadOlderRuns,interval}=_ref4,logic=batchExportRunsLogic({id}),{canEnableNewDestinations}=(0,index_esm.useValues)(pipelineAccessLogic.g),{openBackfillModal}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.g3,{dataSource:groupedRuns,loading:loading,loadingSkeletonRows:5,footer:hasMoreRunsToLoad&&(0,jsx_runtime.jsx)("div",{className:"flex items-center m-2",children:(0,jsx_runtime.jsx)(src.Jp,{center:!0,fullWidth:!0,onClick:loadOlderRuns,loading:loading,children:"Load more rows"})}),expandable:{noIndent:!0,expandedRowRender:groupedRuns=>(0,jsx_runtime.jsx)(src.g3,{dataSource:groupedRuns.runs,embedded:!0,columns:[{title:"Status",key:"status",width:0,render:(_,run)=>(0,jsx_runtime.jsx)(BatchExportRunIcon,{runs:[run],showLabel:!0})},{title:"ID",key:"runId",render:(_,run)=>run.id},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,run)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:run.created_at})}]})},columns:[{key:"icon",width:0,render:(_,groupedRun)=>(0,jsx_runtime.jsx)(BatchExportRunIcon,{runs:groupedRun.runs})},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(_,run)=>run.data_interval_start?(0,jsx_runtime.jsx)(TZLabel.w,{time:run.data_interval_start,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"}):"Beginning of time"},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(_,run)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:run.data_interval_end,formatDate:"MMMM DD, YYYY",formatTime:"HH:mm:ss"})},{title:"Latest run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(_,groupedRun)=>(0,jsx_runtime.jsx)(TZLabel.w,{time:groupedRun.last_run_at})},{key:"actions",width:0,render:function RenderActions(_,groupedRun){if(!(0,pipeline_utils.WT)(groupedRun.runs[0])&&canEnableNewDestinations)return(0,jsx_runtime.jsx)(RunRetryButton,{run:groupedRun.runs[0],retryRun:retryRun})}}],emptyState:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{children:["No runs in this time range. Your exporter runs every ",(0,jsx_runtime.jsx)("b",{children:interval}),"."]}),canEnableNewDestinations&&(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>openBackfillModal(),children:"Start backfill"})]})})})}function RunRetryButton(_ref5){let{run,retryRun}=_ref5;return(0,jsx_runtime.jsx)("span",{className:"flex items-center gap-1",children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),onClick:()=>src.dn.open({title:"Retry export?",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{children:"This will schedule a new run for the same interval. Any changes to the configuration will be applied to the new run."}),(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("b",{children:"Please note -"})," there may be a slight delay before the new run appears."]})]}),width:"20rem",primaryButton:{children:"Retry",onClick:()=>retryRun(run)},secondaryButton:{children:"Cancel"}})})})}function RunCancelButton(_ref6){let{run,cancelRun}=_ref6;return(0,jsx_runtime.jsx)("span",{className:"flex items-center gap-1",children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(icons.uR,{}),disabledReason:"Running"===run.status||"Starting"===run.status?null:`Cannot cancel as run is '${run.status}'`,onClick:()=>src.dn.open({title:"Cancel run?",description:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("p",{children:"This will cancel the selected backfill run."})}),width:"20rem",primaryButton:{children:"Cancel run",onClick:()=>cancelRun(run)},secondaryButton:{children:"Go back"}})})})}function BatchExportRunIcon(_ref7){let{runs,showLabel=!1}=_ref7,status=combineFailedStatuses(runs[0].status),color=BatchExportRuns_colorForStatus(status);return(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Run status: ",status,runs.length>1&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),"Attempts: ",runs.length]})]}),children:(0,jsx_runtime.jsx)("span",{className:(0,clsx_m.default)(`BatchExportRunIcon h-6 p-2 border-2 flex items-center justify-center rounded-full font-semibold text-xs border-${color} text-${color}-dark select-none`,"primary"===color&&"BatchExportRunIcon--pulse",showLabel?"":"w-6"),children:showLabel?(0,jsx_runtime.jsx)("span",{className:"text-center",children:status}):runs.length})})}let combineFailedStatuses=status=>"FailedRetryable"===status?"Failed":status,BatchExportRuns_colorForStatus=status=>{switch(status){case"Completed":return"success";case"ContinuedAsNew":case"Running":case"Starting":return"primary";case"Cancelled":case"Terminated":case"TimedOut":return"warning";case"Failed":case"FailedRetryable":return"danger";default:return"default"}};var schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts");let logsViewerLogic_ALL_LOG_LEVELS=["DEBUG","LOG","INFO","WARNING","ERROR"],loadGroupedLogs=async request=>{var _request$date_from;let query={kind:schema_general.OH.HogQLQuery,query:`SELECT
            instance_id,
            max(timestamp) AS latest_timestamp,
            min(timestamp) AS earliest_timestamp,
            arraySort(
                groupArray((timestamp, level, message))
            ) AS messages
        FROM log_entries
        WHERE log_source = '${request.sourceType}'
        AND log_source_id = '${request.sourceId}'
        AND timestamp > {filters.dateRange.from}
        AND timestamp < {filters.dateRange.to}
        AND instance_id in (
            SELECT DISTINCT instance_id
            FROM log_entries
            WHERE log_source = 'hog_function'
            AND log_source_id = '${request.sourceId}'
            AND timestamp > {filters.dateRange.from}
            AND timestamp < {filters.dateRange.to}
            AND lower(level) IN (${request.levels.map(level=>`'${level.toLowerCase()}'`).join(",")})
            AND message ILIKE '%${request.search}%'
            ORDER BY timestamp ${request.order}
            LIMIT 500
        )
        GROUP BY instance_id
        ORDER BY latest_timestamp DESC`};return(await api.ZP.query(query,void 0,void 0,!0,{date_from:null!==(_request$date_from=request.date_from)&&void 0!==_request$date_from?_request$date_from:"-7d",date_to:request.date_to})).results.map(result=>({instanceId:result[0],maxTimestamp:(0,dayjs.Bv)(result[1]),minTimestamp:(0,dayjs.Bv)(result[2]),entries:result[3].map(entry=>({timestamp:(0,dayjs.Bv)(entry[0]),level:entry[1].toUpperCase(),message:entry[2]}))}))},sanitizeGroupedLogs=groups=>{let byId={};for(let group of groups){if(byId[group.instanceId])for(let entry of group.entries)byId[group.instanceId].entries.find(e=>e.timestamp.isSame(entry.timestamp))||byId[group.instanceId].entries.push(entry);else byId[group.instanceId]=group;byId[group.instanceId].entries.sort((a,b)=>a.timestamp.diff(b.timestamp));let highestLogLevel=group.entries.reduce((max,entry)=>Math.max(max,logsViewerLogic_ALL_LOG_LEVELS.indexOf(entry.level)),0);byId[group.instanceId].logLevel=logsViewerLogic_ALL_LOG_LEVELS[highestLogLevel]}return Object.values(byId).sort((a,b)=>b.maxTimestamp.diff(a.maxTimestamp))},logsViewerLogic=(0,index_esm.kea)([(0,index_esm.path)(key=>["scenes","pipeline","hogfunctions","logs","logsViewerLogic",key]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{sourceType,sourceId}=_ref;return`${sourceType}:${sourceId}`}),(0,index_esm.actions)({setFilters:filters=>({filters}),addLogGroups:logGroups=>({logGroups}),setHiddenLogs:logGroups=>({logGroups}),clearHiddenLogs:!0,markLogsEnd:!0,revealHiddenLogs:!0,setRowExpanded:(instanceId,expanded)=>({instanceId,expanded}),scheduleLoadNewerLogs:!0,loadLogs:!0,loadNewerLogs:!0}),(0,lib.loaders)(_ref2=>{let{props,values,actions}=_ref2;return{logs:[[],{loadLogs:async(_,breakpoint)=>{await breakpoint(10),actions.clearHiddenLogs();let logParams={levels:values.filters.levels,search:values.filters.search,sourceType:props.sourceType,sourceId:props.sourceId,date_from:values.filters.date_from,date_to:values.filters.date_to,order:"DESC"},results=await loadGroupedLogs(logParams);return await breakpoint(10),sanitizeGroupedLogs(results)},loadMoreLogs:async()=>{if(!values.oldestLogTimestamp)return values.logs;let logParams={levels:values.filters.levels,search:values.filters.search,sourceType:props.sourceType,sourceId:props.sourceId,date_to:values.oldestLogTimestamp.toISOString(),date_from:values.filters.date_from,order:"DESC"},results=await loadGroupedLogs(logParams);return results.length||actions.markLogsEnd(),sanitizeGroupedLogs([...results,...values.logs])},revealHiddenLogs:()=>{let hiddenLogs=[...values.hiddenLogs];return actions.clearHiddenLogs(),sanitizeGroupedLogs([...hiddenLogs,...values.logs])},addLogGroups:_ref3=>{let{logGroups}=_ref3;return sanitizeGroupedLogs([...logGroups,...values.logs])}}],hiddenLogs:[[],{loadNewerLogs:async(_,breakpoint)=>{if(await breakpoint(10),!values.newestLogTimestamp)return values.hiddenLogs;let logParams={levels:values.filters.levels,search:values.filters.search,sourceType:props.sourceType,sourceId:props.sourceId,date_from:values.newestLogTimestamp.toISOString(),date_to:values.filters.date_to,order:"ASC"},results=await loadGroupedLogs(logParams);await breakpoint(10);let newLogs=[],existingLogsToUpdate=[],existingLogIds=values.logs.map(log=>log.instanceId);if(values.logsLoading)return values.hiddenLogs;for(let log of results)existingLogIds.includes(log.instanceId)?existingLogsToUpdate.push(log):newLogs.push(log);return existingLogsToUpdate.length&&actions.loadLogsSuccess(sanitizeGroupedLogs([...existingLogsToUpdate,...values.logs])),actions.scheduleLoadNewerLogs(),sanitizeGroupedLogs([...newLogs,...values.hiddenLogs])},clearHiddenLogs:()=>[]}]}}),(0,index_esm.reducers)({filters:[{search:"",levels:["LOG","INFO","WARNING","ERROR"],date_from:"-7d",date_to:void 0},{setFilters:(state,_ref4)=>{let{filters}=_ref4;return{...state,...filters}}}],isThereMoreToLoad:[!0,{markLogsEnd:()=>!1,loadLogs:()=>!0}],expandedRows:[{},{setRowExpanded:(state,_ref5)=>{let{instanceId,expanded}=_ref5;return{...state,[instanceId]:expanded}}}]}),(0,index_esm.selectors)(()=>({newestLogTimestamp:[s=>[s.logs,s.hiddenLogs],(logs,hiddenLogs)=>logs.concat(hiddenLogs).reduce((max,log)=>max?log.maxTimestamp.isAfter(max)?log.maxTimestamp:max:log.maxTimestamp,null)],oldestLogTimestamp:[s=>[s.logs,s.hiddenLogs],(logs,hiddenLogs)=>logs.concat(hiddenLogs).reduce((min,log)=>min?log.minTimestamp.isBefore(min)?log.minTimestamp:min:log.minTimestamp,null)]})),(0,index_esm.listeners)(_ref6=>{let{actions,cache}=_ref6;return{setFilters:async(_,breakpoint)=>{await breakpoint(500),actions.loadLogs()},loadLogsSuccess:()=>{actions.scheduleLoadNewerLogs()},scheduleLoadNewerLogs:()=>{cache.pollingTimeout&&clearTimeout(cache.pollingTimeout),cache.pollingTimeout=setTimeout(()=>actions.loadNewerLogs(),5e3)}}}),(0,index_esm.events)(_ref7=>{let{actions,cache}=_ref7;return{afterMount:()=>{actions.loadLogs()},beforeUnmount:()=>{clearInterval(cache.pollingTimeout)}}})]),eventIdMatchers=[/Event: ([A-Za-z0-9-]+)/,/\/events\/([A-Za-z0-9-]+)\//,/event ([A-Za-z0-9-]+)/];async function runWithParallelism(items,maxParallel,asyncFn){let results=[],executing=new Set;for(let item of items){let promise=(async()=>{let result=await asyncFn(item);results.push(result)})();executing.add(promise),promise.finally(()=>executing.delete(promise)),executing.size>=maxParallel&&await Promise.race(executing)}return await Promise.all(executing),results}let loadClickhouseEvents=async(eventIds,_ref)=>{let{date_from,date_to}=_ref,query={kind:schema_general.OH.HogQLQuery,query:`
            SELECT uuid, distinct_id, event, timestamp, properties, elements_chain, person.id, person.properties, person.created_at 
            FROM events
            WHERE uuid in (${eventIds.map(x=>`'${x}'`).join(",")})
            AND timestamp > {filters.dateRange.from}
            AND timestamp < {filters.dateRange.to}
        `};return(await api.ZP.query(query,void 0,void 0,!0,{date_from:date_from,date_to:date_to})).results.map(x=>{let[uuid,distinct_id,event,timestamp,properties,elements_chain,person_id,person_properties,person_created_at]=x;return{uuid,event,distinct_id,person_id,timestamp,properties,elements_chain,person_created_at,person_properties}})},hogFunctionLogsLogic=(0,index_esm.kea)([(0,index_esm.path)(key=>["scenes","pipeline","hogfunctions","logs","hogFunctionLogsLogic",key]),(0,index_esm.props)({}),(0,index_esm.key)(_ref2=>{let{sourceType,sourceId}=_ref2;return`${sourceType}:${sourceId}`}),(0,index_esm.connect)(props=>({values:[logsViewerLogic(props),["logs"]],actions:[logsViewerLogic(props),["addLogGroups","setRowExpanded"]]})),(0,index_esm.actions)({setSelectingMany:selectingMany=>({selectingMany}),setSelectedForRetry:selectedForRetry=>({selectedForRetry}),selectAllForRetry:!0,retryInvocation:(groupedLogEntry,eventId)=>({groupedLogEntry,eventId}),retryInvocations:groupedLogEntries=>({groupedLogEntries}),retryInvocationStarted:groupedLogEntry=>({groupedLogEntry}),retryInvocationSuccess:groupedLogEntry=>({groupedLogEntry}),retryInvocationFailure:groupedLogEntry=>({groupedLogEntry}),retrySelectedInvocations:!0}),(0,index_esm.reducers)({selectingMany:[!1,{setSelectingMany:(_,_ref3)=>{let{selectingMany}=_ref3;return selectingMany}}],selectedForRetry:[{},{setSelectedForRetry:(state,_ref4)=>{let{selectedForRetry}=_ref4,newState={...state};return Object.keys(selectedForRetry).forEach(key=>{newState[key]=selectedForRetry[key],selectedForRetry[key]||delete newState[key]}),newState},setSelectingMany:(state,_ref5)=>{let{selectingMany}=_ref5;return selectingMany?state:{}}}],retries:[{},{retryInvocationStarted:(state,_ref6)=>{let{groupedLogEntry}=_ref6;return{...state,[groupedLogEntry.instanceId]:"pending"}},retryInvocationSuccess:(state,_ref7)=>{let{groupedLogEntry}=_ref7;return{...state,[groupedLogEntry.instanceId]:"success"}},retryInvocationFailure:(state,_ref8)=>{let{groupedLogEntry}=_ref8;return{...state,[groupedLogEntry.instanceId]:"failure"}}}]}),(0,index_esm.selectors)({retryRunning:[s=>[s.retries],retries=>Object.values(retries).some(x=>"pending"===x)],eventIdByInvocationId:[s=>[s.logs],logs=>{let eventIdByInvocationId={};for(let record of logs){let entryContainingEventId=record.entries.find(entry=>entry.message.includes("Function completed")||entry.message.includes("Suspending function")||entry.message.includes("Error executing function on event"));if(!entryContainingEventId)return;for(let matcher of eventIdMatchers){let match=entryContainingEventId.message.match(matcher);if(match){eventIdByInvocationId[record.instanceId]=match[1];break}}}return eventIdByInvocationId}]}),(0,index_esm.listeners)(_ref9=>{let{actions,props,values}=_ref9;return{retryInvocations:async _ref10=>{let{groupedLogEntries}=_ref10;await src.UJ.promise((async _values$eventIdByInvo=>{for(let groupedLogEntry of groupedLogEntries)actions.retryInvocationStarted(groupedLogEntry);1===groupedLogEntries.length&&actions.setRowExpanded(groupedLogEntries[0].instanceId,!0);let[timestampRangeStart,timestampRangeEnd]=groupedLogEntries.reduce((_ref11,x)=>{let[accStart,accEnd]=_ref11;return accStart?[x.minTimestamp.isBefore(accStart)?x.minTimestamp:accStart,x.maxTimestamp.isAfter(accEnd)?x.maxTimestamp:accEnd]:[x.minTimestamp,x.minTimestamp]},[null,null]),events=await loadClickhouseEvents(Object.values(null!==(_values$eventIdByInvo=values.eventIdByInvocationId)&&void 0!==_values$eventIdByInvo?_values$eventIdByInvo:{}),{date_from:timestampRangeStart?.subtract(1,"day").toISOString(),date_to:timestampRangeEnd?.add(1,"day").toISOString()}),eventsById={};for(let event of events)eventsById[event.uuid]=event;await runWithParallelism(groupedLogEntries,10,async groupedLogEntry=>{try{let event=eventsById[values.eventIdByInvocationId[groupedLogEntry.instanceId]];if(!event){actions.retryInvocationFailure(groupedLogEntry);return}let res=await api.ZP.hogFunctions.createTestInvocation(props.sourceId,{clickhouse_event:event,mock_async_functions:!1,configuration:{filters:{}},invocation_id:groupedLogEntry.instanceId}),newLogGroup={...groupedLogEntry,entries:[...groupedLogEntry.entries,...res.logs.map(x=>({timestamp:(0,dayjs.Bv)(x.timestamp),level:x.level.toUpperCase(),message:x.message}))]};actions.addLogGroups([newLogGroup]),actions.retryInvocationSuccess(groupedLogEntry)}catch(e){actions.retryInvocationFailure(groupedLogEntry)}}),actions.setSelectingMany(!1)})(),{success:"Retries complete!",error:"Retry failed!",pending:"Retrying..."})},retrySelectedInvocations:async()=>{let groupsToRetry=values.logs.filter(x=>values.selectedForRetry[x.instanceId]);actions.retryInvocations(groupsToRetry)},selectAllForRetry:async()=>{for(let groupedLogEntry of(actions.setSelectingMany(!0),values.logs))actions.setSelectedForRetry({[groupedLogEntry.instanceId]:!0})}}}),(0,kea_router_lib.beforeUnload)(_ref12=>{let{values,cache}=_ref12;return{enabled:()=>!cache.disabledBeforeUnload&&values.retryRunning,message:"You have running retries that will be discarded if you leave. Are you sure?",onConfirm:()=>{cache.disabledBeforeUnload=!0}}})]),tagTypeForLevel=level=>{switch(level.toLowerCase()){case"debug":return"muted";case"log":case"info":default:return"default";case"warning":case"warn":return"warning";case"error":return"danger"}};function LogsViewer(_ref){let{renderColumns=c=>c,...props}=_ref,logic=logsViewerLogic(props),{logs,logsLoading,hiddenLogs,hiddenLogsLoading,isThereMoreToLoad,expandedRows,filters}=(0,index_esm.useValues)(logic),{revealHiddenLogs,loadMoreLogs,setFilters,setRowExpanded}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex-1 deprecated-space-y-2 ph-no-capture",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,jsx_runtime.jsx)(src.DF,{className:"flex-1 min-w-120",type:"search",placeholder:"Search for messages containing…",fullWidth:!0,onChange:value=>setFilters({search:value}),allowClear:!0,prefix:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(posthog_icons_es.IconSearch,{})})}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Qw,{closeOnClickInside:!1,matchWidth:!1,placement:"right-end",overlay:(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2 overflow-hidden max-w-100",children:logsViewerLogic_ALL_LOG_LEVELS.map(level=>(0,jsx_runtime.jsx)(src.Jp,{fullWidth:!0,sideIcon:(0,jsx_runtime.jsx)(src.Hw,{checked:filters.levels.includes(level)}),onClick:()=>{setFilters({levels:filters.levels.includes(level)?filters.levels.filter(t=>t!=level):[...filters.levels,level]})},children:level},level))}),children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",tooltip:"Filtering for any log groups containing any of the selected levels",children:filters.levels.map(level=>level).join(", ")})}),(0,jsx_runtime.jsx)(DateFilter.f,{dateTo:filters.date_to,dateFrom:filters.date_from,onChange:(from,to)=>setFilters({date_from:from||void 0,date_to:to||void 0}),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalendar,{})," ",key]})})]})]}),(0,jsx_runtime.jsx)(src.Jp,{onClick:revealHiddenLogs,loading:hiddenLogsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:hiddenLogs.length?void 0:"There's nothing to load",children:hiddenLogs.length?`Show ${(0,utils.Zi)(hiddenLogs.length,"newer entry","newer entries")}`:"No new entries"}),(0,jsx_runtime.jsx)(src.g3,{dataSource:logs,loading:logsLoading,className:"ph-no-capture",rowKey:record=>record.instanceId,columns:renderColumns([{title:"Timestamp",key:"timestamp",dataIndex:"maxTimestamp",width:0,sorter:(a,b)=>a.maxTimestamp.unix()-b.maxTimestamp.unix(),render:(_,_ref2)=>{let{maxTimestamp}=_ref2;return(0,jsx_runtime.jsx)(TZLabel.w,{time:maxTimestamp})}},{width:0,title:"Invocation",dataIndex:"instanceId",key:"instanceId",render:(_,_ref3)=>{let{instanceId}=_ref3;return(0,jsx_runtime.jsx)("code",{className:"whitespace-nowrap",children:(0,jsx_runtime.jsx)(src.rU,{className:"font-semibold",subtle:!0,onClick:()=>{setRowExpanded(instanceId,!expandedRows[instanceId])},children:instanceId})})}},{key:"logLevel",dataIndex:"logLevel",width:0,render:(_,_ref4)=>{let{instanceId,logLevel}=_ref4;return(0,jsx_runtime.jsx)(src.rU,{subtle:!0,className:"flex items-center gap-2",onClick:()=>{setRowExpanded(instanceId,!expandedRows[instanceId])},children:(0,jsx_runtime.jsx)(src.oe,{type:tagTypeForLevel(logLevel),children:logLevel.toUpperCase()})})}},{title:"Last message",key:"entries",dataIndex:"entries",render:(_,_ref5)=>{let{instanceId,entries}=_ref5,lastEntry=entries[entries.length-1];return(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:(0,jsx_runtime.jsxs)(src.rU,{subtle:!0,onClick:()=>{setRowExpanded(instanceId,!expandedRows[instanceId])},children:[lastEntry.message,entries.length>1&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsxs)("span",{className:"text-xs text-muted-alt",children:["+ ",entries.length-1," more"]})]})]})})}}]),expandable:{noIndent:!0,isRowExpanded:record=>{var _expandedRows$record$;return null!==(_expandedRows$record$=expandedRows[record.instanceId])&&void 0!==_expandedRows$record$&&_expandedRows$record$},onRowExpand:record=>setRowExpanded(record.instanceId,!0),onRowCollapse:record=>setRowExpanded(record.instanceId,!1),expandedRowRender:record=>(0,jsx_runtime.jsx)(src.g3,{embedded:!0,dataSource:record.entries,columns:[{key:"spacer",width:0,render:()=>(0,jsx_runtime.jsx)("div",{className:"w-6"})},{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:(_,_ref6)=>{let{timestamp}=_ref6;return(0,jsx_runtime.jsx)(TZLabel.w,{time:timestamp})}},{title:"Level",key:"level",dataIndex:"level",render:(_,_ref7)=>{let{level}=_ref7;return(0,jsx_runtime.jsx)(src.oe,{type:tagTypeForLevel(level),children:level.toUpperCase()})}},{title:"Message",key:"message",dataIndex:"message",render:(_,_ref8)=>{let{message}=_ref8;return(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}}]})}}),!!logs.length&&(0,jsx_runtime.jsx)(src.Jp,{onClick:loadMoreLogs,loading:logsLoading,type:"secondary",fullWidth:!0,center:!0,disabledReason:isThereMoreToLoad?void 0:"There's nothing more to load",children:isThereMoreToLoad?"Load up to 500 older entries":"No older entries"}),(0,jsx_runtime.jsx)("div",{className:"mb-8"})]})}function HogFunctionLogs(props){let logicProps={sourceType:"hog_function",sourceId:props.hogFunctionId},{selectingMany,selectedForRetry,retryRunning}=(0,index_esm.useValues)(hogFunctionLogsLogic(logicProps)),{setSelectingMany,retrySelectedInvocations,selectAllForRetry}=(0,index_esm.useActions)(hogFunctionLogsLogic(logicProps));return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:selectingMany?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!1),children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>selectAllForRetry(),children:"Select all"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"primary",onClick:()=>{src.dn.open({title:"Retry invocations",content:"Are you sure you want to retry the selected events? Please don't close the window until the invocations have completed.",secondaryButton:{children:"Cancel"},primaryButton:{children:"Retry selected events",onClick:()=>retrySelectedInvocations()}})},loading:retryRunning,disabledReason:retryRunning?"Please wait for the current retries to complete.":0===Object.values(selectedForRetry).length?"No invocations selected":void 0,children:"Retry selected"})]}):(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!0),children:"Select invocations"})})}),(0,jsx_runtime.jsx)(LogsViewer,{...logicProps,sourceId:props.hogFunctionId,renderColumns:columns=>[{title:"Status",key:"status",width:0,render:(_,record)=>(0,jsx_runtime.jsx)(HogFunctionLogsStatus,{record:record,hogFunctionId:props.hogFunctionId})},...columns.filter(column=>"logLevel"!==column.key)]})]})}function HogFunctionLogsStatus(_ref){var _selectedForRetry$rec;let{record,hogFunctionId}=_ref,logicProps={sourceType:"hog_function",sourceId:hogFunctionId},{retries,selectingMany,selectedForRetry,eventIdByInvocationId}=(0,index_esm.useValues)(hogFunctionLogsLogic(logicProps)),{retryInvocations,setSelectingMany,setSelectedForRetry}=(0,index_esm.useActions)(hogFunctionLogsLogic(logicProps)),thisRetry=retries[record.instanceId],status=(0,react.useMemo)(()=>{if("pending"===thisRetry)return"running";let lastEntry=record.entries[record.entries.length-1];return lastEntry.message.includes("Function completed")||lastEntry.message.includes("Execution successful")?"success":"ERROR"===lastEntry.level?"failure":"running"},[record,thisRetry]),eventId=eventIdByInvocationId?.[record.instanceId];return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[selectingMany?(0,jsx_runtime.jsx)(src.Hw,{checked:null!==(_selectedForRetry$rec=selectedForRetry[record.instanceId])&&void 0!==_selectedForRetry$rec&&_selectedForRetry$rec,onChange:checked=>setSelectedForRetry({[record.instanceId]:checked})}):null,(0,jsx_runtime.jsx)(src.oe,{type:"success"===status?"success":"failure"===status?"danger":"warning",children:(0,utils.fm)(status)}),(0,jsx_runtime.jsx)(src.d6,{items:[eventId?{label:"View event",to:urls.j.event(eventId,"")}:null,{label:"Retry event",disabledReason:eventId?void 0:"Could not find the source event",onClick:()=>retryInvocations([record])},{label:"Select for retry",onClick:()=>{setSelectingMany(!0),setSelectedForRetry({[record.instanceId]:!0})}}],children:(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{className:"rotate-90"}),loading:"pending"===thisRetry})})]})}var Chart=__webpack_require__("../../frontend/src/lib/Chart.ts"),colors=__webpack_require__("../../frontend/src/lib/colors.ts"),InsightTooltip=__webpack_require__("../../frontend/src/scenes/insights/InsightTooltip/InsightTooltip.tsx"),appMetricsV2Logic=__webpack_require__("../../frontend/src/scenes/pipeline/metrics/appMetricsV2Logic.tsx");let METRICS_INFO={succeeded:"Total number of events processed successfully",failed:"Total number of events that had errors during processing",filtered:"Total number of events that were filtered out",disabled_temporarily:"Total number of events that were skipped due to the destination being temporarily disabled (due to issues such as the destination being down or rate-limited)",disabled_permanently:"Total number of events that were skipped due to the destination being permanently disabled (due to prolonged issues with the destination)"};function AppMetricsV2(_ref){let{id}=_ref,logic=(0,appMetricsV2Logic.N)({id}),{filters}=(0,index_esm.useValues)(logic),{setFilters,loadMetrics,loadMetricsTotals}=(0,index_esm.useActions)(logic);return(0,react.useEffect)(()=>{loadMetrics(),loadMetricsTotals()},[]),(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:appMetricsV2Logic.N,props:{id},children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,jsx_runtime.jsx)(AppMetricsTotals,{}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0",children:"Delivery trends"}),(0,jsx_runtime.jsx)("div",{className:"flex-1"}),(0,jsx_runtime.jsx)(src.Yv,{options:[{label:"Hourly",value:"hour"},{label:"Daily",value:"day"},{label:"Weekly",value:"week"}],size:"small",value:filters.interval,onChange:value=>setFilters({interval:value})}),(0,jsx_runtime.jsx)(DateFilter.f,{dateTo:filters.before,dateFrom:filters.after,onChange:(from,to)=>setFilters({after:from||void 0,before:to||void 0}),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalendar,{})," ",key]})})]}),(0,jsx_runtime.jsx)(AppMetricsGraph,{})]})})}function AppMetricBigNumber(_ref2){let{label,value,tooltip}=_ref2;return(0,jsx_runtime.jsx)(src.u,{title:tooltip,children:(0,jsx_runtime.jsxs)("div",{className:"border p-2 rounded bg-surface-primary flex-1 flex flex-col gap-2 items-center",children:[(0,jsx_runtime.jsx)("div",{className:"uppercase font-bold text-xs",children:label.replace(/_/g," ")}),(0,jsx_runtime.jsx)("div",{className:"text-2xl flex-1 mb-2 flex items-center",children:(0,utils.Lc)(null!=value?value:0)})]})})}function AppMetricsTotals(){let{appMetricsTotals,appMetricsTotalsLoading}=(0,index_esm.useValues)(appMetricsV2Logic.N);return(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-4",children:(0,jsx_runtime.jsx)("div",{className:"flex items-center gap-2 flex-wrap",children:Object.entries(METRICS_INFO).map(_ref3=>{let[key,value]=_ref3;return(0,jsx_runtime.jsx)("div",{className:"flex flex-col h-30 min-w-30 flex-1 max-w-100",children:appMetricsTotalsLoading?(0,jsx_runtime.jsx)(src.yW,{className:"h-full w-full"}):(0,jsx_runtime.jsx)(AppMetricBigNumber,{label:key,value:appMetricsTotals?.totals?.[key],tooltip:value})},key)})})})}function AppMetricsGraph(){let{appMetrics,appMetricsLoading}=(0,index_esm.useValues)(appMetricsV2Logic.N),canvasRef=(0,react.useRef)(null),[popoverContent,setPopoverContent]=(0,react.useState)(null),[tooltipState,setTooltipState]=(0,react.useState)({x:0,y:0,visible:!1});return(0,react.useEffect)(()=>{let chart;if(canvasRef.current&&appMetrics&&!(0,utils.es)())return chart=new Chart.k(canvasRef.current?.getContext("2d"),{type:"line",data:{labels:appMetrics.labels,datasets:[...appMetrics.series.map(series=>({label:series.name,data:series.values,borderColor:"",...colorConfig(series.name)}))]},options:{scales:{x:{ticks:{maxRotation:0},grid:{display:!1}},y:{beginAtZero:!0}},plugins:{crosshair:!1,legend:{display:!1},tooltip:{enabled:!1,external(_ref4){let{tooltip,chart}=_ref4;setPopoverContent((0,jsx_runtime.jsx)(InsightTooltip.Q,{embedded:!0,hideInspectActorsSection:!0,altTitle:tooltip.dataPoints[0].label,seriesData:tooltip.dataPoints.map((dp,i)=>({id:i,dataIndex:0,datasetIndex:0,label:dp.dataset.label,color:dp.dataset.borderColor,count:dp.dataset.data?.[dp.dataIndex]||0})),renderSeries:value=>value,renderCount:count=>(0,utils.Lc)(count)}));let position=chart.canvas.getBoundingClientRect();setTooltipState({x:position.left+tooltip.caretX,y:position.top+tooltip.caretY,visible:tooltip.opacity>0})}}},maintainAspectRatio:!1,interaction:{mode:"index",axis:"x",intersect:!1}}}),()=>{chart?.destroy()}},[appMetrics]),(0,jsx_runtime.jsxs)("div",{className:"relative border rounded p-6 bg-surface-primary h-[50vh]",children:[appMetricsLoading&&(0,jsx_runtime.jsx)(src.t2,{}),!!appMetrics&&(0,jsx_runtime.jsx)("canvas",{ref:canvasRef}),(0,jsx_runtime.jsx)(src.J2,{visible:tooltipState.visible,overlay:popoverContent,placement:"top",padded:!1,className:"pointer-events-none",children:(0,jsx_runtime.jsx)("div",{className:"fixed",style:{left:tooltipState.x,top:tooltipState.y}})})]})}function colorConfig(name){let color="";switch(name){case"succeeded":color=(0,colors.cM)("success");break;case"failed":color=(0,colors.cM)("danger");break;default:color=(0,colors.cM)("data-color-1")}return{borderColor:color,hoverBorderColor:color,hoverBackgroundColor:color,backgroundColor:color,fill:!1,borderWidth:2,pointRadius:0}}var HogFunctionConfiguration=__webpack_require__("../../frontend/src/scenes/pipeline/hogfunctions/HogFunctionConfiguration.tsx"),PipelineBatchExportConfiguration=__webpack_require__("../../frontend/src/scenes/pipeline/PipelineBatchExportConfiguration.tsx"),PipelinePluginConfiguration=__webpack_require__("../../frontend/src/scenes/pipeline/PipelinePluginConfiguration.tsx");function PipelineNodeConfiguration(){let{node,stage}=(0,index_esm.useValues)(pipelineNodeLogic.y);return stage?(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-3",children:node.backend===pipeline_types.b.HogFunction?(0,jsx_runtime.jsx)(HogFunctionConfiguration.g,{id:node.id}):node.backend===pipeline_types.b.Plugin?(0,jsx_runtime.jsx)(PipelinePluginConfiguration.s,{stage:stage,pluginConfigId:node.id}):(0,jsx_runtime.jsx)(PipelineBatchExportConfiguration.B,{id:node.id.toString()})}):(0,jsx_runtime.jsx)(NotFound.T,{object:"pipeline app stage"})}var CodeSnippet=__webpack_require__("../../frontend/src/lib/components/CodeSnippet/index.ts"),LemonLabel=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonLabel/LemonLabel.tsx"),LemonSkeleton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSkeleton/index.ts"),LemonTable=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/index.ts"),Link=__webpack_require__("../../frontend/src/lib/lemon-ui/Link/index.ts"),lemon_ui_Tooltip=__webpack_require__("../../frontend/src/lib/lemon-ui/Tooltip/index.ts"),pipelineNodeMetricsLogic=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineNodeMetricsLogic.tsx");function PipelineNodeMetrics(_ref){let{id}=_ref,logic=(0,pipelineNodeMetricsLogic.j)({id}),{appMetricsResponse,appMetricsResponseLoading,dateRange}=(0,index_esm.useValues)(logic),{setDateRange}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-8",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,jsx_runtime.jsx)(MetricsOverview,{metrics:appMetricsResponse?.metrics,metricsLoading:appMetricsResponseLoading}),(0,jsx_runtime.jsx)(DateFilter.f,{dateTo:dateRange.to,dateFrom:dateRange.from,onChange:(from,to)=>setDateRange(from,to),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:key=>(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCalendar,{})," ",key]})})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h2",{children:"Delivery trends"}),(0,jsx_runtime.jsx)(PipelineNodeMetrics_AppMetricsGraph,{metrics:appMetricsResponse?.metrics,metricsLoading:appMetricsResponseLoading})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h2",{children:"Errors"}),(0,jsx_runtime.jsx)(ErrorsOverview,{id:id})]})]})}function MetricsOverview(_ref2){let{metrics,metricsLoading}=_ref2;return metricsLoading?(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"w-20 h-4 mb-2",repeat:4}):(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-4",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-start gap-8 flex-wrap",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"text-secondary font-semibold mb-2",children:["Events Processed successfully",(0,jsx_runtime.jsx)(lemon_ui_Tooltip.u,{title:"Total number of events processed successfully",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{})})]}),(0,jsx_runtime.jsx)("div",{className:"text-4xl",children:renderNumber(metrics?.totals?.successes)})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"text-secondary font-semibold mb-2",children:["Events Failed",(0,jsx_runtime.jsx)(lemon_ui_Tooltip.u,{title:"Total number of events that threw an error during processing",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{})})]}),(0,jsx_runtime.jsx)("div",{className:"text-4xl",children:renderNumber(metrics?.totals?.failures)})]})]})})}function renderNumber(value){return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:value?(0,utils.Lc)(value):value})}function PipelineNodeMetrics_AppMetricsGraph(_ref3){let{metrics,metricsLoading}=_ref3,canvasRef=(0,react.useRef)(null);return((0,react.useEffect)(()=>{let chart;if(canvasRef.current&&metrics&&!(0,utils.es)())return chart=new Chart.k(canvasRef.current?.getContext("2d"),{type:"line",data:{labels:metrics.dates,datasets:[{label:"events processed successfully",data:metrics.successes,borderColor:"",...PipelineNodeMetrics_colorConfig("data-color-1")},{label:"events failed",data:metrics.failures,...PipelineNodeMetrics_colorConfig("data-color-5")}]},options:{scales:{x:{ticks:{maxRotation:0},grid:{display:!1}},y:{beginAtZero:!0}},plugins:{crosshair:!1,legend:{display:!1}},maintainAspectRatio:!1,interaction:{mode:"index",axis:"x",intersect:!1}}}),()=>{chart?.destroy()}},[metrics]),metricsLoading||!metrics)?(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"AppMetricsGraph border rounded p-6"}):(0,jsx_runtime.jsx)("div",{className:"AppMetricsGraph border rounded p-6",children:(0,jsx_runtime.jsx)("canvas",{ref:canvasRef})})}function PipelineNodeMetrics_colorConfig(baseColorVar){let mainColor=(0,colors.cM)(baseColorVar);return{borderColor:mainColor,hoverBorderColor:(0,utils._$)(mainColor,-20),hoverBackgroundColor:(0,utils._$)(mainColor,-20),backgroundColor:mainColor,fill:!1,borderWidth:2,pointRadius:0}}function ErrorsOverview(_ref4){let{id}=_ref4,logic=(0,pipelineNodeMetricsLogic.j)({id}),{appMetricsResponse,appMetricsResponseLoading}=(0,index_esm.useValues)(logic),{openErrorDetailsModal}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ErrorDetailsModal,{id:id}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:appMetricsResponse?.errors||[],loading:appMetricsResponseLoading,columns:[{title:"Error type",dataIndex:"error_type",render:function RenderErrorType(_,errorSummary){return(0,jsx_runtime.jsx)(Link.r,{title:"View details",className:"font-semibold",onClick:event=>{event.preventDefault(),openErrorDetailsModal(errorSummary.error_type)},children:errorSummary.error_type})},sorter:(a,b)=>a.error_type.localeCompare(b.error_type)},{title:"Count",dataIndex:"count",align:"right",sorter:(a,b)=>a.count-b.count},{title:"Last seen",dataIndex:"last_seen",render:function RenderCreatedAt(lastSeen){return(0,jsx_runtime.jsx)("div",{className:"whitespace-nowrap text-right",children:(0,jsx_runtime.jsx)(TZLabel.w,{time:lastSeen})})},align:"right",sorter:(a,b)=>new Date(a.last_seen||0)>new Date(b.last_seen||0)?1:-1}],defaultSorting:{columnKey:"last_seen",order:-1},useURLForSorting:!1,noSortingCancellation:!0,emptyState:(0,jsx_runtime.jsxs)("div",{className:"",children:[(0,jsx_runtime.jsx)("b",{children:"No errors! \uD83E\uDD73"}),(0,jsx_runtime.jsx)("p",{className:"m-0",children:"If this app has any errors in the future, this table will contain information to help solve the issue."})]})})]})}function ErrorDetailsModal(_ref5){let{id}=_ref5,logic=(0,pipelineNodeMetricsLogic.j)({id}),{errorDetails,errorDetailsModalError,errorDetailsLoading}=(0,index_esm.useValues)(logic),{closeErrorDetailsModal}=(0,index_esm.useActions)(logic),[page,setPage]=(0,react.useState)(0),activeErrorDetails=errorDetails[page];return(0,jsx_runtime.jsx)(LemonModal.f,{isOpen:!!errorDetailsModalError,onClose:closeErrorDetailsModal,title:errorDetailsModalError,width:"min(50vw, 80rem)",description:(0,jsx_runtime.jsx)("span",{children:activeErrorDetails?.error_details?.error.message?.substring(0,200)}),footer:(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-end gap-1 h-",children:errorDetailsLoading?(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"h-10"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("span",{children:[page+1," of ",errorDetails.length," sample",errorDetails.length>1?"s":""]}),(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(icons.ed,{}),onClick:()=>setPage(page-1),disabledReason:0==page?"First page":void 0}),(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(icons.VG,{}),onClick:()=>setPage(page+1),disabledReason:page==errorDetails.length-1?"Last page":void 0})]})}),children:!errorDetailsModalError||errorDetailsLoading?(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"h-10"}):(0,jsx_runtime.jsxs)("div",{className:"flex flex-col deprecated-space-y-2 h-[80vh]",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"When:"})," ",(0,jsx_runtime.jsx)(TZLabel.w,{time:activeErrorDetails.timestamp,showSeconds:!0})]}),activeErrorDetails.error_details.eventCount&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(LemonLabel.H,{children:"Event Count"}),(0,jsx_runtime.jsx)("div",{children:activeErrorDetails.error_details.eventCount})]}),activeErrorDetails.error_details.error.message&&(0,jsx_runtime.jsx)(CollapsibleSection,{title:"Error message",defaultIsExpanded:!0,children:(0,jsx_runtime.jsx)(CodeSnippet.O,{wrap:!0,language:CodeSnippet.S.JavaScript,children:activeErrorDetails.error_details.error.message})}),activeErrorDetails.error_details.event&&(0,jsx_runtime.jsx)(CollapsibleSection,{title:"Event payload",defaultIsExpanded:!1,children:(0,jsx_runtime.jsx)(CodeSnippet.O,{wrap:!0,language:CodeSnippet.S.JSON,children:JSON.stringify(activeErrorDetails.error_details.event,null,2)})}),activeErrorDetails.error_details.error.stack&&(0,jsx_runtime.jsx)(CollapsibleSection,{title:"Stack trace",defaultIsExpanded:!1,children:(0,jsx_runtime.jsx)(CodeSnippet.O,{wrap:!0,language:CodeSnippet.S.JavaScript,children:activeErrorDetails.error_details.error.stack})})]})})}function CollapsibleSection(props){let[isExpanded,setIsExpanded]=(0,react.useState)(props.defaultIsExpanded);return(0,jsx_runtime.jsxs)("div",{className:"bg-primary border rounded",children:[(0,jsx_runtime.jsx)(LemonButton.J,{fullWidth:!0,onClick:()=>setIsExpanded(!isExpanded),sideIcon:isExpanded?(0,jsx_runtime.jsx)(posthog_icons_es.IconCollapse,{}):(0,jsx_runtime.jsx)(posthog_icons_es.IconExpand,{}),title:isExpanded?"Show less":"Show more",className:"bg-primary",children:props.title}),isExpanded&&(0,jsx_runtime.jsx)("div",{className:"bg-surface-primary p-2",children:props.children})]})}var PayGateMini=__webpack_require__("../../frontend/src/lib/components/PayGateMini/PayGateMini.tsx"),PropertyKeyInfo=__webpack_require__("../../frontend/src/lib/components/PropertyKeyInfo.tsx"),TaxonomicFilter_types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),EmptyStates=__webpack_require__("../../frontend/src/scenes/insights/EmptyStates/index.ts"),PersonDisplay=__webpack_require__("../../frontend/src/scenes/persons/PersonDisplay.tsx"),HogFunctionFilters=__webpack_require__("../../frontend/src/scenes/pipeline/hogfunctions/filters/HogFunctionFilters.tsx"),hogFunctionConfigurationLogic=__webpack_require__("../../frontend/src/scenes/pipeline/hogfunctions/hogFunctionConfigurationLogic.tsx"),hogFunctionTestLogic=__webpack_require__("../../frontend/src/scenes/pipeline/hogfunctions/hogFunctionTestLogic.tsx"),fast_deep_equal=__webpack_require__("../../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"),fast_deep_equal_default=__webpack_require__.n(fast_deep_equal),kea_subscriptions_lib=__webpack_require__("../../node_modules/.pnpm/kea-subscriptions@3.0.1_kea@3.1.5_react@18.2.0_/node_modules/kea-subscriptions/lib/index.js"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts"),DataTable_utils=__webpack_require__("../../frontend/src/queries/nodes/DataTable/utils.ts"),queries_utils=__webpack_require__("../../frontend/src/queries/utils.ts");let hogFunctionTestingLogic=(0,index_esm.kea)([(0,index_esm.path)(key=>["scenes","pipeline","hogFunctionTestingLogic",key]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id}=_ref;return id}),(0,index_esm.connect)({values:[hogFunctionConfigurationLogic.nM,["configuration","matchingFilters","templateId"],groupsModel.$,["groupTypes"]]}),(0,index_esm.actions)({changeDateRange:(after,before)=>({after,before}),addLoadingRetry:eventId=>({eventId}),removeLoadingRetry:eventId=>({eventId}),increaseCurrentPage:timestamp=>({timestamp}),decreaseCurrentPage:!0,resetCurrentPage:!0,expandRow:eventId=>({eventId}),collapseRow:eventId=>({eventId}),resetCollapsedRows:!0,selectForRetry:eventIds=>({eventIds}),deselectForRetry:eventIds=>({eventIds}),resetSelectedForRetry:!0,setSelectingMany:selectingMany=>({selectingMany})}),(0,index_esm.reducers)({dateRange:[{after:"-7d",before:null},{changeDateRange:(_,_ref2)=>{let{after,before}=_ref2;return{after,before}}}],loadingRetries:[[],{addLoadingRetry:(state,_ref3)=>{let{eventId}=_ref3;return[...state,eventId]},removeLoadingRetry:(state,_ref4)=>{let{eventId}=_ref4;return state.filter(id=>id!==eventId)}}],pageTimestamps:[[],{increaseCurrentPage:(state,_ref5)=>{let{timestamp}=_ref5;return[...state,timestamp]},decreaseCurrentPage:state=>[...state.filter((_,i)=>i!==state.length-1)],resetCurrentPage:()=>[]}],expandedRows:[[],{expandRow:(state,_ref6)=>{let{eventId}=_ref6;return[...state,eventId]},collapseRow:(state,_ref7)=>{let{eventId}=_ref7;return[...state.filter(id=>id!==eventId)]},resetCollapsedRows:()=>[]}],selectingMany:[!1,{setSelectingMany:(_,_ref8)=>{let{selectingMany}=_ref8;return selectingMany}}],selectedForRetry:[[],{selectForRetry:(state,_ref9)=>{let{eventIds}=_ref9;return[...new Set([...state,...eventIds])]},deselectForRetry:(state,_ref10)=>{let{eventIds}=_ref10;return[...state.filter(id=>!eventIds.includes(id))]},resetSelectedForRetry:()=>[]}]}),(0,lib.loaders)(_ref11=>{let{values,props,actions}=_ref11;return{events:[{results:[],before:void 0},{loadEvents:async()=>{var _values$dateRange$bef;return values.baseEventsQuery?{...await api.ZP.query(values.baseEventsQuery),before:null!==(_values$dateRange$bef=values.dateRange.before)&&void 0!==_values$dateRange$bef?_values$dateRange$bef:void 0}:{results:[],before:void 0}},loadNextEventsPage:async()=>values.nextQuery?(actions.increaseCurrentPage(values.events.before),{...await api.ZP.query(values.nextQuery),before:values.nextQuery.before}):{...values.events,before:void 0},loadPreviousEventsPage:async()=>{if(!values.previousQuery)return{...values.events,before:void 0};let response=await api.ZP.query(values.previousQuery);return actions.decreaseCurrentPage(),{...response,before:values.previousQuery.before}}}],totalEvents:[0,{loadTotalEvents:async()=>{var _response$results$0$a;if(!values.totalEventsQuery)return 0;let response=await api.ZP.query(values.totalEventsQuery);return null!==(_response$results$0$a=response.results[0]?.aggregated_value)&&void 0!==_response$results$0$a?_response$results$0$a:0}}],retries:[[],{retryInvocation:async _ref12=>{let res,{eventId,globals}=_ref12;actions.addLoadingRetry(eventId);let configuration=(0,hogFunctionConfigurationLogic.r9)(values.configuration);configuration.template_id=values.templateId;try{var _props$id;res=await api.ZP.hogFunctions.createTestInvocation(null!==(_props$id=props.id)&&void 0!==_props$id?_props$id:"new",{globals,mock_async_functions:!1,configuration}),actions.removeLoadingRetry(eventId);let retry={eventId:eventId,...res};return[...values.retries,retry]}catch(e){src.UJ.error(`An unexpected server error occurred while testing the function. ${e}`)}return actions.removeLoadingRetry(eventId),[...values.retries]}}]}}),(0,index_esm.selectors)(_ref13=>{let{values}=_ref13;return{baseEventsQuery:[s=>[s.configuration,s.matchingFilters,s.groupTypes,s.dateRange],(configuration,matchingFilters,groupTypes,dateRange)=>{var _dateRange$after,_dateRange$before;let query={kind:schema_general.OH.EventsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,fixedProperties:[matchingFilters],limit:20,select:["*","person","timestamp"],after:null!==(_dateRange$after=dateRange?.after)&&void 0!==_dateRange$after?_dateRange$after:void 0,before:null!==(_dateRange$before=dateRange?.before)&&void 0!==_dateRange$before?_dateRange$before:void 0,orderBy:["timestamp DESC"],modifiers:{personsOnEventsMode:"person_id_no_override_properties_on_events"}};return groupTypes.forEach(groupType=>{let name=(0,queries_utils.AU)(groupType.group_type);query.select.push(`tuple(${name}.created_at, ${name}.index, ${name}.key, ${name}.properties, ${name}.updated_at)`)}),query},{resultEqualityCheck:fast_deep_equal_default()}],totalEventsQuery:[s=>[s.configuration,s.matchingFilters,s.dateRange],(configuration,matchingFilters,dateRange)=>({kind:schema_general.OH.TrendsQuery,filterTestAccounts:configuration.filters?.filter_test_accounts,series:[{kind:schema_general.OH.EventsNode,event:null,name:"All Events",math:types.vN.TotalCount}],properties:matchingFilters,dateRange:{date_from:dateRange.after,date_to:dateRange.before},trendsFilter:{display:types.Qb.BoldNumber},modifiers:{personsOnEventsMode:"person_id_no_override_properties_on_events"}}),{resultEqualityCheck:fast_deep_equal_default()}],eventsWithRetries:[s=>[s.events,s.retries],(events,retries)=>events.results.map(row=>[...row.slice(0,3),retries.filter(r=>r.eventId===row[0].uuid),...row.slice(3)])],nextQuery:[s=>[s.baseEventsQuery,s.events],(baseEventsQuery,events)=>{if(!baseEventsQuery||!events)return null;let typedResults=events?.results,sortColumnIndex=baseEventsQuery?.select.map(hql=>DataTable_utils.$p(hql)).indexOf("timestamp");if(-1!==sortColumnIndex){let lastTimestamp=typedResults?.[typedResults.length-1]?.[sortColumnIndex];if(lastTimestamp)return{...baseEventsQuery,before:lastTimestamp,limit:20}}return null}],previousQuery:[s=>[s.baseEventsQuery,s.events],(baseEventsQuery,events)=>{if(!baseEventsQuery||!events)return null;let lastTimestamp=values.pageTimestamps[values.pageTimestamps.length-1];return{...baseEventsQuery,before:lastTimestamp,limit:20}}]}}),(0,index_esm.listeners)(_ref14=>{let{actions}=_ref14;return{changeDateRange:()=>{actions.loadEvents()},loadEvents:()=>{actions.loadTotalEvents(),actions.resetCurrentPage(),actions.resetCollapsedRows(),actions.resetSelectedForRetry()},increaseCurrentPage:()=>{actions.resetSelectedForRetry()},decreaseCurrentPage:()=>{actions.resetSelectedForRetry()}}}),(0,kea_subscriptions_lib.Vt)(_ref15=>{let{actions,values}=_ref15;return{configuration:()=>{values.configuration?.name&&(actions.loadEvents(),actions.loadTotalEvents())}}}),(0,kea_router_lib.beforeUnload)(_ref16=>{let{values,cache}=_ref16;return{enabled:()=>!cache.disabledBeforeUnload&&values.loadingRetries.length>0,message:"You have running tests that will be discarded if you leave. Are you sure?",onConfirm:()=>{cache.disabledBeforeUnload=!0}}})]),buildGlobals=(row,groupTypes,hogFunctionName)=>{let globals=(0,hogFunctionConfigurationLogic.Af)(row[0],row[1]);return globals.groups={},groupTypes.forEach((groupType,index)=>{let tuple=row?.[4+index];if(tuple&&Array.isArray(tuple)&&tuple[2]){let properties={};try{properties=JSON.parse(tuple[3])}catch(e){}globals.groups[groupType.group_type]={type:groupType.group_type,index:tuple[1],id:tuple[2],url:`${window.location.origin}/groups/${tuple[1]}/${encodeURIComponent(tuple[2])}`,properties}}}),globals.source={name:null!=hogFunctionName?hogFunctionName:"Unnamed",url:window.location.href.split("#")[0]},globals};function TestingMenu(_ref){let{id}=_ref,{selectingMany,eventsWithRetries,loadingRetries,selectedForRetry}=(0,index_esm.useValues)(hogFunctionTestingLogic({id})),{setSelectingMany,retryInvocation,selectForRetry,deselectForRetry,resetSelectedForRetry}=(0,index_esm.useActions)(hogFunctionTestingLogic({id})),{loading,loaded,showPaygate,groupTypes,configuration,isConfigurationSubmitting,willReEnableOnSave,willChangeEnabledOnSave,configurationChanged}=(0,index_esm.useValues)((0,hogFunctionConfigurationLogic.nM)({id})),{submitConfiguration}=(0,index_esm.useActions)((0,hogFunctionConfigurationLogic.nM)({id}));return loading&&!loaded?(0,jsx_runtime.jsx)(src.t2,{}):loaded&&id?showPaygate?(0,jsx_runtime.jsx)(PayGateMini.E,{feature:types.P$.DATA_PIPELINES}):(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-3",children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[selectingMany?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>{setSelectingMany(!1),resetSelectedForRetry()},children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>selectedForRetry.length===eventsWithRetries.length?deselectForRetry(eventsWithRetries.map(row=>row[0].uuid)):selectForRetry(eventsWithRetries.map(row=>row[0].uuid)),children:(0,jsx_runtime.jsx)("span",{children:selectedForRetry.length===eventsWithRetries.length?"Deselect all":"Select all"})}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"primary",onClick:()=>{src.dn.open({title:"Test selected events",content:"Are you sure you want to test the selected events? Please don't close the window until the invocations have completed.",secondaryButton:{children:"Cancel"},primaryButton:{children:"Test selected events",onClick:()=>{eventsWithRetries.filter(row=>selectedForRetry.includes(row[0].uuid)).forEach(row=>{var _configuration$name;return retryInvocation({eventId:row[0].uuid,globals:buildGlobals(row,groupTypes,null!==(_configuration$name=configuration?.name)&&void 0!==_configuration$name?_configuration$name:"Unnamed")})})}}})},loading:loadingRetries.length>0,disabledReason:loadingRetries.length>0?"Please wait for the current tests to complete.":0===selectedForRetry.length?"No invocations selected":void 0,children:"Test selected"})]}):(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:()=>setSelectingMany(!0),children:"Select invocations"}),configurationChanged?(0,jsx_runtime.jsxs)(src.Jp,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,children:["Save",willReEnableOnSave?" & re-enable":willChangeEnabledOnSave?` & ${configuration.enabled?"enable":"disable"}`:""]}):null]})}),(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:(0,jsx_runtime.jsx)("span",{children:"This is a list of all events matching your filters. You can run the function using these historical events."})}),(0,jsx_runtime.jsx)(RunsFilters,{id:id}),(0,jsx_runtime.jsx)(TestingEventsList,{id:id})]}):(0,jsx_runtime.jsx)(NotFound.T,{object:"Hog function"})}function EmptyColumn(){return(0,jsx_runtime.jsx)(src.u,{title:"NULL",placement:"right",delayMs:0,children:(0,jsx_runtime.jsx)("span",{className:"cursor-default","aria-hidden":!0,children:"—"})})}function RunsFilters(_ref3){var _baseEventsQuery$afte,_baseEventsQuery$befo;let{id}=_ref3,logic=hogFunctionTestingLogic({id}),{eventsLoading,baseEventsQuery}=(0,index_esm.useValues)(logic),{loadEvents,changeDateRange,loadTotalEvents}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{loadEvents(),loadTotalEvents()},loading:eventsLoading,type:"secondary",icon:(0,jsx_runtime.jsx)(icons.tr,{}),size:"small",children:"Refresh"}),(0,jsx_runtime.jsx)(DateFilter.f,{dateFrom:null!==(_baseEventsQuery$afte=baseEventsQuery?.after)&&void 0!==_baseEventsQuery$afte?_baseEventsQuery$afte:void 0,dateTo:null!==(_baseEventsQuery$befo=baseEventsQuery?.before)&&void 0!==_baseEventsQuery$befo?_baseEventsQuery$befo:void 0,onChange:changeDateRange}),(0,jsx_runtime.jsx)(src.Qw,{closeOnClickInside:!1,matchWidth:!1,placement:"right-end",overlay:(0,jsx_runtime.jsx)(kea_forms_lib.Form,{logic:hogFunctionConfigurationLogic.nM,props:{id},formKey:"configuration",className:"deprecated-space-y-3",children:(0,jsx_runtime.jsx)(HogFunctionFilters.B,{embedded:!0})}),children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",children:"Filters"})})]})}function TestingEventsList(_ref4){let{id}=_ref4,logic=hogFunctionTestingLogic({id}),{eventsLoading,eventsWithRetries,totalEvents,pageTimestamps,expandedRows,loadingRetries,selectingMany,selectedForRetry}=(0,index_esm.useValues)(logic),{retryInvocation,loadNextEventsPage,loadPreviousEventsPage,expandRow,collapseRow,selectForRetry,deselectForRetry}=(0,index_esm.useActions)(logic),{groupTypes,configuration,logicProps}=(0,index_esm.useValues)((0,hogFunctionConfigurationLogic.nM)({id})),{setSampleGlobals,toggleExpanded}=(0,index_esm.useActions)((0,hogFunctionTestLogic.g)(logicProps));return(0,jsx_runtime.jsx)(src.g3,{dataSource:eventsWithRetries,loading:eventsLoading,loadingSkeletonRows:5,pagination:{controlled:!0,currentPage:pageTimestamps.length+1,onForward:loadNextEventsPage,onBackward:loadPreviousEventsPage,pageSize:eventsWithRetries.length,hideOnSinglePage:!1,entryCount:totalEvents},expandable:{isRowExpanded:_ref5=>{let[event]=_ref5;return expandedRows.includes(event.uuid)},onRowExpand:_ref6=>{let[event]=_ref6;return expandRow(event.uuid)},onRowCollapse:_ref7=>{let[event]=_ref7;return collapseRow(event.uuid)},noIndent:!0,expandedRowRender:_ref8=>{let[,,,retries]=_ref8;return(0,jsx_runtime.jsx)(src.g3,{dataSource:retries.reduce((acc,group)=>acc.concat(group.logs),[]),embedded:!0,columns:[{key:"spacer",width:0,render:()=>(0,jsx_runtime.jsx)("div",{className:"w-6"})},{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:(_,_ref9)=>{let{timestamp}=_ref9;return(0,jsx_runtime.jsx)(TZLabel.w,{time:timestamp})}},{title:"Level",key:"level",dataIndex:"level",render:(_,_ref10)=>{let{level}=_ref10;return(0,jsx_runtime.jsx)(src.oe,{type:tagTypeForLevel(level),children:level.toUpperCase()})}},{title:"Message",key:"message",dataIndex:"message",render:(_,_ref11)=>{let{message}=_ref11;return(0,jsx_runtime.jsx)("code",{className:"whitespace-pre-wrap",children:message})}}]})}},columns:[{title:"Status",key:"status",width:0,render:(_,row)=>{let eventId=row[0].uuid,getStatus=()=>loadingRetries.includes(eventId)?{text:"Running",type:"warning"}:0===row[3].length?{text:"Not tested",type:"muted"}:"error"===row[3][row[3].length-1].status?{text:"Failure",type:"danger"}:"success"===row[3][row[3].length-1].status?{text:"Success",type:"success"}:{text:"Unknown",type:"muted"};return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[selectingMany?(0,jsx_runtime.jsx)(src.Hw,{checked:selectedForRetry.includes(eventId),onChange:checked=>{checked?selectForRetry([eventId]):deselectForRetry([eventId])}}):null,(0,jsx_runtime.jsx)(src.oe,{type:getStatus().type,children:(0,utils.fm)(getStatus().text)}),(0,jsx_runtime.jsx)(src.d6,{items:[eventId?{label:"View event",to:urls.j.event(eventId,row[0].timestamp)}:null,{label:"Test event",onClick:()=>{var _configuration$name2;retryInvocation({eventId,globals:buildGlobals(row,groupTypes,null!==(_configuration$name2=configuration?.name)&&void 0!==_configuration$name2?_configuration$name2:"Unnamed")}),expandRow(eventId)}},{label:"View event in configuration tab",onClick:()=>{var _configuration$name3;setSampleGlobals(buildGlobals(row,groupTypes,null!==(_configuration$name3=configuration?.name)&&void 0!==_configuration$name3?_configuration$name3:"Unnamed")),toggleExpanded(!0),kea_router_lib.router.actions.push(urls.j.pipelineNode(types.We.Destination,"hog-"+id,types.il.Configuration))}}],children:(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{className:"rotate-90"}),loading:!!loadingRetries.includes(eventId)||void 0})})]})}},{title:"Event",key:"event",className:"max-w-80",render:(_,_ref12)=>{let[event]=_ref12;return event.event?(0,jsx_runtime.jsx)(PropertyKeyInfo.T,{value:event.event,type:TaxonomicFilter_types.t.Events}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"Person",key:"person",render:(_,_ref13)=>{let[,person]=_ref13;return person?(0,jsx_runtime.jsx)(PersonDisplay.I,{person:person,withIcon:!0}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"URL / Screen",key:"url",className:"max-w-80",render:(_,_ref14)=>{let[event]=_ref14;return event.properties.$current_url||event.properties.$screen_name?(0,jsx_runtime.jsx)("span",{children:event.properties.$current_url||event.properties.$screen_name}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"Library",key:"library",className:"max-w-80",render:(_,_ref15)=>{let[event]=_ref15;return event.properties.$lib?(0,jsx_runtime.jsx)("span",{children:event.properties.$lib}):(0,jsx_runtime.jsx)(EmptyColumn,{})}},{title:"Time",key:"time",className:"max-w-80",render:(_,_ref16)=>{let[event]=_ref16;return event.timestamp?(0,jsx_runtime.jsx)(TZLabel.w,{time:event.timestamp}):(0,jsx_runtime.jsx)(EmptyColumn,{})}}],emptyState:(0,jsx_runtime.jsx)(EmptyStates.dV,{})})}let PIPELINE_TAB_TO_NODE_STAGE={[types.J9.Transformations]:types.We.Transformation,[types.J9.Destinations]:types.We.Destination,[types.J9.SiteApps]:types.We.SiteApp,[types.J9.ImportApps]:types.We.ImportApp,[types.J9.Sources]:types.We.Source},paramsToProps=_ref=>{let{params:{stage,id}}=_ref,numericId=id&&/^\d+$/.test(id)?parseInt(id):void 0;if(!stage||!id)throw Error("Loaded PipelineNode without either `stage` or `id` passed in");return{stage:PIPELINE_TAB_TO_NODE_STAGE[stage]||null,id:numericId&&!isNaN(numericId)?numericId:id}},scene={component:PipelineNode,logic:pipelineNodeLogic.y,paramsToProps};function PipelineNode(){let params=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{stage,id}=paramsToProps({params}),{currentTab,node}=(0,index_esm.useValues)(pipelineNodeLogic.y),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.h);if(!stage)return(0,jsx_runtime.jsx)(NotFound.T,{object:"pipeline stage"});let tabToContent=node.backend===pipeline_types.b.ManagedSource?{[types.il.Schemas]:(0,jsx_runtime.jsx)(Schemas,{id:node.id}),[types.il.Syncs]:(0,jsx_runtime.jsx)(Syncs,{id:node.id}),...featureFlags[constants.y8.EDIT_DWH_SOURCE_CONFIG]?{[types.il.SourceConfiguration]:(0,jsx_runtime.jsx)(SourceConfiguration,{id:node.id})}:{}}:node.backend!==pipeline_types.b.SelfManagedSource?{[types.il.Configuration]:(0,jsx_runtime.jsx)(PipelineNodeConfiguration,{}),[types.il.Metrics]:node.backend===pipeline_types.b.HogFunction?(0,jsx_runtime.jsx)(AppMetricsV2,{id:node.id}):(0,jsx_runtime.jsx)(PipelineNodeMetrics,{id:id}),[types.il.Logs]:node.backend===pipeline_types.b.HogFunction?(0,jsx_runtime.jsx)(HogFunctionLogs,{hogFunctionId:id.toString().substring(4)}):(0,jsx_runtime.jsx)(PipelineNodeLogs,{id:id,stage:stage})}:{};return node.backend===pipeline_types.b.BatchExport&&(tabToContent[types.il.Runs]=(0,jsx_runtime.jsx)(BatchExportRuns,{id:node.id}),tabToContent[types.il.Backfills]=(0,jsx_runtime.jsx)(BatchExportBackfills,{id:node.id})),node.backend===pipeline_types.b.SelfManagedSource&&(tabToContent[types.il.SourceConfiguration]=(0,jsx_runtime.jsx)(SelfManaged,{id:node.id.toString()})),node.backend===pipeline_types.b.Plugin&&(tabToContent[types.il.History]=(0,jsx_runtime.jsx)(ActivityLog.D,{id:id,scope:types.jc.PLUGIN})),node.backend===pipeline_types.b.HogFunction&&(stage===types.We.Destination&&(tabToContent[types.il.Testing]=(0,jsx_runtime.jsx)(TestingMenu,{id:node.id})),tabToContent[types.il.History]=(0,jsx_runtime.jsx)(ActivityLog.D,{id:String(id).startsWith("hog-")?String(id).substring(4):id,scope:types.jc.HOG_FUNCTION})),stage===types.We.SiteApp&&(delete tabToContent[types.il.Logs],delete tabToContent[types.il.Metrics]),(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(PageHeader.m,{}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:currentTab,tabs:Object.entries(tabToContent).map(_ref2=>{let[tab,content]=_ref2;return{label:(0,utils.fm)(tab),key:tab,content:content,link:params.stage?urls.j.pipelineNode(stage,id,tab):void 0}})})]})}},"../../frontend/src/scenes/pipeline/PipelinePluginConfiguration.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{s:()=>PipelinePluginConfiguration});var posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.11.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),PageHeader=__webpack_require__("../../frontend/src/lib/components/PageHeader.tsx"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonMarkdown=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonMarkdown/index.ts"),CodeEditor=__webpack_require__("../../frontend/src/lib/monaco/CodeEditor.tsx"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),AutoSizer=__webpack_require__("../../node_modules/.pnpm/react-virtualized@9.22.5_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/react-virtualized/dist/es/AutoSizer/index.js"),configUtils=__webpack_require__("../../frontend/src/scenes/pipeline/configUtils.ts"),kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),api=__webpack_require__("../../frontend/src/lib/api.ts"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),types=__webpack_require__("../../frontend/src/types.ts"),destinations_constants=__webpack_require__("../../frontend/src/scenes/pipeline/destinations/constants.ts"),destinationsLogic=__webpack_require__("../../frontend/src/scenes/pipeline/destinations/destinationsLogic.tsx"),frontendAppsLogic=__webpack_require__("../../frontend/src/scenes/pipeline/frontendAppsLogic.tsx"),importAppsLogic=__webpack_require__("../../frontend/src/scenes/pipeline/importAppsLogic.tsx"),pipelineAccessLogic=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineAccessLogic.tsx"),transformationsLogic=__webpack_require__("../../frontend/src/scenes/pipeline/transformationsLogic.tsx"),utils=__webpack_require__("../../frontend/src/scenes/pipeline/utils.tsx");function getConfigurationFromPluginConfig(pluginConfig){return{...pluginConfig.config,enabled:pluginConfig.enabled,order:pluginConfig.order,name:pluginConfig.name?pluginConfig.name:pluginConfig.plugin_info.name,description:pluginConfig.description?pluginConfig.description:pluginConfig.plugin_info.description||""}}function getDefaultConfiguration(plugin){return{...(0,configUtils.NM)(plugin),enabled:!1,name:plugin.name,description:plugin.description}}let pipelinePluginConfigurationLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{pluginId,pluginConfigId}=_ref;return pluginConfigId?`ID:${pluginConfigId}`:`NEW:${pluginId}`}),(0,index_esm.path)(id=>["scenes","pipeline","pipelinePluginConfigurationLogic",id]),(0,index_esm.connect)(()=>({values:[teamLogic.teamLogic,["currentTeamId"],transformationsLogic.P,["plugins as transformationPlugins","nextAvailableOrder"],featureFlagLogic.h,["featureFlags"],pipelineAccessLogic.g,["canEnableNewDestinations"]]})),(0,kea_loaders_lib.loaders)(_ref2=>{let{props,values}=_ref2;return{pluginFromPluginId:[null,{loadPlugin:async()=>{if(!props.pluginId)return null;let plugins={};return props.stage===types.We.Transformation?plugins=await (0,utils.c$)("api/organizations/@current/pipeline_transformations"):props.stage===types.We.Destination&&(plugins=await (0,utils.c$)("api/organizations/@current/pipeline_destinations")),plugins[props.pluginId]||api.ZP.get(`api/organizations/@current/plugins/${props.pluginId}`)}}],pluginConfig:[null,{loadPluginConfig:async()=>props.pluginConfigId?await api.ZP.pluginConfigs.get(props.pluginConfigId):null,updatePluginConfig:async formdata=>{if(!values.plugin||!props.stage)return null;if((!values.pluginConfig||!values.pluginConfig.enabled&&formdata.enabled)&&props.stage===types.We.Destination&&!values.canEnableNewDestinations)return src.UJ.error("Data pipelines add-on is required for enabling new destinations."),values.pluginConfig;let{enabled,order,name,description,...config}=formdata,formData=(0,configUtils.Ge)(values.plugin.config_schema,(0,configUtils.NM)(values.plugin),config);formData.append("enabled",enabled),formData.append("name",name),formData.append("description",description);let orderFixed=enabled&&values.pluginConfig&&!values.pluginConfig.enabled?values.nextAvailableOrder:order||0;if(formData.append("order",orderFixed),props.pluginConfigId)return await api.ZP.pluginConfigs.update(props.pluginConfigId,formData);formData.append("plugin",values.plugin.id.toString());let res=await api.ZP.pluginConfigs.create(formData);return kea_router_lib.router.actions.replace(urls.j.pipelineNode(props.stage,res.id,types.il.Configuration)),res},migrateToHogFunction:async()=>{if(!props.pluginConfigId)return null;let hogFunction=await api.ZP.pluginConfigs.migrate(props.pluginConfigId);return kea_router_lib.router.actions.replace(urls.j.pipelineNode(types.We.Destination,`hog-${hogFunction.id}`)),values.pluginConfig}}]}}),(0,index_esm.listeners)(_ref3=>{let{props,actions,values}=_ref3;return{updatePluginConfigSuccess:_ref4=>{let{pluginConfig}=_ref4;pluginConfig&&(actions.resetConfiguration(values.configuration),props.stage===types.We.Transformation?transformationsLogic.P.findMounted()?.actions.updatePluginConfig(pluginConfig):props.stage===types.We.Destination?destinationsLogic.w.findMounted({types:destinations_constants.SO})?.actions.updatePluginConfig(pluginConfig):props.stage===types.We.SiteApp?values.featureFlags[constants.y8.SITE_APP_FUNCTIONS]?destinationsLogic.w.findMounted({types:destinations_constants.hz})?.actions.updatePluginConfig(pluginConfig):frontendAppsLogic.$.findMounted()?.actions.updatePluginConfig(pluginConfig):props.stage===types.We.ImportApp&&importAppsLogic.c.findMounted()?.actions.updatePluginConfig(pluginConfig))}}}),(0,index_esm.reducers)(()=>({configuration:[{},{loadPluginSuccess:(state,_ref5)=>{let{pluginFromPluginId}=_ref5;return Object.keys(state).length>0||!pluginFromPluginId?state:getDefaultConfiguration(pluginFromPluginId)},loadPluginConfigSuccess:(state,_ref6)=>{let{pluginConfig}=_ref6;return pluginConfig?getConfigurationFromPluginConfig(pluginConfig):state},updatePluginConfigSuccess:(state,_ref7)=>{let{pluginConfig}=_ref7;return pluginConfig?getConfigurationFromPluginConfig(pluginConfig):state}}]})),(0,index_esm.selectors)(()=>({plugin:[s=>[s.pluginFromPluginId,s.pluginConfig],(pluginFromId,pluginConfig)=>pluginConfig?.plugin_info||pluginFromId],loading:[s=>[s.pluginFromPluginIdLoading,s.pluginConfigLoading],(pluginLoading,pluginConfigLoading)=>pluginLoading||pluginConfigLoading],savedConfiguration:[s=>[s.pluginConfig,s.plugin],(pluginConfig,plugin)=>pluginConfig&&plugin?pluginConfig?getConfigurationFromPluginConfig(pluginConfig):plugin?getDefaultConfiguration(plugin):void 0:{}],requiredFields:[s=>[s.plugin,s.configuration],(plugin,configuration)=>plugin&&configuration?(0,configUtils.fY)(fieldName=>configuration[fieldName],plugin):[]],hiddenFields:[s=>[s.plugin,s.configuration],(plugin,configuration)=>plugin&&configuration?(0,configUtils.zl)(fieldName=>configuration[fieldName],plugin):[]],isNew:[(_,p)=>[p.pluginConfigId],pluginConfigId=>!pluginConfigId],stage:[(_,p)=>[p.stage],stage=>stage]})),(0,lib.forms)(_ref8=>{let{asyncActions,values}=_ref8;return{configuration:{errors:formdata=>Object.fromEntries(values.requiredFields.map(field=>[field,formdata[field]?void 0:"This field is required"])),submit:async formdata=>{await asyncActions.updatePluginConfig(formdata)}}}}),(0,kea_router_lib.beforeUnload)(_ref9=>{let{actions,values}=_ref9;return{enabled:()=>values.configurationChanged,message:"Leave action?\nChanges you made will be discarded.",onConfirm:()=>{actions.resetConfiguration()}}}),(0,index_esm.afterMount)(_ref10=>{let{props,actions}=_ref10;props.pluginConfigId?actions.loadPluginConfig():props.pluginId&&actions.loadPlugin()})]);var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function PipelinePluginConfiguration(_ref){let{stage,pluginId,pluginConfigId}=_ref,logicProps={stage:stage,pluginId:pluginId||null,pluginConfigId:pluginConfigId||null},logic=pipelinePluginConfigurationLogic(logicProps),{plugin,isNew,isConfigurationSubmitting,savedConfiguration,hiddenFields,requiredFields,loading,configurationChanged}=(0,index_esm.useValues)(logic),{submitConfiguration,resetConfiguration,migrateToHogFunction}=(0,index_esm.useActions)(logic);if(!stage)return(0,jsx_runtime.jsx)(NotFound.T,{object:"pipeline stage"});if(loading&&!plugin)return(0,jsx_runtime.jsx)(src.t2,{});if(!plugin)return(0,jsx_runtime.jsx)(NotFound.T,{object:`pipeline ${stage}`});let loadingOrSubmitting=loading||isConfigurationSubmitting,fields=(0,configUtils.fN)(plugin.config_schema).map((fieldConfig,index)=>(0,jsx_runtime.jsx)(react.Fragment,{children:fieldConfig.key&&fieldConfig.type&&(0,configUtils.Zs)(fieldConfig)&&!hiddenFields.includes(fieldConfig.key)?(0,jsx_runtime.jsx)(LemonField.D,{name:fieldConfig.key,label:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[fieldConfig.secret&&(0,jsx_runtime.jsx)(src.u,{placement:"top-start",title:"This field is write-only. Its value won't be visible after saving.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconLock,{})}),fieldConfig.markdown&&(0,jsx_runtime.jsx)(LemonMarkdown.j,{children:fieldConfig.markdown}),fieldConfig.name||fieldConfig.key]}),help:fieldConfig.hint&&(0,jsx_runtime.jsx)(LemonMarkdown.j,{className:"mt-0.5",children:fieldConfig.hint}),showOptional:!requiredFields.includes(fieldConfig.key),children:(0,jsx_runtime.jsx)(PluginField,{fieldConfig:fieldConfig,disabled:loadingOrSubmitting})}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:fieldConfig.type?(0,jsx_runtime.jsxs)("p",{className:"text-danger",children:["Invalid config field ",(0,jsx_runtime.jsx)("i",{children:fieldConfig.name||fieldConfig.key}),"."]}):null})},fieldConfig.key||`__key__${index}`)),buttons=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",htmlType:"reset",onClick:()=>resetConfiguration(savedConfiguration||{}),disabledReason:configurationChanged?isConfigurationSubmitting?"Saving in progress…":void 0:"No changes",children:"Clear changes"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",htmlType:"submit",onClick:submitConfiguration,loading:isConfigurationSubmitting,children:isNew?"Create":"Save"})]});return(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-3",children:[(0,jsx_runtime.jsx)(PageHeader.m,{buttons:buttons}),plugin?.hog_function_migration_available&&(0,jsx_runtime.jsxs)(src.Vp,{type:"error",action:{children:"Upgrade to new version",onClick:()=>src.dn.open({title:"Upgrade destination",width:"30rem",description:"This will create a new Destination in the upgraded system. The old destination will be disabled and can later be deleted. In addition there may be slight differences in the configuration options that you can choose to modify.",secondaryButton:{type:"secondary",children:"Cancel"},primaryButton:{type:"primary",onClick:()=>migrateToHogFunction(),children:"Upgrade"}}),disabled:loading},children:[(0,jsx_runtime.jsx)("b",{children:"New version available!"})," This destination is part of our legacy system. Click to upgrade."]}),(0,jsx_runtime.jsx)(lib.Form,{logic:pipelinePluginConfigurationLogic,props:logicProps,formKey:"configuration",className:"deprecated-space-y-3",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-4 items-start",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-4 flex-1 min-w-100",children:[(0,jsx_runtime.jsxs)("div",{className:"border bg-surface-primary rounded p-3 deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-2 min-h-16 items-center",children:[(0,jsx_runtime.jsx)(utils.Wf,{plugin:plugin,imageSize:"medium"}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col py-1 flex-1",children:[(0,jsx_runtime.jsx)("div",{className:"flex flex-row items-center font-semibold text-sm gap-1",children:plugin.name}),plugin.description?(0,jsx_runtime.jsx)("div",{className:"text-text-3000 text-xs text-tertiary mt-1",children:(0,jsx_runtime.jsx)(LemonMarkdown.j,{className:"max-w-[30rem]",lowKeyHeadings:!0,children:plugin.description})}):null]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"enabled",children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(src.f4,{label:"Enabled",onChange:()=>onChange(!value),checked:value,disabled:loadingOrSubmitting,bordered:!0})}})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",info:"Customising the name can be useful if multiple instances of the same type are used.",children:(0,jsx_runtime.jsx)(src.DF,{type:"text",disabled:loadingOrSubmitting})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"description",label:"Description",info:"Add a description to share context with other team members",children:(0,jsx_runtime.jsx)(src._V,{disabled:loadingOrSubmitting})})]})," "]}),(0,jsx_runtime.jsxs)("div",{className:"flex-2 min-w-100 deprecated-space-y-4",children:[(0,jsx_runtime.jsx)("div",{className:"border bg-surface-primary rounded p-3  deprecated-space-y-2",children:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:fields.length?fields:(0,jsx_runtime.jsx)("span",{className:"italic text-secondary",children:"This app does not have specific configuration options"})})}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 justify-end",children:buttons})]})]})})]})}function PluginField(_ref3){let{value,onChange,fieldConfig,disabled}=_ref3,[editingSecret,setEditingSecret]=(0,react.useState)(!1);return fieldConfig.secret&&!editingSecret&&value&&(value===configUtils.ue||value.name===configUtils.ue)?(0,jsx_runtime.jsxs)(src.Jp,{type:"secondary",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{}),onClick:()=>{onChange?.(fieldConfig.default||""),setEditingSecret(!0)},disabled:disabled,children:["Reset secret ","attachment"===fieldConfig.type?"attachment":"field"]}):"attachment"===fieldConfig.type?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[value?.name?(0,jsx_runtime.jsxs)("span",{children:["Selected file: ",value.name]}):null,(0,jsx_runtime.jsx)(src.mH,{accept:"*",multiple:!1,onChange:files=>onChange?.(files[0]),value:value?.size?[value]:[],showUploadedFiles:!1})]}):"string"===fieldConfig.type?(0,jsx_runtime.jsx)(src.DF,{value:value,onChange:onChange,autoFocus:editingSecret,className:"ph-no-capture",disabled:disabled}):"json"===fieldConfig.type?(0,jsx_runtime.jsx)(JsonConfigField,{value:value,onChange:onChange,autoFocus:editingSecret,className:"ph-no-capture"}):"choice"===fieldConfig.type?(0,jsx_runtime.jsx)(src.Yv,{fullWidth:!0,value:value,className:"ph-no-capture",onChange:onChange,options:fieldConfig.choices.map(choice=>({label:choice,value:choice})),disabled:disabled}):(0,jsx_runtime.jsxs)("strong",{className:"text-danger",children:['Unknown field type "',(0,jsx_runtime.jsx)("code",{children:fieldConfig.type}),'".',(0,jsx_runtime.jsx)("br",{}),"You may need to upgrade PostHog!"]})}function JsonConfigField(props){return(0,jsx_runtime.jsx)(AutoSizer.q,{disableWidth:!0,className:"min-h-60",children:_ref4=>{let{height}=_ref4;return(0,jsx_runtime.jsx)(CodeEditor.p,{className:"border",language:"json",value:props.value,onChange:v=>props.onChange?.(null!=v?v:""),height:height,options:{minimap:{enabled:!1}}})}})}},"../../frontend/src/scenes/pipeline/batch-exports/utils.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{x:()=>humanizeBatchExportName});let humanizeBatchExportName=service=>"HTTP"===service?"PostHog HTTP":service},"../../frontend/src/scenes/pipeline/frontendAppsLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{$:()=>frontendAppsLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/api.ts"),scenes_projectLogic__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/scenes/projectLogic.ts"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/types.ts"),_types__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/pipeline/types.ts"),_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/scenes/pipeline/utils.tsx");let frontendAppsLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","pipeline","frontendAppsLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)({values:[scenes_projectLogic__WEBPACK_IMPORTED_MODULE_3__.K,["currentProjectId"],scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__.userLogic,["user"]]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({loadPluginConfigs:!0,updatePluginConfig:pluginConfig=>({pluginConfig})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref=>{let{values}=_ref;return{plugins:[{},{loadPlugins:async()=>(0,_utils__WEBPACK_IMPORTED_MODULE_7__.c$)("api/organizations/@current/pipeline_frontend_apps")}],pluginConfigs:[{},{loadPluginConfigs:async()=>Object.fromEntries((await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.loadPaginatedResults(`api/projects/${values.currentProjectId}/pipeline_frontend_apps_configs`)).map(pluginConfig=>[pluginConfig.id,pluginConfig])),toggleEnabled:async _ref2=>{let{id,enabled}=_ref2;if(!(0,_utils__WEBPACK_IMPORTED_MODULE_7__.FH)(_types__WEBPACK_IMPORTED_MODULE_5__.We.SiteApp,enabled))return values.pluginConfigs;let{pluginConfigs,plugins}=values,pluginConfig=pluginConfigs[id],plugin=plugins[pluginConfig.plugin];(0,_utils__WEBPACK_IMPORTED_MODULE_7__.SO)(`plugin ${enabled?"enabled":"disabled"}`,plugin,pluginConfig);let response=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.update(`api/plugin_config/${id}`,{enabled});return{...pluginConfigs,[id]:response}},updatePluginConfig:_ref3=>{let{pluginConfig}=_ref3;return{...values.pluginConfigs,[pluginConfig.id]:pluginConfig}}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({loading:[s=>[s.pluginsLoading,s.pluginConfigsLoading],(pluginsLoading,pluginConfigsLoading)=>pluginsLoading||pluginConfigsLoading],frontendApps:[s=>[s.plugins,s.pluginConfigs],(plugins,pluginConfigs)=>Object.values(pluginConfigs).map(pluginConfig=>({...pluginConfig,plugin_info:plugins[pluginConfig.plugin]||null})).map(t=>(0,_types__WEBPACK_IMPORTED_MODULE_6__.n)(t,_types__WEBPACK_IMPORTED_MODULE_5__.We.SiteApp)).sort((a,b)=>Number(b.enabled)-Number(a.enabled))]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref4=>{let{actions}=_ref4;actions.loadPlugins(),actions.loadPluginConfigs()})])},"../../frontend/src/scenes/pipeline/importAppsLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{c:()=>importAppsLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/api.ts"),scenes_projectLogic__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/scenes/projectLogic.ts"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/types.ts"),_types__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/pipeline/types.ts"),_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/scenes/pipeline/utils.tsx");let importAppsLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","pipeline","importAppsLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)({values:[scenes_projectLogic__WEBPACK_IMPORTED_MODULE_3__.K,["currentProjectId"],scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__.userLogic,["user"]]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({loadPluginConfigs:!0,updatePluginConfig:pluginConfig=>({pluginConfig})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref=>{let{values}=_ref;return{plugins:[{},{loadPlugins:async()=>(0,_utils__WEBPACK_IMPORTED_MODULE_7__.c$)("api/organizations/@current/pipeline_import_apps")}],pluginConfigs:[{},{loadPluginConfigs:async()=>Object.fromEntries((await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.loadPaginatedResults(`api/projects/${values.currentProjectId}/pipeline_import_apps_configs`)).map(pluginConfig=>[pluginConfig.id,pluginConfig])),toggleEnabled:async _ref2=>{let{id,enabled}=_ref2;if(!(0,_utils__WEBPACK_IMPORTED_MODULE_7__.FH)(_types__WEBPACK_IMPORTED_MODULE_5__.We.ImportApp,enabled))return values.pluginConfigs;let{pluginConfigs,plugins}=values,pluginConfig=pluginConfigs[id],plugin=plugins[pluginConfig.plugin];(0,_utils__WEBPACK_IMPORTED_MODULE_7__.SO)(`plugin ${enabled?"enabled":"disabled"}`,plugin,pluginConfig);let response=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.update(`api/plugin_config/${id}`,{enabled});return{...pluginConfigs,[id]:response}},updatePluginConfig:_ref3=>{let{pluginConfig}=_ref3;return{...values.pluginConfigs,[pluginConfig.id]:pluginConfig}}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({loading:[s=>[s.pluginsLoading,s.pluginConfigsLoading],(pluginsLoading,pluginConfigsLoading)=>pluginsLoading||pluginConfigsLoading],importApps:[s=>[s.plugins,s.pluginConfigs],(plugins,pluginConfigs)=>Object.values(pluginConfigs).map(pluginConfig=>({...pluginConfig,plugin_info:plugins[pluginConfig.plugin]||null})).map(t=>(0,_types__WEBPACK_IMPORTED_MODULE_6__.n)(t,_types__WEBPACK_IMPORTED_MODULE_5__.We.ImportApp)).sort((a,b)=>Number(b.enabled)-Number(a.enabled))],hasEnabledImportApps:[s=>[s.importApps],importApps=>importApps.some(app=>app.enabled)]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref4=>{let{actions}=_ref4;actions.loadPlugins(),actions.loadPluginConfigs()})])},"../../frontend/src/scenes/pipeline/pipelineBatchExportConfigurationLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{t:()=>pipelineBatchExportConfigurationLogic,z:()=>getDefaultConfiguration});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.5_react@18.2.0_/node_modules/kea-forms/lib/index.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../node_modules/.pnpm/kea-router@3.2.1_kea@3.1.5_react@18.2.0_/node_modules/kea-router/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/lib/api.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/urls.ts"),_types__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/types.ts"),_batch_exports_utils__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("../../frontend/src/scenes/pipeline/batch-exports/utils.ts"),_destinations_constants__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("../../frontend/src/scenes/pipeline/destinations/constants.ts"),_destinations_destinationsLogic__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../frontend/src/scenes/pipeline/destinations/destinationsLogic.tsx"),_pipelineAccessLogic__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../frontend/src/scenes/pipeline/pipelineAccessLogic.tsx");function getConfigurationFromBatchExportConfig(batchExportConfig){return{name:batchExportConfig.name,destination:batchExportConfig.destination.type,paused:batchExportConfig.paused,interval:batchExportConfig.interval,model:batchExportConfig.model,filters:batchExportConfig.filters,...batchExportConfig.destination.config}}function getDefaultConfiguration(service){return{name:(0,_batch_exports_utils__WEBPACK_IMPORTED_MODULE_10__.x)(service),destination:service,model:"events",paused:!0,..."Snowflake"===service&&{authentication_type:"password"}}}function getEventTable(service){return{type:"batch_export",id:"Events",name:"events",fields:{uuid:{name:"uuid",hogql_value:"toString(uuid)",type:"string",schema_valid:!0},timestamp:{name:"timestamp",hogql_value:"timestamp",type:"datetime",schema_valid:!0},event:{name:"event",hogql_value:"event",type:"string",schema_valid:!0},distinct_id:{name:"distinct_id",hogql_value:"toString(distinct_id)",type:"string",schema_valid:!0},properties:{name:"properties",hogql_value:"properties",type:"json",schema_valid:!0},..."S3"==service&&{person_id:{name:"person_id",hogql_value:"toString(person_id)",type:"string",schema_valid:!0},person_properties:{name:"person_properties",hogql_value:"nullIf(person_properties, '')",type:"string",schema_valid:!0},created_at:{name:"created_at",hogql_value:"created_at",type:"datetime",schema_valid:!0}},..."S3"!=service&&{team_id:{name:"team_id",hogql_value:"Postgres"==service||"Redshift"==service?"toInt32(team_id)":"team_id",type:"integer",schema_valid:!0},set:{name:"Snowflake"==service?"people_set":"set",hogql_value:"nullIf(JSONExtractString(properties, '$set'), '')",type:"string",schema_valid:!0},set_once:{name:"Snowflake"==service?"people_set_once":"set_once",hogql_value:"nullIf(JSONExtractString(properties, '$set_once'), '')",type:"string",schema_valid:!0},site_url:{name:"site_url",hogql_value:"''",type:"string",schema_valid:!0},ip:{name:"ip",hogql_value:"nullIf(JSONExtractString(properties, '$ip'), '')",type:"string",schema_valid:!0},elements_chain:{name:"elements",hogql_value:"toJSONString(elements_chain)",type:"string",schema_valid:!0}},..."BigQuery"==service&&{bq_ingested_timestamp:{name:"bq_ingested_timestamp",hogql_value:"NOW64()",type:"datetime",schema_valid:!0}}}}}let personsTable={type:"batch_export",id:"Persons",name:"persons",fields:{team_id:{name:"team_id",hogql_value:"team_id",type:"integer",schema_valid:!0},distinct_id:{name:"distinct_id",hogql_value:"distinct_id",type:"string",schema_valid:!0},person_id:{name:"person_id",hogql_value:"person_id",type:"string",schema_valid:!0},properties:{name:"properties",hogql_value:"properties",type:"json",schema_valid:!0},person_version:{name:"person_version",hogql_value:"person_version",type:"integer",schema_valid:!0},person_distinct_id_version:{name:"person_distinct_id_version",hogql_value:"person_distinct_id_version",type:"integer",schema_valid:!0},created_at:{name:"created_at",hogql_value:"created_at",type:"datetime",schema_valid:!0},is_deleted:{name:"is_deleted",hogql_value:"is_deleted",type:"boolean",schema_valid:!0}}},sessionsTable={type:"batch_export",id:"Sessions",name:"sessions",fields:{team_id:{name:"team_id",hogql_value:"team_id",type:"integer",schema_valid:!0},session_id:{name:"session_id",type:"string",hogql_value:"session_id",schema_valid:!0},session_id_v7:{name:"session_id_v7",type:"integer",hogql_value:"session_id_v7",schema_valid:!0},distinct_id:{name:"distinct_id",type:"string",hogql_value:"distinct_id",schema_valid:!0},start_timestamp:{name:"start_timestamp",type:"datetime",hogql_value:"start_timestamp",schema_valid:!0},end_timestamp:{name:"end_timestamp",type:"datetime",hogql_value:"end_timestamp",schema_valid:!0},urls:{name:"urls",type:"array",hogql_value:"urls",schema_valid:!0},num_uniq_urls:{name:"num_uniq_urls",type:"integer",hogql_value:"num_uniq_urls",schema_valid:!0},entry_current_url:{name:"entry_current_url",type:"string",hogql_value:"entry_current_url",schema_valid:!0},entry_pathname:{name:"entry_pathname",type:"string",hogql_value:"entry_pathname",schema_valid:!0},entry_hostname:{name:"entry_hostname",type:"string",hogql_value:"entry_hostname",schema_valid:!0},end_current_url:{name:"end_current_url",type:"string",hogql_value:"end_current_url",schema_valid:!0},end_pathname:{name:"end_pathname",type:"string",hogql_value:"end_pathname",schema_valid:!0},end_hostname:{name:"end_hostname",type:"string",hogql_value:"end_hostname",schema_valid:!0},entry_utm_source:{name:"entry_utm_source",type:"string",hogql_value:"entry_utm_source",schema_valid:!0},entry_utm_campaign:{name:"entry_utm_campaign",type:"string",hogql_value:"entry_utm_campaign",schema_valid:!0},entry_utm_medium:{name:"entry_utm_medium",type:"string",hogql_value:"entry_utm_medium",schema_valid:!0},entry_utm_term:{name:"entry_utm_term",type:"string",hogql_value:"entry_utm_term",schema_valid:!0},entry_utm_content:{name:"entry_utm_content",type:"string",hogql_value:"entry_utm_content",schema_valid:!0},entry_referring_domain:{name:"entry_referring_domain",type:"string",hogql_value:"entry_referring_domain",schema_valid:!0},entry_gclid:{name:"entry_gclid",type:"string",hogql_value:"entry_gclid",schema_valid:!0},entry_fbclid:{name:"entry_fbclid",type:"string",hogql_value:"entry_fbclid",schema_valid:!0},entry_gad_source:{name:"entry_gad_source",type:"string",hogql_value:"entry_gad_source",schema_valid:!0},pageview_count:{name:"pageview_count",type:"integer",hogql_value:"pageview_count",schema_valid:!0},autocapture_count:{name:"autocapture_count",type:"integer",hogql_value:"autocapture_count",schema_valid:!0},screen_count:{name:"screen_count",type:"integer",hogql_value:"screen_count",schema_valid:!0},channel_type:{name:"channel_type",type:"string",hogql_value:"channel_type",schema_valid:!0},session_duration:{name:"session_duration",type:"integer",hogql_value:"session_duration",schema_valid:!0},duration:{name:"duration",type:"integer",hogql_value:"duration",schema_valid:!0},is_bounce:{name:"is_bounce",type:"boolean",hogql_value:"is_bounce",schema_valid:!0},last_external_click_url:{name:"last_external_click_url",type:"string",hogql_value:"last_external_click_url",schema_valid:!0},page_screen_autocapture_count_up_to:{name:"page_screen_autocapture_count_up_to",type:"string",hogql_value:"page_screen_autocapture_count_up_to",schema_valid:!0},exit_current_url:{name:"exit_current_url",type:"string",hogql_value:"exit_current_url",schema_valid:!0},exit_pathname:{name:"exit_pathname",type:"string",hogql_value:"exit_pathname",schema_valid:!0},vital_lcp:{name:"vital_lcp",type:"float",hogql_value:"vital_lcp",schema_valid:!0}}},pipelineBatchExportConfigurationLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.key)(_ref=>{let{service,id}=_ref;return id?`ID:${id}`:`NEW:${service}`}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(id=>["scenes","pipeline","pipelineBatchExportConfigurationLogic",id]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.connect)(()=>({values:[_pipelineAccessLogic__WEBPACK_IMPORTED_MODULE_9__.g,["canEnableNewDestinations"]]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({setSavedConfiguration:configuration=>({configuration}),setSelectedModel:model=>({model})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_3__.loaders)(_ref2=>{let{props,actions}=_ref2;return{batchExportConfig:[null,{loadBatchExportConfig:async()=>props.id?await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.get(props.id):null,updateBatchExportConfig:async formdata=>{let{name,destination,interval,paused,created_at,start_at,end_at,model,filters,...config}=formdata,data={paused,name,interval,model,filters,destination:{type:destination,config:config}};if(props.id){let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.update(props.id,data);return _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.UJ.success("Batch export configuration updated successfully"),res}let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.create(data);return actions.resetConfiguration(getConfigurationFromBatchExportConfig(res)),kea_router__WEBPACK_IMPORTED_MODULE_4__.router.actions.replace(scenes_urls__WEBPACK_IMPORTED_MODULE_6__.j.pipelineNode(_types__WEBPACK_IMPORTED_MODULE_7__.We.Destination,res.id,_types__WEBPACK_IMPORTED_MODULE_7__.il.Configuration)),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.UJ.success("Batch export created successfully"),res}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.reducers)(_ref3=>{let{props}=_ref3;return{tables:[props.service?[getEventTable(props.service),personsTable,sessionsTable]:[],{loadBatchExportConfigSuccess:(state,_ref4)=>{let{batchExportConfig}=_ref4;return batchExportConfig?[getEventTable(batchExportConfig.destination.type),personsTable,sessionsTable]:state},updateBatchExportConfigSuccess:(state,_ref5)=>{let{batchExportConfig}=_ref5;return batchExportConfig?[getEventTable(batchExportConfig.destination.type),personsTable,sessionsTable]:state}}],selectedModel:["events",{setSelectedModel:(_,_ref6)=>{let{model}=_ref6;return model},loadBatchExportConfigSuccess:(state,_ref7)=>{let{batchExportConfig}=_ref7;return batchExportConfig?batchExportConfig.model:state},updateBatchExportConfigSuccess:(state,_ref8)=>{let{batchExportConfig}=_ref8;return batchExportConfig?batchExportConfig.model:state}}],configuration:[props.service?getDefaultConfiguration(props.service):{},{loadBatchExportConfigSuccess:(state,_ref9)=>{let{batchExportConfig}=_ref9;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state},updateBatchExportConfigSuccess:(state,_ref10)=>{let{batchExportConfig}=_ref10;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state}}],savedConfiguration:[{},{loadBatchExportConfigSuccess:(state,_ref11)=>{let{batchExportConfig}=_ref11;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state},updateBatchExportConfigSuccess:(state,_ref12)=>{let{batchExportConfig}=_ref12;return batchExportConfig?getConfigurationFromBatchExportConfig(batchExportConfig):state}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.selectors)(()=>({service:[(s,p)=>[s.batchExportConfig,p.service],(config,service)=>config?.destination.type||service],isNew:[(_,p)=>[p.id],id=>!id],requiredFields:[s=>[s.service,s.isNew,s.configuration],(service,isNew,config)=>{let generalRequiredFields=["interval","name","model"];if("Postgres"===service||"Redshift"===service)return[...generalRequiredFields,...isNew?["user"]:[],...isNew?["password"]:[],"host","port","database","schema","table_name"];if("S3"===service)return[...generalRequiredFields,"bucket_name","region","prefix",...isNew?["aws_access_key_id"]:[],...isNew?["aws_secret_access_key"]:[],...isNew?["file_format"]:[]];if("BigQuery"===service)return[...generalRequiredFields,...isNew?["json_config_file"]:[],"dataset_id","table_id"];if("HTTP"===service)return[...generalRequiredFields,"url","token"];else if("Snowflake"===service)return[...generalRequiredFields,"account","database","warehouse",...isNew?["user"]:[],...isNew&&"password"==config.authentication_type?["password"]:[],...isNew&&"keypair"==config.authentication_type?["private_key"]:[],"schema","table_name"];return generalRequiredFields}]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.listeners)(_ref13=>{let{values,actions}=_ref13;return{updateBatchExportConfigSuccess:_ref14=>{let{batchExportConfig}=_ref14;batchExportConfig&&(actions.resetConfiguration(getConfigurationFromBatchExportConfig(batchExportConfig)),_destinations_destinationsLogic__WEBPACK_IMPORTED_MODULE_8__.w.findMounted({types:_destinations_constants__WEBPACK_IMPORTED_MODULE_11__.SO})?.actions.updateBatchExportConfig(batchExportConfig))},setConfigurationValue:async _ref15=>{let{name,value}=_ref15;if("json_config_file"===name[0]&&value)try{let loadedFile=await new Promise((resolve,reject)=>{let filereader=new FileReader;filereader.onload=e=>resolve(e.target?.result),filereader.onerror=e=>reject(e),filereader.readAsText(value[0])}),jsonConfig=JSON.parse(loadedFile);actions.setConfigurationValues({...values.configuration,project_id:jsonConfig.project_id,private_key:jsonConfig.private_key,private_key_id:jsonConfig.private_key_id,client_email:jsonConfig.client_email,token_uri:jsonConfig.token_uri})}catch(e){actions.setConfigurationManualErrors({json_config_file:"The config file is not valid"})}}}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_2__.forms)(_ref16=>{let{asyncActions,values}=_ref16;return{configuration:{errors:formdata=>Object.fromEntries(values.requiredFields.map(field=>[field,formdata[field]?void 0:"This field is required"])),submit:async formdata=>{await asyncActions.updateBatchExportConfig(formdata)}}}}),(0,kea_router__WEBPACK_IMPORTED_MODULE_4__.beforeUnload)(_ref17=>{let{actions,values}=_ref17;return{enabled:()=>values.configurationChanged,message:"Leave action?\nChanges you made will be discarded.",onConfirm:()=>{values.batchExportConfig?actions.resetConfiguration(getConfigurationFromBatchExportConfig(values.batchExportConfig)):values.service?actions.resetConfiguration(getDefaultConfiguration(values.service)):actions.resetConfiguration()}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.afterMount)(_ref18=>{let{actions}=_ref18;actions.loadBatchExportConfig()})])},"../../frontend/src/scenes/pipeline/pipelineNodeMetricsLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{j:()=>pipelineNodeMetricsLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/api.ts"),lib_utils__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/lib/utils.tsx"),scenes_projectLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/scenes/projectLogic.ts");let pipelineNodeMetricsLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.key)(_ref=>{let{id}=_ref;return id}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(id=>["scenes","pipeline","appMetricsLogic",id]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)({values:[scenes_projectLogic__WEBPACK_IMPORTED_MODULE_4__.K,["currentProjectId"]]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({setDateRange:(from,to)=>({from,to}),openErrorDetailsModal:errorType=>({errorType}),closeErrorDetailsModal:!0}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref2=>{let{values,props}=_ref2;return{appMetricsResponse:[null,{loadMetrics:async()=>{let params=(0,lib_utils__WEBPACK_IMPORTED_MODULE_3__.oZ)({date_from:values.dateRange.from,date_to:values.dateRange.to});return await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.get(`api/projects/${values.currentProjectId}/app_metrics/${props.id}?${params}`)}}],errorDetails:[[],{openErrorDetailsModal:async _ref3=>{let{errorType}=_ref3,params=(0,lib_utils__WEBPACK_IMPORTED_MODULE_3__.oZ)({error_type:errorType}),{result}=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.get(`api/projects/${values.currentProjectId}/app_metrics/${props.id}/error_details?${params}`);return result}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({dateRange:[{from:"-7d",to:null},{setDateRange:(_,_ref4)=>{let{from,to}=_ref4;return{from:null!=from?from:"-7d",to:to}}}],errorDetailsModalError:[null,{openErrorDetailsModal:(_,_ref5)=>{let{errorType}=_ref5;return errorType},closeErrorDetailsModal:()=>null}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref6=>{let{actions}=_ref6;return{setDateRange:()=>{actions.loadMetrics()}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref7=>{let{actions}=_ref7;actions.loadMetrics()})])},"../../frontend/src/scenes/pipeline/transformationsLogic.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{P:()=>pipelineTransformationsLogic});var kea__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../frontend/src/lib/api.ts"),scenes_projectLogic__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../frontend/src/scenes/projectLogic.ts"),scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../frontend/src/scenes/userLogic.ts"),_types__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../frontend/src/types.ts"),_types__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../frontend/src/scenes/pipeline/types.ts"),_utils__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../frontend/src/scenes/pipeline/utils.tsx");let pipelineTransformationsLogic=(0,kea__WEBPACK_IMPORTED_MODULE_0__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_0__.path)(["scenes","pipeline","transformationsLogic"]),(0,kea__WEBPACK_IMPORTED_MODULE_0__.connect)({values:[scenes_projectLogic__WEBPACK_IMPORTED_MODULE_3__.K,["currentProjectId"],scenes_userLogic__WEBPACK_IMPORTED_MODULE_4__.userLogic,["user"]]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.actions)({loadPluginConfigs:!0,openReorderModal:!0,closeReorderModal:!0,setTemporaryOrder:tempOrder=>({tempOrder}),savePluginConfigsOrder:newOrders=>({newOrders}),updatePluginConfig:pluginConfig=>({pluginConfig})}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_1__.loaders)(_ref=>{let{values}=_ref;return{plugins:[{},{loadPlugins:async()=>(0,_utils__WEBPACK_IMPORTED_MODULE_7__.c$)("api/organizations/@current/pipeline_transformations")}],temporaryOrder:[{},{setTemporaryOrder:async _ref2=>{let{tempOrder}=_ref2;return tempOrder},closeReorderModal:async()=>({})}],pluginConfigs:[{},{loadPluginConfigs:async()=>Object.fromEntries((await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.loadPaginatedResults(`api/projects/${values.currentProjectId}/pipeline_transformation_configs`)).map(pluginConfig=>[pluginConfig.id,pluginConfig])),savePluginConfigsOrder:async _ref3=>{let{newOrders}=_ref3;if(!(0,_utils__WEBPACK_IMPORTED_MODULE_7__.FH)(_types__WEBPACK_IMPORTED_MODULE_5__.We.Transformation,!1))return values.pluginConfigs;let{pluginConfigs}=values,response=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.update("api/plugin_config/rearrange",{orders:newOrders}),newPluginConfigs={...pluginConfigs};for(let pluginConfig of response)Object.keys(values.plugins).map(Number).includes(pluginConfig.plugin)&&(newPluginConfigs[pluginConfig.id]=pluginConfig);return newPluginConfigs},toggleEnabled:async _ref4=>{let{id,enabled}=_ref4;if(!(0,_utils__WEBPACK_IMPORTED_MODULE_7__.FH)(_types__WEBPACK_IMPORTED_MODULE_5__.We.Transformation,enabled))return values.pluginConfigs;let{pluginConfigs,plugins}=values,pluginConfig=pluginConfigs[id],plugin=plugins[pluginConfig.plugin];(0,_utils__WEBPACK_IMPORTED_MODULE_7__.SO)(`plugin ${enabled?"enabled":"disabled"}`,plugin,pluginConfig);let order={};enabled&&(order={order:values.nextAvailableOrder});let response=await lib_api__WEBPACK_IMPORTED_MODULE_2__.ZP.update(`api/plugin_config/${id}`,{enabled,...order});return{...pluginConfigs,[id]:response}},updatePluginConfig:_ref5=>{let{pluginConfig}=_ref5;return{...values.pluginConfigs,[pluginConfig.id]:pluginConfig}}}]}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.selectors)({loading:[s=>[s.pluginsLoading,s.pluginConfigsLoading],(pluginsLoading,pluginConfigsLoading)=>pluginsLoading||pluginConfigsLoading],transformations:[s=>[s.pluginConfigs,s.plugins],(pluginConfigs,plugins)=>Object.values(pluginConfigs).map(pluginConfig=>({...pluginConfig,plugin_info:plugins[pluginConfig.plugin]||null})).map(t=>(0,_types__WEBPACK_IMPORTED_MODULE_6__.n)(t,_types__WEBPACK_IMPORTED_MODULE_5__.We.Transformation))],sortedEnabledTransformations:[s=>[s.transformations,s.temporaryOrder],(transformations,temporaryOrder)=>(transformations=transformations.filter(t=>t.enabled),transformations=temporaryOrder&&Object.keys(temporaryOrder).length>0?Object.entries(temporaryOrder).sort((_ref6,_ref7)=>{let[,aIdx]=_ref6,[,bIdx]=_ref7;return aIdx-bIdx}).map(_ref8=>{let[pluginId]=_ref8;return transformations.find(t=>t.id===Number(pluginId))}):transformations.sort((a,b)=>a.order-b.order))],sortedTransformations:[s=>[s.transformations,s.sortedEnabledTransformations],(transformations,sortedEnabledTransformations)=>sortedEnabledTransformations.concat(transformations.filter(t=>!t.enabled).sort((a,b)=>a.id-b.id))],nextAvailableOrder:[s=>[s.transformations],transformations=>{let enabledTransformations=transformations.filter(t=>t.enabled);return enabledTransformations.length>0?Math.max(...enabledTransformations.map(t=>t.order),0)+1:0}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.reducers)({reorderModalOpen:[!1,{openReorderModal:()=>!0,closeReorderModal:()=>!1}]}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.listeners)(_ref9=>{let{actions}=_ref9;return{savePluginConfigsOrderSuccess:()=>{actions.closeReorderModal()}}}),(0,kea__WEBPACK_IMPORTED_MODULE_0__.afterMount)(_ref10=>{let{actions}=_ref10;actions.loadPlugins(),actions.loadPluginConfigs()})])}}]);
//# sourceMappingURL=81045.a68e7284.iframe.bundle.js.map