(window.webpackJsonp=window.webpackJsonp||[]).push([[259],{"./frontend/src/scenes/instance/AsyncMigrations/AsyncMigrations.tsx":function(ye,L,i){"use strict";i.r(L),i.d(L,"scene",function(){return oe}),i.d(L,"AsyncMigrations",function(){return G});var ve=i("./node_modules/core-js/modules/es.symbol.js"),Ee=i("./node_modules/core-js/modules/es.symbol.description.js"),Me=i("./node_modules/core-js/modules/es.array.map.js"),Se=i("./node_modules/core-js/modules/es.function.name.js"),k=i("./node_modules/react/index.js"),e=i.n(k),x=i("./frontend/src/lib/components/PageHeader.tsx"),$=i("./node_modules/antd/es/tabs/index.js"),J=i("./node_modules/antd/es/progress/index.js"),W=i("./node_modules/antd/es/button/index.js"),Q=i("./node_modules/antd/es/space/index.js"),b=i("./node_modules/kea/lib/index.esm.js"),X=i("./node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js"),he=i("./node_modules/core-js/modules/es.array.filter.js"),Ae=i("./node_modules/core-js/modules/es.array.includes.js"),be=i("./node_modules/core-js/modules/es.array.iterator.js"),je=i("./node_modules/core-js/modules/es.array.some.js"),Re=i("./node_modules/core-js/modules/es.object.to-string.js"),Ie=i("./node_modules/core-js/modules/es.string.includes.js"),Oe=i("./node_modules/core-js/modules/web.dom-collections.iterator.js"),Z=i("./node_modules/@babel/runtime/regenerator/index.js"),f=i.n(Z),Te=i("./node_modules/regenerator-runtime/runtime.js"),q=i("./node_modules/@babel/runtime/helpers/asyncToGenerator.js"),S=i.n(q),_=i("./node_modules/@babel/runtime/helpers/defineProperty.js"),T=i.n(_),h=i("./frontend/src/lib/api.ts"),P=i("./frontend/src/scenes/userLogic.ts"),E=i("./frontend/src/lib/components/lemonToast.tsx");function w(t,n){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);n&&(s=s.filter(function(u){return Object.getOwnPropertyDescriptor(t,u).enumerable})),a.push.apply(a,s)}return a}function A(t){for(var n=1;n<arguments.length;n++){var a=arguments[n]!=null?arguments[n]:{};n%2?w(Object(a),!0).forEach(function(s){T()(t,s,a[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):w(Object(a)).forEach(function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(a,s))})}return t}var p;(function(t){t[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.CompletedSuccessfully=2]="CompletedSuccessfully",t[t.Errored=3]="Errored",t[t.RolledBack=4]="RolledBack",t[t.Starting=5]="Starting",t[t.FailedAtStartup=6]="FailedAtStartup"})(p||(p={}));var j;(function(t){t.Management="management",t.Settings="settings"})(j||(j={}));var ee={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},O=Object(b.kea)({path:["scenes","instance","AsyncMigrations","asyncMigrationsLogic"],actions:{triggerMigration:function(n){return{migrationId:n}},resumeMigration:function(n){return{migrationId:n}},rollbackMigration:function(n){return{migrationId:n}},forceStopMigration:function(n){return{migrationId:n}},forceStopMigrationWithoutRollback:function(n){return{migrationId:n}},setActiveTab:function(n){return{tab:n}},updateSetting:function(n,a){return{settingKey:n,newValue:a}},loadAsyncMigrationErrors:function(n){return{migrationId:n}},loadAsyncMigrationErrorsSuccess:function(n,a){return{migrationId:n,errors:a}},loadAsyncMigrationErrorsFailure:function(n,a){return{migrationId:n,error:a}}},reducers:{activeTab:[j.Management,{setActiveTab:function(n,a){var s=a.tab;return s}}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:function(n,a){var s=a.migrationId,u=a.errors;return A(A({},n),{},T()({},s,u))}}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:function(n,a){var s=a.migrationId;return A(A({},n),{},T()({},s,!0))},loadAsyncMigrationErrorsSuccess:function(n,a){var s=a.migrationId;return A(A({},n),{},T()({},s,!1))},loadAsyncMigrationErrorsFailure:function(n,a){var s=a.migrationId;return A(A({},n),{},T()({},s,!1))}}]},loaders:function(){return{asyncMigrations:[[],{loadAsyncMigrations:function(){var n=S()(f.a.mark(function s(){var u;return f.a.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(!((u=P.a.values.user)===null||u===void 0)&&u.is_staff){d.next=2;break}return d.abrupt("return",[]);case 2:return d.next=4,h.b.get("api/async_migrations");case 4:return d.abrupt("return",d.sent.results);case 5:case"end":return d.stop()}},s)}));function a(){return n.apply(this,arguments)}return a}()}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:function(){var n=S()(f.a.mark(function s(){var u,c;return f.a.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(!((u=P.a.values.user)===null||u===void 0)&&u.is_staff){l.next=2;break}return l.abrupt("return",[]);case 2:return l.next=4,h.b.get("api/instance_settings");case 4:return c=l.sent.results,l.abrupt("return",c.filter(function(o){return o.key.includes("ASYNC_MIGRATIONS")}));case 6:case"end":return l.stop()}},s)}));function a(){return n.apply(this,arguments)}return a}()}]}},selectors:{isAnyMigrationRunning:[function(t){return[t.asyncMigrations]},function(t){return t.some(function(n){return[p.Running,p.Starting].includes(n.status)})}]},listeners:function(n){var a=n.actions;return{triggerMigration:function(){var s=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return l=d.migrationId,r.next=3,h.b.create("/api/async_migrations/".concat(l,"/trigger"));case 3:o=r.sent,o.success?(E.a.success("Migration triggered successfully"),a.loadAsyncMigrations()):E.a.error(o.error);case 5:case"end":return r.stop()}},c)}));function u(c){return s.apply(this,arguments)}return u}(),resumeMigration:function(){var s=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return l=d.migrationId,r.next=3,h.b.create("/api/async_migrations/".concat(l,"/resume"));case 3:o=r.sent,o.success?(E.a.success("Migration resume triggered successfully"),a.loadAsyncMigrations()):E.a.error(o.error);case 5:case"end":return r.stop()}},c)}));function u(c){return s.apply(this,arguments)}return u}(),rollbackMigration:function(){var s=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return l=d.migrationId,r.next=3,h.b.create("/api/async_migrations/".concat(l,"/rollback"));case 3:o=r.sent,o.success?(E.a.success("Migration rolledback triggered successfully"),a.loadAsyncMigrations()):E.a.error(o.error);case 5:case"end":return r.stop()}},c)}));function u(c){return s.apply(this,arguments)}return u}(),forceStopMigration:function(){var s=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return l=d.migrationId,r.next=3,h.b.create("/api/async_migrations/".concat(l,"/force_stop"));case 3:o=r.sent,o.success?(E.a.success("Force stop triggered successfully"),a.loadAsyncMigrations()):E.a.error(o.error);case 5:case"end":return r.stop()}},c)}));function u(c){return s.apply(this,arguments)}return u}(),forceStopMigrationWithoutRollback:function(){var s=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return l=d.migrationId,r.next=3,h.b.create("/api/async_migrations/".concat(l,"/force_stop_without_rollback"));case 3:o=r.sent,o.success?(E.a.success("Force stop without rollback triggered successfully"),a.loadAsyncMigrations()):E.a.error(o.error);case 5:case"end":return r.stop()}},c)}));function u(c){return s.apply(this,arguments)}return u}(),updateSetting:function(){var s=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return l=d.settingKey,o=d.newValue,r.prev=1,r.next=4,h.b.update("/api/instance_settings/".concat(l),{value:o});case 4:E.a.success("Instance setting ".concat(l," updated")),a.loadAsyncMigrationSettings(),r.next=11;break;case 8:r.prev=8,r.t0=r.catch(1),E.a.error("Failed to trigger migration");case 11:case"end":return r.stop()}},c,null,[[1,8]])}));function u(c){return s.apply(this,arguments)}return u}(),loadAsyncMigrationErrors:function(){var s=S()(f.a.mark(function c(d){var l,o;return f.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return l=d.migrationId,r.prev=1,r.next=4,h.b.get("api/async_migrations/".concat(l,"/errors"));case 4:o=r.sent,a.loadAsyncMigrationErrorsSuccess(l,o),r.next=11;break;case 8:r.prev=8,r.t0=r.catch(1),a.loadAsyncMigrationErrorsFailure(l,r.t0);case 11:case"end":return r.stop()}},c,null,[[1,8]])}));function u(c){return s.apply(this,arguments)}return u}()}},events:function(n){var a=n.actions;return{afterMount:function(){a.loadAsyncMigrations(),a.loadAsyncMigrationSettings()}}}}),B=i("./frontend/src/lib/components/Tooltip.tsx"),N=i("./frontend/src/lib/components/Spinner/Spinner.tsx"),ne=i("./node_modules/@babel/runtime/helpers/slicedToArray.js"),te=i.n(ne),re=i("./node_modules/antd/es/row/index.js"),U=i("./node_modules/antd/es/col/index.js"),ae=i("./node_modules/antd/es/input/index.js"),ie=i("./node_modules/antd/es/divider/index.js");function C(t){var n=t.setting,a=Object(b.useActions)(O),s=a.updateSetting,u=Object(k.useState)(String(n.value)),c=te()(u,2),d=c[0],l=c[1];return e.a.createElement("div",{key:n.key},e.a.createElement("h4",null,n.key),e.a.createElement("p",null,n.description),e.a.createElement(re.a,{gutter:[8,8]},e.a.createElement(U.a,{span:8},e.a.createElement(ae.a,{value:d,onChange:function(M){return l(M.target.value)}})),e.a.createElement(U.a,{span:16},e.a.createElement(W.a,{disabled:String(n.value)===d,type:"primary",onClick:function(){return s(n.key,d)}},"Update"))),e.a.createElement(ie.a,null))}try{C.displayName="SettingUpdateField",C.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"InstanceSetting"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:C.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(t){}var K=i("./frontend/src/lib/components/LemonTable/index.ts"),D=i("./frontend/src/lib/utils.tsx"),R=i("./frontend/src/lib/components/LemonButton/index.ts"),V=i("./frontend/src/lib/components/icons.tsx");function F(t){var n=t.asyncMigration,a=Object(b.useValues)(O),s=a.asyncMigrationErrorsLoading,u=a.asyncMigrationErrors,c=Object(b.useActions)(O),d=c.loadAsyncMigrationErrors,l=[{title:"Error",dataIndex:"description"},{title:e.a.createElement(R.a,{icon:s[n.id]?e.a.createElement(N.a,{size:"sm"}):e.a.createElement(V.IconRefresh,null),onClick:function(){return d(n.id)},type:"secondary",compact:!0},"Refresh errors"),render:function(M,r){return e.a.createElement("div",null,Object(D.M)(r.created_at))}}];return e.a.createElement(K.a,{columns:l,dataSource:u[n.id],loading:s[n.id],embedded:!0})}try{F.displayName="AsyncMigrationDetails",F.__docgenInfo={description:"",displayName:"AsyncMigrationDetails",props:{asyncMigration:{defaultValue:null,description:"",name:"asyncMigration",required:!0,type:{name:"AsyncMigration"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"]={docgenInfo:F.__docgenInfo,name:"AsyncMigrationDetails",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"})}catch(t){}var Y=i("./frontend/src/lib/components/LemonButton/More.tsx"),se=i("./frontend/src/lib/components/LemonTag/LemonTag.tsx"),z=$.a.TabPane,oe={component:G,logic:O},le=3e3;function G(){var t=Object(b.useValues)(P.a),n=t.user,a=Object(b.useValues)(O),s=a.asyncMigrations,u=a.asyncMigrationsLoading,c=a.activeTab,d=a.asyncMigrationSettings,l=a.isAnyMigrationRunning,o=Object(b.useActions)(O),M=o.triggerMigration,r=o.resumeMigration,ce=o.rollbackMigration,ue=o.forceStopMigration,de=o.forceStopMigrationWithoutRollback,H=o.loadAsyncMigrations,ge=o.loadAsyncMigrationErrors,me=o.setActiveTab;Object(k.useEffect)(function(){if(l){var y=setInterval(function(){return H()},le);return function(){return clearInterval(y)}}},[l]);var fe=[{title:"Migration",render:function(v,m){var g="https://github.com/PostHog/posthog/blob/master/posthog/async_migrations/migrations/"+m.name+".py";return e.a.createElement(e.a.Fragment,null,e.a.createElement("div",{className:"row-name"},e.a.createElement("a",{href:g},m.name)),e.a.createElement("div",{className:"row-description"},m.description))}},{title:"Progress",render:function(v,m){var g=m.progress;return e.a.createElement("div",null,e.a.createElement(J.a,{percent:g}))}},{title:"Status",render:function(v,m){var g=m.status,I=g===p.Running?"success":g===p.Errored||g===p.FailedAtStartup?"danger":g===p.Starting||g===p.RolledBack?"warning":"default";return e.a.createElement(se.a,{type:I},ee[g])}},{title:"Last operation index",dataIndex:"current_operation_index"},{title:"Last query ID",render:function(v,m){return e.a.createElement("div",null,e.a.createElement("small",null,m.current_query_id))}},{title:"Started at",render:function(v,m){var g=m.started_at;return e.a.createElement("div",null,Object(D.M)(g))}},{title:"Finished at",render:function(v,m){var g=m.finished_at;return e.a.createElement("div",null,Object(D.M)(g))}},{title:"",render:function(v,m){var g=m.status;return e.a.createElement("div",null,g===p.NotStarted||g===p.FailedAtStartup?e.a.createElement(B.a,{title:"Start"},e.a.createElement(W.a,{type:"link",icon:e.a.createElement(X.a,null),onClick:function(){return M(m.id)}},"Run")):g===p.Running?e.a.createElement(Y.a,{overlay:e.a.createElement(e.a.Fragment,null,e.a.createElement(R.a,{type:"stealth",onClick:function(){return ue(m.id)},fullWidth:!0},"Stop and rollback"),e.a.createElement(R.a,{type:"stealth",onClick:function(){return de(m.id)},fullWidth:!0},"Stop"))}):g===p.CompletedSuccessfully?e.a.createElement(e.a.Fragment,null):g===p.Errored?e.a.createElement(Y.a,{overlay:e.a.createElement(e.a.Fragment,null,e.a.createElement(R.a,{type:"stealth",onClick:function(){return r(m.id)},fullWidth:!0},"Resume"),e.a.createElement(R.a,{type:"stealth",onClick:function(){return ce(m.id)},fullWidth:!0},"Rollback"))}):g===p.RolledBack?e.a.createElement(B.a,{title:"Restart"},e.a.createElement(R.a,{type:"stealth",icon:e.a.createElement(V.IconReplay,null),onClick:function(){return M(m.id)},fullWidth:!0})):g===p.Starting?e.a.createElement(N.a,{size:"sm"}):null)}}],pe={expandedRowRender:function(v){return v&&e.a.createElement(F,{asyncMigration:v})},rowExpandable:function(v){return v.error_count>0},onRowExpand:function(v){ge(v.id)}};return e.a.createElement("div",null,n!=null&&n.is_staff?e.a.createElement(e.a.Fragment,null,e.a.createElement(x.a,{title:"Async Migrations",caption:e.a.createElement(e.a.Fragment,null,e.a.createElement("p",null,"Manage async migrations in your instance."),e.a.createElement("p",null,"Read about async migrations on our"," ",e.a.createElement("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations"},"dedicated docs page"),"."))}),e.a.createElement($.a,{activeKey:c,onChange:function(v){return me(v)}},e.a.createElement(z,{tab:"Management",key:j.Management}),e.a.createElement(z,{tab:"Settings",key:j.Settings})),c===j.Management?e.a.createElement(e.a.Fragment,null,e.a.createElement("div",{className:"mb float-right"},e.a.createElement(R.a,{icon:u?e.a.createElement(N.a,{size:"sm"}):e.a.createElement(V.IconRefresh,null),onClick:H,type:"secondary",compact:!0},"Refresh")),e.a.createElement(Q.b,null),e.a.createElement(K.a,{pagination:{pageSize:10},loading:u,columns:fe,dataSource:s,expandable:pe})):c===j.Settings?e.a.createElement(e.a.Fragment,null,e.a.createElement("br",null),d.map(function(y){return e.a.createElement("div",{key:y.key},e.a.createElement(C,{setting:y}))})):null):e.a.createElement(x.a,{title:"Async Migrations",caption:e.a.createElement(e.a.Fragment,null,e.a.createElement("p",null,"Only users with staff access can manage async migrations. Please contact your instance admin."),e.a.createElement("p",null,"If you're an admin and don't have access, set ",e.a.createElement("code",null,"is_staff=true")," for your user on the PostgreSQL ",e.a.createElement("code",null,"posthog_user")," table."))}))}}}]);
