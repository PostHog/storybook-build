(window.webpackJsonp=window.webpackJsonp||[]).push([[263],{"./frontend/src/scenes/instance/AsyncMigrations/AsyncMigrations.tsx":function(Ce,k,o){"use strict";o.r(k),o.d(k,"scene",function(){return Ee}),o.d(k,"AsyncMigrations",function(){return q});var Te=o("./node_modules/core-js/modules/es.function.name.js"),Fe=o("./node_modules/core-js/modules/es.symbol.js"),Le=o("./node_modules/core-js/modules/es.symbol.description.js"),Pe=o("./node_modules/core-js/modules/es.array.map.js"),F=o("./node_modules/react/index.js"),e=o.n(F),B=o("./frontend/src/lib/components/PageHeader.tsx"),K=o("./node_modules/antd/es/tabs/index.js"),ne=o("./node_modules/antd/es/progress/index.js"),W=o("./node_modules/antd/es/button/index.js"),te=o("./node_modules/antd/es/space/index.js"),E=o("./node_modules/kea/lib/index.esm.js"),re=o("./node_modules/@ant-design/icons/es/icons/PlayCircleOutlined.js"),Ie=o("./node_modules/core-js/modules/es.object.get-own-property-descriptor.js"),we=o("./node_modules/core-js/modules/web.dom-collections.for-each.js"),ke=o("./node_modules/core-js/modules/es.object.get-own-property-descriptors.js"),ae=o("./node_modules/@babel/runtime/helpers/asyncToGenerator.js"),S=o.n(ae),ie=o("./node_modules/@babel/runtime/helpers/defineProperty.js"),C=o.n(ie),oe=o("./node_modules/@babel/runtime/regenerator/index.js"),g=o.n(oe),xe=o("./node_modules/core-js/modules/es.array.iterator.js"),De=o("./node_modules/core-js/modules/es.object.to-string.js"),Ne=o("./node_modules/core-js/modules/web.dom-collections.iterator.js"),Ve=o("./node_modules/core-js/modules/es.array.filter.js"),$e=o("./node_modules/core-js/modules/es.array.includes.js"),Be=o("./node_modules/core-js/modules/es.string.includes.js"),Ke=o("./node_modules/core-js/modules/es.object.keys.js"),We=o("./node_modules/core-js/modules/es.array.concat.js"),T=o("./frontend/src/lib/api.ts"),x=o("./frontend/src/scenes/userLogic.ts"),se=o("./frontend/src/scenes/instance/SystemStatus/systemStatusLogic.ts"),L=o("./frontend/src/lib/components/lemonToast.tsx");function U(r,n){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(r);n&&(a=a.filter(function(s){return Object.getOwnPropertyDescriptor(r,s).enumerable})),t.push.apply(t,a)}return t}function A(r){for(var n=1;n<arguments.length;n++){var t=arguments[n]!=null?arguments[n]:{};n%2?U(Object(t),!0).forEach(function(a){C()(r,a,t[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):U(Object(t)).forEach(function(a){Object.defineProperty(r,a,Object.getOwnPropertyDescriptor(t,a))})}return r}var y;(function(r){r[r.NotStarted=0]="NotStarted",r[r.Running=1]="Running",r[r.CompletedSuccessfully=2]="CompletedSuccessfully",r[r.Errored=3]="Errored",r[r.RolledBack=4]="RolledBack",r[r.Starting=5]="Starting",r[r.FailedAtStartup=6]="FailedAtStartup"})(y||(y={}));var j;(function(r){r.Management="management",r.Settings="settings"})(j||(j={}));var ce={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},h=Object(E.kea)({path:["scenes","instance","AsyncMigrations","asyncMigrationsLogic"],actions:{triggerMigration:function(n){return{migration:n}},resumeMigration:function(n){return{migration:n}},rollbackMigration:function(n){return{migration:n}},forceStopMigration:function(n){return{migration:n}},forceStopMigrationWithoutRollback:function(n){return{migration:n}},updateMigrationStatus:function(n,t,a){return{migration:n,endpoint:t,message:a}},setActiveTab:function(n){return{tab:n}},updateSetting:function(n,t){return{settingKey:n,newValue:t}},loadAsyncMigrationErrors:function(n){return{migrationId:n}},loadAsyncMigrationErrorsSuccess:function(n,t){return{migrationId:n,errors:t}},loadAsyncMigrationErrorsFailure:function(n,t){return{migrationId:n,error:t}},openAsyncMigrationsModal:function(n,t,a){return{migration:n,endpoint:t,message:a}},closeAsyncMigrationsModal:!0},reducers:{activeTab:[j.Management,{setActiveTab:function(n,t){var a=t.tab;return a}}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:function(n,t){var a=t.migrationId,s=t.errors;return A(A({},n),{},C()({},a,s))}}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:function(n,t){var a=t.migrationId;return A(A({},n),{},C()({},a,!0))},loadAsyncMigrationErrorsSuccess:function(n,t){var a=t.migrationId;return A(A({},n),{},C()({},a,!1))},loadAsyncMigrationErrorsFailure:function(n,t){var a=t.migrationId;return A(A({},n),{},C()({},a,!1))}}],activeAsyncMigrationModal:[null,{openAsyncMigrationsModal:function(n,t){return t},closeAsyncMigrationsModal:function(){return null},updateMigrationStatus:function(){return null}}]},loaders:function(){return{asyncMigrations:[[],{loadAsyncMigrations:function(){var n=S()(g.a.mark(function a(){var s;return g.a.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if((s=x.a.values.user)!==null&&s!==void 0&&s.is_staff){l.next=2;break}return l.abrupt("return",[]);case 2:return l.next=4,T.b.get("api/async_migrations");case 4:return l.abrupt("return",l.sent.results);case 5:case"end":return l.stop()}},a)}));function t(){return n.apply(this,arguments)}return t}()}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:function(){var n=S()(g.a.mark(function a(){var s,c;return g.a.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if((s=x.a.values.user)!==null&&s!==void 0&&s.is_staff){i.next=2;break}return i.abrupt("return",[]);case 2:return i.next=4,T.b.get("api/instance_settings");case 4:return c=i.sent.results,i.abrupt("return",c.filter(function(m){return m.key.includes("ASYNC_MIGRATIONS")}));case 6:case"end":return i.stop()}},a)}));function t(){return n.apply(this,arguments)}return t}()}]}},selectors:{isAnyMigrationRunning:[function(r){return[r.asyncMigrations]},function(r){return r.some(function(n){return[y.Running,y.Starting].includes(n.status)})}]},listeners:function(n){var t=n.actions;return{triggerMigration:function(){var a=S()(g.a.mark(function c(l){var i;return g.a.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:i=l.migration,Object.keys(i.parameter_definitions).length>0?t.openAsyncMigrationsModal(i,"trigger","Migration triggered successfully"):t.updateMigrationStatus(i,"trigger","Migration triggered successfully");case 2:case"end":return u.stop()}},c)}));function s(c){return a.apply(this,arguments)}return s}(),resumeMigration:function(){var a=S()(g.a.mark(function c(l){var i;return g.a.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:i=l.migration,Object.keys(i.parameter_definitions).length>0?t.openAsyncMigrationsModal(i,"resume","Migration resume triggered successfully"):t.updateMigrationStatus(i,"resume","Migration resume triggered successfully");case 2:case"end":return u.stop()}},c)}));function s(c){return a.apply(this,arguments)}return s}(),rollbackMigration:function(){var a=S()(g.a.mark(function c(l){var i;return g.a.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:i=l.migration,t.updateMigrationStatus(i,"rollback","Migration rollback triggered successfully");case 2:case"end":return u.stop()}},c)}));function s(c){return a.apply(this,arguments)}return s}(),forceStopMigration:function(){var a=S()(g.a.mark(function c(l){var i;return g.a.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:i=l.migration,t.updateMigrationStatus(i,"force_stop","Force stop triggered successfully");case 2:case"end":return u.stop()}},c)}));function s(c){return a.apply(this,arguments)}return s}(),forceStopMigrationWithoutRollback:function(){var a=S()(g.a.mark(function c(l){var i;return g.a.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:i=l.migration,t.updateMigrationStatus(i,"force_stop_without_rollback","Force stop without rollback triggered successfully");case 2:case"end":return u.stop()}},c)}));function s(c){return a.apply(this,arguments)}return s}(),updateMigrationStatus:function(){var a=S()(g.a.mark(function c(l){var i,m,u,d;return g.a.wrap(function(O){for(;;)switch(O.prev=O.next){case 0:return i=l.migration,m=l.endpoint,u=l.message,O.next=3,T.b.create("/api/async_migrations/".concat(i.id,"/").concat(m),{parameters:i.parameters});case 3:d=O.sent,d.success?(L.d.success(u),t.loadAsyncMigrations()):L.d.error(d.error);case 5:case"end":return O.stop()}},c)}));function s(c){return a.apply(this,arguments)}return s}(),updateSetting:function(){var a=S()(g.a.mark(function c(l){var i,m;return g.a.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return i=l.settingKey,m=l.newValue,d.prev=1,d.next=4,T.b.update("/api/instance_settings/".concat(i),{value:m});case 4:L.d.success("Instance setting ".concat(i," updated")),t.loadAsyncMigrationSettings(),t.loadAsyncMigrations(),se.b.actions.loadSystemStatus(),d.next=13;break;case 10:d.prev=10,d.t0=d.catch(1),L.d.error("Failed to trigger migration");case 13:case"end":return d.stop()}},c,null,[[1,10]])}));function s(c){return a.apply(this,arguments)}return s}(),loadAsyncMigrationErrors:function(){var a=S()(g.a.mark(function c(l){var i,m;return g.a.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return i=l.migrationId,d.prev=1,d.next=4,T.b.get("api/async_migrations/".concat(i,"/errors"));case 4:m=d.sent,t.loadAsyncMigrationErrorsSuccess(i,m),d.next=11;break;case 8:d.prev=8,d.t0=d.catch(1),t.loadAsyncMigrationErrorsFailure(i,d.t0);case 11:case"end":return d.stop()}},c,null,[[1,8]])}));function s(c){return a.apply(this,arguments)}return s}()}},events:function(n){var t=n.actions;return{afterMount:function(){t.loadAsyncMigrations(),t.loadAsyncMigrationSettings()}}}}),Y=o("./frontend/src/lib/components/Tooltip.tsx"),D=o("./frontend/src/lib/components/Spinner/Spinner.tsx"),le=o("./node_modules/@babel/runtime/helpers/slicedToArray.js"),z=o.n(le),ue=o("./node_modules/antd/es/row/index.js"),G=o("./node_modules/antd/es/col/index.js"),de=o("./node_modules/antd/es/input/index.js"),ge=o("./node_modules/antd/es/divider/index.js");function P(r){var n=r.setting,t=Object(E.useActions)(h),a=t.updateSetting,s=Object(F.useState)(String(n.value)),c=z()(s,2),l=c[0],i=c[1];return e.a.createElement("div",{key:n.key},e.a.createElement("h4",null,n.key),e.a.createElement("p",null,n.description),e.a.createElement(ue.a,{gutter:[8,8]},e.a.createElement(G.a,{span:8},e.a.createElement(de.a,{value:l,onChange:function(u){return i(u.target.value)}})),e.a.createElement(G.a,{span:16},e.a.createElement(W.a,{disabled:String(n.value)===l,type:"primary",onClick:function(){return a(n.key,l)}},"Update"))),e.a.createElement(ge.a,null))}try{P.displayName="SettingUpdateField",P.__docgenInfo={description:"",displayName:"SettingUpdateField",props:{setting:{defaultValue:null,description:"",name:"setting",required:!0,type:{name:"InstanceSetting"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"]={docgenInfo:P.__docgenInfo,name:"SettingUpdateField",path:"frontend/src/scenes/instance/AsyncMigrations/SettingUpdateField.tsx#SettingUpdateField"})}catch(r){}var H=o("./frontend/src/lib/components/LemonTable/index.ts"),N=o("./frontend/src/lib/utils.tsx"),b=o("./frontend/src/lib/components/LemonButton/index.ts"),V=o("./frontend/src/lib/components/icons.tsx");function I(r){var n=r.asyncMigration,t=Object(E.useValues)(h),a=t.asyncMigrationErrorsLoading,s=t.asyncMigrationErrors,c=Object(E.useActions)(h),l=c.loadAsyncMigrationErrors,i=[{title:"Error",dataIndex:"description"},{title:e.a.createElement(b.a,{icon:a[n.id]?e.a.createElement(D.a,{size:"sm"}):e.a.createElement(V.IconRefresh,null),onClick:function(){return l(n.id)},type:"secondary",size:"small"},"Refresh errors"),render:function(u,d){return e.a.createElement("div",null,Object(N.M)(d.created_at))}}];return e.a.createElement(H.a,{columns:i,dataSource:s[n.id],loading:a[n.id],embedded:!0})}try{I.displayName="AsyncMigrationDetails",I.__docgenInfo={description:"",displayName:"AsyncMigrationDetails",props:{asyncMigration:{defaultValue:null,description:"",name:"asyncMigration",required:!0,type:{name:"AsyncMigration"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"]={docgenInfo:I.__docgenInfo,name:"AsyncMigrationDetails",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationDetails.tsx#AsyncMigrationDetails"})}catch(r){}var J=o("./frontend/src/lib/components/LemonButton/More.tsx"),me=o("./frontend/src/lib/components/LemonTag/LemonTag.tsx"),pe=o("./frontend/src/lib/components/LemonModal/LemonModal.tsx"),$=o("./node_modules/kea-forms/lib/index.js");function Q(r,n){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(r);n&&(a=a.filter(function(s){return Object.getOwnPropertyDescriptor(r,s).enumerable})),t.push.apply(t,a)}return t}function X(r){for(var n=1;n<arguments.length;n++){var t=arguments[n]!=null?arguments[n]:{};n%2?Q(Object(t),!0).forEach(function(a){C()(r,a,t[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Q(Object(t)).forEach(function(a){Object.defineProperty(r,a,Object.getOwnPropertyDescriptor(t,a))})}return r}var fe=Object(E.kea)([Object(E.path)(["scenes","instance","AsyncMigrations","asyncMigrationParameterFormLogic"]),Object(E.props)({}),Object(E.key)(function(r){return r.migration.id}),Object($.forms)(function(r){var n=r.props;return{parameters:{defaults:ye(n),submit:function(){var t=S()(g.a.mark(function s(c){return g.a.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:h.actions.updateMigrationStatus(X(X({},n.migration),{},{parameters:c}),n.endpoint,n.message);case 1:case"end":return i.stop()}},s)}));function a(s){return t.apply(this,arguments)}return a}()}}})]);function ye(r){var n={};return Object.keys(r.migration.parameter_definitions).forEach(function(t){r.migration.parameters[t]?n[t]=r.migration.parameters[t]:n[t]=r.migration.parameter_definitions[t][0]}),n}var ve=o("./frontend/src/lib/components/LemonInput/LemonInput.tsx"),Me=o("./frontend/src/lib/components/AnimatedCollapsible.tsx");function w(r){var n=Object(E.useActions)(h),t=n.closeAsyncMigrationsModal,a=Object(F.useState)(!0),s=z()(a,2),c=s[0],l=s[1];return e.a.createElement($.Form,{logic:fe,props:r,formKey:"parameters",enableFormOnSubmit:!0,id:"async-migration-parameters-form"},e.a.createElement(pe.a,{title:"Advanced migration configuration",destroyOnClose:!0,onCancel:t,visible:!0,footer:e.a.createElement(e.a.Fragment,null,e.a.createElement(b.a,{form:"async-migration-parameters-form",type:"secondary","data-attr":"async-migration-parameters-cancel",className:"mr-2",onClick:t},"Cancel"),e.a.createElement(b.a,{form:"async-migration-parameters-form",htmlType:"submit",type:"primary","data-attr":"async-migration-parameters-submit"},"Run migration"))},e.a.createElement("p",null,"This async migration allows tuning parameters used in the async migration.",c&&e.a.createElement(e.a.Fragment,null,e.a.createElement("br",null),e.a.createElement("a",{onClick:function(){l(!c)}},"Click here to show advanced configuration."))),e.a.createElement(Me.a,{collapsed:c},Object.keys(r.migration.parameter_definitions).map(function(i){return e.a.createElement($.Field,{name:i,key:i,label:e.a.createElement(e.a.Fragment,null,r.migration.parameter_definitions[i][1])},e.a.createElement(ve.a,{type:"number"}))}))))}try{w.displayName="AsyncMigrationParametersModal",w.__docgenInfo={description:"",displayName:"AsyncMigrationParametersModal",props:{migration:{defaultValue:null,description:"",name:"migration",required:!0,type:{name:"AsyncMigration"}},endpoint:{defaultValue:null,description:"",name:"endpoint",required:!0,type:{name:"string"}},message:{defaultValue:null,description:"",name:"message",required:!0,type:{name:"string"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationParametersModal.tsx#AsyncMigrationParametersModal"]={docgenInfo:w.__docgenInfo,name:"AsyncMigrationParametersModal",path:"frontend/src/scenes/instance/AsyncMigrations/AsyncMigrationParametersModal.tsx#AsyncMigrationParametersModal"})}catch(r){}var Z=K.a.TabPane,Ee={component:q,logic:h},Se=3e3;function q(){var r=Object(E.useValues)(x.a),n=r.user,t=Object(E.useValues)(h),a=t.asyncMigrations,s=t.asyncMigrationsLoading,c=t.activeTab,l=t.asyncMigrationSettings,i=t.isAnyMigrationRunning,m=t.activeAsyncMigrationModal,u=Object(E.useActions)(h),d=u.triggerMigration,_=u.resumeMigration,O=u.rollbackMigration,be=u.forceStopMigration,Ae=u.forceStopMigrationWithoutRollback,ee=u.loadAsyncMigrations,he=u.loadAsyncMigrationErrors,je=u.setActiveTab;Object(F.useEffect)(function(){if(i){var v=setInterval(function(){return ee()},Se);return function(){return clearInterval(v)}}},[i]);var Oe=[{title:"Migration",render:function(M,f){var p="https://github.com/PostHog/posthog/blob/master/posthog/async_migrations/migrations/"+f.name+".py";return e.a.createElement(e.a.Fragment,null,e.a.createElement("div",{className:"row-name"},e.a.createElement("a",{href:p},f.name)),e.a.createElement("div",{className:"row-description"},f.description))}},{title:"Progress",render:function(M,f){var p=f.progress;return e.a.createElement("div",null,e.a.createElement(ne.a,{percent:p}))}},{title:"Status",render:function(M,f){var p=f.status,R=p===y.Running?"success":p===y.Errored||p===y.FailedAtStartup?"danger":p===y.Starting||p===y.RolledBack?"warning":"default";return e.a.createElement(me.a,{type:R},ce[p])}},{title:"Last operation index",dataIndex:"current_operation_index"},{title:"Last query ID",render:function(M,f){return e.a.createElement("div",null,e.a.createElement("small",null,f.current_query_id))}},{title:"Started at",render:function(M,f){var p=f.started_at;return e.a.createElement("div",null,Object(N.M)(p))}},{title:"Finished at",render:function(M,f){var p=f.finished_at;return e.a.createElement("div",null,Object(N.M)(p))}},{title:"",render:function(M,f){var p=f.status;return e.a.createElement("div",null,p===y.NotStarted||p===y.FailedAtStartup?e.a.createElement(Y.a,{title:"Start"},e.a.createElement(W.a,{type:"link",icon:e.a.createElement(re.a,null),onClick:function(){return d(f)}},"Run")):p===y.Running?e.a.createElement(J.a,{overlay:e.a.createElement(e.a.Fragment,null,e.a.createElement(b.a,{status:"stealth",onClick:function(){return be(f)},fullWidth:!0},"Stop and rollback"),e.a.createElement(b.a,{status:"stealth",onClick:function(){return Ae(f)},fullWidth:!0},"Stop"))}):p===y.CompletedSuccessfully?e.a.createElement(e.a.Fragment,null):p===y.Errored?e.a.createElement(J.a,{overlay:e.a.createElement(e.a.Fragment,null,e.a.createElement(b.a,{status:"stealth",onClick:function(){return _(f)},fullWidth:!0},"Resume"),e.a.createElement(b.a,{status:"stealth",onClick:function(){return O(f)},fullWidth:!0},"Rollback"))}):p===y.RolledBack?e.a.createElement(Y.a,{title:"Restart"},e.a.createElement(b.a,{status:"stealth",icon:e.a.createElement(V.IconReplay,null),onClick:function(){return d(f)},fullWidth:!0})):p===y.Starting?e.a.createElement(D.a,{size:"sm"}):null)}}],Re={expandedRowRender:function(M){return M&&e.a.createElement(I,{asyncMigration:M})},rowExpandable:function(M){return M.error_count>0},onRowExpand:function(M){he(M.id)}};return e.a.createElement("div",null,n!=null&&n.is_staff?e.a.createElement(e.a.Fragment,null,e.a.createElement(B.a,{title:"Async Migrations",caption:e.a.createElement(e.a.Fragment,null,e.a.createElement("p",null,"Manage async migrations in your instance."),e.a.createElement("p",null,"Read about async migrations on our"," ",e.a.createElement("a",{href:"https://posthog.com/docs/self-host/configure/async-migrations/overview"},"dedicated docs page"),"."))}),e.a.createElement(K.a,{activeKey:c,onChange:function(M){return je(M)}},e.a.createElement(Z,{tab:"Management",key:j.Management}),e.a.createElement(Z,{tab:"Settings",key:j.Settings})),c===j.Management?e.a.createElement(e.a.Fragment,null,e.a.createElement("div",{className:"mb-4 float-right"},e.a.createElement(b.a,{icon:s?e.a.createElement(D.a,{size:"sm"}):e.a.createElement(V.IconRefresh,null),onClick:ee,type:"secondary",size:"small"},"Refresh")),e.a.createElement(te.b,null),e.a.createElement(H.a,{pagination:{pageSize:10},loading:s,columns:Oe,dataSource:a,expandable:Re}),m?e.a.createElement(w,m):null):c===j.Settings?e.a.createElement(e.a.Fragment,null,e.a.createElement("br",null),l.map(function(v){return e.a.createElement("div",{key:v.key},e.a.createElement(P,{setting:v}))})):null):e.a.createElement(B.a,{title:"Async Migrations",caption:e.a.createElement(e.a.Fragment,null,e.a.createElement("p",null,"Only users with staff access can manage async migrations. Please contact your instance admin."),e.a.createElement("p",null,"If you're an admin and don't have access, set ",e.a.createElement("code",null,"is_staff=true")," for your user on the PostgreSQL ",e.a.createElement("code",null,"posthog_user")," table."))}))}}}]);
