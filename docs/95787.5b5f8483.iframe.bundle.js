"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[95787],{"./frontend/src/scenes/insights/InsightScene.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{InsightScene:()=>InsightScene,scene:()=>scene});var index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),NotFound=__webpack_require__("./frontend/src/lib/components/NotFound/index.tsx"),lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.7.3_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),icons=__webpack_require__("./frontend/src/lib/lemon-ui/icons/index.ts"),LemonButton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/index.ts"),dashboardsModel=__webpack_require__("./frontend/src/models/dashboardsModel.tsx"),jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function AddToDashboard(_ref){let{insight,setOpenModal}=_ref,{rawDashboards}=(0,index_esm.useValues)(dashboardsModel.h),dashboards=insight.dashboard_tiles?.map(tile=>rawDashboards[tile.dashboard_id]).filter(d=>!!d)||[];return(0,jsx_runtime.jsx)("span",{className:"save-to-dashboard","data-attr":"save-to-dashboard-button",children:(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>setOpenModal(!0),type:"secondary",icon:(0,jsx_runtime.jsx)(icons.Xd,{count:dashboards.length,showZero:!1,children:(0,jsx_runtime.jsx)(posthog_icons_es.IconDashboard,{})}),children:0===dashboards.length?"Add to dashboard":"Manage dashboards"})})}var clsx_m=__webpack_require__("./node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),fuse_esm=__webpack_require__("./node_modules/.pnpm/fuse.js@6.6.2/node_modules/fuse.js/dist/fuse.esm.js"),LemonToast=__webpack_require__("./frontend/src/lib/lemon-ui/LemonToast/LemonToast.tsx"),eventUsageLogic=__webpack_require__("./frontend/src/lib/utils/eventUsageLogic.ts"),newDashboardLogic=__webpack_require__("./frontend/src/scenes/dashboard/newDashboardLogic.ts"),insightLogic=__webpack_require__("./frontend/src/scenes/insights/insightLogic.tsx"),sharedUtils=__webpack_require__("./frontend/src/scenes/insights/sharedUtils.ts"),urls=__webpack_require__("./frontend/src/scenes/urls.ts");let addToDashboardModalLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)((0,sharedUtils.bk)("new")),(0,index_esm.path)(key=>["lib","components","AddToDashboard","saveToDashboardModalLogic",key]),(0,index_esm.connect)(props=>({values:[(0,insightLogic.zm)(props),["queryBasedInsight"]],actions:[(0,insightLogic.zm)(props),["updateInsight","updateInsightSuccess","updateInsightFailure"],eventUsageLogic.vx,["reportSavedInsightToDashboard","reportRemovedInsightFromDashboard","reportCreatedDashboardFromModal"],newDashboardLogic.Z,["showNewDashboardModal"]]})),(0,index_esm.actions)({addNewDashboard:!0,setSearchQuery:query=>({query}),setScrollIndex:index=>({index}),addToDashboard:dashboardId=>({dashboardId}),removeFromDashboard:dashboardId=>({dashboardId})}),(0,index_esm.reducers)({searchQuery:["",{setSearchQuery:(_,_ref)=>{let{query}=_ref;return query}}],scrollIndex:[-1,{setScrollIndex:(_,_ref2)=>{let{index}=_ref2;return index}}],dashboardWithActiveAPICall:[null,{addToDashboard:(_,_ref3)=>{let{dashboardId}=_ref3;return dashboardId},removeFromDashboard:(_,_ref4)=>{let{dashboardId}=_ref4;return dashboardId},updateInsightSuccess:()=>null,updateInsightFailure:()=>null}]}),(0,index_esm.selectors)({dashboardsFuse:[()=>[dashboardsModel.h.selectors.nameSortedDashboards],nameSortedDashboards=>new fuse_esm.Z(nameSortedDashboards||[],{keys:["name","description","tags"],threshold:.3})],filteredDashboards:[s=>[s.searchQuery,s.dashboardsFuse,dashboardsModel.h.selectors.nameSortedDashboards],(searchQuery,dashboardsFuse,nameSortedDashboards)=>searchQuery.length?dashboardsFuse.search(searchQuery).map(r=>r.item):nameSortedDashboards],currentDashboards:[s=>[s.filteredDashboards,s.queryBasedInsight],(filteredDashboards,insight)=>filteredDashboards.filter(d=>insight.dashboard_tiles?.map(dt=>dt.dashboard_id)?.includes(d.id))],availableDashboards:[s=>[s.filteredDashboards,s.currentDashboards],(filteredDashboards,currentDashboards)=>filteredDashboards.filter(d=>!currentDashboards?.map(cd=>cd.id).includes(d.id))],orderedDashboards:[s=>[s.currentDashboards,s.availableDashboards],(currentDashboards,availableDashboards)=>[...currentDashboards,...availableDashboards]]}),(0,index_esm.listeners)(_ref5=>{let{actions,values}=_ref5;return{addNewDashboard:async()=>{actions.showNewDashboardModal()},[dashboardsModel.h.actionTypes.addDashboardSuccess]:async _ref6=>{let{dashboard}=_ref6;actions.reportCreatedDashboardFromModal(),actions.addToDashboard(dashboard.id),actions.setScrollIndex(values.orderedDashboards.findIndex(d=>d.id===dashboard.id))},addToDashboard:async _ref7=>{let{dashboardId}=_ref7;actions.updateInsight({dashboards:[...values.queryBasedInsight.dashboards||[],dashboardId]},()=>{actions.reportSavedInsightToDashboard(),dashboardsModel.h.actions.tileAddedToDashboard(dashboardId),LemonToast.UJ.success("Insight added to dashboard",{button:{label:"View dashboard",action:()=>lib.router.actions.push(urls.j.dashboard(dashboardId))}})})},removeFromDashboard:async _ref8=>{let{dashboardId}=_ref8;actions.updateInsight({dashboards:(values.queryBasedInsight.dashboards||[]).filter(d=>d!==dashboardId),dashboard_tiles:(values.queryBasedInsight.dashboard_tiles||[]).filter(dt=>dt.dashboard_id!==dashboardId)},()=>{actions.reportRemovedInsightFromDashboard(),LemonToast.UJ.success("Insight removed from dashboard")})}}})]);var LemonInput=__webpack_require__("./frontend/src/lib/lemon-ui/LemonInput/LemonInput.tsx"),LemonModal=__webpack_require__("./frontend/src/lib/lemon-ui/LemonModal/index.ts"),Link=__webpack_require__("./frontend/src/lib/lemon-ui/Link/index.ts"),Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip/index.ts"),utils=__webpack_require__("./frontend/src/lib/utils.tsx"),AutoSizer=__webpack_require__("./node_modules/.pnpm/react-virtualized@9.22.5_react-dom@18.2.0_react@18.2.0/node_modules/react-virtualized/dist/es/AutoSizer/index.js"),List=__webpack_require__("./node_modules/.pnpm/react-virtualized@9.22.5_react-dom@18.2.0_react@18.2.0/node_modules/react-virtualized/dist/es/List/index.js"),teamLogic=__webpack_require__("./frontend/src/scenes/teamLogic.tsx");let DashboardRelationRow=_ref=>{let{style,isHighlighted,isAlreadyOnDashboard,dashboard,insightProps,canEditInsight}=_ref,{addToDashboard,removeFromDashboard}=(0,index_esm.useActions)(addToDashboardModalLogic(insightProps)),{dashboardWithActiveAPICall}=(0,index_esm.useValues)(addToDashboardModalLogic(insightProps)),{currentTeam}=(0,index_esm.useValues)(teamLogic.H),isPrimary=dashboard.id===currentTeam?.primary_dashboard;return(0,jsx_runtime.jsxs)("div",{"data-attr":"dashboard-list-item",style:style,className:(0,clsx_m.default)("flex items-center space-x-2",isHighlighted&&"highlighted"),children:[(0,jsx_runtime.jsx)(Link.r,{to:urls.j.dashboard(dashboard.id),className:"overflow-hidden text-ellipsis whitespace-nowrap",title:dashboard.name,children:dashboard.name||"Untitled"}),isPrimary&&(0,jsx_runtime.jsx)(Tooltip.u,{title:"Primary dashboards are shown on the project home page",children:(0,jsx_runtime.jsx)("span",{className:"flex items-center",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconHome,{className:"text-warning text-base"})})}),(0,jsx_runtime.jsx)("span",{className:"grow"}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",status:isAlreadyOnDashboard?"danger":"default",loading:dashboardWithActiveAPICall===dashboard.id,disabledReason:canEditInsight?dashboardWithActiveAPICall?"Loading...":"":"You don't have permission to edit this dashboard",size:"small",onClick:e=>{e.preventDefault(),isAlreadyOnDashboard?removeFromDashboard(dashboard.id):addToDashboard(dashboard.id)},children:isAlreadyOnDashboard?"Remove from dashboard":"Add to dashboard"})]})};function AddToDashboardModal(_ref2){let{isOpen,closeModal,insightProps,canEditInsight}=_ref2,logic=addToDashboardModalLogic(insightProps),{searchQuery,currentDashboards,orderedDashboards,scrollIndex}=(0,index_esm.useValues)(logic),{setSearchQuery,addNewDashboard}=(0,index_esm.useActions)(logic),renderItem=_ref3=>{let{index:rowIndex,style}=_ref3;return(0,jsx_runtime.jsx)(DashboardRelationRow,{dashboard:orderedDashboards[rowIndex],insightProps:insightProps,canEditInsight:canEditInsight,isHighlighted:rowIndex===scrollIndex,isAlreadyOnDashboard:currentDashboards.some(currentDashboard=>currentDashboard.id===orderedDashboards[rowIndex].id),style:style},rowIndex)};return(0,jsx_runtime.jsx)(LemonModal.f,{onClose:()=>{closeModal(),setSearchQuery("")},isOpen:isOpen,title:"Add to dashboard",footer:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",onClick:addNewDashboard,disabledReason:canEditInsight?void 0:"You do not have permission to add this insight to dashboards",children:"Add to a new dashboard"})}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",onClick:closeModal,children:"Close"})]}),children:(0,jsx_runtime.jsxs)("div",{className:"space-y-2 w-192 max-w-full",children:[(0,jsx_runtime.jsx)(LemonInput.D,{"data-attr":"dashboard-searchfield",type:"search",fullWidth:!0,placeholder:"Search for dashboards...",value:searchQuery,onChange:newValue=>setSearchQuery(newValue)}),(0,jsx_runtime.jsxs)("div",{className:"text-muted-alt",children:["This insight is referenced on ",(0,jsx_runtime.jsx)("strong",{className:"text-text-3000",children:currentDashboards.length})," ",(0,utils.Zi)(currentDashboards.length,"dashboard","dashboards",!1)]}),(0,jsx_runtime.jsx)("div",{style:{minHeight:420},children:(0,jsx_runtime.jsx)(AutoSizer.q,{children:_ref4=>{let{height,width}=_ref4;return(0,jsx_runtime.jsx)(List.aV,{width:width,height:height,rowCount:orderedDashboards.length,overscanRowCount:100,rowHeight:40,rowRenderer:renderItem,scrollToIndex:scrollIndex})}})})]})})}var src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),constants=__webpack_require__("./frontend/src/lib/constants.tsx"),Spinner=__webpack_require__("./frontend/src/lib/lemon-ui/Spinner/Spinner.tsx"),featureFlagLogic=__webpack_require__("./frontend/src/lib/logic/featureFlagLogic.ts"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts"),kea_loaders_lib=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),insightVizDataLogic=__webpack_require__("./frontend/src/scenes/insights/insightVizDataLogic.ts"),insights_utils=__webpack_require__("./frontend/src/scenes/insights/utils.tsx"),queries_utils=__webpack_require__("./frontend/src/queries/utils.ts"),types=__webpack_require__("./frontend/src/types.ts");let areAlertsSupportedForInsight=query=>!!query&&(0,queries_utils.KN)(query)&&(0,queries_utils.kX)(query.source)&&null!==query.source.trendsFilter&&query.source.trendsFilter?.display===types.Qb.BoldNumber,alertsLogic=(0,index_esm.kea)([(0,index_esm.path)(["lib","components","Alerts","alertsLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{insightShortId}=_ref;return`insight-${insightShortId}`}),(0,index_esm.actions)({deleteAlert:id=>({id}),setShouldShowAlertDeletionWarning:show=>({show})}),(0,index_esm.connect)(props=>({actions:[(0,insightVizDataLogic.Z)(props.insightLogicProps),["setQuery"]]})),(0,kea_loaders_lib.loaders)(_ref2=>{let{props}=_ref2;return{alerts:{__default:[],loadAlerts:async()=>{let insightId=await (0,insights_utils.gI)(props.insightShortId);if(!insightId)return[];let response=await api.ZP.alerts.list(insightId);return response.results}}}}),(0,index_esm.reducers)({alerts:{deleteAlert:(state,_ref3)=>{let{id}=_ref3;return state.filter(a=>a.id!==id)}},shouldShowAlertDeletionWarning:[!1,{setShouldShowAlertDeletionWarning:(_,_ref4)=>{let{show}=_ref4;return show}}]}),(0,index_esm.listeners)(_ref5=>{let{actions,values}=_ref5;return{deleteAlert:async _ref6=>{let{id}=_ref6;await api.ZP.alerts.delete(id)},setQuery:_ref7=>{let{query}=_ref7;0===values.alerts.length||areAlertsSupportedForInsight(query)?actions.setShouldShowAlertDeletionWarning(!1):actions.setShouldShowAlertDeletionWarning(!0)}}}),(0,index_esm.afterMount)(_ref8=>{let{actions}=_ref8;return actions.loadAlerts()})]);var kea_forms_lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),LemonField=__webpack_require__("./frontend/src/lib/lemon-ui/LemonField/index.ts");let alertLogic=(0,index_esm.kea)([(0,index_esm.path)(["lib","components","Alerts","alertLogic"]),(0,index_esm.props)({}),(0,index_esm.key)(_ref=>{let{id,insightShortId}=_ref;return`${insightShortId}-${null!=id?id:"new"}`}),(0,index_esm.connect)(()=>({actions:[alertsLogic,["loadAlerts"]]})),(0,kea_loaders_lib.loaders)(_ref2=>{let{props}=_ref2;return{alert:{__default:void 0,loadAlert:async()=>props.id&&"new"!==props.id?await api.ZP.alerts.get(props.id):{anomaly_condition:{absoluteThreshold:{}}}}}}),(0,kea_forms_lib.forms)(_ref3=>{let{props,actions}=_ref3;return{alert:{defaults:{},errors:_ref4=>{let{name,target_value}=_ref4;return{name:name?void 0:"You need to give your alert a name",target_value:target_value?target_value.split(",").every(email=>(0,utils.Jh)(email))?void 0:"All emails must be valid":"This field is required."}},submit:async alert=>{let insightId=await (0,insights_utils.gI)(props.insightShortId),payload={...alert,insight:insightId},updatedAlert="new"===props.id?await api.ZP.alerts.create(payload):await api.ZP.alerts.update(props.id,payload);return actions.resetAlert(),updatedAlert.id!==props.id&&lib.router.actions.replace(urls.j.alerts(props.insightShortId)),actions.loadAlerts(),actions.loadAlertSuccess(updatedAlert),LemonToast.UJ.success("Alert saved."),updatedAlert}}}}),(0,lib.urlToAction)(_ref5=>{let{actions}=_ref5;return{"/*/*/alerts/:id":()=>{actions.loadAlert()}}})]);function EditAlert(props){let logic=alertLogic(props),alertslogic=alertsLogic(props),{alert,isAlertSubmitting,alertChanged}=(0,index_esm.useValues)(logic),{deleteAlert}=(0,index_esm.useActions)(alertslogic),id=props.id;return(0,jsx_runtime.jsxs)(kea_forms_lib.Form,{logic:alertLogic,props:props,formKey:"alert",enableFormOnSubmit:!0,className:"LemonModal__layout",children:[(0,jsx_runtime.jsx)(LemonModal.f.Header,{children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(icons.ed,{}),onClick:props.onCancel,size:"xsmall"}),(0,jsx_runtime.jsxs)("h3",{children:["new"===id?"New":"Edit "," Alert"]})]})}),(0,jsx_runtime.jsx)(LemonModal.f.Content,{className:"space-y-2",children:alert?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"e.g. High error rate","data-attr":"alert-name"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"target_value",label:"Who do you want to notify about anomalies",help:"Enter comma separated email addresses of the users you want notify about anomalies",children:(0,jsx_runtime.jsx)(src.DF,{"data-attr":"alert-notification-targets",placeholder:"Enter an email address"})}),(0,jsx_runtime.jsx)(kea_forms_lib.Group,{name:["anomaly_condition","absoluteThreshold"],children:(0,jsx_runtime.jsxs)("span",{className:"flex gap-10",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"lower",label:"Lower threshold",children:(0,jsx_runtime.jsx)(src.DF,{type:"number",className:"w-20","data-attr":"alert-lower-threshold"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"upper",label:"Upper threshold",children:(0,jsx_runtime.jsx)(src.DF,{type:"number",className:"w-20","data-attr":"alert-upper-threshold"})})]})})]}):(0,jsx_runtime.jsxs)("div",{className:"p-4 text-center",children:[(0,jsx_runtime.jsx)("h2",{children:"Not found"}),(0,jsx_runtime.jsx)("p",{children:"This alert could not be found. It may have been deleted."})]})}),(0,jsx_runtime.jsxs)(LemonModal.f.Footer,{children:[(0,jsx_runtime.jsx)("div",{className:"flex-1",children:alert&&"new"!==id&&(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",status:"danger",onClick:()=>{"new"!==id&&(deleteAlert(id),props.onDelete())},children:"Delete alert"})}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",onClick:props.onCancel,children:"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"primary",htmlType:"submit",loading:isAlertSubmitting,disabled:!alertChanged,children:"new"===id?"Create alert":"Save"})]})]})}var ProfilePicture=__webpack_require__("./frontend/src/lib/lemon-ui/ProfilePicture/index.ts");function AlertListItem(_ref){let{alert,onClick,onDelete}=_ref;return(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",onClick:onClick,"data-attr":"alert-list-item",fullWidth:!0,sideAction:{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconEllipsis,{}),dropdown:{overlay:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:onDelete&&(0,jsx_runtime.jsx)(LemonButton.J,{onClick:onDelete,"data-attr":"alert-list-item-delete",status:"danger",fullWidth:!0,children:"Delete Alert"})})}},children:(0,jsx_runtime.jsxs)("div",{className:"flex justify-between flex-auto items-center p-2",children:[(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("div",{className:"text-link font-medium",children:alert.name})}),(0,jsx_runtime.jsx)(ProfilePicture.r,{limit:4,people:alert.target_value.split(",").map(email=>({email}))})]})})}function ManageAlerts(props){let logic=alertsLogic(props),{alerts}=(0,index_esm.useValues)(logic),{deleteAlert}=(0,index_esm.useActions)(logic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonModal.f.Header,{children:(0,jsx_runtime.jsx)("h3",{children:" Manage Alerts"})}),(0,jsx_runtime.jsx)(LemonModal.f.Content,{children:alerts.length?(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("strong",{children:alerts?.length})," active ",(0,utils.Zi)(alerts.length||0,"alert","alerts",!1)]}),alerts.map(alert=>(0,jsx_runtime.jsx)(AlertListItem,{alert:alert,onClick:()=>props.onSelect(alert.id),onDelete:()=>deleteAlert(alert.id)},alert.id))]}):(0,jsx_runtime.jsxs)("div",{className:"flex flex-col p-4 items-center text-center",children:[(0,jsx_runtime.jsx)("h3",{children:"There are no alerts for this insight"}),(0,jsx_runtime.jsx)("p",{children:"Once alerts are created they will display here. "})]})}),(0,jsx_runtime.jsx)(LemonModal.f.Footer,{children:(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",onClick:props.onCancel,children:"Close"})})]})}function AlertsModal(props){let{closeModal,insightShortId,insightLogicProps,alertId,isOpen}=props,{push}=(0,index_esm.useActions)(lib.router),{userLoading}=(0,index_esm.useValues)(userLogic.userLogic);return userLoading?(0,jsx_runtime.jsx)(Spinner.$,{className:"text-2xl"}):(0,jsx_runtime.jsx)(LemonModal.f,{onClose:closeModal,isOpen:isOpen,width:600,simple:!0,title:"",children:alertId?(0,jsx_runtime.jsx)(EditAlert,{id:alertId,insightShortId:insightShortId,insightLogicProps:insightLogicProps,onCancel:()=>push(urls.j.alerts(insightShortId)),onDelete:()=>push(urls.j.alerts(insightShortId))}):(0,jsx_runtime.jsx)(ManageAlerts,{insightShortId:insightShortId,insightLogicProps:insightLogicProps,onCancel:closeModal,onSelect:id=>push(urls.j.alert(insightShortId,id.toString()))})})}function AlertsButton(_ref){let{insight}=_ref,{push}=(0,index_esm.useActions)(lib.router),{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.h),showAlerts=featureFlags[constants.y8.ALERTS];return showAlerts?areAlertsSupportedForInsight(insight.query)?(0,jsx_runtime.jsx)(src.$K,{fullWidth:!0,dropdown:{actionable:!0,closeParentPopoverOnClickInside:!0,placement:"right-start",overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>push(urls.j.alert(insight.short_id,"new")),fullWidth:!0,children:"New alert"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>push(urls.j.alerts(insight.short_id)),fullWidth:!0,children:"Manage alerts"})]})},children:"Alerts"}):(0,jsx_runtime.jsx)(src.Jp,{"data-attr":"disabled-alerts-button",disabledReason:"Insights are only availabe for trends represented as a number. Change the insight representation to add alerts.",children:"Alerts"}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})}var EditableField=__webpack_require__("./frontend/src/lib/components/EditableField/EditableField.tsx"),ExportButton=__webpack_require__("./frontend/src/lib/components/ExportButton/ExportButton.tsx"),ObjectTags=__webpack_require__("./frontend/src/lib/components/ObjectTags/ObjectTags.tsx"),PageHeader=__webpack_require__("./frontend/src/lib/components/PageHeader.tsx"),SharingModal=__webpack_require__("./frontend/src/lib/components/Sharing/SharingModal.tsx"),SubscriptionsModal=__webpack_require__("./frontend/src/lib/components/Subscriptions/SubscriptionsModal.tsx"),UserActivityIndicator=__webpack_require__("./frontend/src/lib/components/UserActivityIndicator/UserActivityIndicator.tsx"),More=__webpack_require__("./frontend/src/lib/lemon-ui/LemonButton/More.tsx"),LemonDivider=__webpack_require__("./frontend/src/lib/lemon-ui/LemonDivider/index.ts"),LemonSwitch=__webpack_require__("./frontend/src/lib/lemon-ui/LemonSwitch/index.ts"),deleteWithUndo=__webpack_require__("./frontend/src/lib/utils/deleteWithUndo.tsx"),react=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),NewDashboardModal=__webpack_require__("./frontend/src/scenes/dashboard/NewDashboardModal.tsx"),commandPaletteLogic=__webpack_require__("./frontend/src/lib/components/CommandPalette/commandPaletteLogic.tsx");let INSIGHT_COMMAND_SCOPE="insights",insightCommandLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)((0,sharedUtils.bk)("new")),(0,index_esm.path)(key=>["scenes","insights","insightCommandLogic",key]),(0,index_esm.connect)(props=>[commandPaletteLogic.M,(0,insightVizDataLogic.Z)(props)]),(0,index_esm.events)(_ref=>{let{props}=_ref;return{afterMount:()=>{let funnelCommands=[{key:"insight-graph",resolver:[{icon:posthog_icons_es.IconTrending,display:'Toggle "Compare Previous" on Graph',executor:()=>{let compareFilter=(0,insightVizDataLogic.Z)(props).values.compareFilter;(0,insightVizDataLogic.Z)(props).actions.updateCompareFilter({compare:!compareFilter?.compare,compare_to:compareFilter?.compare_to})}},...utils.bE.map(_ref2=>{let{key,values}=_ref2;return{icon:posthog_icons_es.IconTrending,display:`Set Time Range to ${key}`,executor:()=>{(0,insightVizDataLogic.Z)(props).actions.updateDateRange({date_from:values[0],date_to:values[1]})}}})],scope:INSIGHT_COMMAND_SCOPE}];for(let command of funnelCommands)commandPaletteLogic.M.actions.registerCommand(command)},beforeUnmount:()=>{commandPaletteLogic.M.actions.deregisterScope(INSIGHT_COMMAND_SCOPE)}}})]);var insightDataLogic=__webpack_require__("./frontend/src/scenes/insights/insightDataLogic.tsx");function InsightSaveButton(_ref){let{saveAs,saveInsight,isSaved,insightSaving,insightChanged,addingToDashboard}=_ref,disabled=isSaved&&!insightChanged,saveAsAvailable=isSaved&&!addingToDashboard;return(0,jsx_runtime.jsx)(LemonButton.J,{type:"primary",onClick:()=>saveInsight(!0),"data-attr":"insight-save-button",disabled:disabled,loading:!disabled&&insightSaving,sideAction:{dropdown:{placement:"bottom-end",overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!disabled&&(0,jsx_runtime.jsxs)(LemonButton.J,{onClick:()=>saveInsight(!1),"data-attr":"insight-save-and-continue",fullWidth:!0,children:[addingToDashboard?"Save, add to dashboard":"Save"," & continue editing"]}),saveAsAvailable&&(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>saveAs(),"data-attr":"insight-save-as-new-insight",fullWidth:!0,children:"Save as…"})]})},disabled:disabled&&!saveAsAvailable,"data-attr":"insight-save-dropdown"},children:disabled?"No changes to be saved":addingToDashboard?"Save & add to dashboard":"Save"})}var insightSceneLogic=__webpack_require__("./frontend/src/scenes/insights/insightSceneLogic.tsx"),NotebookSelectButton=__webpack_require__("./frontend/src/scenes/notebooks/NotebookSelectButton/NotebookSelectButton.tsx"),savedInsightsLogic=__webpack_require__("./frontend/src/scenes/saved-insights/savedInsightsLogic.ts"),tagsModel=__webpack_require__("./frontend/src/models/tagsModel.ts"),schema=__webpack_require__("./frontend/src/queries/schema.ts");function InsightPageHeader(_ref){var _insight$tags;let{insightLogicProps}=_ref,{insightMode,subscriptionId}=(0,index_esm.useValues)(insightSceneLogic.T),{setInsightMode}=(0,index_esm.useActions)(insightSceneLogic.T),{insightProps,canEditInsight,queryBasedInsight:insight,queryBasedInsightSaving,insightChanged,insightSaving,hasDashboardItemId}=(0,index_esm.useValues)((0,insightLogic.zm)(insightLogicProps)),{setInsightMetadata,saveAs,saveInsight}=(0,index_esm.useActions)((0,insightLogic.zm)(insightLogicProps)),{duplicateInsight,loadInsights}=(0,index_esm.useActions)(savedInsightsLogic.w),{queryChanged,showQueryEditor,hogQL,exportContext}=(0,index_esm.useValues)((0,insightDataLogic.Sw)(insightProps)),{toggleQueryEditorPanel}=(0,index_esm.useActions)((0,insightDataLogic.Sw)(insightProps));(0,index_esm.useMountedLogic)(insightCommandLogic(insightProps));let{tags}=(0,index_esm.useValues)(tagsModel.x),{currentTeamId}=(0,index_esm.useValues)(teamLogic.H),{push}=(0,index_esm.useActions)(lib.router),[addToDashboardModalOpen,setAddToDashboardModalOpenModal]=(0,react.useState)(!1);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[hasDashboardItemId&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(SubscriptionsModal.r,{isOpen:insightMode===types.LO.Subscriptions,closeModal:()=>push(urls.j.insightView(insight.short_id)),insightShortId:insight.short_id,subscriptionId:subscriptionId}),(0,jsx_runtime.jsx)(SharingModal.PA,{title:"Insight sharing",isOpen:insightMode===types.LO.Sharing,closeModal:()=>push(urls.j.insightView(insight.short_id)),insightShortId:insight.short_id,insight:insight,previewIframe:!0}),(0,jsx_runtime.jsx)(AddToDashboardModal,{isOpen:addToDashboardModalOpen,closeModal:()=>setAddToDashboardModalOpenModal(!1),insightProps:insightProps,canEditInsight:canEditInsight}),(0,jsx_runtime.jsx)(AlertsModal,{closeModal:()=>push(urls.j.insightView(insight.short_id)),isOpen:insightMode===types.LO.Alerts,insightLogicProps:insightLogicProps,insightShortId:insight.short_id,alertId:subscriptionId}),(0,jsx_runtime.jsx)(NewDashboardModal.O,{})]}),(0,jsx_runtime.jsx)(PageHeader.m,{buttons:(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center gap-2",children:[(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[hasDashboardItemId&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>duplicateInsight(insight,!0),fullWidth:!0,"data-attr":"duplicate-insight-from-insight-view",children:"Duplicate"}),(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>setInsightMetadata({favorited:!insight.favorited}),fullWidth:!0,children:insight.favorited?"Remove from favorites":"Add to favorites"}),(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>setAddToDashboardModalOpenModal(!0),fullWidth:!0,children:"Add to dashboard"}),(0,jsx_runtime.jsx)(LemonDivider.p,{}),(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>insight.short_id?push(urls.j.insightSharing(insight.short_id)):null,fullWidth:!0,children:"Share or embed"}),(0,jsx_runtime.jsx)(SubscriptionsModal.T,{insightShortId:insight.short_id}),(0,jsx_runtime.jsx)(AlertsButton,{insight:insight}),exportContext?(0,jsx_runtime.jsx)(ExportButton.j,{fullWidth:!0,items:[{export_format:types.P5.PNG,insight:insight.id},{export_format:types.P5.CSV,export_context:exportContext},{export_format:types.P5.XLSX,export_context:exportContext}]}):null,(0,jsx_runtime.jsx)(LemonDivider.p,{})]}),(0,jsx_runtime.jsx)(LemonSwitch.f,{"data-attr":`${showQueryEditor?"hide":"show"}-insight-source`,className:"px-2 py-1",checked:showQueryEditor,onChange:()=>{hasDashboardItemId&&insightMode!==types.LO.Edit&&(setInsightMode(types.LO.Edit,null),showQueryEditor)||toggleQueryEditorPanel()},fullWidth:!0,label:"View source"}),hogQL&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonDivider.p,{}),(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"edit-insight-sql",onClick:()=>{lib.router.actions.push(urls.j.insightNew(void 0,void 0,JSON.stringify({kind:schema.OH.DataTableNode,source:{kind:schema.OH.HogQLQuery,query:hogQL},full:!0})))},fullWidth:!0,children:"Edit SQL directly"})]}),hasDashboardItemId&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonDivider.p,{}),(0,jsx_runtime.jsx)(LemonButton.J,{status:"danger",onClick:()=>void(0,deleteWithUndo.c)({object:insight,endpoint:`projects/${currentTeamId}/insights`,callback:()=>{loadInsights(),push(urls.j.savedInsights())},options:{writeAsQuery:queryBasedInsightSaving,readAsQuery:!0}}),fullWidth:!0,children:"Delete insight"})]})]})}),(0,jsx_runtime.jsx)(LemonDivider.p,{vertical:!0}),insightMode===types.LO.Edit&&hasDashboardItemId&&(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",onClick:()=>setInsightMode(types.LO.View,null),"data-attr":"insight-cancel-edit-button",children:"Cancel"}),insightMode!==types.LO.Edit&&hasDashboardItemId&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(NotebookSelectButton.R,{resource:{type:types.Cz.Query,attrs:{query:{kind:schema.OH.SavedInsightNode,shortId:insight.short_id}}},type:"secondary"}),(0,jsx_runtime.jsx)(AddToDashboard,{insight:insight,setOpenModal:setAddToDashboardModalOpenModal})]}),insightMode!==types.LO.Edit?canEditInsight&&(0,jsx_runtime.jsx)(LemonButton.J,{type:"primary",onClick:()=>setInsightMode(types.LO.Edit,null),"data-attr":"insight-edit-button",children:"Edit"}):(0,jsx_runtime.jsx)(InsightSaveButton,{saveAs:saveAs,saveInsight:saveInsight,isSaved:hasDashboardItemId,addingToDashboard:!!insight.dashboards?.length&&!insight.id,insightSaving:insightSaving,insightChanged:insightChanged||queryChanged})]}),caption:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[!!(canEditInsight||insight.description)&&(0,jsx_runtime.jsx)(EditableField.f,{multiline:!0,markdown:!0,name:"description",value:insight.description||"",placeholder:"Description (optional)",onSave:value=>setInsightMetadata({description:value}),saveOnBlur:!0,maxLength:400,mode:canEditInsight?void 0:"view","data-attr":"insight-description",compactButtons:!0}),canEditInsight?(0,jsx_runtime.jsx)(ObjectTags.D,{tags:null!==(_insight$tags=insight.tags)&&void 0!==_insight$tags?_insight$tags:[],saving:insightSaving,onChange:tags=>setInsightMetadata({tags:null!=tags?tags:[]}),tagsAvailable:tags,className:"mt-2","data-attr":"insight-tags"}):insight.tags?.length?(0,jsx_runtime.jsx)(ObjectTags.D,{tags:insight.tags,saving:insightSaving,className:"mt-2","data-attr":"insight-tags",staticOnly:!0}):null,(0,jsx_runtime.jsx)(UserActivityIndicator.F,{at:insight.last_modified_at,by:insight.last_modified_by,className:"mt-2"})]}),tabbedPage:insightMode===types.LO.Edit})]})}var Query=__webpack_require__("./frontend/src/queries/Query/Query.tsx"),LemonBanner=__webpack_require__("./frontend/src/lib/lemon-ui/LemonBanner/index.ts");function AlertDeletionWarning(){var _insight$short_id;let{insightProps,queryBasedInsight:insight}=(0,index_esm.useValues)(insightLogic.zm),{shouldShowAlertDeletionWarning}=(0,index_esm.useValues)(alertsLogic({insightShortId:null!==(_insight$short_id=insight.short_id)&&void 0!==_insight$short_id?_insight$short_id:"",insightLogicProps:insightProps}));return shouldShowAlertDeletionWarning&&insight.short_id?(0,jsx_runtime.jsx)(LemonBanner.V,{type:"warning",className:"mb-4",children:"There are alerts set up for the insight. The selected chart type of the insight doesn't support alerts, so the existing alerts will be deleted when you save."}):null}var LemonTabs=__webpack_require__("./frontend/src/lib/lemon-ui/LemonTabs/index.ts"),insightNavLogic=__webpack_require__("./frontend/src/scenes/insights/InsightNav/insightNavLogic.tsx"),SavedInsights=__webpack_require__("./frontend/src/scenes/saved-insights/SavedInsights.tsx");__webpack_require__("./node_modules/.pnpm/core-js@3.32.0/node_modules/core-js/modules/es.regexp.flags.js");var dist_module=__webpack_require__("./node_modules/.pnpm/posthog-js@1.154.5/node_modules/posthog-js/dist/module.js"),insightUsageLogic=__webpack_require__("./frontend/src/scenes/insights/insightUsageLogic.ts");let funnelsCueLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)((0,sharedUtils.bk)("new")),(0,index_esm.path)(key=>["scenes","insights","InsightTabs","TrendTab","FunnelsCue",key]),(0,index_esm.connect)(props=>({values:[(0,insightUsageLogic.u)(props),["isFirstLoad"],(0,insightVizDataLogic.Z)(props),["query"],featureFlagLogic.h,["featureFlags"]],actions:[(0,insightVizDataLogic.Z)(props),["setQuery"],featureFlagLogic.h,["setFeatureFlags"]]})),(0,index_esm.actions)({optOut:userOptedOut=>({userOptedOut}),setShouldShow:show=>({show}),setPermanentOptOut:!0,displayAsFunnel:!0}),(0,index_esm.reducers)({_shouldShow:[!1,{setShouldShow:(_,_ref)=>{let{show}=_ref;return show}}],permanentOptOut:[!1,{setPermanentOptOut:()=>!0}]}),(0,index_esm.listeners)(_ref2=>{let{actions,values}=_ref2;return{optOut:async _ref3=>{let{userOptedOut}=_ref3;dist_module.ZP.capture("funnel cue 7301 - terminated",{user_opted_out:userOptedOut}),dist_module.ZP.people.set({funnels_cue_3701_opt_out:!0}),actions.setPermanentOptOut()},setQuery:_ref4=>{let{query}=_ref4;(0,queries_utils.KN)(query)&&(!values.isFirstLoad&&(0,queries_utils.kX)(query?.source)&&(query.source.series||[]).length>=3?(actions.setShouldShow(!0),values.permanentOptOut||dist_module.ZP.capture("funnel cue 7301 - shown",{step_count:query.source.series.length})):values.shown&&(0,queries_utils.Wl)(query?.source)?actions.optOut(!1):actions.setShouldShow(!1))},setFeatureFlags:async _ref5=>{let{flags}=_ref5;flags[constants.y8.FUNNELS_CUE_OPT_OUT]&&actions.setPermanentOptOut()},displayAsFunnel:()=>{if(!(0,queries_utils.KN)(values.query)||!(0,queries_utils.kX)(values.query?.source))return;let query=JSON.parse(JSON.stringify(values.query));query.source.kind=schema.OH.FunnelsQuery,actions.setQuery(query)}}}),(0,index_esm.selectors)({shown:[s=>[s._shouldShow,s.permanentOptOut],(shouldShow,permanentOptout)=>shouldShow&&!permanentOptout]}),(0,index_esm.events)(_ref6=>{let{actions,values}=_ref6;return{afterMount:()=>{values.featureFlags[constants.y8.FUNNELS_CUE_OPT_OUT]&&actions.setPermanentOptOut()}}})]);function FunnelsCue(){let{insightProps}=(0,index_esm.useValues)(insightLogic.zm),{shown}=(0,index_esm.useValues)(funnelsCueLogic(insightProps)),{optOut,displayAsFunnel}=(0,index_esm.useActions)(funnelsCueLogic(insightProps));return shown?(0,jsx_runtime.jsx)(LemonBanner.V,{type:"info",action:{onClick:displayAsFunnel,children:"Try this insight as a funnel"},onClose:()=>optOut(!0),className:"mb-4",children:"Looks like you have multiple events. A funnel can help better visualize your user’s progression across each event."}):null}function InsightsNav(){let{insightProps}=(0,index_esm.useValues)(insightLogic.zm),{activeView,tabs}=(0,index_esm.useValues)((0,insightNavLogic.C)(insightProps)),{setActiveView}=(0,index_esm.useActions)((0,insightNavLogic.C)(insightProps));return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(FunnelsCue,{}),(0,jsx_runtime.jsx)(AlertDeletionWarning,{}),(0,jsx_runtime.jsx)(LemonTabs.T,{activeKey:activeView,onChange:newKey=>setActiveView(newKey),tabs:tabs.map(_ref=>{let{label,type,dataAttr}=_ref;return{key:type,label:(0,jsx_runtime.jsx)(Link.r,{to:insights_utils.Uz[type],preventClick:!0,"data-attr":dataAttr,children:(0,jsx_runtime.jsx)(Tooltip.u,{placement:"top",title:SavedInsights.INSIGHT_TYPES_METADATA[type].description,children:(0,jsx_runtime.jsx)("span",{children:label})})})}})})]})}function Insight(_ref){let{insightId}=_ref,{insightMode,legacyInsight}=(0,index_esm.useValues)(insightSceneLogic.T),logic=(0,insightLogic.zm)({dashboardItemId:insightId||"new",cachedInsight:legacyInsight?.short_id===insightId?legacyInsight:null}),{insightProps}=(0,index_esm.useValues)(logic),{query,showQueryEditor}=(0,index_esm.useValues)((0,insightDataLogic.Sw)(insightProps)),{setQuery:setInsightQuery}=(0,index_esm.useActions)((0,insightDataLogic.Sw)(insightProps));(0,index_esm.useMountedLogic)(insightCommandLogic(insightProps));let actuallyShowQueryEditor=insightMode===types.LO.Edit&&showQueryEditor;return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:insightLogic.zm,props:insightProps,children:(0,jsx_runtime.jsxs)("div",{className:"Insight",children:[(0,jsx_runtime.jsx)(InsightPageHeader,{insightLogicProps:insightProps}),insightMode===types.LO.Edit&&(0,jsx_runtime.jsx)(InsightsNav,{}),(0,jsx_runtime.jsx)(Query.A,{query:(0,queries_utils.KN)(query)?{...query,full:!0}:query,setQuery:insightMode===types.LO.Edit?(query,isSourceUpdate)=>{(!(0,queries_utils.KN)(query)||isSourceUpdate)&&setInsightQuery(query)}:void 0,readOnly:insightMode!==types.LO.Edit,context:{showOpenEditorButton:!1,showQueryEditor:actuallyShowQueryEditor,showQueryHelp:insightMode===types.LO.Edit&&!(0,queries_utils.KJ)(query),insightProps}})]})})}var LemonSkeleton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonSkeleton/index.ts");function InsightSkeleton(){return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"my-6 space-y-4",children:[(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"w-1/4 h-4"}),(0,jsx_runtime.jsx)(LemonSkeleton.y,{className:"w-1/2 h-4",repeat:3}),(0,jsx_runtime.jsx)(LemonSkeleton.y,{}),(0,jsx_runtime.jsxs)("div",{className:"border rounded p-6 flex items-center gap-4",children:[(0,jsx_runtime.jsx)("div",{className:"flex-1 space-y-2",children:(0,jsx_runtime.jsx)(LemonSkeleton.y.Row,{repeat:3})}),(0,jsx_runtime.jsx)("div",{className:"flex-1 space-y-2",children:(0,jsx_runtime.jsx)(LemonSkeleton.y.Row,{repeat:3})})]}),(0,jsx_runtime.jsx)("div",{className:"border rounded p-6 min-h-100"})]})})}function InsightScene(){let{insightId,queryBasedInsight:insight,insightLogicRef}=(0,index_esm.useValues)(insightSceneLogic.T);return"new"===insightId||insightId&&insight?.id&&insight?.short_id?(0,jsx_runtime.jsx)(Insight,{insightId:insightId}):insightLogicRef?.logic?.values?.insightLoading?(0,jsx_runtime.jsx)(InsightSkeleton,{}):(0,jsx_runtime.jsx)(NotFound.T,{object:"insight"})}let scene={component:InsightScene,logic:insightSceneLogic.T}}}]);