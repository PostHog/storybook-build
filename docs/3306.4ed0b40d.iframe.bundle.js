(self.webpackChunk_posthog_storybook=self.webpackChunk_posthog_storybook||[]).push([[3306],{"../../frontend/src/scenes/experiments/Experiment.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Experiment:()=>Experiment,scene:()=>scene});var index_esm=__webpack_require__("../../node_modules/.pnpm/kea@3.1.7_react@18.2.0/node_modules/kea/lib/index.esm.js"),NotFound=__webpack_require__("../../frontend/src/lib/components/NotFound/index.tsx"),useFeatureFlag=__webpack_require__("../../frontend/src/lib/hooks/useFeatureFlag.ts"),lib=__webpack_require__("../../node_modules/.pnpm/kea-forms@3.2.0_kea@3.1.7_react@18.2.0_/node_modules/kea-forms/lib/index.js"),react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.33.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),AccessControlAction=__webpack_require__("../../frontend/src/lib/components/AccessControlAction.tsx"),SeriesGlyph=__webpack_require__("../../frontend/src/lib/components/SeriesGlyph.tsx"),constants=__webpack_require__("../../frontend/src/lib/constants.tsx"),groupsAccessLogic=__webpack_require__("../../frontend/src/lib/introductions/groupsAccessLogic.ts"),LemonButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/index.ts"),LemonField=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonRadio=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonRadio/index.ts");__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSelect/index.ts");var icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),utils=__webpack_require__("../../frontend/src/lib/utils.tsx"),accessControlUtils=__webpack_require__("../../frontend/src/lib/utils/accessControlUtils.ts"),css_classes=__webpack_require__("../../frontend/src/lib/utils/css-classes.ts"),eventUsageLogic=__webpack_require__("../../frontend/src/lib/utils/eventUsageLogic.ts"),experimentsLogic=__webpack_require__("../../frontend/src/scenes/experiments/experimentsLogic.ts"),FeatureFlagFilters=__webpack_require__("../../frontend/src/scenes/feature-flags/FeatureFlagFilters.tsx"),urls=__webpack_require__("../../frontend/src/scenes/urls.ts"),SceneContent=__webpack_require__("../../frontend/src/layout/scenes/components/SceneContent.tsx"),SceneDivider=__webpack_require__("../../frontend/src/layout/scenes/components/SceneDivider.tsx"),SceneSection=__webpack_require__("../../frontend/src/layout/scenes/components/SceneSection.tsx"),SceneTitleSection=__webpack_require__("../../frontend/src/layout/scenes/components/SceneTitleSection.tsx"),types=__webpack_require__("../../frontend/src/types.ts"),experiments_experimentLogic=__webpack_require__("../../frontend/src/scenes/experiments/experimentLogic.tsx"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");let ExperimentFormFields=()=>{var _experiment$parameter;let{formMode,experiment,groupTypes,aggregationLabel,hasPrimaryMetricSet,validExistingFeatureFlag,createExperimentLoading}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{addVariant,removeVariant,setExperiment,submitExperiment,setExperimentType,validateFeatureFlag}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{webExperimentsAvailable,unavailableFeatureFlagKeys}=(0,index_esm.useValues)(experimentsLogic.OK),{groupsAccessStatus}=(0,index_esm.useValues)(groupsAccessLogic.e),{reportExperimentFeatureFlagModalOpened,reportExperimentFeatureFlagSelected}=(0,index_esm.useActions)(eventUsageLogic.vx),[showFeatureFlagSelector,setShowFeatureFlagSelector]=(0,react.useState)(!1);return(0,jsx_runtime.jsxs)(SceneContent._,{children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:experiment.name,description:null,resourceType:{type:"experiment"},canEdit:(0,accessControlUtils.y9)(types.qR.Experiment,types.W$.Editor,experiment.user_access_level),onNameChange:name=>{setExperiment({name})},forceEdit:"create"===formMode}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),hasPrimaryMetricSet&&"duplicate"!==formMode&&(0,jsx_runtime.jsx)(src.Vp,{type:"info",className:"my-4",children:"Fill out the details below to create your experiment based off of the insight."}),"duplicate"===formMode&&(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"my-4",children:["We'll copy all settings, including metrics and exposure configuration, from theÂ ",(0,jsx_runtime.jsxs)(src.rU,{target:"_blank",className:"font-semibold items-center",to:urls.j.experiment(experiment.id),children:["original experiment",(0,jsx_runtime.jsx)(icons.pF,{fontSize:"18"})]}),"."]}),(0,jsx_runtime.jsx)(SceneSection.S,{title:"Feature flag key",description:"Each experiment is backed by a feature flag.",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"feature_flag_key",className:"max-w-120",help:(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-between",children:(0,jsx_runtime.jsxs)(LemonButton.J,{type:"secondary",size:"xsmall",onClick:()=>{reportExperimentFeatureFlagModalOpened(),setShowFeatureFlagSelector(!0)},children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconToggle,{className:"mr-1"}),"Link to existing feature flag"]})}),children:(0,jsx_runtime.jsx)(src.DF,{placeholder:"pricing-page-conversion","data-attr":"experiment-feature-flag-key",onFocus:()=>{!experiment.feature_flag_key&&experiment.name&&setExperiment({feature_flag_key:generateFeatureFlagKey(experiment.name,unavailableFeatureFlagKeys)})}})})}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsx)(SceneSection.S,{title:"Hypothesis / Description",description:"Add your hypothesis for this test",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"description",className:"max-w-120",children:(0,jsx_runtime.jsx)(src._V,{placeholder:"The goal of this experiment is ...","data-attr":"experiment-description"})})}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsx)(SelectExistingFeatureFlagModal,{isOpen:showFeatureFlagSelector,onClose:()=>setShowFeatureFlagSelector(!1),onSelect:flag=>{reportExperimentFeatureFlagSelected(flag.key),setExperiment({feature_flag_key:flag.key,parameters:{...experiment.parameters,feature_flag_variants:flag.filters?.multivariate?.variants||[]}}),validateFeatureFlag(flag.key),setShowFeatureFlagSelector(!1)}}),webExperimentsAvailable&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(SceneSection.S,{title:"Experiment type",description:"Select your experiment setup, this cannot be changed once saved.",className:"gap-y-0",children:(0,jsx_runtime.jsx)(LemonRadio._,{value:experiment.type,className:"flex flex-col gap-2 mt-4",onChange:type=>{setExperimentType(type)},options:[{value:"product",description:(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary",children:"Use custom code to manage how variants modify your product."}),label:"Product experiment"},{value:"web",label:"No-code web experiment",description:(0,jsx_runtime.jsx)("div",{className:"text-xs text-secondary",children:"Define variants on your website using the PostHog toolbar, no coding required."})}]})}),(0,jsx_runtime.jsx)(SceneDivider.V,{})]}),groupsAccessStatus===groupsAccessLogic.Q.AlreadyUsing&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(SceneSection.S,{title:"Participant type",description:"Determines on what level you want to aggregate metrics. You can change this later, but flag values for users will change so you need to reset the experiment for accurate results.",className:"gap-y-0",children:(0,jsx_runtime.jsx)(LemonRadio._,{className:"mt-4",value:void 0!=experiment.parameters.aggregation_group_type_index?experiment.parameters.aggregation_group_type_index:-1,onChange:rawGroupTypeIndex=>{let groupTypeIndex=-1!==rawGroupTypeIndex?rawGroupTypeIndex:void 0;setExperiment({parameters:{...experiment.parameters,aggregation_group_type_index:null!=groupTypeIndex?groupTypeIndex:void 0}})},options:[{value:-1,label:"Persons"},...Array.from(groupTypes.values()).map(groupType=>({value:groupType.group_type_index,label:(0,utils.fm)(aggregationLabel(groupType.group_type_index).plural)}))]})}),(0,jsx_runtime.jsx)(SceneDivider.V,{})]}),validExistingFeatureFlag&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(SceneSection.S,{title:"Variants",description:"Existing feature flag configuration will be applied to the experiment.",children:(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)("div",{children:"Existing feature flag configuration will be applied to the experiment."}),(0,jsx_runtime.jsx)(src.rU,{to:urls.j.featureFlag(validExistingFeatureFlag.id),target:"_blank",className:"flex items-center",children:(0,jsx_runtime.jsx)(icons.pF,{className:"ml-1"})})]})})}),(0,jsx_runtime.jsx)(SceneDivider.V,{})]}),!validExistingFeatureFlag&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(SceneSection.S,{title:"Variants",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Add up to ",constants.Rp-1," variants to test against your control."]}),children:(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-2 gap-4 max-w-160",children:[(0,jsx_runtime.jsxs)("div",{className:"max-w-60",children:[(0,jsx_runtime.jsx)("h3",{className:(0,css_classes.cn)("text-sm"),children:"Control"}),(0,jsx_runtime.jsx)("div",{className:"flex items-center",children:(0,jsx_runtime.jsxs)(lib.Group,{name:["parameters","feature_flag_variants",0],children:[(0,jsx_runtime.jsx)(SeriesGlyph.jc,{index:0,className:"h-7 w-7 text-base"}),(0,jsx_runtime.jsx)(LemonField.D,{name:"key",className:"ml-2 flex-grow",children:(0,jsx_runtime.jsx)(src.DF,{disabled:!0,"data-attr":"experiment-variant-key","data-key-index":0,className:"ph-ignore-input",fullWidth:!0,autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:!1})})]},0)}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-xs mt-2",children:"Included automatically, cannot be edited or removed"})]}),(0,jsx_runtime.jsxs)("div",{className:"max-w-100",children:[(0,jsx_runtime.jsx)("h3",{className:(0,css_classes.cn)("text-sm"),children:"Test(s)"}),experiment.parameters.feature_flag_variants?.map((_,index)=>0===index?null:jsx_runtime.jsx(lib.Group,{name:["parameters","feature_flag_variants",index],children:jsx_runtime.jsxs("div",{className:`flex items-center deprecated-space-x-2 ${index>1&&"mt-2"}`,children:[jsx_runtime.jsx(SeriesGlyph.jc,{index:index,className:"h-7 w-7 text-base"}),jsx_runtime.jsx(LemonField.D,{name:"key",className:"flex-grow",children:jsx_runtime.jsx(src.DF,{"data-attr":"experiment-variant-key","data-key-index":index.toString(),className:"ph-ignore-input",fullWidth:!0,autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:!1})}),jsx_runtime.jsx("div",{className:`${1===index&&"pr-9"}`,children:1!==index&&jsx_runtime.jsx(src.u,{title:"Delete this variant",placement:"top-start",children:jsx_runtime.jsx(LemonButton.J,{size:"small",icon:jsx_runtime.jsx(posthog_icons_es.IconTrash,{}),onClick:()=>removeVariant(index)})})})]},`variant-${index}`)},index)),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-xs ml-9 mr-20 mt-2",children:"Alphanumeric, hyphens and underscores only"}),(null!==(_experiment$parameter=experiment.parameters.feature_flag_variants.length)&&void 0!==_experiment$parameter?_experiment$parameter:0)<constants.Rp&&(0,jsx_runtime.jsx)(LemonButton.J,{className:"ml-9 mt-2",type:"secondary",onClick:()=>addVariant(),icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),"data-attr":"add-test-variant",children:"Add test variant"})]})]})}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsx)("div",{className:(0,css_classes.cn)("mt-6 pb-2 max-w-150 mt-0 pb-0"),children:(0,jsx_runtime.jsx)(LemonField.D,{name:"parameters.ensure_experience_continuity",children:_ref=>{let{value,onChange}=_ref;return(0,jsx_runtime.jsxs)("label",{className:"border rounded p-4 group",htmlFor:"continuity-checkbox",children:[(0,jsx_runtime.jsx)(src.Hw,{id:"continuity-checkbox",label:"Persist flag across authentication steps",onChange:()=>onChange(!value),fullWidth:!0,checked:value}),(0,jsx_runtime.jsxs)("div",{className:"text-secondary text-sm pl-6",children:["If your feature flag is evaluated for anonymous users, use this option to ensure the flag value remains consistent after the user logs in. Depending on your setup, this option may not always be appropriate. Note that this feature requires creating profiles for anonymous users."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/feature-flags/creating-feature-flags#persisting-feature-flags-across-authentication-steps",target:"_blank",children:"Learn more"})]})]})}})})]}),(0,jsx_runtime.jsx)(AccessControlAction.b,{resourceType:types.qR.Experiment,minAccessLevel:types.W$.Editor,userAccessLevel:experiment.user_access_level,children:(0,jsx_runtime.jsx)(LemonButton.J,{className:(0,css_classes.cn)("w-fit"),type:"primary","data-attr":"save-experiment",onClick:()=>submitExperiment(),loading:createExperimentLoading,children:"Save as draft"})})]})};function ExperimentForm(){let{props}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);return(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(lib.Form,{id:"experiment-step",logic:experiments_experimentLogic.Wl,formKey:"experiment",props:props,enableFormOnSubmit:!0,className:"deprecated-space-y-6 experiment-form",children:(0,jsx_runtime.jsx)(ExperimentFormFields,{})})})}let generateFeatureFlagKey=(name,unavailableFeatureFlagKeys)=>{let baseKey=name.toLowerCase().replace(/[^A-Za-z0-9-_]+/g,"-").replace(/-+$/,"").replace(/^-+/,""),key=baseKey,counter=1;for(;unavailableFeatureFlagKeys.has(key);)key=`${baseKey}-${counter}`,counter++;return key},SelectExistingFeatureFlagModal=_ref2=>{let{isOpen,onClose,onSelect}=_ref2,{featureFlagModalFeatureFlags,featureFlagModalFeatureFlagsLoading,featureFlagModalFilters,featureFlagModalPagination}=(0,index_esm.useValues)(experimentsLogic.OK),{setFeatureFlagModalFilters,resetFeatureFlagModalFilters}=(0,index_esm.useActions)(experimentsLogic.OK),handleClose=()=>{resetFeatureFlagModalFilters(),onClose()},filtersSection=(0,jsx_runtime.jsx)("div",{className:"mb-4",children:(0,jsx_runtime.jsx)(FeatureFlagFilters.a,{filters:featureFlagModalFilters,setFeatureFlagsFilters:setFeatureFlagModalFilters,searchPlaceholder:"Search for feature flags",filtersConfig:{search:!0}})});return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:handleClose,title:"Choose an existing feature flag",width:"50%",children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"text-muted mb-2 max-w-xl",children:["Select an existing multivariate feature flag to use with this experiment. The feature flag must use multiple variants with ",(0,jsx_runtime.jsx)("code",{children:"'control'"})," as the first, and not be associated with an existing experiment."]}),filtersSection,(0,jsx_runtime.jsx)(src.g3,{id:"ff",dataSource:featureFlagModalFeatureFlags.results,loading:featureFlagModalFeatureFlagsLoading,useURLForSorting:!1,columns:[{title:"Key",dataIndex:"key",sorter:(a,b)=>(a.key||"").localeCompare(b.key||""),render:(key,flag)=>(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:key}),(0,jsx_runtime.jsx)(src.rU,{to:urls.j.featureFlag(flag.id),target:"_blank",className:"flex items-center",children:(0,jsx_runtime.jsx)(icons.pF,{className:"ml-1"})})]})},{title:"Name",dataIndex:"name",sorter:(a,b)=>(a.name||"").localeCompare(b.name||"")},{title:null,render:function RenderActions(_,flag){return(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-end",children:(0,jsx_runtime.jsx)(LemonButton.J,{size:"xsmall",type:"primary",disabledReason:void 0,onClick:()=>{onSelect(flag),handleClose()},children:"Select"})})}}],emptyState:"No feature flags match these filters.",pagination:featureFlagModalPagination,onSort:newSorting=>setFeatureFlagModalFilters({order:newSorting?`${-1===newSorting.order?"-":""}${newSorting.columnKey}`:void 0,page:1})})]})})};var ActivityLog=__webpack_require__("../../frontend/src/lib/components/ActivityLog/ActivityLog.tsx"),AuthorizedUrlList=__webpack_require__("../../frontend/src/lib/components/AuthorizedUrlList/AuthorizedUrlList.tsx"),authorizedUrlListLogic=__webpack_require__("../../frontend/src/lib/components/AuthorizedUrlList/authorizedUrlListLogic.ts"),LemonDialog=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonDialog/index.ts");function WebExperimentImplementationDetails(_ref){let{experiment}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)("div",{className:"border p-6 rounded bg-surface-primary deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold leading-tight text-base text-current",children:"Define variant changes directly on your website"}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-secondary",children:"Use our toolbar to select elements and apply transformations for each variant."}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(LemonButton.J,{size:"small",type:"secondary",onClick:()=>{LemonDialog.LemonDialog.open({title:"Select a domain",description:experiment?.id?"Choose the domain on which to edit this experiment":"Choose the domain on which to create this experiment",content:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(AuthorizedUrlList.t,{experimentId:experiment?.id,type:authorizedUrlListLogic.uw.TOOLBAR_URLS})}),primaryButton:{children:"Close",type:"secondary"}})},sideIcon:(0,jsx_runtime.jsx)(icons.UE,{}),children:"Launch toolbar on your website"})})]})})})}var clsx_m=__webpack_require__("../../node_modules/.pnpm/clsx@1.2.1/node_modules/clsx/dist/clsx.m.js"),CopyToClipboard=__webpack_require__("../../frontend/src/lib/components/CopyToClipboard.tsx"),dayjs=__webpack_require__("../../frontend/src/lib/dayjs.ts"),usePeriodicRerender=__webpack_require__("../../frontend/src/lib/hooks/usePeriodicRerender.ts"),LemonTextArea=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTextArea/LemonTextArea.tsx"),Label=__webpack_require__("../../frontend/src/lib/ui/Label/Label.tsx"),StatsMethodModal=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentView/StatsMethodModal.tsx"),components=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentView/components.tsx"),experiments_constants=__webpack_require__("../../frontend/src/scenes/experiments/constants.ts"),modalsLogic=__webpack_require__("../../frontend/src/scenes/experiments/modalsLogic.ts"),TZLabel=__webpack_require__("../../frontend/src/lib/components/TZLabel/index.tsx");let LegacyExperimentDate=_ref=>{let{label,date,onChange,selectionLimitDate,"data-attr":dataAttr}=_ref,[isDatePickerOpen,setIsDatePickerOpen]=(0,react.useState)(!1);return date?(0,jsx_runtime.jsxs)("div",{className:"block","data-attr":dataAttr,children:[(0,jsx_runtime.jsx)(Label._,{intent:"menu",children:label}),(0,jsx_runtime.jsx)("div",{className:"flex",children:isDatePickerOpen?(0,jsx_runtime.jsx)(src.he,{granularity:"minute",visible:!0,value:(0,dayjs.Bv)(date),onChange:newDate=>{newDate&&onChange&&onChange(newDate.toISOString())},onClose:()=>setIsDatePickerOpen(!1),onClickOutside:()=>setIsDatePickerOpen(!1),clearable:!1,selectionPeriod:"past",buttonProps:{size:"xsmall","data-attr":`${dataAttr}-picker`},selectionPeriodLimit:selectionLimitDate?(0,dayjs.Bv)(selectionLimitDate):void 0}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(TZLabel.w,{time:date}),(0,jsx_runtime.jsx)(src.Jp,{title:`Move ${label}`,"data-attr":`move-${dataAttr}`,icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{}),size:"small",onClick:()=>setIsDatePickerOpen(!0),noPadding:!0,className:"ml-2"})]})})]}):null};function LegacyExperimentDates(){let{experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{changeExperimentStartDate,changeExperimentEndDate}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{created_at,start_date,end_date}=experiment;return start_date||created_at?!start_date&&created_at?(0,jsx_runtime.jsxs)("div",{className:"flex flex-col","data-attr":"experiment-creation-date",children:[(0,jsx_runtime.jsx)(Label._,{intent:"menu",children:"Creation date"}),(0,jsx_runtime.jsx)(TZLabel.w,{time:created_at})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LegacyExperimentDate,{label:"Start Date",date:start_date,"data-attr":"experiment-start-date",onChange:changeExperimentStartDate}),(0,jsx_runtime.jsx)(LegacyExperimentDate,{label:"End Date",date:end_date,"data-attr":"experiment-end-date",selectionLimitDate:start_date,onChange:changeExperimentEndDate})]}):null}let ExperimentLastRefresh=_ref=>{let{isRefreshing,lastRefresh,onClick}=_ref;return(0,usePeriodicRerender.o)(15e3),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsx)(Label._,{intent:"menu",children:"Last refreshed"}),(0,jsx_runtime.jsxs)("div",{className:"inline-flex deprecated-space-x-2",children:[(0,jsx_runtime.jsx)("span",{className:`${lastRefresh?(0,dayjs.Bv)().diff((0,dayjs.Bv)(lastRefresh),"hours")>12?"text-danger":(0,dayjs.Bv)().diff((0,dayjs.Bv)(lastRefresh),"hours")>6?"text-warning":"":""}`,children:isRefreshing?"Loadingâ¦":lastRefresh?(0,dayjs.Bv)(lastRefresh).fromNow():"a while ago"}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",onClick:onClick,"data-attr":"refresh-experiment",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconRefresh,{}),tooltip:"Refresh experiment results"})]})]})};function LegacyExperimentInfo(){let{experiment,legacyPrimaryMetricsResults,legacySecondaryMetricsResults,primaryMetricsResults,secondaryMetricsResults,primaryMetricsResultsLoading,secondaryMetricsResultsLoading,statsMethod,usesNewQueryRunner}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{updateExperiment,refreshExperimentResults}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{openEditConclusionModal,openDescriptionModal,closeDescriptionModal,openStatsEngineModal}=(0,index_esm.useActions)(modalsLogic.l),{isDescriptionModalOpen}=(0,index_esm.useValues)(modalsLogic.l),[tempDescription,setTempDescription]=(0,react.useState)(experiment.description||"");(0,react.useEffect)(()=>{setTempDescription(experiment.description||"")},[experiment.description]);let{created_by}=experiment;if(!experiment.feature_flag)return null;let lastRefresh=legacyPrimaryMetricsResults?.[0]?.last_refresh||legacySecondaryMetricsResults?.[0]?.last_refresh||primaryMetricsResults?.[0]?.last_refresh||secondaryMetricsResults?.[0]?.last_refresh,status=(0,experimentsLogic.Ot)(experiment);return(0,jsx_runtime.jsxs)(SceneContent._,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap justify-between gap-4",children:[(0,jsx_runtime.jsxs)("div",{className:"inline-flex deprecated-space-x-8",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-col","data-attr":"experiment-status",children:[(0,jsx_runtime.jsx)(Label._,{intent:"menu",children:"Status"}),(0,jsx_runtime.jsx)(components.Nj,{status:status})]}),experiment.feature_flag&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsx)(Label._,{intent:"menu",children:"Feature flag"}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-1 items-center",children:[status===types.mN.Running&&!experiment.feature_flag.active&&(0,jsx_runtime.jsx)(src.u,{placement:"bottom",title:"Your experiment is running, but the linked flag is disabled. No data is being collected.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconWarning,{style:{transform:"translateY(2px)"},className:"mr-1 text-danger",fontSize:"18px"})}),(0,jsx_runtime.jsx)(CopyToClipboard.D,{iconStyle:{color:"var(--lemon-button-icon-opacity)"},className:"font-normal text-sm",description:"feature flag key",children:experiment.feature_flag.key}),(0,jsx_runtime.jsx)(src.rU,{target:"_blank",className:"font-semibold",to:experiment.feature_flag?urls.j.featureFlag(experiment.feature_flag.id):void 0,children:(0,jsx_runtime.jsx)(icons.pF,{fontSize:"18"})})]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsx)(Label._,{intent:"menu",children:"Stats Engine"}),(0,jsx_runtime.jsxs)("div",{className:"inline-flex deprecated-space-x-2",children:[(0,jsx_runtime.jsx)("span",{children:statsMethod===types.om.Bayesian?"Bayesian":"Frequentist"}),usesNewQueryRunner&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",onClick:()=>{openStatsEngineModal()},icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGear,{}),tooltip:"Change stats engine"}),(0,jsx_runtime.jsx)(StatsMethodModal.o,{})]})]})]})]}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col",children:(0,jsx_runtime.jsxs)("div",{className:"inline-flex deprecated-space-x-8",children:[experiment.start_date&&(0,jsx_runtime.jsx)(ExperimentLastRefresh,{isRefreshing:primaryMetricsResultsLoading||secondaryMetricsResultsLoading,lastRefresh:lastRefresh,onClick:()=>refreshExperimentResults(!0)}),(0,jsx_runtime.jsx)(LegacyExperimentDates,{}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col",children:[(0,jsx_runtime.jsx)(Label._,{intent:"menu",children:"Created by"}),created_by&&(0,jsx_runtime.jsx)(src.YY,{user:created_by,size:"md",showName:!0})]})]})})]}),(0,jsx_runtime.jsx)("div",{className:(0,css_classes.cn)("block mt-0"),children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-6",children:[(0,jsx_runtime.jsxs)("div",{className:"w-[500px]",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(Label._,{intent:"menu",children:"Hypothesis"}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{}),onClick:openDescriptionModal})]}),experiment.description?(0,jsx_runtime.jsx)("p",{className:(0,css_classes.cn)("py-2 m-0"),children:experiment.description}):(0,jsx_runtime.jsx)("p",{className:(0,css_classes.cn)("py-2 m-0 text-secondary"),children:"Add your hypothesis for this test"}),(0,jsx_runtime.jsx)(src.fQ,{isOpen:isDescriptionModalOpen,onClose:closeDescriptionModal,title:"Edit hypothesis",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 justify-end",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:closeDescriptionModal,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:()=>{updateExperiment({description:tempDescription}),closeDescriptionModal()},children:"Save"})]}),children:(0,jsx_runtime.jsx)(LemonTextArea._,{className:"w-full",value:tempDescription,onChange:value=>setTempDescription(value),placeholder:"Add your hypothesis for this test",minRows:6,maxLength:400})})]}),experiment.conclusion&&experiment.end_date&&(0,jsx_runtime.jsxs)("div",{className:"w-[500px]",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(Label._,{intent:"menu",children:"Conclusion"}),(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{}),onClick:openEditConclusionModal})]}),(0,jsx_runtime.jsxs)("div",{className:(0,css_classes.cn)("py-0"),children:[(0,jsx_runtime.jsxs)("div",{className:"font-semibold flex items-center gap-2",children:[(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)("w-2 h-2 rounded-full",experiments_constants.VS[experiment.conclusion]?.color||"")}),(0,jsx_runtime.jsx)("span",{children:experiments_constants.VS[experiment.conclusion]?.title||experiment.conclusion})]}),(0,jsx_runtime.jsx)("div",{children:experiment.conclusion_comment})]})]})]})})]})}var ExperimentImplementationDetails=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentImplementationDetails.tsx"),ExperimentMetricForm=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentMetricForm.tsx"),experiments_utils=__webpack_require__("../../frontend/src/scenes/experiments/utils.ts");let METRIC_CONTEXTS={primary:{type:"primary",field:"metrics",orderingField:"primary_metrics_ordered_uuids"},secondary:{type:"secondary",field:"metrics_secondary",orderingField:"secondary_metrics_ordered_uuids"}},experimentMetricModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","experiments","Metrics","experimentMetricModalLogic"]),(0,index_esm.actions)({openExperimentMetricModal:(context,metric)=>({metric,context}),closeExperimentMetricModal:!0,setMetric:metric=>({metric})}),(0,index_esm.reducers)({isModalOpen:[!1,{openExperimentMetricModal:()=>!0,closeExperimentMetricModal:()=>!1}],metric:[null,{openExperimentMetricModal:(_,_ref)=>{let{metric}=_ref;return null!=metric?metric:(0,experiments_utils.US)()},closeExperimentMetricModal:()=>null,setMetric:(_,_ref2)=>{let{metric}=_ref2;return null!=metric?metric:null}}],context:[METRIC_CONTEXTS.primary,{openExperimentMetricModal:(_,_ref3)=>{let{context}=_ref3;return context},closeExperimentMetricModal:()=>METRIC_CONTEXTS.primary}],isEditMode:[!1,{openExperimentMetricModal:(_,_ref4)=>{let{metric}=_ref4;return!!metric},closeExperimentMetricModal:()=>!1}]}),(0,index_esm.selectors)({isCreateMode:[s=>[s.isEditMode],isEditMode=>!isEditMode]})]);function ExperimentMetricModal(_ref){let{experiment,onSave,onDelete}=_ref,{isModalOpen,metric,context,isCreateMode,isEditMode}=(0,index_esm.useValues)(experimentMetricModalLogic),{closeExperimentMetricModal,setMetric:setModalMetric}=(0,index_esm.useActions)(experimentMetricModalLogic);return isModalOpen&&metric?(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isModalOpen,onClose:closeExperimentMetricModal,title:isCreateMode?"Create experiment metric":"Edit experiment metric",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center w-full",children:[isEditMode&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",status:"danger",onClick:()=>{src.dn.open({title:"Delete this metric?",content:(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:"This action cannot be undone."}),primaryButton:{children:"Delete",type:"primary",onClick:()=>onDelete(metric,context),size:"small"},secondaryButton:{children:"Cancel",type:"tertiary",size:"small"}})},children:"Delete"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 ml-auto",children:[(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-metric-form",type:"secondary",onClick:closeExperimentMetricModal,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-metric-form",onClick:()=>onSave(metric,context),type:"primary","data-attr":"save-experiment-metric",children:isCreateMode?"Create":"Save"})]})]}),children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{className:"mb-1",children:"Name (optional)"}),(0,jsx_runtime.jsx)(src.DF,{value:metric.name,onChange:newName=>{setModalMetric({...metric,name:newName})}})]}),(0,jsx_runtime.jsx)(ExperimentMetricForm.U,{metric:metric,handleSetMetric:setModalMetric,filterTestAccounts:experiment.exposure_criteria?.filterTestAccounts||!1})]}):null}var TaxonomicFilter_types=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/types.ts"),TestAccountFiltersSwitch=__webpack_require__("../../frontend/src/lib/components/TestAccountFiltersSwitch.tsx"),LemonBanner=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonBanner/index.ts"),ActionFilter=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilter.tsx"),ActionFilterRow=__webpack_require__("../../frontend/src/scenes/insights/filters/ActionFilter/ActionFilterRow/ActionFilterRow.tsx"),AggregationSelect=__webpack_require__("../../frontend/src/scenes/insights/filters/AggregationSelect.tsx"),teamLogic=__webpack_require__("../../frontend/src/scenes/teamLogic.tsx"),Query=__webpack_require__("../../frontend/src/queries/Query/Query.tsx"),filtersToQueryNode=__webpack_require__("../../frontend/src/queries/nodes/InsightQuery/utils/filtersToQueryNode.ts"),queryNodeToFilter=__webpack_require__("../../frontend/src/queries/nodes/InsightQuery/utils/queryNodeToFilter.ts"),schema_general=__webpack_require__("../../frontend/src/queries/schema/schema-general.ts"),Selectors=__webpack_require__("../../frontend/src/scenes/experiments/Metrics/Selectors.tsx");function FunnelsMetricForm(_ref){var _currentMetric$funnel,_currentMetric$funnel2;let{isSecondary=!1}=_ref,{currentTeam}=(0,index_esm.useValues)(teamLogic.teamLogic),{experiment,isExperimentRunning,editingPrimaryMetricUuid,editingSecondaryMetricUuid}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{setFunnelsMetric}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),hasFilters=(currentTeam?.test_account_filters||[]).length>0,metrics=isSecondary?experiment.metrics_secondary:experiment.metrics,metricUuid=isSecondary?editingSecondaryMetricUuid:editingPrimaryMetricUuid;if(!metricUuid)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let currentMetric=metrics.find(m=>m.uuid===metricUuid);if(!currentMetric)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let actionFilterProps={...Selectors.dF,actionsTaxonomicGroupTypes:[TaxonomicFilter_types.t.Events,TaxonomicFilter_types.t.Actions]};return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Name (optional)"}),(0,jsx_runtime.jsx)(src.DF,{value:currentMetric.name,onChange:newName=>{currentMetric.uuid&&setFunnelsMetric({uuid:currentMetric.uuid,name:newName,isSecondary})}})]}),(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(currentMetric.funnels_query),setFilters:_ref2=>{let{actions,events,data_warehouse}=_ref2,series=(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.None);currentMetric.uuid&&setFunnelsMetric({uuid:currentMetric.uuid,series,isSecondary})},typeKey:"experiment-metric",mathAvailability:ActionFilterRow.Qq.None,buttonCopy:"Add funnel step",showSeriesIndicator:!0,seriesIndicatorType:"numeric",sortable:!0,showNestedArrow:!0,...actionFilterProps}),(0,jsx_runtime.jsxs)("div",{className:"mt-4 deprecated-space-y-4",children:[(0,jsx_runtime.jsx)(Selectors.xE,{value:(0,AggregationSelect.eV)(null!==(_currentMetric$funnel=currentMetric.funnels_query.aggregation_group_type_index)&&void 0!==_currentMetric$funnel?_currentMetric$funnel:void 0,null!==(_currentMetric$funnel2=currentMetric.funnels_query.funnelsFilter?.funnelAggregateByHogQL)&&void 0!==_currentMetric$funnel2?_currentMetric$funnel2:void 0),onChange:value=>{currentMetric.uuid&&setFunnelsMetric({uuid:currentMetric.uuid,funnelAggregateByHogQL:value,isSecondary})}}),(0,jsx_runtime.jsx)(Selectors.IF,{funnelWindowInterval:currentMetric.funnels_query?.funnelsFilter?.funnelWindowInterval,funnelWindowIntervalUnit:currentMetric.funnels_query?.funnelsFilter?.funnelWindowIntervalUnit,onFunnelWindowIntervalChange:funnelWindowInterval=>{currentMetric.uuid&&setFunnelsMetric({uuid:currentMetric.uuid,funnelWindowInterval:funnelWindowInterval,isSecondary})},onFunnelWindowIntervalUnitChange:funnelWindowIntervalUnit=>{currentMetric.uuid&&setFunnelsMetric({uuid:currentMetric.uuid,funnelWindowIntervalUnit:funnelWindowIntervalUnit||void 0,isSecondary})}}),(0,jsx_runtime.jsx)(Selectors.f$,{value:(()=>{let breakdownAttributionType=currentMetric.funnels_query?.funnelsFilter?.breakdownAttributionType,breakdownAttributionValue=currentMetric.funnels_query?.funnelsFilter?.breakdownAttributionValue;return breakdownAttributionType?breakdownAttributionType===types.q9.Step?`${breakdownAttributionType}/${breakdownAttributionValue||0}`:breakdownAttributionType:types.q9.FirstTouch})(),onChange:value=>{if(!currentMetric.uuid)return;let[breakdownAttributionType,breakdownAttributionValue]=(value||"").split("/");setFunnelsMetric({uuid:currentMetric.uuid,breakdownAttributionType:breakdownAttributionType,breakdownAttributionValue:breakdownAttributionValue?parseInt(breakdownAttributionValue):void 0,isSecondary})},stepsLength:currentMetric.funnels_query?.series?.length}),(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=currentMetric.funnels_query?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{currentMetric.uuid&&setFunnelsMetric({uuid:currentMetric.uuid,filterTestAccounts:checked,isSecondary})},fullWidth:!0})]}),isExperimentRunning&&(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema_general.OH.InsightVizNode,source:currentMetric.funnels_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})}var SelectableCard=__webpack_require__("../../frontend/src/scenes/experiments/components/SelectableCard.tsx");function TrendsMetricForm(_ref){let{isSecondary=!1}=_ref,{experiment,isExperimentRunning,editingPrimaryMetricUuid,editingSecondaryMetricUuid}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{setTrendsMetric,setTrendsExposureMetric,setExperiment}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{currentTeam}=(0,index_esm.useValues)(teamLogic.teamLogic),hasFilters=(currentTeam?.test_account_filters||[]).length>0,[activeTab,setActiveTab]=(0,react.useState)("main"),metrics=isSecondary?experiment.metrics_secondary:experiment.metrics,metricUuid=isSecondary?editingSecondaryMetricUuid:editingPrimaryMetricUuid;if(!metricUuid)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let currentMetric=metrics.find(m=>m.uuid===metricUuid);if(!currentMetric)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let isDataWarehouseMetric=currentMetric.count_query?.series[0]?.kind===schema_general.OH.DataWarehouseNode;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTab,onChange:newKey=>setActiveTab(newKey),tabs:[{key:"main",label:"Main metric",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Name (optional)"}),(0,jsx_runtime.jsx)(src.DF,{value:currentMetric.name,onChange:newName=>{currentMetric.uuid&&setTrendsMetric({uuid:currentMetric.uuid,name:newName,isSecondary})}})]}),(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(currentMetric.count_query),setFilters:_ref2=>{let{actions,events,data_warehouse}=_ref2,series=(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.All);series[0].kind===schema_general.OH.DataWarehouseNode&&setExperiment({...experiment,[isSecondary?"metrics_secondary":"metrics"]:metrics.map(metric=>metric.uuid===metricUuid?{...metric,exposure_query:void 0}:metric)}),currentMetric.uuid&&setTrendsMetric({uuid:currentMetric.uuid,series,isSecondary})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!0,entitiesLimit:1,showNumericalPropsOnly:!0,allowedMathTypes:experiments_constants.BK,...Selectors.dF}),(0,jsx_runtime.jsx)("div",{className:"mt-4 deprecated-space-y-4",children:(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:!!hasFilters&&!!currentMetric.count_query?.filterTestAccounts,onChange:checked=>{currentMetric.uuid&&setTrendsMetric({uuid:currentMetric.uuid,filterTestAccounts:checked,isSecondary})},fullWidth:!0})}),isExperimentRunning&&(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema_general.OH.InsightVizNode,source:currentMetric.count_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})},{key:"exposure",label:"Exposure",content:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsx)(SelectableCard.u,{title:"Default",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Uses the number of unique users who trigger the"," ",(0,jsx_runtime.jsx)(src.oe,{children:"$feature_flag_called"})," event as your exposure count. This is the recommended setting for most experiments, as it accurately tracks variant exposure."]}),selected:!currentMetric.exposure_query,onClick:()=>{setExperiment({...experiment,[isSecondary?"metrics_secondary":"metrics"]:metrics.map(metric=>metric.uuid===metricUuid?{...metric,exposure_query:void 0}:metric)})}}),(0,jsx_runtime.jsx)(SelectableCard.u,{title:"Custom",description:"Define your own exposure metric for specific use cases, such as counting by sessions instead of users. This gives you full control but requires careful configuration.",selected:!!currentMetric.exposure_query,...isDataWarehouseMetric?{disabled:!0,disabledReason:"Custom exposure events are not supported for data warehouse metrics. Please contact support if you need this feature."}:{disabled:!1},onClick:()=>{setExperiment({...experiment,[isSecondary?"metrics_secondary":"metrics"]:metrics.map(metric=>metric.uuid===metricUuid?{...metric,exposure_query:{kind:schema_general.OH.TrendsQuery,series:[{kind:schema_general.OH.EventsNode,name:"$feature_flag_called",event:"$feature_flag_called",math:types.vN.UniqueUsers}],interval:"day",dateRange:{date_from:(0,dayjs.Bv)().subtract(constants.uq,"day").format("YYYY-MM-DDTHH:mm"),date_to:(0,dayjs.Bv)().endOf("d").format("YYYY-MM-DDTHH:mm"),explicitDate:!0},trendsFilter:{display:types.Qb.ActionsLineGraph},filterTestAccounts:!0}}:metric)})}})]}),currentMetric.exposure_query&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,queryNodeToFilter.ce)(currentMetric.exposure_query),setFilters:_ref3=>{let{actions,events,data_warehouse}=_ref3,series=(0,filtersToQueryNode.NG)({actions,events,data_warehouse},!0,ActionFilterRow.Qq.All);currentMetric.uuid&&setTrendsExposureMetric({uuid:currentMetric.uuid,series,isSecondary})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!0,entitiesLimit:1,showNumericalPropsOnly:!0,...Selectors.dF}),(0,jsx_runtime.jsx)("div",{className:"mt-4 deprecated-space-y-4",children:(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=currentMetric.exposure_query?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{currentMetric.uuid&&setTrendsExposureMetric({uuid:currentMetric.uuid,filterTestAccounts:checked,isSecondary})},fullWidth:!0})}),isExperimentRunning&&(0,jsx_runtime.jsxs)(LemonBanner.V,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",constants.uq," ","days of data. This can cause a mismatch between the preview and the actual results."]}),(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(Query.A,{query:{kind:schema_general.OH.InsightVizNode,source:currentMetric.exposure_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})]})}]})})}function LegacyMetricModal(_ref){let{experimentId,isSecondary}=_ref,{experiment,experimentLoading,getInsightType,editingPrimaryMetricUuid,editingSecondaryMetricUuid}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{updateExperimentMetrics,setExperiment,restoreUnmodifiedExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closePrimaryMetricModal,closeSecondaryMetricModal}=(0,index_esm.useActions)(modalsLogic.l),{isPrimaryMetricModalOpen,isSecondaryMetricModalOpen}=(0,index_esm.useValues)(modalsLogic.l),metricUuid=isSecondary?editingSecondaryMetricUuid:editingPrimaryMetricUuid,metricsField=isSecondary?"metrics_secondary":"metrics";if(!metricUuid)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let metrics=experiment[metricsField],metric=metrics.find(m=>m.uuid===metricUuid);if(!metric)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let insightType=getInsightType(metric),funnelStepsLength=metric?.funnels_query?.series?.length||0,onClose=()=>{restoreUnmodifiedExperiment(),isSecondary?closeSecondaryMetricModal():closePrimaryMetricModal()};return(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isSecondary?isSecondaryMetricModalOpen:isPrimaryMetricModalOpen,onClose:onClose,width:1e3,title:"Edit experiment metric",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center w-full",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",status:"danger",onClick:()=>{src.dn.open({title:"Delete this metric?",content:(0,jsx_runtime.jsx)("div",{className:"text-sm text-secondary",children:"This action cannot be undone."}),primaryButton:{children:"Delete",type:"primary",onClick:()=>{setExperiment({[metricsField]:metrics.filter(m=>m.uuid!==metricUuid)}),updateExperimentMetrics(),isSecondary?closeSecondaryMetricModal():closePrimaryMetricModal()},size:"small"},secondaryButton:{children:"Cancel",type:"tertiary",size:"small"}})},children:"Delete"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 ml-auto",children:[(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-goal-form",type:"secondary",onClick:onClose,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{disabledReason:insightType===types.dw.FUNNELS&&funnelStepsLength<2&&"The experiment needs at least two funnel steps.",form:"edit-experiment-goal-form",onClick:()=>{updateExperimentMetrics(),isSecondary?closeSecondaryMetricModal():closePrimaryMetricModal()},type:"primary",loading:experimentLoading,"data-attr":"create-annotation-submit",children:"Save"})]})]}),children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center w-full gap-2 mb-4",children:[(0,jsx_runtime.jsx)("span",{children:"Metric type"}),(0,jsx_runtime.jsx)(src.Yv,{"data-attr":"metrics-selector",value:insightType,onChange:newInsightType=>{let newMetric=newInsightType===types.dw.TRENDS?(0,experiments_utils.ug)():(0,experiments_utils.xs)();setExperiment({...experiment,[metricsField]:metrics.map(m=>m.uuid===metricUuid?{...newMetric,uuid:metricUuid,name:m.name}:m)})},options:[{value:types.dw.TRENDS,label:(0,jsx_runtime.jsx)("b",{children:"Trends"})},{value:types.dw.FUNNELS,label:(0,jsx_runtime.jsx)("b",{children:"Funnels"})}]})]}),insightType===types.dw.TRENDS?(0,jsx_runtime.jsx)(TrendsMetricForm,{isSecondary:isSecondary}):(0,jsx_runtime.jsx)(FunnelsMetricForm,{isSecondary:isSecondary})]})}function LegacyMetricSourceModal(_ref){let{experimentId,isSecondary}=_ref,{experiment,usesNewQueryRunner}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{setExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closePrimaryMetricSourceModal,closeSecondaryMetricSourceModal,openPrimaryMetricModal,openSecondaryMetricModal,openPrimarySharedMetricModal,openSecondarySharedMetricModal}=(0,index_esm.useActions)(modalsLogic.l),{isPrimaryMetricSourceModalOpen,isSecondaryMetricSourceModalOpen}=(0,index_esm.useValues)(modalsLogic.l),metricsField=isSecondary?"metrics_secondary":"metrics",closeCurrentModal=isSecondary?closeSecondaryMetricSourceModal:closePrimaryMetricSourceModal,openMetricModal=isSecondary?openSecondaryMetricModal:openPrimaryMetricModal,openSharedMetricModal=isSecondary?openSecondarySharedMetricModal:openPrimarySharedMetricModal;return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isSecondary?isSecondaryMetricSourceModalOpen:isPrimaryMetricSourceModalOpen,onClose:closeCurrentModal,width:1e3,title:"Choose metric source",children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 cursor-pointer p-4 rounded border hover:border-accent",onClick:()=>{closeCurrentModal();let defaultMetric=usesNewQueryRunner?(0,experiments_utils.US)():(0,experiments_utils.xs)(),newMetrics=[...experiment[metricsField],defaultMetric];setExperiment({[metricsField]:newMetrics}),defaultMetric.uuid&&openMetricModal(defaultMetric.uuid)},children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,jsx_runtime.jsx)("span",{children:"Single-use"})}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Create a new metric specific to this experiment."})]}),(0,jsx_runtime.jsxs)("div",{className:"flex-1 cursor-pointer p-4 rounded border hover:border-accent",onClick:()=>{closeCurrentModal(),openSharedMetricModal(null)},children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,jsx_runtime.jsx)("span",{children:"Shared"})}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Use a pre-configured metric that can be reused across experiments."})]})]})})}var ObjectTags=__webpack_require__("../../frontend/src/lib/components/ObjectTags/ObjectTags.tsx"),LemonTable=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTable/index.ts"),userLogic=__webpack_require__("../../frontend/src/scenes/userLogic.ts");function LegacySharedMetricModal(_ref){let{experimentId,isSecondary}=_ref,{experiment,compatibleSharedMetrics,editingSharedMetricId}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{addSharedMetricsToExperiment,removeSharedMetricFromExperiment,restoreUnmodifiedExperiment,setExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closePrimarySharedMetricModal,closeSecondarySharedMetricModal}=(0,index_esm.useActions)(modalsLogic.l),{isPrimarySharedMetricModalOpen,isSecondarySharedMetricModalOpen}=(0,index_esm.useValues)(modalsLogic.l),[selectedMetricIds,setSelectedMetricIds]=(0,react.useState)([]),mode=editingSharedMetricId?"edit":"create",{hasAvailableFeature}=(0,index_esm.useValues)(userLogic.userLogic);if(!compatibleSharedMetrics)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let onClose=()=>{restoreUnmodifiedExperiment(),isSecondary?closeSecondarySharedMetricModal():closePrimarySharedMetricModal()},availableSharedMetrics=compatibleSharedMetrics.filter(metric=>!experiment.saved_metrics.some(savedMetric=>savedMetric.saved_metric===metric.id)),availableTags=Array.from(new Set(availableSharedMetrics.filter(metric=>metric.tags).flatMap(metric=>metric.tags).filter(Boolean))).sort();return(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isSecondary?isSecondarySharedMetricModalOpen:isPrimarySharedMetricModalOpen,onClose:onClose,width:500,title:"create"===mode?"Select one or more shared metrics":"Shared metric",footer:(0,jsx_runtime.jsxs)("div",{className:"flex justify-between w-full",children:[(0,jsx_runtime.jsx)("div",{children:editingSharedMetricId&&(0,jsx_runtime.jsx)(src.Jp,{status:"danger",onClick:()=>{let metric=compatibleSharedMetrics.find(m=>m.id===editingSharedMetricId);if(metric){let newOrderingArray=(0,experiments_utils.jz)(experiment,metric.query.uuid,!!isSecondary);setExperiment({[isSecondary?"secondary_metrics_ordered_uuids":"primary_metrics_ordered_uuids"]:newOrderingArray})}removeSharedMetricFromExperiment(editingSharedMetricId),isSecondary?closeSecondarySharedMetricModal():closePrimarySharedMetricModal()},type:"secondary",children:"Remove from experiment"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:onClose,type:"secondary",children:"Cancel"}),"create"===mode&&(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{var _experiment$secondary,_experiment$primary_m;let newOrderingArray=isSecondary?null!==(_experiment$secondary=experiment.secondary_metrics_ordered_uuids)&&void 0!==_experiment$secondary?_experiment$secondary:[]:null!==(_experiment$primary_m=experiment.primary_metrics_ordered_uuids)&&void 0!==_experiment$primary_m?_experiment$primary_m:[];selectedMetricIds.forEach(metricId=>{let metric=compatibleSharedMetrics.find(m=>m.id===metricId);metric&&(newOrderingArray=(0,experiments_utils.yR)({...experiment,[isSecondary?"secondary_metrics_ordered_uuids":"primary_metrics_ordered_uuids"]:newOrderingArray},metric.query.uuid,!!isSecondary))}),setExperiment({[isSecondary?"secondary_metrics_ordered_uuids":"primary_metrics_ordered_uuids"]:newOrderingArray}),addSharedMetricsToExperiment(selectedMetricIds,{type:isSecondary?"secondary":"primary"}),isSecondary?closeSecondarySharedMetricModal():closePrimarySharedMetricModal()},type:"primary",disabledReason:(()=>{if(0===selectedMetricIds.length)return"Please select at least one metric"})(),children:selectedMetricIds.length<2?"Add metric":"Add metrics"})]})]}),children:["create"===mode&&(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:availableSharedMetrics.length>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[experiment.saved_metrics.length>0&&(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:`Hiding ${experiment.saved_metrics.length} shared ${experiment.saved_metrics.length>1?"metrics":"metric"} already in use with this experiment.`}),hasAvailableFeature(types.P$.TAGGING)&&availableTags.length>0&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Quick select:"}),availableTags.map((tag,index)=>(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"secondary",onClick:()=>{setSelectedMetricIds(availableSharedMetrics.filter(metric=>metric.tags?.includes(tag)).map(metric=>metric.id))},children:tag},index))]}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:availableSharedMetrics,columns:[{title:"",key:"checkbox",render:(_,metric)=>(0,jsx_runtime.jsx)("input",{type:"checkbox",checked:selectedMetricIds.includes(metric.id),onChange:e=>{e.target.checked?setSelectedMetricIds([...selectedMetricIds,metric.id]):setSelectedMetricIds(selectedMetricIds.filter(id=>id!==metric.id))}})},{title:"Name",dataIndex:"name",key:"name"},{title:"Description",dataIndex:"description",key:"description"},...hasAvailableFeature(types.P$.TAGGING)?[{title:"Tags",dataIndex:"tags",key:"tags",render:(_,metric)=>(0,jsx_runtime.jsx)(ObjectTags.D,{tags:metric.tags||[],staticOnly:!0})}]:[],{title:"Type",key:"type",render:(_,metric)=>metric.query.kind===schema_general.OH.ExperimentMetric?metric.query.metric_type:metric.query.kind===schema_general.OH.ExperimentTrendsQuery?"Trend":"Funnel"}],footer:(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center m-2",children:(0,jsx_runtime.jsx)(src.Jp,{to:`${urls.j.experiments()}?tab=shared-metrics`,size:"xsmall",type:"tertiary",children:"See all shared metrics"})})})]}):(0,jsx_runtime.jsx)(src.Vp,{className:"w-full",type:"info",action:{children:"New shared metric",to:urls.j.experimentsSharedMetric("new")},children:compatibleSharedMetrics.length>0?"All of your shared metrics are already in this experiment.":"You don't have any shared metrics that match the experiment type. Shared metrics let you create reusable metrics that you can quickly add to any experiment."})}),editingSharedMetricId&&(0,jsx_runtime.jsx)("div",{children:(()=>{let metric=compatibleSharedMetrics.find(m=>m.id===editingSharedMetricId);return metric?(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold m-0 flex items-center",children:metric.name}),(0,jsx_runtime.jsx)(src.rU,{target:"_blank",className:"font-semibold flex items-center",to:urls.j.experimentsSharedMetric(metric.id),children:(0,jsx_runtime.jsx)(icons.pF,{fontSize:"18"})})]}),metric.description&&(0,jsx_runtime.jsx)("p",{className:"mt-2",children:metric.description}),"ExperimentTrendsQuery"===metric.query.kind&&(0,jsx_runtime.jsx)(components.EV,{query:metric.query.count_query}),"ExperimentFunnelsQuery"===metric.query.kind&&(0,jsx_runtime.jsx)(components.AG,{query:metric.query.funnels_query})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})})()})]})}let metricSourceModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","experiments","metrics","metricSourceModalLogic"]),(0,index_esm.actions)({openMetricSourceModal:context=>({context}),closeMetricSourceModal:!0}),(0,index_esm.reducers)({isModalOpen:[!1,{openMetricSourceModal:()=>!0,closeMetricSourceModal:()=>!1}],context:[METRIC_CONTEXTS.primary,{openMetricSourceModal:(_,_ref)=>{let{context}=_ref;return context},closeMetricSourceModal:()=>METRIC_CONTEXTS.primary}]})]);var sharedMetricsLogic=__webpack_require__("../../frontend/src/scenes/experiments/SharedMetrics/sharedMetricsLogic.tsx");let sharedMetricModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","experiments","Metrics","sharedMetricModalLogic"]),(0,index_esm.connect)(()=>({actions:[sharedMetricsLogic.G,["loadSharedMetrics"],eventUsageLogic.vx,["reportExperimentSharedMetricAssigned"]],values:[sharedMetricsLogic.G,["sharedMetrics","sharedMetricsLoading"]]})),(0,index_esm.actions)({openSharedMetricModal:(context,sharedMetricId)=>({context,sharedMetricId}),closeSharedMetricModal:!0,setSharedMetric:sharedMetric=>({sharedMetric})}),(0,index_esm.listeners)(_ref=>{let{actions}=_ref;return{openSharedMetricModal:()=>{actions.loadSharedMetrics()}}}),(0,index_esm.reducers)({isModalOpen:[!1,{openSharedMetricModal:()=>!0,closeSharedMetricModal:()=>!1}],sharedMetricId:[null,{openSharedMetricModal:(_,_ref2)=>{let{sharedMetricId}=_ref2;return null!=sharedMetricId?sharedMetricId:null},closeSharedMetricModal:()=>null}],context:[METRIC_CONTEXTS.primary,{openSharedMetricModal:(_,_ref3)=>{let{context}=_ref3;return context},closeSharedMetricModal:()=>METRIC_CONTEXTS.primary}],isEditMode:[!1,{openSharedMetricModal:(_,_ref4)=>{let{sharedMetricId}=_ref4;return!!sharedMetricId},closeSharedMetricModal:()=>!1}]}),(0,index_esm.selectors)({isCreateMode:[s=>[s.isEditMode],isEditMode=>!isEditMode],compatibleSharedMetrics:[s=>[s.sharedMetrics],sharedMetrics=>sharedMetrics.filter(metric=>metric.query.kind===schema_general.OH.ExperimentMetric)]})]),MetricSourceModal=()=>{let{isModalOpen,context}=(0,index_esm.useValues)(metricSourceModalLogic),{closeMetricSourceModal}=(0,index_esm.useActions)(metricSourceModalLogic),{openExperimentMetricModal}=(0,index_esm.useActions)(experimentMetricModalLogic),{openSharedMetricModal}=(0,index_esm.useActions)(sharedMetricModalLogic);return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isModalOpen,onClose:closeMetricSourceModal,width:1e3,title:"Choose metric source",children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex-1 cursor-pointer p-4 rounded border hover:border-accent",onClick:()=>{closeMetricSourceModal(),openExperimentMetricModal(context)},children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,jsx_runtime.jsx)("span",{children:"Single-use"})}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Create a new metric specific to this experiment."})]}),(0,jsx_runtime.jsxs)("div",{className:"flex-1 cursor-pointer p-4 rounded border hover:border-accent",onClick:()=>{closeMetricSourceModal(),openSharedMetricModal(context)},children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,jsx_runtime.jsx)("span",{children:"Shared"})}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Use a pre-configured metric that can be reused across experiments."})]})]})})};function SharedMetricModal(_ref){let{experiment,onSave,onDelete}=_ref,{hasAvailableFeature}=(0,index_esm.useValues)(userLogic.userLogic),{isModalOpen,context,compatibleSharedMetrics,sharedMetricId,isCreateMode,isEditMode}=(0,index_esm.useValues)(sharedMetricModalLogic),{closeSharedMetricModal}=(0,index_esm.useActions)(sharedMetricModalLogic),[selectedMetricIds,setSelectedMetricIds]=(0,react.useState)([]);if(!compatibleSharedMetrics)return null;let availableSharedMetrics=compatibleSharedMetrics.filter(metric=>!experiment.saved_metrics.some(savedMetric=>savedMetric.saved_metric===metric.id)),availableTags=Array.from(new Set(availableSharedMetrics.filter(metric=>metric.tags).flatMap(metric=>metric.tags).filter(Boolean))).sort();return(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isModalOpen,onClose:closeSharedMetricModal,maxWidth:800,title:isCreateMode?"Select one or more shared metrics":"Shared metric",footer:(0,jsx_runtime.jsxs)("div",{className:"flex justify-between w-full",children:[(0,jsx_runtime.jsx)("div",{children:isEditMode&&(0,jsx_runtime.jsx)(src.Jp,{status:"danger",onClick:()=>{let metric=compatibleSharedMetrics.find(m=>m.id===sharedMetricId);metric&&onDelete(metric,context)},type:"secondary",children:"Remove from experiment"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{onClick:closeSharedMetricModal,type:"secondary",children:"Cancel"}),isCreateMode&&(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{onSave(selectedMetricIds.map(metricId=>compatibleSharedMetrics.find(m=>m.id===metricId)).filter(metric=>void 0!==metric),context)},type:"primary",disabledReason:(()=>{if(0===selectedMetricIds.length)return"Please select at least one metric"})(),children:selectedMetricIds.length<2?"Add metric":"Add metrics"})]})]}),children:[isCreateMode&&(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-2",children:availableSharedMetrics.length>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[experiment.saved_metrics.length>0&&(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:`Hiding ${experiment.saved_metrics.length} shared ${experiment.saved_metrics.length>1?"metrics":"metric"} already in use with this experiment.`}),hasAvailableFeature(types.P$.TAGGING)&&availableTags.length>0&&(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,jsx_runtime.jsx)(src.HQ,{children:"Quick select:"}),availableTags.map((tag,index)=>(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"secondary",onClick:()=>{setSelectedMetricIds(availableSharedMetrics.filter(metric=>metric.tags?.includes(tag)).map(metric=>metric.id))},children:tag},index))]}),(0,jsx_runtime.jsx)(LemonTable.g,{dataSource:availableSharedMetrics,columns:[{title:"",key:"checkbox",render:(_,metric)=>(0,jsx_runtime.jsx)("input",{type:"checkbox",checked:selectedMetricIds.includes(metric.id),onChange:e=>{e.target.checked?setSelectedMetricIds([...selectedMetricIds,metric.id]):setSelectedMetricIds(selectedMetricIds.filter(id=>id!==metric.id))}})},{title:"Name",dataIndex:"name",key:"name"},{title:"Description",dataIndex:"description",key:"description"},...hasAvailableFeature(types.P$.TAGGING)?[{title:"Tags",dataIndex:"tags",key:"tags",render:(_,metric)=>(0,jsx_runtime.jsx)(ObjectTags.D,{tags:metric.tags||[],staticOnly:!0})}]:[],{title:"Type",key:"type",render:(_,metric)=>metric.query.kind===schema_general.OH.ExperimentMetric?metric.query.metric_type:metric.query.kind===schema_general.OH.ExperimentTrendsQuery?"Trend":"Funnel"}],footer:(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center m-2",children:(0,jsx_runtime.jsx)(src.Jp,{to:`${urls.j.experiments()}?tab=shared-metrics`,size:"xsmall",type:"tertiary",children:"See all shared metrics"})})})]}):(0,jsx_runtime.jsx)(src.Vp,{className:"w-full",type:"info",action:{children:"New shared metric",to:urls.j.experimentsSharedMetric("new")},children:compatibleSharedMetrics.length>0?"All of your shared metrics are already in this experiment.":"You don't have any shared metrics that match the experiment type. Shared metrics let you create reusable metrics that you can quickly add to any experiment."})}),isEditMode&&(0,jsx_runtime.jsx)("div",{children:(()=>{let metric=compatibleSharedMetrics.find(m=>m.id===sharedMetricId);return metric?(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold m-0 flex items-center",children:metric.name}),(0,jsx_runtime.jsx)(src.rU,{target:"_blank",className:"font-semibold flex items-center",to:urls.j.experimentsSharedMetric(metric.id),children:(0,jsx_runtime.jsx)(icons.pF,{fontSize:"18"})})]}),metric.description&&(0,jsx_runtime.jsx)("p",{className:"mt-2",children:metric.description}),"ExperimentTrendsQuery"===metric.query.kind&&(0,jsx_runtime.jsx)(components.EV,{query:metric.query.count_query}),"ExperimentFunnelsQuery"===metric.query.kind&&(0,jsx_runtime.jsx)(components.AG,{query:metric.query.funnels_query})]}):null})()})]})}var legacyExperimentCalculations=__webpack_require__("../../frontend/src/scenes/experiments/legacyExperimentCalculations.tsx");function AddPrimaryMetric(){let{openPrimaryMetricSourceModal}=(0,index_esm.useActions)(modalsLogic.l);return(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),type:"secondary",size:"xsmall",onClick:()=>{openPrimaryMetricSourceModal()},children:"Add primary metric"})}function AddSecondaryMetric(){let{openSecondaryMetricSourceModal}=(0,index_esm.useActions)(modalsLogic.l);return(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),type:"secondary",size:"xsmall",onClick:()=>{openSecondaryMetricSourceModal()},children:"Add secondary metric"})}var shared_utils=__webpack_require__("../../frontend/src/scenes/experiments/MetricsView/shared/utils.ts"),lib_utils=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/utils.js");let ResultErrorCode=function(ResultErrorCode){return ResultErrorCode.NO_CONTROL_VARIANT="no-control-variant",ResultErrorCode.NO_TEST_VARIANT="no-test-variant",ResultErrorCode.NO_EXPOSURES="no-exposures",ResultErrorCode}({});function ErrorChecklist(_ref){let{error,metric}=_ref,{experiment,variants,getInsightType}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);if(!error)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let{statusCode,hasDiagnostics}=error;function ChecklistItem(_ref2){let{errorCode,value}=_ref2,failureText={[ResultErrorCode.NO_CONTROL_VARIANT]:"Events with the control variant not received",[ResultErrorCode.NO_TEST_VARIANT]:"Events with at least one test variant not received",[ResultErrorCode.NO_EXPOSURES]:"Exposure events not received"},successText={[ResultErrorCode.NO_CONTROL_VARIANT]:"Events with the control variant received",[ResultErrorCode.NO_TEST_VARIANT]:"Events with at least one test variant received",[ResultErrorCode.NO_EXPOSURES]:"Exposure events have been received"},insightType=getInsightType(metric),hasMissingExposure=errorCode===ResultErrorCode.NO_EXPOSURES,requiredEvent=insightType===types.dw.TRENDS?hasMissingExposure?metric.exposure_query?.series[0]?.event||"$feature_flag_called":metric.count_query?.series[0]?.event:metric.funnels_query?.series[0]?.event,query={kind:schema_general.OH.DataTableNode,full:!0,source:{kind:schema_general.OH.EventsQuery,select:["*","event",`properties."$feature/${experiment.feature_flag?.key}"`,"timestamp"],orderBy:["timestamp DESC"],after:experiment.start_date,event:requiredEvent,properties:[{key:`$feature/${experiment.feature_flag?.key}`,value:hasMissingExposure?variants.map(variant=>variant.key):errorCode===ResultErrorCode.NO_CONTROL_VARIANT?["control"]:variants.slice(1).map(variant=>variant.key),operator:"exact",type:"event"},...hasMissingExposure?[{key:"$feature_flag",value:[experiment.feature_flag?.key],operator:"exact",type:"event"}]:[]],filterTestAccounts:metric.count_query?.filter_test_accounts},propertiesViaUrl:!0,showPersistentColumnConfigurator:!0};return(0,jsx_runtime.jsx)("div",{className:"flex items-center deprecated-space-x-2",children:!1===value?(0,jsx_runtime.jsxs)("span",{className:"flex items-center deprecated-space-x-2",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCheck,{className:"text-success",fontSize:16}),(0,jsx_runtime.jsx)("span",{className:"text-secondary",children:successText[errorCode]})]}):(0,jsx_runtime.jsxs)("span",{className:"flex items-center deprecated-space-x-2",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{className:"text-danger",fontSize:16}),(0,jsx_runtime.jsx)("span",{children:failureText[errorCode]}),(0,jsx_runtime.jsx)(src.u,{title:"Verify missing events in the Activity tab",children:(0,jsx_runtime.jsx)(src.rU,{target:"_blank",className:"font-semibold",to:(0,lib_utils.combineUrl)(urls.j.activity(types.ZO.ExploreEvents),{},{q:query}).url,children:(0,jsx_runtime.jsx)(icons.pF,{fontSize:"16",className:"-ml-1"})})})]})})}if(hasDiagnostics){let checklistItems=[];for(let[errorCode,value]of Object.entries(error.detail))Object.values(ResultErrorCode).includes(errorCode)&&checklistItems.push((0,jsx_runtime.jsx)(ChecklistItem,{errorCode:errorCode,value:value},errorCode));return(0,jsx_runtime.jsx)("div",{children:checklistItems})}return 504===statusCode?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("h2",{className:"text-xl font-semibold leading-tight",children:"Experiment results timed out"}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-center text-balance",children:"This may occur when the experiment has a large amount of data or is particularly complex. We are actively working on fixing this. In the meantime, please try refreshing the experiment to retrieve the results."})]}):(0,jsx_runtime.jsx)("div",{children:error.detail})}function ChartEmptyState(_ref){let{height,experimentStarted,error,metric}=_ref;return(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center w-full",style:{height:`${height}px`},children:experimentStarted?(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center text-secondary cursor-default text-[12px] font-normal",children:error?.hasDiagnostics?(0,jsx_runtime.jsx)(ErrorChecklist,{error:error,metric:metric}):(0,jsx_runtime.jsx)(src.u,{title:error?"string"==typeof error?error:error.message||error.detail||error.error||JSON.stringify(error):"An error occurred",children:(0,jsx_runtime.jsx)(src.oe,{size:"small",type:"danger",className:"mr-1 cursor-pointer",children:"Error"})})}):(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-center text-secondary cursor-default text-[12px] font-normal",children:[(0,jsx_runtime.jsx)(src.oe,{size:"small",className:"mr-2",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconClock,{fontSize:"1em"})}),(0,jsx_runtime.jsx)("span",{children:"Waiting for experiment to startâ¦"})]})})}var Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/index.ts");function ChartLoadingState(_ref){let{height}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-center gap-2 text-[14px] font-normal",style:{height:`${height}px`},children:[(0,jsx_runtime.jsx)(Spinner.$,{className:"text-lg"}),(0,jsx_runtime.jsx)("span",{children:"Loading resultsâ¦"})]})}var themeLogic=__webpack_require__("../../frontend/src/layout/navigation-3000/themeLogic.ts");function useChartColors(){let{isDarkModeOn}=(0,index_esm.useValues)(themeLogic.b);return{TICK_TEXT_COLOR:"var(--color-text-tertiary)",BOUNDARY_LINES:"var(--color-border-primary)",ZERO_LINE:"var(--border-bold)",BAR_NEGATIVE:isDarkModeOn?"#c32f45":"#f84257",BAR_POSITIVE:isDarkModeOn?"#12a461":"#36cd6f",BAR_DEFAULT:isDarkModeOn?"rgb(121 121 121)":"rgb(217 217 217)",BAR_CONTROL:isDarkModeOn?"rgba(217, 217, 217, 0.2)":"rgba(217, 217, 217, 0.4)",BAR_MIDDLE_POINT:"black",BAR_MIDDLE_POINT_CONTROL:"rgba(0, 0, 0, 0.4)",EXPOSURES_AXIS_LINES:isDarkModeOn?"rgba(217, 217, 217, 0.2)":"rgba(217, 217, 217, 0.4)"}}let COLORS={TICK_TEXT_COLOR:"var(--color-text-tertiary)",BOUNDARY_LINES:"var(--color-border-primary)",ZERO_LINE:"var(--border-bold)",BAR_NEGATIVE:"#f84257",BAR_POSITIVE:"#36cd6f",BAR_DEFAULT:"rgb(217 217 217)"};function GridLines(_ref){let{tickValues,valueToX,height}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:tickValues.map(value=>{let x=valueToX(value);return(0,jsx_runtime.jsx)("line",{x1:x,y1:0,x2:x,y2:height,stroke:0===value?COLORS.ZERO_LINE:COLORS.BOUNDARY_LINES,strokeWidth:0===value?1:.5},value)})})}var TaxonomicFilter=__webpack_require__("../../frontend/src/lib/components/TaxonomicFilter/TaxonomicFilter.tsx");let MetricTitle=_ref=>{let{metric,metricType}=_ref,shouldShowTooltip=text=>text.length>50,getTextClassName=text=>{let breakClass=text.includes(" ")?"break-words":"break-all";return`line-clamp-3 ${breakClass}`},wrapWithTooltip=(text,element)=>shouldShowTooltip(text)?(0,jsx_runtime.jsx)(src.u,{title:text,children:element}):element;if(metric.kind===schema_general.OH.ExperimentMetric){let title=metric.name||(0,shared_utils.vD)(metric),element=(0,jsx_runtime.jsx)("span",{className:getTextClassName(title),children:title});return wrapWithTooltip(title,element)}if(metricType===types.dw.TRENDS&&metric.count_query?.series?.[0]?.name){let name=metric.count_query.series[0].name,element=(0,jsx_runtime.jsx)("span",{className:getTextClassName(name),children:name});return wrapWithTooltip(name,element)}if(metricType===types.dw.FUNNELS&&metric.funnels_query?.series){let series=metric.funnels_query.series;if(series.length>0){let firstStep=series[0]?.name,lastStep=series[series.length-1]?.name;return(0,jsx_runtime.jsxs)("div",{className:"inline-flex flex-wrap items-center gap-1 min-w-0",children:[(0,jsx_runtime.jsxs)("div",{className:"inline-flex items-center gap-1 min-w-0",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconFunnels,{className:"text-secondary flex-shrink-0",fontSize:"14"}),wrapWithTooltip(firstStep,(0,jsx_runtime.jsx)("span",{className:getTextClassName(firstStep),children:firstStep}))]}),(0,jsx_runtime.jsxs)("div",{className:"inline-flex items-center gap-1 min-w-0 @max-[200px]:ml-5",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconArrowRight,{className:"text-secondary flex-shrink-0",fontSize:"14"}),wrapWithTooltip(lastStep,(0,jsx_runtime.jsx)("span",{className:getTextClassName(lastStep),children:lastStep}))]})]})}}return(0,jsx_runtime.jsx)("span",{className:`text-secondary ${getTextClassName("Untitled metric")}`,children:"Untitled metric"})},getExposureEvent=experiment=>{let exposureConfig=experiment.exposure_criteria?.exposure_config;return exposureConfig&&(0,experiments_utils.SR)(exposureConfig)?exposureConfig.event:"$feature_flag_called"},AddBreakdownButton=_ref=>{let{experiment,onChange}=_ref,[dropdownOpen,setDropdownOpen]=(0,react.useState)(!1);if(!experiment)return null;let exposureEvent=getExposureEvent(experiment),metadataSource={kind:schema_general.OH.EventsNode,event:exposureEvent};return(0,jsx_runtime.jsx)(src.Qw,{overlay:(0,jsx_runtime.jsx)(TaxonomicFilter.I,{onChange:(_,value)=>{onChange({type:"event",property:value}),setDropdownOpen(!1)},taxonomicGroupTypes:[TaxonomicFilter_types.t.EventProperties,TaxonomicFilter_types.t.PersonProperties],metadataSource:metadataSource}),visible:dropdownOpen,onClickOutside:()=>setDropdownOpen(!1),children:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlusSmall,{}),onClick:()=>setDropdownOpen(!dropdownOpen),children:"Add breakdown"})})},MetricHeader=_ref2=>{let{displayOrder,metric,metricType,isPrimaryMetric,experiment,onDuplicateMetricClick}=_ref2,showBreakdownFilter=(0,useFeatureFlag.y)("EXPERIMENTS_BREAKDOWN_FILTER"),{openPrimaryMetricModal,openSecondaryMetricModal,openPrimarySharedMetricModal,openSecondarySharedMetricModal}=(0,index_esm.useActions)(modalsLogic.l),{openExperimentMetricModal}=(0,index_esm.useActions)(experimentMetricModalLogic),{openSharedMetricModal}=(0,index_esm.useActions)(sharedMetricModalLogic);return(0,jsx_runtime.jsxs)("div",{className:"text-xs font-semibold flex flex-col justify-between h-full",children:[(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-1",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-start justify-between gap-2 min-w-0",children:[(0,jsx_runtime.jsxs)("div",{className:"text-xs font-semibold flex items-start min-w-0 flex-1",children:[void 0!==displayOrder&&(0,jsx_runtime.jsxs)("span",{className:"mr-1 flex-shrink-0",children:[displayOrder+1,"."]}),(0,jsx_runtime.jsx)("div",{className:"min-w-0 flex-1",children:(0,jsx_runtime.jsx)(MetricTitle,{metric:metric,metricType:metricType})})]}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col gap-1 flex-shrink-0 items-end",children:(0,jsx_runtime.jsxs)("div",{className:"flex gap-1",children:[(0,jsx_runtime.jsx)(src.Jp,{className:"flex-shrink-0",type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{fontSize:"12"}),tooltip:"Edit",onClick:()=>{metric.isSharedMetric?((isPrimaryMetric?openPrimarySharedMetricModal:openSecondarySharedMetricModal)(metric.sharedMetricId),openSharedMetricModal(METRIC_CONTEXTS[isPrimaryMetric?"primary":"secondary"],metric.sharedMetricId)):(metric.uuid&&(isPrimaryMetric?openPrimaryMetricModal:openSecondaryMetricModal)(metric.uuid),openExperimentMetricModal(METRIC_CONTEXTS[isPrimaryMetric?"primary":"secondary"],metric))}}),(0,jsx_runtime.jsx)(src.Jp,{className:"flex-shrink-0",type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconCopy,{fontSize:"12"}),tooltip:"Duplicate",onClick:()=>{if(metric.isSharedMetric){src.dn.open({title:"Duplicate this shared metric?",content:(0,jsx_runtime.jsx)("div",{className:"text-sm text-secondary max-w-lg",children:(0,jsx_runtime.jsx)("p",{children:"We'll take you to the form to customize and save this metric. Your new version will appear in your shared metrics, ready to add to your experiment."})}),primaryButton:{children:"Duplicate metric",to:urls.j.experimentsSharedMetric(metric.sharedMetricId,"duplicate"),type:"primary",size:"small"},secondaryButton:{children:"Cancel",type:"tertiary",size:"small"}});return}onDuplicateMetricClick(metric)}})]})})]}),(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-x-1",children:[(0,jsx_runtime.jsx)(src.oe,{type:"muted",size:"small",children:(0,shared_utils.Xj)(metric)}),metric.isSharedMetric&&(0,jsx_runtime.jsx)(src.oe,{type:"option",size:"small",children:"Shared"})]})]}),showBreakdownFilter&&(0,jsx_runtime.jsx)("div",{className:"flex justify-end items-end",children:(0,jsx_runtime.jsx)(AddBreakdownButton,{experiment:experiment,onChange:breakdown=>{if(breakdown)return}})})]})};function WinningVariantText(_ref){let{result,experimentId}=_ref,{getInsightType,experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),highestProbabilityVariant=(0,legacyExperimentCalculations.jl)(result),index=(0,legacyExperimentCalculations.SP)(result,highestProbabilityVariant||"",getInsightType(experiment.metrics[0]));if(highestProbabilityVariant&&null!==index&&result){let{probability}=result;return(0,jsx_runtime.jsxs)("div",{className:"items-center inline-flex flex-wrap",children:[(0,jsx_runtime.jsx)(components.Aw,{experimentId:experimentId,variantKey:highestProbabilityVariant}),(0,jsx_runtime.jsx)("span",{children:"Â is winning with aÂ "}),(0,jsx_runtime.jsxs)("span",{className:"font-semibold items-center",children:[`${(100*probability[highestProbabilityVariant]).toFixed(2)}% probability`,"Â "]}),(0,jsx_runtime.jsx)("span",{children:"of being best.Â "})]})}return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})}function SignificanceText(_ref2){let{metricUuid,isSecondary=!1}=_ref2,{isPrimaryMetricSignificant,isSecondaryMetricSignificant}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);return(0,jsx_runtime.jsxs)("div",{className:"flex-wrap",children:[(0,jsx_runtime.jsx)("span",{children:"Your results areÂ "}),(0,jsx_runtime.jsxs)("span",{className:"font-semibold",children:[`${(isSecondary?isSecondaryMetricSignificant(metricUuid):isPrimaryMetricSignificant(metricUuid))?"significant":"not significant"}`,"."]})]})}function Overview(_ref3){let{metricUuid}=_ref3,{experimentId,legacyPrimaryMetricsResults,experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),index=experiment.metrics.findIndex(m=>m.uuid===metricUuid),result=index>=0?legacyPrimaryMetricsResults?.[index]:null;return result?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)("div",{className:"items-center inline-flex flex-wrap",children:[(0,jsx_runtime.jsx)(WinningVariantText,{result:result,experimentId:experimentId}),(0,jsx_runtime.jsx)(SignificanceText,{metricUuid:metricUuid})]})}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})}var SummaryTable=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentView/SummaryTable.tsx");function ExploreAsInsightButton(_ref){let{query}=_ref;return(0,jsx_runtime.jsx)(LemonButton.J,{className:"ml-auto -translate-y-2",size:"xsmall",type:"primary",icon:(0,jsx_runtime.jsx)(icons.Ii,{}),to:urls.j.insightNew({query}),targetBlank:!0,children:"Explore as Insight"})}var kea_loaders_lib=__webpack_require__("../../node_modules/.pnpm/kea-loaders@3.1.1_kea@3.1.7_react@18.2.0_/node_modules/kea-loaders/lib/index.js"),dist=__webpack_require__("../../node_modules/.pnpm/ts-pattern@4.3.0/node_modules/ts-pattern/dist/index.js"),queries_query=__webpack_require__("../../frontend/src/queries/query.ts"),metricQueryUtils=__webpack_require__("../../frontend/src/scenes/experiments/metricQueryUtils.ts");let filterFunnelSteps=(steps,variants)=>steps.filter(step=>(0,dist.EQ)(step.breakdown_value).with(void 0,()=>!1).with(dist.P.array(dist.P.string),values=>values.some(value=>variants.includes(value))).otherwise(()=>variants.includes(step.breakdown_value))),resultsBreakdownLogic=(0,index_esm.kea)([(0,index_esm.props)({experiment:{},metric:{}}),(0,index_esm.key)(props=>`${props.experiment.id}-${props.metricUuid}-${props.isPrimary?"primary":"secondary"}`),(0,index_esm.path)(key=>["scenes","experiment","experimentResultBreakdownLogic",key]),(0,index_esm.connect)(props=>({actions:[(0,experiments_experimentLogic.Wl)({experimentId:props.experiment.id}),["refreshExperimentResults"]]})),(0,index_esm.actions)({loadBreakdownResults:refresh=>({refresh}),setBreakdownLastRefresh:lastRefresh=>({lastRefresh})}),(0,index_esm.selectors)({query:[()=>[(_,props)=>props],_ref=>{let{experiment,metric}=_ref;if(!metric)return null;let exposureEventNode=(0,metricQueryUtils.YL)(experiment.exposure_criteria?.exposure_config,{featureFlagKey:experiment.feature_flag_key,featureFlagVariants:experiment.parameters.feature_flag_variants});return(0,metricQueryUtils.qC)((0,metricQueryUtils.jV)(exposureEventNode),(0,metricQueryUtils.pm)({filterTestAccounts:!!experiment.exposure_criteria?.filterTestAccounts,dateRange:(0,metricQueryUtils.zZ)(experiment),breakdownFilter:{breakdown:"$feature_flag_called"===exposureEventNode.event?"$feature_flag_response":`$feature/${experiment.feature_flag_key}`,breakdown_type:"event"},funnelsFilter:{layout:constants.xp.vertical,breakdownAttributionType:types.q9.Step,breakdownAttributionValue:0,funnelOrderType:(0,schema_general.N4)(metric)&&metric.funnel_order_type||types.kO.ORDERED,funnelStepReference:types.XF.total,funnelVizType:types.Ui.Steps,funnelWindowInterval:14,funnelWindowIntervalUnit:types.ih.Day}}),(0,metricQueryUtils.cc)({showTable:!0,showLastComputation:!0,showLastComputationRefresh:!1}))(metric)||null}]}),(0,index_esm.reducers)({breakdownLastRefresh:[null,{setBreakdownLastRefresh:(_,_ref2)=>{let{lastRefresh}=_ref2;return lastRefresh},loadBreakdownResults:()=>null}]}),(0,kea_loaders_lib.loaders)(_ref3=>{let{props,values,actions}=_ref3;return{breakdownResults:[null,{loadBreakdownResults:async _ref4=>{let{refresh}=_ref4;try{let{experiment}=props,query=values.query;if(!query)throw Error("No query returned from queryBuilder");if(query.source.kind===schema_general.OH.TrendsQuery)return[];let response=await (0,queries_query.jr)(query,void 0,refresh?"force_async":"async");if(!response?.results)throw Error("No results returned from query");response.last_refresh&&actions.setBreakdownLastRefresh(response.last_refresh);let results=response.results,variants=experiment.parameters.feature_flag_variants.map(_ref5=>{let{key}=_ref5;return key});return results=(0,dist.EQ)(results).with(dist.P.array(dist.P.array({breakdown_value:dist.P.any})),nestedSteps=>nestedSteps.map(stepGroup=>filterFunnelSteps(stepGroup,variants)).filter(steps=>steps.length>0)).with(dist.P.array({breakdown_value:dist.P.any}),flatSteps=>filterFunnelSteps(flatSteps,variants)).otherwise(()=>[])}catch(error){throw Error(error instanceof Error?`Failed to load experiment results: ${error.message}`:"Failed to load experiment results")}}}]}}),(0,index_esm.listeners)(_ref6=>{let{actions,props}=_ref6;return{refreshExperimentResults:()=>{let{metric,experiment}=props;experiment&&metric&&metric.kind===schema_general.OH.ExperimentMetric&&metric.metric_type===schema_general.Tu.FUNNEL&&actions.loadBreakdownResults(!0)}}}),(0,index_esm.afterMount)(_ref7=>{let{actions,props}=_ref7,{metric,experiment}=props;experiment&&metric&&metric.kind===schema_general.OH.ExperimentMetric&&metric.metric_type===schema_general.Tu.FUNNEL&&actions.loadBreakdownResults()})]),isExperimentVariantFunnels=variant=>"success_count"in variant&&"failure_count"in variant,calculateLegacyExposureCount=result=>result.variants?result.variants.reduce((acc,variant)=>isExperimentVariantFunnels(variant)?acc+variant.success_count+variant.failure_count:acc+variant.count,0):-1,calculateExposureCount=result=>[result.baseline,...result.variant_results||[]].reduce((acc,_ref)=>{let{number_of_samples}=_ref;return acc+number_of_samples},0),calculateExposureDifference=(result,breakdownResults)=>{let breakdownResultsTotalExposureCount=breakdownResults?breakdownResults.reduce((acc,result)=>acc+result[0].count,0):0;return(0,experiments_experimentLogic.Oi)(result)?calculateExposureCount(result)-breakdownResultsTotalExposureCount:calculateLegacyExposureCount(result)-breakdownResultsTotalExposureCount},ResultsBreakdownContent=_ref2=>{let{result,children}=_ref2,{query,breakdownResults,breakdownResultsLoading,breakdownLastRefresh}=(0,index_esm.useValues)(resultsBreakdownLogic),exposureDifference=calculateExposureDifference(result,breakdownResults);return children&&"function"==typeof children?children({query,breakdownResults,breakdownResultsLoading,exposureDifference,breakdownLastRefresh}):null},ResultsBreakdown=_ref=>{let{result,experiment,metricUuid,isPrimary,children}=_ref;return(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:resultsBreakdownLogic,props:{experiment,metric:result.metric,metricUuid,isPrimary},children:(0,jsx_runtime.jsx)(ResultsBreakdownContent,{result:result,children:children})})};var Spinner_Spinner=__webpack_require__("../../frontend/src/lib/lemon-ui/Spinner/Spinner.tsx");let ResultsBreakdownSkeleton=()=>(0,jsx_runtime.jsx)("div",{className:"space-y-4",children:(0,jsx_runtime.jsx)("div",{className:"border rounded-lg p-4 bg-bg-light space-y-3",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-center gap-2 font-normal",children:[(0,jsx_runtime.jsx)(Spinner_Spinner.$,{className:"text-lg"}),(0,jsx_runtime.jsx)("span",{children:"Loading breakdown"})]})})}),ResultsInsightInfoBanner=_ref=>{let{exposureDifference}=_ref;return 0===exposureDifference?null:(0,jsx_runtime.jsx)(src.Vp,{type:"info",className:"mb-4",children:(0,jsx_runtime.jsx)("div",{className:"items-center inline-flex flex-wrap",children:(0,jsx_runtime.jsxs)("span",{children:["Insight results may be slightly different from exposure results due to a difference in data processing methods. We're actively working on fixing this.Â ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/experiments/common-questions",className:"font-semibold text-primary hover:text-primary-dark",children:"Learn more in our docs"}),"."]})})})},ResultsQuery=_ref=>{let{query,breakdownResults,breakdownLastRefresh}=_ref;if(query.source.kind===schema_general.OH.TrendsQuery)return null;let fakeInsightId=Math.random().toString(36).substring(2,15);return(0,jsx_runtime.jsx)(Query.A,{query:query,context:{insightProps:{dashboardItemId:fakeInsightId,cachedInsight:{short_id:fakeInsightId,query,result:breakdownResults,last_refresh:breakdownLastRefresh,disable_baseline:!0},doNotLoad:!0}},readOnly:!0})};function ChartModal(_ref){let{isOpen,onClose,metric,displayOrder,isSecondary,result,experimentId,experiment}=_ref,isLegacyResult=result&&(result.kind===schema_general.OH.ExperimentTrendsQuery||result.kind===schema_general.OH.ExperimentFunnelsQuery);return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:onClose,width:1200,title:`Metric results: ${metric.name||"Untitled metric"}`,footer:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:onClose,children:"Close"}),children:isLegacyResult?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(components.bD,{result:result})}),(0,jsx_runtime.jsx)(src.Vp,{type:result?.significant?"success":"info",className:"mb-4",children:(0,jsx_runtime.jsxs)("div",{className:"items-center inline-flex flex-wrap",children:[(0,jsx_runtime.jsx)(WinningVariantText,{result:result,experimentId:experimentId}),(0,jsx_runtime.jsx)(SignificanceText,{metricUuid:metric.uuid||"",isSecondary:isSecondary})]})}),(0,jsx_runtime.jsx)(SummaryTable.H,{metric:metric,displayOrder:displayOrder,isSecondary:isSecondary}),(0,jsx_runtime.jsx)(components.TX,{result:result,showTable:!0})]}):(0,jsx_runtime.jsx)(ResultsBreakdown,{result:result,experiment:experiment,metricUuid:metric.uuid||"",isPrimary:!isSecondary,children:_ref2=>{let{query,breakdownResults,breakdownResultsLoading,exposureDifference,breakdownLastRefresh}=_ref2;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[query&&(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(ExploreAsInsightButton,{query:query})}),(0,jsx_runtime.jsx)(src.Vp,{type:result?.significant?"success":"info",className:"mb-4",children:(0,jsx_runtime.jsxs)("div",{className:"items-center inline-flex flex-wrap",children:[(0,jsx_runtime.jsx)(WinningVariantText,{result:result,experimentId:experimentId}),(0,jsx_runtime.jsx)(SignificanceText,{metricUuid:metric.uuid||"",isSecondary:isSecondary})]})}),(0,jsx_runtime.jsx)(SummaryTable.H,{metric:metric,displayOrder:displayOrder,isSecondary:isSecondary}),breakdownResultsLoading&&(0,jsx_runtime.jsx)(ResultsBreakdownSkeleton,{}),query&&breakdownResults&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ResultsInsightInfoBanner,{exposureDifference:exposureDifference}),(0,jsx_runtime.jsx)(ResultsQuery,{query:query,breakdownResults:breakdownResults,breakdownLastRefresh:breakdownLastRefresh})]})]})}})})}function useSvgResizeObserver(){let deps=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],ticksSvgRef=(0,react.useRef)(null),chartSvgRef=(0,react.useRef)(null),[ticksSvgHeight,setTicksSvgHeight]=(0,react.useState)(0),[chartSvgHeight,setChartSvgHeight]=(0,react.useState)(0);return(0,react.useEffect)(()=>{let ticksSvg=ticksSvgRef.current,chartSvg=chartSvgRef.current,resizeObserver=new ResizeObserver(entries=>{for(let entry of entries)entry.target===ticksSvg?setTicksSvgHeight(entry.contentRect.height):entry.target===chartSvg&&setChartSvgHeight(entry.contentRect.height)});return ticksSvg&&resizeObserver.observe(ticksSvg),chartSvg&&resizeObserver.observe(chartSvg),()=>{resizeObserver.disconnect()}},deps),{ticksSvgRef,chartSvgRef,ticksSvgHeight,chartSvgHeight}}function TickPanel(_ref){let{tickValues,valueToX,viewBoxWidth,tickPanelHeight,svgRef}=_ref;return(0,jsx_runtime.jsx)("svg",{ref:svgRef,viewBox:`0 0 ${viewBoxWidth} ${tickPanelHeight}`,preserveAspectRatio:"xMidYMid meet",className:"ml-12 max-w-[1000px]",style:{minHeight:`${tickPanelHeight}px`},children:tickValues.map(value=>{let x=valueToX(value);return(0,jsx_runtime.jsx)("g",{children:(0,jsx_runtime.jsx)("text",{x:x,y:tickPanelHeight/2,textAnchor:"middle",dominantBaseline:"middle",fontSize:9,fill:COLORS.TICK_TEXT_COLOR,fontWeight:"600",children:(0,shared_utils.wo)(value)})},value)})})}function MetricsChartLayout(_ref){let{isFirstMetric,tickValues,chartBound,metricTitlePanel,chartContent,viewBoxWidth=800,horizontalPadding=20,tickPanelHeight=20}=_ref,{ticksSvgRef,chartSvgRef,ticksSvgHeight,chartSvgHeight}=useSvgResizeObserver([tickValues,chartBound]),metricTitlePanelHeight=Math.max(chartSvgHeight,80);return(0,jsx_runtime.jsx)("div",{className:"rounded bg-[var(--color-bg-table)]",children:(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsxs)("div",{className:"w-1/5 border-r border-primary",children:[isFirstMetric&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{style:{height:`${ticksSvgHeight}px`}}),(0,jsx_runtime.jsx)("div",{className:"w-full border-t border-primary"})]}),(0,jsx_runtime.jsx)("div",{className:"p-2",style:{height:`${metricTitlePanelHeight}px`},children:metricTitlePanel})]}),(0,jsx_runtime.jsxs)("div",{className:"w-4/5 min-w-[780px]",children:[isFirstMetric&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:(0,jsx_runtime.jsx)(TickPanel,{svgRef:ticksSvgRef,tickValues:tickValues,valueToX:value=>(0,shared_utils.wq)(value,chartBound,viewBoxWidth,horizontalPadding),viewBoxWidth:viewBoxWidth,tickPanelHeight:tickPanelHeight})}),(0,jsx_runtime.jsx)("div",{className:"w-full border-t border-primary"})]}),(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:"function"==typeof chartContent?chartContent(chartSvgRef):chartContent})]})]})})}function SignificanceHighlight(_ref){let{displayOrder=0,metricUuid,isSecondary=!1,className=""}=_ref,{isPrimaryMetricSignificant,isSecondaryMetricSignificant,significanceDetails,experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),identifier=metricUuid;if(!identifier){let metrics=isSecondary?experiment.metrics_secondary:experiment.metrics;identifier=metrics[displayOrder]?.uuid||""}if(!identifier)return(0,jsx_runtime.jsx)("div",{className:className});let isSignificant=isSecondary?isSecondaryMetricSignificant(identifier):isPrimaryMetricSignificant(identifier),result=isSignificant?{color:"success",label:"Significant"}:{color:"primary",label:"Not significant"},inner=isSignificant?(0,jsx_runtime.jsxs)("div",{className:"bg-success-highlight text-success-light px-1.5 py-0.5 flex items-center gap-1 rounded border border-success-light",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconTrending,{fontSize:20,fontWeight:600}),(0,jsx_runtime.jsx)("span",{className:"text-xs font-semibold",children:result.label})]}):(0,jsx_runtime.jsxs)("div",{className:"bg-warning-highlight text-warning-dark px-1.5 py-0.5 flex items-center gap-1 rounded border border-warning",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconMinus,{fontSize:20,fontWeight:600}),(0,jsx_runtime.jsx)("span",{className:"text-xs font-semibold",children:result.label})]}),details=significanceDetails(identifier);return details?(0,jsx_runtime.jsx)(src.u,{title:details,children:(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)({"cursor-default":!0,"bg-[var(--color-bg-table)]":!0,[className]:!0}),children:inner})}):(0,jsx_runtime.jsx)("div",{className:(0,clsx_m.default)({"bg-[var(--color-bg-table)]":!0,[className]:!0}),children:inner})}var LemonProgress=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonProgress/index.tsx");function VariantTooltip(_ref){let{tooltipData,experimentId,result,metricType,conversionRateForVariant,countDataForVariant,exposureCountDataForVariant,credibleIntervalForVariant}=_ref;return(0,jsx_runtime.jsx)("div",{className:"fixed -translate-x-1/2 -translate-y-full bg-[var(--color-bg-surface-primary)] border border-[var(--color-border-primary)] px-3 py-2 rounded-md text-[13px] shadow-md pointer-events-none z-[103] min-w-[300px]",style:{left:tooltipData.x,top:tooltipData.y},children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)(components.Aw,{experimentId:experimentId,variantKey:tooltipData.variant}),(0,jsx_runtime.jsxs)("div",{className:"inline-flex",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold mb-1",children:"Win probability:"}),result?.probability?.[tooltipData.variant]!==void 0?(0,jsx_runtime.jsxs)("span",{className:"flex items-center justify-between flex-1 pl-6",children:[(0,jsx_runtime.jsx)(LemonProgress.b,{className:"w-3/4 mr-4",percent:100*result.probability[tooltipData.variant]}),(0,jsx_runtime.jsxs)("span",{className:"font-semibold",children:[(100*result.probability[tooltipData.variant]).toFixed(2),"%"]})]}):(0,jsx_runtime.jsx)("span",{children:"â"})]}),metricType===types.dw.TRENDS?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsxs)("span",{className:"text-secondary font-semibold",children:[metricType===types.dw.TRENDS&&result.exposure_query?.series?.[0]?.math?(0,jsx_runtime.jsx)("span",{children:"Total"}):(0,jsx_runtime.jsx)("span",{children:"Count"}),(0,jsx_runtime.jsx)("span",{children:":"})]}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(()=>{let count=countDataForVariant(result,tooltipData.variant);return null!==count?(0,utils.Lc)(count):(0,jsx_runtime.jsx)("span",{children:"â"})})()})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Exposure:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(()=>{let exposure=exposureCountDataForVariant(result,tooltipData.variant);return null!==exposure?(0,utils.Lc)(exposure):"â"})()})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Mean:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(()=>{let variant=result.variants.find(v=>v.key===tooltipData.variant);return variant?.count&&variant?.absolute_exposure?(variant.count/variant.absolute_exposure).toFixed(2):"â"})()})]})]}):(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Conversion rate:"}),(0,jsx_runtime.jsxs)("span",{className:"font-semibold",children:[conversionRateForVariant(result,tooltipData.variant)?.toFixed(2),"%"]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Delta:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"control"===tooltipData.variant?(0,jsx_runtime.jsx)("em",{className:"text-secondary",children:"Baseline"}):(()=>{let deltaResult=(0,legacyExperimentCalculations.YD)(result,tooltipData.variant,metricType);return deltaResult?(0,jsx_runtime.jsx)("span",{className:deltaResult.isPositive?"text-success":"text-danger",children:`${deltaResult.isPositive?"+":""}${deltaResult.deltaPercent.toFixed(2)}%`}):"â"})()})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-secondary font-semibold",children:"Credible interval:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(()=>{let interval=credibleIntervalForVariant(result,tooltipData.variant,metricType),[lower,upper]=interval?[interval[0]/100,interval[1]/100]:[0,0];return`[${lower>0?"+":""}${(100*lower).toFixed(2)}%, ${upper>0?"+":""}${(100*upper).toFixed(2)}%]`})()})]})]})})}function generateViolinPath(x1,x2,y,height,deltaX){let points=[],maxWidth=height/2;for(let i=0;i<=20;i++){let t=i/20,x=x1+(deltaX-x1)*t,z=(t-1)*2,width=Math.exp(-.5*z*z)*maxWidth;points.push([x,y+height/2-width])}for(let i=0;i<=20;i++){let t=i/20,x=deltaX+(x2-deltaX)*t,z=2*t,width=Math.exp(-.5*z*z)*maxWidth;points.push([x,y+height/2-width])}for(let i=20;i>=0;i--){let t=i/20,x=deltaX+(x2-deltaX)*t,z=2*t,width=Math.exp(-.5*z*z)*maxWidth;points.push([x,y+height/2+width])}for(let i=20;i>=0;i--){let t=i/20,x=x1+(deltaX-x1)*t,z=(t-1)*2,width=Math.exp(-.5*z*z)*maxWidth;points.push([x,y+height/2+width])}return`
        M ${points[0][0]} ${points[0][1]}
        ${points.map(point=>`L ${point[0]} ${point[1]}`).join(" ")}
        Z
    `}let DeltaChartContext=(0,react.createContext)(null);function useDeltaChartContext(){let context=(0,react.useContext)(DeltaChartContext);if(!context)throw Error("useDeltaChartContext must be used within a DeltaChartContextProvider");return context}function useChartDimensions(variants){var variantCount;let scaleAddition=(variantCount=variants.length)<3?6:variantCount<4?3:+(variantCount<5),barHeight=10+scaleAddition,barPadding=10+scaleAddition,chartHeight=barPadding+(barHeight+barPadding)*variants.length;return{barHeight,barPadding,viewBoxWidth:800,horizontalPadding:20,chartHeight}}function hasEnoughDataForResults(variantExposureCount,variantMetricValue){return variantExposureCount>=experiments_constants.Kn&&variantMetricValue>experiments_constants.GI}function VariantBar(_ref){let hasEnoughData,{variant,index}=_ref,{result,metricType,metric,dimensions,valueToX,experimentId,featureFlags,colors,tooltip:{setTooltipData},credibleIntervalForVariant,isSecondary,openVariantDeltaTimeseriesModal}=useDeltaChartContext(),metricId=metric?.uuid?metric.uuid.slice(-8):index,{barHeight,barPadding}=dimensions,interval=credibleIntervalForVariant(result,variant.key,metricType),[lower,upper]=interval?[interval[0]/100,interval[1]/100]:[0,0],deltaResult=(0,legacyExperimentCalculations.YD)(result,variant.key,metricType),delta=deltaResult?.delta||0;if(metricType===types.dw.TRENDS){let controlVariant=result.variants.find(v=>"control"===v.key),variantData=result.variants.find(v=>v.key===variant.key);hasEnoughData=!!(variantData?.count&&variantData?.absolute_exposure&&controlVariant?.count&&controlVariant?.absolute_exposure)&&hasEnoughDataForResults(variantData.absolute_exposure,variantData.count)}else{let variantData=result.variants.find(v=>v.key===variant.key);hasEnoughData=!!variantData&&hasEnoughDataForResults(variantData.failure_count+variantData.success_count,variantData.success_count)}let y=barPadding+(barHeight+barPadding)*index,x1=valueToX(lower),x2=valueToX(upper),deltaX=valueToX(delta);return(0,jsx_runtime.jsx)("g",{onMouseEnter:e=>{let rect=e.currentTarget.getBoundingClientRect();setTooltipData({x:rect.left+rect.width/2,y:rect.top-10,variant:variant.key})},onMouseLeave:()=>setTooltipData(null),onClick:()=>{featureFlags[constants.y8.EXPERIMENT_INTERVAL_TIMESERIES]&&openVariantDeltaTimeseriesModal()},className:featureFlags[constants.y8.EXPERIMENT_INTERVAL_TIMESERIES]?"cursor-pointer":"",children:hasEnoughData?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("foreignObject",{x:x1-8,y:y+barHeight/2-10,width:"90",height:"16",transform:"translate(-90, 0)",children:(0,jsx_runtime.jsx)(components.Aw,{className:"justify-end mt-0.5",experimentId:experimentId,variantKey:variant.key,fontSize:10})}),"control"===variant.key?(0,jsx_runtime.jsx)("path",{d:generateViolinPath(x1,x2,y,barHeight,deltaX),fill:colors.BAR_CONTROL,stroke:colors.BOUNDARY_LINES,strokeWidth:1,strokeDasharray:"2,2"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("defs",{children:(0,jsx_runtime.jsx)("linearGradient",{id:`gradient-${metricId}-${variant.key}-${isSecondary?"secondary":"primary"}`,x1:"0",x2:"1",y1:"0",y2:"0",children:lower<0&&upper>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("stop",{offset:"0%",stopColor:colors.BAR_NEGATIVE}),(0,jsx_runtime.jsx)("stop",{offset:`${-lower/(upper-lower)*100}%`,stopColor:colors.BAR_NEGATIVE}),(0,jsx_runtime.jsx)("stop",{offset:`${-lower/(upper-lower)*100}%`,stopColor:colors.BAR_POSITIVE}),(0,jsx_runtime.jsx)("stop",{offset:"100%",stopColor:colors.BAR_POSITIVE})]}):(0,jsx_runtime.jsx)("stop",{offset:"100%",stopColor:upper<=0?colors.BAR_NEGATIVE:colors.BAR_POSITIVE})})}),(0,jsx_runtime.jsx)("path",{d:generateViolinPath(x1,x2,y,barHeight,deltaX),fill:`url(#gradient-${metricId}-${variant.key}-${isSecondary?"secondary":"primary"})`})]}),(0,jsx_runtime.jsx)("g",{transform:`translate(${deltaX}, 0)`,children:(0,jsx_runtime.jsx)("line",{x1:0,y1:y,x2:0,y2:y+barHeight,stroke:"control"===variant.key?colors.BAR_MIDDLE_POINT_CONTROL:colors.BAR_MIDDLE_POINT,strokeWidth:2,vectorEffect:"non-scaling-stroke",shapeRendering:"crispEdges"})})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("foreignObject",{x:valueToX(0)-150,y:y+barHeight/2-10,width:"90",height:"16",children:(0,jsx_runtime.jsx)(components.Aw,{className:"justify-end mt-0.5",experimentId:experimentId,variantKey:variant.key,fontSize:10})}),(0,jsx_runtime.jsx)("rect",{x:valueToX(0)-50,y:y+barHeight/2-8,width:"100",height:"16",rx:"3",ry:"3",fill:"var(--color-bg-light)"}),(0,jsx_runtime.jsx)("rect",{x:valueToX(0)-50,y:y+barHeight/2-8,width:"100",height:"16",rx:"3",ry:"3",fill:"var(--border-light)",strokeWidth:"0"}),(0,jsx_runtime.jsx)("text",{x:valueToX(0),y:y+barHeight/2,fontSize:"10",textAnchor:"middle",dominantBaseline:"middle",fill:"var(--muted)",children:"Not enough data yet"})]})},variant.key)}function ChartSVG(_ref2){let{chartSvgRef}=_ref2,{dimensions,tickValues,valueToX,variants}=useDeltaChartContext(),{viewBoxWidth,chartHeight}=dimensions;return(0,jsx_runtime.jsx)("div",{className:"flex justify-center",children:(0,jsx_runtime.jsxs)("svg",{ref:chartSvgRef,viewBox:`0 0 ${viewBoxWidth} ${chartHeight}`,preserveAspectRatio:"xMidYMid meet",className:"ml-12 max-w-[1000px]",style:{minHeight:`${chartHeight}px`},children:[(0,jsx_runtime.jsx)("g",{className:"grid-lines-layer",children:(0,jsx_runtime.jsx)(GridLines,{tickValues:tickValues,valueToX:valueToX,height:chartHeight})}),(0,jsx_runtime.jsx)("g",{className:"variant-bars-layer",children:variants.map((variant,index)=>(0,jsx_runtime.jsx)(VariantBar,{variant:variant,index:index},variant.key))})]})})}function ChartControls(){let{displayOrder,isSecondary,primaryMetricsLengthWithSharedMetrics,setIsModalOpen,metric}=useDeltaChartContext();return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"absolute top-2 left-2 z-[102]",children:(0,jsx_runtime.jsx)(SignificanceHighlight,{displayOrder:displayOrder,isSecondary:isSecondary,metricUuid:metric?.uuid})}),(isSecondary||!isSecondary&&primaryMetricsLengthWithSharedMetrics>1)&&(0,jsx_runtime.jsx)("div",{className:"absolute bottom-2 left-2 flex justify-center bg-[var(--color-bg-table)] z-[101]",children:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGraph,{}),onClick:()=>setIsModalOpen(!0),children:"Details"})})]})}function ChartTooltips(){let{tooltip:{tooltipData},experimentId,result,metricType,conversionRateForVariant,countDataForVariant,exposureCountDataForVariant,credibleIntervalForVariant}=useDeltaChartContext();return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:tooltipData&&(0,jsx_runtime.jsx)(VariantTooltip,{tooltipData:tooltipData,experimentId:experimentId,result:result,metricType:metricType,conversionRateForVariant:conversionRateForVariant,countDataForVariant:countDataForVariant,exposureCountDataForVariant:exposureCountDataForVariant,credibleIntervalForVariant:credibleIntervalForVariant})})}function DeltaChartContent(_ref3){let{chartSvgRef}=_ref3,{result,metric,hasMinimumExposureForResults,resultsLoading,experiment,error,dimensions}=useDeltaChartContext(),{chartHeight}=dimensions;return result&&hasMinimumExposureForResults?(0,jsx_runtime.jsxs)("div",{className:"relative w-full max-w-screen",children:[(0,jsx_runtime.jsx)(ChartControls,{}),(0,jsx_runtime.jsx)(ChartSVG,{chartSvgRef:chartSvgRef}),(0,jsx_runtime.jsx)(ChartTooltips,{})]}):resultsLoading?(0,jsx_runtime.jsx)(ChartLoadingState,{height:chartHeight}):(0,jsx_runtime.jsx)("div",{className:"relative w-full max-w-screen",children:(0,jsx_runtime.jsx)(ChartEmptyState,{height:chartHeight,experimentStarted:!!experiment.start_date,metric:metric,error:error})})}function DeltaChart(_ref4){let{isSecondary,result,error,variants,metricType,displayOrder,isFirstMetric,metric,tickValues,chartBound}=_ref4,{experimentId,experiment,primaryMetricsResultsLoading,secondaryMetricsResultsLoading,featureFlags,primaryMetricsLengthWithSharedMetrics,hasMinimumExposureForResults}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{duplicateMetric,updateExperimentMetrics}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{openVariantDeltaTimeseriesModal}=(0,index_esm.useActions)(modalsLogic.l),resultsLoading=isSecondary?secondaryMetricsResultsLoading:primaryMetricsResultsLoading,dimensions=useChartDimensions(variants),{viewBoxWidth:VIEW_BOX_WIDTH,horizontalPadding:HORIZONTAL_PADDING}=dimensions,colors=useChartColors(),[isModalOpen,setIsModalOpen]=(0,react.useState)(!1),[tooltipData,setTooltipData]=(0,react.useState)(null),[emptyStateTooltipVisible,setEmptyStateTooltipVisible]=(0,react.useState)(!1),[tooltipPosition,setTooltipPosition]=(0,react.useState)({x:0,y:0}),metricTitlePanel=(0,jsx_runtime.jsx)(MetricHeader,{displayOrder:displayOrder,experiment:experiment,metric:metric,metricType:metricType,isPrimaryMetric:!isSecondary,onDuplicateMetricClick:()=>{if(!metric.uuid)return;let newUuid=crypto.randomUUID();duplicateMetric({uuid:metric.uuid,isSecondary,newUuid}),updateExperimentMetrics()}}),contextValue={result,error,displayOrder,isSecondary,metricType,metric,tickValues,chartBound,experimentId:experimentId,experiment,variants,hasMinimumExposureForResults,featureFlags,primaryMetricsLengthWithSharedMetrics,valueToX:value=>HORIZONTAL_PADDING+(value/chartBound+1)/2*(VIEW_BOX_WIDTH-2*HORIZONTAL_PADDING),credibleIntervalForVariant:legacyExperimentCalculations.fv,conversionRateForVariant:legacyExperimentCalculations.Wd,countDataForVariant:legacyExperimentCalculations.PZ,exposureCountDataForVariant:legacyExperimentCalculations.MB,dimensions,isModalOpen,setIsModalOpen,resultsLoading,openVariantDeltaTimeseriesModal,colors,tooltip:{tooltipData,setTooltipData,emptyStateTooltipVisible,setEmptyStateTooltipVisible,tooltipPosition,setTooltipPosition}};return(0,jsx_runtime.jsxs)(DeltaChartContext.Provider,{value:contextValue,children:[(0,jsx_runtime.jsx)(MetricsChartLayout,{isFirstMetric:isFirstMetric,tickValues:tickValues,chartBound:chartBound,metricTitlePanel:metricTitlePanel,chartContent:chartSvgRef=>(0,jsx_runtime.jsx)(DeltaChartContent,{chartSvgRef:chartSvgRef}),viewBoxWidth:VIEW_BOX_WIDTH,horizontalPadding:HORIZONTAL_PADDING}),(0,jsx_runtime.jsx)(ChartModal,{isOpen:isModalOpen,onClose:()=>setIsModalOpen(!1),metric:metric,displayOrder:displayOrder,isSecondary:isSecondary,result:result,experimentId:experimentId,experiment:experiment})]})}function MetricsViewLegacy(_ref){let{isSecondary}=_ref,{experiment,getInsightType,legacyPrimaryMetricsResults,legacySecondaryMetricsResults,primaryMetricsResultsErrors,secondaryMetricsResultsErrors}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),variants=experiment?.feature_flag?.filters?.multivariate?.variants;if(!variants)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let results=isSecondary?legacySecondaryMetricsResults:legacyPrimaryMetricsResults,errors=isSecondary?secondaryMetricsResultsErrors:primaryMetricsResultsErrors,hasSomeResults=results?.some(result=>result?.insight),metrics=isSecondary?experiment.metrics_secondary:experiment.metrics,sharedMetrics=experiment.saved_metrics.filter(sharedMetric=>sharedMetric.metadata.type===(isSecondary?"secondary":"primary")).map(sharedMetric=>({...sharedMetric.query,name:sharedMetric.name,sharedMetricId:sharedMetric.saved_metric,isSharedMetric:!0}));sharedMetrics&&(metrics=[...metrics,...sharedMetrics]);let maxAbsValue=Math.max(...metrics.flatMap((metric,index)=>{let result=results?.[index];return result?variants.flatMap(variant=>{let insightType=getInsightType(metric),interval=(0,legacyExperimentCalculations.fv)(result,variant.key,insightType);return interval?[Math.abs(interval[0]/100),Math.abs(interval[1]/100)]:[]}):[]})),padding=Math.max(.05*maxAbsValue,.1),chartBound=maxAbsValue+padding,commonTickValues=(0,shared_utils.Zj)(chartBound);return(0,jsx_runtime.jsxs)("div",{className:"mb-4 -mt-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/2 pt-5",children:(0,jsx_runtime.jsxs)("div",{className:"inline-flex items-center deprecated-space-x-2 mb-0",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0 font-semibold text-lg leading-6",children:isSecondary?"Secondary metrics":"Primary metrics"}),metrics.length>0&&(0,jsx_runtime.jsx)(src.u,{title:isSecondary?"Secondary metrics capture additional outcomes or behaviors affected by your experiment. They help you understand broader impacts and potential side effects beyond the primary goal.":"Primary metrics represent the main goal of your experiment. They directly measure whether your hypothesis was successful and are the key factor in deciding if the test achieved its primary objective.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-lg"})}),hasSomeResults&&!isSecondary&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.p2,{vertical:!0,className:"mx-2"}),(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)("div",{className:"p-2",children:[(0,jsx_runtime.jsxs)("p",{className:"mb-4",children:["Each bar shows how a variant is performing compared to the control (the gray bar) for this metric, using a"," ",(0,jsx_runtime.jsx)("strong",{children:"95% credible interval."}),' That means there\'s a 95% chance the true difference for that variant falls within this range. The vertical "0%" line is your baseline:']}),(0,jsx_runtime.jsxs)("ul",{className:"mb-4 list-disc pl-4",children:[(0,jsx_runtime.jsxs)("li",{children:[(0,jsx_runtime.jsx)("strong",{children:"To the right (green):"})," The metric is higher (an improvement)."]}),(0,jsx_runtime.jsxs)("li",{children:[(0,jsx_runtime.jsx)("strong",{children:"To the left (red):"})," The metric is lower (a decrease)."]})]}),(0,jsx_runtime.jsx)("p",{className:"mb-4",children:"The shape of each bar represents the probability distribution. The true value is more likely to be near the center (where the bar is wider) than at the edges (where it tapers off)."}),(0,jsx_runtime.jsx)("p",{className:"mb-4",children:"The control (baseline) is always shown in gray. Other bars will be green or redâor even a mixâdepending on whether the change is positive or negative."}),(0,jsx_runtime.jsx)("img",{src:"https://res.cloudinary.com/dmukukwp6/image/upload/violin_plot_screenshot_acca775d36.png",width:700,className:"rounded border object-contain",alt:"How to read metrics"})]}),children:(0,jsx_runtime.jsx)("span",{className:"text-xs text-secondary cursor-help",children:"How to read"})})]})]})}),(0,jsx_runtime.jsx)("div",{className:"w-1/2 flex flex-col justify-end",children:(0,jsx_runtime.jsx)("div",{className:"ml-auto",children:metrics.length>0&&(0,jsx_runtime.jsx)("div",{className:"mb-2 mt-4 justify-end",children:isSecondary?(0,jsx_runtime.jsx)(AddSecondaryMetric,{}):(0,jsx_runtime.jsx)(AddPrimaryMetric,{})})})})]}),metrics.length>0?(0,jsx_runtime.jsx)("div",{className:"w-full overflow-x-auto",children:(0,jsx_runtime.jsx)("div",{className:"min-w-[1000px]",children:metrics.map((metric,index)=>{let result=results?.[index],isFirstMetric=0===index;return(0,jsx_runtime.jsx)("div",{className:`w-full border border-primary bg-light ${1===metrics.length?"rounded":isFirstMetric?"rounded-t":index===metrics.length-1?"rounded-b":""}`,children:(0,jsx_runtime.jsx)(DeltaChart,{isSecondary:!!isSecondary,result:result,error:errors?.[index],variants:variants,metricType:getInsightType(metric),displayOrder:index,metric:metric,isFirstMetric:isFirstMetric,tickValues:commonTickValues,chartBound:chartBound})},metric.uuid||index)})})}):(0,jsx_runtime.jsx)("div",{className:"border rounded bg-surface-primary pt-6 pb-8 text-secondary mt-2",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col items-center mx-auto deprecated-space-y-3",children:[(0,jsx_runtime.jsx)(icons.Ii,{fontSize:"30"}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-center text-balance max-w-sm",children:(0,jsx_runtime.jsx)("p",{children:isSecondary?"Secondary metrics provide additional context and help detect unintended side effects.":"Primary metrics represent the main goal of the experiment and directly measure if your hypothesis was successful."})}),isSecondary?(0,jsx_runtime.jsx)(AddSecondaryMetric,{}):(0,jsx_runtime.jsx)(AddPrimaryMetric,{})]})})]})}var Chart=__webpack_require__("../../frontend/src/lib/Chart.ts"),LemonModal=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonModal/index.ts");let DELTA=[.16,.17,.15,.16,.14,.15,.145,.15,.155,.148,.15,.147,.152,.15],UPPER_BOUND=[.26,.27,.24,.24,.21,.21,.2,.2,.195,.183,.182,.177,.182,.18],LOWER_BOUND=[.06,.07,.06,.08,.07,.09,.09,.1,.115,.113,.118,.117,.122,.12],VariantDeltaTimeseries=()=>{let{closeVariantDeltaTimeseriesModal}=(0,index_esm.useActions)(modalsLogic.l),{isVariantDeltaTimeseriesModalOpen}=(0,index_esm.useValues)(modalsLogic.l),chartRef=(0,react.useRef)(null);return(0,react.useEffect)(()=>(isVariantDeltaTimeseriesModalOpen&&setTimeout(()=>{let ctx=document.getElementById("variantDeltaChart");if(!ctx){console.error("Canvas element not found");return}let existingChart=Chart.kL.getChart(ctx);existingChart&&existingChart.destroy(),ctx.style.width="100%",ctx.style.height="100%";let config={type:"line",data:{labels:["Day 1","Day 2","Day 3","Day 4","Day 5","Day 6","Day 7","Day 8","Day 9","Day 10","Day 11","Day 12","Day 13","Day 14"],datasets:[{label:"Upper Bound",data:UPPER_BOUND,borderColor:"rgba(200, 200, 200, 1)",fill:!1,tension:0,pointRadius:0},{label:"Lower Bound",data:LOWER_BOUND,borderColor:"rgba(200, 200, 200, 1)",fill:"-1",backgroundColor:"rgba(200, 200, 200, 0.2)",tension:0,pointRadius:0},{label:"Delta",data:DELTA,borderColor:"rgba(0, 100, 255, 1)",borderWidth:2,fill:!1,tension:0,pointRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"nearest",axis:"x"},scales:{y:{beginAtZero:!0,grid:{display:!1},ticks:{count:6,callback:value=>`${(100*Number(value)).toFixed(1)}%`}}},plugins:{legend:{display:!1},tooltip:{callbacks:{labelPointStyle:function(){return{pointStyle:"circle",rotation:0}}},usePointStyle:!0,boxWidth:16,boxHeight:1},crosshair:!1}}};chartRef.current=new Chart.kL(ctx,config)},0),()=>{chartRef.current&&(chartRef.current.destroy(),chartRef.current=null)}),[isVariantDeltaTimeseriesModalOpen]),(0,jsx_runtime.jsx)(LemonModal.f,{isOpen:isVariantDeltaTimeseriesModalOpen,onClose:()=>{closeVariantDeltaTimeseriesModal()},width:800,title:"Variant performance over time",footer:(0,jsx_runtime.jsx)(LemonButton.J,{form:"secondary-metric-modal-form",type:"secondary",onClick:()=>{},children:"Close"}),children:(0,jsx_runtime.jsx)("div",{className:"relative h-[400px]",children:(0,jsx_runtime.jsx)("canvas",{id:"variantDeltaChart"})})})},AddMetricButton=_ref=>{let{metricContext}=_ref,{openMetricSourceModal}=(0,index_esm.useActions)(metricSourceModalLogic);return(0,jsx_runtime.jsxs)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),type:"secondary",size:"xsmall",onClick:()=>{openMetricSourceModal(metricContext)},children:["Add ",metricContext.type," metric"]})};var core_esm=__webpack_require__("../../node_modules/.pnpm/@dnd-kit+core@6.0.8_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@dnd-kit/core/dist/core.esm.js"),modifiers_esm=__webpack_require__("../../node_modules/.pnpm/@dnd-kit+modifiers@6.0.1_@dnd-kit+core@6.0.8_react-dom@18.2.0_react@18.2.0__react@18.2.0__react@18.2.0/node_modules/@dnd-kit/modifiers/dist/modifiers.esm.js"),sortable_esm=__webpack_require__("../../node_modules/.pnpm/@dnd-kit+sortable@7.0.2_@dnd-kit+core@6.0.8_react-dom@18.2.0_react@18.2.0__react@18.2.0__react@18.2.0/node_modules/@dnd-kit/sortable/dist/sortable.esm.js"),utilities_esm=__webpack_require__("../../node_modules/.pnpm/@dnd-kit+utilities@3.2.1_react@18.2.0/node_modules/@dnd-kit/utilities/dist/utilities.esm.js");let MetricItem=_ref=>{let{metric,order}=_ref,uuid=metric.uuid||metric.query?.uuid,{attributes,listeners,setNodeRef,transform,transition,isDragging}=(0,sortable_esm.nB)({id:uuid});return(0,jsx_runtime.jsxs)("div",{ref:setNodeRef,className:(0,clsx_m.default)("relative flex items-center gap-2 p-3 border rounded cursor-move bg-bg-light",isDragging&&"z-[999999]"),style:{transform:utilities_esm.ux.Transform.toString(transform),transition},...attributes,...listeners,children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconDrag,{className:"text-orange-500 flex-shrink-0 text-lg"}),(0,jsx_runtime.jsx)(src.Mo.Number,{count:order+1,maxDigits:3,status:"muted"}),(0,jsx_runtime.jsxs)("div",{className:"flex-1 min-w-0 flex flex-col gap-1",children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,jsx_runtime.jsx)(MetricTitle,{metric:metric})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-1",children:[(0,jsx_runtime.jsx)(src.oe,{type:"muted",size:"small",children:(0,shared_utils.Xj)(metric)}),metric.isSharedMetric&&(0,jsx_runtime.jsx)(src.oe,{type:"option",size:"small",children:"Shared"})]})]})]})};function MetricsReorderModal(_ref2){let{isSecondary=!1}=_ref2,{isPrimaryMetricsReorderModalOpen,isSecondaryMetricsReorderModalOpen}=(0,index_esm.useValues)(modalsLogic.l),{closePrimaryMetricsReorderModal,closeSecondaryMetricsReorderModal}=(0,index_esm.useActions)(modalsLogic.l),isOpen=isSecondary?isSecondaryMetricsReorderModalOpen:isPrimaryMetricsReorderModalOpen,closeModal=isSecondary?closeSecondaryMetricsReorderModal:closePrimaryMetricsReorderModal,{experiment,getOrderedMetrics}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{updateExperiment}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),[orderedUuids,setOrderedUuids]=(0,react.useState)([]);(0,react.useEffect)(()=>{if(isOpen&&experiment){var _experiment$secondary,_experiment$primary_m;setOrderedUuids([...isSecondary?null!==(_experiment$secondary=experiment.secondary_metrics_ordered_uuids)&&void 0!==_experiment$secondary?_experiment$secondary:[]:null!==(_experiment$primary_m=experiment.primary_metrics_ordered_uuids)&&void 0!==_experiment$primary_m?_experiment$primary_m:[]])}else setOrderedUuids([])},[isOpen,isSecondary,experiment.primary_metrics_ordered_uuids,experiment.secondary_metrics_ordered_uuids,experiment]);let displayMetrics=(()=>{if(!experiment||0===orderedUuids.length)return[];let allMetrics=getOrderedMetrics(isSecondary),metricsMap=new Map;return allMetrics.forEach(metric=>{let uuid=metric.uuid||metric.query?.uuid;uuid&&metricsMap.set(uuid,metric)}),orderedUuids.map(uuid=>metricsMap.get(uuid)).filter(Boolean)})(),handleSaveOrder=async()=>{isSecondary?experiment.secondary_metrics_ordered_uuids=orderedUuids:experiment.primary_metrics_ordered_uuids=orderedUuids,await updateExperiment({primary_metrics_ordered_uuids:experiment?.primary_metrics_ordered_uuids,secondary_metrics_ordered_uuids:experiment?.secondary_metrics_ordered_uuids}),closeModal()};return(0,jsx_runtime.jsx)(src.fQ,{onClose:closeModal,isOpen:isOpen,width:600,title:`Reorder ${isSecondary?"secondary":"primary"} metrics`,description:(0,jsx_runtime.jsxs)("p",{children:["Change the order in which your ",isSecondary?"secondary":"primary"," metrics are displayed. You can ",(0,jsx_runtime.jsx)("b",{children:"drag and drop the metrics below"})," to change their order."]}),footer:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:closeModal,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{type:"primary",onClick:handleSaveOrder,children:"Save order"})]}),children:(0,jsx_runtime.jsx)("div",{className:"flex flex-col gap-2",children:(0,jsx_runtime.jsx)(core_esm.LB,{modifiers:[modifiers_esm.DL,modifiers_esm.F4],onDragEnd:_ref3=>{let{active,over}=_ref3;if(active.id&&over&&active.id!==over.id){let from=orderedUuids.indexOf(active.id),to=orderedUuids.indexOf(over.id);-1!==from&&-1!==to&&setOrderedUuids((0,sortable_esm.Rp)(orderedUuids,from,to))}},children:(0,jsx_runtime.jsxs)(sortable_esm.Fo,{items:orderedUuids,strategy:sortable_esm.qw,children:[0===displayMetrics.length&&(0,jsx_runtime.jsx)("div",{className:"p-4 text-center text-muted",children:(0,jsx_runtime.jsx)("p",{children:"No metrics available for reordering"})}),displayMetrics.map((metric,index)=>(0,jsx_runtime.jsx)(MetricItem,{metric:metric,order:index},metric.uuid||metric.query?.uuid))]})})})})}var Link=__webpack_require__("../../frontend/src/lib/lemon-ui/Link/index.ts");function HowToReadTooltip(){let{statsMethod}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{isDarkModeOn}=(0,index_esm.useValues)(themeLogic.b);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(src.p2,{vertical:!0,className:"mx-2"}),(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)("div",{className:"p-2",children:[(0,jsx_runtime.jsx)("p",{className:"mb-3 font-semibold",children:"Is my variant significant?"}),(0,jsx_runtime.jsxs)("p",{className:"mb-3",children:["Look at the ",(0,jsx_runtime.jsx)("strong",{children:"Delta column"})," for each variant:"]}),(0,jsx_runtime.jsxs)("div",{className:"mb-3 space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-3",children:[(0,jsx_runtime.jsxs)("span",{className:"inline-flex items-center gap-1 w-20 font-semibold",style:{color:isDarkModeOn?"#388600":"rgb(5, 223, 114)"},children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconTrending,{className:"w-3 h-3"}),"Green"]}),(0,jsx_runtime.jsx)("span",{children:"Variant won"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-3",children:[(0,jsx_runtime.jsxs)("span",{className:"inline-flex items-center gap-1 w-20 font-semibold",style:{color:isDarkModeOn?"#df4b20":"rgb(255, 102, 102)"},children:[(0,jsx_runtime.jsx)(icons.j4,{className:"w-3 h-3"}),"Red"]}),(0,jsx_runtime.jsx)("span",{children:"Variant lost"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-3",children:[(0,jsx_runtime.jsx)("span",{className:"inline-flex items-center gap-1 w-20 font-semibold",children:"No color"}),(0,jsx_runtime.jsx)("span",{children:"Not statistically significant"})]})]}),(0,jsx_runtime.jsx)("img",{src:isDarkModeOn?"https://res.cloudinary.com/dmukukwp6/image/upload/q_auto,f_auto/sig_light_2_4f2a9648ec.png":"https://res.cloudinary.com/dmukukwp6/image/upload/q_auto,f_auto/sign_dark_2_ce4e9018ad.png",width:350,className:"rounded border object-contain mb-3",alt:"Significance indicators example"}),(0,jsx_runtime.jsxs)("p",{className:"mb-3",children:["The bars show"," ",statsMethod===types.om.Bayesian?"95% credible intervals":"95% confidence intervals",". When an interval doesn't cross the 0% line, the result is significant."]}),(0,jsx_runtime.jsx)("img",{src:isDarkModeOn?statsMethod===types.om.Bayesian?"https://res.cloudinary.com/dmukukwp6/image/upload/q_auto,f_auto/interval_bayesian_light_cc0eab723d.png":"https://res.cloudinary.com/dmukukwp6/image/upload/q_auto,f_auto/interval_frequentist_light_de8a266b6f.png":statsMethod===types.om.Bayesian?"https://res.cloudinary.com/dmukukwp6/image/upload/q_auto,f_auto/interval_b_1d344c42f6.png":"https://res.cloudinary.com/dmukukwp6/image/upload/q_auto,f_auto/interval_f_9b8ae12438.png",width:350,className:"rounded border object-contain mb-2",alt:"How to read metrics"}),(0,jsx_runtime.jsx)("p",{className:"text-sm mb-0",children:(0,jsx_runtime.jsx)(Link.r,{to:"https://posthog.com/docs/experiments/analyzing-results",children:"Learn more about analyzing results"})})]}),children:(0,jsx_runtime.jsx)("span",{className:"text-xs text-secondary cursor-help",children:"How to read"})})]})}var injectStylesIntoStyleTag=__webpack_require__("../../node_modules/.pnpm/style-loader@2.0.0_webpack@5.88.2/node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),MetricRowGroup=__webpack_require__("../../node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!../../node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.5.6_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!../../node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!../../frontend/src/scenes/experiments/MetricsView/new/MetricRowGroup.scss"),MetricRowGroup_default=__webpack_require__.n(MetricRowGroup),options={};options.insert="head",options.singleton=!1,injectStylesIntoStyleTag_default()(MetricRowGroup_default(),options),MetricRowGroup_default().locals;var react_dom=__webpack_require__("../../node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/index.js");function ChartGradients(_ref){let{lower=0,upper=0,gradientId="chart-gradient",metric}=_ref,colors=useChartColors(),goalColors=(0,shared_utils.eA)(colors,metric?.goal);if(lower<0&&upper>0){let zeroOffset=-lower/(upper-lower)*100;return(0,jsx_runtime.jsx)("defs",{children:(0,jsx_runtime.jsxs)("linearGradient",{id:gradientId,x1:"0",x2:"1",y1:"0",y2:"0",children:[(0,jsx_runtime.jsx)("stop",{offset:"0%",stopColor:goalColors.negative}),(0,jsx_runtime.jsx)("stop",{offset:`${zeroOffset}%`,stopColor:goalColors.negative}),(0,jsx_runtime.jsx)("stop",{offset:`${zeroOffset}%`,stopColor:goalColors.positive}),(0,jsx_runtime.jsx)("stop",{offset:"100%",stopColor:goalColors.positive})]})})}return(0,jsx_runtime.jsx)("defs",{children:(0,jsx_runtime.jsx)("linearGradient",{id:gradientId,x1:"0",x2:"0",y1:"0",y2:"0",children:(0,jsx_runtime.jsx)("stop",{offset:"100%",stopColor:upper<=0?goalColors.negative:goalColors.positive})})})}function GridLines_GridLines(_ref){let{tickValues,scale,height,viewBoxWidth=800,zeroLineColor=COLORS.ZERO_LINE,gridLineColor=COLORS.BOUNDARY_LINES,zeroLineWidth=1.25,gridLineWidth=.75,opacity=1,edgeThreshold=.06,edgeMargin=20}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:tickValues.map(value=>{let x=scale(value),position=(x-edgeMargin)/(viewBoxWidth-2*edgeMargin),isZeroLine=0===value;return!isZeroLine&&(position<edgeThreshold||position>1-edgeThreshold)?null:(0,jsx_runtime.jsx)("line",{x1:x,y1:0,x2:x,y2:height,stroke:isZeroLine?zeroLineColor:gridLineColor,strokeWidth:isZeroLine?zeroLineWidth:gridLineWidth,opacity:opacity},value)})})}function useAxisScale(axisRange){let viewBoxWidth=arguments.length>1&&void 0!==arguments[1]?arguments[1]:800,edgeMargin=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;return(0,react.useCallback)(value=>(0,shared_utils.wq)(value,axisRange,viewBoxWidth,edgeMargin),[axisRange,viewBoxWidth,edgeMargin])}function ChartCell(_ref){let{variantResult,metric,axisRange,metricUuid,showGridLines=!0,isAlternatingRow=!1,isLastRow=!1,isSecondary=!1,onTimeseriesClick}=_ref,colors=useChartColors(),scale=useAxisScale(axisRange,800,20),interval=(0,shared_utils.nM)(variantResult),[lower,upper]=(0,shared_utils.Ok)(variantResult),delta=(0,shared_utils.dv)(variantResult),hasEnoughData=!!interval,validationFailureType=(0,shared_utils.fN)(variantResult),x1=scale(lower),x2=scale(upper),deltaX=scale(delta);return(0,jsx_runtime.jsx)("td",{"data-table-cell":"chart",className:`p-0 align-top text-center relative overflow-hidden ${isAlternatingRow?"bg-bg-table":"bg-bg-light"} ${isLastRow?"border-b":""}`,style:{height:"51px",maxHeight:"51px"},children:(0,jsx_runtime.jsxs)("div",{className:"relative h-full",children:[(0,jsx_runtime.jsxs)("svg",{viewBox:"0 0 800 51",preserveAspectRatio:"none",className:"h-full w-full",children:[showGridLines&&(0,jsx_runtime.jsx)(GridLines_GridLines,{tickValues:(0,shared_utils.Zj)(axisRange),scale:scale,height:51,viewBoxWidth:800,zeroLineColor:colors.ZERO_LINE,gridLineColor:colors.BOUNDARY_LINES,zeroLineWidth:1.25,gridLineWidth:.75,opacity:.8,edgeMargin:20}),hasEnoughData&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ChartGradients,{lower:lower,upper:upper,metric:metric,gradientId:`gradient-${isSecondary?"secondary":"primary"}-${metricUuid?metricUuid.slice(-8):"default"}-${variantResult.key}`}),(0,shared_utils.YL)(variantResult)?(0,jsx_runtime.jsx)("path",{d:generateViolinPath(x1,x2,18,15,deltaX),fill:`url(#gradient-${isSecondary?"secondary":"primary"}-${metricUuid?metricUuid.slice(-8):"default"}-${variantResult.key})`,opacity:.9,style:{cursor:onTimeseriesClick?"pointer":"default"},onClick:onTimeseriesClick}):(0,jsx_runtime.jsx)("rect",{x:x1,y:18,width:x2-x1,height:15,fill:`url(#gradient-${isSecondary?"secondary":"primary"}-${metricUuid?metricUuid.slice(-8):"default"}-${variantResult.key})`,opacity:.9,rx:3,ry:3,style:{cursor:onTimeseriesClick?"pointer":"default"},onClick:onTimeseriesClick}),(0,jsx_runtime.jsx)("line",{x1:deltaX,y1:18,x2:deltaX,y2:33,stroke:colors.BAR_MIDDLE_POINT,strokeWidth:2,shapeRendering:"crispEdges"})]})]}),(!hasEnoughData||validationFailureType)&&(0,jsx_runtime.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:(0,jsx_runtime.jsx)("div",{className:`px-3 py-1 rounded text-xs whitespace-nowrap ${"error"===validationFailureType?"bg-danger-highlight text-danger":"bg-border-light text-muted"}`,children:"error"===validationFailureType?"Error":"Not enough data yet"})})]})})}function DetailsButton(_ref){let{setIsModalOpen}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconGraph,{}),onClick:()=>setIsModalOpen(!0),children:"Details"})})}var kea_router_lib=__webpack_require__("../../node_modules/.pnpm/kea-router@3.4.1_kea@3.1.7_react@18.2.0_/node_modules/kea-router/lib/index.js"),dist_module=__webpack_require__("../../node_modules/.pnpm/posthog-js@1.276.0_@rrweb+types@2.0.0-alpha.17/node_modules/posthog-js/dist/module.js");__webpack_require__("../../frontend/src/scenes/funnels/Funnel.scss"),__webpack_require__("../../frontend/src/scenes/funnels/FunnelBarVertical/FunnelBarVertical.scss");var ScrollableShadows=__webpack_require__("../../frontend/src/lib/components/ScrollableShadows/ScrollableShadows.tsx"),useResizeObserver=__webpack_require__("../../frontend/src/lib/hooks/useResizeObserver.ts"),StepBarLabels=__webpack_require__("../../frontend/src/scenes/funnels/FunnelBarVertical/StepBarLabels.tsx"),EntityFilterInfo=__webpack_require__("../../frontend/src/lib/components/EntityFilterInfo.tsx"),LemonDivider=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonDivider/index.ts"),LemonRow=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonRow/index.ts"),Lettermark=__webpack_require__("../../frontend/src/lib/lemon-ui/Lettermark/index.ts"),useInsightTooltip=__webpack_require__("../../frontend/src/scenes/insights/useInsightTooltip.ts"),insights_utils=__webpack_require__("../../frontend/src/scenes/insights/utils.tsx"),funnelStepTableUtils=__webpack_require__("../../frontend/src/scenes/insights/views/Funnels/funnelStepTableUtils.tsx");function FunnelTooltipContent(_ref){let{stepIndex,series,embedded=!1,hasSessionData=!1}=_ref;return(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("FunnelTooltip InsightTooltip",{"p-2":!embedded,"border-none":embedded,"shadow-none":embedded}),children:[(0,jsx_runtime.jsx)(LemonRow.Q,{icon:(0,jsx_runtime.jsx)(Lettermark.B,{name:stepIndex+1,color:Lettermark.w.Gray}),fullWidth:!0,children:(0,jsx_runtime.jsxs)("strong",{children:[(0,jsx_runtime.jsx)(EntityFilterInfo.c,{filter:(0,funnelStepTableUtils.R)(series),allowWrap:!0}),series.breakdown_value&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("span",{className:"mx-1",children:"â¢"}),(0,insights_utils.Cq)(series.breakdown_value,null,[],value=>value?.toString()||"")]})]})}),(0,jsx_runtime.jsx)(LemonDivider.p,{className:"my-2"}),(0,jsx_runtime.jsx)("table",{children:(0,jsx_runtime.jsxs)("tbody",{children:[(0,jsx_runtime.jsxs)("tr",{children:[(0,jsx_runtime.jsx)("td",{children:0===stepIndex?"Entered":"Converted"}),(0,jsx_runtime.jsx)("td",{children:(0,utils.Lc)(series.count)})]}),stepIndex>0&&(0,jsx_runtime.jsxs)("tr",{children:[(0,jsx_runtime.jsx)("td",{children:"Dropped off"}),(0,jsx_runtime.jsx)("td",{children:(0,utils.Lc)(series.droppedOffFromPrevious||0)})]}),(0,jsx_runtime.jsxs)("tr",{children:[(0,jsx_runtime.jsx)("td",{children:"Conversion so far"}),(0,jsx_runtime.jsx)("td",{children:(0,utils.e9)(series.conversionRates.total||0,2,!0)})]}),stepIndex>0&&(0,jsx_runtime.jsxs)("tr",{children:[(0,jsx_runtime.jsx)("td",{children:"Conversion from previous"}),(0,jsx_runtime.jsx)("td",{children:(0,utils.e9)(series.conversionRates.fromPrevious||0,2,!0)})]}),stepIndex>0&&null!=series.median_conversion_time&&(0,jsx_runtime.jsxs)("tr",{children:[(0,jsx_runtime.jsx)("td",{children:"Median time from previous"}),(0,jsx_runtime.jsx)("td",{children:(0,utils.C7)(series.median_conversion_time,{maxUnits:3})})]}),stepIndex>0&&null!=series.average_conversion_time&&(0,jsx_runtime.jsxs)("tr",{children:[(0,jsx_runtime.jsx)("td",{children:"Average time from previous"}),(0,jsx_runtime.jsx)("td",{children:(0,utils.C7)(series.average_conversion_time,{maxUnits:3})})]})]})}),hasSessionData&&(0,jsx_runtime.jsxs)("div",{className:"table-subtext table-subtext-click-to-inspect",children:[(0,jsx_runtime.jsx)(icons.IN,{className:"mr-1 mb-0.5"}),"Click to view persons"]})]})}function useFunnelTooltip(){let vizRef=(0,react.useRef)(null),{getTooltip}=(0,useInsightTooltip._0)(),[isTooltipShown,setIsTooltipShown]=(0,react.useState)(!1),[currentTooltip,setCurrentTooltip]=(0,react.useState)(null),[tooltipOrigin,setTooltipOrigin]=(0,react.useState)(null),[hasSessionData,setHasSessionData]=(0,react.useState)(!1);return(0,react.useEffect)(()=>{let svgRect=vizRef.current?.getBoundingClientRect(),[tooltipRoot,tooltipEl]=getTooltip();tooltipEl.style.opacity=isTooltipShown?"1":"0";let tooltipRect=tooltipEl.getBoundingClientRect();if(tooltipOrigin&&currentTooltip){let xOffset;tooltipRoot.render((0,jsx_runtime.jsx)(FunnelTooltipContent,{stepIndex:currentTooltip.stepIndex,series:currentTooltip.series,hasSessionData:hasSessionData})),xOffset=svgRect&&tooltipRect&&tooltipOrigin[0]+tooltipOrigin[2]+tooltipRect.width+4>svgRect.x+svgRect.width?-tooltipRect.width-4:tooltipOrigin[2]+4,tooltipEl.style.left=`${window.pageXOffset+tooltipOrigin[0]+xOffset}px`,tooltipEl.style.top=`${window.pageYOffset+tooltipOrigin[1]}px`}else tooltipEl.style.left="revert",tooltipEl.style.top="revert"},[isTooltipShown,tooltipOrigin,currentTooltip]),{vizRef,showTooltip:function(rect,stepIndex,series){let hasSessionData=arguments.length>3&&void 0!==arguments[3]&&arguments[3];setIsTooltipShown(!0),setCurrentTooltip({stepIndex,series}),setTooltipOrigin(rect),setHasSessionData(hasSessionData)},hideTooltip:()=>{setIsTooltipShown(!1),setCurrentTooltip(null),setTooltipOrigin(null)}}}var defaults=__webpack_require__("../../frontend/src/scenes/activity/explore/defaults.ts"),sceneLogic=__webpack_require__("../../frontend/src/scenes/sceneLogic.tsx"),sessionPlayerModalLogic=__webpack_require__("../../frontend/src/scenes/session-recordings/player/modal/sessionPlayerModalLogic.ts"),api=__webpack_require__("../../frontend/src/lib/api.ts");let sampledSessionsModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","experiments","charts","funnel","sampledSessionsModalLogic"]),(0,index_esm.actions)({openModal:modalData=>({modalData}),closeModal:!0,checkRecordingAvailability:sessionData=>({sessionData})}),(0,index_esm.reducers)({isOpen:[!1,{openModal:()=>!0,closeModal:()=>!1}],modalData:[null,{openModal:(_,_ref)=>{let{modalData}=_ref;return modalData},closeModal:()=>null}]}),(0,kea_loaders_lib.loaders)(()=>({recordingAvailability:[new Map,{checkRecordingAvailability:async _ref2=>{let{sessionData}=_ref2,allSessionIds=Array.from(new Set(sessionData.map(s=>s.session_id)));if(0===allSessionIds.length)return new Map;try{let response=await api.ZP.recordings.list({kind:schema_general.OH.RecordingsQuery,session_ids:allSessionIds,date_from:"-90d",limit:allSessionIds.length}),availabilityMap=new Map;return response.results?.forEach(recording=>{availabilityMap.set(recording.id,{hasRecording:!0})}),allSessionIds.forEach(sessionId=>{availabilityMap.has(sessionId)||availabilityMap.set(sessionId,{hasRecording:!1})}),availabilityMap}catch(error){return console.error("Failed to check recording availability:",error),new Map}}}]})),(0,index_esm.listeners)(_ref3=>{let{actions}=_ref3;return{openModal:_ref4=>{let{modalData}=_ref4;modalData.sessionData.length>0&&actions.checkRecordingAvailability(modalData.sessionData)}}})]),getEventsUrl=(key,value)=>{let eventsQuery=(0,defaults.w)([{type:types.FT.EventMetadata,key:key,value:[value],operator:types.WV.Exact}]);return"after"in eventsQuery.source&&(eventsQuery.source.after="-90d"),(0,kea_router_lib.combineUrl)(urls.j.activity(types.ZO.ExploreEvents),{},{q:eventsQuery}).url},getLinkTextAndUrl=session=>session.session_id?{text:session.session_id,url:getEventsUrl("$session_id",session.session_id)}:session.person_id?{text:session.person_id,url:getEventsUrl("person_id",session.person_id)}:{text:session.event_uuid,url:getEventsUrl("uuid",session.event_uuid)};function SampledSessionsModal(){let{isOpen,modalData,recordingAvailability,recordingAvailabilityLoading}=(0,index_esm.useValues)(sampledSessionsModalLogic),{closeModal}=(0,index_esm.useActions)(sampledSessionsModalLogic),{openSessionPlayer}=(0,index_esm.useActions)(sessionPlayerModalLogic.A);if(!modalData)return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});let{sessionData,stepName,variant}=modalData,openSessionRecording=(sessionId,eventUuid)=>{openSessionPlayer({id:sessionId,matching_events:[{session_id:sessionId,events:[{uuid:eventUuid}]}]})},columns=[{title:"Person",key:"personId",render:(_,session)=>{let{text,url}=getLinkTextAndUrl(session);return(0,jsx_runtime.jsx)("div",{className:"flex items-center gap-1",children:(0,jsx_runtime.jsxs)(src.rU,{to:url,onClick:e=>{e.preventDefault(),sceneLogic.k.actions.newTab(url)},className:"font-mono text-xs whitespace-nowrap",title:`View events for ${text}`,children:[text,(0,jsx_runtime.jsx)(icons.pF,{style:{fontSize:14}})]})})},width:"40%"},{title:"Recording",key:"recording",render:(_,session)=>{let sessionInfo=recordingAvailability.get(session.session_id),hasRecording=sessionInfo?.hasRecording||!1;return recordingAvailabilityLoading?(0,jsx_runtime.jsx)(Spinner_Spinner.$,{className:"text-sm"}):hasRecording?(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",icon:(0,jsx_runtime.jsx)(icons.Ud,{}),onClick:()=>openSessionRecording(session.session_id,session.event_uuid),children:"View recording"}):void 0},width:"60%"}];return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:closeModal,title:`Sampled persons - ${variant}`,width:720,children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsxs)("div",{className:"text",children:["Persons in ",(0,jsx_runtime.jsx)("strong",{children:variant})," with ",(0,jsx_runtime.jsx)("strong",{children:stepName})," as their last funnel step."]}),(0,jsx_runtime.jsx)("div",{className:"mt-2",children:(0,jsx_runtime.jsx)(src.g3,{columns:columns,dataSource:sessionData,size:"small",emptyState:"No sessions for this step",loading:recordingAvailabilityLoading})}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-muted border-t pt-2",children:[(0,jsx_runtime.jsx)("strong",{children:"Note:"})," This shows a sample of up to 100 persons per step. Session recordings are only available for sessions that have been captured and not deleted."]})]})})}function StepBar(_ref){let sessionData,{step,stepIndex}=_ref,ref=(0,react.useRef)(null),{showTooltip,hideTooltip}=useTooltip(),{experimentResult,experiment}=useFunnelChartData(),{openModal}=(0,index_esm.useActions)(sampledSessionsModalLogic),variantKey=Array.isArray(step.breakdown_value)?step.breakdown_value[0]?.toString()||"":step.breakdown_value?.toString()||"",seriesColor=experiment?.parameters?.feature_flag_variants&&variantKey?(0,experiments_utils.Hp)(variantKey,experiment.parameters.feature_flag_variants):"var(--text-muted)";if(experimentResult&&variantKey){if("control"===variantKey)sessionData=experimentResult.baseline.step_sessions?.[stepIndex];else{let variantResult=experimentResult.variant_results?.find(v=>v.key===variantKey);sessionData=variantResult?.step_sessions?.[stepIndex]}}let handleClick=()=>{sessionData&&openModal({sessionData,stepName:step.custom_name||step.name,variant:variantKey})};return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("StepBar"),style:{"--series-color":seriesColor,"--conversion-rate":(0,utils.e9)(step.conversionRates.fromBasisStep,1,!0)},ref:ref,onMouseEnter:()=>{if(ref.current){let rect=ref.current.getBoundingClientRect();showTooltip([rect.x,rect.y,rect.width],stepIndex,step,!!sessionData)}},onMouseLeave:()=>hideTooltip(),children:[(0,jsx_runtime.jsx)("div",{className:"StepBar__backdrop",onClick:handleClick,style:{cursor:"pointer"}}),(0,jsx_runtime.jsx)("div",{className:"StepBar__fill",onClick:handleClick,style:{cursor:"pointer"}})]})})}function StepBars(_ref){let{step,stepIndex}=_ref;return(0,jsx_runtime.jsxs)("div",{className:(0,clsx_m.default)("StepBars",0===stepIndex&&"StepBars--first"),children:[(0,jsx_runtime.jsx)("div",{className:"StepBars__grid",children:Array.from({length:5},(_,i)=>(0,jsx_runtime.jsx)("div",{className:"StepBars__gridline StepBars__gridline--horizontal"},`gridline-${stepIndex}-${i}`))}),step.nested_breakdown?.map(series=>jsx_runtime.jsx(StepBar,{step:series,stepIndex:stepIndex},`bar-${stepIndex}-${series.order}`))||(0,jsx_runtime.jsx)(StepBar,{step:step,stepIndex:stepIndex})]})}var Tooltip=__webpack_require__("../../frontend/src/lib/lemon-ui/Tooltip/index.ts");function StepLegend(_ref){var _step$count,_step$droppedOffFromP;let{step,stepIndex,showTime}=_ref,aggregationTargetLabel={singular:"user",plural:"users"},convertedCountPresentation=(0,utils.Zi)(null!==(_step$count=step.count)&&void 0!==_step$count?_step$count:0,aggregationTargetLabel.singular,aggregationTargetLabel.plural),droppedOffCountPresentation=(0,utils.Zi)(null!==(_step$droppedOffFromP=step.droppedOffFromPrevious)&&void 0!==_step$droppedOffFromP?_step$droppedOffFromP:0,aggregationTargetLabel.singular,aggregationTargetLabel.plural),convertedCountPresentationWithPercentage=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[convertedCountPresentation," ",(0,jsx_runtime.jsxs)("span",{className:"text-secondary",children:["(",(0,utils.e9)(step.conversionRates.fromBasisStep,2),")"]})]}),droppedOffCountPresentationWithPercentage=(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[droppedOffCountPresentation," ",(0,jsx_runtime.jsxs)("span",{className:"text-secondary",children:["(",(0,utils.e9)(1-step.conversionRates.fromPrevious,2),")"]})]});return(0,jsx_runtime.jsxs)("div",{className:"StepLegend",children:[(0,jsx_runtime.jsx)(LemonRow.Q,{icon:(0,jsx_runtime.jsx)(Lettermark.B,{name:stepIndex+1,color:Lettermark.w.Gray}),children:(0,jsx_runtime.jsx)("span",{title:step.custom_name||step.name,children:step.custom_name||step.name})}),(0,jsx_runtime.jsx)(LemonRow.Q,{icon:(0,jsx_runtime.jsx)(icons.cs,{}),status:"success",style:{color:"unset"},children:(0,jsx_runtime.jsx)(Tooltip.u,{title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,utils.fm)(aggregationTargetLabel.plural)," who completed this step,",(0,jsx_runtime.jsx)("br",{}),"with conversion rate relative to the first step"]}),placement:"right",children:(0,jsx_runtime.jsx)("span",{children:convertedCountPresentationWithPercentage})})}),stepIndex>0&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonRow.Q,{icon:(0,jsx_runtime.jsx)(icons.K6,{}),status:"danger",style:{color:"unset"},children:(0,jsx_runtime.jsx)(Tooltip.u,{title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,utils.fm)(aggregationTargetLabel.plural)," who didn't complete this step,",(0,jsx_runtime.jsx)("br",{}),"with drop-off rate relative to the previous step"]}),placement:"right",children:(0,jsx_runtime.jsx)("span",{children:droppedOffCountPresentationWithPercentage})})}),showTime&&(0,jsx_runtime.jsx)(LemonRow.Q,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconClock,{}),title:"Median time of conversion from previous step",children:(0,utils.C7)(step.median_conversion_time,{maxUnits:3})||"â"})]})]})}let TooltipContext=(0,react.createContext)(null);function useTooltip(){let context=(0,react.useContext)(TooltipContext);if(!context)throw Error("useDataDrivenTooltip must be used within DataDrivenTooltipContext");return context}function FunnelBarVertical_FunnelBarVertical(_ref){var _widthLimits$find$wid;let{inCardView=!1}=_ref,{stepsWithConversionMetrics}=useFunnelChartData(),{vizRef,showTooltip,hideTooltip}=useFunnelTooltip(),{height:availableHeight}=(0,useResizeObserver.y)({ref:vizRef}),[scrollbarHeightPx,setScrollbarHeightPx]=(0,react.useState)(0),[stepLegendRowHeightPx,setStepLegendRowHeightPx]=(0,react.useState)(0),seriesCount=Math.max(...stepsWithConversionMetrics.map(step=>step.nested_breakdown?.length||1),1),baseBarWidthPx=null!==(_widthLimits$find$wid=[{min:60,width:4},{min:20,width:8},{min:12,width:16},{min:10,width:20},{min:8,width:24},{min:6,width:32},{min:5,width:40},{min:4,width:48},{min:3,width:64},{min:2,width:96},{min:0,width:192}].find(_ref2=>{let{min}=_ref2;return seriesCount>=min})?.width)&&void 0!==_widthLimits$find$wid?_widthLimits$find$wid:192,scrollRef=(0,react.useRef)(null),stepLegendRowRef=(0,react.useRef)(null);(0,react.useLayoutEffect)(()=>{scrollRef.current&&setScrollbarHeightPx(scrollRef.current.offsetHeight-scrollRef.current.clientHeight)},[availableHeight]),(0,react.useLayoutEffect)(()=>{stepLegendRowRef.current&&setStepLegendRowHeightPx(stepLegendRowRef.current.clientHeight)},[availableHeight]);let showTime=stepsWithConversionMetrics.some(step=>null!=step.average_conversion_time),barRowHeight=`max(150px, calc(${availableHeight}px - 1px - ${stepLegendRowHeightPx}px - ${scrollbarHeightPx}px))`;return(0,jsx_runtime.jsxs)(TooltipContext.Provider,{value:{showTooltip,hideTooltip},children:[(0,jsx_runtime.jsx)("div",{className:"FunnelBarVertical",ref:vizRef,"data-attr":"funnel-bar-vertical",children:(0,jsx_runtime.jsx)(ScrollableShadows.D,{scrollRef:scrollRef,direction:"horizontal",children:(0,jsx_runtime.jsxs)("table",{style:{"--bar-width":`${inCardView?2*baseBarWidthPx:baseBarWidthPx}px`,"--bar-row-height":barRowHeight},children:[(0,jsx_runtime.jsxs)("colgroup",{children:[stepsWithConversionMetrics.map((_,i)=>(0,jsx_runtime.jsx)("col",{width:0},i)),(0,jsx_runtime.jsx)("col",{width:"100%"})]}),(0,jsx_runtime.jsxs)("tbody",{children:[(0,jsx_runtime.jsxs)("tr",{children:[(0,jsx_runtime.jsx)("td",{children:(0,jsx_runtime.jsx)(StepBarLabels.O,{})}),stepsWithConversionMetrics.map((step,stepIndex)=>(0,jsx_runtime.jsx)("td",{children:(0,jsx_runtime.jsx)(StepBars,{step:step,stepIndex:stepIndex})},stepIndex))]}),(0,jsx_runtime.jsxs)("tr",{ref:stepLegendRowRef,children:[(0,jsx_runtime.jsx)("td",{}),stepsWithConversionMetrics.map((step,stepIndex)=>(0,jsx_runtime.jsx)("td",{children:(0,jsx_runtime.jsx)(StepLegend,{step:step,stepIndex:stepIndex,showTime:showTime})},stepIndex))]})]})]})})}),(0,jsx_runtime.jsx)(SampledSessionsModal,{})]})}var funnelUtils=__webpack_require__("../../frontend/src/scenes/funnels/funnelUtils.ts");function processFunnelData(steps){let options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{stepReference=types.XF.total}=options,sortedSteps=steps.sort((a,b)=>a.order-b.order),stepsWithMetrics=(0,funnelUtils.I4)(sortedSteps,stepReference),flattenedBreakdowns=(0,funnelUtils.Vk)(stepsWithMetrics,constants.xp.vertical,!0),hasFunnelResults=!!(sortedSteps&&sortedSteps[0]&&sortedSteps[0].count>-1);return{steps:sortedSteps,stepsWithConversionMetrics:stepsWithMetrics,flattenedBreakdowns,hasFunnelResults}}let FunnelChartDataContext=(0,react.createContext)(null);function useFunnelChartData(){let context=(0,react.useContext)(FunnelChartDataContext);if(!context)throw Error("useFunnelChartData must be used within a experiment Funnel");return context}function FunnelChart(_ref){let{steps,stepReference=types.XF.total,hiddenLegendBreakdowns=[],disableBaseline=!1,inCardView=!1,experimentResult,experiment,...chartParams}=_ref,processedData=(0,react.useMemo)(()=>processFunnelData(steps,{stepReference,disableBaseline,hiddenLegendBreakdowns}),[steps,stepReference,disableBaseline,hiddenLegendBreakdowns]),contextValue=(0,react.useMemo)(()=>({stepsWithConversionMetrics:processedData.stepsWithConversionMetrics,steps:processedData.steps,hasFunnelResults:processedData.hasFunnelResults,experimentResult,experiment}),[processedData,experimentResult,experiment]);return(0,jsx_runtime.jsx)(FunnelChartDataContext.Provider,{value:contextValue,children:(0,jsx_runtime.jsx)("div",{className:`pt-4 FunnelInsight FunnelInsight--type-steps-vertical${inCardView?" InsightCard":""}`,children:(0,jsx_runtime.jsx)(FunnelBarVertical_FunnelBarVertical,{...chartParams,inCardView:inCardView})})})}function convertExperimentResultToFunnelSteps(result,metric){let allResults=[result.baseline,...result.variant_results||[]],stepCountsSource=allResults.find(r=>r.step_counts&&r.step_counts.length>0)||result.baseline,numSteps=(stepCountsSource.step_counts?.length||0)+1,funnelSteps=[];for(let stepIndex=0;stepIndex<numSteps;stepIndex++){let variantSteps=allResults.map((variantResult,variantIndex)=>{let count,stepName;if(count=0===stepIndex?variantResult.number_of_samples:variantResult.step_counts?.[stepIndex-1]||0,0===stepIndex)stepName="Experiment exposure";else if((0,schema_general.N4)(metric)&&metric.series?.[stepIndex-1]){let series=metric.series[stepIndex-1];stepName=series.kind===schema_general.OH.EventsNode?series.custom_name||series.name||series.event||`Step ${stepIndex}`:series.custom_name||series.name||`Action ${series.id}`}else stepName=`Step ${stepIndex}`;return{name:stepName,custom_name:null,count:count,type:"events",breakdown_value:variantResult.key,breakdown_index:variantIndex}}),baseStep=variantSteps[0],totalCount=variantSteps.reduce((sum,step)=>sum+step.count,0);funnelSteps.push({...baseStep,count:totalCount,nested_breakdown:variantSteps})}return funnelSteps}function ResultDetails(_ref){let{experiment,result,metric}=_ref,columns=[{key:"variant",title:"Variant",render:(_,item)=>(0,jsx_runtime.jsx)(components.Aw,{experimentId:experiment.id,variantKey:item.key})},{key:"total-users",title:"Total users",render:(_,item)=>(0,utils.Lc)(item.number_of_samples)},{key:"value",title:(0,schema_general.Gt)(metric)?"Mean":(0,schema_general.FQ)(metric)?"Ratio":"Conversion rate",render:(_,item)=>(0,shared_utils.jP)(item,metric)},{key:"statistical_measure",title:result.variant_results?.[0]&&(0,shared_utils.YL)(result.variant_results[0])?"Chance to win":"p-value",render:(_,item)=>"control"===item.key?"â":(0,shared_utils.YL)(item)?(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,shared_utils.kU)(item.chance_to_win)}):(0,shared_utils.VB)(item)?(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:(0,shared_utils.L5)(item.p_value)}):"â"},{key:"significant",title:"Significant",render:(_,item)=>{if("control"===item.key||!("significant"in item))return"â";let label=item.significant?"Yes":"No";return item.significant?(0,jsx_runtime.jsx)("div",{className:"text-success font-semibold",children:label}):label}},{key:"interval",title:result.variant_results?.[0]?`${(0,shared_utils.qr)(result.variant_results[0])} (95%)`:"Confidence interval (95%)",render:(_,item)=>{if("control"===item.key)return"â";let interval=(0,shared_utils.nM)(item);return interval?`[${(100*interval[0]).toFixed(2)}%, ${(100*interval[1]).toFixed(2)}%]`:"â"}},{key:"recordings",title:"",render:(_,item)=>{let variantKey=item.key,filters=(0,experiments_utils.l_)(experiment,metric,variantKey);return(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconRewindPlay,{}),tooltip:"Watch recordings of people who were exposed to this variant.",disabledReason:0===filters.length?"Unable to identify recordings for this metric":void 0,type:"secondary",onClick:()=>{var _experiment$exposure_;let filterGroup={filter_group:{type:types.J2.And,values:[{type:types.J2.And,values:filters}]},date_from:experiment?.start_date,date_to:experiment?.end_date,filter_test_accounts:null!==(_experiment$exposure_=experiment.exposure_criteria?.filterTestAccounts)&&void 0!==_experiment$exposure_&&_experiment$exposure_};kea_router_lib.router.actions.push(urls.j.replay(types.yd.Home,filterGroup)),dist_module.ZP.capture("viewed recordings from experiment",{variant:variantKey})},children:"View recordings"})}}],dataSource=[...result.baseline?[{...result.baseline,key:"control"}]:[],...result.variant_results||[]];return(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)(src.g3,{columns:columns,dataSource:dataSource,loading:!1}),(0,schema_general.N4)(metric)&&(0,jsx_runtime.jsx)(FunnelChart,{steps:convertExperimentResultToFunnelSteps(result,metric),showPersonsModal:!1,disableBaseline:!0,inCardView:!0,experimentResult:result,experiment:experiment})]})}function DetailsModal(_ref){let{isOpen,onClose,metric,result,experiment}=_ref;return result.metric=metric,(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:onClose,width:1200,title:`Metric results: ${metric.name||"Untitled metric"}`,footer:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:onClose,children:"Close"}),children:(0,jsx_runtime.jsx)(ResultDetails,{result:result,experiment:experiment,metric:metric})})}var LemonTag=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTag/index.ts");let renderTooltipContent=(variantResult,metric)=>{let intervalPercent=(0,shared_utils.KK)(variantResult),intervalLabel=(0,shared_utils.qr)(variantResult),significant=(0,shared_utils.$Y)(variantResult),winning=(0,shared_utils.HB)(variantResult,metric.goal);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold pb-2",children:variantResult.key}),"control"!==variantResult.key&&(0,jsx_runtime.jsx)(LemonTag.o,{type:significant?winning?"success":"danger":"muted",size:"medium",children:significant?winning?"Won":"Lost":"Not significant"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-muted-alt font-semibold",children:"Total value:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(0,utils.Lc)(variantResult.sum)})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-muted-alt font-semibold",children:"Exposures:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:variantResult.number_of_samples})]}),(0,shared_utils.YL)(variantResult)?(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-muted-alt font-semibold",children:"Chance to win:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(0,shared_utils.vm)(variantResult,metric.goal)})]}):(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-muted-alt font-semibold",children:"P-value:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(0,shared_utils.L5)(variantResult.p_value)})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsx)("span",{className:"text-muted-alt font-semibold",children:"Delta:"}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"control"===variantResult.key?(0,jsx_runtime.jsx)("em",{className:"text-muted-alt",children:"Baseline"}):(0,jsx_runtime.jsx)("span",{className:winning?"text-success":"text-danger",children:(0,shared_utils.UT)(variantResult)})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center",children:[(0,jsx_runtime.jsxs)("span",{className:"text-muted-alt font-semibold",children:[intervalLabel,":"]}),(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:intervalPercent})]})]})};var More=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonButton/More.tsx"),lib_colors=__webpack_require__("../../frontend/src/lib/colors.ts"),LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/index.ts");let experimentTimeseriesLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>props.experimentId),(0,index_esm.path)(key=>["scenes","experiments","experimentTimeseriesLogic",key]),(0,index_esm.connect)(()=>({values:[experiments_experimentLogic.Wl,["experiment"]]})),(0,index_esm.actions)(()=>({clearTimeseries:!0,recalculateTimeseries:_ref=>{let{metric}=_ref;return{metric}}})),(0,kea_loaders_lib.loaders)(_ref2=>{let{props}=_ref2;return{timeseries:[null,{loadTimeseries:async _ref3=>{let{metric}=_ref3;if(!metric.uuid)throw Error("Metric UUID is required");if(!metric.fingerprint)throw Error("Metric fingerprint is required");return await api.ZP.get(`api/projects/@current/experiments/${props.experimentId}/timeseries_results/?metric_uuid=${metric.uuid}&fingerprint=${metric.fingerprint}`)},clearTimeseries:()=>null,recalculateTimeseries:async _ref4=>{let{metric}=_ref4;if(!metric.fingerprint)throw Error("Metric fingerprint is required");try{let response=await api.ZP.createResponse(`api/projects/@current/experiments/${props.experimentId}/recalculate_timeseries/`,{metric:metric,fingerprint:metric.fingerprint});response.ok&&(201===response.status?LemonToast.U.success("Recalculation started successfully"):200===response.status&&LemonToast.U.info("Recalculation already in progress"))}catch(error){throw LemonToast.U.error("Failed to start recalculation"),error}return null}}]}}),(0,index_esm.selectors)({processedVariantData:[s=>[s.timeseries],timeseries=>variantKey=>{if(!timeseries?.timeseries||!["completed","partial"].includes(timeseries.status))return[];let sortedTimeseriesData=Object.entries(timeseries.timeseries).map(_ref5=>{let[date,data]=_ref5;return{date,data:data}}).sort((a,b)=>a.date.localeCompare(b.date)),lastKnownData=null;return sortedTimeseriesData.map(entry=>{let d=entry.data;if(d&&d.variant_results&&d.baseline){let variant=d.variant_results.find(v=>v.key===variantKey),baseline=d.baseline;if(variant&&baseline){var _variant$significant;let[lower,upper]=(0,shared_utils.nM)(variant)||[0,0],dataPoint={date:entry.date,value:(lower+upper)/2,upper_bound:upper,lower_bound:lower,hasRealData:!0,number_of_samples:variant.number_of_samples||0,significant:null!==(_variant$significant=variant.significant)&&void 0!==_variant$significant&&_variant$significant};return lastKnownData=dataPoint,dataPoint}}return lastKnownData?{...lastKnownData,date:entry.date,hasRealData:!1}:{date:entry.date,value:0,upper_bound:0,lower_bound:0,hasRealData:!1,number_of_samples:0,significant:!1}})}],progressMessage:[s=>[s.timeseries],timeseries=>{if(!timeseries||"partial"!==timeseries.status)return null;let timeseriesData=timeseries.timeseries||{},computedDays=Object.values(timeseriesData).filter(Boolean).length,totalDays=Object.keys(timeseriesData).length;return totalDays>0?`Computed ${computedDays} of ${totalDays} days`:null}],hasTimeseriesData:[s=>[s.timeseries],timeseries=>!!(timeseries&&("completed"===timeseries.status||"partial"===timeseries.status)&&timeseries.timeseries&&Object.values(timeseries.timeseries).some(data=>null!==data))],chartData:[s=>[s.processedVariantData,s.experiment],(processedVariantData,experiment)=>variantKey=>{let processedData=processedVariantData(variantKey);if(0===processedData.length)return null;let firstMeaningfulIndex=processedData.findIndex(d=>d.hasRealData&&null!==d.value&&0!==d.value&&null!==d.upper_bound&&null!==d.lower_bound&&0!==d.upper_bound&&0!==d.lower_bound),trimmedData=firstMeaningfulIndex>0?processedData.slice(firstMeaningfulIndex):processedData,labels=trimmedData.map(d=>d.date),values=trimmedData.map(d=>d.value),upperBounds=trimmedData.map(d=>d.upper_bound),lowerBounds=trimmedData.map(d=>d.lower_bound),variantIndex=0;if(experiment?.parameters?.feature_flag_variants){let idx=experiment.parameters.feature_flag_variants.findIndex(v=>v.key===variantKey);-1!==idx&&(variantIndex=idx)}let variantColor=(0,lib_colors._r)(variantIndex),datasets=[];return datasets.push({label:"Upper bound",data:upperBounds,borderColor:COLORS.BAR_DEFAULT,borderWidth:1,fill:!1,tension:0,pointRadius:0}),datasets.push({label:"Lower bound",data:lowerBounds,borderColor:COLORS.BAR_DEFAULT,borderWidth:1,fill:"-1",backgroundColor:context=>{if(context.parsed){let dataPoint=trimmedData[context.dataIndex];if(dataPoint?.significant)return null!==dataPoint.value&&dataPoint.value>0?(0,utils.E9)(COLORS.BAR_POSITIVE,.15):(0,utils.E9)(COLORS.BAR_NEGATIVE,.15)}return(0,utils.E9)(COLORS.BAR_DEFAULT,.1)},segment:{backgroundColor:ctx=>{let dataPoint=trimmedData[ctx.p0DataIndex];return dataPoint?.significant?null!==dataPoint.value&&dataPoint.value>0?(0,utils.E9)(COLORS.BAR_POSITIVE,.15):(0,utils.E9)(COLORS.BAR_NEGATIVE,.15):(0,utils.E9)(COLORS.BAR_DEFAULT,.1)}},tension:0,pointRadius:0}),datasets.push({label:"Delta",data:values,borderColor:variantColor,borderWidth:2,fill:!1,tension:0,pointRadius:3,pointBackgroundColor:context=>{if(context.parsed){let dataPoint=trimmedData[context.dataIndex];return dataPoint?.hasRealData?variantColor:(0,utils.E9)(variantColor,.5)}return variantColor},pointBorderColor:context=>{if(context.parsed){let dataPoint=trimmedData[context.dataIndex];return dataPoint?.hasRealData?variantColor:(0,utils.E9)(variantColor,.5)}return variantColor},segment:{borderColor:ctx=>{let endDataPoint=trimmedData[ctx.p1DataIndex];return endDataPoint?.hasRealData?variantColor:(0,utils.E9)(variantColor,.5)},borderDash:ctx=>{let endDataPoint=trimmedData[ctx.p1DataIndex];return endDataPoint?.hasRealData?[]:[5,5]}}}),{labels,datasets,processedData:trimmedData}}]}),(0,index_esm.afterMount)(_ref6=>{let{props,actions}=_ref6;props.metric&&props.metric.uuid&&props.metric.fingerprint&&actions.loadTimeseries({metric:props.metric})})]);function VariantTimeseriesChart(_ref){let{chartData:data}=_ref,canvasRef=(0,react.useRef)(null),chartRef=(0,react.useRef)(null),colors=useChartColors();return(0,react.useEffect)(()=>{if(!data)return;let timeoutId=setTimeout(()=>{let ctx=canvasRef.current;if(!ctx){console.error("Canvas element not found");return}let existingChart=Chart.kL.getChart(ctx);existingChart&&existingChart.destroy(),ctx.style.width="100%",ctx.style.height="100%";let{labels,datasets,processedData}=data,config={type:"line",data:{labels,datasets},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"nearest",axis:"x"},scales:{y:{beginAtZero:!0,grid:{display:!0,color:colors.EXPOSURES_AXIS_LINES},ticks:{count:6,callback:value=>{let num=Number(value);return 1>Math.abs(num)?`${(100*num).toFixed(1)}%`:num.toFixed(2)}}},x:{grid:{display:!1}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(context){let value=context.parsed.y,formattedValue=`${(100*value).toFixed(2)}%`;return`${context.dataset.label}: ${formattedValue}`},labelPointStyle:function(){return{pointStyle:"circle",rotation:0}},afterBody:function(context){if(context.length>0){let dataPoint=processedData[context[0].dataIndex],lines=[];return dataPoint&&!dataPoint.hasRealData&&lines.push("â ï¸ Data pending - showing last known value"),dataPoint&&dataPoint.number_of_samples&&lines.push(`Samples: ${dataPoint.number_of_samples.toLocaleString()}`),dataPoint&&void 0!==dataPoint.significant&&lines.push(`Significant: ${dataPoint.significant?"Yes":"No"}`),lines}return[]}},usePointStyle:!0,boxWidth:16,boxHeight:1},crosshair:!1}}};chartRef.current=new Chart.kL(ctx,config)},0);return()=>{clearTimeout(timeoutId),chartRef.current&&(chartRef.current.destroy(),chartRef.current=null)}},[data,colors.EXPOSURES_AXIS_LINES]),(0,jsx_runtime.jsx)("div",{className:"relative h-[224px]",children:(0,jsx_runtime.jsx)("canvas",{ref:canvasRef})})}function TimeseriesModal(_ref){let{isOpen,onClose,metric,variantResult,experiment}=_ref,logic=experimentTimeseriesLogic({experimentId:experiment.id,metric:isOpen?metric:void 0}),{chartData,progressMessage,hasTimeseriesData,timeseriesLoading}=(0,index_esm.useValues)(logic),{recalculateTimeseries}=(0,index_esm.useActions)(logic),processedChartData=chartData(variantResult.key);return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isOpen,onClose:onClose,width:1e3,title:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,jsx_runtime.jsx)("div",{className:"flex items-center",children:(0,jsx_runtime.jsx)("span",{children:"Time series"})}),(0,jsx_runtime.jsx)(src.p2,{vertical:!0,className:"h-4 self-stretch"}),(0,jsx_runtime.jsx)("div",{className:"flex items-center",children:(0,jsx_runtime.jsx)(MetricTitle,{metric:metric})}),(0,jsx_runtime.jsx)(src.p2,{vertical:!0,className:"h-4 self-stretch"}),(0,jsx_runtime.jsx)("div",{className:"flex items-center",children:(0,jsx_runtime.jsx)(components.Aw,{experimentId:experiment.id,variantKey:variantResult.key})})]}),footer:(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:onClose,children:"Close"}),children:(0,jsx_runtime.jsx)("div",{children:timeseriesLoading?(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-center gap-2 text-[14px] font-normal",style:{height:"200px"},children:[(0,jsx_runtime.jsx)(Spinner.$,{className:"text-lg"}),(0,jsx_runtime.jsx)("span",{children:"Loading timeseriesâ¦"})]}):(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center mt-2 mb-4",children:[(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted",children:progressMessage||""}),(0,jsx_runtime.jsx)(More.T,{overlay:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{src.dn.open({title:"Recalculate timeseries data",content:(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("p",{children:"All existing timeseries data will be deleted and recalculated from scratch. This could take a long time for large datasets."})}),primaryButton:{children:"Recalculate",type:"primary",onClick:()=>recalculateTimeseries({metric})},secondaryButton:{children:"Cancel"}})},children:"Recalculate"})})})]}),hasTimeseriesData?processedChartData?(0,jsx_runtime.jsx)(VariantTimeseriesChart,{chartData:processedChartData}):(0,jsx_runtime.jsx)("div",{className:"p-10 text-center text-muted",children:"No timeseries data available for this variant"}):(0,jsx_runtime.jsx)("div",{className:"p-10 text-center text-muted -translate-y-6",children:"No timeseries data available"})]})})})}function MetricRowGroup_MetricRowGroup(_ref){let{metric,result,experiment,metricType,displayOrder,axisRange,isSecondary,isLastMetric,isAlternatingRow,onDuplicateMetric,error,isLoading,hasMinimumExposureForResults=!0,exposuresLoading=!1,showDetailsModal}=_ref,[isModalOpen,setIsModalOpen]=(0,react.useState)(!1),[timeseriesModalState,setTimeseriesModalState]=(0,react.useState)({isOpen:!1,variantResult:null}),[tooltipState,setTooltipState]=(0,react.useState)({isVisible:!1,variantResult:null,position:{x:0,y:0},isPositioned:!1}),tooltipRef=(0,react.useRef)(null),colors=useChartColors(),scale=useAxisScale(axisRange,800,20),{featureFlags}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),timeseriesEnabled=featureFlags[constants.y8.EXPERIMENT_TIMESERIES]&&experiment.stats_config?.timeseries,totalRows=isLoading||error||!result?1:1+(result.variant_results?.length||0),calculateTooltipPosition=(chartCell,variantResult)=>{if(!tooltipRef.current)return null;let chartCellRect=chartCell.getBoundingClientRect(),tooltipRect=tooltipRef.current.getBoundingClientRect(),deltaX=scale((0,shared_utils.dv)(variantResult)),svgToPixelRatio=chartCellRect.width/800,x=chartCellRect.left+deltaX*svgToPixelRatio-tooltipRect.width/2,y=chartCellRect.top-tooltipRect.height-8;return{x:x=Math.max(8,Math.min(x,window.innerWidth-tooltipRect.width-8)),y}},handleTooltipMouseEnter=(e,variantResult)=>{let chartCell=e.currentTarget.querySelector('[data-table-cell="chart"]');if(!chartCell)return;let position=calculateTooltipPosition(chartCell,variantResult);setTooltipState({isVisible:!0,variantResult,position:position||{x:0,y:0},isPositioned:!!position})},handleTooltipMouseLeave=()=>{setTooltipState(prev=>({...prev,isVisible:!1,variantResult:null,isPositioned:!1}))},handleTooltipMouseMove=(e,variantResult)=>{if(!tooltipState.isPositioned){let chartCell=e.currentTarget.querySelector('[data-table-cell="chart"]');if(!chartCell)return;let position=calculateTooltipPosition(chartCell,variantResult);position&&setTooltipState(prev=>({...prev,position,isPositioned:!0}))}},handleTimeseriesClick=variantResult=>{setTimeseriesModalState({isOpen:!0,variantResult})},hasResultWithValidationFailures=result&&(0,shared_utils.KT)(result);if(isLoading||error||!result||!hasMinimumExposureForResults&&!hasResultWithValidationFailures)return(0,jsx_runtime.jsxs)("tr",{className:"hover:bg-bg-hover group [&:last-child>td]:border-b-0",style:{height:"51px",maxHeight:"51px"},children:[(0,jsx_runtime.jsx)("td",{className:`w-1/5 border-r p-3 align-top text-left relative overflow-hidden ${isLastMetric?"":"border-b"} ${isAlternatingRow?"bg-bg-table":"bg-bg-light"}`,style:{height:"51px",maxHeight:"51px"},children:(0,jsx_runtime.jsx)(MetricHeader,{displayOrder:displayOrder,metric:metric,metricType:metricType,isPrimaryMetric:!isSecondary,experiment:experiment,onDuplicateMetricClick:()=>onDuplicateMetric?.()})}),(0,jsx_runtime.jsx)("td",{colSpan:5,className:`p-3 text-center ${isAlternatingRow?"bg-bg-table":"bg-bg-light"} ${isLastMetric?"":"border-b"}`,style:{height:"51px",maxHeight:"51px"},children:isLoading||exposuresLoading?(0,jsx_runtime.jsx)(ChartLoadingState,{height:51}):(0,jsx_runtime.jsx)(ChartEmptyState,{height:51,experimentStarted:!!experiment.start_date,metric:metric,error:error})})]});let baselineResult=result.baseline,variantResults=result.variant_results||[],ratioMetricLabel=(variant,metric)=>(0,jsx_runtime.jsx)("div",{className:"text-xs text-muted",children:(()=>{let{numerator,denominator}=(0,shared_utils.iU)(variant,metric);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,utils.Lc)(numerator)," / ",(0,utils.Lc)(denominator)]})})()});return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[tooltipState.isVisible&&tooltipState.variantResult&&(0,react_dom.createPortal)((0,jsx_runtime.jsx)("div",{ref:tooltipRef,className:"fixed bg-bg-light border border-border px-3 py-2 rounded-md text-[13px] shadow-md z-[100] min-w-[280px]",style:{left:tooltipState.position.x,top:tooltipState.position.y,visibility:tooltipState.isPositioned?"visible":"hidden"},children:renderTooltipContent(tooltipState.variantResult,metric)}),document.body),(0,jsx_runtime.jsxs)("tr",{className:"hover:bg-bg-hover group [&:last-child>td]:border-b-0",style:{height:"51px",maxHeight:"51px"},children:[(0,jsx_runtime.jsx)("td",{className:`w-1/5 border-r p-3 align-top text-left relative overflow-hidden ${isLastMetric?"":"border-b"} ${isAlternatingRow?"bg-bg-table":"bg-bg-light"}`,rowSpan:totalRows,style:{height:`${51*totalRows}px`,maxHeight:`${51*totalRows}px`},children:(0,jsx_runtime.jsx)(MetricHeader,{displayOrder:displayOrder,metric:metric,metricType:metricType,isPrimaryMetric:!isSecondary,experiment:experiment,onDuplicateMetricClick:()=>onDuplicateMetric?.()})}),(0,jsx_runtime.jsx)("td",{className:`w-20 pt-1 pl-3 pr-3 pb-1 whitespace-nowrap overflow-hidden ${isAlternatingRow?"bg-bg-table":"bg-bg-light"} ${0===variantResults.length?"border-b":""}`,style:{height:"51px",maxHeight:"51px"},children:(0,jsx_runtime.jsx)(components.Aw,{experimentId:experiment.id,variantKey:baselineResult.key})}),(0,jsx_runtime.jsx)("td",{className:`w-24 pt-1 pl-3 pr-3 pb-1 text-left whitespace-nowrap overflow-hidden ${isAlternatingRow?"bg-bg-table":"bg-bg-light"} ${0===variantResults.length?"border-b":""}`,style:{height:"51px",maxHeight:"51px"},children:(0,jsx_runtime.jsxs)("div",{className:"metric-cell",children:[(0,jsx_runtime.jsx)("div",{children:(0,shared_utils.jP)(baselineResult,metric)}),ratioMetricLabel(baselineResult,metric)]})}),(0,jsx_runtime.jsx)("td",{className:`w-20 pt-1 pl-3 pr-3 pb-1 text-left whitespace-nowrap overflow-hidden ${isAlternatingRow?"bg-bg-table":"bg-bg-light"} ${0===variantResults.length?"border-b":""}`,style:{height:"51px",maxHeight:"51px"},children:(0,jsx_runtime.jsx)("div",{})}),(0,jsx_runtime.jsx)("td",{className:`pt-3 align-top relative overflow-hidden ${isLastMetric?"":"border-b"} ${isAlternatingRow?"bg-bg-table":"bg-bg-light"}`,rowSpan:totalRows,style:{height:`${51*totalRows}px`,maxHeight:`${51*totalRows}px`},children:showDetailsModal&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(DetailsButton,{metric:metric,setIsModalOpen:setIsModalOpen})}),(0,jsx_runtime.jsx)(DetailsModal,{isOpen:isModalOpen,onClose:()=>setIsModalOpen(!1),metric:metric,result:result,experiment:experiment})]})}),(0,jsx_runtime.jsx)("td",{className:`p-0 align-top text-center relative overflow-hidden ${isAlternatingRow?"bg-bg-table":"bg-bg-light"} ${0===variantResults.length?"border-b":""}`,style:{height:"51px",maxHeight:"51px"},children:axisRange&&axisRange>0?(0,jsx_runtime.jsx)("div",{className:"relative h-full",children:(0,jsx_runtime.jsx)("svg",{viewBox:"0 0 800 51",preserveAspectRatio:"none",className:"h-full w-full",children:(0,jsx_runtime.jsx)(GridLines_GridLines,{tickValues:(0,shared_utils.Zj)(axisRange),scale:scale,height:51,viewBoxWidth:800,zeroLineColor:colors.ZERO_LINE,gridLineColor:colors.BOUNDARY_LINES,zeroLineWidth:1.25,gridLineWidth:.75,opacity:.8})})}):(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center h-full text-muted text-xs",children:"â"})})]}),variantResults.map((variant,index)=>{let isLastRow=index===variantResults.length-1,significant=(0,shared_utils.$Y)(variant),deltaPositive=(0,shared_utils.FG)(variant),winning=(0,shared_utils.HB)(variant,metric.goal),deltaText=(0,shared_utils.UT)(variant);return(0,jsx_runtime.jsxs)("tr",{className:"hover:bg-bg-hover group [&:last-child>td]:border-b-0",style:{height:"51px",maxHeight:"51px"},onMouseEnter:e=>handleTooltipMouseEnter(e,variant),onMouseLeave:handleTooltipMouseLeave,onMouseMove:e=>handleTooltipMouseMove(e,variant),children:[(0,jsx_runtime.jsx)("td",{className:`w-20 pt-1 pl-3 pr-3 pb-1 text-left whitespace-nowrap overflow-hidden ${isAlternatingRow?"bg-bg-table":"bg-bg-light"} ${isLastRow?"border-b":""}`,style:{height:"51px",maxHeight:"51px"},children:(0,jsx_runtime.jsx)(components.Aw,{experimentId:experiment.id,variantKey:variant.key})}),(0,jsx_runtime.jsx)("td",{className:`w-24 pt-1 pl-3 pr-3 pb-1 text-left whitespace-nowrap overflow-hidden ${isAlternatingRow?"bg-bg-table":"bg-bg-light"} ${isLastRow?"border-b":""}`,style:{height:"51px",maxHeight:"51px"},children:(0,jsx_runtime.jsxs)("div",{className:"metric-cell",children:[(0,jsx_runtime.jsx)("div",{children:(0,shared_utils.jP)(variant,metric)}),ratioMetricLabel(variant,metric)]})}),(0,jsx_runtime.jsx)("td",{className:`w-20 pt-1 pl-3 pr-3 pb-1 text-left whitespace-nowrap overflow-hidden ${isAlternatingRow?"bg-bg-table":"bg-bg-light"} ${isLastRow?"border-b":""}`,style:{height:"51px",maxHeight:"51px"},children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-1",children:[(0,jsx_runtime.jsx)("span",{className:`${significant?winning?"metric-cell text-success font-bold":"metric-cell text-danger font-bold":"metric-cell"}`,children:deltaText}),significant&&void 0!==deltaPositive&&(0,jsx_runtime.jsx)("span",{className:`flex-shrink-0 ${winning?"text-success":"text-danger"}`,children:deltaPositive?(0,jsx_runtime.jsx)(posthog_icons_es.IconTrending,{className:"w-4 h-4"}):(0,jsx_runtime.jsx)(icons.j4,{className:"w-4 h-4"})})]})}),(0,jsx_runtime.jsx)(ChartCell,{variantResult:variant,metric:metric,axisRange:axisRange,metricUuid:metric.uuid,isAlternatingRow:isAlternatingRow,isLastRow:isLastRow,isSecondary:isSecondary,onTimeseriesClick:timeseriesEnabled?()=>handleTimeseriesClick(variant):void 0})]},`${metric.uuid}-${variant.key}`)}),timeseriesModalState.variantResult&&(0,jsx_runtime.jsx)(TimeseriesModal,{isOpen:timeseriesModalState.isOpen,onClose:()=>{setTimeseriesModalState({isOpen:!1,variantResult:null})},metric:metric,variantResult:timeseriesModalState.variantResult,experiment:experiment})]})}function TickLabels(_ref){let{tickValues,scale,y,viewBoxWidth=800,fontSize=9,fontWeight="600",textColor=COLORS.TICK_TEXT_COLOR,textAnchor="middle",dominantBaseline="middle",edgeThreshold=.06,svgWidth}=_ref,scaleFactor=svgWidth?viewBoxWidth/svgWidth:1;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:tickValues.map(value=>{let x=scale(value),position=x/viewBoxWidth;return position<edgeThreshold||position>1-edgeThreshold?null:(0,jsx_runtime.jsx)("text",{x:x,y:y,textAnchor:textAnchor,dominantBaseline:dominantBaseline,fill:textColor,fontWeight:fontWeight,style:{fontSize:`${fontSize*scaleFactor}px`},children:(0,shared_utils.wo)(value)},`text-${value}`)})})}function TableHeader(_ref){let{axisRange}=_ref,[svgWidth,setSvgWidth]=(0,react.useState)(void 0),tickValues=(0,react.useMemo)(()=>axisRange?(0,shared_utils.Zj)(axisRange):[],[axisRange]),scale=useAxisScale(axisRange||0,800,20),{ticksSvgRef}=useSvgResizeObserver([tickValues,axisRange]);return(0,react.useEffect)(()=>{if(ticksSvgRef.current){let updateWidth=()=>{let rect=ticksSvgRef.current?.getBoundingClientRect();rect&&setSvgWidth(rect.width)};return updateWidth(),window.addEventListener("resize",updateWidth),()=>window.removeEventListener("resize",updateWidth)}},[ticksSvgRef,tickValues,axisRange]),(0,jsx_runtime.jsx)("thead",{children:(0,jsx_runtime.jsxs)("tr",{children:[(0,jsx_runtime.jsx)("th",{className:"w-1/5 border-b-2 bg-bg-table p-3 text-left text-xs sticky top-0 z-10 metric-cell-header",children:"Metric"}),(0,jsx_runtime.jsx)("th",{className:"w-1/15 border-b-2 bg-bg-table p-3 text-left text-xs sticky top-0 z-10 metric-cell-header",children:"Variant"}),(0,jsx_runtime.jsx)("th",{className:"w-1/15 border-b-2 bg-bg-table p-3 text-left text-xs sticky top-0 z-10 metric-cell-header",children:"Value"}),(0,jsx_runtime.jsx)("th",{className:"w-1/15 border-b-2 bg-bg-table p-3 text-left text-xs sticky top-0 z-10 metric-cell-header",children:"Delta"}),(0,jsx_runtime.jsx)("th",{className:"border-b-2 bg-bg-table p-3 z-10"}),(0,jsx_runtime.jsx)("th",{className:"border-b-2 bg-bg-table p-0 z-10",children:axisRange&&axisRange>0?(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("svg",{ref:ticksSvgRef,viewBox:"0 0 800 30",preserveAspectRatio:"xMidYMid meet",className:"w-full",style:{minHeight:"30px"},children:(0,jsx_runtime.jsx)(TickLabels,{tickValues:tickValues,scale:scale,y:16.5,viewBoxWidth:800,fontSize:11,fontWeight:"600",dominantBaseline:"middle",svgWidth:svgWidth})})}):(0,jsx_runtime.jsx)("div",{className:"p-3"})})]})})}function MetricsTable(_ref){let{metrics,results,errors,isSecondary,getInsightType,showDetailsModal=!0}=_ref,{experiment,hasMinimumExposureForResults,exposuresLoading}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{duplicateMetric,updateExperimentMetrics,setExperiment}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),maxAbsValue=Math.max(...results.flatMap(result=>(result?.variant_results||[]).flatMap(variant=>{let interval=(0,shared_utils.nM)(variant);return interval?[Math.abs(interval[0]),Math.abs(interval[1])]:[]}))),axisMargin=Math.max(.05*maxAbsValue,.1),axisRange=maxAbsValue+axisMargin;return 0===metrics.length?(0,jsx_runtime.jsx)("div",{className:"p-8 text-center border rounded-md",children:(0,jsx_runtime.jsxs)("div",{className:"text-muted",children:["No ",isSecondary?"secondary":"primary"," metrics configured"]})}):(0,jsx_runtime.jsx)("div",{className:"w-full overflow-x-auto rounded-md border",children:(0,jsx_runtime.jsxs)("table",{className:"w-full border-collapse text-sm",children:[(0,jsx_runtime.jsxs)("colgroup",{children:[(0,jsx_runtime.jsx)("col",{className:"min-w-[200px]"}),(0,jsx_runtime.jsx)("col",{}),(0,jsx_runtime.jsx)("col",{}),(0,jsx_runtime.jsx)("col",{}),(0,jsx_runtime.jsx)("col",{}),(0,jsx_runtime.jsx)("col",{className:"min-w-[400px]"})]}),(0,jsx_runtime.jsx)(TableHeader,{axisRange:axisRange}),(0,jsx_runtime.jsx)("tbody",{children:metrics.map((metric,index)=>{let result=results[index],error=errors[index],isLoading=!result&&!error&&!!experiment.start_date;return(0,jsx_runtime.jsx)(MetricRowGroup_MetricRowGroup,{metric:metric,result:result,experiment:experiment,metricType:getInsightType(metric),displayOrder:index,axisRange:axisRange,isSecondary:isSecondary,isLastMetric:index===metrics.length-1,isAlternatingRow:index%2==1,onDuplicateMetric:()=>{if(!metric.uuid||!experiment)return;let newUuid=crypto.randomUUID();duplicateMetric({uuid:metric.uuid,isSecondary,newUuid});let newOrderingArray=(0,experiments_utils.Pd)(experiment,newUuid,metric.uuid,isSecondary);setExperiment({[isSecondary?"secondary_metrics_ordered_uuids":"primary_metrics_ordered_uuids"]:newOrderingArray}),updateExperimentMetrics()},error:error,isLoading:isLoading,hasMinimumExposureForResults:hasMinimumExposureForResults,exposuresLoading:exposuresLoading,showDetailsModal:showDetailsModal},metric.uuid||index)})})]})})}function Metrics(_ref){let{isSecondary}=_ref,{experiment,getInsightType,getOrderedMetrics,primaryMetricsResults,secondaryMetricsResults,secondaryMetricsResultsErrors,primaryMetricsResultsErrors,hasMinimumExposureForResults}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{openPrimaryMetricsReorderModal,openSecondaryMetricsReorderModal}=(0,index_esm.useActions)(modalsLogic.l);if(!experiment?.feature_flag?.filters?.multivariate?.variants)return null;let unorderedResults=isSecondary?secondaryMetricsResults:primaryMetricsResults,unorderedErrors=isSecondary?secondaryMetricsResultsErrors:primaryMetricsResultsErrors,metrics=getOrderedMetrics(!!isSecondary),resultsMap=new Map,errorsMap=new Map;[...isSecondary?experiment.metrics_secondary:experiment.metrics,...(experiment.saved_metrics||[]).filter(sharedMetric=>sharedMetric.metadata.type===(isSecondary?"secondary":"primary")).map(sharedMetric=>sharedMetric.query)].forEach((metric,index)=>{let uuid=metric.uuid||metric.query?.uuid;uuid&&(resultsMap.set(uuid,unorderedResults[index]),errorsMap.set(uuid,unorderedErrors[index]))});let results=metrics.map(metric=>resultsMap.get(metric.uuid)),errors=metrics.map(metric=>errorsMap.get(metric.uuid)),showResultDetails=1===metrics.length&&results[0]&&hasMinimumExposureForResults&&!isSecondary,hasSomeResults=results?.some(result=>result?.variant_results&&result.variant_results.length>0)&&hasMinimumExposureForResults;return(0,jsx_runtime.jsxs)("div",{className:"mb-4 -mt-2",children:[experiment?.id&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(MetricsReorderModal,{isSecondary:!1}),(0,jsx_runtime.jsx)(MetricsReorderModal,{isSecondary:!0})]}),(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/2 pt-5",children:(0,jsx_runtime.jsxs)("div",{className:"inline-flex items-center deprecated-space-x-2 mb-0",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-0 font-semibold text-lg leading-6",children:isSecondary?"Secondary metrics":"Primary metrics"}),metrics.length>0&&(0,jsx_runtime.jsx)(src.u,{title:isSecondary?"Secondary metrics capture additional outcomes or behaviors affected by your experiment. They help you understand broader impacts and potential side effects beyond the primary goal.":"Primary metrics represent the main goal of your experiment. They directly measure whether your hypothesis was successful and are the key factor in deciding if the test achieved its primary objective.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-lg"})}),hasSomeResults&&!isSecondary&&(0,jsx_runtime.jsx)(HowToReadTooltip,{})]})}),(0,jsx_runtime.jsx)("div",{className:"w-1/2 flex flex-col justify-end",children:(0,jsx_runtime.jsx)("div",{className:"ml-auto",children:metrics.length>0&&(0,jsx_runtime.jsxs)("div",{className:"mb-2 mt-4 justify-end flex gap-2",children:[(0,jsx_runtime.jsx)(AddMetricButton,{metricContext:isSecondary?METRIC_CONTEXTS.secondary:METRIC_CONTEXTS.primary}),metrics.length>1&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"xsmall",onClick:()=>isSecondary?openSecondaryMetricsReorderModal():openPrimaryMetricsReorderModal(),icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconList,{}),tooltip:"Reorder metrics"})]})})})]}),metrics.length>0?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(MetricsTable,{metrics:metrics,results:results,errors:errors,isSecondary:!!isSecondary,getInsightType:getInsightType,showDetailsModal:!showResultDetails}),showResultDetails&&(0,jsx_runtime.jsx)("div",{className:"mt-4",children:(0,jsx_runtime.jsx)(ResultDetails,{metric:metrics[0],result:{...results[0],metric:metrics[0]},experiment:experiment})})]}):(0,jsx_runtime.jsx)("div",{className:"border rounded bg-surface-primary pt-6 pb-8 text-secondary mt-2",children:(0,jsx_runtime.jsxs)("div",{className:"flex flex-col items-center mx-auto deprecated-space-y-3",children:[(0,jsx_runtime.jsx)(icons.Ii,{fontSize:"30"}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-center text-balance max-w-sm",children:(0,jsx_runtime.jsx)("p",{children:isSecondary?"Secondary metrics provide additional context and help detect unintended side effects.":"Primary metrics represent the main goal of the experiment and directly measure if your hypothesis was successful."})}),(0,jsx_runtime.jsx)(AddMetricButton,{metricContext:isSecondary?METRIC_CONTEXTS.secondary:METRIC_CONTEXTS.primary})]})})]})}let RunningTimeCalculatorModalStep=_ref=>{let{children,stepNumber,title,description}=_ref;return(0,jsx_runtime.jsx)("div",{className:"space-y-6",children:(0,jsx_runtime.jsxs)("div",{className:"rounded bg-light p-4 space-y-3",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("span",{className:"rounded-full bg-muted text-white w-6 h-6 flex items-center justify-center font-semibold",children:stepNumber}),(0,jsx_runtime.jsx)("h4",{className:"font-semibold m-0",children:title})]}),(0,jsx_runtime.jsx)("p",{className:"text-muted",children:description}),(0,jsx_runtime.jsx)("div",{className:"space-y-2",children:children})]})})},exposureEstimateConfigToFilter=_ref=>{let{eventFilter}=_ref;return eventFilter?{actions:eventFilter.entityType===TaxonomicFilter_types.t.Actions?[{id:eventFilter.event?Number(eventFilter.event):0,kind:schema_general.OH.ActionsNode,type:"actions",name:eventFilter.name||"",properties:eventFilter.properties||[]}]:[],events:eventFilter.entityType===TaxonomicFilter_types.t.Events?[{id:eventFilter.event||"$pageview",kind:schema_general.OH.EventsNode,type:"events",name:eventFilter.name||"$pageview",properties:eventFilter.properties||[]}]:[]}:{events:[],actions:[]}},EventSelectorStep=_ref2=>{let{exposureEstimateConfig,onSetFilter}=_ref2,filter=exposureEstimateConfig?exposureEstimateConfigToFilter(exposureEstimateConfig):{events:[{id:"$pageview",kind:schema_general.OH.EventsNode,type:"events",name:"$pageview",properties:[]}]};return(0,jsx_runtime.jsx)(RunningTimeCalculatorModalStep,{stepNumber:1,title:"Estimate experiment traffic",description:"Choose an event to estimate the number of users who will be exposed to your experiment. We'll use data from the last 14 days to calculate the minimum sample size and estimated duration for your experiment.",children:(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,hideRename:!0,typeKey:"running-time-calculator",filters:filter,actionsTaxonomicGroupTypes:[TaxonomicFilter_types.t.Events,TaxonomicFilter_types.t.Actions],entitiesLimit:1,mathAvailability:ActionFilterRow.Qq.None,setFilters:_ref3=>{let{events,actions}=_ref3,eventFilter=events?.[0]||actions?.[0];eventFilter&&onSetFilter(eventFilter)}})})};var LemonInput=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonInput/index.ts"),LemonSegmentedButton=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSegmentedButton/index.ts"),fast_deep_equal=__webpack_require__("../../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"),fast_deep_equal_default=__webpack_require__.n(fast_deep_equal);let calculateVariance=(metric,averageEventsPerUser,averagePropertyValuePerUser)=>metric?(0,schema_general.Gt)(metric)&&metric.source.math===types.xu.TotalCount?2*averageEventsPerUser:(0,schema_general.Gt)(metric)&&metric.source.math===types.xu.Sum?.25*averagePropertyValuePerUser**2:null:null,calculateRecommendedSampleSize=(metric,minimumDetectableEffect,variance,averageEventsPerUser,averagePropertyValuePerUser,automaticConversionRateDecimal,manualConversionRate,conversionRateInputType,numberOfVariants)=>{let d,sampleSizeFormula;if(!metric)return null;let minimumDetectableEffectDecimal=minimumDetectableEffect/100;if((0,schema_general.Gt)(metric)&&metric.source.math===types.xu.TotalCount)sampleSizeFormula=16*variance/(d=minimumDetectableEffectDecimal*averageEventsPerUser)**2;else if((0,schema_general.Gt)(metric)&&metric.source.math===types.xu.Sum)sampleSizeFormula=16*variance/(d=minimumDetectableEffectDecimal*averagePropertyValuePerUser)**2;else if((0,schema_general.N4)(metric)){let conversionRate=conversionRateInputType===ConversionRateInputType.MANUAL?manualConversionRate/100:automaticConversionRateDecimal;if(d=minimumDetectableEffectDecimal*conversionRate,null===conversionRate)return null;sampleSizeFormula=16*conversionRate*(1-conversionRate)/d**2}return d&&sampleSizeFormula?sampleSizeFormula*numberOfVariants:null},ConversionRateInputType=function(ConversionRateInputType){return ConversionRateInputType.MANUAL="manual",ConversionRateInputType.AUTOMATIC="automatic",ConversionRateInputType}({}),defaultExposureEstimateConfig={eventFilter:{event:"$pageview",name:"$pageview",properties:[],entityType:TaxonomicFilter_types.t.Events},metric:null,conversionRateInputType:ConversionRateInputType.AUTOMATIC,manualConversionRate:2,uniqueUsers:null},runningTimeCalculatorLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","experiments","RunningTimeCalculator","runningTimeCalculatorLogic"]),(0,index_esm.connect)(_ref=>{let{experimentId}=_ref;return{values:[(0,experiments_experimentLogic.Wl)({experimentId}),["experiment"]]}}),(0,index_esm.actions)({setMetricIndex:value=>({value}),setMetricUuid:value=>({value}),setMetricResult:value=>({value}),setConversionRateInputType:value=>({value}),setManualConversionRate:value=>({value}),setExposureEstimateConfig:value=>({value}),setMinimumDetectableEffect:value=>({value})}),(0,index_esm.reducers)({_exposureEstimateConfig:[null,{setExposureEstimateConfig:(_,_ref2)=>{let{value}=_ref2;return value}}],_metricUuid:[null,{setMetricUuid:(_,_ref3)=>{let{value}=_ref3;return value}}],_conversionRateInputType:[ConversionRateInputType.AUTOMATIC,{setConversionRateInputType:(_,_ref4)=>{let{value}=_ref4;return value}}],_manualConversionRate:[2,{setManualConversionRate:(_,_ref5)=>{let{value}=_ref5;return value}}],_minimumDetectableEffect:[null,{setMinimumDetectableEffect:(_,_ref6)=>{let{value}=_ref6;return value}}]}),(0,kea_loaders_lib.loaders)(_ref7=>{let{values}=_ref7;return{metricResult:{loadMetricResult:async()=>{var _values$exposureEstim,_result$results$0$cou,_result$results$1$cou,_result$results$1$cou2,_result$results$0$cou2;if(null===values.metricUuid)return null;let metric=values.metric;if(!metric)return null;let eventFilter=null!==(_values$exposureEstim=values.exposureEstimateConfig?.eventFilter)&&void 0!==_values$exposureEstim?_values$exposureEstim:{event:"$pageview",name:"$pageview",properties:[],entityType:TaxonomicFilter_types.t.Events},exposureEventNode=(0,metricQueryUtils.s6)(eventFilter,{mathProps:{math:types.vN.UniqueUsers}}),query=(0,metricQueryUtils.qC)((0,metricQueryUtils.pm)({filterTestAccounts:!!values.experiment.exposure_criteria?.filterTestAccounts,dateRange:(0,metricQueryUtils.e6)(),funnelsFilter:{funnelVizType:types.Ui.Steps},trendsFilter:{}}),(0,metricQueryUtils.Te)(exposureEventNode))(metric);if(!query)return null;let result=await (0,queries_query.jr)(query,void 0,"force_blocking");if((0,schema_general.Gt)(metric))return{uniqueUsers:null!==(_result$results$0$cou=result?.results?.[0]?.count)&&void 0!==_result$results$0$cou?_result$results$0$cou:null,...metric.source.math===types.xu.TotalCount?{averageEventsPerUser:null!==(_result$results$1$cou=result?.results?.[1]?.count)&&void 0!==_result$results$1$cou?_result$results$1$cou:null}:{},...metric.source.math===types.xu.Sum?{averagePropertyValuePerUser:null!==(_result$results$1$cou2=result?.results?.[1]?.count)&&void 0!==_result$results$1$cou2?_result$results$1$cou2:null}:{}};if((0,schema_general.N4)(metric)){let firstStepCount=result?.results?.[0]?.count,automaticConversionRateDecimal=firstStepCount&&firstStepCount>0?(result?.results?.at(-1)?.count||0)/firstStepCount:null;return{uniqueUsers:null!==(_result$results$0$cou2=result?.results?.[0]?.count)&&void 0!==_result$results$0$cou2?_result$results$0$cou2:null,automaticConversionRateDecimal:automaticConversionRateDecimal}}return{}},setMetricResult:_ref8=>{let{value}=_ref8;return value}}}}),(0,index_esm.listeners)(_ref9=>{let{actions,values}=_ref9;return{setMetricIndex:_ref10=>{let{value:metricIndex}=_ref10,metric=values.experiment?.metrics?.[metricIndex];metric?.uuid&&actions.setMetricUuid(metric.uuid)},setMetricUuid:()=>{if(values.metric){var _values$exposureEstim2;actions.setExposureEstimateConfig({...null!==(_values$exposureEstim2=values.exposureEstimateConfig)&&void 0!==_values$exposureEstim2?_values$exposureEstim2:defaultExposureEstimateConfig,metric:values.metric})}actions.loadMetricResult()},setManualConversionRate:()=>{var _values$exposureEstim3;actions.setExposureEstimateConfig({...null!==(_values$exposureEstim3=values.exposureEstimateConfig)&&void 0!==_values$exposureEstim3?_values$exposureEstim3:{eventFilter:null,metric:null,conversionRateInputType:ConversionRateInputType.MANUAL,uniqueUsers:null},manualConversionRate:values._manualConversionRate})},loadMetricResultSuccess:()=>{let uniqueUsers=values.metricResult?.uniqueUsers;if(uniqueUsers!==values.exposureEstimateConfig?.uniqueUsers){var _values$exposureEstim4;actions.setExposureEstimateConfig({...null!==(_values$exposureEstim4=values.exposureEstimateConfig)&&void 0!==_values$exposureEstim4?_values$exposureEstim4:{eventFilter:null,metric:null,conversionRateInputType:ConversionRateInputType.AUTOMATIC,manualConversionRate:null},uniqueUsers})}}}}),(0,index_esm.afterMount)(_ref11=>{let{actions,values}=_ref11;values.metric&&!values.metricResult&&null!==values.metricUuid&&actions.loadMetricResult()}),(0,index_esm.selectors)({defaultMetricUuid:[s=>[s.experiment,s.exposureEstimateConfig],(experiment,exposureEstimateConfig)=>{if(!experiment?.metrics||!exposureEstimateConfig?.metric)return null;let regularMetric=experiment.metrics.find(m=>fast_deep_equal_default()(m,exposureEstimateConfig.metric));if(regularMetric?.uuid)return regularMetric.uuid;let sharedMetric=experiment.saved_metrics.filter(m=>"primary"===m.metadata.type).find(m=>fast_deep_equal_default()(m.query,exposureEstimateConfig.metric));return sharedMetric?.query?.uuid||null}],metricUuid:[s=>[s._metricUuid,s.defaultMetricUuid],(metricUuid,defaultMetricUuid)=>null!=metricUuid?metricUuid:defaultMetricUuid],exposureEstimateConfig:[s=>[s._exposureEstimateConfig,s.experiment],(localExposureEstimateConfig,experiment)=>localExposureEstimateConfig||(experiment.parameters.exposure_estimate_config?{...defaultExposureEstimateConfig,...experiment.parameters.exposure_estimate_config}:defaultExposureEstimateConfig)],conversionRateInputType:[s=>[s._conversionRateInputType,s.exposureEstimateConfig],(conversionRateInputType,exposureEstimateConfig)=>conversionRateInputType?exposureEstimateConfig?exposureEstimateConfig.conversionRateInputType:ConversionRateInputType.AUTOMATIC:conversionRateInputType],manualConversionRate:[s=>[s._manualConversionRate,s.exposureEstimateConfig],(manualConversionRate,exposureEstimateConfig)=>exposureEstimateConfig?.conversionRateInputType===ConversionRateInputType.MANUAL?exposureEstimateConfig.manualConversionRate:manualConversionRate],minimumDetectableEffect:[s=>[s._minimumDetectableEffect,s.experiment],(minimumDetectableEffect,experiment)=>{var _ref12;return null!==(_ref12=null!=minimumDetectableEffect?minimumDetectableEffect:experiment?.parameters?.minimum_detectable_effect)&&void 0!==_ref12?_ref12:experiments_experimentLogic.zi}],metric:[s=>[s.metricUuid,s.experiment],(metricUuid,experiment)=>{if(null===metricUuid)return null;let regularMetric=experiment.metrics.find(m=>m.uuid===metricUuid);if(regularMetric)return regularMetric;let sharedMetric=experiment.saved_metrics.filter(m=>"primary"===m.metadata.type).find(m=>m.query?.uuid===metricUuid);return sharedMetric?.query}],uniqueUsers:[s=>[s.metricResult,s.exposureEstimateConfig],(metricResult,exposureEstimateConfig)=>{var _exposureEstimateConf;return metricResult&&null!==metricResult.uniqueUsers?metricResult.uniqueUsers:null!==(_exposureEstimateConf=exposureEstimateConfig?.uniqueUsers)&&void 0!==_exposureEstimateConf?_exposureEstimateConf:null}],averageEventsPerUser:[s=>[s.metricResult],metricResult=>{var _metricResult$average;return null!==(_metricResult$average=metricResult?.averageEventsPerUser)&&void 0!==_metricResult$average?_metricResult$average:null}],averagePropertyValuePerUser:[s=>[s.metricResult],metricResult=>{var _metricResult$average2;return null!==(_metricResult$average2=metricResult?.averagePropertyValuePerUser)&&void 0!==_metricResult$average2?_metricResult$average2:null}],automaticConversionRateDecimal:[s=>[s.metricResult],metricResult=>{var _metricResult$automat;return null!==(_metricResult$automat=metricResult?.automaticConversionRateDecimal)&&void 0!==_metricResult$automat?_metricResult$automat:null}],variance:[s=>[s.metric,s.averageEventsPerUser,s.averagePropertyValuePerUser],(metric,averageEventsPerUser,averagePropertyValuePerUser)=>calculateVariance(metric,averageEventsPerUser,averagePropertyValuePerUser)],standardDeviation:[s=>[s.variance],variance=>variance?Math.sqrt(variance):null],numberOfVariants:[s=>[s.experiment],experiment=>experiment.feature_flag?.filters.multivariate?.variants.length],recommendedSampleSize:[s=>[s.metric,s.minimumDetectableEffect,s.variance,s.averageEventsPerUser,s.averagePropertyValuePerUser,s.automaticConversionRateDecimal,s.manualConversionRate,s.conversionRateInputType,s.numberOfVariants],(metric,minimumDetectableEffect,variance,averageEventsPerUser,averagePropertyValuePerUser,automaticConversionRateDecimal,manualConversionRate,conversionRateInputType,numberOfVariants)=>calculateRecommendedSampleSize(metric,minimumDetectableEffect,variance,averageEventsPerUser,averagePropertyValuePerUser,automaticConversionRateDecimal,manualConversionRate,conversionRateInputType,numberOfVariants)],recommendedRunningTime:[s=>[s.recommendedSampleSize,s.uniqueUsers],(recommendedSampleSize,uniqueUsers)=>recommendedSampleSize/(uniqueUsers/14)]})]),UniqueUsersPanel=_ref=>{let{uniqueUsers}=_ref;return uniqueUsers?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Unique users"}),(0,jsx_runtime.jsxs)("div",{className:"font-semibold",children:["~",(0,utils.Lc)(uniqueUsers,0)," persons"]}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-muted",children:["Last ",14," days"]})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})},AverageEventsPerUserPanel=_ref2=>{let{averageEventsPerUser}=_ref2;return averageEventsPerUser?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Avg. events per user"}),(0,jsx_runtime.jsxs)("div",{className:"font-semibold",children:["~",(0,utils.Lc)(averageEventsPerUser,0)]})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})},AveragePropertyValuePerUserPanel=_ref3=>{let{averagePropertyValuePerUser}=_ref3;return averagePropertyValuePerUser?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Avg. property value per user"}),(0,jsx_runtime.jsxs)("div",{className:"font-semibold",children:["~",(0,utils.Lc)(averagePropertyValuePerUser,0)]})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})},StandardDeviationPanel=_ref4=>{let{standardDeviation}=_ref4;return standardDeviation?(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"card-secondary",children:[(0,jsx_runtime.jsx)("span",{children:"Est. standard deviation"}),(0,jsx_runtime.jsx)(src.u,{className:"ml-1",title:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:'The estimated standard deviation of the metric in the last 14 days. It\'s the "human-readable" version of the amount of dispersion in the dataset, and is calculated as the square root of the variance. The variance informs the recommended sample size.'}),children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary ml-1"})})]}),(0,jsx_runtime.jsxs)("div",{className:"font-semibold",children:["~",(0,utils.Lc)(standardDeviation,0)]})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{})},FunnelMetricDataPanel=_ref=>{let{onChangeType}=_ref,{experimentId}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{conversionRateInputType,uniqueUsers,automaticConversionRateDecimal,manualConversionRate}=(0,index_esm.useValues)(runningTimeCalculatorLogic({experimentId})),{setConversionRateInputType,setManualConversionRate}=(0,index_esm.useActions)(runningTimeCalculatorLogic({experimentId}));return(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,jsx_runtime.jsx)(UniqueUsersPanel,{uniqueUsers:null!=uniqueUsers?uniqueUsers:0}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"card-secondary",children:[(0,jsx_runtime.jsx)("span",{children:"Conversion rate input"}),(0,jsx_runtime.jsx)(Tooltip.u,{className:"ml-1",title:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("strong",{children:"Automatic:"})," Uses historical conversion rate between your exposure event and the conversion event. It may not always be representative of expected performance.",(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"Manual:"})," Allows you to set a custom conversion rate based on your own knowledge of the funnel."]}),children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary ml-1"})})]}),(0,jsx_runtime.jsx)(LemonSegmentedButton.P,{className:"mt-2",size:"small",options:[{label:"Manual",value:ConversionRateInputType.MANUAL},{label:"Automatic",value:ConversionRateInputType.AUTOMATIC}],onChange:value=>{setConversionRateInputType(value),onChangeType(value)},value:conversionRateInputType}),conversionRateInputType===ConversionRateInputType.MANUAL&&(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(LemonInput.D,{className:"w-[80px] mt-2",min:0,step:1,max:100,type:"number",value:manualConversionRate||void 0,onChange:newValue=>{null!=newValue&&newValue>=0&&setManualConversionRate(newValue)}}),(0,jsx_runtime.jsx)("div",{children:"%"})]}),conversionRateInputType===ConversionRateInputType.AUTOMATIC&&(0,jsx_runtime.jsxs)("div",{className:"font-semibold mt-2",children:["~",(0,utils.Lc)(100*automaticConversionRateDecimal,2),"%"]})]})]})})},MeanMetricDataPanel=()=>{let{experimentId}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{uniqueUsers,averageEventsPerUser,averagePropertyValuePerUser,standardDeviation}=(0,index_esm.useValues)(runningTimeCalculatorLogic({experimentId}));return(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,jsx_runtime.jsx)(UniqueUsersPanel,{uniqueUsers:null!=uniqueUsers?uniqueUsers:0}),(0,jsx_runtime.jsx)(AverageEventsPerUserPanel,{averageEventsPerUser:averageEventsPerUser}),(0,jsx_runtime.jsx)(AveragePropertyValuePerUserPanel,{averagePropertyValuePerUser:averagePropertyValuePerUser}),(0,jsx_runtime.jsx)(StandardDeviationPanel,{standardDeviation:standardDeviation})]})},MetricSelectorStep=_ref=>{let{onChangeMetric,onChangeFunnelConversionRateType}=_ref,{experimentId}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{experiment,metric,metricUuid,metricResultLoading}=(0,index_esm.useValues)(runningTimeCalculatorLogic({experimentId})),{setMetricUuid}=(0,index_esm.useActions)(runningTimeCalculatorLogic({experimentId})),metricOptions=[...experiment.metrics.filter(metric=>metric.uuid).map(metric=>({metric:metric,uuid:metric.uuid,isSharedMetric:!1,name:void 0})),...experiment.saved_metrics.filter(sharedMetric=>"primary"===sharedMetric.metadata.type).map(sharedMetric=>sharedMetric.query&&sharedMetric.query.uuid&&(sharedMetric.query.kind===schema_general.OH.ExperimentMetric||void 0!==sharedMetric.query.metric_type)?{metric:sharedMetric.query,uuid:sharedMetric.query.uuid,isSharedMetric:!0,name:sharedMetric.name}:null).filter(option=>null!==option)];return(0,jsx_runtime.jsxs)(RunningTimeCalculatorModalStep,{stepNumber:2,title:"Select a metric",description:"Choose a metric to analyze. We'll use historical data from this metric to estimate the experiment duration.",children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary mb-2",children:"Experiment metric"}),(0,jsx_runtime.jsx)(src.Yv,{options:metricOptions.map((option,index)=>({label:(0,jsx_runtime.jsxs)("div",{className:"cursor-default text-xs font-semibold whitespace-nowrap overflow-hidden text-ellipsis flex-grow flex items-center",children:[(0,jsx_runtime.jsxs)("span",{className:"mr-1",children:[index+1,"."]}),option.name?(0,jsx_runtime.jsx)("span",{className:"max-w-56 truncate",children:option.name}):(0,jsx_runtime.jsx)(MetricTitle,{metric:option.metric}),option.isSharedMetric&&(0,jsx_runtime.jsx)("span",{className:"ml-1",children:(0,jsx_runtime.jsx)(src.oe,{children:"Shared"})})]}),value:option.uuid})),value:metricUuid,onChange:value=>{if(null!==value){setMetricUuid(value);let selectedOption=metricOptions.find(option=>option.uuid===value);selectedOption&&onChangeMetric(selectedOption.metric)}}})]}),metricResultLoading?(0,jsx_runtime.jsx)("div",{className:"border-t pt-2",children:(0,jsx_runtime.jsx)("div",{className:"h-[100px] flex items-center justify-center",children:(0,jsx_runtime.jsx)(src.$j,{className:"text-3xl transform -translate-y-[-10px]"})})}):(0,jsx_runtime.jsxs)("div",{className:"border-t pt-2",children:[metric&&(0,schema_general.Gt)(metric)&&(0,jsx_runtime.jsx)(MeanMetricDataPanel,{}),metric&&(0,schema_general.N4)(metric)&&(0,jsx_runtime.jsx)(FunnelMetricDataPanel,{onChangeType:onChangeFunnelConversionRateType})]})]})},RunningTimeCalculatorModalFooter=_ref=>{let{onClose,onSave,disabled=!1}=_ref;return(0,jsx_runtime.jsx)("div",{className:"flex items-center w-full",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 ml-auto",children:[(0,jsx_runtime.jsx)(LemonButton.J,{form:"edit-experiment-metric-form",type:"secondary",onClick:onClose,children:"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{form:"edit-experiment-metric-form",onClick:onSave,type:"primary",disabledReason:disabled?"Calculation required before saving":void 0,children:"Save"})]})})};function RunningTimeCalculatorModal(){let{experimentId}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{isCalculateRunningTimeModalOpen}=(0,index_esm.useValues)(modalsLogic.l),{experiment,minimumDetectableEffect,recommendedSampleSize,recommendedRunningTime,exposureEstimateConfig,metricResultLoading,uniqueUsers}=(0,index_esm.useValues)(runningTimeCalculatorLogic({experimentId})),{updateExperiment}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{setMinimumDetectableEffect,setExposureEstimateConfig}=(0,index_esm.useActions)(runningTimeCalculatorLogic({experimentId})),{closeCalculateRunningTimeModal}=(0,index_esm.useActions)(modalsLogic.l);return(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isCalculateRunningTimeModalOpen,onClose:closeCalculateRunningTimeModal,width:700,title:"Calculate estimated running time",footer:(0,jsx_runtime.jsx)(RunningTimeCalculatorModalFooter,{onClose:closeCalculateRunningTimeModal,onSave:()=>{updateExperiment({parameters:{...experiment?.parameters,exposure_estimate_config:exposureEstimateConfig,recommended_running_time:recommendedRunningTime,recommended_sample_size:recommendedSampleSize||void 0,minimum_detectable_effect:minimumDetectableEffect||void 0}}),closeCalculateRunningTimeModal()},disabled:!recommendedRunningTime||metricResultLoading}),children:[(0,jsx_runtime.jsx)(EventSelectorStep,{exposureEstimateConfig:exposureEstimateConfig,onSetFilter:filter=>setExposureEstimateConfig({...null!=exposureEstimateConfig?exposureEstimateConfig:{metric:null,conversionRateInputType:ConversionRateInputType.AUTOMATIC,manualConversionRate:null,uniqueUsers:null},eventFilter:{event:filter.id,name:filter.name,properties:filter.properties,entityType:"events"===filter.type?TaxonomicFilter_types.t.Events:TaxonomicFilter_types.t.Actions}})}),exposureEstimateConfig&&(0,jsx_runtime.jsx)(MetricSelectorStep,{onChangeMetric:metric=>setExposureEstimateConfig({...exposureEstimateConfig,metric}),onChangeFunnelConversionRateType:type=>setExposureEstimateConfig({...exposureEstimateConfig,conversionRateInputType:type})}),(0,jsx_runtime.jsx)("div",{className:"deprecated-space-y-6",children:!metricResultLoading&&null!==uniqueUsers&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(RunningTimeCalculatorModalStep,{stepNumber:3,title:"Choose minimum detectable effect",description:"The minimum detectable effect (MDE) is the smallest relative improvement you want to be able to detect with statistical significance. A smaller MDE requires more participants but can detect subtler changes.",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.DF,{className:"w-[80px]",min:0,step:1,type:"number",value:minimumDetectableEffect,onChange:newValue=>{newValue&&setMinimumDetectableEffect(newValue)}}),(0,jsx_runtime.jsx)("div",{children:"%"})]})}),null!==recommendedSampleSize&&null!==recommendedRunningTime&&(0,jsx_runtime.jsx)(RunningTimeCalculatorModalStep,{stepNumber:4,title:"Estimated experiment size & duration",description:"These are just statistical estimates â you can conclude the experiment earlier if a significant effect is detected. Running shorter may make results less reliable.",children:(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-2 gap-4 pt-2",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Recommended sample size"}),(0,jsx_runtime.jsxs)("div",{className:"text-lg font-semibold",children:["~",(0,utils.Lc)(recommendedSampleSize,0)," users"]})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Estimated running time"}),(0,jsx_runtime.jsxs)("div",{className:"text-lg font-semibold",children:["~",(0,utils.Lc)(recommendedRunningTime,1)," days"]})]})]})})]})})]})}var index_module=__webpack_require__("../../node_modules/.pnpm/use-debounce@9.0.3_react@18.2.0/node_modules/use-debounce/dist/index.module.js"),Hogfetti=__webpack_require__("../../frontend/src/lib/components/Hogfetti/Hogfetti.tsx"),LemonCollapse=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonCollapse/index.ts"),lemon_ui_LemonTextArea=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonTextArea/index.ts");function ExposureCriteriaPanel(_ref){let{experiment,onChange}=_ref,[selectedExposureType,setSelectedExposureType]=(0,react.useState)("default"),{currentTeam}=(0,index_esm.useValues)(teamLogic.teamLogic),hasFilters=(currentTeam?.test_account_filters||[]).length>0;return(0,jsx_runtime.jsxs)("div",{className:"space-y-4",children:[(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted",children:"Configure when users are considered exposed to the experiment and included in the analysis."}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsx)(SelectableCard.u,{title:"Default",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["When a ",(0,jsx_runtime.jsx)(src.oe,{children:"$feature_flag_called"})," event is recorded, a user is considered"," ",(0,jsx_runtime.jsx)("strong",{children:"exposed"})," to the experiment."]}),selected:"default"===selectedExposureType,onClick:()=>{setSelectedExposureType("default"),onChange({exposure_config:void 0})}}),(0,jsx_runtime.jsx)(SelectableCard.u,{title:"Custom",description:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Select a custom event to signal that users reached the part of your app where the experiment runs. You can also filter out users you would like to exclude."}),selected:"custom"===selectedExposureType,onClick:()=>{setSelectedExposureType("custom"),onChange({exposure_config:{kind:schema_general.OH.ExperimentEventExposureConfig,event:"$feature_flag_called",properties:[]}})}})]}),"custom"===selectedExposureType&&(0,jsx_runtime.jsx)("div",{className:"mb-4",children:(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,experiments_utils.m3)(experiment.exposure_criteria?.exposure_config||{kind:schema_general.OH.ExperimentEventExposureConfig,event:"$feature_flag_called",properties:[]}),setFilters:_ref2=>{let{events}=_ref2,entity=events?.[0];entity&&onChange({exposure_config:(0,experiments_utils.ZE)(entity)})},typeKey:"experiment-exposure-config",buttonCopy:"Add exposure event",showSeriesIndicator:!1,hideRename:!0,entitiesLimit:1,mathAvailability:ActionFilterRow.Qq.None,showNumericalPropsOnly:!1,actionsTaxonomicGroupTypes:[TaxonomicFilter_types.t.Events],propertiesTaxonomicGroupTypes:Selectors.dF.propertiesTaxonomicGroupTypes})}),(0,jsx_runtime.jsxs)("div",{className:"max-w-120",children:[(0,jsx_runtime.jsx)("label",{className:"block text-sm font-medium text-default mb-2",children:"Multiple variant handling"}),(0,jsx_runtime.jsx)(src.Yv,{value:experiment.exposure_criteria?.multiple_variant_handling||"exclude",onChange:value=>{onChange({multiple_variant_handling:value})},options:[{value:"exclude",label:"Exclude from analysis","data-attr":"multiple-handling-exclude"},{value:"first_seen",label:"Use first seen variant","data-attr":"multiple-handling-first-seen"}],placeholder:"Select handling method",fullWidth:!0}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-muted mt-1",children:[experiment.exposure_criteria?.multiple_variant_handling==="first_seen"&&"Users exposed to multiple variants will be analyzed using their first seen variant.",(!experiment.exposure_criteria?.multiple_variant_handling||experiment.exposure_criteria?.multiple_variant_handling==="exclude")&&"Users exposed to multiple variants will be excluded from the analysis (recommended)."]})]}),(0,jsx_runtime.jsx)("div",{className:"max-w-120",children:(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=experiment.exposure_criteria?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{onChange({filterTestAccounts:checked})},fullWidth:!0})})]})}var featureFlagsLogic=__webpack_require__("../../frontend/src/scenes/feature-flags/featureFlagsLogic.ts");let DEFAULT_FILTERS={active:void 0,created_by_id:void 0,search:void 0,order:void 0,page:1,evaluation_runtime:void 0},selectExistingFeatureFlagModalLogic=(0,index_esm.kea)([(0,index_esm.path)(["scenes","experiments","create","selectExistingFeatureFlagModalLogic"]),(0,index_esm.actions)({openSelectExistingFeatureFlagModal:!0,closeSelectExistingFeatureFlagModal:!0,setFilters:(filters,replace)=>({filters,replace}),resetFilters:!0}),(0,index_esm.reducers)({isModalOpen:[!1,{openSelectExistingFeatureFlagModal:()=>!0,closeSelectExistingFeatureFlagModal:()=>!1}],filters:[DEFAULT_FILTERS,{setFilters:(state,_ref)=>{let{filters,replace}=_ref;return replace?{...DEFAULT_FILTERS,...filters}:{...state,...filters}},resetFilters:()=>DEFAULT_FILTERS}]}),(0,index_esm.listeners)(_ref2=>{let{actions}=_ref2;return{setFilters:async(_,breakpoint)=>{await breakpoint(300),actions.loadFeatureFlags()},resetFilters:()=>{actions.loadFeatureFlags()},openSelectExistingFeatureFlagModal:()=>{actions.loadFeatureFlags()}}}),(0,kea_loaders_lib.loaders)(_ref3=>{let{values}=_ref3;return{featureFlags:[{results:[],count:0},{loadFeatureFlags:async()=>{let url=`api/projects/@current/experiments/eligible_feature_flags/?${(0,utils.oZ)({...values.paramsFromFilters})}`;return await api.ZP.get(url)}}]}}),(0,index_esm.selectors)({paramsFromFilters:[s=>[s.filters],filters=>({...filters,limit:featureFlagsLogic.ac,offset:filters.page?(filters.page-1)*featureFlagsLogic.ac:0})],pagination:[s=>[s.filters,s.featureFlags],(filters,featureFlags)=>{let currentPage=filters.page||1,hasNextPage=featureFlags.count>currentPage*featureFlagsLogic.ac,needsPagination=featureFlags.count>featureFlagsLogic.ac;return{controlled:!0,pageSize:featureFlagsLogic.ac,currentPage,entryCount:featureFlags.count,onForward:needsPagination&&hasNextPage?()=>{selectExistingFeatureFlagModalLogic.actions.setFilters({page:currentPage+1})}:void 0,onBackward:needsPagination&&currentPage>1?()=>{selectExistingFeatureFlagModalLogic.actions.setFilters({page:Math.max(1,currentPage-1)})}:void 0}}]})]),SelectExistingFeatureFlagModal_SelectExistingFeatureFlagModal=_ref=>{let{onClose,onSelect}=_ref,{featureFlags,featureFlagsLoading,filters,pagination,isModalOpen}=(0,index_esm.useValues)(selectExistingFeatureFlagModalLogic),{setFilters,resetFilters}=(0,index_esm.useActions)(selectExistingFeatureFlagModalLogic),handleClose=()=>{resetFilters(),onClose()},filtersSection=(0,jsx_runtime.jsx)("div",{className:"mb-4",children:(0,jsx_runtime.jsx)(FeatureFlagFilters.a,{filters:filters,setFeatureFlagsFilters:setFilters,searchPlaceholder:"Search for feature flags",filtersConfig:{search:!0}})});return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isModalOpen,onClose:handleClose,title:"Choose an existing feature flag",width:"50%",children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"text-muted mb-2 max-w-xl",children:["Select an existing multivariate feature flag to use with this experiment. The feature flag must use multiple variants with ",(0,jsx_runtime.jsx)("code",{children:"'control'"})," as the first, and not be associated with an existing experiment."]}),filtersSection,(0,jsx_runtime.jsx)(src.g3,{id:"ff",dataSource:featureFlags.results,loading:featureFlagsLoading,useURLForSorting:!1,columns:[{title:"Key",dataIndex:"key",sorter:(a,b)=>(a.key||"").localeCompare(b.key||""),render:(key,flag)=>(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:key}),(0,jsx_runtime.jsx)(src.rU,{to:urls.j.featureFlag(flag.id),target:"_blank",className:"flex items-center",children:(0,jsx_runtime.jsx)(icons.pF,{className:"ml-1"})})]})},{title:"Name",dataIndex:"name",sorter:(a,b)=>(a.name||"").localeCompare(b.name||"")},{title:null,render:function RenderActions(_,flag){return(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-end",children:(0,jsx_runtime.jsx)(src.Jp,{size:"xsmall",type:"primary",disabledReason:void 0,onClick:()=>{onSelect(flag),handleClose()},children:"Select"})})}}],emptyState:"No feature flags match these filters.",pagination:pagination,onSort:newSorting=>setFilters({order:newSorting?`${-1===newSorting.order?"-":""}${newSorting.columnKey}`:void 0,page:1})})]})})};var LemonCheckbox=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonCheckbox/index.ts"),featureFlagLogic=__webpack_require__("../../frontend/src/scenes/feature-flags/featureFlagLogic.ts"),LemonToast_LemonToast=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonToast/LemonToast.tsx"),logic_featureFlagLogic=__webpack_require__("../../frontend/src/lib/logic/featureFlagLogic.ts"),product_intents=__webpack_require__("../../frontend/src/lib/utils/product-intents.ts"),projectTreeLogic=__webpack_require__("../../frontend/src/layout/panel-layout/ProjectTree/projectTreeLogic.tsx");let createExperimentLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(props=>props.experiment?.id||"create-experiment"),(0,index_esm.path)(key=>["scenes","experiments","create","createExperimentLogic",key]),(0,index_esm.connect)(()=>({values:[logic_featureFlagLogic.featureFlagLogic,["featureFlags"]],actions:[eventUsageLogic.vx,["reportExperimentCreated"],featureFlagsLogic.bP,["updateFlag"],teamLogic.teamLogic,["addProductIntent"]]})),(0,lib.forms)(_ref=>{var _props$experiment;let{actions,props}=_ref;return{experiment:{options:{showErrorsOnTouch:!0},defaults:null!==(_props$experiment=props.experiment)&&void 0!==_props$experiment?_props$experiment:{...experiments_constants.j6},errors:_ref2=>{let{name,description}=_ref2;return{name:name?void 0:"Name is required",description:description?void 0:"Hypothesis is required"}},submit:()=>{actions.createExperiment()}}}}),(0,index_esm.actions)(()=>({setExperiment:experiment=>({experiment}),createExperiment:()=>({}),createExperimentSuccess:!0})),(0,index_esm.reducers)(_ref3=>{var _props$experiment2;let{props}=_ref3;return{experiment:[null!==(_props$experiment2=props.experiment)&&void 0!==_props$experiment2?_props$experiment2:{...experiments_constants.j6},{setExperiment:(_,_ref4)=>{let{experiment}=_ref4;return experiment},updateFeatureFlagKey:(state,_ref5)=>{let{key}=_ref5;return{...state,feature_flag_key:key}},resetExperiment:()=>{var _props$experiment3;return null!==(_props$experiment3=props.experiment)&&void 0!==_props$experiment3?_props$experiment3:{...experiments_constants.j6}}}]}}),(0,index_esm.listeners)(_ref6=>{let{values,actions}=_ref6;return{setExperiment:()=>{},setExperimentValue:()=>{},createExperiment:async()=>{let response=await api.ZP.create("api/projects/@current/experiments",values.experiment);response.id&&(actions.reportExperimentCreated(response),actions.addProductIntent({product_type:types.Md.EXPERIMENTS,intent_context:product_intents.kp.EXPERIMENT_CREATED}),actions.createExperimentSuccess(),(0,projectTreeLogic.BI)("experiment",String(response.id)),response.feature_flag?.id&&(0,projectTreeLogic.BI)("feature_flag",String(response.feature_flag.id)),LemonToast_LemonToast.UJ.success("Experiment created successfully!",{button:{label:"View it",action:()=>{kea_router_lib.router.actions.push(urls.j.experiment(response.id))}}}),actions.resetExperiment(),kea_router_lib.router.actions.push(urls.j.experiment(response.id)))}}})]),variantsPanelLogic=(0,index_esm.kea)({path:["scenes","experiments","create","panels","variantsPanelLogic"],props:{experiment:{}},connect:{values:[featureFlagsLogic.bP,["featureFlags"],experimentsLogic.OK,["experiments"]],actions:[createExperimentLogic,["setExperimentValue"]]},actions:{validateFeatureFlagKey:key=>({key}),setFeatureFlagKeyError:error=>({error}),searchFeatureFlags:search=>({search}),resetFeatureFlagsSearch:!0,loadAllEligibleFeatureFlags:!0,generateFeatureFlagKey:name=>({name}),setMode:mode=>({mode}),setFeatureFlagKeyDirty:!0},reducers:{featureFlagKeyError:[null,{setFeatureFlagKeyError:(_,_ref)=>{let{error}=_ref;return error}}],mode:["create",{setMode:(_,_ref2)=>{let{mode}=_ref2;return mode}}],featureFlagKeyDirty:[!1,{setFeatureFlagKeyDirty:()=>!0,setMode:()=>!1}]},loaders:_ref3=>{let{values}=_ref3;return{featureFlagKeyValidation:[null,{validateFeatureFlagKey:async(_ref4,breakpoint)=>{let{key}=_ref4,clientError=(0,featureFlagLogic.QE)(key);if(clientError)return{valid:!1,error:clientError};if(await breakpoint(300),values.unavailableFeatureFlagKeys.has(key))return{valid:!1,error:"A feature flag with this key already exists."};let response=await api.ZP.get(`api/projects/@current/feature_flags/?${(0,utils.oZ)({search:key})}`);return response.results.length>0&&response.results.find(flag=>flag.key===key)?{valid:!1,error:"A feature flag with this key already exists."}:{valid:!0,error:null}}}],availableFeatureFlags:[[],{loadAllEligibleFeatureFlags:async()=>(await api.ZP.get(`api/projects/@current/feature_flags/?${(0,utils.oZ)({limit:100,deleted:!1})}`)).results.filter(flag=>{try{return(0,experiments_utils.i3)(flag)}catch{return!1}}),searchFeatureFlags:async _ref5=>{let{search}=_ref5;return(await api.ZP.get(`api/projects/@current/feature_flags/?${(0,utils.oZ)({search:search||void 0,limit:100,deleted:!1})}`)).results.filter(flag=>{try{return(0,experiments_utils.i3)(flag)}catch{return!1}})},resetFeatureFlagsSearch:()=>[]}],generatedKey:[null,{generateFeatureFlagKey:async _ref6=>{let{name}=_ref6;if(!name)return null;let baseKey=name.toLowerCase().replace(/[^a-z0-9-_]+/g,"-").replace(/-+$/,"").replace(/^-+/,""),key=baseKey,counter=1;for(;values.unavailableFeatureFlagKeys.has(key);)key=`${baseKey}-${counter}`,counter++;return key}}]}},selectors:{unavailableFeatureFlagKeys:[s=>[s.featureFlags,s.experiments],(featureFlags,experiments)=>new Set([...featureFlags.results.map(flag=>flag.key),...experiments.results.map(experiment=>experiment.feature_flag_key)])],featureFlagKey:[(_,props)=>[props.experiment],experiment=>experiment.feature_flag_key||""]},listeners:_ref7=>{let{values,actions}=_ref7;return{[createExperimentLogic.actionTypes.setExperimentValue]:_ref8=>{let{name,value}=_ref8;"name"!==name||"create"!==values.mode||values.featureFlagKeyDirty||actions.generateFeatureFlagKey(value)},generateFeatureFlagKeySuccess:_ref9=>{let{generatedKey}=_ref9;generatedKey&&(actions.setExperimentValue("feature_flag_key",generatedKey),actions.validateFeatureFlagKey(generatedKey))}}}}),VariantsPanelCreateFeatureFlag_generateFeatureFlagKey=(name,unavailableFeatureFlagKeys)=>{let baseKey=name.toLowerCase().replace(/[^A-Za-z0-9-_]+/g,"-").replace(/-+$/,"").replace(/^-+/,""),key=baseKey,counter=1;for(;unavailableFeatureFlagKeys?.has(key);)key=`${baseKey}-${counter}`,counter++;return key},VariantsPanelCreateFeatureFlag=_ref=>{var _ensure_experience_co;let{experiment,onChange}=_ref,{featureFlagKeyDirty,unavailableFeatureFlagKeys,featureFlagKeyValidation,featureFlagKeyValidationLoading}=(0,index_esm.useValues)(variantsPanelLogic),{setFeatureFlagKeyDirty,validateFeatureFlagKey}=(0,index_esm.useActions)(variantsPanelLogic),variants=experiment.parameters?.feature_flag_variants||[{key:"control",rollout_percentage:50},{key:"test",rollout_percentage:50}],ensureExperienceContinuity=null===(_ensure_experience_co=experiment.parameters?.ensure_experience_continuity)||void 0===_ensure_experience_co||_ensure_experience_co,variantRolloutSum=variants.reduce((sum,_ref2)=>{let{rollout_percentage}=_ref2;return sum+rollout_percentage},0),areVariantRolloutsValid=variants.every(_ref3=>{let{rollout_percentage}=_ref3;return rollout_percentage>=0&&rollout_percentage<=100})&&100===variantRolloutSum,updateVariant=(index,updates)=>{let newVariants=[...variants];newVariants[index]={...newVariants[index],...updates},onChange({parameters:{...experiment.parameters,feature_flag_variants:newVariants,ensure_experience_continuity:ensureExperienceContinuity}})},removeVariant=index=>{!(variants.length<=2)&&0!==index&&distributeVariantsEqually(variants.filter((_,i)=>i!==index))},distributeVariantsEqually=variantsToDistribute=>{let variantsToUse=variantsToDistribute||experiment.parameters?.feature_flag_variants||[{key:"control",rollout_percentage:50},{key:"test",rollout_percentage:50}],percentages=(0,experiments_utils.d5)(variantsToUse.length);onChange({parameters:{feature_flag_variants:variantsToUse.map((variant,index)=>({...variant,rollout_percentage:percentages[index]})),ensure_experience_continuity:ensureExperienceContinuity}})},debouncedValidateFeatureFlagKey=(0,index_module.y1)(key=>{key&&validateFeatureFlagKey(key)},300);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Feature flag key",htmlFor:"experiment-feature-flag-key",children:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonInput.D,{id:"experiment-feature-flag-key",placeholder:"examples: new-landing-page, betaFeature, ab_test_1",value:experiment.feature_flag_key||"",onChange:value=>{setFeatureFlagKeyDirty();let normalizedValue=value.replace(/\s+/g,"-");onChange({feature_flag_key:normalizedValue}),debouncedValidateFeatureFlagKey(normalizedValue)},onFocus:()=>{experiment.name&&!featureFlagKeyDirty&&onChange({feature_flag_key:VariantsPanelCreateFeatureFlag_generateFeatureFlagKey(experiment.name,unavailableFeatureFlagKeys)})},suffix:featureFlagKeyValidationLoading?(0,jsx_runtime.jsx)(Spinner.$,{size:"small"}):featureFlagKeyValidation?.valid?(0,jsx_runtime.jsx)(posthog_icons_es.IconCheck,{className:"text-success"}):null,status:featureFlagKeyValidation?.error?"danger":"default"}),featureFlagKeyValidation?.error&&(0,jsx_runtime.jsx)("div",{className:"text-xs text-danger",children:featureFlagKeyValidation.error}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-secondary",children:"Each experiment is backed by a feature flag. This key will be used to control the experiment in your code."})]})}),(0,jsx_runtime.jsx)(LemonField.D.Pure,{label:"Variant keys",help:"The rollout percentage of experiment variants must add up to 100%",children:(0,jsx_runtime.jsxs)("div",{className:"text-sm border border-primary rounded p-4",children:[(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-24 gap-2 font-bold mb-2 items-center",children:[(0,jsx_runtime.jsx)("div",{}),(0,jsx_runtime.jsx)("div",{className:"col-span-4",children:"Variant key"}),(0,jsx_runtime.jsx)("div",{className:"col-span-6",children:"Description"}),(0,jsx_runtime.jsxs)("div",{className:"col-span-3 flex justify-between items-center gap-1",children:[(0,jsx_runtime.jsx)("span",{children:"Rollout"}),(0,jsx_runtime.jsx)(LemonButton.J,{onClick:()=>distributeVariantsEqually(),tooltip:"Normalize variant rollout percentages",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconBalance,{})})]})]}),variants.map((variant,index)=>(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-24 gap-2 mb-2",children:[(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center",children:(0,jsx_runtime.jsx)(Lettermark.B,{name:utils.bH[index],color:Lettermark.w.Gray})}),(0,jsx_runtime.jsx)("div",{className:"col-span-4",children:(0,jsx_runtime.jsx)(LemonInput.D,{value:variant.key,onChange:value=>updateVariant(index,{key:value}),"data-attr":"experiment-variant-key","data-key-index":index.toString(),className:"ph-ignore-input",placeholder:`example-variant-${index+1}`,autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:!1})}),(0,jsx_runtime.jsx)("div",{className:"col-span-6",children:(0,jsx_runtime.jsx)(LemonInput.D,{value:variant.name||"",onChange:value=>updateVariant(index,{name:value}),"data-attr":"experiment-variant-name",className:"ph-ignore-input",placeholder:"Description"})}),(0,jsx_runtime.jsx)("div",{className:"col-span-3",children:(0,jsx_runtime.jsx)(LemonInput.D,{type:"number",min:0,max:100,value:variant.rollout_percentage,onChange:changedValue=>{updateVariant(index,{rollout_percentage:void 0===changedValue||Number.isNaN(changedValue)?0:parseInt(changedValue.toString(),10)})},suffix:(0,jsx_runtime.jsx)("span",{children:"%"}),"data-attr":"experiment-variant-rollout-percentage-input"})}),(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center",children:variants.length>2&&index>0&&(0,jsx_runtime.jsx)(LemonButton.J,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconTrash,{}),"data-attr":`delete-prop-filter-${index}`,noPadding:!0,onClick:()=>removeVariant(index),tooltipPlacement:"top-end"})})]},variant.key)),variants.length>0&&!areVariantRolloutsValid&&(0,jsx_runtime.jsxs)("p",{className:"text-danger",children:["Percentage rollouts for variants must sum to 100 (currently ",variantRolloutSum,")."]}),variants.length<constants.Rp&&(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",onClick:()=>{if(variants.length>=constants.Rp)return;let newVariant={key:`test-${variants.length}`,rollout_percentage:0};distributeVariantsEqually([...variants,newVariant])},icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPlus,{}),center:!0,children:"Add variant"})]})}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(LemonCheckbox.H,{label:"Persist flag across authentication steps",onChange:checked=>{onChange({parameters:{feature_flag_variants:variants,ensure_experience_continuity:checked}})},fullWidth:!0,checked:ensureExperienceContinuity}),(0,jsx_runtime.jsx)("div",{className:"text-secondary text-sm pl-6 mt-2",children:"If your feature flag is evaluated for anonymous users, use this option to ensure the flag value remains consistent after the user logs in. Note that this feature requires creating profiles for anonymous users."})]})]})},getTargetingSummary=flag=>(0,dist.EQ)(flag).with({is_simple_flag:!0,rollout_percentage:dist.P.not(dist.P.nullish)},f=>[`${f.rollout_percentage}% of all users`]).with({filters:{groups:dist.P.when(g=>!g||0===g.length)}},()=>["All users"]).otherwise(f=>f.filters.groups.map(group=>{let rollout=null!=group.rollout_percentage?`${group.rollout_percentage}% of `:"",users=group.properties?.length?`users matching ${group.properties.length} ${1===group.properties.length?"condition":"conditions"}`:"all users",variant=group.variant?` â variant "${group.variant}"`:"";return`${rollout}${users}${variant}`})),TargetingSummary=_ref=>{let{flag}=_ref,[expanded,setExpanded]=(0,react.useState)(!1),conditions=getTargetingSummary(flag),hasMultipleConditions=conditions.length>2,displayConditions=expanded?conditions:conditions.slice(0,2);return(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsx)("div",{className:"text-xs uppercase tracking-wide font-semibold text-muted",children:"Targeting"}),(0,jsx_runtime.jsx)("ul",{className:"list-disc pl-4 text-sm space-y-1",children:displayConditions.map((condition,index)=>(0,jsx_runtime.jsx)("li",{children:condition},index))}),hasMultipleConditions&&!expanded&&(0,jsx_runtime.jsxs)("button",{onClick:()=>setExpanded(!0),className:"text-sm text-link hover:underline cursor-pointer pl-4",children:["+",conditions.length-2," more ",conditions.length-2==1?"condition":"conditions"]}),expanded&&hasMultipleConditions&&(0,jsx_runtime.jsx)("button",{onClick:()=>setExpanded(!1),className:"text-sm text-link hover:underline cursor-pointer pl-4",children:"Show less"})]})},VariantsPanelLinkFeatureFlag=_ref2=>{let{linkedFeatureFlag,setShowFeatureFlagSelector}=_ref2;if(!linkedFeatureFlag)return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("label",{className:"text-sm font-semibold",children:"Selected Feature Flag"}),(0,jsx_runtime.jsxs)("div",{className:"mt-2 p-8 border border-dashed rounded-lg bg-bg-light flex flex-col items-center gap-3",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconToggle,{className:"text-muted text-2xl"}),(0,jsx_runtime.jsx)("div",{className:"text-base font-semibold",children:"No feature flag selected"})]}),(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted-alt text-center",children:"Select an existing multivariate feature flag to use with this experiment"}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"primary",size:"small",onClick:setShowFeatureFlagSelector,children:"Select Feature Flag"})]})]});let variants=linkedFeatureFlag.filters?.multivariate?.variants||[];return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("label",{className:"text-sm font-semibold",children:"Linked Feature Flag"}),(0,jsx_runtime.jsxs)("div",{className:"mt-2 border rounded-lg bg-bg-light p-4 space-y-2",children:[(0,jsx_runtime.jsxs)("div",{className:"flex flex-row gap-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconToggle,{className:"text-lg flex-shrink-0"}),(0,jsx_runtime.jsx)("div",{className:"font-semibold text-base truncate",children:linkedFeatureFlag.key}),(0,jsx_runtime.jsx)(Link.r,{to:urls.j.featureFlag(linkedFeatureFlag.id),target:"_blank",className:"flex items-center hover:text-link flex-shrink-0",title:"View feature flag",children:(0,jsx_runtime.jsx)(icons.pF,{})})]}),(0,jsx_runtime.jsx)(LemonButton.J,{type:"secondary",size:"small",onClick:setShowFeatureFlagSelector,children:"Change"})]}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("div",{className:`w-2 h-2 rounded-full ${linkedFeatureFlag.active?"bg-success":"bg-muted"}`,title:linkedFeatureFlag.active?"Active":"Inactive"}),(0,jsx_runtime.jsx)("span",{className:"text-sm font-medium",children:linkedFeatureFlag.active?"Active":"Inactive"})]}),linkedFeatureFlag.name&&(0,jsx_runtime.jsx)("div",{className:"text-sm text-muted-alt",children:linkedFeatureFlag.name}),(0,jsx_runtime.jsxs)("div",{className:"space-y-2",children:[(0,jsx_runtime.jsx)("div",{className:"text-xs uppercase tracking-wide font-semibold text-muted",children:"Variants"}),(0,jsx_runtime.jsx)("div",{className:"flex flex-wrap gap-1.5",children:variants.map(_ref3=>{let{key}=_ref3;return(0,jsx_runtime.jsx)(LemonTag.o,{type:"control"===key?"primary":"default",children:key},key)})})]}),(0,jsx_runtime.jsx)(TargetingSummary,{flag:linkedFeatureFlag})]})]})};function VariantsPanel(_ref){let{experiment,updateFeatureFlag}=_ref,{mode}=(0,index_esm.useValues)(variantsPanelLogic),{setMode}=(0,index_esm.useActions)(variantsPanelLogic),[linkedFeatureFlag,setLinkedFeatureFlag]=(0,react.useState)(null),{openSelectExistingFeatureFlagModal,closeSelectExistingFeatureFlagModal}=(0,index_esm.useActions)(selectExistingFeatureFlagModalLogic);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsx)(SelectableCard.u,{title:"Create new feature flag",description:"Generate a new feature flag with custom variants for this experiment.",selected:"create"===mode,onClick:()=>{setMode("create")}}),(0,jsx_runtime.jsx)(SelectableCard.u,{title:"Link existing feature flag",description:"Use an existing multivariate feature flag and inherit its variants.",selected:"link"===mode,onClick:()=>setMode("link")})]}),(0,dist.EQ)(mode).with("create",()=>(0,jsx_runtime.jsx)(VariantsPanelCreateFeatureFlag,{experiment:experiment,onChange:updateFeatureFlag})).with("link",()=>(0,jsx_runtime.jsx)(VariantsPanelLinkFeatureFlag,{linkedFeatureFlag:linkedFeatureFlag,setShowFeatureFlagSelector:openSelectExistingFeatureFlagModal})).exhaustive(),(0,jsx_runtime.jsx)(SelectExistingFeatureFlagModal_SelectExistingFeatureFlagModal,{onClose:()=>closeSelectExistingFeatureFlagModal(),onSelect:flag=>{setLinkedFeatureFlag(flag),closeSelectExistingFeatureFlagModal()}})]})}let LemonFieldError=_ref=>{let{error}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"text-danger flex items-center gap-1 text-sm",children:[(0,jsx_runtime.jsx)(icons.b8,{className:"text-xl shrink-0"})," ",error]})},CreateExperiment=_ref2=>{let{draftExperiment}=_ref2,{HogfettiComponent}=(0,Hogfetti.Z)({count:100,duration:3e3}),{experiment,experimentErrors}=(0,index_esm.useValues)(createExperimentLogic({experiment:draftExperiment})),{setExperimentValue}=(0,index_esm.useActions)(createExperimentLogic({experiment:draftExperiment})),[selectedPanel,setSelectedPanel]=(0,react.useState)(null),debouncedOnNameChange=(0,index_module.y1)(name=>{setExperimentValue("name",name)},500);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col xl:grid xl:grid-cols-[1fr_400px] gap-x-4 h-full",children:[(0,jsx_runtime.jsxs)(lib.Form,{logic:createExperimentLogic,formKey:"experiment",enableFormOnSubmit:!0,children:[(0,jsx_runtime.jsx)(HogfettiComponent,{}),(0,jsx_runtime.jsxs)(SceneContent._,{className:"max-w-none flex-1",children:[(0,jsx_runtime.jsx)(SceneTitleSection.s,{name:experiment.name,description:null,resourceType:{type:"experiment"},canEdit:!0,forceEdit:!0,onNameChange:debouncedOnNameChange,actions:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"cancel-experiment",type:"secondary",size:"small",onClick:()=>{kea_router_lib.router.actions.push(urls.j.experiments())},children:"Cancel"}),(0,jsx_runtime.jsx)(LemonButton.J,{"data-attr":"save-experiment",type:"primary",size:"small",htmlType:"submit",children:"Save as draft"})]})}),experimentErrors.name&&"string"==typeof experimentErrors.name&&(0,jsx_runtime.jsx)(LemonFieldError,{error:experimentErrors.name}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsx)(SceneSection.S,{title:"Hypothesis",description:"Describe your experiment in a few sentences.",children:(0,jsx_runtime.jsx)(LemonField.D,{name:"description",children:(0,jsx_runtime.jsx)(lemon_ui_LemonTextArea._,{placeholder:"The goal of this experiment is ...","data-attr":"experiment-hypothesis",value:experiment.description,onChange:value=>{setExperimentValue("description",value)}})})}),(0,jsx_runtime.jsx)(SceneDivider.V,{}),(0,jsx_runtime.jsx)(LemonCollapse.J,{activeKey:null!=selectedPanel?selectedPanel:void 0,defaultActiveKey:"experiment-variants",onChange:key=>{setSelectedPanel(key)},className:"bg-surface-primary",panels:[{key:"experiment-variants",header:"Feature flag & variants",content:(0,jsx_runtime.jsx)(VariantsPanel,{experiment:experiment,updateFeatureFlag:updates=>{void 0!==updates.feature_flag_key&&setExperimentValue("feature_flag_key",updates.feature_flag_key),updates.parameters&&setExperimentValue("parameters",{...experiment.parameters,...updates.parameters})}})},{key:"experiment-exposure",header:"Exposure criteria",content:(0,jsx_runtime.jsx)(ExposureCriteriaPanel,{experiment:experiment,onChange:exposureCriteria=>exposureCriteria})},{key:"experiment-metrics",header:"Metrics",content:(0,jsx_runtime.jsx)("div",{className:"p-4",children:(0,jsx_runtime.jsx)("span",{children:"Metrics Panel Goes Here"})})}]})]})]}),(0,jsx_runtime.jsx)("div",{className:"h-full",children:(0,jsx_runtime.jsx)("div",{className:"sticky top-16",children:(0,jsx_runtime.jsx)("span",{children:"Sidebar Checklist Goes Here"})})})]})};function HoldoutSelector_HoldoutSelector(){let{experiment,holdouts,isExperimentRunning}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{setExperiment,reportExperimentHoldoutAssigned}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),holdoutOptions=holdouts.map(holdout=>({value:holdout.id,label:holdout.name}));return holdoutOptions.unshift({value:null,label:"No holdout"}),(0,jsx_runtime.jsxs)("div",{className:"mt-3",children:[(0,jsx_runtime.jsxs)("div",{className:"inline-flex deprecated-space-x-1",children:[(0,jsx_runtime.jsx)("h4",{className:"font-semibold mb-0",children:"Holdout group"}),(0,jsx_runtime.jsx)(src.u,{title:"Exclude a stable group of users from the experiment. This cannot be changed once the experiment is launched.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-base"})})]}),(0,jsx_runtime.jsx)("div",{className:"mt-1",children:(0,jsx_runtime.jsx)(src.Yv,{disabledReason:isExperimentRunning&&!experiment.end_date&&"The holdout group cannot be changed once the experiment is launched.",size:"xsmall",options:holdoutOptions,value:experiment.holdout_id||null,onChange:value=>{setExperiment({...experiment,holdout_id:value}),reportExperimentHoldoutAssigned({experimentId:experiment.id,holdoutId:value})},"data-attr":"experiment-holdout-selector"})})]})}var useUploadFiles=__webpack_require__("../../frontend/src/lib/hooks/useUploadFiles.ts");function VariantScreenshot(_ref){let{variantKey,rolloutPercentage}=_ref,{experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{updateExperimentVariantImages,reportExperimentVariantScreenshotUploaded}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),[mediaIds,setMediaIds]=(0,react.useState)((()=>{let variantImages=experiment.parameters?.variant_screenshot_media_ids?.[variantKey];return variantImages?Array.isArray(variantImages)?variantImages:[variantImages]:[]})()),[loadingImages,setLoadingImages]=(0,react.useState)({}),[selectedImageIndex,setSelectedImageIndex]=(0,react.useState)(null),{setFilesToUpload,filesToUpload,uploading}=(0,useUploadFiles.nc)({onUpload:(_,__,id)=>{if(id&&mediaIds.length<5){let newMediaIds=[...mediaIds,id];setMediaIds(newMediaIds),updateExperimentVariantImages({...experiment.parameters?.variant_screenshot_media_ids,[variantKey]:newMediaIds}),reportExperimentVariantScreenshotUploaded(experiment.id)}else mediaIds.length>=5&&src.UJ.error("Maximum of 5 images allowed")},onError:detail=>{src.UJ.error(`Error uploading image: ${detail}`)}}),handleImageLoad=mediaId=>{setLoadingImages(prev=>({...prev,[mediaId]:!1}))},handleImageError=mediaId=>{setLoadingImages(prev=>({...prev,[mediaId]:!1}))},handleDelete=indexToDelete=>{let newMediaIds=mediaIds.filter((_,index)=>index!==indexToDelete);setMediaIds(newMediaIds),updateExperimentVariantImages({...experiment.parameters?.variant_screenshot_media_ids,[variantKey]:newMediaIds})},widthClass=(()=>{switch(mediaIds.length<5?mediaIds.length+1:mediaIds.length){case 1:case 2:default:return"w-20";case 3:return"w-16";case 4:return"w-14";case 5:return"w-12"}})();return(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 items-start",children:[mediaIds.map((mediaId,index)=>(0,jsx_runtime.jsx)("div",{className:"relative",children:(0,jsx_runtime.jsx)("div",{className:"text-secondary inline-flex flow-row items-center gap-1 cursor-pointer",children:(0,jsx_runtime.jsxs)("div",{onClick:()=>setSelectedImageIndex(index),className:"cursor-zoom-in relative",children:[(0,jsx_runtime.jsxs)("div",{className:`relative flex overflow-hidden select-none ${widthClass} h-16 rounded before:absolute before:inset-0 before:border before:rounded`,children:[loadingImages[mediaId]&&(0,jsx_runtime.jsx)(src.yW,{className:"absolute inset-0"}),(0,jsx_runtime.jsx)("img",{className:"w-full h-full object-cover",src:mediaId.startsWith("data:")?mediaId:`/uploaded_media/${mediaId}`,onError:()=>handleImageError(mediaId),onLoad:()=>handleImageLoad(mediaId)})]}),(0,jsx_runtime.jsx)("div",{className:"absolute -inset-2 group",children:(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconX,{}),onClick:e=>{e.stopPropagation(),handleDelete(index)},size:"small",tooltip:"Remove",tooltipPlacement:"right",noPadding:!0,className:"group-hover:flex hidden absolute right-0 top-0"})})]})})},mediaId)),mediaIds.length<5&&(0,jsx_runtime.jsx)("div",{className:`relative ${widthClass} h-16`,children:(0,jsx_runtime.jsx)(src.mH,{accept:"image/*",multiple:!1,onChange:setFilesToUpload,loading:uploading,value:filesToUpload,callToAction:(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center w-full h-16 border border-dashed rounded cursor-pointer hover:border-accent",children:(0,jsx_runtime.jsx)("span",{className:"text-2xl text-secondary",children:"+"})})})})]}),(0,jsx_runtime.jsx)(src.fQ,{isOpen:null!==selectedImageIndex,onClose:()=>setSelectedImageIndex(null),title:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsxs)("span",{children:["Screenshot ",null!==selectedImageIndex?selectedImageIndex+1:""]}),(0,jsx_runtime.jsx)(src.p2,{className:"my-0 mx-1",vertical:!0}),(0,jsx_runtime.jsx)(components.Aw,{experimentId:experiment.id,variantKey:variantKey}),void 0!==rolloutPercentage&&(0,jsx_runtime.jsxs)("span",{className:"text-secondary text-sm",children:["(",rolloutPercentage,"% rollout)"]})]}),children:null!==selectedImageIndex&&mediaIds[selectedImageIndex]&&(0,jsx_runtime.jsx)("img",{src:mediaIds[selectedImageIndex]?.startsWith("data:")?mediaIds[selectedImageIndex]:`/uploaded_media/${mediaIds[selectedImageIndex]}`,alt:`Screenshot ${selectedImageIndex+1}: ${variantKey}`,className:"max-w-full max-h-[80vh] overflow-auto"})})]})}function DistributionModal(_ref){var _experiment$feature_f;let{experimentId}=_ref,{experiment,experimentLoading}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{updateDistribution}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closeDistributionModal}=(0,index_esm.useActions)(modalsLogic.l),{isDistributionModalOpen}=(0,index_esm.useValues)(modalsLogic.l),_featureFlagLogic=(0,featureFlagLogic.hk)({id:null!==(_experiment$feature_f=experiment.feature_flag?.id)&&void 0!==_experiment$feature_f?_experiment$feature_f:null}),{featureFlag,areVariantRolloutsValid,variantRolloutSum}=(0,index_esm.useValues)(_featureFlagLogic),{setFeatureFlagFilters,distributeVariantsEqually}=(0,index_esm.useActions)(_featureFlagLogic),handleRolloutPercentageChange=(index,value)=>{if(!featureFlag?.filters?.multivariate)return;let numericValue=value||0,updatedVariants=featureFlag.filters.multivariate.variants.map((variant,i)=>i===index?{...variant,rollout_percentage:numericValue}:variant);setFeatureFlagFilters({...featureFlag.filters,multivariate:{...featureFlag.filters.multivariate,variants:updatedVariants}},null)};return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isDistributionModalOpen,onClose:closeDistributionModal,width:600,title:"Change experiment distribution",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:closeDistributionModal,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{updateDistribution(featureFlag),closeDistributionModal()},type:"primary",loading:experimentLoading,disabled:!areVariantRolloutsValid,children:"Save"})]}),children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:"Adjusting variant distribution may impact the validity of your results. Adjust only if you're aware of how changes will affect your experiment."}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold mb-0",children:"Variant distribution"}),(0,jsx_runtime.jsx)(src.Jp,{size:"small",onClick:distributeVariantsEqually,tooltip:"Redistribute variant rollout percentages equally",icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconBalance,{}),children:"Distribute equally"})]}),(0,jsx_runtime.jsx)(src.g3,{dataSource:featureFlag?.filters?.multivariate?.variants||[],columns:[{title:"Variant",dataIndex:"key",render:value=>(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:value})},{title:"Rollout Percentage",dataIndex:"rollout_percentage",render:(_,record,index)=>(0,jsx_runtime.jsx)(src.DF,{type:"number",value:record.rollout_percentage,onChange:value=>handleRolloutPercentageChange(index,value),min:0,max:100,suffix:(0,jsx_runtime.jsx)("span",{children:"%"})})}]}),!areVariantRolloutsValid&&(0,jsx_runtime.jsxs)("p",{className:"text-danger mt-2",children:["Percentage rollouts must sum to 100 (currently ",variantRolloutSum,")."]})]}),(0,jsx_runtime.jsx)(HoldoutSelector_HoldoutSelector,{})]})})}function DistributionTable(){let{openDistributionModal}=(0,index_esm.useActions)(modalsLogic.l),{experimentId,experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{reportExperimentReleaseConditionsViewed}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),onSelectElement=variant=>{src.dn.open({title:"Select a domain",description:"Choose the domain on which to preview this experiment variant",content:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(AuthorizedUrlList.t,{query:"?__experiment_id="+experiment?.id+"&__experiment_variant="+variant,experimentId:experiment?.id,type:authorizedUrlListLogic.uw.WEB_EXPERIMENTS})}),primaryButton:{children:"Close",type:"secondary"}})},className=experiment?.type==="web"?"w-1/2.5":"w-1/3",columns=[{className:className,key:"key",title:"Variant",render:function Key(_,item){return(0,jsx_runtime.jsx)(components.Aw,{experimentId:experimentId,variantKey:item.key})}},{className:className,key:"rollout_percentage",title:"Rollout",render:function Key(_,item){return(0,jsx_runtime.jsx)("div",{children:`${item.rollout_percentage}%`})}},{className:className,key:"variant_screenshot",title:"Screenshot",render:function Key(_,item){return item.key===`holdout-${experiment.holdout?.id}`?(0,jsx_runtime.jsx)("div",{className:"h-16"}):(0,jsx_runtime.jsx)("div",{className:"my-2",children:(0,jsx_runtime.jsx)(VariantScreenshot,{variantKey:item.key,rolloutPercentage:item.rollout_percentage})})}}];"web"===experiment.type&&columns.push({className:className,key:"preview_web_experiment",title:"Preview",render:function Key(_,item){return(0,jsx_runtime.jsx)("div",{className:"my-2",children:(0,jsx_runtime.jsx)(src.Jp,{size:"small",type:"secondary",onClick:e=>{e.preventDefault(),onSelectElement(item.key)},sideIcon:(0,jsx_runtime.jsx)(icons.UE,{}),children:"Preview variant"})})}});let holdoutData=experiment.holdout?[{key:`holdout-${experiment.holdout.id}`,rollout_percentage:experiment.holdout.filters[0].rollout_percentage}]:[],tableData=[...(experiment.feature_flag?.filters.multivariate?.variants||[]).map(variant=>({...variant,rollout_percentage:variant.rollout_percentage*((100-(experiment.holdout?.filters[0].rollout_percentage||0))/100)})),...holdoutData];return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/2",children:(0,jsx_runtime.jsx)("h2",{className:"font-semibold text-lg",children:"Distribution"})}),(0,jsx_runtime.jsx)("div",{className:"w-1/2 flex flex-col justify-end",children:(0,jsx_runtime.jsx)("div",{className:"ml-auto mb-2",children:(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconFlag,{}),onClick:()=>{openDistributionModal(),reportExperimentReleaseConditionsViewed(experiment.id)},type:"secondary",size:"xsmall",className:"font-semibold",children:"Manage distribution"})})})]}),experiment.holdout&&(0,jsx_runtime.jsxs)(src.Vp,{type:"info",className:"mb-4",children:["This experiment has a holdout group of ",experiment.holdout.filters[0].rollout_percentage,"%. The variants are modified to show their relative rollout percentage."]}),(0,jsx_runtime.jsx)(src.g3,{loading:!1,columns:columns,dataSource:tableData,rowClassName:item=>item.key===`holdout-${experiment.holdout?.id}`?"dark:bg-fill-primary bg-mid":""})]})}function PreLaunchChecklist(){let{experiment,usesNewQueryRunner}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{openDescriptionModal,openPrimaryMetricSourceModal}=(0,index_esm.useActions)(modalsLogic.l),{openMetricSourceModal}=(0,index_esm.useActions)(metricSourceModalLogic);return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"flex items-center deprecated-space-x-2 mb-2",children:(0,jsx_runtime.jsx)("h2",{className:"mb-0 font-semibold text-lg leading-6",children:"Pre-launch checklist"})}),(0,jsx_runtime.jsx)("div",{className:"bg-bg-light rounded p-4 border",children:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-3 mb-6",children:[experiment.description?(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{className:"text-success flex-none w-6 h-6"}):(0,jsx_runtime.jsx)("div",{className:"flex-none w-5 h-5 rounded-full border-2 border-orange"}),(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[(0,jsx_runtime.jsx)("div",{className:`text-xs font-semibold ${experiment.description?"text-success":""}`,children:"Step 1"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:`font-semibold ${experiment.description?"text-muted line-through":""}`,children:"Add hypothesis"}),(0,jsx_runtime.jsx)("div",{className:`text-sm ${experiment.description?"text-muted line-through":"text-muted"}`,children:"Document what you expect to learn from this experiment"})]}),!experiment.description&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>{openDescriptionModal()},children:"Add hypothesis"})]})]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-3",children:[experiment.metrics?.length>0?(0,jsx_runtime.jsx)(posthog_icons_es.IconCheckCircle,{className:"text-success flex-none w-6 h-6"}):(0,jsx_runtime.jsx)("div",{className:"flex-none w-5 h-5 rounded-full border-2 border-orange"}),(0,jsx_runtime.jsxs)("div",{className:"flex-1",children:[(0,jsx_runtime.jsx)("div",{className:`text-xs font-semibold ${experiment.metrics?.length>0?"text-success":""}`,children:"Step 2"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:`font-semibold ${experiment.metrics?.length>0?"text-muted line-through":""}`,children:"Add first metric"}),(0,jsx_runtime.jsx)("div",{className:`text-sm ${experiment.metrics?.length>0?"text-muted line-through":"text-muted"}`,children:"Define your experiment's primary success metric"})]}),!(experiment.metrics?.length>0)&&(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",size:"small",onClick:()=>{usesNewQueryRunner?openMetricSourceModal(METRIC_CONTEXTS.primary):openPrimaryMetricSourceModal()},children:"Add metric"})]})]})]})]})})]})}function ExperimentHeader(){let{experiment,isExperimentRunning}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:!isExperimentRunning&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"w-1/2",children:(0,jsx_runtime.jsx)(PreLaunchChecklist,{})}),"web"===experiment.type?(0,jsx_runtime.jsx)(WebExperimentImplementationDetails,{experiment:experiment}):(0,jsx_runtime.jsx)(ExperimentImplementationDetails.aK,{experiment:experiment})]})})}function ExposureCriteriaModal(){let{experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{restoreUnmodifiedExperiment,setExposureCriteria,updateExposureCriteria}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{closeExposureCriteriaModal}=(0,index_esm.useActions)(modalsLogic.l),{isExposureCriteriaModalOpen}=(0,index_esm.useValues)(modalsLogic.l),{currentTeam}=(0,index_esm.useValues)(teamLogic.teamLogic),hasFilters=(currentTeam?.test_account_filters||[]).length>0;return(0,jsx_runtime.jsxs)(src.fQ,{isOpen:isExposureCriteriaModalOpen,onClose:closeExposureCriteriaModal,width:860,title:"Edit exposure criteria",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-exposure-form",type:"secondary",onClick:()=>{restoreUnmodifiedExperiment(),closeExposureCriteriaModal()},children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-exposure-form",onClick:()=>{updateExposureCriteria(),closeExposureCriteriaModal()},type:"primary",children:"Save"})]}),children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,jsx_runtime.jsx)(SelectableCard.u,{title:"Default",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["When a ",(0,jsx_runtime.jsx)(src.oe,{children:"$feature_flag_called"})," event is recorded, a user is considered"," ",(0,jsx_runtime.jsx)("strong",{children:"exposed"})," to the experiment and included in the analysis."]}),selected:!experiment.exposure_criteria?.exposure_config,onClick:()=>{setExposureCriteria({exposure_config:void 0})}}),(0,jsx_runtime.jsx)(SelectableCard.u,{title:"Custom",description:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["If you can't rely on the ",(0,jsx_runtime.jsx)(src.oe,{children:"$feature_flag_called"})," event, you can select a custom event to signal that users reached the part of your app where the experiment runs. You can also filter out users you would like to exclude from the analysis."]}),selected:!!experiment.exposure_criteria?.exposure_config,onClick:()=>{setExposureCriteria({exposure_config:{kind:schema_general.OH.ExperimentEventExposureConfig,event:"$feature_flag_called",properties:[]}})}})]}),experiment.exposure_criteria?.exposure_config&&(0,jsx_runtime.jsx)("div",{className:"mb-4",children:(0,jsx_runtime.jsx)(ActionFilter.T,{bordered:!0,filters:(0,experiments_utils.m3)(experiment.exposure_criteria.exposure_config),setFilters:_ref=>{let{events,actions}=_ref,entity=events?.[0]||actions?.[0];entity&&setExposureCriteria({exposure_config:(0,experiments_utils.ZE)(entity)})},typeKey:"experiment-exposure-config",buttonCopy:"Add graph series",showSeriesIndicator:!0,hideRename:!0,entitiesLimit:1,mathAvailability:ActionFilterRow.Qq.None,showNumericalPropsOnly:!0,actionsTaxonomicGroupTypes:[TaxonomicFilter_types.t.Events,TaxonomicFilter_types.t.Actions],propertiesTaxonomicGroupTypes:Selectors.dF.propertiesTaxonomicGroupTypes})}),(0,jsx_runtime.jsxs)("div",{className:"w-[405px]",children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)("label",{className:"block text-sm font-medium text-default mb-2",children:"Multiple variant handling"}),(0,jsx_runtime.jsx)(src.Yv,{value:experiment.exposure_criteria?.multiple_variant_handling||"exclude",onChange:value=>{setExposureCriteria({multiple_variant_handling:value})},options:[{value:"exclude",label:"Exclude from analysis","data-attr":"multiple-handling-exclude"},{value:"first_seen",label:"Use first seen variant","data-attr":"multiple-handling-first-seen"}],placeholder:"Select handling method",fullWidth:!0}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-muted mt-1",children:[experiment.exposure_criteria?.multiple_variant_handling==="first_seen"&&"Users exposed to multiple variants will be analyzed using their first seen variant.",(!experiment.exposure_criteria?.multiple_variant_handling||experiment.exposure_criteria?.multiple_variant_handling==="exclude")&&"Users exposed to multiple variants will be excluded from the analysis (recommended)."]})]}),(0,jsx_runtime.jsx)(TestAccountFiltersSwitch.Z,{checked:(()=>{let val=experiment.exposure_criteria?.filterTestAccounts;return!!hasFilters&&!!val})(),onChange:checked=>{setExposureCriteria({filterTestAccounts:checked})},fullWidth:!0})]})]})}function MicroChart(_ref){let{exposures}=_ref,canvasRef=(0,react.useRef)(null),chartRef=(0,react.useRef)(null);return((0,react.useEffect)(()=>{if(!canvasRef.current||!exposures?.timeseries?.length)return;chartRef.current&&(chartRef.current.destroy(),chartRef.current=null);let ctx=canvasRef.current,timeseries=exposures.timeseries,datasets=timeseries.map((series,index)=>({data:series.exposure_counts,borderColor:(0,lib_colors._r)(index),fill:!1,tension:.3,borderWidth:1.5,pointRadius:0}));1===timeseries[0].days.length&&(datasets=datasets.map(dataset=>({...dataset,data:[0,...dataset.data]})));let config={type:"line",data:{labels:datasets[0].data.map((_,i)=>i),datasets},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:0},scales:{x:{display:!1,grid:{display:!1}},y:{display:!1,beginAtZero:!0,grid:{display:!1}}},plugins:{legend:{display:!1},tooltip:{enabled:!1}},elements:{line:{borderJoinStyle:"round"}}}};try{chartRef.current=new Chart.kL(ctx,config)}catch(error){console.error("Error creating microchart:",error)}return()=>{chartRef.current&&(chartRef.current.destroy(),chartRef.current=null)}},[exposures]),exposures?.timeseries?.length)?(0,jsx_runtime.jsx)("div",{className:"inline-block",style:{width:"60px",height:"20px",pointerEvents:"none",borderBottom:"1px solid var(--color-border-primary)",borderRight:"1px solid var(--color-border-primary)"},children:(0,jsx_runtime.jsx)("canvas",{ref:canvasRef})}):null}function getExposureCriteriaLabel(exposureCriteria){let exposureConfig=exposureCriteria?.exposure_config;if(!exposureConfig)return"Default ($feature_flag_called)";let displayName=(0,experiments_utils.W5)(exposureConfig);return`Custom (${displayName})`}function Exposures(){let{experimentId,exposures,exposuresLoading,exposureCriteria,isExperimentDraft}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{openExposureCriteriaModal}=(0,index_esm.useActions)(modalsLogic.l),colors=useChartColors(),chartRef=(0,react.useRef)(null),canvasRef=(0,react.useRef)(null),[isCollapsed,setIsCollapsed]=(0,react.useState)(!0),totalExposures=0,variants=[];if(exposures?.timeseries){for(let series of exposures.timeseries){let count=exposures.total_exposures?.[series.variant]||0;totalExposures+=Number(count)}for(let series of exposures.timeseries){let count=exposures.total_exposures?.[series.variant]||0;variants.push({variant:series.variant,count:Number(count),percentage:totalExposures?Number(count)/totalExposures*100:0})}}let createChart=(0,react.useCallback)(ctx=>{if(chartRef.current&&(chartRef.current.destroy(),chartRef.current=null),!exposures?.timeseries?.length)return;let labels=exposures.timeseries[0].days.map(day=>(0,dayjs.Bv)(day).format("MM/DD")),datasets=exposures.timeseries.map((series,index)=>({label:series.variant,data:series.exposure_counts,borderColor:(0,lib_colors._r)(index),backgroundColor:(0,lib_colors.qc)(index),fill:!1,tension:0,borderWidth:2,pointRadius:0}));1===exposures.timeseries[0].days.length&&(labels=[(0,dayjs.Bv)(exposures.timeseries[0].days[0]).subtract(1,"day").format("MM/DD"),...labels],datasets=datasets.map(dataset=>({...dataset,data:[0,...dataset.data]})));let config={type:"line",data:{labels,datasets},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"nearest",axis:"x"},scales:{x:{ticks:{maxTicksLimit:8,autoSkip:!0,maxRotation:0,minRotation:0},grid:{display:!0,color:colors.EXPOSURES_AXIS_LINES}},y:{beginAtZero:!0,grid:{display:!0,color:colors.EXPOSURES_AXIS_LINES}}},plugins:{legend:{display:!1,labels:{boxWidth:4,boxPadding:20,pointStyle:"dash"}},crosshair:!1}}};try{chartRef.current=new Chart.kL(ctx,config)}catch(error){console.error("Error creating chart:",error)}},[exposures,colors.EXPOSURES_AXIS_LINES]),canvasRefCallback=(0,react.useCallback)(node=>{canvasRef.current=node,node&&exposures?.timeseries?.length&&!isCollapsed&&setTimeout(()=>createChart(node),50)},[exposures,createChart,isCollapsed]);(0,react.useEffect)(()=>{canvasRef.current&&exposures?.timeseries?.length&&!isCollapsed&&createChart(canvasRef.current)},[exposures,createChart,isCollapsed]);let handleCollapseChange=(0,react.useCallback)(activeKey=>{let isOpen="cumulative-exposures"===activeKey;setIsCollapsed(!isOpen),isOpen&&canvasRef.current&&exposures?.timeseries?.length&&setTimeout(()=>createChart(canvasRef.current),100)},[exposures,createChart]);(0,react.useEffect)(()=>()=>{chartRef.current&&(chartRef.current.destroy(),chartRef.current=null)},[]);let headerContent={style:{backgroundColor:"var(--color-bg-table)"},children:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-3 metric-cell",style:{minHeight:"33px"},children:[(0,jsx_runtime.jsx)("span",{className:"metric-cell-header font-bold",children:"Exposures"}),!isExperimentDraft&&(0,jsx_runtime.jsx)("div",{className:`flex items-center gap-3 transition-opacity duration-300 ease-in-out ${isCollapsed?"opacity-100":"opacity-0"}`,style:{visibility:isCollapsed?"visible":"hidden",pointerEvents:isCollapsed?"auto":"none"},children:exposuresLoading?(0,jsx_runtime.jsx)(src.$j,{className:"text-lg"}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("span",{children:totalExposures>1e5?(0,utils.d$)(totalExposures):(0,utils.Lc)(totalExposures)}),exposures?.timeseries?.length>0&&(0,jsx_runtime.jsx)(MicroChart,{exposures:exposures}),variants.length>0&&(0,jsx_runtime.jsx)("div",{className:"ml-2 flex items-center gap-4",children:variants.map(_ref2=>{let{variant,percentage}=_ref2;return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("div",{className:"metric-cell",children:(0,jsx_runtime.jsx)(components.Aw,{experimentId:experimentId,variantKey:variant})}),(0,jsx_runtime.jsxs)("span",{className:"metric-cell",children:[percentage.toFixed(1),"%"]})]},variant)})})]})})]})};return(0,jsx_runtime.jsx)(src.JL,{onChange:handleCollapseChange,panels:[{key:"cumulative-exposures",header:headerContent,content:(0,jsx_runtime.jsxs)("div",{className:"space-y-4 bg-bg-light -m-4 p-4",children:[exposuresLoading?(0,jsx_runtime.jsx)("div",{className:"relative border rounded h-[200px] flex justify-center items-center",children:(0,jsx_runtime.jsx)(src.$j,{className:"text-5xl"})}):exposures?.timeseries?.length?(0,jsx_runtime.jsx)("div",{className:"relative h-[200px]",children:(0,jsx_runtime.jsx)("canvas",{ref:canvasRefCallback})}):(0,jsx_runtime.jsx)("div",{className:"relative border rounded h-[200px] flex justify-center items-center",children:(0,jsx_runtime.jsxs)("div",{className:"text-center",children:[(0,jsx_runtime.jsx)(posthog_icons_es.IconCorrelationAnalysis,{className:"text-3xl mb-2 text-tertiary"}),(0,jsx_runtime.jsx)("div",{className:"text-md font-semibold leading-tight mb-2",children:"No exposures yet"}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-center text-balance text-tertiary",children:"Exposures will appear here once the first participant has been exposed."}),(0,jsx_runtime.jsx)("div",{className:"flex justify-center mt-4",children:(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{fontSize:"12"}),size:"xsmall",className:"flex items-center gap-2",type:"secondary",onClick:()=>openExposureCriteriaModal(),children:"Edit exposure criteria"})})]})}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-between mb-4",children:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h3",{className:"card-secondary",children:"Exposure criteria"}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("div",{className:"text-sm font-semibold",children:getExposureCriteriaLabel(exposureCriteria)}),(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconPencil,{fontSize:"12"}),size:"xsmall",className:"flex items-center gap-2",type:"secondary",onClick:()=>openExposureCriteriaModal()})]})]})}),exposures?.timeseries.length>0&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h3",{className:"card-secondary",children:"Total exposures"}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(src.g3,{dataSource:[...exposures?.timeseries||[],{variant:"__total__",isTotal:!0}],columns:[{title:"Variant",key:"variant",render:function Variant(_,series){return series.isTotal?(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Total"}):(0,jsx_runtime.jsx)(components.Aw,{experimentId:experimentId,variantKey:series.variant})}},{title:"Exposures",key:"exposures",render:function Exposures(_,series){return series.isTotal?(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:(0,utils.Lc)(totalExposures)}):(0,utils.Lc)(exposures?.total_exposures[series.variant])}},{title:"%",key:"percentage",render:function Percentage(_,series){if(series.isTotal){let totalPercentage=0,total=0;if(exposures?.total_exposures){for(let[_,value]of Object.entries(exposures.total_exposures))total+=Number(value);if(total>0)for(let[_,count]of Object.entries(exposures.total_exposures))totalPercentage+=Number(count)/total*100}return(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:totalPercentage?`${totalPercentage.toFixed(1)}%`:"-%"})}let total=0;if(exposures?.total_exposures)for(let[_,value]of Object.entries(exposures.total_exposures))total+=Number(value);return(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:total?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(exposures?.total_exposures[series.variant]/total*100).toFixed(1),"%"]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"-%"})})}}]})})]})]})]})}]})}var Info=__webpack_require__("../../frontend/src/scenes/experiments/ExperimentView/Info.tsx"),LoadingBar=__webpack_require__("../../frontend/src/lib/lemon-ui/LoadingBar/index.ts"),LemonSlider=__webpack_require__("../../frontend/src/lib/lemon-ui/LemonSlider/index.ts"),insightLogic=__webpack_require__("../../frontend/src/scenes/insights/insightLogic.tsx");function FunnelCalculation(_ref){let{experimentId}=_ref,{minimumDetectableEffect,experiment,conversionMetrics,recommendedRunningTime,variants}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),funnelConversionRate=conversionMetrics?.totalRate*100||0,conversionRate=100*conversionMetrics.totalRate,funnelSampleSize=(0,legacyExperimentCalculations.nu)(minimumDetectableEffect,conversionRate)*variants.length,baselineConversionRate=funnelConversionRate.toFixed(1),minimumAcceptableConversionRate=(funnelConversionRate+(minimumDetectableEffect||5)).toFixed(1),recommendedSampleSize=(0,utils.Lc)(funnelSampleSize||0);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap",children:[!experiment?.start_date&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4 w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Baseline Conversion Rate"}),(0,jsx_runtime.jsxs)("div",{className:"l4",children:[baselineConversionRate,"%"]})]}),(0,jsx_runtime.jsxs)("div",{className:"mb-4 w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Minimum Acceptable Conversion Rate"}),(0,jsx_runtime.jsxs)("div",{className:"l4",children:[minimumAcceptableConversionRate,"%"]})]})]}),(0,jsx_runtime.jsxs)("div",{className:"w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Recommended Sample Size"}),(0,jsx_runtime.jsxs)("div",{className:"pb-4",children:[(0,jsx_runtime.jsxs)("span",{className:"l4",children:["~",recommendedSampleSize]})," persons"]})]}),!experiment?.start_date&&(0,jsx_runtime.jsxs)("div",{className:"w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Recommended running time"}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("span",{className:"l4",children:["~",recommendedRunningTime]})," days"]})]})]})}function TrendCalculation(_ref2){let{experimentId}=_ref2,{minimumDetectableEffect,experiment,trendResults}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),trendCount=trendResults[0]?.count||0,trendExposure=(0,legacyExperimentCalculations.j$)(minimumDetectableEffect,trendCount),baselineCount=(0,utils.Lc)(trendCount||0),minimumAcceptableCount=(0,utils.Lc)(trendCount+Math.ceil((minimumDetectableEffect||5)/100*trendCount)||0),recommendedRunningTime=(0,utils.Lc)(trendExposure||0);return(0,jsx_runtime.jsxs)("div",{className:"flex flex-wrap",children:[!experiment?.start_date&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4 w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Baseline Count"}),(0,jsx_runtime.jsx)("div",{className:"l4",children:baselineCount})]}),(0,jsx_runtime.jsxs)("div",{className:"mb-4 w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Minimum Acceptable Count"}),(0,jsx_runtime.jsx)("div",{className:"l4",children:minimumAcceptableCount})]})]}),(0,jsx_runtime.jsxs)("div",{className:"w-1/2",children:[(0,jsx_runtime.jsx)("div",{className:"card-secondary",children:"Recommended running time"}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("span",{className:"l4",children:["~",recommendedRunningTime]})," days"]})]})]})}function DataCollectionCalculator(_ref3){let{experimentId}=_ref3,{getInsightType,firstPrimaryMetric,minimumDetectableEffect,experiment,conversionMetrics}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{setExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),insightType=getInsightType(firstPrimaryMetric),insightLogicInstance=(0,insightLogic.zm)({dashboardItemId:insightType===types.dw.FUNNELS?experiments_constants.Wx.Funnels:experiments_constants.Wx.Trends,syncWithUrl:!1}),{insightProps}=(0,index_esm.useValues)(insightLogicInstance),query=null;experiment.metrics.length>0&&(query={kind:schema_general.OH.InsightVizNode,source:insightType===types.dw.FUNNELS?firstPrimaryMetric.funnels_query:firstPrimaryMetric.count_query});let funnelConversionRate=conversionMetrics?.totalRate*100||0,sliderMaxValue=0;return sliderMaxValue=insightType===types.dw.FUNNELS?100-funnelConversionRate<50?100-funnelConversionRate:50:100,(0,jsx_runtime.jsx)("div",{className:"flex",children:(0,jsx_runtime.jsxs)("div",{className:"w-full",children:[(0,jsx_runtime.jsxs)("div",{className:"mb-4 experiment-preview-row",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)("b",{children:"Minimum detectable effect"}),(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"The Minimum detectable effect represents the smallest change that you want to be able to detect in your experiment."}),(0,jsx_runtime.jsx)("div",{children:"To make things easier, we initially set this value to a reasonable default. However, we encourage you to review and adjust it based on your specific goals."}),(0,jsx_runtime.jsxs)("div",{children:["Read more in the"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/experiments/sample-size-running-time#minimum-detectable-effect-mde",children:"documentation."})]})]}),closeDelayMs:200,children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-base ml-1"})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonSlider.j,{value:minimumDetectableEffect,min:1,max:sliderMaxValue,step:1,onChange:value=>{setExperiment({parameters:{...experiment.parameters,minimum_detectable_effect:value}})},className:"w-5/6"}),(0,jsx_runtime.jsx)(src.DF,{className:"w-1/6","data-attr":"min-detectable-effect",type:"number",min:1,max:sliderMaxValue,defaultValue:5,suffix:(0,jsx_runtime.jsx)("span",{children:"%"}),value:minimumDetectableEffect,onChange:value=>{value&&setExperiment({parameters:{...experiment.parameters,minimum_detectable_effect:value}})}})]})]}),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col experiment-preview-row",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"info",className:"mb-4",children:"The calculations are based on the events received in the last 14 days. This event count may differ from what was considered in earlier estimates."}),insightType===types.dw.TRENDS?(0,jsx_runtime.jsx)(TrendCalculation,{experimentId:experimentId}):(0,jsx_runtime.jsx)(FunnelCalculation,{experimentId:experimentId}),(0,jsx_runtime.jsx)("div",{className:"hidden",children:(0,jsx_runtime.jsx)(index_esm.BindLogic,{logic:insightLogic.zm,props:insightProps,children:(0,jsx_runtime.jsx)(Query.A,{query:query,context:{insightProps},readOnly:!0})})})]})]})})}function DataCollection(){let{experimentId,experiment,getInsightType,funnelResultsPersonsTotal,actualRunningTime,minimumDetectableEffect,firstPrimaryMetric}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{openExperimentCollectionGoalModal}=(0,index_esm.useActions)(modalsLogic.l),insightType=getInsightType(firstPrimaryMetric),recommendedRunningTime=experiment?.parameters?.recommended_running_time||1,recommendedSampleSize=experiment?.parameters?.recommended_sample_size||100,experimentProgressPercent=insightType===types.dw.FUNNELS?funnelResultsPersonsTotal(0)/recommendedSampleSize*100:actualRunningTime/recommendedRunningTime*100,hasHighRunningTime=recommendedRunningTime>62,GoalTooltip=()=>experiment?.parameters?.minimum_detectable_effect?(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{children:`Based on the Minimum detectable effect of ${experiment.parameters.minimum_detectable_effect}%.`}),hasHighRunningTime&&(0,jsx_runtime.jsx)("div",{className:"mt-2",children:"Given the current data, this experiment might take a while to reach statistical significance. Please make sure events are being tracked correctly and consider if this timeline works for you."})]}),children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-base"})}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{});return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"inline-flex items-center deprecated-space-x-2",children:[(0,jsx_runtime.jsx)("h2",{className:"font-semibold text-lg mb-0",children:"Data collection"}),(0,jsx_runtime.jsx)(src.u,{title:"Estimated target for the number of participants. Actual data may reveal significance earlier or later than predicted.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-base"})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsxs)("div",{className:"w-3/5 pr-4",children:[(0,jsx_runtime.jsx)("div",{className:"mt-2 mb-1 font-semibold",children:`${experimentProgressPercent>100?100:experimentProgressPercent.toFixed(2)}% complete`}),(0,jsx_runtime.jsx)(LemonProgress.b,{className:"w-full border",bgColor:"var(--color-bg-table)",size:"medium",percent:experimentProgressPercent}),insightType===types.dw.TRENDS&&(0,jsx_runtime.jsx)("div",{className:"flex justify-between mt-0",children:(0,jsx_runtime.jsxs)("span",{className:"flex items-center text-xs",children:["CompletedÂ ",(0,jsx_runtime.jsxs)("b",{children:[actualRunningTime," of"]}),hasHighRunningTime?(0,jsx_runtime.jsx)("b",{children:"Â  > 60 days"}):(0,jsx_runtime.jsxs)("span",{children:["Â ",(0,jsx_runtime.jsx)("b",{children:recommendedRunningTime})," ",(0,experiments_utils.Du)(recommendedRunningTime,"day")]}),(0,jsx_runtime.jsx)("span",{className:"ml-1 text-xs",children:(0,jsx_runtime.jsx)(GoalTooltip,{})})]})}),insightType===types.dw.FUNNELS&&(0,jsx_runtime.jsx)("div",{className:"flex justify-between mt-0",children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-x-1 flex items-center text-xs",children:[(0,jsx_runtime.jsxs)("span",{children:["SawÂ ",(0,jsx_runtime.jsxs)("b",{children:[(0,utils.Lc)(funnelResultsPersonsTotal(0))," of"," ",(0,utils.Lc)(recommendedSampleSize)," "]})," ",(0,experiments_utils.Du)(recommendedSampleSize,"participant")]}),(0,jsx_runtime.jsx)(GoalTooltip,{})]})})]}),(0,jsx_runtime.jsx)(src.p2,{className:"my-0",vertical:!0}),(0,jsx_runtime.jsxs)("div",{className:"w-2/5 pl-4",children:[(0,jsx_runtime.jsxs)("div",{className:`text-lg font-semibold ${experiment.end_date?"mt-4":""}`,children:[minimumDetectableEffect,"%"]}),(0,jsx_runtime.jsxs)("div",{className:"text-xs deprecated-space-x-1 text-sm flex",children:[(0,jsx_runtime.jsx)("span",{children:"Minimum detectable effect"}),(0,jsx_runtime.jsx)(src.u,{title:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-2",children:[(0,jsx_runtime.jsx)("div",{children:"The Minimum detectable effect represents the smallest change that you want to be able to detect in your experiment."}),(0,jsx_runtime.jsx)("div",{children:"To make things easier, we initially set this value to a reasonable default. However, we encourage you to review and adjust it based on your specific goals."}),(0,jsx_runtime.jsxs)("div",{children:["Read more in the"," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/experiments/sample-size-running-time#minimum-detectable-effect-mde",children:"documentation."})]})]}),closeDelayMs:200,children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:"text-secondary text-base"})})]}),!experiment.end_date&&(0,jsx_runtime.jsx)("div",{className:"w-24",children:(0,jsx_runtime.jsx)(src.Jp,{className:"mt-2",size:"xsmall",type:"secondary",onClick:openExperimentCollectionGoalModal,children:(0,jsx_runtime.jsx)("span",{className:"px-0",children:"Edit"})})}),(0,jsx_runtime.jsx)(DataCollectionGoalModal,{experimentId:experimentId})]})]})]})}function DataCollectionGoalModal(_ref){let{experimentId}=_ref,{getInsightType,firstPrimaryMetric,trendMetricInsightLoading,funnelMetricInsightLoading}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{updateExperimentCollectionGoal,restoreUnmodifiedExperiment}=(0,index_esm.useActions)((0,experiments_experimentLogic.Wl)({experimentId})),{closeExperimentCollectionGoalModal}=(0,index_esm.useActions)(modalsLogic.l),{isExperimentCollectionGoalModalOpen}=(0,index_esm.useValues)(modalsLogic.l),isInsightLoading=getInsightType(firstPrimaryMetric)===types.dw.TRENDS?trendMetricInsightLoading:funnelMetricInsightLoading;return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isExperimentCollectionGoalModalOpen,onClose:closeExperimentCollectionGoalModal,width:550,title:"Recalculate estimated sample size",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-exposure-form",type:"secondary",onClick:()=>{restoreUnmodifiedExperiment(),closeExperimentCollectionGoalModal()},children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{form:"edit-experiment-exposure-form",onClick:()=>{updateExperimentCollectionGoal(),closeExperimentCollectionGoalModal()},type:"primary","data-attr":"create-annotation-submit",children:"Save"})]}),children:isInsightLoading?(0,jsx_runtime.jsxs)("div",{className:"flex flex-col flex-1 justify-center items-center mb-6",children:[(0,jsx_runtime.jsx)(LoadingBar.F,{}),(0,jsx_runtime.jsxs)("div",{className:"text-xs text-secondary w-60",children:[(0,jsx_runtime.jsx)("span",{className:"mr-1",children:"Fetching past events for the estimation"}),(0,jsx_runtime.jsx)(components.QT,{})]})]}):(0,jsx_runtime.jsx)(DataCollectionCalculator,{experimentId:experimentId})})}function LegacyExperimentHeader(){return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("div",{className:"w-1/2 mt-8 xl:mt-0",children:(0,jsx_runtime.jsx)(DataCollection,{})})})}var FeatureFlagReleaseConditions=__webpack_require__("../../frontend/src/scenes/feature-flags/FeatureFlagReleaseConditions.tsx"),groupsModel=__webpack_require__("../../frontend/src/models/groupsModel.ts");function ReleaseConditionsModal(_ref){var _experiment$feature_f,_featureFlag$filters;let{experimentId}=_ref,{experiment}=(0,index_esm.useValues)((0,experiments_experimentLogic.Wl)({experimentId})),{closeReleaseConditionsModal}=(0,index_esm.useActions)(modalsLogic.l),{isReleaseConditionsModalOpen}=(0,index_esm.useValues)(modalsLogic.l),_featureFlagLogic=(0,featureFlagLogic.hk)({id:null!==(_experiment$feature_f=experiment.feature_flag?.id)&&void 0!==_experiment$feature_f?_experiment$feature_f:null}),{featureFlag,nonEmptyVariants}=(0,index_esm.useValues)(_featureFlagLogic),{setFeatureFlagFilters,saveSidebarExperimentFeatureFlag}=(0,index_esm.useActions)(_featureFlagLogic);return(0,jsx_runtime.jsx)(src.fQ,{isOpen:isReleaseConditionsModalOpen,onClose:closeReleaseConditionsModal,width:600,title:"Change release conditions",footer:(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(src.Jp,{type:"secondary",onClick:closeReleaseConditionsModal,children:"Cancel"}),(0,jsx_runtime.jsx)(src.Jp,{onClick:()=>{saveSidebarExperimentFeatureFlag(featureFlag),closeReleaseConditionsModal()},type:"primary",children:"Save"})]}),children:(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-4",children:[(0,jsx_runtime.jsx)(src.Vp,{type:"info",children:"Adjusting user targeting may impact the validity of your results. Adjust only if you're aware of how changes will affect your experiment."}),(0,jsx_runtime.jsx)(FeatureFlagReleaseConditions.I,{id:`${experiment.feature_flag?.id}`,filters:null!==(_featureFlag$filters=featureFlag?.filters)&&void 0!==_featureFlag$filters?_featureFlag$filters:[],onChange:setFeatureFlagFilters,nonEmptyFeatureFlagVariants:nonEmptyVariants})]})})}function ReleaseConditionsTable(){let{experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{reportExperimentReleaseConditionsViewed}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{openReleaseConditionsModal}=(0,index_esm.useActions)(modalsLogic.l),{aggregationLabel}=(0,index_esm.useValues)(groupsModel.$),columns=[{key:"key",title:"",render:function Key(_,_item,index){return(0,jsx_runtime.jsx)("div",{className:"font-semibold",children:`Set ${index+1}`})}},{key:"rollout_percentage",title:"Rollout",render:function Key(_,item){let aggregationTargetName=null!=experiment.filters.aggregation_group_type_index?aggregationLabel(experiment.filters.aggregation_group_type_index).plural:"users",releaseText=`${item.rollout_percentage}% of ${aggregationTargetName}`;return(0,jsx_runtime.jsx)("div",{children:releaseText.startsWith("100% of")?(0,jsx_runtime.jsx)(src.oe,{type:"highlight",children:releaseText}):releaseText})}},{key:"variant",title:"Override",render:function Key(_,item){return(0,jsx_runtime.jsx)("div",{children:item.variant||"--"})}}];return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("div",{className:"flex",children:[(0,jsx_runtime.jsx)("div",{className:"w-1/2",children:(0,jsx_runtime.jsx)("h2",{className:"font-semibold text-lg",children:"Release conditions"})}),(0,jsx_runtime.jsx)("div",{className:"w-1/2 flex flex-col justify-end",children:(0,jsx_runtime.jsx)("div",{className:"ml-auto mb-2",children:(0,jsx_runtime.jsx)(src.Jp,{icon:(0,jsx_runtime.jsx)(posthog_icons_es.IconFlag,{}),onClick:()=>{openReleaseConditionsModal(),reportExperimentReleaseConditionsViewed(experiment.id)},type:"secondary",size:"xsmall",className:"font-semibold",children:"Manage release conditions"})})})]}),(0,jsx_runtime.jsx)(src.g3,{loading:!1,columns:columns,dataSource:experiment.feature_flag?.filters.groups||[]})]})}let MetricsTab=()=>{let{experiment,legacyPrimaryMetricsResults,firstPrimaryMetric,primaryMetricsLengthWithSharedMetrics,hasMinimumExposureForResults,usesNewQueryRunner}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),hasSomeResults=legacyPrimaryMetricsResults?.some(result=>result?.insight),hasSinglePrimaryMetric=1===primaryMetricsLengthWithSharedMetrics,firstPrimaryMetricResult=legacyPrimaryMetricsResults?.[0],hasLegacyResults=legacyPrimaryMetricsResults.some(result=>null!=result),showResultDetails=hasSomeResults&&hasMinimumExposureForResults&&hasSinglePrimaryMetric&&firstPrimaryMetric&&firstPrimaryMetricResult;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[usesNewQueryRunner&&(0,jsx_runtime.jsx)("div",{className:"w-full mb-4",children:(0,jsx_runtime.jsx)(Exposures,{})}),hasSinglePrimaryMetric&&hasMinimumExposureForResults&&(0,jsx_runtime.jsx)("div",{className:"mb-4 mt-2",children:(0,jsx_runtime.jsx)(Overview,{metricUuid:firstPrimaryMetric?.uuid||""})}),(0,experiments_utils.cH)(experiment)||hasLegacyResults?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(MetricsViewLegacy,{isSecondary:!1}),showResultDetails&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"pb-4",children:(0,jsx_runtime.jsx)(SummaryTable.H,{metric:firstPrimaryMetric,displayOrder:0,isSecondary:!1})}),(0,experiments_utils.C1)(firstPrimaryMetricResult)?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(components.bD,{result:firstPrimaryMetricResult,size:"xsmall"})}),(0,jsx_runtime.jsx)("div",{className:"pb-4",children:(0,jsx_runtime.jsx)(components.TX,{result:firstPrimaryMetricResult||null,showTable:!0})})]}):(0,jsx_runtime.jsx)(ResultsBreakdown,{result:firstPrimaryMetricResult,experiment:experiment,metricUuid:firstPrimaryMetric?.uuid||"",isPrimary:!0,children:_ref=>{let{query,breakdownResults,breakdownResultsLoading,exposureDifference,breakdownLastRefresh}=_ref;return(0,jsx_runtime.jsxs)("div",{children:[breakdownResultsLoading&&(0,jsx_runtime.jsx)(ResultsBreakdownSkeleton,{}),query&&breakdownResults&&(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsx)(ExploreAsInsightButton,{query:query})}),(0,jsx_runtime.jsx)(ResultsInsightInfoBanner,{exposureDifference:exposureDifference}),(0,jsx_runtime.jsx)("div",{className:"pb-4",children:(0,jsx_runtime.jsx)(ResultsQuery,{query:query,breakdownResults:breakdownResults,breakdownLastRefresh:breakdownLastRefresh})})]})]})}})]}),(0,jsx_runtime.jsx)(MetricsViewLegacy,{isSecondary:!0})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(Metrics,{isSecondary:!1}),(0,jsx_runtime.jsx)(Metrics,{isSecondary:!0})]})]})},CodeTab=()=>{let{experiment}=(0,index_esm.useValues)(experiments_experimentLogic.Wl);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"web"===experiment.type?(0,jsx_runtime.jsx)(WebExperimentImplementationDetails,{experiment:experiment}):(0,jsx_runtime.jsx)(ExperimentImplementationDetails.aK,{experiment:experiment})})},VariantsTab=()=>(0,jsx_runtime.jsxs)("div",{className:"deprecated-space-y-8 mt-2",children:[(0,jsx_runtime.jsx)(ReleaseConditionsTable,{}),(0,jsx_runtime.jsx)(DistributionTable,{})]});function ExperimentView(){let{experimentLoading,experimentId,experiment,usesNewQueryRunner,isExperimentDraft}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),{setExperiment,updateExperimentMetrics,addSharedMetricsToExperiment,removeSharedMetricFromExperiment}=(0,index_esm.useActions)(experiments_experimentLogic.Wl),{closeExperimentMetricModal}=(0,index_esm.useActions)(experimentMetricModalLogic),{closeSharedMetricModal}=(0,index_esm.useActions)(sharedMetricModalLogic),[activeTabKey,setActiveTabKey]=(0,react.useState)("metrics"),isUnifiedCreateFormEnabled=(0,useFeatureFlag.y)("EXPERIMENTS_UNIFIED_CREATE_FORM","test");return!experimentLoading&&(0,experimentsLogic.Ot)(experiment)===types.mN.Draft&&isUnifiedCreateFormEnabled?(0,jsx_runtime.jsx)(CreateExperiment,{draftExperiment:experiment}):(0,jsx_runtime.jsxs)(SceneContent._,{children:[(0,jsx_runtime.jsx)(components.nt,{}),experimentLoading?(0,jsx_runtime.jsx)(components.Gu,{}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[usesNewQueryRunner?(0,jsx_runtime.jsx)(Info.k,{}):(0,jsx_runtime.jsx)(LegacyExperimentInfo,{}),usesNewQueryRunner?(0,jsx_runtime.jsx)(ExperimentHeader,{}):(0,jsx_runtime.jsx)(LegacyExperimentHeader,{}),(0,jsx_runtime.jsx)(src.TP,{activeKey:activeTabKey,onChange:key=>setActiveTabKey(key),sceneInset:!0,tabs:[{key:"metrics",label:"Metrics",content:(0,jsx_runtime.jsx)(MetricsTab,{})},...isExperimentDraft?[]:[{key:"code",label:"Code",content:(0,jsx_runtime.jsx)(CodeTab,{})}],{key:"variants",label:"Variants",content:(0,jsx_runtime.jsx)(VariantsTab,{})},{key:"history",label:"History",content:(0,jsx_runtime.jsx)(ActivityLog.DA,{scope:types.jc.EXPERIMENT,id:experimentId})}]}),usesNewQueryRunner?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(MetricSourceModal,{}),(0,jsx_runtime.jsx)(ExperimentMetricModal,{experiment:experiment,onSave:(metric,context)=>{var _experiment$context$o;let metrics=experiment[context.field],isNew=!metrics.some(_ref2=>{let{uuid}=_ref2;return uuid===metric.uuid});setExperiment({[context.field]:isNew?[...metrics,metric]:metrics.map(m=>m.uuid===metric.uuid?metric:m),...isNew&&{[context.orderingField]:[...null!==(_experiment$context$o=experiment[context.orderingField])&&void 0!==_experiment$context$o?_experiment$context$o:[],metric.uuid]}}),updateExperimentMetrics(),closeExperimentMetricModal()},onDelete:(metric,context)=>{metric.uuid&&(setExperiment({[context.field]:experiment[context.field].filter(m=>m.uuid!==metric.uuid),[context.orderingField]:(0,experiments_utils.jz)(experiment,metric.uuid,"secondary"===context.type)}),updateExperimentMetrics(),closeExperimentMetricModal())}}),(0,jsx_runtime.jsx)(SharedMetricModal,{experiment:experiment,onSave:(metrics,context)=>{var _experiment$context$o2;let existingOrderingArray=null!==(_experiment$context$o2=experiment[context.orderingField])&&void 0!==_experiment$context$o2?_experiment$context$o2:[],newMetricUuids=metrics.map(metric=>metric.query.uuid).filter(uuid=>!existingOrderingArray.includes(uuid)),newOrderingArray=[...existingOrderingArray,...newMetricUuids];setExperiment({[context.orderingField]:newOrderingArray}),addSharedMetricsToExperiment(metrics.map(_ref3=>{let{id}=_ref3;return id}),{type:context.type}),closeSharedMetricModal()},onDelete:(metric,context)=>{let newOrderingArray=(0,experiments_utils.jz)(experiment,metric.query.uuid,"secondary"===context.type);setExperiment({[context.orderingField]:newOrderingArray}),removeSharedMetricFromExperiment(metric.id),closeSharedMetricModal()}}),(0,jsx_runtime.jsx)(ExposureCriteriaModal,{}),(0,jsx_runtime.jsx)(RunningTimeCalculatorModal,{})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LegacyMetricSourceModal,{experimentId:experimentId,isSecondary:!0}),(0,jsx_runtime.jsx)(LegacyMetricSourceModal,{experimentId:experimentId,isSecondary:!1}),(0,jsx_runtime.jsx)(LegacySharedMetricModal,{experimentId:experimentId,isSecondary:!0}),(0,jsx_runtime.jsx)(LegacySharedMetricModal,{experimentId:experimentId,isSecondary:!1}),(0,jsx_runtime.jsx)(LegacyMetricModal,{experimentId:experimentId,isSecondary:!0}),(0,jsx_runtime.jsx)(LegacyMetricModal,{experimentId:experimentId,isSecondary:!1})]}),(0,jsx_runtime.jsx)(DistributionModal,{experimentId:experimentId}),(0,jsx_runtime.jsx)(ReleaseConditionsModal,{experimentId:experimentId}),(0,jsx_runtime.jsx)(components.WV,{experimentId:experimentId}),(0,jsx_runtime.jsx)(components.jQ,{experimentId:experimentId}),(0,jsx_runtime.jsx)(VariantDeltaTimeseries,{})]})]})}let scene={component:Experiment,logic:experiments_experimentLogic.Wl,paramsToProps:_ref=>{let{params:{id,formMode}}=_ref;return{experimentId:"new"===id?"new":parseInt(id,10),formMode:formMode||("new"===id?experiments_experimentLogic.SI.create:experiments_experimentLogic.SI.update)}}};function Experiment(){let{formMode,experimentMissing}=(0,index_esm.useValues)(experiments_experimentLogic.Wl),isUnifiedCreateFormEnabled=(0,useFeatureFlag.y)("EXPERIMENTS_UNIFIED_CREATE_FORM","test");return experimentMissing?(0,jsx_runtime.jsx)(NotFound.T,{object:"experiment"}):isUnifiedCreateFormEnabled&&formMode===experiments_experimentLogic.SI.create?(0,jsx_runtime.jsx)(CreateExperiment,{}):[experiments_experimentLogic.SI.create,experiments_experimentLogic.SI.duplicate].includes(formMode)?(0,jsx_runtime.jsx)(ExperimentForm,{}):(0,jsx_runtime.jsx)(ExperimentView,{})}},"../../frontend/src/scenes/experiments/ExperimentImplementationDetails.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{aK:()=>ExperimentImplementationDetails,JY:()=>OPTIONS});var react=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js"),posthog_icons_es=__webpack_require__("../../node_modules/.pnpm/@posthog+icons@0.33.0_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("../../frontend/@posthog/lemon-ui/src/index.ts"),icons=__webpack_require__("../../frontend/src/lib/lemon-ui/icons/index.ts"),types=__webpack_require__("../../frontend/src/types.ts"),CodeSnippet=__webpack_require__("../../frontend/src/lib/components/CodeSnippet/index.ts"),jsx_runtime=__webpack_require__("../../node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function ServerSideWarning(){return(0,jsx_runtime.jsx)("div",{className:"warning",children:(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("b",{children:"Warning:"})," Server side experiment metrics require you to manually send the feature flag information."," ",(0,jsx_runtime.jsx)(src.rU,{to:"https://posthog.com/docs/experiments/adding-experiment-code",target:"_blank",children:"See this tutorial for more information."})]})})}function AndroidSnippet(_ref){let{flagKey,variant}=_ref;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Kotlin,wrap:!0,children:`if (PostHog.getFeatureFlag("${flagKey}") == "${variant}") {
    // do something
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`})})}function IOSSnippet(_ref2){let{flagKey,variant}=_ref2;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Swift,wrap:!0,children:`if (PostHogSDK.shared.getFeatureFlag("${flagKey}") as? String == "${variant}") {
    // do something
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`})})}function NodeJSSnippet(_ref3){let{flagKey,variant}=_ref3;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.JavaScript,wrap:!0,children:`const experimentFlagValue = await client.getFeatureFlag('${flagKey}', 'user distinct id')

if (experimentFlagValue === '${variant}' ) {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}function JSSnippet(_ref4){let{flagKey,variant}=_ref4;return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.JavaScript,wrap:!0,children:`if (posthog.getFeatureFlag('${flagKey}') === '${variant}') {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`}),(0,jsx_runtime.jsx)("div",{className:"mt-4 mb-1",children:(0,jsx_runtime.jsx)("b",{children:"Test that it works"})}),(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.JavaScript,wrap:!0,children:`posthog.featureFlags.overrideFeatureFlags({ flags: {'${flagKey}': '${variant}'} })`})]})}function ReactSnippet(_ref5){let{flagKey,variant}=_ref5;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.JavaScript,wrap:!0,children:`// You can either use the useFeatureFlagVariantKey hook,
// or you can use the feature flags component - https://posthog.com/docs/libraries/react#feature-flags-react-component

// Method one: using the useFeatureFlagVariantKey hook
import { useFeatureFlagVariantKey } from 'posthog-js/react'

function App() {
    const variant = useFeatureFlagVariantKey('${flagKey}')
    if (variant === '${variant}') {
        // do something
    }
}

// Method two: using the feature flags component
import { PostHogFeature } from 'posthog-js/react'

function App() {
    return (
        <PostHogFeature flag='${flagKey}' match='${variant}'>
            <div>
                {/* the component to show */}
            </div>
        </PostHogFeature>
    )
}

// You can also test your code by overriding the feature flag:
posthog.featureFlags.overrideFeatureFlags({ flags: {'${flagKey}': '${variant}'} })`})})}function RNSnippet(_ref6){let{flagKey,variant}=_ref6;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.JavaScript,wrap:!0,children:`if (posthog.getFeatureFlag('${flagKey}') === '${variant}') {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`})})}function PHPSnippet(_ref7){let{flagKey,variant}=_ref7;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.PHP,wrap:!0,children:`if (PostHog::getFeatureFlag('${flagKey}', 'user distinct id') == '${variant}') {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}function GolangSnippet(_ref8){let{flagKey,variant}=_ref8;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Go,wrap:!0,children:`experimentFlagValue, err := client.GetFeatureFlag(posthog.FeatureFlagPayload{
    Key:        '${flagKey}',
    DistinctId: "distinct-id",
})
if err != nil {
    // Handle error (e.g. capture error and fallback to default behaviour)
}
if experimentFlagValue == '${variant}' {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}function FlutterSnippet(_ref9){let{flagKey,variant}=_ref9,variantSuffix=` == '${variant}'`;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Dart,wrap:!0,children:`if (await Posthog().getFeatureFlag('${flagKey}')${variantSuffix}) {
  // Do something differently for this user
} else {
  // It's a good idea to let control variant always be the default behaviour,
  // so if something goes wrong with flag evaluation, you don't break your app.
}
            `})})}function RubySnippet(_ref10){let{flagKey,variant}=_ref10;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Ruby,wrap:!0,children:`experimentFlagValue = posthog.get_feature_flag('${flagKey}', 'user distinct id')


if experimentFlagValue == '${variant}'
    # Do something differently for this user
else
    # It's a good idea to let control variant always be the default behaviour,
    # so if something goes wrong with flag evaluation, you don't break your app.
end
`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}function PythonSnippet(_ref11){let{flagKey,variant}=_ref11;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Python,wrap:!0,children:`experiment_flag_value = posthog.get_feature_flag("${flagKey}", "user_distinct_id"):

if experiment_flag_value == '${variant}':
    # Do something differently for this user
else:
    # It's a good idea to let control variant always be the default behaviour,
    # so if something goes wrong with flag evaluation, you don't break your app.
`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}function JavaSnippet(_ref12){let{flagKey,variant}=_ref12;return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CodeSnippet.O,{language:CodeSnippet.S.Java,wrap:!0,children:`Object flagValue = postHog.getFeatureFlag("user distinct id", "${flagKey}");
if ("${variant}".equals(flagValue)) {
    // Do something differently for this user
} else {
    // It's a good idea to let control variant always be the default behaviour,
    // so if something goes wrong with flag evaluation, you don't break your app.
}
`}),(0,jsx_runtime.jsx)(ServerSideWarning,{})]})}let UTM_TAGS="?utm_medium=in-product&utm_campaign=experiment",DOC_BASE_URL="https://posthog.com/docs/",FF_ANCHOR="#feature-flags",LibraryType=function(LibraryType){return LibraryType.Client="Client",LibraryType.Server="Server",LibraryType}({}),OPTIONS=[{value:"JavaScript",key:types.lh.JS_WEB,documentationLink:`${DOC_BASE_URL}libraries/js${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.RQ,Snippet:JSSnippet,type:LibraryType.Client},{value:"Android",key:types.lh.ANDROID,documentationLink:`${DOC_BASE_URL}libraries/android${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.Kp,Snippet:AndroidSnippet,type:LibraryType.Client},{value:"Go",key:types.lh.GO,documentationLink:`${DOC_BASE_URL}libraries/go${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.GH,Snippet:GolangSnippet,type:LibraryType.Server},{value:"Flutter",key:types.lh.FLUTTER,documentationLink:`${DOC_BASE_URL}libraries/flutter${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.D_,Snippet:FlutterSnippet,type:LibraryType.Client},{value:"iOS",key:types.lh.IOS,documentationLink:`${DOC_BASE_URL}libraries/ios${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.in,Snippet:IOSSnippet,type:LibraryType.Client},{value:"Node.js",key:types.lh.NODE_JS,documentationLink:`${DOC_BASE_URL}libraries/node${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.fS,Snippet:NodeJSSnippet,type:LibraryType.Server},{value:"PHP",key:types.lh.PHP,documentationLink:`${DOC_BASE_URL}libraries/php${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.W7,Snippet:PHPSnippet,type:LibraryType.Server},{value:"Python",key:types.lh.PYTHON,documentationLink:`${DOC_BASE_URL}libraries/python${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.Bm,Snippet:PythonSnippet,type:LibraryType.Server},{value:"React",key:types.lh.REACT,documentationLink:`${DOC_BASE_URL}libraries/react${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.RQ,Snippet:ReactSnippet,type:LibraryType.Client},{value:"ReactNative",key:types.lh.REACT_NATIVE,documentationLink:`${DOC_BASE_URL}libraries/react-native${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.RQ,Snippet:RNSnippet,type:LibraryType.Client},{value:"Ruby",key:types.lh.RUBY,documentationLink:`${DOC_BASE_URL}libraries/ruby${UTM_TAGS}${FF_ANCHOR}`,Icon:icons.gz,Snippet:RubySnippet,type:LibraryType.Server},{value:"Java",key:types.lh.JAVA,documentationLink:`${DOC_BASE_URL}libraries/java${UTM_TAGS}${FF_ANCHOR}`,Icon:posthog_icons_es.IconServer,Snippet:JavaSnippet,type:LibraryType.Server}];function CodeLanguageSelect(_ref){let{selectedOptionValue,selectOption}=_ref;return(0,jsx_runtime.jsx)(src.Yv,{size:"small",className:"min-w-[7.5rem]",onSelect:selectOption,value:selectedOptionValue,options:[{title:"Client libraries",options:OPTIONS.filter(option=>option.type==LibraryType.Client).map(_ref2=>{let{Icon,value}=_ref2;return{value,label:value,labelInMenu:(0,jsx_runtime.jsxs)("div",{className:"flex items-center deprecated-space-x-2",children:[(0,jsx_runtime.jsx)(Icon,{}),(0,jsx_runtime.jsx)("span",{children:value})]})}})},{title:"Server libraries",options:OPTIONS.filter(option=>option.type==LibraryType.Server).map(_ref3=>{let{Icon,value}=_ref3;return{value,label:value,labelInMenu:(0,jsx_runtime.jsxs)("div",{className:"flex items-center deprecated-space-x-2",children:[(0,jsx_runtime.jsx)(Icon,{}),(0,jsx_runtime.jsx)("span",{children:value})]})}})}]})}function ExperimentImplementationDetails(_ref4){var _experiment$parameter,_experiment$feature_f;let{experiment}=_ref4,defaultVariant=null!==(_experiment$parameter=experiment?.parameters?.feature_flag_variants?.[1]?.key)&&void 0!==_experiment$parameter?_experiment$parameter:"test",[currentVariant,setCurrentVariant]=(0,react.useState)(defaultVariant),[defaultSelectedOption]=OPTIONS,[selectedOption,setSelectedOption]=(0,react.useState)(defaultSelectedOption);return(0,jsx_runtime.jsx)("div",{className:"mb-4",children:(0,jsx_runtime.jsx)("div",{className:"border rounded bg-surface-primary",children:(0,jsx_runtime.jsxs)("div",{className:"p-6 deprecated-space-y-4",children:[(0,jsx_runtime.jsxs)("div",{className:"flex justify-between",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center",children:[(0,jsx_runtime.jsx)("span",{className:"mr-2",children:"Variant group"}),(0,jsx_runtime.jsx)(src.Yv,{size:"small",className:"min-w-[5rem]",onSelect:setCurrentVariant,value:currentVariant,options:(experiment?.parameters?.feature_flag_variants||[]).map(variant=>({value:variant.key,label:variant.key}))})]}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)(CodeLanguageSelect,{selectOption:selectedValue=>{let option=OPTIONS.find(option=>option.value===selectedValue);option&&setSelectedOption(option)},selectedOptionValue:selectedOption.value})})]}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("div",{className:"mb-1",children:(0,jsx_runtime.jsx)("b",{children:"Implement your experiment in code"})}),(0,jsx_runtime.jsx)("div",{className:"mb-1",children:(0,jsx_runtime.jsx)(selectedOption.Snippet,{variant:currentVariant,flagKey:null!==(_experiment$feature_f=experiment?.feature_flag?.key)&&void 0!==_experiment$feature_f?_experiment$feature_f:""})}),(0,jsx_runtime.jsx)(src.rU,{subtle:!0,to:selectedOption.documentationLink,target:"_blank",children:"See the docs for more implementation information."})]})]})})})}},"../../node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/cjs.js!../../node_modules/.pnpm/postcss-loader@4.3.0_postcss@8.5.6_webpack@5.88.2/node_modules/postcss-loader/dist/cjs.js!../../node_modules/.pnpm/sass-loader@10.3.1_sass@1.56.0_webpack@5.88.2/node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[2].use[3]!../../frontend/src/scenes/experiments/MetricsView/new/MetricRowGroup.scss":(module,exports,__webpack_require__)=>{(exports=__webpack_require__("../../node_modules/.pnpm/css-loader@3.6.0_webpack@5.88.2/node_modules/css-loader/dist/runtime/api.js")(!1)).push([module.id,".metric-cell{font-size:13px;font-weight:500}.metric-cell,.metric-cell-header{color:var(--color-text-secondary)}.metric-cell-header{font-size:.75rem;letter-spacing:.03125rem;text-transform:uppercase}",""]),module.exports=exports}}]);
//# sourceMappingURL=3306.4ed0b40d.iframe.bundle.js.map