"use strict";(self.webpackChunkposthog=self.webpackChunkposthog||[]).push([[13222],{"./frontend/src/scenes/batch_exports/BatchExportEditForm.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{pU:()=>BatchExportGeneralEditFields,g3:()=>BatchExportsEditFields,mf:()=>BatchExportsEditForm});var posthog_icons_es=__webpack_require__("./node_modules/.pnpm/@posthog+icons@0.7.0_react-dom@18.2.0_react@18.2.0/node_modules/@posthog/icons/dist/posthog-icons.es.js"),src=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),index_esm=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),lib=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),constants=__webpack_require__("./frontend/src/lib/constants.tsx"),LemonBanner=__webpack_require__("./frontend/src/lib/lemon-ui/LemonBanner/index.ts"),LemonCalendarSelect=__webpack_require__("./frontend/src/lib/lemon-ui/LemonCalendar/LemonCalendarSelect.tsx"),LemonField=__webpack_require__("./frontend/src/lib/lemon-ui/LemonField/index.ts"),LemonFileInput=__webpack_require__("./frontend/src/lib/lemon-ui/LemonFileInput/LemonFileInput.tsx"),LemonInputSelect=__webpack_require__("./frontend/src/lib/lemon-ui/LemonInputSelect/LemonInputSelect.tsx"),LemonSkeleton=__webpack_require__("./frontend/src/lib/lemon-ui/LemonSkeleton/index.ts"),Tooltip=__webpack_require__("./frontend/src/lib/lemon-ui/Tooltip/index.ts"),featureFlagLogic=__webpack_require__("./frontend/src/lib/logic/featureFlagLogic.ts"),userLogic=__webpack_require__("./frontend/src/scenes/userLogic.ts"),kea_router_lib=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),api=__webpack_require__("./frontend/src/lib/api.ts"),dayjs=__webpack_require__("./frontend/src/lib/dayjs.ts"),sceneTypes=__webpack_require__("./frontend/src/scenes/sceneTypes.ts"),urls=__webpack_require__("./frontend/src/scenes/urls.ts"),batchExportLogic=__webpack_require__("./frontend/src/scenes/batch_exports/batchExportLogic.ts");let batchExportFormFields=function(isNew,_ref){let{name,destination,interval,start_at,end_at,paused,...config}=_ref,{isPipeline}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{name:name||isPipeline?"":"Please enter a name",destination:destination?"":"Please select a destination",interval:interval?"":"Please select a frequency",paused:"",start_at:"",end_at:"",..."Postgres"===destination?{user:isNew?config.user?"":"This field is required":"",password:isNew?config.password?"":"This field is required":"",host:config.host?"":"This field is required",port:config.port?"":"This field is required",database:config.database?"":"This field is required",schema:config.schema?"":"This field is required",table_name:config.table_name?"":"This field is required",has_self_signed_cert:!1,exclude_events:"",include_events:""}:"Redshift"===destination?{user:isNew?config.user?"":"This field is required":"",password:isNew?config.password?"":"This field is required":"",host:config.host?"":"This field is required",port:config.port?"":"This field is required",database:config.database?"":"This field is required",schema:config.schema?"":"This field is required",table_name:config.table_name?"":"This field is required",properties_data_type:"",exclude_events:"",include_events:""}:"S3"===destination?{bucket_name:config.bucket_name?"":"This field is required",region:config.region?"":"This field is required",prefix:config.prefix?"":"This field is required",aws_access_key_id:isNew?config.aws_access_key_id?"":"This field is required":"",aws_secret_access_key:isNew?config.aws_secret_access_key?"":"This field is required":"",compression:"",encryption:"",file_format:isNew?config.file_format?"":"This field is required":"",kms_key_id:config.kms_key_id||"aws:kms"!=config.encryption?"":"This field is required",exclude_events:"",include_events:"",endpoint_url:null}:"BigQuery"===destination?{json_config_file:isNew?config.json_config_file?config.project_id&&config.private_key&&config.private_key_id&&config.client_email&&config.token_uri?"":"The config file is not valid":"This field is required":"",dataset_id:config.dataset_id?"":"This field is required",table_id:config.table_id?"":"This field is required",exclude_events:"",include_events:"",use_json_type:""}:"HTTP"===destination?{url:config.url?"":"This field is required",token:config.token?"":"This field is required",exclude_events:"",include_events:""}:"Snowflake"===destination?{account:config.account?"":"This field is required",database:config.database?"":"This field is required",warehouse:config.warehouse?"":"This field is required",user:isNew?config.user?"":"This field is required":"",password:isNew?config.password?"":"This field is required":"",schema:config.schema?"":"This field is required",table_name:config.table_name?"":"This field is required",role:"",exclude_events:"",include_events:""}:{}}},batchExportsEditLogic=(0,index_esm.kea)([(0,index_esm.props)({}),(0,index_esm.key)(_ref2=>{let{id}=_ref2;return id}),(0,index_esm.path)(key=>["scenes","batch_exports","batchExportsEditLogic",key]),(0,index_esm.connect)(props=>({values:[(0,batchExportLogic.B)(props),["batchExportConfig","batchExportConfigLoading"]],actions:[(0,batchExportLogic.B)(props),["loadBatchExportConfig","loadBatchExportConfigSuccess"]]})),(0,index_esm.actions)({cancelEditing:!0}),(0,lib.forms)(_ref3=>{let{props,actions}=_ref3;return{batchExportConfigForm:{defaults:{name:""},errors:form=>batchExportFormFields("new"===props.id,form),submit:async _ref4=>{var _start_at$toISOString,_end_at$toISOString;let{name,destination,interval,start_at,end_at,paused,...config}=_ref4,data={paused,name,interval,start_at:null!==(_start_at$toISOString=start_at?.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=end_at?.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null,destination:"Postgres"===destination?{type:"Postgres",config:config}:"S3"===destination?{type:"S3",config:config}:"Redshift"===destination?{type:"Redshift",config:config}:"BigQuery"===destination?{type:"BigQuery",config:config}:"HTTP"===destination?{type:"HTTP",config:config}:{type:"Snowflake",config:config}},result="new"===props.id?await api.ZP.batchExports.create(data):await api.ZP.batchExports.update(props.id,data);await new Promise(resolve=>setTimeout(resolve,1e3)),actions.resetBatchExportConfigForm(),kea_router_lib.router.actions.replace(urls.j.batchExport(result.id))}}}}),(0,index_esm.listeners)(_ref5=>{let{values,props,actions}=_ref5;return{cancelEditing:()=>{values.isNew?kea_router_lib.router.actions.push(urls.j.batchExports()):kea_router_lib.router.actions.push(urls.j.batchExport(props.id))},setBatchExportConfigFormValue:async _ref6=>{let{name,value}=_ref6;if("json_config_file"===name[0]&&value)try{let loadedFile=await new Promise((resolve,reject)=>{let filereader=new FileReader;filereader.onload=e=>resolve(e.target?.result),filereader.onerror=e=>reject(e),filereader.readAsText(value[0])}),jsonConfig=JSON.parse(loadedFile);actions.setBatchExportConfigFormValues({...values.batchExportConfigForm,project_id:jsonConfig.project_id,private_key:jsonConfig.private_key,private_key_id:jsonConfig.private_key_id,client_email:jsonConfig.client_email,token_uri:jsonConfig.token_uri})}catch(e){actions.setBatchExportConfigFormManualErrors({json_config_file:"The config file is not valid"})}},loadBatchExportConfigSuccess:_ref7=>{let{batchExportConfig}=_ref7;if(!batchExportConfig)return;let destination=batchExportConfig.destination.type,transformedConfig={...batchExportConfig,destination,start_at:batchExportConfig.start_at?(0,dayjs.Bv)(batchExportConfig.start_at):null,end_at:batchExportConfig.end_at?(0,dayjs.Bv)(batchExportConfig.end_at):null,...batchExportConfig.destination.config},validFormFields=Object.keys(batchExportFormFields("new"===props.id,transformedConfig));Object.keys(transformedConfig).forEach(key=>{validFormFields.includes(key)||delete transformedConfig[key]}),actions.resetBatchExportConfigForm(transformedConfig)}}}),(0,index_esm.selectors)({isNew:[()=>[(_,props)=>props],props=>"new"===props.id],breadcrumbs:[s=>[s.batchExportConfig,s.isNew],(config,isNew)=>{var _config$id;return[{key:sceneTypes.x.BatchExports,name:"Batch Exports",path:urls.j.batchExports()},...isNew?[{key:"new",name:"New"}]:[{key:null!==(_config$id=config?.id)&&void 0!==_config$id?_config$id:"loading",name:config?.name,path:config?.id?urls.j.batchExport(config.id):void 0},{key:"edit",name:"Edit"}]]}]}),(0,index_esm.afterMount)(_ref8=>{let{values,actions}=_ref8;values.isNew||(values.batchExportConfig?actions.loadBatchExportConfigSuccess(values.batchExportConfig):actions.loadBatchExportConfig())}),(0,kea_router_lib.beforeUnload)(_ref9=>{let{values}=_ref9;return{enabled:()=>values.batchExportConfigFormChanged,message:`Leave?
Changes you made will be discarded.`}})]);var jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@18.2.0/node_modules/react/jsx-runtime.js");function BatchExportsEditForm(props){let logic=batchExportsEditLogic(props),{isNew,batchExportConfigForm,isBatchExportConfigFormSubmitting,batchExportConfigLoading}=(0,index_esm.useValues)(logic),{submitBatchExportConfigForm,cancelEditing}=(0,index_esm.useActions)(logic),{user}=(0,index_esm.useValues)(userLogic.userLogic);return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:batchExportConfigLoading?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonSkeleton.y,{}),(0,jsx_runtime.jsx)(LemonSkeleton.y,{}),(0,jsx_runtime.jsx)(LemonSkeleton.y,{}),(0,jsx_runtime.jsx)(LemonSkeleton.y,{})]}):(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)(lib.Form,{logic:batchExportsEditLogic,props:props,formKey:"batchExportConfigForm",className:"space-y-4",children:[(0,jsx_runtime.jsx)(BatchExportGeneralEditFields,{isNew:isNew,batchExportConfigForm:batchExportConfigForm}),(0,jsx_runtime.jsxs)("div",{className:"space-y-4 max-w-200 w-full ",children:[(0,jsx_runtime.jsx)(src.LemonDivider,{}),(0,jsx_runtime.jsx)(LemonField.D,{name:"destination",label:"Destination",children:(0,jsx_runtime.jsx)(src.LemonSelect,{options:[{value:"BigQuery",label:"BigQuery"},{value:"Postgres",label:"PostgreSQL"},{value:"Redshift",label:"Redshift"},{value:"S3",label:"S3"},{value:"Snowflake",label:"Snowflake"},...user?.is_impersonated?[{value:"HTTP",label:"HTTP"}]:[]]})})]}),batchExportConfigForm.destination?(0,jsx_runtime.jsx)(BatchExportsEditFields,{isNew:isNew,batchExportConfigForm:batchExportConfigForm}):(0,jsx_runtime.jsx)("p",{className:"text-muted-alt italic",children:"Select a destination to continue configuring"}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(src.LemonButton,{"data-attr":"cancel-batch-export",type:"secondary",onClick:()=>cancelEditing(),disabledReason:isBatchExportConfigFormSubmitting?"Currently being saved":void 0,children:"Cancel"}),(0,jsx_runtime.jsx)(src.LemonButton,{"data-attr":"save-batch-export",htmlType:"submit",type:"primary",onClick:submitBatchExportConfigForm,loading:isBatchExportConfigFormSubmitting,children:isNew?"Create":"Save"})]})]})})})}function BatchExportGeneralEditFields(_ref){let{isNew,isPipeline=!1,batchExportConfigForm}=_ref,{featureFlags}=(0,index_esm.useValues)(featureFlagLogic.h),highFrequencyBatchExports=featureFlags[constants.y8.HIGH_FREQUENCY_BATCH_EXPORTS];return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsxs)("div",{className:"space-y-4 max-w-200",children:[!isPipeline&&(0,jsx_runtime.jsx)(LemonField.D,{name:"name",label:"Name",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"Name your workflow for future reference"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 items-start flex-wrap",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"interval",label:"Batch interval",className:"flex-1",info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The intervals of data exports. For example, if you select hourly, every hour a run will be created to export that hours data."}),children:(0,jsx_runtime.jsx)(src.LemonSelect,{options:[{value:"hour",label:"Hourly"},{value:"day",label:"Daily"},{value:"every 5 minutes",label:"Every 5 minutes",hidden:!highFrequencyBatchExports}]})}),(!isPipeline||batchExportConfigForm.end_at)&&(0,jsx_runtime.jsx)(LemonField.D,{name:"end_at",label:"End date",className:"flex-1",info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"The date up to which data is to be exported. Leaving it unset implies that data exports will continue forever until this export is paused or deleted."}),children:_ref2=>{let{value,onChange}=_ref2;return(0,jsx_runtime.jsx)(LemonCalendarSelect.he,{value:value,onChange:onChange,placeholder:"Select end date (optional)",clearable:!0})}})]}),isPipeline?(0,jsx_runtime.jsx)(LemonBanner.V,{type:"info",children:"The export will be created in a paused state, once configured your exporter, you can trigger a manual export for historic data or start the continous export."}):(0,jsx_runtime.jsx)(LemonBanner.V,{type:"info",children:"This batch exporter will schedule regular batch exports at your indicated interval until the end date. Once you have configured your exporter, you can trigger a manual export for historic data."}),isNew&&!isPipeline?(0,jsx_runtime.jsx)(LemonField.D,{name:"paused",children:(0,jsx_runtime.jsx)(src.LemonCheckbox,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Create in paused state",(0,jsx_runtime.jsx)(Tooltip.u,{title:"If selected, the Batch Exporter will be created but will be 'paused' allowing you to resumed it at a later date.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:" text-lg text-muted-alt"})})]})})}):null]})})}function BatchExportsEditFields(_ref3){let{isNew,batchExportConfigForm}=_ref3;return(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)("div",{className:"space-y-4 max-w-200",children:"S3"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"bucket_name",label:"Bucket",className:"flex-1",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"e.g. my-bucket"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"region",label:"Region",className:"flex-1",children:(0,jsx_runtime.jsx)(src.LemonSelect,{options:[{value:"us-east-1",label:"US East (N. Virginia)"},{value:"us-east-2",label:"US East (Ohio)"},{value:"us-west-1",label:"US West (N. California)"},{value:"us-west-2",label:"US West (Oregon)"},{value:"af-south-1",label:"Africa (Cape Town)"},{value:"ap-east-1",label:"Asia Pacific (Hong Kong)"},{value:"ap-south-1",label:"Asia Pacific (Mumbai)"},{value:"ap-northeast-3",label:"Asia Pacific (Osaka-Local)"},{value:"ap-northeast-2",label:"Asia Pacific (Seoul)"},{value:"ap-southeast-1",label:"Asia Pacific (Singapore)"},{value:"ap-southeast-2",label:"Asia Pacific (Sydney)"},{value:"ap-northeast-1",label:"Asia Pacific (Tokyo)"},{value:"ca-central-1",label:"Canada (Central)"},{value:"cn-north-1",label:"China (Beijing)"},{value:"cn-northwest-1",label:"China (Ningxia)"},{value:"eu-central-1",label:"Europe (Frankfurt)"},{value:"eu-west-1",label:"Europe (Ireland)"},{value:"eu-west-2",label:"Europe (London)"},{value:"eu-south-1",label:"Europe (Milan)"},{value:"eu-west-3",label:"Europe (Paris)"},{value:"eu-north-1",label:"Europe (Stockholm)"},{value:"me-south-1",label:"Middle East (Bahrain)"},{value:"sa-east-1",label:"South America (S\xe3o Paulo)"}]})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"prefix",label:"Key prefix",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"e.g. posthog-events/"})}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"compression",label:"Compression",className:"flex-1",children:(0,jsx_runtime.jsx)(src.LemonSelect,{options:[{value:"gzip",label:"gzip"},{value:"brotli",label:"brotli"},{value:null,label:"No compression"}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"encryption",label:"Encryption",className:"flex-1",children:(0,jsx_runtime.jsx)(src.LemonSelect,{options:[{value:"AES256",label:"AES256"},{value:"aws:kms",label:"aws:kms"},{value:null,label:"No encryption"}]})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"file_format",label:"Format",className:"flex-1",children:(0,jsx_runtime.jsx)(src.LemonSelect,{options:[{value:"JSONLines",label:"JSON lines"},{value:"Parquet",label:"Apache Parquet"}]})})]}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-4",children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"aws_access_key_id",label:"AWS Access Key ID",className:"flex-1",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:isNew?"e.g. AKIAIOSFODNN7EXAMPLE":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"aws_secret_access_key",label:"AWS Secret Access Key",className:"flex-1",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:isNew?"e.g. secret-key":"Leave unchanged",type:"password"})}),"aws:kms"==batchExportConfigForm.encryption&&(0,jsx_runtime.jsx)(LemonField.D,{name:"kms_key_id",label:"AWS KMS Key ID",className:"flex-1",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:isNew?"e.g. 1234abcd-12ab-34cd-56ef-1234567890ab":"leave unchanged"})})]}),(0,jsx_runtime.jsx)(LemonField.D,{name:"endpoint_url",label:"Endpoint URL",showOptional:!0,info:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:"Only required if exporting to an S3-compatible blob storage (like MinIO)"}),children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:isNew?"e.g. https://your-minio-host:9000":"Leave unchanged"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):"Snowflake"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-user"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-password",type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"account",label:"Account",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-account"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"warehouse",label:"Warehouse",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-warehouse"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-schema"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"role",label:"Role",showOptional:!0,children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-role"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):"Postgres"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-user"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-password",type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"host",label:"Host",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-host"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"port",label:"Port",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"5432",type:"number",min:"0",max:"65535"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"public"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"has_self_signed_cert",children:_ref4=>{let{value,onChange}=_ref4;return(0,jsx_runtime.jsx)(src.LemonCheckbox,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Does your Postgres instance have a self-signed SSL certificate?",(0,jsx_runtime.jsx)(Tooltip.u,{title:"In most cases, Heroku and RDS users should check this.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:" text-lg text-muted-alt"})})]}),checked:!!value,onChange:onChange})}}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):"Redshift"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"user",label:"User",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-user"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"password",label:"Password",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-password",type:"password"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"host",label:"Host",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-host"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"port",label:"Port",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"5439",type:"number",min:"0",max:"65535"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"database",label:"Database",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"my-database"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"schema",label:"Schema",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"public"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_name",label:"Table name",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"properties_data_type",label:"Properties data type",children:(0,jsx_runtime.jsx)(src.LemonSelect,{options:[{value:"varchar",label:"VARCHAR(65535)"},{value:"super",label:"SUPER"}],value:"varchar"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):"BigQuery"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"json_config_file",label:"Google Cloud JSON key file",children:(0,jsx_runtime.jsx)(LemonFileInput.m,{accept:".json",multiple:!1})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"table_id",label:"Table ID",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"events"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"dataset_id",label:"Dataset ID",children:(0,jsx_runtime.jsx)(src.LemonInput,{placeholder:"dataset"})}),isNew?(0,jsx_runtime.jsx)(LemonField.D,{name:"use_json_type",label:"Structured fields data type",children:(0,jsx_runtime.jsx)(src.LemonCheckbox,{bordered:!0,label:(0,jsx_runtime.jsxs)("span",{className:"flex items-center gap-2",children:["Export 'properties', 'set', and 'set_once' fields as BigQuery JSON type",(0,jsx_runtime.jsx)(Tooltip.u,{title:"If left unchecked, these fields will be sent as STRING type. This setting cannot be changed after batch export is created.",children:(0,jsx_runtime.jsx)(posthog_icons_es.IconInfo,{className:" text-lg text-muted-alt"})})]})})}):null,(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):"HTTP"===batchExportConfigForm.destination?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(LemonField.D,{name:"url",label:"URL",children:(0,jsx_runtime.jsx)(src.LemonInput,{})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"token",label:"Project API Key",children:(0,jsx_runtime.jsx)(src.LemonInput,{})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"exclude_events",label:"Events to exclude",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to exclude from the export (optional)"})}),(0,jsx_runtime.jsx)(LemonField.D,{name:"include_events",label:"Events to include",className:"flex-1",children:(0,jsx_runtime.jsx)(LemonInputSelect.n,{mode:"multiple",allowCustomValues:!0,options:[],placeholder:"Input one or more events to include in the export (optional)"})})]}):null})})}},"./frontend/src/scenes/batch_exports/batchExportLogic.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{B:()=>batchExportLogic,o:()=>BatchExportTab});var _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./frontend/@posthog/lemon-ui/src/index.ts"),kea__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/kea@3.1.5_react@18.2.0/node_modules/kea/lib/index.esm.js"),kea_forms__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/kea-forms@3.1.3_kea@3.1.5/node_modules/kea-forms/lib/index.js"),kea_loaders__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/.pnpm/kea-loaders@3.0.0_kea@3.1.5/node_modules/kea-loaders/lib/index.js"),kea_router__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/.pnpm/kea-router@3.1.4_kea@3.1.5/node_modules/kea-router/lib/index.js"),lib_api__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./frontend/src/lib/api.ts"),lib_dayjs__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./frontend/src/lib/dayjs.ts"),scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./frontend/src/scenes/sceneTypes.ts"),scenes_urls__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./frontend/src/scenes/urls.ts");let BatchExportTab=function(BatchExportTab){return BatchExportTab.Runs="runs",BatchExportTab.Logs="logs",BatchExportTab}({}),convert=run=>({...run,data_interval_start:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.data_interval_start),data_interval_end:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.data_interval_end),created_at:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.created_at),last_updated_at:run.last_updated_at?(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)(run.last_updated_at):void 0}),mergeRuns=(oldRuns,newRuns)=>{let runs=[...oldRuns];return newRuns.forEach(rawRun=>{let newRun=convert(rawRun),index=runs.findIndex(run=>run.id===newRun.id);index>-1?runs[index]=newRun:runs.push(newRun)}),runs},batchExportLogic=(0,kea__WEBPACK_IMPORTED_MODULE_1__.kea)([(0,kea__WEBPACK_IMPORTED_MODULE_1__.props)({}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.key)(_ref=>{let{id}=_ref;return id}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.path)(key=>["scenes","batch_exports","batchExportLogic",key]),(0,kea__WEBPACK_IMPORTED_MODULE_1__.actions)({loadBatchExportRuns:!0,loadNextBatchExportRuns:!0,openBackfillModal:!0,closeBackfillModal:!0,retryRun:run=>({run}),setRunsDateRange:data=>data,setActiveTab:tab=>({tab})}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.reducers)({activeTab:["runs",{setActiveTab:(_,_ref2)=>{let{tab}=_ref2;return tab}}],runsDateRange:[{from:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)().subtract(7,"day").startOf("day"),to:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)().endOf("day")},{setRunsDateRange:(_,_ref3)=>{let{from,to}=_ref3;return{from,to}}}],isBackfillModalOpen:[!1,{openBackfillModal:()=>!0,closeBackfillModal:()=>!1}]}),(0,kea_loaders__WEBPACK_IMPORTED_MODULE_3__.loaders)(_ref4=>{let{props,values}=_ref4;return{batchExportConfig:[null,{loadBatchExportConfig:async()=>{let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.get(props.id);return res},pause:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.pause(props.id),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Batch export paused. No future runs will be scheduled"),{...values.batchExportConfig,paused:!0}):null,unpause:async()=>values.batchExportConfig?(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.unpause(props.id),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Batch export unpaused. Future runs will be scheduled"),{...values.batchExportConfig,paused:!1}):null,archive:async()=>(values.batchExportConfig&&(await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.delete(props.id),kea_router__WEBPACK_IMPORTED_MODULE_4__.router.actions.replace(scenes_urls__WEBPACK_IMPORTED_MODULE_8__.j.batchExports())),null)}],batchExportRunsResponse:[null,{loadBatchExportRuns:async()=>{var _values$batchExportRu;let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.listRuns(props.id,{after:values.runsDateRange.from,before:values.runsDateRange.to.add(1,"day")});return res.results=mergeRuns(null!==(_values$batchExportRu=values.batchExportRunsResponse?.results)&&void 0!==_values$batchExportRu?_values$batchExportRu:[],res.results),res},loadNextBatchExportRuns:async()=>{var _values$batchExportRu2;let nextUrl=values.batchExportRunsResponse?.next;if(!nextUrl)return values.batchExportRunsResponse;let res=await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.get(nextUrl);return res.results=mergeRuns(null!==(_values$batchExportRu2=values.batchExportRunsResponse?.results)&&void 0!==_values$batchExportRu2?_values$batchExportRu2:[],res.results),res}}]}}),(0,kea_forms__WEBPACK_IMPORTED_MODULE_2__.forms)(_ref5=>{let{props,actions}=_ref5;return{backfillForm:{defaults:{end_at:(0,lib_dayjs__WEBPACK_IMPORTED_MODULE_6__.Bv)()},errors:_ref6=>{let{start_at,end_at}=_ref6;return{start_at:start_at?void 0:"Start date is required",end_at:end_at?void 0:"End date is required"}},submit:async _ref7=>{var _start_at$toISOString,_end_at$toISOString;let{start_at,end_at}=_ref7;await new Promise(resolve=>setTimeout(resolve,1e3)),await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.createBackfill(props.id,{start_at:null!==(_start_at$toISOString=start_at?.toISOString())&&void 0!==_start_at$toISOString?_start_at$toISOString:null,end_at:null!==(_end_at$toISOString=end_at?.toISOString())&&void 0!==_end_at$toISOString?_end_at$toISOString:null}).catch(e=>{if(e.detail){var _e$attr;actions.setBackfillFormManualErrors({[null!==(_e$attr=e.attr)&&void 0!==_e$attr?_e$attr:"start_at"]:e.detail})}else _posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.error("Unknown error occurred");throw e}),actions.closeBackfillModal(),actions.loadBatchExportRuns()}}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.selectors)(()=>({groupedRuns:[s=>[s.batchExportRuns],runs=>{let groupedRuns={};return runs.forEach(run=>{let key=`${run.data_interval_start}-${run.data_interval_end}`;groupedRuns[key]||(groupedRuns[key]={data_interval_start:run.data_interval_start,data_interval_end:run.data_interval_end,runs:[],last_run_at:run.created_at}),groupedRuns[key].runs.push(run),groupedRuns[key].runs.sort((a,b)=>b.created_at.diff(a.created_at)),groupedRuns[key].last_run_at=groupedRuns[key].runs[0].created_at}),Object.values(groupedRuns).sort((a,b)=>b.data_interval_end.diff(a.data_interval_end))}],breadcrumbs:[s=>[s.batchExportConfig],config=>[{key:scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__.x.BatchExports,name:"Batch Exports",path:scenes_urls__WEBPACK_IMPORTED_MODULE_8__.j.batchExports()},{key:[scenes_sceneTypes__WEBPACK_IMPORTED_MODULE_7__.x.BatchExport,config?.id||"loading"],name:config?.name}]],batchExportRuns:[s=>[s.batchExportRunsResponse],batchExportRunsResponse=>{var _batchExportRunsRespo;return null!==(_batchExportRunsRespo=batchExportRunsResponse?.results)&&void 0!==_batchExportRunsRespo?_batchExportRunsRespo:[]}],defaultTab:[s=>[s.batchExportConfig],()=>BatchExportTab.Runs]})),(0,kea__WEBPACK_IMPORTED_MODULE_1__.listeners)(_ref8=>{let{actions,cache,props}=_ref8;return{setRunsDateRange:()=>{actions.loadBatchExportRuns()},loadBatchExportRunsSuccess:()=>{clearTimeout(cache.refreshTimeout),cache.refreshTimeout=setTimeout(()=>{actions.loadBatchExportRuns()},5e3)},retryRun:async _ref9=>{let{run}=_ref9;await lib_api__WEBPACK_IMPORTED_MODULE_5__.ZP.batchExports.createBackfill(props.id,{start_at:run.data_interval_start.toISOString(),end_at:run.data_interval_end.toISOString()}),_posthog_lemon_ui__WEBPACK_IMPORTED_MODULE_0__.lemonToast.success("Retry has been scheduled."),clearTimeout(cache.refreshTimeout),cache.refreshTimeout=setTimeout(()=>{actions.loadBatchExportRuns()},2e3)}}}),(0,kea__WEBPACK_IMPORTED_MODULE_1__.beforeUnmount)(_ref10=>{let{cache}=_ref10;clearTimeout(cache.refreshTimeout)})])}}]);
//# sourceMappingURL=13222.f7c69684.iframe.bundle.js.map